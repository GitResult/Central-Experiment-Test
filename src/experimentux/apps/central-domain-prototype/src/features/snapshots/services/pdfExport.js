/**
 * PDF Export Service
 * Exports snapshots with annotations to PDF
 */

/**
 * Export snapshot to PDF
 * Uses browser's print functionality as a lightweight solution
 * For production, consider using jspdf library for more control
 */
export async function exportSnapshotToPDF(snapshot) {
  // Create a temporary container for PDF content
  const container = document.createElement('div');
  container.style.position = 'fixed';
  container.style.left = '-9999px';
  container.style.top = '0';
  container.style.width = '8.5in'; // US Letter size
  container.style.padding = '0.5in';
  container.style.backgroundColor = 'white';
  container.style.fontFamily = 'Arial, sans-serif';

  // Build PDF content
  container.innerHTML = `
    <div style="text-align: center; margin-bottom: 24px;">
      <h1 style="margin: 0 0 8px 0; font-size: 24px; color: #1d1d1f;">Central Snapshot</h1>
      <p style="margin: 0; color: #6b7280; font-size: 14px;">
        Created: ${new Date(snapshot.createdAt).toLocaleString()}
      </p>
    </div>

    <div style="margin-bottom: 24px;">
      <img
        src="${snapshot.imageUrl}"
        alt="Snapshot"
        style="max-width: 100%; height: auto; border: 1px solid #e5e7eb; border-radius: 8px;"
      />
    </div>

    <div style="margin-bottom: 16px;">
      <h2 style="margin: 0 0 8px 0; font-size: 16px; color: #1d1d1f;">Details</h2>
      <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
        <tr style="border-bottom: 1px solid #e5e7eb;">
          <td style="padding: 8px 0; font-weight: 600; color: #6b7280;">Module:</td>
          <td style="padding: 8px 0;">${snapshot.sourceContext.module || 'General'}</td>
        </tr>
        <tr style="border-bottom: 1px solid #e5e7eb;">
          <td style="padding: 8px 0; font-weight: 600; color: #6b7280;">Source URL:</td>
          <td style="padding: 8px 0; word-break: break-all;">${snapshot.sourceContext.url || 'N/A'}</td>
        </tr>
        <tr style="border-bottom: 1px solid #e5e7eb;">
          <td style="padding: 8px 0; font-weight: 600; color: #6b7280;">File Size:</td>
          <td style="padding: 8px 0;">${Math.round(snapshot.metadata.fileSize / 1024)} KB</td>
        </tr>
        <tr style="border-bottom: 1px solid #e5e7eb;">
          <td style="padding: 8px 0; font-weight: 600; color: #6b7280;">Dimensions:</td>
          <td style="padding: 8px 0;">${snapshot.metadata.dimensions?.width || 'N/A'} × ${snapshot.metadata.dimensions?.height || 'N/A'}</td>
        </tr>
      </table>
    </div>

    ${snapshot.discussions && snapshot.discussions.length > 0 ? `
      <div style="margin-top: 24px;">
        <h2 style="margin: 0 0 12px 0; font-size: 16px; color: #1d1d1f;">Discussions</h2>
        ${snapshot.discussions.map(discussion => `
          <div style="margin-bottom: 12px; padding: 12px; background-color: #f9fafb; border-radius: 8px;">
            <p style="margin: 0 0 4px 0; font-weight: 600; font-size: 13px; color: #1d1d1f;">
              ${discussion.author} <span style="font-weight: 400; color: #6b7280;">${new Date(discussion.timestamp).toLocaleString()}</span>
            </p>
            <p style="margin: 0; font-size: 13px; color: #374151;">${discussion.content}</p>
          </div>
        `).join('')}
      </div>
    ` : ''}

    <div style="margin-top: 32px; padding-top: 16px; border-top: 1px solid #e5e7eb; text-align: center;">
      <p style="margin: 0; font-size: 12px; color: #9ca3af;">
        Generated by Central Snapshots • ${new Date().toLocaleString()}
      </p>
    </div>
  `;

  document.body.appendChild(container);

  // Wait for images to load
  const images = container.getElementsByTagName('img');
  await Promise.all(
    Array.from(images).map(img => {
      return new Promise((resolve) => {
        if (img.complete) {
          resolve();
        } else {
          img.onload = resolve;
          img.onerror = resolve;
        }
      });
    })
  );

  // Trigger print dialog
  const originalContents = document.body.innerHTML;
  const printContents = container.innerHTML;

  // Create print window
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
      <head>
        <title>Snapshot - ${snapshot.id}</title>
        <style>
          @media print {
            body { margin: 0; }
            @page { margin: 0.5in; }
          }
        </style>
      </head>
      <body>
        ${printContents}
      </body>
    </html>
  `);

  printWindow.document.close();
  printWindow.focus();

  // Trigger print
  setTimeout(() => {
    printWindow.print();
  }, 250);

  // Clean up
  document.body.removeChild(container);

  return {
    success: true,
    filename: `snapshot-${snapshot.id}.pdf`,
  };
}

/**
 * Export multiple snapshots to PDF
 */
export async function exportMultipleSnapshotsToPDF(snapshots) {
  // For simplicity, export first snapshot
  // In production, you'd combine multiple snapshots into one PDF
  if (snapshots.length === 0) {
    throw new Error('No snapshots to export');
  }

  if (snapshots.length === 1) {
    return exportSnapshotToPDF(snapshots[0]);
  }

  // For multiple snapshots, export each separately
  // In production, use jspdf to combine into single PDF
  for (const snapshot of snapshots) {
    await exportSnapshotToPDF(snapshot);
    // Add delay between prints
    await new Promise(resolve => setTimeout(resolve, 1000));
  }

  return {
    success: true,
    count: snapshots.length,
  };
}
