import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Card, CardHeader, CardBody, Button, Input, DateRangeField } from '@central-ux/ui-components';
import {
  DndContext,
  closestCenter,
  pointerWithin,
  PointerSensor,
  KeyboardSensor,
  useSensor,
  useSensors,
  DragOverlay,
  useDraggable,
  useDroppable,
} from '@dnd-kit/core';
import {
  arrayMove,
  SortableContext,
  useSortable,
  verticalListSortingStrategy,
  rectSortingStrategy,
  sortableKeyboardCoordinates,
} from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';
import RGL, { WidthProvider } from 'react-grid-layout';
import Selecto from 'react-selecto';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell, PieChart, Pie, LineChart, Line, Legend } from 'recharts';
import CalendarHeatmap from 'react-calendar-heatmap';
import { format, subDays, startOfDay, endOfDay, eachDayOfInterval, addDays } from 'date-fns';
import Signature from '@uiw/react-signature';
import EmojiPicker from 'emoji-picker-react';

// Template System Components
import TemplateGallery from './components/TemplateGallery';
import TemplateDemo from './TemplateDemo';
import { createRecordFromTemplate, createSampleRecord } from './templates/index';
import { createBlankPage } from './config/blankPageConfig';

// Slash Palette and Element Registry
import SlashPalette from './components/shared/SlashPalette';
import { getElementDefinition } from './components/elements/registry';
import SlideDeckElement from './components/elements/SlideDeck/SlideDeckElement';

// Slide Decks Feature
import { DeckList, SimpleDeckEditorDemo, deckService } from './features/slide-decks/index';

const ReactGridLayout = WidthProvider(RGL);

// Add global styles for card animations
const cardAnimationStyles = `
  @keyframes slideIn {
    0% {
      opacity: 0;
      transform: translateY(-8px) scale(0.98);
    }
    100% {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  @keyframes slideInRight {
    0% {
      transform: translateX(100%);
    }
    100% {
      transform: translateX(0);
    }
  }

  @keyframes zoomPulse {
    0%, 100% {
      opacity: 0.8;
      transform: scale(1);
    }
    50% {
      opacity: 1;
      transform: scale(1.02);
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes fadeInScale {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }
`;

// Floating Toolbar Component for Canvas
const FloatingToolbar = ({
  selectedTool,
  setSelectedTool,
  zoom,
  setZoom,
  showGrid,
  setShowGrid,
  showRuler,
  setShowRuler,
  currentView,
  setCurrentView,
  onZoomIn,
  onZoomOut,
  onZoomToFit
}) => {
  const [openDropdown, setOpenDropdown] = useState(null);
  const [toolbarPosition, setToolbarPosition] = useState({
    x: window.innerWidth / 2,
    y: window.innerHeight - 100
  });
  const [isDragging, setIsDragging] = useState(false);
  const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
  const toolbarRef = useRef(null);

  // Determine if dropdowns should show upward based on toolbar position
  const showDropdownsUpward = toolbarPosition.y > window.innerHeight - 300;

  const toggleDropdown = (dropdown) => {
    setOpenDropdown(openDropdown === dropdown ? null : dropdown);
  };

  // Handle toolbar dragging
  const handleMouseDown = (e) => {
    if (e.target.closest('[data-toolbar-dropdown]') || e.target.closest('button') || e.target.closest('input')) {
      return; // Don't start drag if clicking on interactive elements
    }

    if (!toolbarRef.current) return;

    const rect = toolbarRef.current.getBoundingClientRect();
    setDragOffset({
      x: e.clientX - rect.left,
      y: e.clientY - rect.top
    });
    setIsDragging(true);
  };

  useEffect(() => {
    if (!isDragging) return;

    const handleMouseMove = (e) => {
      setToolbarPosition({
        x: e.clientX - dragOffset.x,
        y: e.clientY - dragOffset.y
      });
    };

    const handleMouseUp = () => {
      setIsDragging(false);
    };

    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);

    return () => {
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);
    };
  }, [isDragging, dragOffset]);

  // Close dropdowns when clicking outside
  useEffect(() => {
    const handleClickOutside = (e) => {
      if (!e.target.closest('[data-toolbar-dropdown]')) {
        setOpenDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  const selectionTools = [
    { id: 'select', name: 'Select', icon: 'M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z' },
    { id: 'hand', name: 'Hand', icon: 'M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11m0-5.5a1.5 1.5 0 013 0v3m0 0V11' }
  ];

  const shapeTools = [
    { id: 'rectangle', name: 'Rectangle', icon: 'M4 5a1 1 0 011-1h14a1 1 0 011 1v14a1 1 0 01-1 1H5a1 1 0 01-1-1V5z' },
    { id: 'diamond', name: 'Diamond', icon: 'M12 2L2 12l10 10 10-10L12 2z' },
    { id: 'circle', name: 'Circle', icon: 'M21 12a9 9 0 11-18 0 9 9 0 0118 0z' },
    { id: 'arrow', name: 'Arrow', icon: 'M17 8l4 4m0 0l-4 4m4-4H3' },
    { id: 'line', name: 'Line', icon: 'M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3' },
    { id: 'section', name: 'Section', icon: 'M4 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4z' },
    { id: 'image', name: 'Image/Video', icon: 'M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z' }
  ];

  const drawingTools = [
    { id: 'pencil', name: 'Pencil', icon: 'M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z' },
    { id: 'pen', name: 'Pen', icon: 'M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z' }
  ];

  const textTools = [
    { id: 'text', name: 'Text', icon: 'M4 5h16M4 19h16M8 5v14m8-14v14' },
    { id: 'list', name: 'List', icon: 'M4 6h16M4 12h16M4 18h16' },
    { id: 'table', name: 'Table', icon: 'M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z' }
  ];

  const viewOptions = [
    { id: 'toggle-grid', name: 'Toggle Grid Lines', checked: showGrid },
    { id: 'toggle-ruler', name: 'Toggle Ruler', checked: showRuler },
    { id: 'drawing', name: 'Drawing View' },
    { id: 'process', name: 'Process View' },
    { id: 'data', name: 'Data View' },
    { id: 'design', name: 'Design View' }
  ];

  const getToolIcon = (tool) => {
    const allTools = [...selectionTools, ...shapeTools, ...drawingTools, ...textTools];
    const foundTool = allTools.find(t => t.id === tool);
    return foundTool?.icon || selectionTools[0].icon;
  };

  const getToolName = (tool) => {
    const allTools = [...selectionTools, ...shapeTools, ...drawingTools, ...textTools];
    const foundTool = allTools.find(t => t.id === tool);
    return foundTool?.name || 'Select';
  };

  const handleZoomChange = (e) => {
    const value = parseInt(e.target.value);
    if (!isNaN(value) && value > 0 && value <= 500) {
      setZoom(value);
    }
  };

  return (
    <div
      ref={toolbarRef}
      className="fixed bg-white border border-neutral-200 rounded-xl shadow-lg py-2 pr-3 flex items-center gap-2 z-[100] select-none"
      style={{
        left: `${toolbarPosition.x}px`,
        top: `${toolbarPosition.y}px`,
        transform: 'translate(-50%, -50%)'
      }}
    >
      {/* Drag Handle */}
      <div
        onMouseDown={handleMouseDown}
        className="flex items-center justify-center px-2 cursor-grab active:cursor-grabbing hover:bg-neutral-50 rounded-l-xl transition-colors"
        style={{ cursor: isDragging ? 'grabbing' : 'grab' }}
        title="Drag to reposition toolbar"
      >
        <svg className="w-4 h-4 text-neutral-400" fill="currentColor" viewBox="0 0 24 24">
          <circle cx="9" cy="5" r="1.5" />
          <circle cx="9" cy="12" r="1.5" />
          <circle cx="9" cy="19" r="1.5" />
          <circle cx="15" cy="5" r="1.5" />
          <circle cx="15" cy="12" r="1.5" />
          <circle cx="15" cy="19" r="1.5" />
        </svg>
      </div>

      {/* Divider */}
      <div className="w-px h-6 bg-neutral-200" />

      {/* Selection Tools - Split Button */}
      <div className="relative flex items-center" data-toolbar-dropdown>
        {/* Main tool button */}
        <button
          onClick={() => {
            const currentToolIndex = selectionTools.findIndex(t => t.id === selectedTool);
            const toolToSelect = currentToolIndex >= 0 ? selectedTool : selectionTools[0].id;
            setSelectedTool(toolToSelect);
          }}
          className={`w-9 h-9 flex items-center justify-center rounded-l-lg transition-colors ${
            selectionTools.some(t => t.id === selectedTool)
              ? 'text-blue-600 bg-blue-50 hover:bg-blue-100'
              : 'text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100'
          }`}
          title={getToolName(selectedTool)}
        >
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d={getToolIcon(selectedTool)} />
          </svg>
        </button>
        {/* Dropdown trigger button */}
        <button
          onClick={() => toggleDropdown('selection')}
          className={`w-5 h-9 flex items-center justify-center rounded-r-lg border-l transition-colors ${
            selectionTools.some(t => t.id === selectedTool)
              ? 'text-blue-600 bg-blue-50 hover:bg-blue-100 border-blue-200'
              : 'text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100 border-neutral-200'
          }`}
          title="More selection tools"
        >
          <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        {openDropdown === 'selection' && (
          <div className={`absolute ${showDropdownsUpward ? 'bottom-full mb-1' : 'top-full mt-1'} left-0 w-48 bg-white border border-neutral-200 rounded-lg shadow-lg py-1 z-50`}>
            {selectionTools.map(tool => (
              <button
                key={tool.id}
                onClick={() => {
                  setSelectedTool(tool.id);
                  setOpenDropdown(null);
                }}
                className={`w-full text-left px-3 py-2 text-sm hover:bg-neutral-50 transition-colors flex items-center gap-3 ${selectedTool === tool.id ? 'bg-neutral-100 text-neutral-900' : 'text-neutral-700'}`}
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d={tool.icon} />
                </svg>
                {tool.name}
              </button>
            ))}
          </div>
        )}
      </div>

      {/* Divider */}
      <div className="w-px h-6 bg-neutral-200" />

      {/* Shape Tools - Split Button */}
      <div className="relative flex items-center" data-toolbar-dropdown>
        {/* Main tool button */}
        <button
          onClick={() => {
            const currentToolIndex = shapeTools.findIndex(t => t.id === selectedTool);
            const toolToSelect = currentToolIndex >= 0 ? selectedTool : shapeTools[0].id;
            setSelectedTool(toolToSelect);
          }}
          className={`w-9 h-9 flex items-center justify-center rounded-l-lg transition-colors ${
            shapeTools.some(t => t.id === selectedTool)
              ? 'text-blue-600 bg-blue-50 hover:bg-blue-100'
              : 'text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100'
          }`}
          title={shapeTools.find(t => t.id === selectedTool)?.name || shapeTools[0].name}
        >
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d={shapeTools.find(t => t.id === selectedTool)?.icon || shapeTools[0].icon} />
          </svg>
        </button>
        {/* Dropdown trigger button */}
        <button
          onClick={() => toggleDropdown('shapes')}
          className={`w-5 h-9 flex items-center justify-center rounded-r-lg border-l transition-colors ${
            shapeTools.some(t => t.id === selectedTool)
              ? 'text-blue-600 bg-blue-50 hover:bg-blue-100 border-blue-200'
              : 'text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100 border-neutral-200'
          }`}
          title="More shapes"
        >
          <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        {openDropdown === 'shapes' && (
          <div className={`absolute ${showDropdownsUpward ? 'bottom-full mb-1' : 'top-full mt-1'} left-0 w-48 bg-white border border-neutral-200 rounded-lg shadow-lg py-1 z-50`}>
            {shapeTools.map(tool => (
              <button
                key={tool.id}
                onClick={() => {
                  setSelectedTool(tool.id);
                  setOpenDropdown(null);
                }}
                className={`w-full text-left px-3 py-2 text-sm hover:bg-neutral-50 transition-colors flex items-center gap-3 ${selectedTool === tool.id ? 'bg-neutral-100 text-neutral-900' : 'text-neutral-700'}`}
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d={tool.icon} />
                </svg>
                {tool.name}
              </button>
            ))}
          </div>
        )}
      </div>

      {/* Drawing Tools - Split Button */}
      <div className="relative flex items-center" data-toolbar-dropdown>
        {/* Main tool button */}
        <button
          onClick={() => {
            const currentToolIndex = drawingTools.findIndex(t => t.id === selectedTool);
            const toolToSelect = currentToolIndex >= 0 ? selectedTool : drawingTools[0].id;
            setSelectedTool(toolToSelect);
          }}
          className={`w-9 h-9 flex items-center justify-center rounded-l-lg transition-colors ${
            drawingTools.some(t => t.id === selectedTool)
              ? 'text-blue-600 bg-blue-50 hover:bg-blue-100'
              : 'text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100'
          }`}
          title={drawingTools.find(t => t.id === selectedTool)?.name || drawingTools[0].name}
        >
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d={drawingTools.find(t => t.id === selectedTool)?.icon || drawingTools[0].icon} />
          </svg>
        </button>
        {/* Dropdown trigger button */}
        <button
          onClick={() => toggleDropdown('drawing')}
          className={`w-5 h-9 flex items-center justify-center rounded-r-lg border-l transition-colors ${
            drawingTools.some(t => t.id === selectedTool)
              ? 'text-blue-600 bg-blue-50 hover:bg-blue-100 border-blue-200'
              : 'text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100 border-neutral-200'
          }`}
          title="More drawing tools"
        >
          <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        {openDropdown === 'drawing' && (
          <div className={`absolute ${showDropdownsUpward ? 'bottom-full mb-1' : 'top-full mt-1'} left-0 w-48 bg-white border border-neutral-200 rounded-lg shadow-lg py-1 z-50`}>
            {drawingTools.map(tool => (
              <button
                key={tool.id}
                onClick={() => {
                  setSelectedTool(tool.id);
                  setOpenDropdown(null);
                }}
                className={`w-full text-left px-3 py-2 text-sm hover:bg-neutral-50 transition-colors flex items-center gap-3 ${selectedTool === tool.id ? 'bg-neutral-100 text-neutral-900' : 'text-neutral-700'}`}
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d={tool.icon} />
                </svg>
                {tool.name}
              </button>
            ))}
          </div>
        )}
      </div>

      {/* Text Tools - Split Button */}
      <div className="relative flex items-center" data-toolbar-dropdown>
        {/* Main tool button */}
        <button
          onClick={() => {
            const currentToolIndex = textTools.findIndex(t => t.id === selectedTool);
            const toolToSelect = currentToolIndex >= 0 ? selectedTool : textTools[0].id;
            setSelectedTool(toolToSelect);
          }}
          className={`w-9 h-9 flex items-center justify-center rounded-l-lg transition-colors ${
            textTools.some(t => t.id === selectedTool)
              ? 'text-blue-600 bg-blue-50 hover:bg-blue-100'
              : 'text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100'
          }`}
          title={textTools.find(t => t.id === selectedTool)?.name || textTools[0].name}
        >
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d={textTools.find(t => t.id === selectedTool)?.icon || textTools[0].icon} />
          </svg>
        </button>
        {/* Dropdown trigger button */}
        <button
          onClick={() => toggleDropdown('text')}
          className={`w-5 h-9 flex items-center justify-center rounded-r-lg border-l transition-colors ${
            textTools.some(t => t.id === selectedTool)
              ? 'text-blue-600 bg-blue-50 hover:bg-blue-100 border-blue-200'
              : 'text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100 border-neutral-200'
          }`}
          title="More text tools"
        >
          <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        {openDropdown === 'text' && (
          <div className={`absolute ${showDropdownsUpward ? 'bottom-full mb-1' : 'top-full mt-1'} left-0 w-48 bg-white border border-neutral-200 rounded-lg shadow-lg py-1 z-50`}>
            {textTools.map(tool => (
              <button
                key={tool.id}
                onClick={() => {
                  setSelectedTool(tool.id);
                  setOpenDropdown(null);
                }}
                className={`w-full text-left px-3 py-2 text-sm hover:bg-neutral-50 transition-colors flex items-center gap-3 ${selectedTool === tool.id ? 'bg-neutral-100 text-neutral-900' : 'text-neutral-700'}`}
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d={tool.icon} />
                </svg>
                {tool.name}
              </button>
            ))}
          </div>
        )}
      </div>

      {/* Annotate Icon */}
      <button
        className="w-9 h-9 flex items-center justify-center text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-colors"
        title="Annotate"
      >
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
        </svg>
      </button>

      {/* AI Actions Icon */}
      <button
        className="w-9 h-9 flex items-center justify-center text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-colors"
        title="AI Actions"
      >
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M13 10V3L4 14h7v7l9-11h-7z" />
        </svg>
      </button>

      {/* More Dropdown */}
      <div className="relative" data-toolbar-dropdown>
        <button
          onClick={() => toggleDropdown('more')}
          className="w-9 h-9 flex items-center justify-center text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-colors"
          title="More Options"
        >
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
          </svg>
        </button>
        {openDropdown === 'more' && (
          <div className={`absolute ${showDropdownsUpward ? 'bottom-full mb-1' : 'top-full mt-1'} right-0 w-48 bg-white border border-neutral-200 rounded-lg shadow-lg py-1 z-50`}>
            {viewOptions.map(option => (
              <button
                key={option.id}
                onClick={() => {
                  if (option.id === 'toggle-grid') {
                    setShowGrid(!showGrid);
                  } else if (option.id === 'toggle-ruler') {
                    setShowRuler(!showRuler);
                  } else if (option.id === 'drawing') {
                    setCurrentView('drawing');
                  } else if (option.id === 'process') {
                    setCurrentView('process');
                  } else if (option.id === 'data') {
                    setCurrentView('data');
                  } else if (option.id === 'design') {
                    setCurrentView('design');
                  }
                }}
                className="w-full text-left px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-50 transition-colors flex items-center justify-between"
              >
                <span>{option.name}</span>
                {option.checked !== undefined && (
                  <svg className={`w-4 h-4 ${option.checked ? 'text-neutral-900' : 'text-transparent'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                  </svg>
                )}
              </button>
            ))}
          </div>
        )}
      </div>

      {/* Divider */}
      <div className="w-px h-6 bg-neutral-200" />

      {/* Zoom Controls */}
      <div className="flex items-center gap-2">
        <button
          onClick={onZoomOut}
          className="w-8 h-8 flex items-center justify-center text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-colors"
          title="Zoom Out"
        >
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 12H4" />
          </svg>
        </button>

        <input
          type="text"
          value={`${Math.round(zoom)}%`}
          onChange={handleZoomChange}
          className="w-14 px-2 py-1 text-xs text-center border border-neutral-200 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
        />

        <button
          onClick={onZoomIn}
          className="w-8 h-8 flex items-center justify-center text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-colors"
          title="Zoom In"
        >
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
          </svg>
        </button>

        <button
          onClick={onZoomToFit}
          className="w-8 h-8 flex items-center justify-center text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-colors"
          title="Fit to Page"
        >
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
          </svg>
        </button>
      </div>
    </div>
  );
};

// Reusable Shape Component - Works in Canvas, Forms, Workflows, anywhere!
const ShapeElement = ({ shape, isSelected, onUpdate }) => {
  const renderShape = () => {
    switch (shape.type) {
      case 'rectangle':
        return (
          <div
            style={{
              width: '100%',
              height: '100%',
              backgroundColor: shape.fill || 'rgba(147, 197, 253, 0.5)',
              border: `${shape.strokeWidth || 2}px ${shape.isSection ? 'dashed' : 'solid'} ${shape.stroke || '#3b82f6'}`,
              borderRadius: '4px'
            }}
          >
            {shape.isSection && (
              <div className="absolute top-2 left-2 text-xs text-neutral-500 font-semibold bg-white px-2 py-1 rounded">
                Section
              </div>
            )}
          </div>
        );

      // Blueprint Frame Types
      case 'blueprint-data':
      case 'blueprint-process':
      case 'blueprint-page':
        return (
          <div className="w-full h-full bg-white rounded-lg border border-neutral-200 shadow-lg overflow-hidden flex flex-col">
            {/* Frame Header */}
            <div className="bg-neutral-50 border-b border-neutral-200 px-3 py-2 flex items-center justify-between flex-shrink-0">
              <div className="flex items-center gap-2">
                {/* Browser Chrome for Page Frames */}
                {shape.type === 'blueprint-page' && (
                  <div className="flex gap-1.5">
                    <div className="w-2 h-2 rounded-full bg-red-400"></div>
                    <div className="w-2 h-2 rounded-full bg-yellow-400"></div>
                    <div className="w-2 h-2 rounded-full bg-green-400"></div>
                  </div>
                )}
                {/* Database Icon for Data Frames */}
                {shape.type === 'blueprint-data' && (
                  <svg className="w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
                  </svg>
                )}
                {/* Lightning Icon for Process Frames */}
                {shape.type === 'blueprint-process' && (
                  <svg className="w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                  </svg>
                )}
                <div className="font-semibold text-neutral-900 text-xs">{shape.title || 'Frame'}</div>
              </div>
            </div>
            {/* Frame Content */}
            <div className="flex-1 overflow-hidden">
              {shape.blueprintContent}
            </div>
          </div>
        );

      case 'circle':
        return (
          <div
            style={{
              width: '100%',
              height: '100%',
              backgroundColor: shape.fill || 'rgba(147, 197, 253, 0.5)',
              border: `${shape.strokeWidth || 2}px solid ${shape.stroke || '#3b82f6'}`,
              borderRadius: '50%'
            }}
          />
        );
      case 'diamond':
        return (
          <div
            style={{
              width: '70.7%',
              height: '70.7%',
              margin: '14.65%',
              backgroundColor: shape.fill || 'rgba(147, 197, 253, 0.5)',
              border: `${shape.strokeWidth || 2}px solid ${shape.stroke || '#3b82f6'}`,
              transform: 'rotate(45deg)'
            }}
          />
        );
      case 'text':
        return (
          <div
            contentEditable={isSelected}
            suppressContentEditableWarning
            style={{
              fontSize: `${shape.fontSize || 16}px`,
              color: shape.fill || '#18181b',
              fontFamily: shape.fontFamily || 'Inter, system-ui, sans-serif',
              outline: 'none',
              whiteSpace: 'pre-wrap',
              wordBreak: 'break-word',
              userSelect: isSelected ? 'text' : 'none',
              padding: '4px',
              minWidth: '50px',
              minHeight: '24px'
            }}
            onBlur={(e) => onUpdate && onUpdate(shape.id, { text: e.target.innerText })}
          >
            {shape.text || 'Double-click to edit'}
          </div>
        );
      case 'arrow':
      case 'line':
        return (
          <svg width="100%" height="100%" style={{ overflow: 'visible' }}>
            <defs>
              {shape.type === 'arrow' && (
                <marker
                  id={`arrowhead-${shape.id}`}
                  markerWidth="10"
                  markerHeight="10"
                  refX="9"
                  refY="3"
                  orient="auto"
                >
                  <polygon points="0 0, 10 3, 0 6" fill={shape.stroke || '#3b82f6'} />
                </marker>
              )}
            </defs>
            <line
              x1="0"
              y1="50%"
              x2="100%"
              y2="50%"
              stroke={shape.stroke || '#3b82f6'}
              strokeWidth={shape.strokeWidth || 2}
              markerEnd={shape.type === 'arrow' ? `url(#arrowhead-${shape.id})` : undefined}
            />
          </svg>
        );
      case 'drawing':
        return (
          <img
            src={shape.dataURL}
            alt="drawing"
            draggable={false}
            style={{
              width: '100%',
              height: '100%',
              objectFit: 'contain',
              pointerEvents: 'none'
            }}
          />
        );
      default:
        return null;
    }
  };

  return renderShape();
};

// Resize Handle Component
const ResizeHandle = ({ position, onResizeStart, zoom }) => {
  const handleId = `resize-handle-${position}`;
  const { attributes, listeners, setNodeRef } = useDraggable({
    id: handleId,
    data: { type: 'resize-handle', position }
  });

  const cursorMap = {
    'nw': 'nw-resize',
    'n': 'n-resize',
    'ne': 'ne-resize',
    'w': 'w-resize',
    'e': 'e-resize',
    'sw': 'sw-resize',
    's': 's-resize',
    'se': 'se-resize'
  };

  const positionStyles = {
    'nw': { top: '-4px', left: '-4px' },
    'n': { top: '-4px', left: '50%', transform: 'translateX(-50%)' },
    'ne': { top: '-4px', right: '-4px' },
    'w': { top: '50%', left: '-4px', transform: 'translateY(-50%)' },
    'e': { top: '50%', right: '-4px', transform: 'translateY(-50%)' },
    'sw': { bottom: '-4px', left: '-4px' },
    's': { bottom: '-4px', left: '50%', transform: 'translateX(-50%)' },
    'se': { bottom: '-4px', right: '-4px' }
  };

  return (
    <div
      ref={setNodeRef}
      {...listeners}
      {...attributes}
      className="resize-handle"
      id={handleId}
      style={{
        position: 'absolute',
        width: '8px',
        height: '8px',
        backgroundColor: '#3b82f6',
        border: '1px solid white',
        borderRadius: '2px',
        cursor: cursorMap[position],
        zIndex: 1001,
        ...positionStyles[position]
      }}
    />
  );
};

// Resize Handles Container for selected shapes
const ResizeHandles = ({ shapes, selectedShapeIds, zoom, resizePreview }) => {
  if (selectedShapeIds.length === 0) return null;

  // Calculate bounding box for all selected shapes
  const selectedShapes = shapes.filter(s => selectedShapeIds.includes(s.id) && !s.locked);
  if (selectedShapes.length === 0) return null;

  const xs = selectedShapes.map(s => s.x);
  const ys = selectedShapes.map(s => s.y);
  const rights = selectedShapes.map(s => s.x + s.width);
  const bottoms = selectedShapes.map(s => s.y + s.height);

  const minX = Math.min(...xs);
  const minY = Math.min(...ys);
  const maxX = Math.max(...rights);
  const maxY = Math.max(...bottoms);

  const boundingBox = {
    x: minX,
    y: minY,
    width: maxX - minX,
    height: maxY - minY
  };

  // Use preview if available, otherwise use calculated bounding box
  const displayBox = resizePreview || boundingBox;

  const handles = ['nw', 'n', 'ne', 'w', 'e', 'sw', 's', 'se'];

  return (
    <div
      style={{
        position: 'absolute',
        left: `${displayBox.x}px`,
        top: `${displayBox.y}px`,
        width: `${displayBox.width}px`,
        height: `${displayBox.height}px`,
        pointerEvents: 'none',
        border: '2px solid #3b82f6',
        borderStyle: resizePreview ? 'dashed' : 'solid',
        zIndex: 1000
      }}
    >
      {handles.map(position => (
        <div key={position} style={{ pointerEvents: 'auto' }}>
          <ResizeHandle position={position} zoom={zoom} />
        </div>
      ))}
    </div>
  );
};

// Draggable Shape Wrapper using dnd-kit
const DraggableShape = ({ shape, isSelected, onSelect, onUpdate, selectedTool, zoom, activeDragId, activeDragTransform, selectedShapeIds }) => {
  const { attributes, listeners, setNodeRef, transform, isDragging } = useDraggable({
    id: shape.id,
    disabled: selectedTool !== 'select' || shape.locked  // Disable drag if locked
  });

  // Check if this shape is part of a multi-select drag operation
  // If we're dragging and this shape is selected (or is the one being dragged)
  const isPartOfMultiDrag = activeDragId && activeDragId !== shape.id && selectedShapeIds.includes(shape.id) && selectedShapeIds.includes(activeDragId);

  // For multi-drag: use activeDragTransform for all selected shapes except the one being dragged
  // For single drag: use the shape's own transform
  const activeTransform = isPartOfMultiDrag ? activeDragTransform : (isDragging ? transform : null);
  const isBeingDragged = isDragging || isPartOfMultiDrag;

  const style = {
    position: 'absolute',
    left: `${shape.x}px`,
    top: `${shape.y}px`,
    width: `${shape.width}px`,
    height: `${shape.height}px`,
    transform: activeTransform
      ? `translate3d(${activeTransform.x / (zoom / 100)}px, ${activeTransform.y / (zoom / 100)}px, 0) rotate(${shape.rotation || 0}deg)`
      : `rotate(${shape.rotation || 0}deg)`,
    cursor: shape.locked ? 'not-allowed' : (selectedTool === 'select' ? (isBeingDragged ? 'grabbing' : 'grab') : 'default'),
    outline: isSelected && !isBeingDragged ? (shape.locked ? '2px solid #f97316' : '2px solid #3b82f6') : 'none',
    outlineOffset: '2px',
    transition: isBeingDragged ? 'none' : 'outline 0.2s',
    zIndex: isSelected ? 100 : (isBeingDragged ? 99 : 1),
    touchAction: 'none',
    opacity: shape.locked ? 0.7 : (isBeingDragged ? 0.5 : 1),
    boxShadow: isBeingDragged ? '0 8px 16px rgba(0,0,0,0.2)' : 'none'
  };

  // Size label style - positioned below the shape
  const sizeLabelStyle = {
    position: 'absolute',
    left: '50%',
    top: '100%',
    transform: 'translateX(-50%)',
    marginTop: '8px',
    backgroundColor: '#3b82f6',
    color: 'white',
    padding: '4px 8px',
    borderRadius: '4px',
    fontSize: '11px',
    fontWeight: '500',
    whiteSpace: 'nowrap',
    pointerEvents: 'none',
    zIndex: 1000,
    boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
  };

  return (
    <div
      ref={setNodeRef}
      {...(selectedTool === 'select' && !shape.locked ? { ...listeners, ...attributes } : {})}
      data-shape-id={shape.id}
      style={style}
      onClick={(e) => {
        e.stopPropagation();
        onSelect(shape.id, e); // Pass event for Ctrl/Cmd detection
      }}
      className="shape-element"
    >
      <ShapeElement shape={shape} isSelected={isSelected} onUpdate={onUpdate} />
      {shape.locked && isSelected && (
        <div className="absolute top-0 right-0 bg-orange-500 text-white rounded-bl px-1 text-xs flex items-center gap-1">
          <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
            <path fillRule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clipRule="evenodd" />
          </svg>
          Locked
        </div>
      )}
      {/* Size display - shown when selected */}
      {isSelected && selectedTool === 'select' && (
        <div style={sizeLabelStyle}>
          {Math.round(shape.width)} Ã— {Math.round(shape.height)}
        </div>
      )}
    </div>
  );
};

// Layer Panel Component
const LayerPanel = ({ shapes, selectedShapeIds, onSelect, onLayerOrder, onToggleLock, onClose }) => {
  return (
    <div className="fixed right-4 top-20 w-64 bg-white rounded-lg shadow-lg border border-neutral-200 z-[100] animate-slide-in-right panel-transition">
      <div className="flex items-center justify-between p-3 border-b border-neutral-200">
        <h3 className="font-semibold text-sm">Layers</h3>
        <button
          onClick={onClose}
          className="text-neutral-500 hover:text-neutral-700"
        >
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div className="max-h-96 overflow-y-auto p-2">
        {[...shapes].reverse().map((shape, index) => {
          const reversedIndex = shapes.length - 1 - index;
          const isSelected = selectedShapeIds.includes(shape.id);
          return (
            <div
              key={shape.id}
              onClick={() => onSelect(shape.id, {})}
              className={`flex items-center gap-2 p-2 rounded cursor-pointer mb-1 ${
                isSelected ? 'bg-blue-50 border border-blue-300' : 'hover:bg-neutral-50 border border-transparent'
              }`}
            >
              <div className="flex-1 flex items-center gap-2">
                <span className="text-xs font-mono text-neutral-500">#{reversedIndex}</span>
                <span className="text-sm capitalize">{shape.type}</span>
                {shape.locked && (
                  <svg className="w-3 h-3 text-orange-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clipRule="evenodd" />
                  </svg>
                )}
              </div>
              <div className="flex gap-1">
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    onLayerOrder(shape.id, 'forward');
                  }}
                  className="p-1 hover:bg-neutral-200 rounded"
                  title="Move forward"
                >
                  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                  </svg>
                </button>
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    onLayerOrder(shape.id, 'backward');
                  }}
                  className="p-1 hover:bg-neutral-200 rounded"
                  title="Move backward"
                >
                  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    onToggleLock();
                  }}
                  className="p-1 hover:bg-neutral-200 rounded"
                  title={shape.locked ? "Unlock" : "Lock"}
                >
                  {shape.locked ? (
                    <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                      <path fillRule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clipRule="evenodd" />
                    </svg>
                  ) : (
                    <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M10 2a5 5 0 00-5 5v2a2 2 0 00-2 2v5a2 2 0 002 2h10a2 2 0 002-2v-5a2 2 0 00-2-2H7V7a3 3 0 015.905-.75 1 1 0 001.937-.5A5.002 5.002 0 0010 2z" />
                    </svg>
                  )}
                </button>
              </div>
            </div>
          );
        })}
        {shapes.length === 0 && (
          <div className="text-center text-neutral-400 text-sm py-8">
            No layers yet
          </div>
        )}
      </div>
    </div>
  );
};

// Alignment Toolbar Component
const AlignmentToolbar = ({ onAlign, selectedCount }) => {
  if (selectedCount < 2) return null;

  return (
    <div className="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-white rounded-lg shadow-lg border border-neutral-200 p-2 flex gap-1 z-[100]">
      <button
        onClick={() => onAlign('left')}
        className="p-2 hover:bg-neutral-100 rounded"
        title="Align left"
      >
        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" />
        </svg>
      </button>
      <button
        onClick={() => onAlign('center-h')}
        className="p-2 hover:bg-neutral-100 rounded"
        title="Align center horizontal"
      >
        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path d="M11 3a1 1 0 10-2 0v4a1 1 0 002 0V3zM11 13a1 1 0 10-2 0v4a1 1 0 002 0v-4zM9 8h2v4H9V8z" />
        </svg>
      </button>
      <button
        onClick={() => onAlign('right')}
        className="p-2 hover:bg-neutral-100 rounded"
        title="Align right"
      >
        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path d="M17 4a1 1 0 01-1 1H4a1 1 0 110-2h12a1 1 0 011 1zm0 4a1 1 0 01-1 1H4a1 1 0 110-2h12a1 1 0 011 1zm0 4a1 1 0 01-1 1H4a1 1 0 110-2h12a1 1 0 011 1z" />
        </svg>
      </button>
      <div className="w-px bg-neutral-300" />
      <button
        onClick={() => onAlign('top')}
        className="p-2 hover:bg-neutral-100 rounded"
        title="Align top"
      >
        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" />
          <rect x="5" y="6" width="10" height="2" rx="1" />
          <rect x="5" y="9" width="10" height="2" rx="1" />
        </svg>
      </button>
      <button
        onClick={() => onAlign('center-v')}
        className="p-2 hover:bg-neutral-100 rounded"
        title="Align center vertical"
      >
        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path d="M3 10a1 1 0 011-1h4a1 1 0 010 2H4a1 1 0 01-1-1zM13 10a1 1 0 011-1h2a1 1 0 010 2h-2a1 1 0 01-1-1z" />
          <rect x="8" y="7" width="4" height="6" rx="1" />
        </svg>
      </button>
      <button
        onClick={() => onAlign('bottom')}
        className="p-2 hover:bg-neutral-100 rounded"
        title="Align bottom"
      >
        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path d="M3 16a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" />
          <rect x="5" y="9" width="10" height="2" rx="1" />
          <rect x="5" y="12" width="10" height="2" rx="1" />
        </svg>
      </button>
      <div className="w-px bg-neutral-300" />
      <button
        onClick={() => onAlign('distribute-h')}
        className="p-2 hover:bg-neutral-100 rounded"
        title="Distribute horizontally"
      >
        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <rect x="2" y="7" width="3" height="6" rx="1" />
          <rect x="8" y="7" width="3" height="6" rx="1" />
          <rect x="14" y="7" width="3" height="6" rx="1" />
        </svg>
      </button>
      <button
        onClick={() => onAlign('distribute-v')}
        className="p-2 hover:bg-neutral-100 rounded"
        title="Distribute vertically"
      >
        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <rect x="7" y="2" width="6" height="3" rx="1" />
          <rect x="7" y="8" width="6" height="3" rx="1" />
          <rect x="7" y="14" width="6" height="3" rx="1" />
        </svg>
      </button>
    </div>
  );
};

// Main Canvas Component
const InfiniteCanvas = ({ onClose, onShapesChange, initialShapes = [], mode = 'empty' }) => {
  const [selectedTool, setSelectedTool] = useState('select');
  const [zoom, setZoom] = useState(100);
  const [showGrid, setShowGrid] = useState(true);
  const [showRuler, setShowRuler] = useState(false);
  const [currentView, setCurrentView] = useState('design');
  const [shapes, setShapes] = useState(initialShapes);
  const [selectedShapeIds, setSelectedShapeIds] = useState([]); // Changed to array for multi-select
  const [canvasOffset, setCanvasOffset] = useState({ x: 0, y: 0 });
  const [isPanning, setIsPanning] = useState(false);
  const [panStart, setPanStart] = useState({ x: 0, y: 0 });
  const [isDrawing, setIsDrawing] = useState(false);
  const [isCreatingShape, setIsCreatingShape] = useState(false);
  const [creatingShapeStart, setCreatingShapeStart] = useState(null);
  const [creatingShapePreview, setCreatingShapePreview] = useState(null);
  const [isSpacePressed, setIsSpacePressed] = useState(false);
  const [previousTool, setPreviousTool] = useState(null);
  const canvasRef = useRef(null);
  const canvasContentRef = useRef(null);
  const signatureRef = useRef(null);
  const selectoRef = useRef(null);
  const [resizeStartData, setResizeStartData] = useState(null); // Track initial data for multi-select resize
  const [resizePreview, setResizePreview] = useState(null); // Live preview of resize bounding box

  // NEW: History for undo/redo
  const [history, setHistory] = useState([]);
  const [historyIndex, setHistoryIndex] = useState(-1);

  // NEW: Clipboard for copy/paste
  const [clipboard, setClipboard] = useState([]);

  // NEW: Smart guides
  const [guides, setGuides] = useState({ horizontal: [], vertical: [] });

  // NEW: Grid snapping
  const [snapToGrid, setSnapToGrid] = useState(true);
  const gridSize = 50;

  // NEW: Layer panel visibility
  const [showLayerPanel, setShowLayerPanel] = useState(false);

  // NEW: Active drag state for multi-select dragging
  const [activeDragId, setActiveDragId] = useState(null);
  const [activeDragTransform, setActiveDragTransform] = useState(null);

  // Blueprint mode state
  const [csvData, setCsvData] = useState(null);
  const [isDraggingFile, setIsDraggingFile] = useState(false);
  const [schema, setSchema] = useState([]);
  const [isGenerating, setIsGenerating] = useState(false);

  // DND-Kit sensors for drag and drop
  const sensors = useSensors(
    useSensor(PointerSensor, {
      activationConstraint: {
        distance: 8, // Require 8px movement before drag starts
      },
    })
  );

  // NEW: Snap to grid function
  const snapValue = (value) => {
    if (!snapToGrid) return value;
    return Math.round(value / gridSize) * gridSize;
  };

  // NEW: Add to history
  const addToHistory = (newShapes) => {
    const newHistory = history.slice(0, historyIndex + 1);
    newHistory.push(JSON.parse(JSON.stringify(newShapes)));
    setHistory(newHistory);
    setHistoryIndex(newHistory.length - 1);
  };

  // NEW: Undo function
  const handleUndo = () => {
    if (historyIndex > 0) {
      setHistoryIndex(historyIndex - 1);
      setShapes(JSON.parse(JSON.stringify(history[historyIndex - 1])));
    }
  };

  // NEW: Redo function
  const handleRedo = () => {
    if (historyIndex < history.length - 1) {
      setHistoryIndex(historyIndex + 1);
      setShapes(JSON.parse(JSON.stringify(history[historyIndex + 1])));
    }
  };

  // NEW: Copy selected shapes
  const handleCopy = () => {
    const selectedShapes = shapes.filter(s => selectedShapeIds.includes(s.id));
    setClipboard(JSON.parse(JSON.stringify(selectedShapes)));
  };

  // NEW: Paste shapes
  const handlePaste = () => {
    if (clipboard.length === 0) return;

    const newShapes = clipboard.map(shape => ({
      ...shape,
      id: `${shape.type}-${Date.now()}-${Math.random()}`,
      x: shape.x + 20,
      y: shape.y + 20
    }));

    const updatedShapes = [...shapes, ...newShapes];
    setShapes(updatedShapes);
    setSelectedShapeIds(newShapes.map(s => s.id));
    addToHistory(updatedShapes);
  };

  // NEW: Toggle lock on selected shapes
  const handleToggleLock = () => {
    const updatedShapes = shapes.map(shape =>
      selectedShapeIds.includes(shape.id)
        ? { ...shape, locked: !shape.locked }
        : shape
    );
    setShapes(updatedShapes);
    addToHistory(updatedShapes);
  };

  // NEW: Alignment functions
  const handleAlign = (type) => {
    if (selectedShapeIds.length < 2) return;

    const selectedShapes = shapes.filter(s => selectedShapeIds.includes(s.id));
    let updatedShapes = [...shapes];

    switch (type) {
      case 'left': {
        const minX = Math.min(...selectedShapes.map(s => s.x));
        updatedShapes = shapes.map(shape =>
          selectedShapeIds.includes(shape.id) ? { ...shape, x: minX } : shape
        );
        break;
      }
      case 'right': {
        const maxRight = Math.max(...selectedShapes.map(s => s.x + s.width));
        updatedShapes = shapes.map(shape =>
          selectedShapeIds.includes(shape.id)
            ? { ...shape, x: maxRight - shape.width }
            : shape
        );
        break;
      }
      case 'top': {
        const minY = Math.min(...selectedShapes.map(s => s.y));
        updatedShapes = shapes.map(shape =>
          selectedShapeIds.includes(shape.id) ? { ...shape, y: minY } : shape
        );
        break;
      }
      case 'bottom': {
        const maxBottom = Math.max(...selectedShapes.map(s => s.y + s.height));
        updatedShapes = shapes.map(shape =>
          selectedShapeIds.includes(shape.id)
            ? { ...shape, y: maxBottom - shape.height }
            : shape
        );
        break;
      }
      case 'center-h': {
        const avgX = selectedShapes.reduce((sum, s) => sum + s.x + s.width / 2, 0) / selectedShapes.length;
        updatedShapes = shapes.map(shape =>
          selectedShapeIds.includes(shape.id)
            ? { ...shape, x: avgX - shape.width / 2 }
            : shape
        );
        break;
      }
      case 'center-v': {
        const avgY = selectedShapes.reduce((sum, s) => sum + s.y + s.height / 2, 0) / selectedShapes.length;
        updatedShapes = shapes.map(shape =>
          selectedShapeIds.includes(shape.id)
            ? { ...shape, y: avgY - shape.height / 2 }
            : shape
        );
        break;
      }
      case 'distribute-h': {
        const sorted = [...selectedShapes].sort((a, b) => a.x - b.x);
        const totalWidth = sorted[sorted.length - 1].x + sorted[sorted.length - 1].width - sorted[0].x;
        const spacing = (totalWidth - sorted.reduce((sum, s) => sum + s.width, 0)) / (sorted.length - 1);
        let currentX = sorted[0].x + sorted[0].width + spacing;

        updatedShapes = shapes.map(shape => {
          const index = sorted.findIndex(s => s.id === shape.id);
          if (index > 0 && index < sorted.length - 1) {
            const newX = currentX;
            currentX += sorted[index].width + spacing;
            return { ...shape, x: newX };
          }
          return shape;
        });
        break;
      }
      case 'distribute-v': {
        const sorted = [...selectedShapes].sort((a, b) => a.y - b.y);
        const totalHeight = sorted[sorted.length - 1].y + sorted[sorted.length - 1].height - sorted[0].y;
        const spacing = (totalHeight - sorted.reduce((sum, s) => sum + s.height, 0)) / (sorted.length - 1);
        let currentY = sorted[0].y + sorted[0].height + spacing;

        updatedShapes = shapes.map(shape => {
          const index = sorted.findIndex(s => s.id === shape.id);
          if (index > 0 && index < sorted.length - 1) {
            const newY = currentY;
            currentY += sorted[index].height + spacing;
            return { ...shape, y: newY };
          }
          return shape;
        });
        break;
      }
    }

    setShapes(updatedShapes);
    addToHistory(updatedShapes);
  };

  // NEW: Change layer order
  const handleLayerOrder = (shapeId, direction) => {
    const index = shapes.findIndex(s => s.id === shapeId);
    if (index === -1) return;

    const newShapes = [...shapes];
    if (direction === 'front') {
      const [shape] = newShapes.splice(index, 1);
      newShapes.push(shape);
    } else if (direction === 'back') {
      const [shape] = newShapes.splice(index, 1);
      newShapes.unshift(shape);
    } else if (direction === 'forward' && index < newShapes.length - 1) {
      [newShapes[index], newShapes[index + 1]] = [newShapes[index + 1], newShapes[index]];
    } else if (direction === 'backward' && index > 0) {
      [newShapes[index], newShapes[index - 1]] = [newShapes[index - 1], newShapes[index]];
    }

    setShapes(newShapes);
    addToHistory(newShapes);
  };

  // Blueprint mode: Icon library for processes
  const getProcessIcon = (iconName) => {
    const icons = {
      plus: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />,
      list: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 10h16M4 14h16M4 18h16" />,
      eye: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />,
      edit: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />,
      trash: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
    };
    return icons[iconName] || icons.list;
  };

  // Blueprint mode: Parse CSV and generate blueprint shapes
  const handleFileUpload = (file) => {
    if (!file) return;

    setIsGenerating(true);
    const reader = new FileReader();

    reader.onload = (e) => {
      const text = e.target.result;
      const lines = text.split('\n').filter(line => line.trim());

      if (lines.length === 0) {
        alert('CSV file is empty');
        setIsGenerating(false);
        return;
      }

      // Parse CSV
      const headers = lines[0].split(',').map(h => h.trim());
      const rows = lines.slice(1).map(line => {
        const values = line.split(',').map(v => v.trim());
        return headers.reduce((obj, header, index) => {
          obj[header] = values[index] || '';
          return obj;
        }, {});
      });

      const parsedCsvData = { headers, rows };
      setCsvData(parsedCsvData);

      // Generate Schema
      const generatedSchema = headers.map((header, index) => {
        const sampleValue = rows[0]?.[header] || '';
        let fieldType = 'Text';

        if (!isNaN(sampleValue) && sampleValue !== '') {
          fieldType = 'Number';
        } else if (sampleValue.includes('@')) {
          fieldType = 'Email';
        } else if (/^\d{4}-\d{2}-\d{2}/.test(sampleValue)) {
          fieldType = 'Date';
        } else if (/^(true|false|yes|no)$/i.test(sampleValue)) {
          fieldType = 'Boolean';
        }

        return {
          id: `field-${index}`,
          name: header,
          type: fieldType,
          required: false
        };
      });

      setSchema(generatedSchema);

      // Generate Blueprint Shapes for InfiniteCanvas
      const blueprintShapes = [
        // Data Schema Frame
        {
          id: 'blueprint-data-schema',
          type: 'blueprint-data',
          title: 'Data Schema',
          x: 50,
          y: 50,
          width: 400,
          height: 500,
          blueprintContent: generateBlueprintContent('data-schema', { csvData: parsedCsvData, schema: generatedSchema }),
          locked: false
        },

        // Process Frames
        {
          id: 'blueprint-process-create',
          type: 'blueprint-process',
          title: 'Create Record',
          x: 500,
          y: 50,
          width: 280,
          height: 120,
          blueprintContent: generateBlueprintContent('process', {
            csvData: parsedCsvData,
            schema: generatedSchema,
            title: 'Create Record',
            description: 'New record form with validation',
            icon: getProcessIcon('plus'),
            color: 'bg-green-50 border-green-200'
          }),
          locked: false
        },
        {
          id: 'blueprint-process-list',
          type: 'blueprint-process',
          title: 'View Listing',
          x: 500,
          y: 190,
          width: 280,
          height: 120,
          blueprintContent: generateBlueprintContent('process', {
            csvData: parsedCsvData,
            schema: generatedSchema,
            title: 'View Listing',
            description: 'Searchable data table',
            icon: getProcessIcon('list'),
            color: 'bg-blue-50 border-blue-200'
          }),
          locked: false
        },
        {
          id: 'blueprint-process-detail',
          type: 'blueprint-process',
          title: 'View Details',
          x: 500,
          y: 330,
          width: 280,
          height: 120,
          blueprintContent: generateBlueprintContent('process', {
            csvData: parsedCsvData,
            schema: generatedSchema,
            title: 'View Details',
            description: 'Record detail view',
            icon: getProcessIcon('eye'),
            color: 'bg-purple-50 border-purple-200'
          }),
          locked: false
        },
        {
          id: 'blueprint-process-edit',
          type: 'blueprint-process',
          title: 'Edit Record',
          x: 500,
          y: 470,
          width: 280,
          height: 120,
          blueprintContent: generateBlueprintContent('process', {
            csvData: parsedCsvData,
            schema: generatedSchema,
            title: 'Edit Record',
            description: 'Update record data',
            icon: getProcessIcon('edit'),
            color: 'bg-yellow-50 border-yellow-200'
          }),
          locked: false
        },
        {
          id: 'blueprint-process-delete',
          type: 'blueprint-process',
          title: 'Delete Record',
          x: 500,
          y: 610,
          width: 280,
          height: 120,
          blueprintContent: generateBlueprintContent('process', {
            csvData: parsedCsvData,
            schema: generatedSchema,
            title: 'Delete Record',
            description: 'Soft delete with retention',
            icon: getProcessIcon('trash'),
            color: 'bg-red-50 border-red-200'
          }),
          locked: false
        },

        // UI/Page Frames
        {
          id: 'blueprint-page-dashboard',
          type: 'blueprint-page',
          title: 'Dashboard View',
          x: 830,
          y: 50,
          width: 450,
          height: 400,
          blueprintContent: generateBlueprintContent('dashboard', { csvData: parsedCsvData, schema: generatedSchema }),
          locked: false
        },
        {
          id: 'blueprint-page-list',
          type: 'blueprint-page',
          title: 'List View',
          x: 1330,
          y: 50,
          width: 500,
          height: 400,
          blueprintContent: generateBlueprintContent('list-view', { csvData: parsedCsvData, schema: generatedSchema }),
          locked: false
        },
        {
          id: 'blueprint-page-new-record',
          type: 'blueprint-page',
          title: 'New Record Form',
          x: 830,
          y: 480,
          width: 380,
          height: 650,
          blueprintContent: generateBlueprintContent('new-record', { csvData: parsedCsvData, schema: generatedSchema }),
          locked: false
        },
        {
          id: 'blueprint-page-detail',
          type: 'blueprint-page',
          title: 'Record Details',
          x: 1240,
          y: 480,
          width: 360,
          height: 650,
          blueprintContent: generateBlueprintContent('detail-view', { csvData: parsedCsvData, schema: generatedSchema }),
          locked: false
        },
        {
          id: 'blueprint-page-edit',
          type: 'blueprint-page',
          title: 'Edit Record Form',
          x: 1630,
          y: 480,
          width: 380,
          height: 650,
          blueprintContent: generateBlueprintContent('edit-form', { csvData: parsedCsvData, schema: generatedSchema }),
          locked: false
        }
      ];

      setShapes(blueprintShapes);
      addToHistory(blueprintShapes);
      setIsGenerating(false);
    };

    reader.readAsText(file);
  };

  // Blueprint mode: Handle drag and drop for CSV
  const handleDragOver = (e) => {
    e.preventDefault();
    setIsDraggingFile(true);
  };

  const handleDragLeave = (e) => {
    e.preventDefault();
    if (e.currentTarget === e.target) {
      setIsDraggingFile(false);
    }
  };

  const handleDrop = (e) => {
    e.preventDefault();
    setIsDraggingFile(false);

    const file = e.dataTransfer.files[0];
    if (file && file.name.endsWith('.csv')) {
      handleFileUpload(file);
    } else {
      alert('Please upload a CSV file');
    }
  };

  // NEW: Calculate smart guides during drag
  const calculateGuides = (draggedShape) => {
    const threshold = 5;
    const newGuides = { horizontal: [], vertical: [] };

    shapes.forEach(shape => {
      if (shape.id === draggedShape.id) return;

      // Vertical alignment guides
      if (Math.abs(shape.x - draggedShape.x) < threshold) {
        newGuides.vertical.push(shape.x);
      }
      if (Math.abs(shape.x + shape.width / 2 - (draggedShape.x + draggedShape.width / 2)) < threshold) {
        newGuides.vertical.push(shape.x + shape.width / 2);
      }
      if (Math.abs(shape.x + shape.width - (draggedShape.x + draggedShape.width)) < threshold) {
        newGuides.vertical.push(shape.x + shape.width);
      }

      // Horizontal alignment guides
      if (Math.abs(shape.y - draggedShape.y) < threshold) {
        newGuides.horizontal.push(shape.y);
      }
      if (Math.abs(shape.y + shape.height / 2 - (draggedShape.y + draggedShape.height / 2)) < threshold) {
        newGuides.horizontal.push(shape.y + shape.height / 2);
      }
      if (Math.abs(shape.y + shape.height - (draggedShape.y + draggedShape.height)) < threshold) {
        newGuides.horizontal.push(shape.y + shape.height);
      }
    });

    setGuides(newGuides);
  };

  // Handle drag start
  const handleDragStart = (event) => {
    const { active } = event;
    console.log('Drag start:', active.id, 'Selected shapes:', selectedShapeIds);
    setActiveDragId(active.id);

    // Check if this is a resize handle
    if (typeof active.id === 'string' && active.id.startsWith('resize-handle-')) {
      const position = active.id.replace('resize-handle-', '');
      const selectedShapes = shapes.filter(s => selectedShapeIds.includes(s.id) && !s.locked);

      if (selectedShapes.length > 0) {
        // Calculate initial bounding box and shape data
        const xs = selectedShapes.map(s => s.x);
        const ys = selectedShapes.map(s => s.y);
        const rights = selectedShapes.map(s => s.x + s.width);
        const bottoms = selectedShapes.map(s => s.y + s.height);

        const minX = Math.min(...xs);
        const minY = Math.min(...ys);
        const maxX = Math.max(...rights);
        const maxY = Math.max(...bottoms);

        setResizeStartData({
          position,
          shapes: selectedShapes.map(s => ({
            id: s.id,
            x: s.x,
            y: s.y,
            width: s.width,
            height: s.height
          })),
          boundingBox: {
            x: minX,
            y: minY,
            width: maxX - minX,
            height: maxY - minY
          }
        });
        console.log('Resize start, position:', position, 'shapes:', selectedShapes.length);
      }
      return;
    }

    // Regular shape drag: ensure the dragged shape is selected if not already
    if (!selectedShapeIds.includes(active.id)) {
      setSelectedShapeIds([active.id]);
    }
  };

  // Handle drag move for real-time updates
  const handleDragMove = (event) => {
    const { active, delta } = event;
    setActiveDragTransform(delta);

    if (active && delta) {
      // Check if this is a resize handle
      if (typeof active.id === 'string' && active.id.startsWith('resize-handle-') && resizeStartData) {
        const position = resizeStartData.position;
        const deltaX = delta.x / (zoom / 100);
        const deltaY = delta.y / (zoom / 100);
        const { boundingBox } = resizeStartData;
        let newBoundingBox = { ...boundingBox };

        // Calculate new bounding box based on handle position
        switch (position) {
          case 'se':
            newBoundingBox.width += deltaX;
            newBoundingBox.height += deltaY;
            break;
          case 'sw':
            newBoundingBox.x += deltaX;
            newBoundingBox.width -= deltaX;
            newBoundingBox.height += deltaY;
            break;
          case 'ne':
            newBoundingBox.y += deltaY;
            newBoundingBox.width += deltaX;
            newBoundingBox.height -= deltaY;
            break;
          case 'nw':
            newBoundingBox.x += deltaX;
            newBoundingBox.y += deltaY;
            newBoundingBox.width -= deltaX;
            newBoundingBox.height -= deltaY;
            break;
          case 'e':
            newBoundingBox.width += deltaX;
            break;
          case 'w':
            newBoundingBox.x += deltaX;
            newBoundingBox.width -= deltaX;
            break;
          case 's':
            newBoundingBox.height += deltaY;
            break;
          case 'n':
            newBoundingBox.y += deltaY;
            newBoundingBox.height -= deltaY;
            break;
        }

        // Update preview
        if (newBoundingBox.width >= 20 && newBoundingBox.height >= 20) {
          setResizePreview(newBoundingBox);
        }
      } else {
        // Calculate guides for regular shape drag
        const shape = shapes.find(s => s.id === active.id);
        if (shape) {
          const draggedShape = {
            ...shape,
            x: shape.x + delta.x / (zoom / 100),
            y: shape.y + delta.y / (zoom / 100)
          };
          calculateGuides(draggedShape);
        }
      }
    }
  };

  // Handle drag end from DndContext (UPDATED for multi-drag, resize, and snapping)
  const handleDragEnd = (event) => {
    const { active, delta } = event;
    console.log('Drag end:', active?.id, 'delta:', delta, 'selectedShapeIds:', selectedShapeIds);
    setGuides({ horizontal: [], vertical: [] }); // Clear guides
    setActiveDragId(null);
    setActiveDragTransform(null);
    setResizePreview(null); // Clear resize preview

    if (active && delta) {
      // Check if this is a resize handle
      if (typeof active.id === 'string' && active.id.startsWith('resize-handle-') && resizeStartData) {
        const position = resizeStartData.position;
        const deltaX = delta.x / (zoom / 100);
        const deltaY = delta.y / (zoom / 100);

        // Calculate new dimensions based on handle position
        const { boundingBox, shapes: initialShapes } = resizeStartData;
        let newBoundingBox = { ...boundingBox };

        // Adjust bounding box based on which handle was dragged
        switch (position) {
          case 'se': // Southeast - bottom right
            newBoundingBox.width += deltaX;
            newBoundingBox.height += deltaY;
            break;
          case 'sw': // Southwest - bottom left
            newBoundingBox.x += deltaX;
            newBoundingBox.width -= deltaX;
            newBoundingBox.height += deltaY;
            break;
          case 'ne': // Northeast - top right
            newBoundingBox.y += deltaY;
            newBoundingBox.width += deltaX;
            newBoundingBox.height -= deltaY;
            break;
          case 'nw': // Northwest - top left
            newBoundingBox.x += deltaX;
            newBoundingBox.y += deltaY;
            newBoundingBox.width -= deltaX;
            newBoundingBox.height -= deltaY;
            break;
          case 'e': // East - right
            newBoundingBox.width += deltaX;
            break;
          case 'w': // West - left
            newBoundingBox.x += deltaX;
            newBoundingBox.width -= deltaX;
            break;
          case 's': // South - bottom
            newBoundingBox.height += deltaY;
            break;
          case 'n': // North - top
            newBoundingBox.y += deltaY;
            newBoundingBox.height -= deltaY;
            break;
        }

        // Prevent negative dimensions
        if (newBoundingBox.width < 20 || newBoundingBox.height < 20) {
          setResizeStartData(null);
          return;
        }

        // Calculate scale factors
        const scaleX = newBoundingBox.width / boundingBox.width;
        const scaleY = newBoundingBox.height / boundingBox.height;

        console.log('Resize end - Scale:', scaleX, scaleY, 'New bbox:', newBoundingBox);

        // Apply proportional resize to all selected shapes
        const updatedShapes = shapes.map(shape => {
          const initialShape = initialShapes.find(s => s.id === shape.id);
          if (initialShape) {
            // Calculate relative position within original bounding box
            const relX = initialShape.x - boundingBox.x;
            const relY = initialShape.y - boundingBox.y;

            // Scale dimensions and position
            const newWidth = initialShape.width * scaleX;
            const newHeight = initialShape.height * scaleY;
            const newRelX = relX * scaleX;
            const newRelY = relY * scaleY;

            return {
              ...shape,
              x: newBoundingBox.x + newRelX,
              y: newBoundingBox.y + newRelY,
              width: newWidth,
              height: newHeight
            };
          }
          return shape;
        });

        setShapes(updatedShapes);
        addToHistory(updatedShapes);
        setResizeStartData(null);
        return;
      }

      // Regular shape drag
      const shapeId = active.id;
      const shape = shapes.find(s => s.id === shapeId);

      if (shape && !shape.locked) {
        // If dragging a selected shape, move all selected shapes
        if (selectedShapeIds.includes(shapeId)) {
          console.log('Multi-drag: moving', selectedShapeIds.length, 'shapes');
          const updatedShapes = shapes.map(s => {
            if (selectedShapeIds.includes(s.id) && !s.locked) {
              const newX = snapValue(s.x + delta.x / (zoom / 100));
              const newY = snapValue(s.y + delta.y / (zoom / 100));
              return { ...s, x: newX, y: newY };
            }
            return s;
          });
          setShapes(updatedShapes);
          addToHistory(updatedShapes);
        } else {
          // Single shape drag
          console.log('Single drag');
          const newX = snapValue(shape.x + delta.x / (zoom / 100));
          const newY = snapValue(shape.y + delta.y / (zoom / 100));
          handleShapeDragEnd(shapeId, { x: newX, y: newY });
        }
      }
    }
  };

  // Zoom handlers
  const handleZoomIn = () => {
    setZoom(prev => Math.min(prev + 10, 500));
  };

  const handleZoomOut = () => {
    setZoom(prev => Math.max(prev - 10, 10));
  };

  const handleZoomToFit = () => {
    setZoom(100);
    setCanvasOffset({ x: 0, y: 0 });
  };

  // Handle panning and shape creation
  const handleMouseDown = (e) => {
    // Skip if clicking on resize handles or shape elements
    if (e.target.closest('.shape-element') ||
        e.target.closest('.resize-handle')) {
      console.log('Skipping handleMouseDown - clicked on resize handle or shape');
      return;
    }

    // Only handle clicks on canvas or canvas-content, not on shapes
    if (!e.target.classList.contains('canvas-content') && e.target !== canvasRef.current) {
      console.log('Skipping handleMouseDown - not on canvas-content', e.target);
      return;
    }

    const rect = canvasRef.current.getBoundingClientRect();
    const x = (e.clientX - rect.left - canvasOffset.x) / (zoom / 100);
    const y = (e.clientY - rect.top - canvasOffset.y) / (zoom / 100);

    if (selectedTool === 'hand') {
      setIsPanning(true);
      setPanStart({ x: e.clientX - canvasOffset.x, y: e.clientY - canvasOffset.y });
      e.preventDefault();
    } else if (['rectangle', 'circle', 'diamond', 'arrow', 'line', 'section', 'text'].includes(selectedTool)) {
      // Start creating shape with drag
      setIsCreatingShape(true);
      setCreatingShapeStart({ x, y });
      e.preventDefault();
    } else if (selectedTool === 'select') {
      // Deselect all when clicking empty canvas in select mode
      setSelectedShapeIds([]);
    }
  };

  const handleMouseMove = (e) => {
    if (isPanning) {
      setCanvasOffset({
        x: e.clientX - panStart.x,
        y: e.clientY - panStart.y
      });
    } else if (isCreatingShape && creatingShapeStart) {
      const rect = canvasRef.current.getBoundingClientRect();
      const currentX = (e.clientX - rect.left - canvasOffset.x) / (zoom / 100);
      const currentY = (e.clientY - rect.top - canvasOffset.y) / (zoom / 100);

      const width = Math.abs(currentX - creatingShapeStart.x);
      const height = Math.abs(currentY - creatingShapeStart.y);
      const x = Math.min(currentX, creatingShapeStart.x);
      const y = Math.min(currentY, creatingShapeStart.y);

      // Create preview shape
      let previewShape = null;
      if (['rectangle', 'circle', 'diamond', 'arrow', 'line'].includes(selectedTool)) {
        previewShape = {
          type: selectedTool,
          x,
          y,
          width: Math.max(width, 10),
          height: Math.max(height, 10),
          fill: 'rgba(147, 197, 253, 0.5)',
          stroke: '#3b82f6',
          strokeWidth: 2,
        };
      } else if (selectedTool === 'section') {
        previewShape = {
          type: 'rectangle',
          x,
          y,
          width: Math.max(width, 50),
          height: Math.max(height, 50),
          fill: 'rgba(229, 231, 235, 0.3)',
          stroke: '#9ca3af',
          strokeWidth: 2,
          isSection: true,
        };
      } else if (selectedTool === 'text') {
        previewShape = {
          type: 'text',
          x,
          y,
          width: Math.max(width, 100),
          height: Math.max(height, 30),
          text: 'Double-click to edit',
          fontSize: 16,
          fill: '#18181b',
          fontFamily: 'Inter, system-ui, sans-serif',
        };
      }

      setCreatingShapePreview(previewShape);
    }
  };

  const handleMouseUp = () => {
    if (isPanning) {
      setIsPanning(false);
    } else if (isCreatingShape && creatingShapePreview) {
      // Finalize shape creation
      const newShape = {
        ...creatingShapePreview,
        id: `${selectedTool}-${Date.now()}`,
        rotation: 0,
      };

      const updatedShapes = [...shapes, newShape];
      setShapes(updatedShapes);
      setSelectedShapeIds([newShape.id]);
      addToHistory(updatedShapes);

      // Reset creation state
      setIsCreatingShape(false);
      setCreatingShapeStart(null);
      setCreatingShapePreview(null);

      // Auto-switch back to select tool
      setSelectedTool('select');
    } else if (isCreatingShape) {
      // Handle click without drag (create default size)
      const rect = canvasRef.current.getBoundingClientRect();
      const x = creatingShapeStart.x;
      const y = creatingShapeStart.y;

      let newShape = null;
      if (['rectangle', 'circle', 'diamond', 'arrow', 'line'].includes(selectedTool)) {
        newShape = {
          id: `${selectedTool}-${Date.now()}`,
          type: selectedTool,
          x,
          y,
          width: 100,
          height: 100,
          fill: 'rgba(147, 197, 253, 0.5)',
          stroke: '#3b82f6',
          strokeWidth: 2,
          rotation: 0,
        };
      } else if (selectedTool === 'section') {
        newShape = {
          id: `section-${Date.now()}`,
          type: 'rectangle',
          x,
          y,
          width: 300,
          height: 200,
          fill: 'rgba(229, 231, 235, 0.3)',
          stroke: '#9ca3af',
          strokeWidth: 2,
          rotation: 0,
          isSection: true,
        };
      } else if (selectedTool === 'text') {
        newShape = {
          id: `text-${Date.now()}`,
          type: 'text',
          x,
          y,
          width: 200,
          height: 40,
          text: 'Double-click to edit',
          fontSize: 16,
          fill: '#18181b',
          fontFamily: 'Inter, system-ui, sans-serif',
          rotation: 0,
        };
      }

      if (newShape) {
        const updatedShapes = [...shapes, newShape];
        setShapes(updatedShapes);
        setSelectedShapeIds([newShape.id]);
        addToHistory(updatedShapes);

        // Auto-switch back to select tool
        setSelectedTool('select');
      }

      // Reset creation state
      setIsCreatingShape(false);
      setCreatingShapeStart(null);
      setCreatingShapePreview(null);
    }
  };

  useEffect(() => {
    if (isPanning || isCreatingShape) {
      window.addEventListener('mousemove', handleMouseMove);
      window.addEventListener('mouseup', handleMouseUp);
      return () => {
        window.removeEventListener('mousemove', handleMouseMove);
        window.removeEventListener('mouseup', handleMouseUp);
      };
    }
  }, [isPanning, isCreatingShape, panStart, creatingShapeStart, creatingShapePreview, selectedTool, shapes, zoom, canvasOffset]);

  // Notify parent component when shapes change
  useEffect(() => {
    if (onShapesChange) {
      onShapesChange(shapes);
    }
  }, [shapes, onShapesChange]);

  // Update shape position after drag
  const handleShapeDragEnd = (id, updates) => {
    const updatedShapes = shapes.map(shape =>
      shape.id === id ? { ...shape, ...updates } : shape
    );
    setShapes(updatedShapes);
    addToHistory(updatedShapes);
  };

  // Update shape properties
  const handleShapeUpdate = (id, updates) => {
    const updatedShapes = shapes.map(shape =>
      shape.id === id ? { ...shape, ...updates } : shape
    );
    setShapes(updatedShapes);
    addToHistory(updatedShapes);
  };

  // Handle drawing complete
  const handleDrawingComplete = () => {
    if (signatureRef.current) {
      const dataURL = signatureRef.current.toDataURL();
      if (dataURL) {
        const newShape = {
          id: `drawing-${Date.now()}`,
          type: 'drawing',
          x: 100,
          y: 100,
          width: 400,
          height: 300,
          dataURL,
          rotation: 0
        };
        const updatedShapes = [...shapes, newShape];
        setShapes(updatedShapes);
        addToHistory(updatedShapes);
        signatureRef.current.clear();
        setIsDrawing(false);
      }
    }
  };

  // Handle shape selection (supports multi-select with Ctrl/Cmd)
  const handleShapeSelect = (shapeId, event) => {
    // Don't change selection if we're currently dragging
    if (activeDragId) {
      console.log('handleShapeSelect blocked - activeDragId:', activeDragId);
      return;
    }

    // Don't change selection if clicking on resize handles
    if (event?.target?.closest('.resize-handle')) {
      console.log('handleShapeSelect blocked - clicking on resize handle');
      return;
    }

    console.log('handleShapeSelect called for:', shapeId, 'ctrlKey:', event?.ctrlKey, 'current selection:', selectedShapeIds);

    if (event?.ctrlKey || event?.metaKey) {
      // Toggle selection with Ctrl/Cmd
      setSelectedShapeIds(prev =>
        prev.includes(shapeId)
          ? prev.filter(id => id !== shapeId)
          : [...prev, shapeId]
      );
    } else {
      // Only change selection if clicking on an unselected shape
      // This prevents deselecting other shapes when starting a drag
      setSelectedShapeIds(prev => {
        if (prev.includes(shapeId) && prev.length > 1) {
          // Shape is already selected as part of multi-selection, keep selection
          console.log('Keeping multi-selection:', prev);
          return prev;
        }
        // Single selection
        console.log('Setting single selection:', [shapeId]);
        return [shapeId];
      });
    }
  };

  // Keyboard shortcuts (EXPANDED)
  useEffect(() => {
    const handleKeyDown = (e) => {
      // Ignore if typing in editable field
      if (e.target.isContentEditable || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

      // Spacebar for temporary hand tool (Figma-style)
      if (e.key === ' ' && !isSpacePressed) {
        setIsSpacePressed(true);
        if (selectedTool !== 'hand') {
          setPreviousTool(selectedTool);
          setSelectedTool('hand');
        }
        e.preventDefault();
      }
      // Hand tool with H key
      else if (e.key === 'h' || e.key === 'H') {
        setSelectedTool('hand');
        e.preventDefault();
      }
      // Select tool with V key (common in design tools)
      else if (e.key === 'v' || e.key === 'V') {
        setSelectedTool('select');
        e.preventDefault();
      }
      // Delete selected shapes
      else if (e.key === 'Delete' || e.key === 'Backspace') {
        if (selectedShapeIds.length > 0) {
          const updatedShapes = shapes.filter(shape => !selectedShapeIds.includes(shape.id));
          setShapes(updatedShapes);
          setSelectedShapeIds([]);
          addToHistory(updatedShapes);
          e.preventDefault();
        }
      }
      // Copy
      else if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
        handleCopy();
        e.preventDefault();
      }
      // Paste
      else if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
        handlePaste();
        e.preventDefault();
      }
      // Undo
      else if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
        handleUndo();
        e.preventDefault();
      }
      // Redo
      else if (((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'z') || ((e.ctrlKey || e.metaKey) && e.key === 'y')) {
        handleRedo();
        e.preventDefault();
      }
      // Select all shapes
      else if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
        if (selectedTool === 'select') {
          setSelectedShapeIds(shapes.map(s => s.id));
          e.preventDefault();
        }
      }
      // Lock/Unlock
      else if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
        if (selectedShapeIds.length > 0) {
          handleToggleLock();
          e.preventDefault();
        }
      }
      // Toggle layer panel
      else if ((e.ctrlKey || e.metaKey) && e.key === 'L' && e.shiftKey) {
        setShowLayerPanel(!showLayerPanel);
        e.preventDefault();
      }
      // Toggle grid snapping
      else if ((e.ctrlKey || e.metaKey) && e.key === 'g') {
        setSnapToGrid(!snapToGrid);
        e.preventDefault();
      }
      // Bring to front
      else if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === ']') {
        if (selectedShapeIds.length === 1) {
          handleLayerOrder(selectedShapeIds[0], 'front');
          e.preventDefault();
        }
      }
      // Send to back
      else if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === '[') {
        if (selectedShapeIds.length === 1) {
          handleLayerOrder(selectedShapeIds[0], 'back');
          e.preventDefault();
        }
      }
      // Deselect all
      else if (e.key === 'Escape') {
        setSelectedShapeIds([]);
      }
    };

    const handleKeyUp = (e) => {
      // Release spacebar - revert to previous tool
      if (e.key === ' ' && isSpacePressed) {
        setIsSpacePressed(false);
        if (previousTool) {
          setSelectedTool(previousTool);
          setPreviousTool(null);
        }
        e.preventDefault();
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    window.addEventListener('keyup', handleKeyUp);
    return () => {
      window.removeEventListener('keydown', handleKeyDown);
      window.removeEventListener('keyup', handleKeyUp);
    };
  }, [selectedShapeIds, shapes, selectedTool, clipboard, historyIndex, showLayerPanel, snapToGrid, isSpacePressed, previousTool]);

  // Initialize history with empty state
  useEffect(() => {
    if (history.length === 0) {
      setHistory([[]]);
      setHistoryIndex(0);
    }
  }, []);

  // Force Selecto refresh when shapes change
  useEffect(() => {
    if (selectoRef.current && selectedTool === 'select') {
      // Small delay to ensure DOM is updated
      setTimeout(() => {
        selectoRef.current?.checkScroll();
      }, 0);
    }
  }, [shapes, selectedTool]);

  // Ctrl+Scroll zoom functionality
  useEffect(() => {
    const handleWheel = (e) => {
      if (e.ctrlKey || e.metaKey) {
        e.preventDefault();

        // Determine zoom direction
        const delta = e.deltaY > 0 ? -10 : 10;
        const newZoom = Math.max(10, Math.min(500, zoom + delta));

        setZoom(newZoom);
      }
    };

    const canvasElement = canvasRef.current;
    if (canvasElement) {
      canvasElement.addEventListener('wheel', handleWheel, { passive: false });
      return () => {
        canvasElement.removeEventListener('wheel', handleWheel);
      };
    }
  }, [zoom]);

  // Grid background style
  const gridStyle = showGrid ? {
    backgroundImage: `
      linear-gradient(to right, #e4e4e7 1px, transparent 1px),
      linear-gradient(to bottom, #e4e4e7 1px, transparent 1px)
    `,
    backgroundSize: `${50 * (zoom / 100)}px ${50 * (zoom / 100)}px`,
    backgroundPosition: `${canvasOffset.x}px ${canvasOffset.y}px`
  } : {};

  // If blueprint mode and no CSV loaded, show drop zone
  if (mode === 'blueprint' && !csvData && !isGenerating) {
    return (
      <div className="fixed inset-0 bg-neutral-50 z-50 flex flex-col">
        {/* Header Toolbar */}
        <div className="h-14 bg-white border-b border-neutral-200 flex items-center justify-between px-4 flex-shrink-0">
          <div className="flex items-center gap-4">
            <button
              onClick={onClose}
              className="flex items-center gap-2 px-3 py-1.5 text-sm text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-colors"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15 19l-7-7 7-7" />
              </svg>
              Back
            </button>
            <div className="w-px h-6 bg-neutral-200"></div>
            <h1 className="text-lg font-semibold text-neutral-900">Enterprise Blueprint</h1>
          </div>
        </div>

        {/* CSV Drop Zone */}
        <div className="flex-1 flex items-center justify-center p-8">
          <div
            className={`w-full max-w-2xl transition-all duration-300 ${
              isDraggingFile ? 'scale-105' : 'scale-100'
            }`}
            onDragOver={handleDragOver}
            onDragLeave={handleDragLeave}
            onDrop={handleDrop}
          >
            <div
              className={`border-2 border-dashed rounded-xl p-16 text-center transition-all duration-300 ${
                isDraggingFile
                  ? 'border-neutral-900 bg-neutral-100 shadow-2xl'
                  : 'border-neutral-300 bg-white hover:border-neutral-400 hover:bg-neutral-50'
              }`}
            >
              <div className="flex flex-col items-center gap-6">
                <div className={`w-20 h-20 rounded-full flex items-center justify-center transition-colors ${
                  isDraggingFile ? 'bg-neutral-900 text-white' : 'bg-neutral-100 text-neutral-600'
                }`}>
                  <svg className="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                  </svg>
                </div>
                <div>
                  <h2 className="text-2xl font-semibold text-neutral-900 mb-2">
                    {isDraggingFile ? 'Drop your CSV file here' : 'Drop CSV to Generate Blueprint'}
                  </h2>
                  <p className="text-neutral-500 text-sm">
                    Upload your data file to automatically generate working UI on the canvas
                  </p>
                </div>
                <div className="flex items-center gap-3">
                  <input
                    type="file"
                    accept=".csv"
                    onChange={(e) => handleFileUpload(e.target.files[0])}
                    className="hidden"
                    id="csv-upload"
                  />
                  <label
                    htmlFor="csv-upload"
                    className="px-6 py-2.5 bg-neutral-900 text-white rounded-lg hover:bg-neutral-800 transition-colors cursor-pointer text-sm font-medium"
                  >
                    Choose File
                  </label>
                  <span className="text-neutral-400 text-sm">or drag and drop</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Loading Overlay */}
        {isGenerating && (
          <div className="absolute inset-0 bg-neutral-900/50 backdrop-blur-sm flex items-center justify-center z-50">
            <div className="bg-white rounded-lg p-8 shadow-2xl flex flex-col items-center gap-4">
              <div className="w-12 h-12 border-4 border-neutral-200 border-t-neutral-900 rounded-full animate-spin"></div>
              <div className="text-lg font-medium text-neutral-900">Generating Blueprint...</div>
              <div className="text-sm text-neutral-500">Creating frames on canvas</div>
            </div>
          </div>
        )}
      </div>
    );
  }

  return (
    <div className="relative w-full h-full bg-neutral-100 overflow-hidden">
      {/* Floating Toolbar */}
      <FloatingToolbar
        selectedTool={selectedTool}
        setSelectedTool={setSelectedTool}
        zoom={zoom}
        setZoom={setZoom}
        showGrid={showGrid}
        setShowGrid={setShowGrid}
        showRuler={showRuler}
        setShowRuler={setShowRuler}
        currentView={currentView}
        setCurrentView={setCurrentView}
        onZoomIn={handleZoomIn}
        onZoomOut={handleZoomOut}
        onZoomToFit={handleZoomToFit}
      />

      {/* Canvas Container */}
      <div
        ref={canvasRef}
        className="w-full h-full relative"
        style={{
          ...gridStyle,
          cursor: selectedTool === 'hand' ? (isPanning ? 'grabbing' : 'grab') :
                  (selectedTool === 'pencil' || selectedTool === 'pen') ? 'crosshair' :
                  ['rectangle', 'circle', 'diamond', 'arrow', 'line', 'section', 'text'].includes(selectedTool) ? 'crosshair' : 'default'
        }}
        onMouseDown={handleMouseDown}
      >
        {/* Canvas Content with zoom and pan transform */}
        <div
          ref={canvasContentRef}
          className="canvas-content"
          style={{
            transform: `translate(${canvasOffset.x}px, ${canvasOffset.y}px) scale(${zoom / 100})`,
            transformOrigin: '0 0',
            width: '10000px',
            height: '10000px',
            position: 'relative'
          }}
        >
          {/* DndContext for drag and drop */}
          <DndContext
            sensors={sensors}
            onDragStart={handleDragStart}
            onDragMove={handleDragMove}
            onDragEnd={handleDragEnd}
          >
            {/* Render all shapes */}
            {shapes.map(shape => (
              <DraggableShape
                key={shape.id}
                shape={shape}
                isSelected={selectedShapeIds.includes(shape.id)}
                onSelect={handleShapeSelect}
                onUpdate={handleShapeUpdate}
                selectedTool={selectedTool}
                zoom={zoom}
                activeDragId={activeDragId}
                activeDragTransform={activeDragTransform}
                selectedShapeIds={selectedShapeIds}
              />
            ))}

            {/* Resize handles for selected shapes - MUST be inside DndContext */}
            {selectedTool === 'select' && (
              <ResizeHandles
                shapes={shapes}
                selectedShapeIds={selectedShapeIds}
                zoom={zoom}
                resizePreview={resizePreview}
              />
            )}

            {/* DragOverlay to show shape being dragged */}
            <DragOverlay dropAnimation={null}>
              {null}
            </DragOverlay>
          </DndContext>

          {/* Preview shape during creation */}
          {creatingShapePreview && (
            <div
              style={{
                position: 'absolute',
                left: `${creatingShapePreview.x}px`,
                top: `${creatingShapePreview.y}px`,
                width: `${creatingShapePreview.width}px`,
                height: `${creatingShapePreview.height}px`,
                pointerEvents: 'none',
                opacity: 0.7,
                border: '2px dashed #3b82f6',
                zIndex: 1000
              }}
            >
              <ShapeElement shape={creatingShapePreview} isSelected={false} />
            </div>
          )}

          {/* Drop outline preview when dragging shapes */}
          {activeDragId && activeDragTransform && selectedShapeIds.map(shapeId => {
            const shape = shapes.find(s => s.id === shapeId);
            if (!shape || shape.locked) return null;

            const newX = shape.x + activeDragTransform.x / (zoom / 100);
            const newY = shape.y + activeDragTransform.y / (zoom / 100);

            return (
              <div
                key={`drop-outline-${shape.id}`}
                style={{
                  position: 'absolute',
                  left: `${newX}px`,
                  top: `${newY}px`,
                  width: `${shape.width}px`,
                  height: `${shape.height}px`,
                  border: '2px dashed #3b82f6',
                  borderRadius: shape.type === 'circle' ? '50%' : '4px',
                  pointerEvents: 'none',
                  zIndex: 98,
                  opacity: 0.6
                }}
              />
            );
          })}
        </div>

        {/* Drawing Layer */}
        {(selectedTool === 'pencil' || selectedTool === 'pen') && (
          <div className="absolute inset-0 z-50" style={{ pointerEvents: isDrawing ? 'auto' : 'none' }}>
            <Signature
              ref={signatureRef}
              options={{
                penColor: '#18181b',
                size: 2
              }}
              onPointerDown={() => setIsDrawing(true)}
              onPointerUp={handleDrawingComplete}
              style={{
                width: '100%',
                height: '100%',
                cursor: 'crosshair'
              }}
            />
          </div>
        )}
      </div>

      {/* Selecto for drag-to-select multiple elements - disabled during resize */}
      {selectedTool === 'select' && canvasContentRef.current && !activeDragId?.toString().startsWith('resize-handle-') && (
        <Selecto
          ref={selectoRef}
          container={canvasContentRef.current}
          dragContainer={canvasContentRef.current}
          selectableTargets={['.shape-element']}
          selectByClick={false}
          selectFromInside={false}
          continueSelect={false}
          toggleContinueSelect={'shift'}
          keyContainer={window}
          hitRate={0}
          onSelectStart={(e) => {
            // Prevent selection if clicking on a shape or resize handles
            const target = e.inputEvent.target;
            const isResizeHandle = target.closest('.resize-handle');
            const isShape = target.closest('.shape-element');

            if (isShape || isResizeHandle) {
              console.log('Selecto prevented - clicking on shape or resize handle');
              return false;
            }
          }}
          onSelect={(e) => {
            console.log('Selecto onSelect called, selected elements:', e.selected.length, 'added:', e.added.length, 'removed:', e.removed.length);

            // Only block if this was a simple click (not a drag) on a shape or resize handle
            // Allow drag-select operations to proceed even if they pass over shapes
            const isDragOperation = e.rect && (e.rect.width > 0 || e.rect.height > 0);
            const target = e.inputEvent?.target;
            const clickedOnShape = target?.closest('.shape-element');
            const clickedOnHandle = target?.closest('.resize-handle');

            if (!isDragOperation && (clickedOnShape || clickedOnHandle)) {
              console.log('Selecto onSelect BLOCKED - simple click on shape/handle, not a drag operation');
              return;
            }

            const selectedIds = e.selected
              .map(el => el.getAttribute('data-shape-id'))
              .filter(id => id !== null);

            console.log('Selecto selectedIds:', selectedIds);

            if (e.inputEvent?.shiftKey) {
              // Add to selection with Shift
              console.log('Selecto: Adding to selection with Shift');
              setSelectedShapeIds(prev => [...new Set([...prev, ...selectedIds])]);
            } else {
              // Replace selection
              console.log('Selecto: Replacing selection with:', selectedIds);
              setSelectedShapeIds(selectedIds);
            }
          }}
        />
      )}

      {/* Rulers */}
      {showRuler && (
        <>
          {/* Horizontal ruler */}
          <div className="absolute top-0 left-6 right-0 h-6 bg-white border-b border-neutral-200 z-[99] overflow-hidden">
            <svg width="100%" height="24" style={{ display: 'block' }}>
              {Array.from({ length: Math.ceil(10000 * (zoom / 100) / 50) }, (_, i) => {
                const xPos = canvasOffset.x + (i * 50 * (zoom / 100));
                const value = i * 50;
                if (xPos < -50 || xPos > window.innerWidth) return null;

                return (
                  <g key={i}>
                    <line
                      x1={xPos}
                      y1={i % 2 === 0 ? 12 : 16}
                      x2={xPos}
                      y2={24}
                      stroke="#d4d4d8"
                      strokeWidth="1"
                    />
                    {i % 2 === 0 && (
                      <text
                        x={xPos + 4}
                        y={10}
                        fontSize="9"
                        fill="#71717a"
                        fontFamily="system-ui"
                      >
                        {value}
                      </text>
                    )}
                  </g>
                );
              }).filter(Boolean)}

              {/* Drag position indicators */}
              {activeDragId && activeDragTransform && (() => {
                const draggedShape = shapes.find(s => s.id === activeDragId);
                if (!draggedShape) return null;

                const draggedX = draggedShape.x + activeDragTransform.x / (zoom / 100);
                const draggedRight = draggedX + draggedShape.width;
                const centerX = draggedX + draggedShape.width / 2;

                return (
                  <>
                    {/* Left edge */}
                    <line
                      x1={canvasOffset.x + draggedX * (zoom / 100)}
                      y1={0}
                      x2={canvasOffset.x + draggedX * (zoom / 100)}
                      y2={24}
                      stroke="#3b82f6"
                      strokeWidth="2"
                    />
                    {/* Right edge */}
                    <line
                      x1={canvasOffset.x + draggedRight * (zoom / 100)}
                      y1={0}
                      x2={canvasOffset.x + draggedRight * (zoom / 100)}
                      y2={24}
                      stroke="#3b82f6"
                      strokeWidth="2"
                    />
                    {/* Center */}
                    <line
                      x1={canvasOffset.x + centerX * (zoom / 100)}
                      y1={0}
                      x2={canvasOffset.x + centerX * (zoom / 100)}
                      y2={24}
                      stroke="#3b82f6"
                      strokeWidth="1"
                      strokeDasharray="2,2"
                    />
                  </>
                );
              })()}
            </svg>
          </div>

          {/* Vertical ruler */}
          <div className="absolute left-0 w-6 bg-white border-r border-neutral-200 z-[99] overflow-hidden" style={{ top: '24px', bottom: 0 }}>
            <svg width="24" height="100%" style={{ display: 'block' }}>
              {Array.from({ length: Math.ceil(10000 * (zoom / 100) / 50) }, (_, i) => {
                const yPos = canvasOffset.y + (i * 50 * (zoom / 100));
                const value = i * 50;
                if (yPos < -50 || yPos > window.innerHeight) return null;

                return (
                  <g key={i}>
                    <line
                      x1={i % 2 === 0 ? 12 : 16}
                      y1={yPos}
                      x2={24}
                      y2={yPos}
                      stroke="#d4d4d8"
                      strokeWidth="1"
                    />
                    {i % 2 === 0 && (
                      <text
                        x={18}
                        y={yPos + 3}
                        fontSize="9"
                        fill="#71717a"
                        fontFamily="system-ui"
                        textAnchor="end"
                        transform={`rotate(-90, 18, ${yPos + 3})`}
                      >
                        {value}
                      </text>
                    )}
                  </g>
                );
              }).filter(Boolean)}

              {/* Drag position indicators */}
              {activeDragId && activeDragTransform && (() => {
                const draggedShape = shapes.find(s => s.id === activeDragId);
                if (!draggedShape) return null;

                const draggedY = draggedShape.y + activeDragTransform.y / (zoom / 100);
                const draggedBottom = draggedY + draggedShape.height;
                const centerY = draggedY + draggedShape.height / 2;

                return (
                  <>
                    {/* Top edge */}
                    <line
                      x1={0}
                      y1={canvasOffset.y + draggedY * (zoom / 100)}
                      x2={24}
                      y2={canvasOffset.y + draggedY * (zoom / 100)}
                      stroke="#3b82f6"
                      strokeWidth="2"
                    />
                    {/* Bottom edge */}
                    <line
                      x1={0}
                      y1={canvasOffset.y + draggedBottom * (zoom / 100)}
                      x2={24}
                      y2={canvasOffset.y + draggedBottom * (zoom / 100)}
                      stroke="#3b82f6"
                      strokeWidth="2"
                    />
                    {/* Center */}
                    <line
                      x1={0}
                      y1={canvasOffset.y + centerY * (zoom / 100)}
                      x2={24}
                      y2={canvasOffset.y + centerY * (zoom / 100)}
                      stroke="#3b82f6"
                      strokeWidth="1"
                      strokeDasharray="2,2"
                    />
                  </>
                );
              })()}
            </svg>
          </div>

          {/* Corner box */}
          <div className="absolute top-0 left-0 w-6 h-6 bg-neutral-100 border-b border-r border-neutral-200 z-[100]" />
        </>
      )}

      {/* Smart Guides */}
      {guides.vertical.map((x, index) => (
        <div
          key={`v-guide-${index}`}
          className="absolute top-0 bottom-0 w-px bg-pink-500 pointer-events-none z-[98]"
          style={{
            left: `${canvasOffset.x + x * (zoom / 100)}px`
          }}
        />
      ))}
      {guides.horizontal.map((y, index) => (
        <div
          key={`h-guide-${index}`}
          className="absolute left-0 right-0 h-px bg-pink-500 pointer-events-none z-[98]"
          style={{
            top: `${canvasOffset.y + y * (zoom / 100)}px`
          }}
        />
      ))}

      {/* Layer Panel */}
      {showLayerPanel && (
        <LayerPanel
          shapes={shapes}
          selectedShapeIds={selectedShapeIds}
          onSelect={handleShapeSelect}
          onLayerOrder={handleLayerOrder}
          onToggleLock={handleToggleLock}
          onClose={() => setShowLayerPanel(false)}
        />
      )}

      {/* Alignment Toolbar */}
      <AlignmentToolbar
        onAlign={handleAlign}
        selectedCount={selectedShapeIds.length}
      />

      {/* Status Bar */}
      <div className="absolute bottom-4 right-4 bg-white rounded-lg shadow-md border border-neutral-200 px-3 py-2 text-xs text-neutral-600 z-[99] flex gap-4">
        <span>Selected: {selectedShapeIds.length}</span>
        <span>Total: {shapes.length}</span>
        <span>Zoom: {zoom}%</span>
        <span className="flex items-center gap-1">
          <span className={snapToGrid ? "text-green-600 font-semibold" : "text-neutral-400"}>
            {snapToGrid ? "Snap ON" : "Snap OFF"}
          </span>
        </span>
        {historyIndex >= 0 && (
          <span className="text-neutral-400">
            History: {historyIndex + 1}/{history.length}
          </span>
        )}
      </div>
    </div>
  );
};

// Blueprint Content Generators - Creates React elements for frame content
const generateBlueprintContent = (type, frameData) => {
  const { csvData, schema } = frameData;

  switch (type) {
    case 'data-schema':
      return (
        <div className="h-full overflow-auto">
          <table className="w-full text-xs">
            <thead className="bg-neutral-100 sticky top-0">
              <tr>
                <th className="px-3 py-2 text-left font-semibold text-neutral-700">Field Name</th>
                <th className="px-3 py-2 text-left font-semibold text-neutral-700">Type</th>
                <th className="px-3 py-2 text-left font-semibold text-neutral-700">Sample</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-neutral-200">
              {schema.map((field) => (
                <tr key={field.id} className="hover:bg-neutral-50">
                  <td className="px-3 py-2">
                    <input
                      type="text"
                      defaultValue={field.name}
                      className="w-full border-none bg-transparent focus:outline-none focus:ring-1 focus:ring-neutral-300 rounded px-1"
                    />
                  </td>
                  <td className="px-3 py-2">
                    <select
                      defaultValue={field.type}
                      className="w-full border-none bg-transparent focus:outline-none focus:ring-1 focus:ring-neutral-300 rounded text-neutral-600"
                    >
                      <option>Text</option>
                      <option>Number</option>
                      <option>Email</option>
                      <option>Date</option>
                      <option>Boolean</option>
                    </select>
                  </td>
                  <td className="px-3 py-2 text-neutral-500 truncate max-w-[120px]">
                    {csvData.rows[0]?.[field.name] || '-'}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );

    case 'dashboard':
      const totalRecords = csvData.rows.length;
      const activeCount = csvData.rows.filter(r => r.Status === 'Active').length;
      const memberTypes = csvData.rows.reduce((acc, row) => {
        const type = row['Member Type'] || 'Unknown';
        acc[type] = (acc[type] || 0) + 1;
        return acc;
      }, {});

      return (
        <div className="h-full overflow-auto p-4 space-y-4">
          {/* Stats Grid */}
          <div className="grid grid-cols-3 gap-3">
            <div className="bg-blue-50 rounded-lg p-3 border border-blue-200">
              <div className="text-2xl font-bold text-blue-900">{totalRecords}</div>
              <div className="text-xs text-blue-700">Total Records</div>
            </div>
            <div className="bg-green-50 rounded-lg p-3 border border-green-200">
              <div className="text-2xl font-bold text-green-900">{activeCount}</div>
              <div className="text-xs text-green-700">Active Members</div>
            </div>
            <div className="bg-purple-50 rounded-lg p-3 border border-purple-200">
              <div className="text-2xl font-bold text-purple-900">{Object.keys(memberTypes).length}</div>
              <div className="text-xs text-purple-700">Member Types</div>
            </div>
          </div>

          {/* Member Type Breakdown */}
          <div className="bg-white rounded-lg border border-neutral-200 p-3">
            <div className="text-sm font-semibold text-neutral-900 mb-3">Member Type Distribution</div>
            <div className="space-y-2">
              {Object.entries(memberTypes).map(([type, count]) => (
                <div key={type} className="flex items-center gap-2">
                  <div className="text-xs text-neutral-600 w-16">{type}</div>
                  <div className="flex-1 bg-neutral-100 rounded-full h-5 overflow-hidden">
                    <div
                      className="bg-neutral-900 h-full flex items-center justify-end pr-2"
                      style={{ width: `${(count / totalRecords) * 100}%` }}
                    >
                      <span className="text-[10px] text-white font-medium">{count}</span>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Recent Activity */}
          <div className="bg-white rounded-lg border border-neutral-200 p-3">
            <div className="text-sm font-semibold text-neutral-900 mb-2">Recent Additions</div>
            <div className="space-y-2">
              {csvData.rows.slice(0, 3).map((row, idx) => (
                <div key={idx} className="flex items-center gap-2 text-xs">
                  <div className="w-6 h-6 rounded-full bg-neutral-200 flex items-center justify-center text-neutral-600 font-medium">
                    {row.Name?.[0] || '?'}
                  </div>
                  <div className="flex-1">
                    <div className="font-medium text-neutral-900">{row.Name}</div>
                    <div className="text-neutral-500">{row.Email}</div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );

    case 'list-view':
      return (
        <div className="h-full overflow-auto">
          <table className="w-full text-xs">
            <thead className="bg-neutral-100 sticky top-0">
              <tr>
                {schema.slice(0, 5).map(field => (
                  <th key={field.id} className="px-3 py-2 text-left font-semibold text-neutral-700">
                    {field.name}
                  </th>
                ))}
              </tr>
            </thead>
            <tbody className="divide-y divide-neutral-200">
              {csvData.rows.map((row, idx) => (
                <tr key={idx} className="hover:bg-neutral-50">
                  {schema.slice(0, 5).map(field => (
                    <td key={field.id} className="px-3 py-2 text-neutral-600">
                      {row[field.name] || '-'}
                    </td>
                  ))}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );

    case 'new-record':
      return (
        <div className="h-full overflow-auto p-4">
          <div className="space-y-3">
            {schema.map(field => (
              <div key={field.id}>
                <label className="block text-xs font-medium text-neutral-700 mb-1">
                  {field.name}
                </label>
                {field.type === 'Boolean' ? (
                  <select className="w-full px-3 py-1.5 text-xs border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-neutral-900">
                    <option>Yes</option>
                    <option>No</option>
                  </select>
                ) : field.type === 'Date' ? (
                  <input
                    type="date"
                    className="w-full px-3 py-1.5 text-xs border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-neutral-900"
                  />
                ) : (
                  <input
                    type={field.type === 'Email' ? 'email' : field.type === 'Number' ? 'number' : 'text'}
                    placeholder={`Enter ${field.name.toLowerCase()}`}
                    className="w-full px-3 py-1.5 text-xs border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-neutral-900"
                  />
                )}
              </div>
            ))}
            <button className="w-full mt-4 px-4 py-2 bg-neutral-900 text-white text-xs font-medium rounded-lg hover:bg-neutral-800 transition-colors">
              Create Record
            </button>
          </div>
        </div>
      );

    case 'detail-view':
      const firstRecord = csvData.rows[0] || {};
      return (
        <div className="h-full overflow-auto p-4">
          <div className="space-y-4">
            <div className="flex items-center gap-3 pb-3 border-b border-neutral-200">
              <div className="w-12 h-12 rounded-full bg-neutral-900 text-white flex items-center justify-center font-semibold text-sm">
                {firstRecord.Name?.[0] || '?'}
              </div>
              <div>
                <div className="font-semibold text-neutral-900">{firstRecord.Name}</div>
                <div className="text-xs text-neutral-500">{firstRecord['Member Type']}</div>
              </div>
            </div>
            <div className="grid grid-cols-2 gap-3">
              {schema.map(field => (
                <div key={field.id}>
                  <div className="text-[10px] font-medium text-neutral-500 uppercase tracking-wider mb-1">
                    {field.name}
                  </div>
                  <div className="text-xs text-neutral-900">
                    {firstRecord[field.name] || '-'}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );

    case 'edit-form':
      const recordToEdit = csvData.rows[0] || {};
      return (
        <div className="h-full overflow-auto p-4">
          <div className="space-y-3">
            {schema.map(field => (
              <div key={field.id}>
                <label className="block text-xs font-medium text-neutral-700 mb-1">
                  {field.name}
                </label>
                {field.type === 'Boolean' ? (
                  <select
                    defaultValue={recordToEdit[field.name]}
                    className="w-full px-3 py-1.5 text-xs border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-neutral-900"
                  >
                    <option>Yes</option>
                    <option>No</option>
                  </select>
                ) : field.type === 'Date' ? (
                  <input
                    type="date"
                    defaultValue={recordToEdit[field.name]}
                    className="w-full px-3 py-1.5 text-xs border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-neutral-900"
                  />
                ) : (
                  <input
                    type={field.type === 'Email' ? 'email' : field.type === 'Number' ? 'number' : 'text'}
                    defaultValue={recordToEdit[field.name]}
                    className="w-full px-3 py-1.5 text-xs border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-neutral-900"
                  />
                )}
              </div>
            ))}
            <div className="flex gap-2 mt-4">
              <button className="flex-1 px-4 py-2 bg-neutral-900 text-white text-xs font-medium rounded-lg hover:bg-neutral-800 transition-colors">
                Save Changes
              </button>
              <button className="px-4 py-2 border border-neutral-300 text-neutral-700 text-xs font-medium rounded-lg hover:bg-neutral-50 transition-colors">
                Cancel
              </button>
            </div>
          </div>
        </div>
      );

    case 'process':
      return (
        <div className={`h-full p-4 ${frameData.color} flex items-center justify-center`}>
          <div className="text-center">
            <div className="w-12 h-12 mx-auto mb-3 rounded-lg bg-white border border-neutral-200 flex items-center justify-center">
              <svg className="w-6 h-6 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                {frameData.icon}
              </svg>
            </div>
            <div className="font-semibold text-neutral-900 text-sm">{frameData.title}</div>
            <div className="text-xs text-neutral-600 mt-1">{frameData.description}</div>
          </div>
        </div>
      );

    default:
      return <div className="p-4 text-neutral-500">Unknown frame type</div>;
  }
};


// Zoom-Out Overlay Component - Shows miniature page view during Outline drag operations
const ZoomOutOverlay = ({ isActive, mainContentRef, overOutlineItemId, activeOutlineItemId, view, droppedElements, selectedRecord, getAllDetailElements }) => {
  const [scale, setScale] = useState(0.2);
  const [contentSnapshot, setContentSnapshot] = useState(null);
  const [elementPositions, setElementPositions] = useState([]);
  const [viewportRect, setViewportRect] = useState(null);
  const overlayRef = useRef(null);

  useEffect(() => {
    if (!isActive || !mainContentRef?.current) return;

    // Calculate scale to fit entire page in viewport
    const calculateScale = () => {
      const content = mainContentRef.current;
      const viewportHeight = window.innerHeight;
      const viewportWidth = window.innerWidth;
      const contentHeight = content.scrollHeight;
      const contentWidth = content.scrollWidth;

      // Scale to fit with some padding (80% of viewport)
      const scaleY = (viewportHeight * 0.75) / contentHeight;
      const scaleX = (viewportWidth * 0.5) / contentWidth;
      const newScale = Math.min(scaleY, scaleX, 0.3); // Cap at 30% for readability

      setScale(newScale);
    };

    calculateScale();

    // Capture content dimensions and element positions
    const content = mainContentRef.current;
    const contentRect = content.getBoundingClientRect();

    // Capture viewport position relative to content
    const viewportTop = content.scrollTop;
    const viewportLeft = content.scrollLeft;
    const viewportWidth = contentRect.width;
    const viewportHeight = contentRect.height;

    setViewportRect({
      top: viewportTop,
      left: viewportLeft,
      width: viewportWidth,
      height: viewportHeight
    });

    setContentSnapshot({
      width: content.scrollWidth,
      height: content.scrollHeight,
      scrollTop: content.scrollTop,
      scrollLeft: content.scrollLeft
    });

    // Capture positions of all visible elements
    const positions = [];
    const currentElements = view === 'detail' && selectedRecord
      ? getAllDetailElements(selectedRecord.id)
      : droppedElements.filter(el => el.context === view && el.visible !== false);

    currentElements.forEach((element) => {
      const domElement = document.getElementById(element.id);
      if (domElement) {
        const rect = domElement.getBoundingClientRect();
        positions.push({
          id: element.id,
          top: rect.top - contentRect.top + content.scrollTop,
          left: rect.left - contentRect.left + content.scrollLeft,
          width: rect.width,
          height: rect.height,
          type: element.type || element.elementType,
          label: element.label || element.elementType || element.type,
        });
      }
    });

    setElementPositions(positions);

    window.addEventListener('resize', calculateScale);
    return () => window.removeEventListener('resize', calculateScale);
  }, [isActive, mainContentRef, view, droppedElements, selectedRecord, getAllDetailElements]);

  if (!isActive || !contentSnapshot) return null;

  return (
    <div
      ref={overlayRef}
      className="fixed inset-0 z-[60] pointer-events-none"
      style={{
        background: 'rgba(0, 0, 0, 0.5)',
        backdropFilter: 'blur(12px)',
        WebkitBackdropFilter: 'blur(12px)',
        animation: 'fadeIn 0.25s cubic-bezier(0.4, 0, 0.2, 1)'
      }}
    >
      {/* Miniature Page Preview - Scaled View of Actual Content */}
      <div className="absolute inset-0 flex items-center justify-center p-12">
        <div
          className="relative bg-white rounded-2xl shadow-[0_20px_60px_rgba(0,0,0,0.4)] overflow-auto border-2 border-neutral-200"
          style={{
            width: `${contentSnapshot.width * scale}px`,
            height: `${Math.min(contentSnapshot.height * scale, window.innerHeight * 0.75)}px`,
            maxWidth: '85vw',
            maxHeight: '75vh',
            transform: 'translateZ(0)', // Force GPU acceleration
            animation: 'fadeInScale 0.3s cubic-bezier(0.4, 0, 0.2, 1)'
          }}
        >
          {/* Live Page Content - Visual representation of elements */}
          <div
            style={{
              transform: `scale(${scale})`,
              transformOrigin: 'top left',
              width: `${contentSnapshot.width}px`,
              height: `${contentSnapshot.height}px`,
              pointerEvents: 'none',
              position: 'relative'
            }}
          >
            {/* Background grid pattern for context */}
            <div
              className="absolute inset-0 opacity-10"
              style={{
                backgroundImage: 'linear-gradient(0deg, #e5e7eb 1px, transparent 1px), linear-gradient(90deg, #e5e7eb 1px, transparent 1px)',
                backgroundSize: '40px 40px'
              }}
            />

            {/* Render element boxes */}
            {elementPositions.map((element) => {
              const isHovered = element.id === overOutlineItemId;
              const isContainer = ['container', 'kanban', 'grid', 'canvas'].includes(element.type);
              // Only highlight containers, not regular elements
              const shouldHighlight = isHovered && isContainer;

              return (
                <div
                  key={element.id}
                  style={{
                    position: 'absolute',
                    top: `${element.top}px`,
                    left: `${element.left}px`,
                    width: `${element.width}px`,
                    height: `${element.height}px`,
                    border: shouldHighlight ? '3px solid #3b82f6' : '1.5px solid #d1d5db',
                    borderRadius: '8px',
                    backgroundColor: shouldHighlight ? 'rgba(59, 130, 246, 0.15)' : 'rgba(255, 255, 255, 0.9)',
                    boxShadow: shouldHighlight
                      ? '0 0 20px 4px rgba(59, 130, 246, 0.4), 0 4px 12px rgba(0, 0, 0, 0.1)'
                      : '0 1px 3px rgba(0, 0, 0, 0.1)',
                    transition: 'all 0.2s ease-out',
                    overflow: 'hidden'
                  }}
                >
                  {/* Element type indicator */}
                  <div
                    style={{
                      position: 'absolute',
                      top: '4px',
                      left: '4px',
                      right: '4px',
                      fontSize: `${Math.max(8, 10 / scale)}px`,
                      fontWeight: '500',
                      color: shouldHighlight ? '#1e40af' : '#6b7280',
                      backgroundColor: shouldHighlight ? 'rgba(255, 255, 255, 0.9)' : 'rgba(249, 250, 251, 0.9)',
                      padding: `${Math.max(2, 4 / scale)}px ${Math.max(4, 6 / scale)}px`,
                      borderRadius: '4px',
                      whiteSpace: 'nowrap',
                      overflow: 'hidden',
                      textOverflow: 'ellipsis',
                      maxWidth: 'calc(100% - 8px)'
                    }}
                  >
                    {element.label}
                  </div>

                  {/* Visual content representation */}
                  <div
                    style={{
                      position: 'absolute',
                      bottom: '6px',
                      left: '6px',
                      right: '6px',
                      top: `${Math.max(20, 24 / scale)}px`,
                      display: 'flex',
                      flexDirection: 'column',
                      gap: `${Math.max(2, 3 / scale)}px`
                    }}
                  >
                    {/* Simulated content lines */}
                    {[...Array(Math.min(3, Math.floor(element.height / 30)))].map((_, i) => (
                      <div
                        key={i}
                        style={{
                          height: `${Math.max(2, 3 / scale)}px`,
                          backgroundColor: shouldHighlight ? '#bfdbfe' : '#e5e7eb',
                          borderRadius: '2px',
                          width: i === 2 ? '60%' : '100%'
                        }}
                      />
                    ))}
                  </div>
                </div>
              );
            })}

            {/* Drop zone indicator for hovered element */}
            {overOutlineItemId && elementPositions.find(el => el.id === overOutlineItemId) && (
              <div
                style={{
                  position: 'absolute',
                  top: `${elementPositions.find(el => el.id === overOutlineItemId).top - 8}px`,
                  left: `${elementPositions.find(el => el.id === overOutlineItemId).left}px`,
                  width: `${elementPositions.find(el => el.id === overOutlineItemId).width}px`,
                  height: '6px',
                  background: 'linear-gradient(to right, #60a5fa, #3b82f6, #60a5fa)',
                  borderRadius: '3px',
                  boxShadow: '0 0 16px 3px rgba(59, 130, 246, 0.6)',
                  animation: 'pulse 1.5s ease-in-out infinite'
                }}
              />
            )}

            {/* Viewport Indicator - Shows current visible area */}
            {viewportRect && (
              <div
                style={{
                  position: 'absolute',
                  top: `${viewportRect.top}px`,
                  left: `${viewportRect.left}px`,
                  width: `${viewportRect.width}px`,
                  height: `${viewportRect.height}px`,
                  border: '2px solid rgba(34, 197, 94, 0.7)',
                  backgroundColor: 'rgba(34, 197, 94, 0.08)',
                  borderRadius: '6px',
                  boxShadow: '0 0 12px 2px rgba(34, 197, 94, 0.3), inset 0 0 20px rgba(34, 197, 94, 0.1)',
                  pointerEvents: 'none',
                  zIndex: 5
                }}
              >
                {/* Viewport label */}
                <div
                  style={{
                    position: 'absolute',
                    top: '-24px',
                    left: '50%',
                    transform: 'translateX(-50%)',
                    fontSize: `${Math.max(9, 11 / scale)}px`,
                    fontWeight: '600',
                    color: '#16a34a',
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    padding: `${Math.max(2, 3 / scale)}px ${Math.max(6, 8 / scale)}px`,
                    borderRadius: '4px',
                    whiteSpace: 'nowrap',
                    boxShadow: '0 2px 4px rgba(0, 0, 0, 0.1)'
                  }}
                >
                  Your View
                </div>
              </div>
            )}
          </div>

          {/* Overlay Info - Positioned over the preview */}
          <div className="absolute top-0 left-0 right-0 p-3 bg-gradient-to-b from-black/20 to-transparent">
            <div className="flex items-center justify-center gap-2 text-white text-xs font-medium drop-shadow-lg">
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
              <span>Page Overview</span>
            </div>
          </div>
        </div>
      </div>

      {/* Header Label - Above the preview */}
      <div className="absolute top-16 left-1/2 transform -translate-x-1/2">
        <div className="px-5 py-2.5 bg-neutral-900 text-white text-sm font-medium rounded-xl shadow-2xl whitespace-nowrap border border-neutral-700">
          <div className="flex items-center gap-2.5">
            <svg className="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
            </svg>
            <span>Zoom View Active</span>
            <div className="flex items-center gap-1 px-2 py-0.5 bg-blue-500 rounded text-xs">
              <div className="w-1.5 h-1.5 bg-white rounded-full animate-pulse"></div>
              Live
            </div>
          </div>
        </div>
      </div>

      {/* Instructions */}
      <div className="absolute bottom-12 left-1/2 transform -translate-x-1/2">
        <div className="px-6 py-3 bg-white/95 backdrop-blur-sm rounded-xl shadow-2xl border border-neutral-200">
          <p className="text-sm text-neutral-700 font-medium text-center flex items-center gap-2">
            <svg className="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Hover over items in the Outline to see drop zones highlighted
          </p>
        </div>
      </div>

      {/* Drop Zone Indicator Badge */}
      {overOutlineItemId && (
        <div className="absolute top-32 right-12">
          <div className="px-4 py-2 bg-blue-500 text-white text-sm font-medium rounded-lg shadow-2xl border border-blue-400 animate-pulse">
            <div className="flex items-center gap-2">
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M5 13l4 4L19 7" />
              </svg>
              <span>Drop Zone Active</span>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// Shared Settings Panel Components
const SettingsHeader = ({ title, subtitle, onBack }) => (
  <div className="flex items-center gap-2">
    <button
      onClick={onBack}
      className="flex-shrink-0 p-1 text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100 rounded transition-colors"
      title="Back to settings"
    >
      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M15 19l-7-7 7-7" />
      </svg>
    </button>
    <div className="flex-1">
      <h3 className="text-sm font-semibold text-neutral-900 mb-1">{title}</h3>
      {subtitle && <p className="text-xs text-neutral-500">{subtitle}</p>}
    </div>
  </div>
);

const LAYOUT_OPTIONS = [
  { id: 'link', name: 'Link', description: 'Single actionable link', icon: 'M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1' },
  { id: 'list', name: 'List', description: 'Vertical item list', icon: 'M4 6h16M4 10h16M4 14h16M4 18h16' },
  { id: 'card', name: 'Card', description: 'Grouped content block', icon: 'M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10' },
  { id: 'grid', name: 'Grid', description: 'Tabular data view', icon: 'M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2' },
  { id: 'visualizations', name: 'Visualizations', description: 'Charts and graphs', icon: 'M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z' },
  { id: 'custom', name: 'Custom', description: 'User-defined template', icon: 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065zM15 12a3 3 0 11-6 0 3 3 0 016 0z' }
];

// FAB Layer Options
const FAB_LAYER_OPTIONS = {
  vertical: [
    {
      id: 'dock',
      name: 'Quick Actions',
      description: 'Collaborate with contextual tools',
      icon: 'M3 10h18M3 14h18M3 6h18M3 18h18'
    },
    {
      id: 'explorer',
      name: 'Explorer',
      description: 'Browse page outline and lists',
      icon: 'M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2zm8 0h-2a2 2 0 00-2 2v10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2z'
    },
    {
      id: 'studio',
      name: 'Context',
      description: 'Workspace views and controls',
      icon: 'M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4'
    }
  ],
  horizontal: [
    {
      id: 'finder',
      name: 'Finder',
      description: 'Navigate and review related data',
      icon: 'M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'
    },
    {
      id: 'insights',
      name: 'Insights',
      description: 'Contextual summaries',
      icon: 'M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z'
    },
    {
      id: 'reports',
      name: 'Reports',
      description: 'Rapid report creation',
      icon: 'M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z'
    },
    {
      id: 'timeline',
      name: 'Timeline',
      description: 'Activities and events over time',
      icon: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z'
    }
  ]
};

// Workspace Views for Studio
const WORKSPACE_VIEWS = [
  { id: 'data', name: 'Data View', description: 'Optimal grid interface', icon: 'M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z' },
  { id: 'design', name: 'Design View', description: 'Tailor user interfaces', icon: 'M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01' },
  { id: 'actions', name: 'Actions', description: 'Configure action behaviors', icon: 'M13 10V3L4 14h7v7l9-11h-7z' },
  { id: 'task', name: 'Task View', description: 'Track work items', icon: 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4' },
  { id: 'calendar', name: 'Calendar View', description: 'Visualize date connections', icon: 'M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z' },
  { id: 'blueprint', name: 'Blueprint View', description: 'Site map and journeys', icon: 'M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7' },
  { id: 'command', name: 'Command View', description: 'Team operations orchestration', icon: 'M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z' }
];

// Interaction Modes for Studio
const INTERACTION_MODES = [
  { id: 'balanced', name: 'Balanced', description: 'Standard defaults', icon: 'M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4' },
  { id: 'chart', name: 'Chart', description: 'Display charts on selection', icon: 'M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z' },
  { id: 'edit', name: 'Design/Edit', description: 'Edit elements on selection', icon: 'M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z' },
  { id: 'filter', name: 'Filter', description: 'Filter by field value', icon: 'M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V4z' },
  { id: 'focus', name: 'Focus', description: 'Set primary context', icon: 'M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z' },
  { id: 'help', name: 'Help', description: 'Display guidance', icon: 'M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' },
  { id: 'timeline', name: 'Timeline', description: 'Field activity timeline', icon: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z' },
  { id: 'view', name: 'View', description: 'Slide out record view', icon: 'M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z' }
];

// User Personas for Studio Context Bar
const USER_PERSONAS = [
  { id: 'johndoe', name: '@johndoe', role: 'Admin' },
  { id: 'janedoe', name: '@janedoe', role: 'Editor' },
  { id: 'alexsmith', name: '@alexsmith', role: 'Viewer' },
  { id: 'maryjones', name: '@maryjones', role: 'Contributor' }
];

// Helper function to generate mock timeline activity data
const generateTimelineData = (days, period = 'day', selectedField = null) => {
  const data = [];
  const today = new Date();

  if (period === 'day') {
    for (let i = days - 1; i >= 0; i--) {
      const date = subDays(today, i);
      const count = Math.floor(Math.random() * 25) + (i === 0 ? 5 : 0); // More activity today
      data.push({
        date: format(date, 'MMM dd'),
        fullDate: format(date, 'yyyy-MM-dd'),
        count,
        activities: generateMockActivities(count, date, selectedField)
      });
    }
  } else if (period === 'week') {
    const weeks = Math.ceil(days / 7);
    for (let i = weeks - 1; i >= 0; i--) {
      const weekStart = subDays(today, i * 7);
      const count = Math.floor(Math.random() * 100) + 10;
      data.push({
        date: `Week ${weeks - i}`,
        fullDate: format(weekStart, 'yyyy-MM-dd'),
        count,
        activities: generateMockActivities(count, weekStart, selectedField)
      });
    }
  } else if (period === 'month') {
    const months = Math.ceil(days / 30);
    for (let i = months - 1; i >= 0; i--) {
      const monthStart = subDays(today, i * 30);
      const count = Math.floor(Math.random() * 400) + 50;
      data.push({
        date: format(monthStart, 'MMM'),
        fullDate: format(monthStart, 'yyyy-MM-dd'),
        count,
        activities: generateMockActivities(count, monthStart, selectedField)
      });
    }
  }

  return data;
};

// Generate mock activity details for a specific data point
const generateMockActivities = (count, date, selectedField = null) => {
  const activities = [];
  const activityTypes = selectedField
    ? [`Updated ${selectedField}`, `Changed ${selectedField}`, `Modified ${selectedField}`]
    : ['Created record', 'Updated record', 'Status changed', 'Assigned', 'Comment added', 'File attached', 'Email sent', 'Task completed'];

  const users = ['John Doe', 'Jane Smith', 'Alex Johnson', 'Maria Garcia', 'System'];

  for (let i = 0; i < Math.min(count, 50); i++) { // Cap at 50 activities per data point
    activities.push({
      id: `activity-${date.getTime()}-${i}`,
      type: activityTypes[Math.floor(Math.random() * activityTypes.length)],
      user: users[Math.floor(Math.random() * users.length)],
      timestamp: format(date, 'MMM dd, yyyy HH:mm'),
      details: selectedField
        ? `Changed from "${['Pending', 'In Progress', 'Completed'][Math.floor(Math.random() * 3)]}" to "${['Pending', 'In Progress', 'Completed'][Math.floor(Math.random() * 3)]}"`
        : 'Lorem ipsum dolor sit amet, consectetur adipiscing elit.'
    });
  }

  return activities;
};

// Generate heatmap data for calendar visualization
const generateHeatmapData = (days) => {
  const data = [];
  const today = new Date();

  for (let i = days - 1; i >= 0; i--) {
    const date = subDays(today, i);
    const count = Math.floor(Math.random() * 30);
    data.push({
      date: format(date, 'yyyy-MM-dd'),
      count
    });
  }

  return data;
};

const LayoutSelector = ({ currentLayout, onLayoutChange, customDescription }) => {
  const layoutOptions = customDescription
    ? LAYOUT_OPTIONS.map(opt => opt.id === 'custom' ? { ...opt, description: customDescription } : opt)
    : LAYOUT_OPTIONS;

  return (
    <>
      <div>
        <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">
          Layout
        </label>
      </div>
      <div className="space-y-3">
        {layoutOptions.map((layout) => (
          <button
            key={layout.id}
            onClick={() => onLayoutChange(layout.id)}
            className={`w-full flex items-start gap-3 p-3 rounded-lg border-2 transition-all ${
              currentLayout === layout.id
                ? 'border-neutral-900 bg-neutral-50'
                : 'border-neutral-200 hover:border-neutral-300 hover:bg-neutral-50'
            }`}
          >
            <div className="flex-shrink-0 w-10 h-10 rounded-lg bg-white border border-neutral-200 flex items-center justify-center">
              <svg className="w-5 h-5 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d={layout.icon} />
              </svg>
            </div>
            <div className="flex-1 text-left">
              <div className="text-sm font-medium text-neutral-900">{layout.name}</div>
              <div className="text-xs text-neutral-500 mt-0.5">{layout.description}</div>
            </div>
            {currentLayout === layout.id && (
              <svg className="w-5 h-5 text-neutral-900 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
              </svg>
            )}
          </button>
        ))}
      </div>
    </>
  );
};

// Canvas Layout Mode Selector
const CanvasLayoutModeSelector = ({ containerId, currentMode, onChange }) => {
  const modes = [
    {
      id: 'grid',
      name: 'Grid Mode',
      description: '24/8 column system like Squarespace Fluid Engine',
      icon: 'M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z'
    },
    {
      id: 'freeform',
      name: 'Freeform Mode',
      description: 'Pixel-perfect positioning with full control',
      icon: 'M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z'
    }
  ];

  return (
    <div>
      <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">
        Canvas Mode
      </label>
      <div className="space-y-2">
        {modes.map((mode) => (
          <button
            key={mode.id}
            onClick={() => onChange(mode.id)}
            className={`w-full flex items-start gap-3 p-3 rounded-lg border-2 transition-all ${
              currentMode === mode.id
                ? 'border-blue-500 bg-blue-50'
                : 'border-neutral-200 hover:border-neutral-300 hover:bg-neutral-50'
            }`}
          >
            <div className="flex-shrink-0 w-8 h-8 rounded bg-white border border-neutral-200 flex items-center justify-center">
              <svg className="w-4 h-4 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d={mode.icon} />
              </svg>
            </div>
            <div className="flex-1 text-left">
              <div className="text-sm font-medium text-neutral-900">{mode.name}</div>
              <div className="text-xs text-neutral-500 mt-0.5">{mode.description}</div>
            </div>
            {currentMode === mode.id && (
              <svg className="w-5 h-5 text-blue-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
              </svg>
            )}
          </button>
        ))}
      </div>
    </div>
  );
};

// Breakpoint Selector
const BreakpointSelector = ({ currentBreakpoint, onChange }) => {
  const breakpoints = [
    { id: 'desktop', name: 'Desktop', icon: 'M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z' },
    { id: 'tablet', name: 'Tablet', icon: 'M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z' },
    { id: 'mobile', name: 'Mobile', icon: 'M12 18h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z' }
  ];

  return (
    <div>
      <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">
        Breakpoint
      </label>
      <div className="flex gap-2">
        {breakpoints.map((bp) => (
          <button
            key={bp.id}
            onClick={() => onChange(bp.id)}
            className={`flex-1 flex flex-col items-center gap-2 p-3 rounded-lg border-2 transition-all ${
              currentBreakpoint === bp.id
                ? 'border-blue-500 bg-blue-50'
                : 'border-neutral-200 hover:border-neutral-300 hover:bg-neutral-50'
            }`}
            title={bp.name}
          >
            <svg className="w-5 h-5 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d={bp.icon} />
            </svg>
            <span className="text-xs font-medium text-neutral-900">{bp.name}</span>
          </button>
        ))}
      </div>
    </div>
  );
};

const BorderWidthControl = ({ value, onChange }) => (
  <div>
    <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">
      Border Width: {value ?? 1}px
    </label>
    <input
      type="range"
      min="0"
      max="8"
      step="1"
      value={value ?? 1}
      onChange={(e) => onChange(parseInt(e.target.value))}
      className="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer accent-neutral-900"
    />
    <div className="flex justify-between text-xs text-neutral-400 mt-1">
      <span>0px</span>
      <span>8px</span>
    </div>
  </div>
);

const ColumnSpanControl = ({
  value,
  maxColumns,
  onChange,
  showCollisionWarning = false,
  collisionData = null,
  elementType = 'element', // 'card', 'section', or 'element'
  onFixCollision = null,
  onFixCollisionMouseEnter = null,
  onFixCollisionMouseLeave = null,
  fixCollisionButtonLabel = 'Fix Collision'
}) => (
  <>
    <div>
      <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">
        Column Span: {value ?? 1} {value === 1 ? 'column' : 'columns'}
      </label>
      <input
        type="range"
        min="1"
        max={maxColumns}
        step="1"
        value={value ?? 1}
        onChange={(e) => onChange(parseInt(e.target.value))}
        className="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer accent-neutral-900"
      />
      <div className="flex justify-between text-xs text-neutral-400 mt-1">
        <span>1</span>
        <span>{maxColumns}</span>
      </div>
    </div>

    {/* Collision Warning */}
    {showCollisionWarning && value > 1 && (
      <div className="p-4 bg-amber-50 border border-amber-200 rounded-lg">
        <div className="flex items-start gap-3">
          <svg className="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
            <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
          </svg>
          <div className="flex-1">
            {collisionData && collisionData.hasCollision ? (
              // Detailed collision detection for cards
              <>
                <h4 className="text-sm font-medium text-amber-900 mb-1">
                  Collision Detected
                </h4>
                <p className="text-xs text-amber-700 mb-2">
                  This {elementType} spans {value} columns and overlaps with {collisionData.collisions.length} item{collisionData.collisions.length > 1 ? 's' : ''} in {
                    (() => {
                      const cols = [...new Set(collisionData.collisions.map(e => e.columnIndex))];
                      return cols.map(col => `column ${col + 1}`).join(', ');
                    })()
                  }.
                </p>
                {collisionData.collisions.length > 0 && (
                  <div className="text-xs text-amber-600 mb-3 pl-3 border-l-2 border-amber-300">
                    <div className="font-medium mb-1">Affected items:</div>
                    <ul className="space-y-0.5">
                      {collisionData.collisions.slice(0, 3).map((collision, idx) => (
                        <li key={idx}>
                          â€¢ Column {collision.columnIndex + 1}: {collision.elementType || collision.itemType}
                        </li>
                      ))}
                      {collisionData.collisions.length > 3 && (
                        <li className="text-amber-500">...and {collisionData.collisions.length - 3} more</li>
                      )}
                    </ul>
                  </div>
                )}
                {onFixCollision && (
                  <button
                    onClick={onFixCollision}
                    onMouseEnter={onFixCollisionMouseEnter}
                    onMouseLeave={onFixCollisionMouseLeave}
                    className="flex items-center gap-2 px-3 py-2 bg-amber-600 text-white text-sm font-medium rounded-lg hover:bg-amber-700 transition-colors"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                    </svg>
                    {fixCollisionButtonLabel}
                  </button>
                )}
              </>
            ) : (
              // Simple warning for sections
              <>
                <h4 className="text-sm font-medium text-amber-900 mb-1">
                  Column Spanning Active
                </h4>
                <p className="text-xs text-amber-700 mb-3">
                  This {elementType} spans {value} columns. When a {elementType} spans multiple columns, content in adjacent columns will be overlapped.
                </p>
                <div className="text-xs text-amber-600 bg-amber-100 p-2 rounded">
                  ðŸ’¡ Tip: Use spacer cards in affected columns to prevent content overlap.
                </div>
              </>
            )}
          </div>
        </div>
      </div>
    )}
  </>
);

const SettingsFooter = ({ onDone }) => (
  <button
    onClick={onDone}
    className="w-full px-4 py-2 text-sm text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-colors"
  >
    Done
  </button>
);

// Grid Layout Drop Zone Component - extracted to prevent re-renders
const GridLayoutDropZone = React.memo(({
  elementId,
  gridChildren,
  gridLayouts,
  pageSettings,
  context,
  componentElements,
  setGridLayouts,
  record,
  renderElementContent,
  gridSettings
}) => {
  const { setNodeRef, isOver } = useDroppable({
    id: `grid-container-${elementId}`,
    data: {
      type: 'grid-container',
      containerId: elementId,
    },
  });

  // Track if component is mounted to ignore initial layout changes from react-grid-layout
  const isMountedRef = React.useRef(false);
  React.useEffect(() => {
    isMountedRef.current = true;
    return () => {
      isMountedRef.current = false;
    };
  }, []);

  // Get grid-specific settings or use defaults
  const cols = gridSettings?.cols || 12;
  const rowHeight = gridSettings?.rowHeight || 60;
  const margin = gridSettings?.margin || 8;
  const compactType = gridSettings?.compactType || 'vertical';

  // Memoize layout to prevent recreating on every render
  const layout = React.useMemo(() => {
    const gridData = gridLayouts[elementId] || { children: [], positions: {} };
    return gridChildren.map((child) => {
      const position = gridData.positions[child.id] || { x: 0, y: 0, w: 4, h: 2 };
      return {
        i: child.id,
        x: position.x,
        y: position.y,
        w: position.w,
        h: position.h,
        minW: 2,
        minH: 1,
      };
    });
  }, [gridChildren, gridLayouts, elementId]);

  const handleLayoutChange = React.useCallback((newLayout) => {
    // Ignore layout changes during initial mount - react-grid-layout calls this in componentDidMount
    if (!isMountedRef.current) {
      return;
    }

    const newPositions = {};
    newLayout.forEach((item) => {
      newPositions[item.i] = {
        x: item.x,
        y: item.y,
        w: item.w,
        h: item.h,
      };
    });

    setGridLayouts(prev => ({
      ...prev,
      [elementId]: {
        ...prev[elementId],
        positions: newPositions,
      }
    }));
  }, [elementId, setGridLayouts]);

  return (
    <div
      ref={setNodeRef}
      className={`transition-colors ${
        isOver ? 'ring-2 ring-blue-500 ring-offset-2 rounded-lg' : ''
      }`}
    >
      {gridChildren.length === 0 ? (
        <div className="bg-neutral-50 rounded-lg p-4 min-h-[400px] flex items-center justify-center">
          <div className="text-neutral-400 text-sm">
            Drag elements here to add them to the grid
          </div>
        </div>
      ) : (
        <ReactGridLayout
          className="layout"
          layout={layout}
          cols={cols}
          rowHeight={rowHeight}
          onLayoutChange={handleLayoutChange}
          draggableHandle=".drag-handle"
          compactType={compactType}
          preventCollision={false}
          isDraggable={true}
          isResizable={true}
          margin={[margin, margin]}
        >
          {gridChildren.map((child) => {
            const childCardDef = componentElements.find(e => e.id === child.elementType);

            // Render full element content if available
            const elementContent = renderElementContent ? renderElementContent(child, record) : null;

            return (
              <div key={child.id} className="bg-white rounded-lg border border-neutral-200 overflow-hidden">
                {/* Drag handle header */}
                <div className="flex items-center gap-2 px-3 py-2 bg-neutral-50 border-b border-neutral-200">
                  <div className="drag-handle flex-shrink-0 cursor-move p-1 hover:bg-neutral-100 rounded transition-colors">
                    <svg className="w-4 h-4 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 8h16M4 16h16" />
                    </svg>
                  </div>
                  <div className="flex-1 min-w-0">
                    <div className="text-xs font-medium text-neutral-700 truncate">
                      {childCardDef?.name || 'Element'}
                    </div>
                  </div>
                </div>
                {/* Element content */}
                <div className="p-4 overflow-auto">
                  {elementContent || (
                    <div className="text-xs text-neutral-500">
                      {childCardDef?.description || 'No content available'}
                    </div>
                  )}
                </div>
              </div>
            );
          })}
        </ReactGridLayout>
      )}
    </div>
  );
});

GridLayoutDropZone.displayName = 'GridLayoutDropZone';

// Grid Child Component for Canvas Layout - Defined at module level to prevent re-creation
// Supports drag-to-reorder with grid snapping (like Squarespace Fluid Engine)
const DraggableGridChild = React.memo(({ child, idx, position, containerId, breakpoint, componentElements, gridConfig, onResize }) => {
  const childCardDef = componentElements.find(e => e.id === child.elementType);
  const [isResizing, setIsResizing] = React.useState(false);

  // Store position in ref for drag operations
  const positionRef = React.useRef(position);
  React.useEffect(() => {
    positionRef.current = position;
  }, [position]);

  // Memoize data object to prevent dnd-kit from remeasuring on every render
  const draggableData = React.useMemo(() => ({
    type: 'canvas-grid-child',
    childId: child.id,
    containerId: containerId,
    breakpoint: breakpoint,
    getPosition: () => positionRef.current,
    gridConfig: gridConfig,
  }), [child.id, containerId, breakpoint, gridConfig]);

  const { attributes, listeners, setNodeRef, transform, isDragging } = useDraggable({
    id: `canvas-grid-child-${child.id}`,
    data: draggableData,
  });

  // Memoize style object to prevent unnecessary re-renders
  const style = React.useMemo(() => ({
    gridColumn: position.gridColumn,
    gridRow: position.gridRow,
    zIndex: position.zIndex,
    visibility: isDragging ? 'hidden' : 'visible', // Completely hide during drag - preview shows at drop position
    cursor: 'default',
    transform: 'none', // Disable dnd-kit transform
  }), [position.gridColumn, position.gridRow, position.zIndex, isDragging]);

  return (
    <div
      ref={setNodeRef}
      style={style}
      {...attributes}
      className={`bg-white rounded-lg border-2 p-4 transition-colors shadow-sm overflow-hidden relative group ${
        isDragging ? 'border-blue-500' : 'border-neutral-300 hover:border-blue-400'
      }`}
    >
      {/* Drag handle - top left, offset 10px outside element */}
      <div
        {...listeners}
        className="absolute w-6 h-6 opacity-0 group-hover:opacity-100 transition-opacity cursor-grab flex items-center justify-center bg-white hover:bg-neutral-100 rounded border border-neutral-300 shadow-sm"
        style={{
          pointerEvents: 'auto',
          left: '-10px',
          top: '0px'
        }}
      >
        <svg className="w-3 h-3 text-neutral-400" viewBox="0 0 16 16" fill="currentColor">
          <path d="M5 3C5 2.44772 5.44772 2 6 2C6.55228 2 7 2.44772 7 3C7 3.55228 6.55228 4 6 4C5.44772 4 5 3.55228 5 3ZM9 3C9 2.44772 9.44772 2 10 2C10.5523 2 11 2.44772 11 3C11 3.55228 10.5523 4 10 4C9.44772 4 9 3.55228 9 3ZM6 6C5.44772 6 5 6.44772 5 7C5 7.55228 5.44772 8 6 8C6.55228 8 7 7.55228 7 7C7 6.44772 6.55228 6 6 6ZM9 7C9 6.44772 9.44772 6 10 6C10.5523 6 11 6.44772 11 7C11 7.55228 10.5523 8 10 8C9.44772 8 9 7.55228 9 7ZM6 10C5.44772 10 5 10.4477 5 11C5 11.5523 5.44772 12 6 12C6.55228 12 7 11.5523 7 11C7 10.4477 6.55228 10 6 10ZM9 11C9 10.4477 9.44772 10 10 10C10.5523 10 11 10.4477 11 11C11 11.5523 10.5523 12 10 12C9.44772 12 9 11.5523 9 11ZM6 14C5.44772 14 5 14.4477 5 15C5 15.5523 5.44772 16 6 16C6.55228 16 7 15.5523 7 15C7 14.4477 6.55228 14 6 14ZM9 15C9 14.4477 9.44772 14 10 14C10.5523 14 11 14.4477 11 15C11 15.5523 10.5523 16 10 16C9.44772 16 9 15.5523 9 15Z" />
        </svg>
      </div>
      <div className="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity text-xs text-neutral-400">
        {position.gridColumn}
      </div>
      <div className="text-sm font-medium text-neutral-900 mb-2 pointer-events-none">{childCardDef?.name || 'Element'}</div>
      <div className="text-xs text-neutral-500 pointer-events-none">{childCardDef?.description || ''}</div>

      {/* Resize handle - bottom-right corner */}
      <div
        onMouseDown={(e) => {
          e.stopPropagation();
          setIsResizing(true);

          const containerElement = document.querySelector(`[data-container-id="${containerId}"]`);
          if (!containerElement) return;

          const containerRect = containerElement.getBoundingClientRect();
          const contentWidth = containerRect.width - (gridConfig.gap * 2);
          const columnWidth = (contentWidth - (gridConfig.gap * (gridConfig.columns - 1))) / gridConfig.columns;

          const [colStart, colEnd] = position.gridColumn.split(' / ').map(v => parseInt(v) || 1);
          const currentRow = position.gridRow.split(' / ');
          const rowStart = currentRow[0] === 'auto' ? 1 : parseInt(currentRow[0]) || 1;
          const rowEnd = currentRow[1] === 'auto' ? rowStart + 1 : parseInt(currentRow[1]) || rowStart + 1;

          const handleMouseMove = (moveEvent) => {
            const mouseX = moveEvent.clientX - containerRect.left - gridConfig.gap;
            const mouseY = moveEvent.clientY - containerRect.top - gridConfig.gap;

            // Calculate new column and row end based on mouse position
            const newColEnd = Math.min(
              gridConfig.columns + 1,
              Math.max(colStart + 1, Math.round(mouseX / (columnWidth + gridConfig.gap)) + 1)
            );
            const newRowEnd = Math.max(rowStart + 1, Math.round(mouseY / (gridConfig.rowHeight + gridConfig.gap)) + 1);

            if (onResize) {
              onResize(child.id, {
                gridColumn: `${colStart} / ${newColEnd}`,
                gridRow: `${rowStart} / ${newRowEnd}`,
                zIndex: position.zIndex
              });
            }
          };

          const handleMouseUp = () => {
            setIsResizing(false);
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
          };

          document.addEventListener('mousemove', handleMouseMove);
          document.addEventListener('mouseup', handleMouseUp);
        }}
        className="absolute bottom-0 right-0 w-4 h-4 cursor-nwse-resize opacity-0 group-hover:opacity-100 transition-opacity"
        style={{ pointerEvents: 'auto' }}
      >
        <svg className="w-4 h-4 text-neutral-400" viewBox="0 0 16 16" fill="currentColor">
          <path d="M16 16V14H14V16H16ZM16 11V9H14V11H16ZM13 16V14H11V16H13ZM16 8V6H14V8H16ZM13 13V11H11V13H13ZM10 16V14H8V16H10ZM13 10V8H11V10H13ZM10 13V11H8V13H10ZM10 10V8H8V10H10Z" />
        </svg>
      </div>
    </div>
  );
});

DraggableGridChild.displayName = 'DraggableGridChild';

// Draggable Freeform Child Component for Canvas Layout - Defined at module level to prevent re-creation
const DraggableFreeformChild = React.memo(({ child, idx, position, containerId, breakpoint, componentElements, isSelected, onSelect, elementRefs, setDragRef }) => {
  const childCardDef = componentElements.find(e => e.id === child.elementType);

  // Memoize data object to prevent dnd-kit from remeasuring on every render
  // Note: position is intentionally not in dependencies - we capture it via ref for drag operations
  const positionRef = React.useRef(position);
  React.useEffect(() => {
    positionRef.current = position;
  }, [position]);

  const draggableData = React.useMemo(() => ({
    type: 'canvas-freeform-child',
    childId: child.id,
    containerId: containerId,
    breakpoint: breakpoint,
    getPosition: () => positionRef.current, // Use getter to access current position
  }), [child.id, containerId, breakpoint]);

  const { attributes, listeners, setNodeRef: setDragRefInternal, transform, isDragging } = useDraggable({
    id: `canvas-freeform-child-${child.id}`,
    data: draggableData,
    disabled: isSelected, // Disable dnd-kit drag when using Moveable
  });

  // Memoize style object to prevent unnecessary re-renders
  const style = React.useMemo(() => {
    const baseStyle = {
      position: 'absolute',
      left: `${position.x}px`,
      top: `${position.y}px`,
      width: `${position.width}px`,
      height: `${position.height}px`,
      transformOrigin: 'center center',
      zIndex: position.zIndex,
      cursor: isSelected ? 'move' : 'grab',
      visibility: isDragging ? 'hidden' : 'visible', // Completely hide during drag - preview shows at drop position
      transform: `rotate(${position.rotate || 0}deg)`, // Only apply rotation, no drag transform
    };

    return baseStyle;
  }, [position.x, position.y, position.width, position.height, position.rotate, position.zIndex, isSelected, isDragging]);

  // Memoize click handler
  const handleClick = React.useCallback((e) => {
    e.stopPropagation();
    onSelect(child.id);
  }, [onSelect, child.id]);

  // Memoize ref callback
  const handleRef = React.useCallback((el) => {
    if (el) {
      elementRefs[child.id] = el;
      setDragRefInternal(el);
    }
  }, [elementRefs, child.id, setDragRefInternal]);

  return (
    <div
      ref={handleRef}
      className="moveable-target"
      data-element-id={child.id}
      onClick={handleClick}
      style={style}
      {...attributes}
      {...listeners}
    >
      <div
        className={`bg-white rounded-lg border-2 p-4 transition-colors shadow-sm h-full ${
          isSelected ? 'border-blue-500 ring-2 ring-blue-200' : 'border-neutral-300 hover:border-blue-400'
        }`}
        style={{ overflow: 'auto', userSelect: 'none' }}
      >
        <div className="text-sm font-medium text-neutral-900 mb-2">{childCardDef?.name || 'Element'}</div>
        <div className="text-xs text-neutral-500">{childCardDef?.description || ''}</div>
      </div>
    </div>
  );
});

DraggableFreeformChild.displayName = 'DraggableFreeformChild';

// Canvas Grid Mode Container - Defined at module level to prevent re-creation
const CanvasGridModeContainer = React.memo(({
  elementId,
  canvasData,
  currentBreakpoint,
  canvasChildren,
  currentGridConfig,
  componentElements,
  onUpdateGridPosition,
  activeElementId,
  dragPreviewPosition
}) => {
  const containerRef = useRef(null);

  // Disable droppable when dragging existing canvas children to prevent interference
  const isDraggingCanvasChild = activeElementId &&
    (activeElementId.toString().startsWith('canvas-grid-child-') ||
     activeElementId.toString().startsWith('canvas-freeform-child-'));

  // Memoize data object to prevent dnd-kit from remeasuring on every render
  const droppableData = React.useMemo(() => ({
    type: 'canvas-container',
    containerId: elementId,
    getContainerElement: () => containerRef.current,
  }), [elementId]);

  const { setNodeRef, isOver } = useDroppable({
    id: `canvas-container-${elementId}`,
    data: droppableData,
    disabled: isDraggingCanvasChild, // Disable when dragging canvas children
  });

  // Combine refs
  const setRefs = React.useCallback((node) => {
    containerRef.current = node;
    setNodeRef(node);
  }, [setNodeRef]);

  const positions = canvasData.gridPositions?.[currentBreakpoint] || {};

  return (
    <div
      ref={setRefs}
      data-container-id={elementId}
      className={`relative bg-neutral-50 rounded-lg min-h-[600px] transition-colors ${
        isOver ? 'bg-blue-50 ring-2 ring-blue-500' : ''
      }`}
      style={{
        display: 'grid',
        gridTemplateColumns: `repeat(${currentGridConfig.columns}, 1fr)`,
        gridAutoRows: `${currentGridConfig.rowHeight}px`,
        gap: `${currentGridConfig.gap}px`,
        padding: `${currentGridConfig.gap}px`,
        position: 'relative',
      }}
    >
      {/* Grid overlay */}
      <div className="absolute inset-0 pointer-events-none" style={{ padding: `${currentGridConfig.gap}px` }}>
        <div
          style={{
            display: 'grid',
            gridTemplateColumns: `repeat(${currentGridConfig.columns}, 1fr)`,
            gridAutoRows: `${currentGridConfig.rowHeight}px`,
            gap: `${currentGridConfig.gap}px`,
            height: '100%',
          }}
        >
          {Array.from({ length: currentGridConfig.columns * 12 }).map((_, i) => (
            <div key={i} className="border border-dashed border-neutral-200" />
          ))}
        </div>
      </div>

      {/* Drop indicator for grid mode - shows outline only at drop position */}
      {dragPreviewPosition && dragPreviewPosition.type === 'grid' && dragPreviewPosition.containerId === elementId && (
        <div
          style={{
            gridColumn: dragPreviewPosition.gridColumn,
            gridRow: dragPreviewPosition.gridRow,
            zIndex: 9999,
            pointerEvents: 'none',
          }}
          className="rounded-lg border-2 border-dashed border-blue-500 bg-blue-500/10"
        />
      )}

      {canvasChildren.length === 0 && (
        <div className="col-span-full row-span-full flex items-center justify-center text-neutral-400 text-sm z-10">
          Drag elements here to add them to the grid
        </div>
      )}

      {canvasChildren.map((child, idx) => {
        const position = positions[child.id] || {
          gridColumn: `${1 + (idx % 4) * 6} / ${7 + (idx % 4) * 6}`,
          gridRow: `${Math.floor(idx / 4) + 1} / ${Math.floor(idx / 4) + 2}`,
          zIndex: 1
        };

        return (
          <DraggableGridChild
            key={child.id}
            child={child}
            idx={idx}
            position={position}
            containerId={elementId}
            breakpoint={currentBreakpoint}
            componentElements={componentElements}
            gridConfig={currentGridConfig}
            onResize={(childId, updates) => {
              if (onUpdateGridPosition) {
                onUpdateGridPosition(elementId, currentBreakpoint, childId, updates);
              }
            }}
          />
        );
      })}
    </div>
  );
});

CanvasGridModeContainer.displayName = 'CanvasGridModeContainer';

// Canvas Freeform Mode Container - Defined at module level to prevent re-creation
const CanvasFreeformModeContainer = React.memo(({
  elementId,
  canvasData,
  currentBreakpoint,
  canvasChildren,
  currentGridConfig,
  componentElements,
  onUpdatePosition,
  activeElementId,
  dragPreviewPosition
}) => {
  const containerRef = useRef(null);

  // Disable droppable when dragging existing canvas children to prevent interference
  const isDraggingCanvasChild = activeElementId &&
    (activeElementId.toString().startsWith('canvas-grid-child-') ||
     activeElementId.toString().startsWith('canvas-freeform-child-'));

  // Memoize data object to prevent dnd-kit from remeasuring on every render
  const droppableData = React.useMemo(() => ({
    type: 'canvas-container',
    containerId: elementId,
    getContainerElement: () => containerRef.current,
  }), [elementId]);

  const { setNodeRef, isOver } = useDroppable({
    id: `canvas-container-${elementId}`,
    data: droppableData,
    disabled: isDraggingCanvasChild, // Disable when dragging canvas children
  });

  // Combine refs
  const setRefs = React.useCallback((node) => {
    containerRef.current = node;
    setNodeRef(node);
  }, [setNodeRef]);

  const positions = canvasData.freeformPositions?.[currentBreakpoint] || {};
  const [selectedElement, setSelectedElement] = useState(null);
  const [elementRefs] = useState({});
  const moveableRef = useRef(null);

  // Memoize the update position callback to prevent recreating on every render
  const updatePosition = React.useCallback((childId, updates) => {
    onUpdatePosition(elementId, currentBreakpoint, childId, updates);
  }, [onUpdatePosition, elementId, currentBreakpoint]);

  return (
    <div
      ref={setRefs}
      data-container-id={elementId}
      className={`relative bg-neutral-50 rounded-lg min-h-[600px] transition-colors ${
        isOver ? 'bg-blue-50 ring-2 ring-blue-500' : ''
      }`}
      style={{ position: 'relative', overflow: 'visible' }}
      onClick={(e) => {
        if (e.target === e.currentTarget || e.target.closest('.canvas-bg-overlay')) {
          setSelectedElement(null);
        }
      }}
    >
      {/* Grid overlay for snapping guidance */}
      <div className="absolute inset-0 pointer-events-none opacity-20 canvas-bg-overlay">
        <div
          style={{
            backgroundImage: `
              linear-gradient(to right, #e5e7eb 1px, transparent 1px),
              linear-gradient(to bottom, #e5e7eb 1px, transparent 1px)
            `,
            backgroundSize: `${currentGridConfig.gap * 2}px ${currentGridConfig.gap * 2}px`,
            height: '100%',
            width: '100%',
          }}
        />
      </div>

      {/* Drop indicator for freeform mode - shows outline only at drop position */}
      {dragPreviewPosition && dragPreviewPosition.type === 'freeform' && dragPreviewPosition.containerId === elementId && (
        <div
          style={{
            position: 'absolute',
            left: `${dragPreviewPosition.x}px`,
            top: `${dragPreviewPosition.y}px`,
            width: `${dragPreviewPosition.width}px`,
            height: `${dragPreviewPosition.height}px`,
            transform: `rotate(${dragPreviewPosition.rotate || 0}deg)`,
            transformOrigin: 'center center',
            zIndex: 9999,
            pointerEvents: 'none',
          }}
          className="rounded-lg border-2 border-dashed border-blue-500 bg-blue-500/10"
        />
      )}

      {canvasChildren.length === 0 && (
        <div className="absolute inset-0 flex items-center justify-center text-neutral-400 text-sm canvas-bg-overlay pointer-events-none">
          Drag elements here for freeform positioning
        </div>
      )}

      {canvasChildren.map((child, idx) => {
        const position = positions[child.id] || {
          x: 50 + (idx * 30),
          y: 50 + (idx * 30),
          width: 250,
          height: 150,
          rotate: 0,
          zIndex: 1
        };

        return (
          <DraggableFreeformChild
            key={child.id}
            child={child}
            idx={idx}
            position={position}
            containerId={elementId}
            breakpoint={currentBreakpoint}
            componentElements={componentElements}
            isSelected={selectedElement === child.id}
            onSelect={setSelectedElement}
            elementRefs={elementRefs}
          />
        );
      })}

      {/* Moveable controller for selected element - resize/rotate only */}
      {selectedElement && elementRefs[selectedElement] && (
        <Moveable
          key={selectedElement}
          ref={moveableRef}
          target={elementRefs[selectedElement]}
          container={null}
          draggable={true}
          resizable={true}
          rotatable={true}
          keepRatio={false}
          throttleDrag={0}
          throttleResize={0}
          throttleRotate={0}
          renderDirections={["nw", "n", "ne", "w", "e", "sw", "s", "se"]}
          edge={false}
          zoom={1}
          origin={false}
          padding={{ left: 0, top: 0, right: 0, bottom: 0 }}
          onDragStart={({ set }) => {
            const pos = positions[selectedElement];
            set([pos.x, pos.y]);
          }}
          onDrag={({ target, beforeTranslate }) => {
            const pos = positions[selectedElement];
            target.style.left = `${pos.x + beforeTranslate[0]}px`;
            target.style.top = `${pos.y + beforeTranslate[1]}px`;
          }}
          onDragEnd={({ target }) => {
            updatePosition(selectedElement, {
              x: parseFloat(target.style.left),
              y: parseFloat(target.style.top)
            });
          }}
          onResizeStart={({ setOrigin, dragStart }) => {
            setOrigin(["%", "%"]);
            if (dragStart) {
              dragStart.set([positions[selectedElement].x, positions[selectedElement].y]);
            }
          }}
          onResize={({ target, width, height, drag }) => {
            const pos = positions[selectedElement];
            target.style.width = `${width}px`;
            target.style.height = `${height}px`;
            target.style.left = `${pos.x + drag.beforeTranslate[0]}px`;
            target.style.top = `${pos.y + drag.beforeTranslate[1]}px`;
          }}
          onResizeEnd={({ target }) => {
            updatePosition(selectedElement, {
              x: parseFloat(target.style.left),
              y: parseFloat(target.style.top),
              width: parseFloat(target.style.width),
              height: parseFloat(target.style.height)
            });
          }}
          onRotateStart={({ set }) => {
            set(positions[selectedElement].rotate || 0);
          }}
          onRotate={({ target, beforeRotate }) => {
            target.style.transform = `rotate(${beforeRotate}deg)`;
          }}
          onRotateEnd={({ target }) => {
            const matrix = new DOMMatrix(target.style.transform);
            const angle = Math.atan2(matrix.b, matrix.a) * (180 / Math.PI);
            updatePosition(selectedElement, {
              rotate: angle
            });
          }}
        />
      )}
    </div>
  );
});

CanvasFreeformModeContainer.displayName = 'CanvasFreeformModeContainer';

// Sortable Body Element Component
const SortableBodyElement = ({ element, activePage, customPages, setCustomPages }) => {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging,
  } = useSortable({ id: element.id });

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    opacity: isDragging ? 0.5 : 1,
  };

  const body = activePage?.settings?.body || {};

  return (
    <div
      ref={setNodeRef}
      style={style}
      className="group relative"
    >
      {/* Drag handle */}
      <div
        {...attributes}
        {...listeners}
        className="absolute left-0 top-0 opacity-0 group-hover:opacity-100 transition-opacity cursor-grab active:cursor-grabbing p-1 hover:bg-neutral-100 rounded"
        style={{ marginLeft: '-32px' }}
      >
        <svg className="w-4 h-4 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 8h16M4 16h16" />
        </svg>
      </div>

      {/* Delete button */}
      <button
        onClick={() => {
          setCustomPages(customPages.map(p =>
            p.id === activePage.id
              ? {
                  ...p,
                  settings: {
                    ...p.settings,
                    body: {
                      ...body,
                      elements: (body.elements || []).filter(el => el.id !== element.id)
                    }
                  }
                }
              : p
          ));
        }}
        className="absolute right-0 top-0 opacity-0 group-hover:opacity-100 transition-opacity p-1 hover:bg-red-50 rounded text-neutral-400 hover:text-red-600"
        style={{ marginRight: '-32px' }}
      >
        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
      </button>

      {element.type === 'data' || element.type === 'data-grid' ? (
        <div
          className="border-2 border-dashed border-neutral-300 rounded-lg bg-neutral-50 hover:border-neutral-400 transition-colors"
          onDragOver={(e) => {
            e.preventDefault();
            e.currentTarget.classList.add('border-blue-500', 'bg-blue-50');
          }}
          onDragLeave={(e) => {
            e.currentTarget.classList.remove('border-blue-500', 'bg-blue-50');
          }}
          onDrop={(e) => {
            e.preventDefault();
            e.currentTarget.classList.remove('border-blue-500', 'bg-blue-50');

            const files = Array.from(e.dataTransfer.files);
            const csvFile = files.find(f => f.name.endsWith('.csv'));

            if (csvFile) {
              const reader = new FileReader();
              reader.onload = (event) => {
                const csv = event.target.result;
                const lines = csv.split('\n').filter(line => line.trim());
                if (lines.length === 0) return;

                const headers = lines[0].split(',').map(h => h.trim());
                const rows = lines.slice(1).map(line => {
                  const values = line.split(',').map(v => v.trim());
                  return headers.reduce((obj, header, i) => {
                    obj[header] = values[i] || '';
                    return obj;
                  }, {});
                });

                setCustomPages(customPages.map(p =>
                  p.id === activePage.id
                    ? {
                        ...p,
                        settings: {
                          ...p.settings,
                          body: {
                            ...body,
                            elements: (body.elements || []).map(el =>
                              el.id === element.id
                                ? { ...el, data: { headers, rows } }
                                : el
                            )
                          }
                        }
                      }
                    : p
                ));
              };
              reader.readAsText(csvFile);
            }
          }}
        >
          {!element.data ? (
            <div className="py-12 text-center">
              <svg className="w-12 h-12 mx-auto text-neutral-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
              <p className="text-sm font-medium text-neutral-700 mb-1">Drop CSV file here</p>
              <p className="text-xs text-neutral-500">Or click to upload a CSV file</p>
              <input
                type="file"
                accept=".csv"
                className="hidden"
                id={`csv-upload-${element.id}`}
                onChange={(e) => {
                  const file = e.target.files[0];
                  if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                      const csv = event.target.result;
                      const lines = csv.split('\n').filter(line => line.trim());
                      if (lines.length === 0) return;

                      const headers = lines[0].split(',').map(h => h.trim());
                      const rows = lines.slice(1).map(line => {
                        const values = line.split(',').map(v => v.trim());
                        return headers.reduce((obj, header, i) => {
                          obj[header] = values[i] || '';
                          return obj;
                        }, {});
                      });

                      setCustomPages(customPages.map(p =>
                        p.id === activePage.id
                          ? {
                              ...p,
                              settings: {
                                ...p.settings,
                                body: {
                                  ...body,
                                  elements: (body.elements || []).map(el =>
                                    el.id === element.id
                                      ? { ...el, data: { headers, rows } }
                                      : el
                                  )
                                }
                              }
                            }
                          : p
                      ));
                    };
                    reader.readAsText(file);
                  }
                }}
              />
              <button
                onClick={() => document.getElementById(`csv-upload-${element.id}`).click()}
                className="mt-3 px-4 py-2 bg-neutral-900 text-white text-sm rounded-lg hover:bg-neutral-800 transition-colors"
              >
                Choose File
              </button>
            </div>
          ) : (
            <div className="bg-white rounded-lg overflow-hidden">
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-neutral-100 border-b border-neutral-200">
                    <tr>
                      {element.data.headers.map((header, i) => (
                        <th key={i} className="px-4 py-3 text-left text-xs font-semibold text-neutral-700 uppercase tracking-wider">
                          {header}
                        </th>
                      ))}
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-neutral-200">
                    {element.data.rows.map((row, rowIndex) => (
                      <tr key={rowIndex} className="hover:bg-neutral-50 transition-colors">
                        {element.data.headers.map((header, colIndex) => (
                          <td key={colIndex} className="px-4 py-3 text-sm text-neutral-900">
                            {row[header]}
                          </td>
                        ))}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
              <div className="border-t border-neutral-200 bg-neutral-50 px-4 py-2 flex items-center justify-between">
                <span className="text-xs text-neutral-600">
                  {element.data.rows.length} rows Ã— {element.data.headers.length} columns
                </span>
                <button
                  onClick={() => {
                    setCustomPages(customPages.map(p =>
                      p.id === activePage.id
                        ? {
                            ...p,
                            settings: {
                              ...p.settings,
                              body: {
                                ...body,
                                elements: (body.elements || []).map(el =>
                                  el.id === element.id
                                    ? { ...el, data: null }
                                    : el
                                )
                              }
                            }
                          }
                        : p
                    ));
                  }}
                  className="text-xs text-neutral-600 hover:text-neutral-900 transition-colors"
                >
                  Clear data
                </button>
              </div>
            </div>
          )}
        </div>
      ) : (
        <input
          type="text"
          value={element.content || ''}
          onChange={(e) => {
            setCustomPages(customPages.map(p =>
              p.id === activePage.id
                ? {
                    ...p,
                    settings: {
                      ...p.settings,
                      body: {
                        ...body,
                        elements: (body.elements || []).map(el =>
                          el.id === element.id
                            ? { ...el, content: e.target.value }
                            : el
                        )
                      }
                    }
                  }
                : p
            ));
          }}
          placeholder={`Enter ${element.type.replace(/-/g, ' ')}...`}
          className={`w-full border-0 outline-none bg-transparent focus:ring-0 ${
            element.type === 'heading' || element.type === 'title'
              ? 'text-2xl font-bold text-neutral-900'
              : element.type === 'description'
              ? 'text-sm text-neutral-500'
              : 'text-base text-neutral-900'
          }`}
        />
      )}
    </div>
  );
};

function App() {
  const [view, setView] = useState('list'); // 'list', 'detail', 'canvas', 'custom-page', or 'template-demo'
  const [canvasType, setCanvasType] = useState('empty'); // 'empty' or 'blueprint'
  const [selectedRecord, setSelectedRecord] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedRecords, setSelectedRecords] = useState([]);
  const [editingCommittee, setEditingCommittee] = useState(null); // { committeeIndex, field }
  const [editingLineItem, setEditingLineItem] = useState(null); // { recordId, itemIndex, field }
  const [returningLineItem, setReturningLineItem] = useState(null); // { recordId, itemIndex }
  const [isEditPanelOpen, setIsEditPanelOpen] = useState(false);
  const [isComponentPanelOpen, setIsComponentPanelOpen] = useState(false);
  const [selectedFieldId, setSelectedFieldId] = useState(null); // Which field is selected in edit panel
  const [draggedFieldIndex, setDraggedFieldIndex] = useState(null); // Track dragging field
  const [draggedFieldType, setDraggedFieldType] = useState(null); // Track dragging field type from elements panel
  const [dropTargetIndex, setDropTargetIndex] = useState(null); // Track drop target for visual indicator
  const [openDropdownId, setOpenDropdownId] = useState(null); // Track which custom dropdown is open
  const [rightPanelTab, setRightPanelTab] = useState('elements'); // 'elements' or 'settings'
  const [justDroppedId, setJustDroppedId] = useState(null); // Track recently dropped field for animation
  const fieldRefs = useRef({}); // Track field element refs for FLIP animations
  const fieldPositions = useRef({}); // Track field positions for animations
  const processedDropsRef = useRef(new Set()); // Track processed drops to prevent React StrictMode double-execution
  const [elementSearchFilter, setElementSearchFilter] = useState(''); // Search filter for all elements (blocks/containers/combos/fields)
  const [elementCategoryFilter, setElementCategoryFilter] = useState('all'); // Category filter: 'all', 'blocks', 'containers', 'combos', 'fields'
  const mainContentRef = useRef(null); // Reference to main content area for zoom-out overlay

  // Enterprise UX enhancements
  const [isFilterPanelOpen, setIsFilterPanelOpen] = useState(false);
  const [statusFilter, setStatusFilter] = useState([]);
  const [typeFilter, setTypeFilter] = useState([]);
  const [sortField, setSortField] = useState('title');
  const [sortDirection, setSortDirection] = useState('asc');
  const [visibleColumns, setVisibleColumns] = useState({
    status: true,
    name: true,
    company: true,
    type: true,
    joinDate: true,
    committees: false,
    email: false
  });
  const [openActionMenu, setOpenActionMenu] = useState(null);
  const [showStatsCard, setShowStatsCard] = useState(true);

  // Global header state
  const [isWorkspaceSelectorOpen, setIsWorkspaceSelectorOpen] = useState(false);
  const [isNewRecordMenuOpen, setIsNewRecordMenuOpen] = useState(false);
  const [isUserMenuOpen, setIsUserMenuOpen] = useState(false);
  const [globalSearchTerm, setGlobalSearchTerm] = useState('');
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);
  const [isSidebarPinned, setIsSidebarPinned] = useState(false); // Keep sidebar open even when Explorer is docked
  const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false); // Show icon-only view
  const [expandedFolders, setExpandedFolders] = useState(['current-members']); // Track which folders are expanded

  // Card management state
  const [droppedElements, setDroppedElements] = useState([]); // Elements dropped on pages
  const [cardSettings, setCardSettings] = useState({}); // Settings for each card instance
  const [selectedElementForSettings, setSelectedElementForSettings] = useState(null); // Card being configured
  const [activeElementId, setActiveElementId] = useState(null); // Track actively dragging card (dnd-kit)
  const [dragPreviewPosition, setDragPreviewPosition] = useState(null); // Track preview position for drop indicator
  const [successFeedback, setSuccessFeedback] = useState(null); // Track recently dropped element for success animation

  // Selection cycling state - for cycling through overlapping elements
  const [lastClickTime, setLastClickTime] = useState(0); // Track last click timestamp
  const [clickCycleIndex, setClickCycleIndex] = useState(0); // Current index in cycle
  const clickCycleTimeoutRef = useRef(null); // Timeout to reset cycling

  // Section settings state
  const [sectionSettings, setSectionSettings] = useState({
    committees: { layout: 'custom', borderWidth: 1, columnSpan: 1 }
  }); // Settings for each section type
  const [selectedSectionForSettings, setSelectedSectionForSettings] = useState(null); // Section being configured

  // Auto-spacer feature state
  const [toastMessage, setToastMessage] = useState(null); // Toast notification
  const [highlightedColumns, setHighlightedColumns] = useState([]); // Columns to highlight for preview
  const [recentlyInsertedSpacers, setRecentlyInsertedSpacers] = useState([]); // For animation
  const toastTimeoutRef = useRef(null);
  const spacerAnimationTimeoutRef = useRef(null);

  // Floating Artifact Panels state
  const [floatingPanels, setFloatingPanels] = useState([]); // Array of { id, artifactId, position: {x, y, width, height}, zIndex, minimized }
  const [panelZIndexCounter, setPanelZIndexCounter] = useState(1000); // Counter for z-index management
  const [activeArtifactPanel, setActiveArtifactPanel] = useState(null); // Currently active/focused panel
  const [isArtifactGalleryOpen, setIsArtifactGalleryOpen] = useState(false); // Artifact gallery modal
  const [discussionMarkers, setDiscussionMarkers] = useState({}); // Discussion markers by field { fieldId: [{ id, x, y, priority, text, author, timestamp }] }
  const [activeDiscussion, setActiveDiscussion] = useState(null); // Currently viewing discussion { fieldId, markerId }
  const [canvasZoom, setCanvasZoom] = useState(100); // Zoom level for application form canvas (50-200%)
  const [canvasPan, setCanvasPan] = useState({ x: 0, y: 0 }); // Pan position for canvas
  const [isPanning, setIsPanning] = useState(false); // Track if user is panning with spacebar
  const [isSpacebarPressed, setIsSpacebarPressed] = useState(false); // Track spacebar state for pan mode
  const [discussionPanelPosition, setDiscussionPanelPosition] = useState({ x: 300, y: 100, width: 650, height: 500 }); // Discussion panel position

  // FAB Layers state
  const [isFabExpanded, setIsFabExpanded] = useState(false); // Whether FAB is expanded to show layer options
  const [activeLayers, setActiveLayers] = useState(new Set()); // Which layers are currently active: Set of 'dock', 'explorer', 'studio', 'insights', 'reports', 'timeline'
  const [studioWorkspaceView, setStudioWorkspaceView] = useState('design'); // Current workspace view in Studio
  const [studioInteractionMode, setStudioInteractionMode] = useState('balanced'); // Current interaction mode in Studio
  const [isWorkspaceViewDropdownOpen, setIsWorkspaceViewDropdownOpen] = useState(false);
  const [isInteractionModeDropdownOpen, setIsInteractionModeDropdownOpen] = useState(false);
  const [isContextBarExpanded, setIsContextBarExpanded] = useState(false);
  const [studioDeviceView, setStudioDeviceView] = useState('desktop'); // Current device view: desktop, tablet, mobile
  const [studioUserPersona, setStudioUserPersona] = useState('johndoe'); // Current user persona
  const [isUserPersonaDropdownOpen, setIsUserPersonaDropdownOpen] = useState(false);

  // Slide Deck State
  const [slideDeckSettings, setSlideDeckSettings] = useState({
    template: 'blank',
    theme: 'minimalist',
    aspectRatio: '16:9',
    markdown: '# Welcome to Your Presentation\n\nStart editing to create your first slide!\n\n---\n\n## Slide 2\n\nUse `---` to separate slides.\n\n---\n\n## Features\n\n- Beautiful Apple-inspired design\n- Live preview\n- Code syntax highlighting\n- Easy markdown editing'
  });

  // New Slide Decks Feature State
  const [deckView, setDeckView] = useState('list'); // 'list' or 'editor'
  const [currentDeckId, setCurrentDeckId] = useState(null);

  // Explorer Panel state
  const [explorerPanelMinimized, setExplorerPanelMinimized] = useState(false);
  const [explorerIsDocked, setExplorerIsDocked] = useState(true); // Whether Explorer is docked (vs floating)
  const [explorerPanelSnapped, setExplorerPanelSnapped] = useState('left'); // 'left' | 'right' | 'top' | 'bottom' | null
  const [explorerPanelSize, setExplorerPanelSize] = useState({ width: 320, height: Math.min(window.innerHeight - 96, 600) }); // Leave space for global bar (56px) + padding
  const [explorerPanelPosition, setExplorerPanelPosition] = useState({ x: 20, y: 76 }); // Start below global bar (56px) + padding (20px)
  const [explorerActiveTab, setExplorerActiveTab] = useState('pages'); // 'pages' | 'outline' | 'list'
  const [explorerSearchFilter, setExplorerSearchFilter] = useState('');
  const [explorerPagesSearch, setExplorerPagesSearch] = useState('');
  const [canvasMenuOpen, setCanvasMenuOpen] = useState(false); // Track canvas submenu open state
  const [explorerRecordType, setExplorerRecordType] = useState('contacts'); // 'contacts' | 'tasks' | 'invoices' etc
  const [isExplorerRecordTypeMenuOpen, setIsExplorerRecordTypeMenuOpen] = useState(false);
  const [isExplorerPanelFocused, setIsExplorerPanelFocused] = useState(true);
  const [isExplorerSettingsMenuOpen, setIsExplorerSettingsMenuOpen] = useState(false);
  const [quickAccessHeight, setQuickAccessHeight] = useState(320); // Default height to avoid vertical scrollbar initially
  const [isQuickAccessCollapsed, setIsQuickAccessCollapsed] = useState(false);
  const [draggedTab, setDraggedTab] = useState(null); // Track which tab is being dragged
  const [draggedElement, setDraggedElement] = useState(null); // Track which element is being dragged to Quick Access
  const [hoveredTab, setHoveredTab] = useState(null); // Track which tab is being hovered
  const [dragOverTab, setDragOverTab] = useState(null); // Track which tab is being dragged over for reordering
  const [isQuickAccessDropTarget, setIsQuickAccessDropTarget] = useState(false); // Whether Quick Access is a valid drop target
  const [explorerTabOrder, setExplorerTabOrder] = useState(['pages', 'outline', 'list']); // Order of tabs
  const [detachedPanels, setDetachedPanels] = useState([]); // Panels that have been detached from Explorer
  const [embeddedPanels, setEmbeddedPanels] = useState([]); // Panels embedded within Explorer (above Quick Access)
  const [customPages, setCustomPages] = useState([]); // Custom pages added by user

  const [editingPageId, setEditingPageId] = useState(null); // Track which page name is being edited
  const [activeCustomPageId, setActiveCustomPageId] = useState(null); // Track which custom page is active
  const [draggedPageId, setDraggedPageId] = useState(null); // Track which page is being dragged

  // Database page modal states
  const [showEmojiPicker, setShowEmojiPicker] = useState(false);
  const [showUnsplashModal, setShowUnsplashModal] = useState(false);
  const [showRepositionModal, setShowRepositionModal] = useState(false);
  const [showSlashPalette, setShowSlashPalette] = useState(false);
  const [showPageTemplateGallery, setShowPageTemplateGallery] = useState(false);
  const [slashPalettePosition, setSlashPalettePosition] = useState({ x: 0, y: 0 });
  const [slashPaletteInput, setSlashPaletteInput] = useState(null); // Reference to input that triggered palette
  const [unsplashSearch, setUnsplashSearch] = useState('');
  const [unsplashImages, setUnsplashImages] = useState([]);
  const [repositionValue, setRepositionValue] = useState(50);
  const [editingElementId, setEditingElementId] = useState(null); // Track which element is being edited
  const [isDraggingCover, setIsDraggingCover] = useState(false); // Track if user is dragging to reposition cover
  const [coverDragStartY, setCoverDragStartY] = useState(0); // Track drag start position
  const [coverDragStartPosition, setCoverDragStartPosition] = useState(50); // Track initial cover position
  const [dropTargetPageId, setDropTargetPageId] = useState(null); // Track drop target for page reordering
  const [canvasShapes, setCanvasShapes] = useState([]); // Track shapes from canvas for Explorer Outline
  const [quickAccessIcons, setQuickAccessIcons] = useState([
    // Shapes
    { id: 'rectangle', category: 'shapes', icon: 'M3 3h18v18H3z', label: 'Rectangle' },
    { id: 'diamond', category: 'shapes', icon: 'M12 2l10 10-10 10L2 12z', label: 'Diamond' },
    { id: 'ellipse', category: 'shapes', icon: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z', label: 'Ellipse' },
    { id: 'arrow', category: 'shapes', icon: 'M13 7l5 5m0 0l-5 5m5-5H6', label: 'Arrow' },
    { id: 'line', category: 'shapes', icon: 'M5 12h14', label: 'Line' },
    // Content
    { id: 'draw', category: 'content', icon: 'M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z', label: 'Draw' },
    { id: 'text', category: 'content', icon: 'M4 6h16M4 12h16M4 18h7', label: 'Text' },
    { id: 'list', category: 'content', icon: 'M4 6h16M4 12h16M4 18h16', label: 'List' },
    { id: 'image', category: 'content', icon: 'M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z', label: 'Insert Image' },
    // Tools
    { id: 'marker', category: 'tools', icon: 'M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z', label: 'Marker' },
    { id: 'eraser', category: 'tools', icon: 'M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16', label: 'Eraser' },
  ]);
  const explorerPanelRef = useRef(null);
  const explorerDragHandleRef = useRef(null);
  const explorerResizeHandleRef = useRef(null);
  const quickAccessResizeHandleRef = useRef(null);
  const [activeOutlineItemId, setActiveOutlineItemId] = useState(null);
  const [overOutlineItemId, setOverOutlineItemId] = useState(null);

  // Timeline Panel state
  const [timelinePanelMinimized, setTimelinePanelMinimized] = useState(false);
  const [timelinePanelHeight, setTimelinePanelHeight] = useState(400);
  const [isTimelinePanelFocused, setIsTimelinePanelFocused] = useState(true);
  const [timelineVisualization, setTimelineVisualization] = useState('bar'); // 'bar' | 'heatmap'
  const [timelinePeriod, setTimelinePeriod] = useState('day'); // 'day' | 'week' | 'month'
  const [timelineDateRange, setTimelineDateRange] = useState(30); // Number of days
  const [timelineRecordName, setTimelineRecordName] = useState('Current Record');
  const [timelineSelectedField, setTimelineSelectedField] = useState(null);
  const [timelineSelectedDataPoint, setTimelineSelectedDataPoint] = useState(null);
  const [isTimelineDetailsPanelOpen, setIsTimelineDetailsPanelOpen] = useState(false);
  const [isTimelineFieldSelectorActive, setIsTimelineFieldSelectorActive] = useState(false);
  const timelinePanelRef = useRef(null);

  // Insights Panel state
  const [insightsPanelMinimized, setInsightsPanelMinimized] = useState(false);
  const [insightsPanelHeight, setInsightsPanelHeight] = useState(450);
  const [isInsightsPanelFocused, setIsInsightsPanelFocused] = useState(true);
  const [insightsSelectedField, setInsightsSelectedField] = useState(null);
  const [isInsightsFieldSelectorActive, setIsInsightsFieldSelectorActive] = useState(false);
  const [insightsVisualizations, setInsightsVisualizations] = useState([
    { id: 'status', type: 'pie', title: 'Status Distribution', field: 'status', enabled: true },
    { id: 'priority', type: 'donut', title: 'Priority Breakdown', field: 'priority', enabled: true },
    { id: 'trend', type: 'line', title: 'Activity Trend', field: 'createdDate', enabled: true },
    { id: 'assignee', type: 'bar', title: 'Tasks by Assignee', field: 'assignee', enabled: true },
    { id: 'completion', type: 'progress', title: 'Completion Rate', field: 'completionRate', enabled: true },
    { id: 'category', type: 'bar', title: 'Category Distribution', field: 'category', enabled: true },
    { id: 'overdue', type: 'metric', title: 'Overdue Items', field: 'dueDate', enabled: true },
  ]);
  const [insightsSelectedChart, setInsightsSelectedChart] = useState(null);
  const insightsPanelRef = useRef(null);

  // Finder Panel state
  const [finderPanelMinimized, setFinderPanelMinimized] = useState(false);
  const [finderIsDocked, setFinderIsDocked] = useState(true); // Whether Finder is docked (vs floating)
  const [finderPanelSnapped, setFinderPanelSnapped] = useState('bottom'); // 'left' | 'right' | 'top' | 'bottom' | null
  const [finderPanelSize, setFinderPanelSize] = useState({ width: window.innerWidth - 96, height: 350 }); // Default docked to bottom
  const [finderPanelPosition, setFinderPanelPosition] = useState({ x: 20, y: window.innerHeight - 400 }); // Start near bottom
  const [isFinderPanelFocused, setIsFinderPanelFocused] = useState(true);
  const [finderSearchFilter, setFinderSearchFilter] = useState('');
  const finderPanelRef = useRef(null);

  // Flex Panel state - allows blocks to become floating, resizable panels
  const [flexPanelSettings, setFlexPanelSettings] = useState({}); // { elementId: { enabled, position, size, minimized, maximized, zIndex } }
  const [flexPanelFocusStates, setFlexPanelFocusStates] = useState({}); // { elementId: boolean } - Track focus state for each panel
  const flexPanelRefs = useRef({}); // References to flex panel elements
  const [hoveredElementId, setHoveredElementId] = useState(null); // Track which element is being hovered for pop-out icon
  const [flexPanelTransitioning, setFlexPanelTransitioning] = useState(null); // Track element ID currently transitioning
  const elementRectCache = useRef({}); // Cache element positions for FLIP animation
  const [isFlexPanelArrangeMenuOpen, setIsFlexPanelArrangeMenuOpen] = useState(false); // Track auto-arrange dropdown menu state

  // Helper function to toggle a layer on/off
  const toggleLayer = (layerId) => {
    setActiveLayers(prevLayers => {
      const newLayers = new Set(prevLayers);
      if (newLayers.has(layerId)) {
        newLayers.delete(layerId);
      } else {
        newLayers.add(layerId);
      }
      return newLayers;
    });
  };

  // Helper function to check if a layer is active
  const isLayerActive = (layerId) => {
    return activeLayers.has(layerId);
  };

  // Check if we're in design/edit mode (vs view mode)
  const isDesignMode = () => {
    return isLayerActive('explorer') || isLayerActive('studio') || isComponentPanelOpen;
  };

  // Flex Panel helper functions
  const isFlexPanelEnabled = (elementId) => {
    return flexPanelSettings[elementId]?.enabled || false;
  };

  const toggleFlexPanel = (elementId, withAnimation = true) => {
    const isEnabled = flexPanelSettings[elementId]?.enabled;

    if (isEnabled) {
      // Disable flex panel (return to grid)
      if (withAnimation) {
        setFlexPanelTransitioning(elementId);
        // Clear transition after animation completes
        setTimeout(() => {
          setFlexPanelTransitioning(null);
        }, 350);
      }

      setFlexPanelSettings(prev => {
        const newSettings = { ...prev };
        delete newSettings[elementId];
        return newSettings;
      });
    } else {
      // Enable flex panel
      // Capture current element position for FLIP animation
      const element = document.getElementById(elementId);
      if (element && withAnimation) {
        const rect = element.getBoundingClientRect();
        elementRectCache.current[elementId] = {
          x: rect.left,
          y: rect.top,
          width: rect.width,
          height: rect.height
        };
        setFlexPanelTransitioning(elementId);

        // Clear transition after animation completes
        setTimeout(() => {
          setFlexPanelTransitioning(null);
        }, 350);
      }

      // Calculate smart initial position based on current element location
      const rect = element ? element.getBoundingClientRect() : null;
      const initialX = rect ? Math.max(20, rect.left - 50) : 100;
      const initialY = rect ? Math.max(76, rect.top - 50) : 100;

      setFlexPanelSettings(prev => ({
        ...prev,
        [elementId]: {
          enabled: true,
          position: { x: initialX, y: initialY },
          size: { width: rect?.width || 400, height: rect?.height || 300 },
          minimized: false,
          maximized: false,
          zIndex: 100 + Object.keys(prev).length,
        }
      }));
    }
  };

  const updateFlexPanelSettings = (elementId, updates) => {
    setFlexPanelSettings(prev => ({
      ...prev,
      [elementId]: {
        ...prev[elementId],
        ...updates
      }
    }));
  };

  // Auto-arrange flex panels
  const autoArrangeFlexPanels = (layout) => {
    const activePanelIds = Object.keys(flexPanelSettings).filter(id => flexPanelSettings[id]?.enabled);
    if (activePanelIds.length === 0) return;

    const headerHeight = 76; // Global bar height + padding
    const padding = 20;
    const availableWidth = window.innerWidth - (padding * 2);
    const availableHeight = window.innerHeight - headerHeight - padding;

    let newSettings = { ...flexPanelSettings };

    switch (layout) {
      case 'grid': {
        // Calculate optimal grid layout
        const panelCount = activePanelIds.length;
        const cols = Math.ceil(Math.sqrt(panelCount));
        const rows = Math.ceil(panelCount / cols);

        const panelWidth = Math.max(300, (availableWidth - (padding * (cols - 1))) / cols);
        const panelHeight = Math.max(200, (availableHeight - (padding * (rows - 1))) / rows);

        activePanelIds.forEach((id, index) => {
          const col = index % cols;
          const row = Math.floor(index / cols);
          const x = padding + (col * (panelWidth + padding));
          const y = headerHeight + (row * (panelHeight + padding));

          newSettings[id] = {
            ...newSettings[id],
            position: { x, y },
            size: { width: panelWidth, height: panelHeight },
            minimized: false,
            maximized: false,
          };
        });
        break;
      }

      case 'side-by-side': {
        // Arrange panels horizontally
        const panelWidth = Math.max(300, (availableWidth - (padding * (activePanelIds.length - 1))) / activePanelIds.length);
        const panelHeight = Math.max(200, availableHeight);

        activePanelIds.forEach((id, index) => {
          const x = padding + (index * (panelWidth + padding));
          const y = headerHeight;

          newSettings[id] = {
            ...newSettings[id],
            position: { x, y },
            size: { width: panelWidth, height: panelHeight },
            minimized: false,
            maximized: false,
          };
        });
        break;
      }

      case 'stacked': {
        // Arrange panels vertically
        const panelWidth = Math.max(300, availableWidth);
        const panelHeight = Math.max(200, (availableHeight - (padding * (activePanelIds.length - 1))) / activePanelIds.length);

        activePanelIds.forEach((id, index) => {
          const x = padding;
          const y = headerHeight + (index * (panelHeight + padding));

          newSettings[id] = {
            ...newSettings[id],
            position: { x, y },
            size: { width: panelWidth, height: panelHeight },
            minimized: false,
            maximized: false,
          };
        });
        break;
      }

      case 'cascade': {
        // Classic diagonal window cascade - each window offset from the previous
        const panelWidth = Math.max(400, Math.min(600, availableWidth * 0.5));
        const panelHeight = Math.max(300, Math.min(500, availableHeight * 0.6));
        const offsetX = 40; // Horizontal offset between windows
        const offsetY = 40; // Vertical offset between windows

        activePanelIds.forEach((id, index) => {
          // Calculate position with wrapping if we run out of space
          const maxCascadeSteps = Math.min(
            Math.floor((availableWidth - panelWidth) / offsetX),
            Math.floor((availableHeight - panelHeight) / offsetY)
          );
          const step = index % (maxCascadeSteps + 1);

          const x = padding + (step * offsetX);
          const y = headerHeight + (step * offsetY);

          newSettings[id] = {
            ...newSettings[id],
            position: { x, y },
            size: { width: panelWidth, height: panelHeight },
            minimized: false,
            maximized: false,
            zIndex: 100 + index, // Stack in order
          };
        });
        break;
      }

      case 'coverflow': {
        // Cover Flow style - overlapping panels arranged horizontally with depth
        const panelWidth = Math.max(350, Math.min(500, availableWidth * 0.4));
        const panelHeight = Math.max(300, Math.min(450, availableHeight * 0.7));
        const overlapAmount = panelWidth * 0.65; // Panels overlap by 65%
        const centerY = headerHeight + (availableHeight - panelHeight) / 2;

        // Calculate total width needed and center the arrangement
        const totalWidth = activePanelIds.length > 1
          ? panelWidth + ((activePanelIds.length - 1) * overlapAmount)
          : panelWidth;
        const startX = Math.max(padding, (window.innerWidth - totalWidth) / 2);

        activePanelIds.forEach((id, index) => {
          const x = startX + (index * overlapAmount);
          const y = centerY;

          // Center panel is slightly larger and more prominent
          const isCenter = Math.floor(activePanelIds.length / 2) === index;
          const scale = isCenter ? 1.1 : 1.0;
          const adjustedWidth = panelWidth * scale;
          const adjustedHeight = panelHeight * scale;
          const adjustedY = y - (isCenter ? (adjustedHeight - panelHeight) / 2 : 0);

          newSettings[id] = {
            ...newSettings[id],
            position: { x, y: adjustedY },
            size: { width: adjustedWidth, height: adjustedHeight },
            minimized: false,
            maximized: false,
            zIndex: isCenter ? 110 : 100 + (activePanelIds.length - Math.abs(index - Math.floor(activePanelIds.length / 2))),
          };
        });
        break;
      }

      default:
        break;
    }

    setFlexPanelSettings(newSettings);
    setIsFlexPanelArrangeMenuOpen(false);
  };

  // Configure dnd-kit sensors
  const sensors = useSensors(
    useSensor(PointerSensor, {
      activationConstraint: {
        distance: 8, // Drag starts after moving 8px
      },
    }),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  );

  // Keyboard shortcut for toggling Explorer panel (Cmd/Ctrl + E)
  useEffect(() => {
    const handleKeyDown = (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'e') {
        e.preventDefault();
        toggleLayer('explorer');
        if (!isLayerActive('explorer')) {
          setIsFabExpanded(true);
        }
      }
      // Cmd/Ctrl + Shift + P: Toggle Flex Panel for selected element
      if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key === 'P') {
        e.preventDefault();
        if (selectedElementForSettings) {
          toggleFlexPanel(selectedElementForSettings);
        }
      }
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [activeLayers, selectedElementForSettings]);

  // ESC key to cancel drag operation from Outline or exit field selection mode
  useEffect(() => {
    const handleEscapeKey = (e) => {
      if (e.key === 'Escape') {
        e.preventDefault();

        // Priority 1: Exit Timeline field selection mode
        if (isTimelineFieldSelectorActive) {
          setIsTimelineFieldSelectorActive(false);
          return;
        }

        // Priority 2: Exit Insights field selection mode
        if (isInsightsFieldSelectorActive) {
          setIsInsightsFieldSelectorActive(false);
          return;
        }

        // Priority 3: Cancel Outline drag operation
        if (activeOutlineItemId) {
          setActiveOutlineItemId(null);
          setOverOutlineItemId(null);
          setActiveElementId(null);
          return;
        }

        // Priority 4: Navigate back to list view from detail view
        if (view === 'detail' && selectedRecord) {
          setView('list');
          setSelectedRecord(null);
          return;
        }
      }
    };
    window.addEventListener('keydown', handleEscapeKey);
    return () => window.removeEventListener('keydown', handleEscapeKey);
  }, [activeOutlineItemId, isTimelineFieldSelectorActive, isInsightsFieldSelectorActive, view, selectedRecord]);

  // Auto-open component panel when entering detail view to show drag handles
  // DISABLED: Users should manually enable design mode instead of having it on by default
  // useEffect(() => {
  //   if (view === 'detail' && selectedRecord && !isComponentPanelOpen) {
  //     setIsComponentPanelOpen(true);
  //   }
  // }, [view, selectedRecord]);

  // Handle window resize to prevent panel from going off-screen
  useEffect(() => {
    const handleResize = () => {
      const newHeight = Math.min(window.innerHeight - 96, 600);
      setExplorerPanelSize(prev => ({ ...prev, height: newHeight }));

      // Adjust position if panel is off-screen
      setExplorerPanelPosition(prev => ({
        x: Math.max(20, Math.min(prev.x, window.innerWidth - explorerPanelSize.width - 20)),
        y: Math.max(76, Math.min(prev.y, window.innerHeight - 200))
      }));
    };
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, [explorerPanelSize.width]);

  // Detail page unified layout management
  // Tracks the order of sections AND cards for each record's detail page
  // Structure: { recordId: [{ type: 'section', id: 'section-header', sectionId: 'header' }, { type: 'card', id: 'event-123' }, ...] }
  const [detailPageLayouts, setDetailPageLayouts] = useState({});

  // UNDO/REDO SYSTEM for Layout Changes
  const [layoutHistory, setLayoutHistory] = useState([]);
  const [layoutHistoryIndex, setLayoutHistoryIndex] = useState(-1);
  const [lastSavedLayouts, setLastSavedLayouts] = useState({});
  const MAX_HISTORY_SIZE = 50;

  // AUTO-SAVE & UNSAVED CHANGES TRACKING
  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
  const [showRestoreDraftDialog, setShowRestoreDraftDialog] = useState(false);
  const [draftToRestore, setDraftToRestore] = useState(null);

  // Page settings state
  const [pageSettings, setPageSettings] = useState({
    list: {
      // Container settings
      containerWidth: 'full', // 'standard' | 'wide' | 'narrow' | 'full' | 'custom'
      customWidth: 1200,
      // Layout settings
      columns: 1,
      columnWidths: [100], // Array of percentages, must sum to 100
      // Spacing settings
      columnGap: 24, // px
      contentPadding: 12, // px
      sectionSpacing: 8, // px
      // Responsive settings
      mobileBreakpoint: 768, // px
      mobileStackReverse: false,
    },
    detail: {
      // 3-Zone Layout System (Header, Body, Footer)
      zones: {
        header: {
          visible: true,
          containerWidth: 'standard',
          rows: [
            {
              id: 'header-row',
              order: 0,
              columns: 3,
              columnWidths: [25, 50, 25],
              columnGap: 24,
              elements: [
                { id: 'breadcrumb', type: 'zone', elementType: 'breadcrumb', layout: 'custom', borderWidth: 0, columnSpan: 1, columnIndex: 0, visible: true },
                { id: 'title-group', type: 'zone', elementType: 'title-group', layout: 'custom', borderWidth: 0, columnSpan: 1, columnIndex: 1, visible: true },
                { id: 'header-actions', type: 'zone', elementType: 'action-buttons', layout: 'custom', borderWidth: 0, columnSpan: 1, columnIndex: 2, visible: true }
              ]
            }
          ]
        },
        body: {
          visible: true,
          containerWidth: 'full',
          rows: [
            {
              id: 'main-content-row',
              order: 0,
              columns: 1,
              columnWidths: [100],
              columnLayoutMode: 'auto',
              columnConfig: [
                { type: 'flexible', value: 100 }
              ],
              hybridSidebarWidth: 320,
              hybridRightSidebarWidth: 280,
              columnGap: 24,
              contentPadding: 12,
              sectionSpacing: 16,
              smartLayout: false,
              smartLayoutOffset: 200,
              mobileBreakpoint: 768,
              mobileStackReverse: false,
              elements: [] // Will be populated from detailPageLayouts
            }
          ]
        },
        footer: {
          visible: true,
          containerWidth: 'standard',
          rows: [
            {
              id: 'footer-row',
              order: 0,
              columns: 3,
              columnWidths: [40, 30, 30],
              columnGap: 24,
              elements: [
                { id: 'record-metadata', type: 'zone', elementType: 'metadata', layout: 'custom', borderWidth: 0, columnSpan: 1, columnIndex: 0, visible: true },
                { id: 'last-updated', type: 'zone', elementType: 'last-updated', layout: 'custom', borderWidth: 0, columnSpan: 1, columnIndex: 1, visible: true },
                { id: 'footer-stats', type: 'zone', elementType: 'stats-summary', layout: 'custom', borderWidth: 0, columnSpan: 1, columnIndex: 2, visible: true }
              ]
            },
            {
              id: 'footer-actions-row',
              order: 1,
              columns: 1,
              columnWidths: [100],
              columnGap: 16,
              sectionSpacing: 16,
              elements: [
                { id: 'footer-action-bar', type: 'zone', elementType: 'action-bar', layout: 'custom', borderWidth: 0, columnSpan: 1, columnIndex: 0, visible: true }
              ]
            }
          ]
        }
      },
      // Legacy settings (kept for backward compatibility during migration)
      containerWidth: 'full',
      customWidth: 1200,
      columns: 3,
      columnWidths: [33.33, 33.33, 33.34],
      columnLayoutMode: 'auto',
      columnConfig: [
        { type: 'flexible', value: 33.33 },
        { type: 'flexible', value: 33.33 },
        { type: 'flexible', value: 33.34 },
      ],
      hybridSidebarWidth: 320,
      hybridRightSidebarWidth: 280,
      columnGap: 24,
      contentPadding: 12,
      sectionSpacing: 8,
      mobileBreakpoint: 768,
      mobileStackReverse: false,
      smartLayout: false,
      smartLayoutOffset: 200,
    },
    // Per-record-type layout overrides (Tier 3)
    recordTypeLayouts: {
      // Example: Different layout for Order records
      // 'Order': { columnLayoutMode: 'proportional', columnWidths: [100] }
    },
  });

  // UNDO/REDO FUNCTIONS for Layout History
  const addToLayoutHistory = (recordId, layout, actionLabel = 'Change') => {
    if (!recordId || !layout) return;

    const snapshot = {
      id: Date.now(),
      recordId,
      layout: JSON.parse(JSON.stringify(layout)), // Deep clone
      timestamp: Date.now(),
      action: actionLabel,
      pageSettingsSnapshot: JSON.parse(JSON.stringify(pageSettings.detail.zones))
    };

    setLayoutHistory(prev => {
      // Remove any history after current index (for redo clearing)
      const newHistory = prev.slice(0, layoutHistoryIndex + 1);
      newHistory.push(snapshot);

      // Limit history size
      if (newHistory.length > MAX_HISTORY_SIZE) {
        newHistory.shift();
      }

      return newHistory;
    });

    setLayoutHistoryIndex(prev => {
      const newIndex = Math.min(prev + 1, MAX_HISTORY_SIZE - 1);
      return newIndex;
    });
  };

  const handleUndo = useCallback(() => {
    if (layoutHistoryIndex <= 0) {
      showToast('Nothing to undo', 'info');
      return;
    }

    const previousSnapshot = layoutHistory[layoutHistoryIndex - 1];
    if (!previousSnapshot) return;

    // Restore layout
    setDetailPageLayouts(prev => ({
      ...prev,
      [previousSnapshot.recordId]: previousSnapshot.layout
    }));

    // Restore page settings
    setPageSettings(prev => ({
      ...prev,
      detail: {
        ...prev.detail,
        zones: previousSnapshot.pageSettingsSnapshot
      }
    }));

    setLayoutHistoryIndex(layoutHistoryIndex - 1);
    showToast(`Undo: ${previousSnapshot.action}`, 'info');
  }, [layoutHistoryIndex, layoutHistory]);

  const handleRedo = useCallback(() => {
    if (layoutHistoryIndex >= layoutHistory.length - 1) {
      showToast('Nothing to redo', 'info');
      return;
    }

    const nextSnapshot = layoutHistory[layoutHistoryIndex + 1];
    if (!nextSnapshot) return;

    // Restore layout
    setDetailPageLayouts(prev => ({
      ...prev,
      [nextSnapshot.recordId]: nextSnapshot.layout
    }));

    // Restore page settings
    setPageSettings(prev => ({
      ...prev,
      detail: {
        ...prev.detail,
        zones: nextSnapshot.pageSettingsSnapshot
      }
    }));

    setLayoutHistoryIndex(layoutHistoryIndex + 1);
    showToast(`Redo: ${nextSnapshot.action}`, 'info');
  }, [layoutHistoryIndex, layoutHistory]);

  // Settings panel navigation state
  const [settingsCategory, setSettingsCategory] = useState(null); // null | 'element' | 'page' | 'workspace' | 'themes'

  // Theme settings state
  const [themeSettings, setThemeSettings] = useState({
    theme: 'minimalist', // 'minimalist' | 'clarity' | 'joyful' | 'custom'
    mode: 'light', // 'light' | 'dark'
    colors: {
      primary: '#171717', // neutral-900
      secondary: '#737373', // neutral-500
      accent: '#3b82f6', // blue-500
      background: '#ffffff',
      surface: '#f5f5f5', // neutral-100
      text: '#171717',
      textSecondary: '#737373',
    },
    buttons: {
      primary: {
        background: '#171717',
        text: '#ffffff',
        borderRadius: 8,
      },
      secondary: {
        background: '#f5f5f5',
        text: '#171717',
        borderRadius: 8,
      }
    },
    typography: {
      default: { fontSize: 14, lineHeight: 1.5, fontWeight: 400 },
      paragraph: { fontSize: 14, lineHeight: 1.6, fontWeight: 400 },
      header: { fontSize: 16, lineHeight: 1.3, fontWeight: 600 },
    },
    images: {
      borderWidth: 1,
      borderRadius: 8,
      shadow: 'sm',
    },
    pageBackground: '#ffffff',
    layout: {
      spacing: 'comfortable', // 'compact' | 'comfortable' | 'spacious'
    }
  });

  // AUTO-SAVE to localStorage every 5 seconds
  useEffect(() => {
    if (!selectedRecord) return;

    const saveInterval = setInterval(() => {
      const layoutToSave = detailPageLayouts[selectedRecord.id];
      if (layoutToSave) {
        try {
          localStorage.setItem(
            `draft-layout-${selectedRecord.id}`,
            JSON.stringify({
              layout: layoutToSave,
              timestamp: Date.now(),
              version: 1,
              zones: pageSettings.detail.zones
            })
          );
        } catch (error) {
          console.error('Auto-save failed:', error);
        }
      }
    }, 5000); // Auto-save every 5 seconds

    return () => clearInterval(saveInterval);
  }, [detailPageLayouts, selectedRecord, pageSettings.detail.zones]);

  // RESTORE DRAFT on load
  useEffect(() => {
    if (!selectedRecord) return;

    const draftKey = `draft-layout-${selectedRecord.id}`;
    const draft = localStorage.getItem(draftKey);

    if (draft) {
      try {
        const { layout, timestamp, zones } = JSON.parse(draft);
        const age = Date.now() - timestamp;

        // Validate and merge with defaults to ensure all required elements exist
        const defaultLayout = getDefaultDetailLayout(selectedRecord.id);
        const mergedLayout = [...layout];

        // Add any missing default elements
        defaultLayout.forEach(defaultElement => {
          const exists = layout.some(el => el.elementType === defaultElement.elementType);
          if (!exists) {
            console.log(`Adding missing element: ${defaultElement.elementType}`);
            mergedLayout.push(defaultElement);
          }
        });

        // Show restore option if draft is less than 24 hours old
        if (age < 24 * 60 * 60 * 1000) {
          setDraftToRestore({ layout: mergedLayout, zones });
          setShowRestoreDraftDialog(true);
        } else {
          // Clean up old drafts
          localStorage.removeItem(draftKey);
        }
      } catch (error) {
        console.error('Failed to restore draft:', error);
        // Clear corrupted draft
        localStorage.removeItem(draftKey);
      }
    }
  }, [selectedRecord]);

  // TRACK UNSAVED CHANGES
  useEffect(() => {
    if (!selectedRecord) {
      setHasUnsavedChanges(false);
      return;
    }

    const currentLayout = JSON.stringify(detailPageLayouts[selectedRecord.id]);
    const savedLayout = JSON.stringify(lastSavedLayouts[selectedRecord.id]);

    setHasUnsavedChanges(currentLayout !== savedLayout);
  }, [detailPageLayouts, lastSavedLayouts, selectedRecord]);

  // WARN before leaving with unsaved changes
  useEffect(() => {
    const handleBeforeUnload = (e) => {
      if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = ''; // Chrome requires returnValue to be set
        return 'You have unsaved changes. Are you sure you want to leave?';
      }
    };

    window.addEventListener('beforeunload', handleBeforeUnload);
    return () => window.removeEventListener('beforeunload', handleBeforeUnload);
  }, [hasUnsavedChanges]);

  // Theme presets with improved dark mode contrast
  const themePresets = {
    minimalist: {
      light: {
        colors: {
          primary: '#171717',
          secondary: '#737373',
          accent: '#3b82f6',
          background: '#ffffff',
          surface: '#f5f5f5',
          text: '#171717',
          textSecondary: '#737373',
        },
        buttons: {
          primary: { background: '#171717', text: '#ffffff', borderRadius: 8 },
          secondary: { background: '#f5f5f5', text: '#171717', borderRadius: 8 }
        },
        pageBackground: '#ffffff',
      },
      dark: {
        colors: {
          primary: '#f5f5f5',
          secondary: '#d4d4d4',
          accent: '#60a5fa',
          background: '#1c1c1c',
          surface: '#2a2a2a',
          text: '#f5f5f5',
          textSecondary: '#d4d4d4',
        },
        buttons: {
          primary: { background: '#f5f5f5', text: '#171717', borderRadius: 8 },
          secondary: { background: '#2a2a2a', text: '#f5f5f5', borderRadius: 8 }
        },
        pageBackground: '#121212',
      }
    },
    clarity: {
      light: {
        colors: {
          primary: '#2563eb',
          secondary: '#6366f1',
          accent: '#0ea5e9',
          background: '#ffffff',
          surface: '#eff6ff',
          text: '#1e293b',
          textSecondary: '#64748b',
        },
        buttons: {
          primary: { background: '#2563eb', text: '#ffffff', borderRadius: 8 },
          secondary: { background: '#eff6ff', text: '#2563eb', borderRadius: 8 }
        },
        pageBackground: '#f8fafc',
      },
      dark: {
        colors: {
          primary: '#60a5fa',
          secondary: '#93c5fd',
          accent: '#38bdf8',
          background: '#0f1629',
          surface: '#1e293b',
          text: '#f1f5f9',
          textSecondary: '#cbd5e1',
        },
        buttons: {
          primary: { background: '#3b82f6', text: '#ffffff', borderRadius: 8 },
          secondary: { background: '#1e293b', text: '#93c5fd', borderRadius: 8 }
        },
        pageBackground: '#020617',
      }
    },
    joyful: {
      light: {
        colors: {
          primary: '#ec4899',
          secondary: '#a855f7',
          accent: '#f59e0b',
          background: '#ffffff',
          surface: '#fdf4ff',
          text: '#831843',
          textSecondary: '#a21caf',
        },
        buttons: {
          primary: { background: '#ec4899', text: '#ffffff', borderRadius: 12 },
          secondary: { background: '#fdf4ff', text: '#ec4899', borderRadius: 12 }
        },
        pageBackground: '#fef3f8',
      },
      dark: {
        colors: {
          primary: '#f9a8d4',
          secondary: '#d8b4fe',
          accent: '#fbbf24',
          background: '#1f1022',
          surface: '#2d1b2d',
          text: '#fce7f3',
          textSecondary: '#f5d0fe',
        },
        buttons: {
          primary: { background: '#ec4899', text: '#ffffff', borderRadius: 12 },
          secondary: { background: '#2d1b2d', text: '#f9a8d4', borderRadius: 12 }
        },
        pageBackground: '#0f0511',
      }
    },
    corporate: {
      light: {
        colors: {
          primary: '#1e40af',
          secondary: '#475569',
          accent: '#0891b2',
          background: '#ffffff',
          surface: '#f1f5f9',
          text: '#0f172a',
          textSecondary: '#475569',
        },
        buttons: {
          primary: { background: '#1e40af', text: '#ffffff', borderRadius: 6 },
          secondary: { background: '#f1f5f9', text: '#1e40af', borderRadius: 6 }
        },
        pageBackground: '#f8fafc',
      },
      dark: {
        colors: {
          primary: '#3b82f6',
          secondary: '#94a3b8',
          accent: '#06b6d4',
          background: '#0f1829',
          surface: '#1e293b',
          text: '#f1f5f9',
          textSecondary: '#cbd5e1',
        },
        buttons: {
          primary: { background: '#3b82f6', text: '#ffffff', borderRadius: 6 },
          secondary: { background: '#1e293b', text: '#93c5fd', borderRadius: 6 }
        },
        pageBackground: '#020617',
      }
    },
    ocean: {
      light: {
        colors: {
          primary: '#0891b2',
          secondary: '#0ea5e9',
          accent: '#06b6d4',
          background: '#ffffff',
          surface: '#ecfeff',
          text: '#164e63',
          textSecondary: '#0e7490',
        },
        buttons: {
          primary: { background: '#0891b2', text: '#ffffff', borderRadius: 10 },
          secondary: { background: '#ecfeff', text: '#0891b2', borderRadius: 10 }
        },
        pageBackground: '#f0fdfa',
      },
      dark: {
        colors: {
          primary: '#22d3ee',
          secondary: '#67e8f9',
          accent: '#06b6d4',
          background: '#083344',
          surface: '#164e63',
          text: '#ecfeff',
          textSecondary: '#a5f3fc',
        },
        buttons: {
          primary: { background: '#0891b2', text: '#ffffff', borderRadius: 10 },
          secondary: { background: '#164e63', text: '#67e8f9', borderRadius: 10 }
        },
        pageBackground: '#022c3d',
      }
    },
    forest: {
      light: {
        colors: {
          primary: '#059669',
          secondary: '#10b981',
          accent: '#14b8a6',
          background: '#ffffff',
          surface: '#f0fdf4',
          text: '#064e3b',
          textSecondary: '#047857',
        },
        buttons: {
          primary: { background: '#059669', text: '#ffffff', borderRadius: 8 },
          secondary: { background: '#f0fdf4', text: '#059669', borderRadius: 8 }
        },
        pageBackground: '#f0fdf4',
      },
      dark: {
        colors: {
          primary: '#34d399',
          secondary: '#6ee7b7',
          accent: '#2dd4bf',
          background: '#022c22',
          surface: '#064e3b',
          text: '#d1fae5',
          textSecondary: '#a7f3d0',
        },
        buttons: {
          primary: { background: '#059669', text: '#ffffff', borderRadius: 8 },
          secondary: { background: '#064e3b', text: '#6ee7b7', borderRadius: 8 }
        },
        pageBackground: '#011714',
      }
    },
    sunset: {
      light: {
        colors: {
          primary: '#ea580c',
          secondary: '#f59e0b',
          accent: '#dc2626',
          background: '#ffffff',
          surface: '#fff7ed',
          text: '#7c2d12',
          textSecondary: '#c2410c',
        },
        buttons: {
          primary: { background: '#ea580c', text: '#ffffff', borderRadius: 12 },
          secondary: { background: '#fff7ed', text: '#ea580c', borderRadius: 12 }
        },
        pageBackground: '#fffbeb',
      },
      dark: {
        colors: {
          primary: '#fb923c',
          secondary: '#fbbf24',
          accent: '#f87171',
          background: '#1c1410',
          surface: '#431407',
          text: '#fed7aa',
          textSecondary: '#fdba74',
        },
        buttons: {
          primary: { background: '#ea580c', text: '#ffffff', borderRadius: 12 },
          secondary: { background: '#431407', text: '#fb923c', borderRadius: 12 }
        },
        pageBackground: '#0c0a09',
      }
    }
  };

  // Helper to apply theme preset
  const applyThemePreset = (themeName, mode) => {
    const preset = themePresets[themeName]?.[mode];
    if (preset) {
      setThemeSettings(prev => ({
        ...prev,
        theme: themeName,
        mode: mode,
        colors: preset.colors,
        buttons: preset.buttons,
        pageBackground: preset.pageBackground,
      }));
    }
  };

  // Export theme to JSON
  const exportTheme = () => {
    const themeData = {
      name: `${themeSettings.theme}-${themeSettings.mode}-${Date.now()}`,
      settings: themeSettings,
      exportedAt: new Date().toISOString(),
    };
    const dataStr = JSON.stringify(themeData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    const exportFileDefaultName = `theme-${themeSettings.theme}-${themeSettings.mode}.json`;

    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
  };

  // Import theme from JSON
  const importTheme = (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const themeData = JSON.parse(e.target.result);
          if (themeData.settings) {
            setThemeSettings(themeData.settings);
            setToastMessage('Theme imported successfully!');
            setTimeout(() => setToastMessage(null), 3000);
          }
        } catch (error) {
          setToastMessage('Error importing theme. Invalid file format.');
          setTimeout(() => setToastMessage(null), 3000);
        }
      };
      reader.readAsText(file);
    }
  };

  // Column overlay state for visual feedback
  const [showColumnOverlays, setShowColumnOverlays] = useState(false);
  const overlayTimeoutRef = useRef(null);

  // Helper to activate column overlays with auto-hide
  const activateColumnOverlays = () => {
    setShowColumnOverlays(true);
    if (overlayTimeoutRef.current) {
      clearTimeout(overlayTimeoutRef.current);
    }
    overlayTimeoutRef.current = setTimeout(() => {
      setShowColumnOverlays(false);
    }, 800);
  };

  // Helper: Get default layout for a record's detail page
  const getDefaultDetailLayout = (recordId) => {
    // Find the record to determine its type
    const record = mockRecords.find(r => r.id === recordId);
    const recordType = record?.recordType;

    // Return layout based on record type
    if (recordType === 'Application') {
      return [
        // Column 0: Profile
        { type: 'card', id: `${recordId}-applicant-profile`, elementType: 'applicant-profile', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-applicant-contact`, elementType: 'applicant-contact', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-application-details`, elementType: 'application-details', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        // Column 1: Application Form
        { type: 'card', id: `${recordId}-application-form`, elementType: 'application-form', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 1 },
        // Column 2: Actions & Activity
        { type: 'card', id: `${recordId}-application-actions`, elementType: 'application-actions', layout: 'custom', borderWidth: 1, columnSpan: 1, columnIndex: 2 },
        { type: 'card', id: `${recordId}-application-activity`, elementType: 'application-activity', layout: 'list', borderWidth: 1, columnSpan: 1, columnIndex: 2 },
      ];
    }

    if (recordType === 'Event') {
      // Modern event landing page: Full-width hero + 3-column content + testimonials
      return [
        { type: 'card', id: `${recordId}-event-hero`, elementType: 'event-hero', layout: 'custom', borderWidth: 0, columnSpan: 1, columnIndex: 0 },
        { type: 'container', id: `${recordId}-event-3col`, elementType: 'event-3-column-section', layout: 'custom', borderWidth: 0, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-event-testimonials`, elementType: 'event-testimonials', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
      ];
    }

    if (recordType === 'Article') {
      // Magazine-style: Narrow single column for readability
      return [
        { type: 'card', id: `${recordId}-article-header`, elementType: 'article-header', layout: 'custom', borderWidth: 0, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-article-content`, elementType: 'article-content', layout: 'custom', borderWidth: 0, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-article-author`, elementType: 'article-author', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-article-related`, elementType: 'article-related', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
      ];
    }

    if (recordType === 'Email Campaign') {
      // Email template: Narrow single column (~600px email width)
      return [
        { type: 'card', id: `${recordId}-email-header`, elementType: 'email-header', layout: 'custom', borderWidth: 0, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-email-preview`, elementType: 'email-preview', layout: 'custom', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-email-stats`, elementType: 'email-stats', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-email-actions`, elementType: 'email-actions', layout: 'custom', borderWidth: 0, columnSpan: 1, columnIndex: 0 },
      ];
    }

    if (recordType === 'Contact') {
      // HubSpot CRM-inspired: 3-column hybrid (profile | timeline | deals/tasks)
      return [
        // Column 0: Profile & Contact Info
        { type: 'card', id: `${recordId}-contact-profile`, elementType: 'contact-profile', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-contact-info`, elementType: 'contact', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-contact-company`, elementType: 'contact-company', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        // Column 1: Timeline & Activity
        { type: 'card', id: `${recordId}-contact-timeline`, elementType: 'contact-timeline', layout: 'list', borderWidth: 1, columnSpan: 1, columnIndex: 1 },
        { type: 'card', id: `${recordId}-contact-notes`, elementType: 'contact-notes', layout: 'list', borderWidth: 1, columnSpan: 1, columnIndex: 1 },
        // Column 2: Deals & Tasks
        { type: 'card', id: `${recordId}-contact-deals`, elementType: 'contact-deals', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 2 },
        { type: 'card', id: `${recordId}-contact-tasks`, elementType: 'contact-tasks', layout: 'list', borderWidth: 1, columnSpan: 1, columnIndex: 2 },
      ];
    }

    if (recordType === 'Course') {
      // Online learning platform: 2-column (70/30 - content | enrollment)
      return [
        // Column 0: Course Content (70%)
        { type: 'card', id: `${recordId}-course-hero`, elementType: 'course-hero', layout: 'custom', borderWidth: 0, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-course-description`, elementType: 'course-description', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-course-curriculum`, elementType: 'course-curriculum', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-course-instructor`, elementType: 'course-instructor', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        // Column 1: Enrollment Card (30%)
        { type: 'card', id: `${recordId}-course-enrollment`, elementType: 'course-enrollment', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 1 },
        { type: 'card', id: `${recordId}-course-stats`, elementType: 'course-stats', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 1 },
        { type: 'card', id: `${recordId}-course-testimonials`, elementType: 'course-testimonials', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 1 },
      ];
    }

    if (recordType === 'Product') {
      // E-commerce: 2-column (50/50 - gallery | details)
      return [
        // Column 0: Product Gallery
        { type: 'card', id: `${recordId}-product-gallery`, elementType: 'product-gallery', layout: 'custom', borderWidth: 0, columnSpan: 1, columnIndex: 0 },
        // Column 1: Product Details
        { type: 'card', id: `${recordId}-product-info`, elementType: 'product-info', layout: 'custom', borderWidth: 0, columnSpan: 1, columnIndex: 1 },
        { type: 'card', id: `${recordId}-product-purchase`, elementType: 'product-purchase', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 1 },
        // Full width sections
        { type: 'card', id: `${recordId}-product-description`, elementType: 'product-description', layout: 'card', borderWidth: 1, columnSpan: 2, columnIndex: 0 },
        { type: 'card', id: `${recordId}-product-reviews`, elementType: 'product-reviews', layout: 'card', borderWidth: 1, columnSpan: 2, columnIndex: 0 },
      ];
    }

    if (recordType === 'Order') {
      // Modern order tracking: 2-column (65/35 - items/timeline | summary)
      return [
        // Column 0: Order Details (65%)
        { type: 'card', id: `${recordId}-order-header`, elementType: 'order-header', layout: 'custom', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-order-timeline`, elementType: 'order-timeline', layout: 'custom', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-order-items`, elementType: 'order-items', layout: 'custom', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        // Column 1: Order Summary (35%)
        { type: 'card', id: `${recordId}-order-totals`, elementType: 'order-totals', layout: 'custom', borderWidth: 1, columnSpan: 1, columnIndex: 1 },
        { type: 'card', id: `${recordId}-order-customer`, elementType: 'order-customer', layout: 'custom', borderWidth: 1, columnSpan: 1, columnIndex: 1 },
        { type: 'card', id: `${recordId}-order-actions`, elementType: 'order-actions', layout: 'custom', borderWidth: 0, columnSpan: 1, columnIndex: 1 },
      ];
    }

    if (recordType === 'Dashboard') {
      // Analytics dashboard: 3-column grid with metrics
      return [
        { type: 'card', id: `${recordId}-dashboard-header`, elementType: 'dashboard-header', layout: 'custom', borderWidth: 0, columnSpan: 3, columnIndex: 0 },
        { type: 'card', id: `${recordId}-dashboard-kpis`, elementType: 'dashboard-kpis', layout: 'custom', borderWidth: 1, columnSpan: 3, columnIndex: 0 },
        { type: 'card', id: `${recordId}-dashboard-chart-1`, elementType: 'dashboard-chart', layout: 'card', borderWidth: 1, columnSpan: 2, columnIndex: 0 },
        { type: 'card', id: `${recordId}-dashboard-insights`, elementType: 'dashboard-insights', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 2 },
        { type: 'card', id: `${recordId}-dashboard-chart-2`, elementType: 'dashboard-chart', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-dashboard-chart-3`, elementType: 'dashboard-chart', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 1 },
        { type: 'card', id: `${recordId}-dashboard-chart-4`, elementType: 'dashboard-chart', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 2 },
      ];
    }

    if (recordType === 'Portfolio') {
      // Creative portfolio: Full-width images, narrow text sections
      return [
        { type: 'card', id: `${recordId}-portfolio-hero`, elementType: 'portfolio-hero', layout: 'custom', borderWidth: 0, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-portfolio-overview`, elementType: 'portfolio-overview', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-portfolio-challenge`, elementType: 'portfolio-challenge', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-portfolio-solution`, elementType: 'portfolio-solution', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-portfolio-results`, elementType: 'portfolio-results', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-portfolio-gallery`, elementType: 'portfolio-gallery', layout: 'custom', borderWidth: 0, columnSpan: 1, columnIndex: 0 },
      ];
    }

    if (recordType === 'Invoice') {
      // Professional invoice: Standard width, single column document
      return [
        { type: 'card', id: `${recordId}-invoice-header`, elementType: 'invoice-header', layout: 'custom', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-invoice-details`, elementType: 'invoice-details', layout: 'custom', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-invoice-items`, elementType: 'invoice-items', layout: 'custom', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-invoice-totals`, elementType: 'invoice-totals', layout: 'custom', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-invoice-notes`, elementType: 'invoice-notes', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-invoice-actions`, elementType: 'invoice-actions', layout: 'custom', borderWidth: 0, columnSpan: 1, columnIndex: 0 },
      ];
    }

    if (recordType === 'Job') {
      // Job posting: 2-column (70/30 - description | apply card)
      return [
        // Column 0: Job Description (70%)
        { type: 'card', id: `${recordId}-job-header`, elementType: 'job-header', layout: 'custom', borderWidth: 0, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-job-description`, elementType: 'job-description', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-job-requirements`, elementType: 'job-requirements', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        { type: 'card', id: `${recordId}-job-benefits`, elementType: 'job-benefits', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
        // Column 1: Apply Card (30%)
        { type: 'card', id: `${recordId}-job-apply`, elementType: 'job-apply', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 1 },
        { type: 'card', id: `${recordId}-job-details`, elementType: 'job-details', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 1 },
        { type: 'card', id: `${recordId}-job-team`, elementType: 'job-team', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 1 },
      ];
    }

    if (recordType === 'Landing Page') {
      // Marketing landing page: Full-width sections alternating
      return [
        { type: 'card', id: `${recordId}-landing-hero`, elementType: 'landing-hero', layout: 'custom', borderWidth: 0, columnSpan: 3, columnIndex: 0 },
        { type: 'card', id: `${recordId}-landing-sections`, elementType: 'landing-sections', layout: 'card', borderWidth: 0, columnSpan: 3, columnIndex: 0 },
        { type: 'card', id: `${recordId}-landing-stats`, elementType: 'landing-stats', layout: 'custom', borderWidth: 0, columnSpan: 3, columnIndex: 0 },
        { type: 'card', id: `${recordId}-landing-performance`, elementType: 'landing-performance', layout: 'card', borderWidth: 0, columnSpan: 3, columnIndex: 0 },
        { type: 'card', id: `${recordId}-landing-tests`, elementType: 'landing-tests', layout: 'card', borderWidth: 0, columnSpan: 3, columnIndex: 0 },
      ];
    }

    // Default layout for other record types
    return [
      { type: 'card', id: `${recordId}-header`, elementType: 'header', layout: 'custom', borderWidth: 0, columnSpan: 1, columnIndex: 0 },
      { type: 'card', id: `${recordId}-bio`, elementType: 'bio', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
      { type: 'card', id: `${recordId}-contact`, elementType: 'contact', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
      { type: 'card', id: `${recordId}-committees`, elementType: 'committees', layout: 'custom', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
      { type: 'card', id: `${recordId}-interests`, elementType: 'interests', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
      { type: 'card', id: `${recordId}-membership`, elementType: 'membership', layout: 'card', borderWidth: 1, columnSpan: 1, columnIndex: 0 },
      { type: 'card', id: `${recordId}-actions`, elementType: 'actions', layout: 'custom', borderWidth: 1, columnSpan: 1, columnIndex: 1 },
      { type: 'card', id: `${recordId}-recent-activity`, elementType: 'recent-activity', layout: 'list', borderWidth: 1, columnSpan: 1, columnIndex: 1 },
    ];
  };

  // Container layouts state
  const [kanbanLayouts, setKanbanLayouts] = useState({}); // { containerId: { columns: [{id, title, cardIds: []}] } }
  const [gridLayouts, setGridLayouts] = useState({}); // { containerId: { children: [childId], positions: {childId: {x, y, w, h}} } }
  const [gridSettings, setGridSettings] = useState({}); // { containerId: { cols, rowHeight, margin, compactType } }
  const [canvasLayouts, setCanvasLayouts] = useState({}); // { containerId: { mode: 'grid'|'freeform', children: [], gridPositions: {breakpoint: {childId: {...}}}, freeformPositions: {breakpoint: {childId: {...}}} } }
  const [containerChildren, setContainerChildren] = useState({
    // Default children for event 3-column section (ELEVATE 2025)
    '2-event-3col': [
      { id: '2-event-speakers', elementType: 'event-speakers', visible: true },
      { id: '2-event-schedule', elementType: 'event-schedule', visible: true },
      { id: '2-event-registration', elementType: 'event-registration', visible: true }
    ]
  }); // { containerId: [{id, elementType, ...elementData}] }
  const [canvasMode, setCanvasMode] = useState({}); // { containerId: 'grid' | 'freeform' }
  const [canvasBreakpoint, setCanvasBreakpoint] = useState({}); // { containerId: 'desktop' | 'tablet' | 'mobile' }

  // Helper: Get container width based on setting
  const getContainerWidth = (containerWidthSetting, customWidth) => {
    const widths = {
      'narrow': '900px',
      'standard': '1200px',
      'wide': '1400px',
      'full': 'none', // Remove maxWidth constraint to allow full expansion
      'custom': `${customWidth}px`
    };
    return widths[containerWidthSetting] || widths.standard;
  };

  // Helper: Get columns for detail page based on record type
  const getDetailPageColumns = (recordId) => {
    if (!recordId) return pageSettings.detail.columns;
    const record = mockRecords.find(r => r.id === recordId);
    const recordType = record?.recordType;

    // Define columns for each record type
    const columnsByType = {
      'Application': 3,
      'Event': 1, // Single column - 3-column layout is inside event-3-column-section container
      'Article': 1,
      'Email Campaign': 1,
      'Contact': 3,
      'Course': 2,
      'Product': 2,
      'Order': 2,
      'Dashboard': 3,
      'Portfolio': 1,
      'Invoice': 1,
      'Job': 2,
      'Landing Page': 3
    };

    return columnsByType[recordType] || pageSettings.detail.columns;
  };

  // Helper: Get column widths for detail page based on record type
  const getDetailPageColumnWidths = (recordId) => {
    if (!recordId) return pageSettings.detail.columnWidths;
    const record = mockRecords.find(r => r.id === recordId);
    const recordType = record?.recordType;

    // Define column widths for each record type
    const widthsByType = {
      'Application': [33.33, 33.33, 33.34],  // 3 equal columns
      'Event': [100],                         // Single column - 3-column layout is inside event-3-column-section container
      'Article': [100],                       // Single column
      'Email Campaign': [100],                // Single column (~600px via container width)
      'Contact': [25, 50, 25],               // 3 columns: sidebar | center | sidebar
      'Course': [70, 30],                    // 2 columns: content | enrollment
      'Product': [50, 50],                   // 2 equal columns: gallery | details
      'Order': [65, 35],                     // 2 columns: items | summary
      'Dashboard': [33.33, 33.33, 33.34],    // 3 equal columns for grid
      'Portfolio': [100],                     // Single column (narrow via container width)
      'Invoice': [100],                       // Single column
      'Job': [70, 30],                       // 2 columns: description | apply
      'Landing Page': [100]                   // Single column (full-width)
    };

    return widthsByType[recordType] || pageSettings.detail.columnWidths;
  };

  // Helper: Determine column layout mode for a record (Tier 1, 2, 3 system)
  const getDetailPageColumnLayoutMode = (recordId) => {
    if (!recordId) return pageSettings.detail.columnLayoutMode || 'proportional';

    const record = mockRecords.find(r => r.id === recordId);
    const recordType = record?.recordType;

    // Tier 3: Check for record-type-specific override
    if (pageSettings.recordTypeLayouts?.[recordType]?.columnLayoutMode) {
      return pageSettings.recordTypeLayouts[recordType].columnLayoutMode;
    }

    // Tier 1: Smart default - Applications auto-use hybrid layout
    if (recordType === 'Application' && pageSettings.detail.columnLayoutMode === 'auto') {
      return 'hybrid';
    }

    // Tier 2: Use page-level setting
    const mode = pageSettings.detail.columnLayoutMode || 'auto';

    // If mode is 'auto', apply smart defaults
    if (mode === 'auto') {
      if (recordType === 'Application') return 'hybrid';
      return 'proportional'; // Default for other record types
    }

    return mode;
  };

  // Helper: Get CSS grid template for detail page columns
  const getDetailPageGridTemplate = (recordId) => {
    if (!recordId) return pageSettings.detail.columnWidths.map(w => w + 'fr').join(' ');

    const record = mockRecords.find(r => r.id === recordId);
    const recordType = record?.recordType;
    const mode = getDetailPageColumnLayoutMode(recordId);
    const columnCount = getDetailPageColumns(recordId);

    // Tier 3: Record-type-specific template
    if (pageSettings.recordTypeLayouts?.[recordType]?.gridTemplate) {
      return pageSettings.recordTypeLayouts[recordType].gridTemplate;
    }

    // Hybrid mode: Fixed sidebars + flexible center
    if (mode === 'hybrid') {
      if (recordType === 'Application' && columnCount === 3) {
        const leftWidth = pageSettings.detail.hybridSidebarWidth || 320;
        const rightWidth = pageSettings.detail.hybridRightSidebarWidth || 280;
        return `${leftWidth}px 1fr ${rightWidth}px`;
      }
      // For 2 columns in hybrid mode
      if (columnCount === 2) {
        const sidebarWidth = pageSettings.detail.hybridSidebarWidth || 320;
        return `${sidebarWidth}px 1fr`;
      }
    }

    // Custom mode: Use columnConfig
    if (mode === 'custom' && pageSettings.detail.columnConfig) {
      return pageSettings.detail.columnConfig
        .slice(0, columnCount)
        .map(col => {
          if (col.type === 'fixed') return `${col.value}px`;
          if (col.type === 'flexible') return `${col.value}fr`;
          if (col.type === 'percentage') return `${col.value}%`;
          if (col.type === 'minmax') return `minmax(${col.min}px, ${col.max}fr)`;
          return '1fr';
        })
        .join(' ');
    }

    // Narrow centered column for content-focused record types
    if (columnCount === 1 && ['Article', 'Email Campaign'].includes(recordType)) {
      // Center a narrow column with auto margins on sides
      // For Article: max ~700px for optimal readability
      // For Email Campaign: max ~650px to simulate email width
      const maxWidth = recordType === 'Article' ? '700px' : '650px';
      return `minmax(auto, ${maxWidth})`;
    }

    // Proportional mode (default): Use fractional units
    return getDetailPageColumnWidths(recordId).map(w => w + 'fr').join(' ');
  };

  // Helper: Get container width for detail page
  const getDetailPageContainerWidth = (recordId) => {
    if (!recordId) return pageSettings.detail.containerWidth;

    const record = mockRecords.find(r => r.id === recordId);
    const recordType = record?.recordType;

    // Tier 3: Record-type-specific override
    if (pageSettings.recordTypeLayouts?.[recordType]?.containerWidth) {
      return pageSettings.recordTypeLayouts[recordType].containerWidth;
    }

    // Always use the configured container width
    // Container width is independent of column layout mode
    // Users can combine any container width (narrow/standard/wide/full) with any layout mode
    return pageSettings.detail.containerWidth;
  };

  // ============================================================================
  // 3-ZONE LAYOUT HELPERS
  // ============================================================================

  // Helper: Get rows for a specific zone
  const getZoneRows = (zoneName) => {
    return pageSettings.detail.zones[zoneName]?.rows || [];
  };

  // Helper: Get row settings with fallback to default body row settings
  const getRowSettings = (row) => {
    // For body zone rows, merge with main-content-row as default
    const bodyMainRow = pageSettings.detail.zones.body?.rows?.find(r => r.id === 'main-content-row');
    return {
      columns: row.columns || 1,
      columnWidths: row.columnWidths || [100],
      columnLayoutMode: row.columnLayoutMode || 'proportional',
      columnConfig: row.columnConfig || [],
      hybridSidebarWidth: row.hybridSidebarWidth || bodyMainRow?.hybridSidebarWidth || 320,
      hybridRightSidebarWidth: row.hybridRightSidebarWidth || bodyMainRow?.hybridRightSidebarWidth || 280,
      columnGap: row.columnGap !== undefined ? row.columnGap : 24,
      contentPadding: row.contentPadding !== undefined ? row.contentPadding : 12,
      sectionSpacing: row.sectionSpacing !== undefined ? row.sectionSpacing : 8,
      smartLayout: row.smartLayout !== undefined ? row.smartLayout : false,
      smartLayoutOffset: row.smartLayoutOffset || 200,
      mobileBreakpoint: row.mobileBreakpoint || 768,
      mobileStackReverse: row.mobileStackReverse || false,
    };
  };

  // Helper: Get grid template for a row
  const getRowGridTemplate = (row, recordId) => {
    // For body zone main-content-row, use dynamic grid template based on record type
    if (row.id === 'main-content-row' && recordId) {
      return getDetailPageGridTemplate(recordId);
    }

    // For all other rows, use static row configuration
    const settings = getRowSettings(row);
    const mode = settings.columnLayoutMode;
    const columnCount = settings.columns;

    // Hybrid mode: Fixed sidebars + flexible center
    if (mode === 'hybrid') {
      const record = mockRecords.find(r => r.id === recordId);
      const recordType = record?.recordType;

      if (recordType === 'Application' && columnCount === 3) {
        const leftWidth = settings.hybridSidebarWidth;
        const rightWidth = settings.hybridRightSidebarWidth;
        return `${leftWidth}px 1fr ${rightWidth}px`;
      }
      if (columnCount === 2) {
        const sidebarWidth = settings.hybridSidebarWidth;
        return `${sidebarWidth}px 1fr`;
      }
    }

    // Custom mode: Use columnConfig
    if (mode === 'custom' && settings.columnConfig && settings.columnConfig.length > 0) {
      return settings.columnConfig
        .slice(0, columnCount)
        .map(col => {
          if (col.type === 'fixed') return `${col.value}px`;
          if (col.type === 'flexible') return `${col.value}fr`;
          if (col.type === 'percentage') return `${col.value}%`;
          if (col.type === 'minmax') return `minmax(${col.min}px, ${col.max}fr)`;
          return '1fr';
        })
        .join(' ');
    }

    // Proportional mode (default): Use fractional units
    return settings.columnWidths.map(w => w + 'fr').join(' ');
  };

  // ============================================================================
  // 3-ZONE RENDERING ARCHITECTURE
  // ============================================================================
  //
  // The detail page uses a clean 2-layer architecture for rendering:
  //
  //   Layer 1: getPageElements() - Data preparation
  //     - Gathers all elements organized by zones (header, body, footer)
  //     - Returns normalized structure with consistent element shape
  //     - Single source of truth for page layout
  //
  //   Layer 2: renderZone() - Rendering
  //     - Renders complete zone with rows, columns, and elements
  //     - Handles drag-and-drop, design mode, and responsive layout
  //     - Self-contained rendering logic
  //
  // HELPER FUNCTIONS:
  //   - getAllDetailElements() - Get all body elements as flat array
  //   - getAllPageElements() - Get all elements from all zones as flat array
  //
  // BENEFITS:
  //   - Consistent data model across all zones
  //   - Easy to modify and extend
  //   - Clear separation of concerns
  //   - Simple debugging with flat call stack
  //
  // ============================================================================

  /**
   * LAYER 1: Data Preparation
   *
   * Gathers all page elements organized by zones and rows. This is the single
   * entry point for retrieving the complete page structure.
   *
   * @param {string} recordId - The record ID to get elements for
   * @returns {Object} Structure:
   *   {
   *     header: {
   *       zone: ZoneConfig,
   *       rows: [{ id, zoneName, elements: [Element] }]
   *     },
   *     body: {
   *       zone: ZoneConfig,
   *       rows: [{ id, zoneName, elements: [Element] }]
   *     },
   *     footer: {
   *       zone: ZoneConfig,
   *       rows: [{ id, zoneName, elements: [Element] }]
   *     }
   *   }
   */
  const getPageElements = (recordId) => {
    const result = {
      header: { rows: [], zone: pageSettings.detail.zones.header },
      body: { rows: [], zone: pageSettings.detail.zones.body },
      footer: { rows: [], zone: pageSettings.detail.zones.footer }
    };

    // Get header zone rows
    const headerZone = pageSettings.detail.zones.header;
    if (headerZone?.visible && headerZone.rows) {
      result.header.rows = headerZone.rows.map(row => ({
        ...row,
        zoneName: 'header',
        elements: row.elements || []
      }));
    }

    // Get body zone rows - from detailPageLayouts
    const bodyZone = pageSettings.detail.zones.body;
    if (bodyZone?.visible && bodyZone.rows) {
      const bodyElements = detailPageLayouts[recordId] || getDefaultDetailLayout(recordId);
      result.body.rows = bodyZone.rows.map(row => ({
        ...row,
        zoneName: 'body',
        elements: row.id === 'main-content-row' ? bodyElements : (row.elements || [])
      }));
    }

    // Get footer zone rows
    const footerZone = pageSettings.detail.zones.footer;
    if (footerZone?.visible && footerZone.rows) {
      result.footer.rows = footerZone.rows.map(row => ({
        ...row,
        zoneName: 'footer',
        elements: row.elements || []
      }));
    }

    return result;
  };

  /**
   * Helper: Get all body elements for a record (flat array)
   * This replaces the old getAllDetailElements() function
   * Ensures all default elements are present by merging with defaults
   */
  const getAllDetailElements = (recordId) => {
    const pageElements = getPageElements(recordId);
    const currentElements = pageElements.body.rows.flatMap(row => row.elements || []);

    // Validate: ensure all default elements are present
    const defaultLayout = getDefaultDetailLayout(recordId);
    const mergedElements = [...currentElements];

    // Add any missing default elements
    defaultLayout.forEach(defaultElement => {
      const exists = currentElements.some(el => el.elementType === defaultElement.elementType);
      if (!exists) {
        console.log(`[getAllDetailElements] Restoring missing element: ${defaultElement.elementType} for record ${recordId}`);
        mergedElements.push(defaultElement);
      }
    });

    return mergedElements;
  };

  /**
   * Helper: Get all elements from all zones (header, body, footer) as flat array
   * Useful for element lookup, collision detection, and outline generation
   */
  const getAllPageElements = (recordId) => {
    const pageElements = getPageElements(recordId);
    return [
      ...pageElements.header.rows.flatMap(row => row.elements || []),
      ...pageElements.body.rows.flatMap(row => row.elements || []),
      ...pageElements.footer.rows.flatMap(row => row.elements || [])
    ];
  };

  /**
   * Helper: Get zone data from custom page universalConfig
   * Extracts zone configuration and rows for rendering
   */
  const getCustomPageZoneData = (pageId, zoneName) => {
    const page = customPages.find(p => p.id === pageId);
    if (!page?.settings?.universalConfig) return null;

    const zone = page.settings.universalConfig.zones?.find(z => z.id === zoneName || z.type === zoneName);
    if (!zone) return null;

    return {
      zone: {
        visible: zone.visible !== false,
        containerWidth: zone.containerWidth || 'standard',
        padding: zone.padding || { x: 8, y: 8 }
      },
      rows: zone.rows || []
    };
  };

  /**
   * Helper: Update custom page zone data
   * Used when elements are added/removed/reordered via drag-and-drop
   */
  const updateCustomPageZone = (pageId, zoneName, updater) => {
    setCustomPages(prevPages => prevPages.map(page => {
      if (page.id !== pageId || !page.settings?.universalConfig) return page;

      const zones = page.settings.universalConfig.zones || [];
      const updatedZones = zones.map(zone => {
        if (zone.id === zoneName || zone.type === zoneName) {
          return updater(zone);
        }
        return zone;
      });

      return {
        ...page,
        settings: {
          ...page.settings,
          universalConfig: {
            ...page.settings.universalConfig,
            zones: updatedZones
          }
        }
      };
    }));
  };

  /**
   * LAYER 2: Rendering
   *
   * Renders a complete zone with all its rows and elements. This function
   * handles the entire rendering pipeline in one place:
   * - Zone wrapper with semantic HTML tags (header/section/footer)
   * - Row layout with grid system
   * - Column distribution
   * - Drag-and-drop support via dnd-kit
   * - Design mode visual indicators
   *
   * @param {string} zoneName - 'header', 'body', or 'footer'
   * @param {Object} zoneData - Zone data from getPageElements() containing:
   *   - zone: ZoneConfig (visible, containerWidth, rows)
   *   - rows: Array of row objects with elements
   * @param {string} recordId - The record ID being rendered
   * @returns {JSX.Element|null} Rendered zone or null if not visible
   */
  const renderZone = (zoneName, zoneData, recordId) => {
    if (!zoneData?.zone?.visible || !zoneData?.rows?.length) {
      return null;
    }

    const { zone, rows } = zoneData;
    const ZoneTag = zoneName === 'header' ? 'header' : zoneName === 'footer' ? 'footer' : 'section';
    const zoneStyles = {
      header: { paddingTop: '24px', paddingBottom: '16px' },
      body: { paddingTop: '0px', paddingBottom: '16px' },
      footer: { paddingTop: '16px', paddingBottom: '48px' }
    };

    return (
      <ZoneTag
        className={`zone-${zoneName} group/zone relative transition-all duration-200 ${
          isDesignMode() ? 'hover:bg-gradient-to-r hover:from-blue-50/30 hover:to-transparent' : ''
        }`}
        style={{
          ...zoneStyles[zoneName],
          ...(isDesignMode() ? {
            borderLeft: '3px solid transparent',
            borderColor: zoneName === 'header' ? '#3b82f6' : zoneName === 'footer' ? '#8b5cf6' : '#10b981'
          } : {})
        }}
      >
        {rows.map(row => {
          const settings = getRowSettings(row);
          const elements = row.elements || [];

          // For body zone main-content-row, use dynamic column count based on record type
          const columnCount = (zoneName === 'body' && row.id === 'main-content-row' && recordId)
            ? getDetailPageColumns(recordId)
            : settings.columns;

          return (
            <div
              key={row.id}
              className="zone-row group/row relative"
            >
              {isDesignMode() && (
                <div className="absolute left-0 top-0 opacity-0 group-hover/row:opacity-100 transition-opacity pointer-events-none z-40">
                  <div className="px-2 py-1 bg-neutral-700 text-white text-[10px] font-medium rounded shadow-lg">
                    Row: {columnCount} col{columnCount !== 1 ? 's' : ''} â€¢ {settings.columnGap}px gap
                  </div>
                </div>
              )}
              <div
                style={{
                  maxWidth: getContainerWidth(zone.containerWidth, pageSettings.detail.customWidth),
                  margin: '0 auto',
                  padding: '0 24px',
                }}
              >
                <div
                  className={`row-grid ${settings.mobileStackReverse ? 'mobile-reverse' : ''}`}
                  style={{
                    display: 'grid',
                    gridTemplateColumns: getRowGridTemplate(row, recordId),
                    gap: settings.columnGap + 'px',
                    // Center narrow single columns (Article, Email Campaign)
                    justifyContent: (zoneName === 'body' && row.id === 'main-content-row' && recordId &&
                      getDetailPageColumns(recordId) === 1 &&
                      ['Article', 'Email Campaign'].includes(mockRecords.find(r => r.id === recordId)?.recordType))
                      ? 'center' : undefined,
                  }}
                >
                  {Array.from({ length: columnCount }).map((_, colIndex) => {
                    const columnItems = elements.filter(item => (item.columnIndex ?? 0) === colIndex);
                    const isDragging = activeElementId !== null;

                    return (
                      <div
                        key={colIndex}
                        className={`relative ${isDragging ? 'bg-neutral-50/50 rounded-lg transition-colors duration-200' : ''}`}
                        style={{
                          display: 'flex',
                          flexDirection: 'column',
                          gap: (isDragging ? settings.sectionSpacing / 2 : settings.sectionSpacing) + 'px',
                          position: 'relative',
                          minWidth: 0,
                          padding: isDragging ? '8px' : '0',
                        }}
                      >
                        <SortableContext
                          items={columnItems.map(item => item.id)}
                          strategy={verticalListSortingStrategy}
                        >
                          <DroppableGap
                            context="detail"
                            recordId={recordId}
                            insertIndex={0}
                            columnIndex={colIndex}
                            zoneName={zoneName}
                            rowId={row.id}
                            columnItems={columnItems}
                          />
                          {columnItems.map((item, itemIndex) => {
                            if (item.visible === false) return null;
                            const elementData = droppedElements.find(e => e.id === item.id);
                            if (elementData?.visible === false) return null;

                            return (
                              <React.Fragment key={item.id}>
                                <SortableElement
                                  element={item}
                                  index={itemIndex}
                                  context="detail"
                                  recordId={recordId}
                                  columnIndex={colIndex}
                                  zoneName={zoneName}
                                  rowId={row.id}
                                />
                                <DroppableGap
                                  context="detail"
                                  recordId={recordId}
                                  insertIndex={itemIndex + 1}
                                  columnIndex={colIndex}
                                  zoneName={zoneName}
                                  rowId={row.id}
                                  columnItems={columnItems}
                                />
                              </React.Fragment>
                            );
                          })}
                        </SortableContext>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          );
        })}
      </ZoneTag>
    );
  };

  /**
   * Render zone for custom pages
   * Similar to renderZone but adapted for custom pages (uses pageId instead of recordId)
   */
  const renderCustomPageZone = (zoneName, zoneData, pageId) => {
    if (!zoneData?.zone?.visible || !zoneData?.rows?.length) {
      return null;
    }

    const { zone, rows } = zoneData;
    const ZoneTag = zoneName === 'header' ? 'header' : zoneName === 'footer' ? 'footer' : 'section';
    const zoneStyles = {
      header: { paddingTop: '24px', paddingBottom: '16px' },
      body: { paddingTop: '0px', paddingBottom: '16px' },
      footer: { paddingTop: '16px', paddingBottom: '48px' }
    };

    return (
      <ZoneTag
        className={`zone-${zoneName} group/zone relative transition-all duration-200 ${
          isDesignMode() ? 'hover:bg-gradient-to-r hover:from-blue-50/30 hover:to-transparent' : ''
        }`}
        style={{
          ...zoneStyles[zoneName],
          ...(isDesignMode() ? {
            borderLeft: '3px solid transparent',
            borderColor: zoneName === 'header' ? '#3b82f6' : zoneName === 'footer' ? '#8b5cf6' : '#10b981'
          } : {})
        }}
      >
        {rows.map((row, rowIndex) => {
          const columns = row.columns || [];
          const columnCount = columns.length || 1;

          return (
            <div
              key={row.id || `row-${rowIndex}`}
              className="zone-row group/row relative"
            >
              {isDesignMode() && (
                <div className="absolute left-0 top-0 opacity-0 group-hover/row:opacity-100 transition-opacity pointer-events-none z-40">
                  <div className="px-2 py-1 bg-neutral-700 text-white text-[10px] font-medium rounded shadow-lg">
                    Row: {columnCount} col{columnCount !== 1 ? 's' : ''}
                  </div>
                </div>
              )}
              <div
                style={{
                  maxWidth: zone.containerWidth === 'full' ? '100%' : zone.containerWidth === 'standard' ? '900px' : '1200px',
                  margin: '0 auto',
                  padding: '0 24px',
                }}
              >
                <div
                  className="row-grid"
                  style={{
                    display: 'grid',
                    gridTemplateColumns: `repeat(${columnCount}, 1fr)`,
                    gap: '24px',
                  }}
                >
                  {columns.map((column, colIndex) => {
                    const columnElements = column.elements || [];
                    const isDragging = activeElementId !== null;

                    return (
                      <div
                        key={column.id || `col-${colIndex}`}
                        className={`relative ${isDragging ? 'bg-neutral-50/50 rounded-lg transition-colors duration-200' : ''}`}
                        style={{
                          display: 'flex',
                          flexDirection: 'column',
                          gap: '16px',
                          position: 'relative',
                          minWidth: 0,
                          padding: isDragging ? '8px' : '0',
                        }}
                      >
                        <SortableContext
                          items={columnElements.map(el => el.id)}
                          strategy={verticalListSortingStrategy}
                        >
                          <DroppableGap
                            context="custom-page"
                            pageId={pageId}
                            insertIndex={0}
                            columnIndex={colIndex}
                            zoneName={zoneName}
                            rowId={row.id}
                            columnItems={columnElements}
                          />
                          {columnElements.map((element, elemIndex) => {
                            return (
                              <React.Fragment key={element.id}>
                                <SortableElement
                                  element={element}
                                  index={elemIndex}
                                  context="custom-page"
                                  pageId={pageId}
                                  columnIndex={colIndex}
                                  zoneName={zoneName}
                                  rowId={row.id}
                                />
                                <DroppableGap
                                  context="custom-page"
                                  pageId={pageId}
                                  insertIndex={elemIndex + 1}
                                  columnIndex={colIndex}
                                  zoneName={zoneName}
                                  rowId={row.id}
                                  columnItems={columnElements}
                                />
                              </React.Fragment>
                            );
                          })}
                        </SortableContext>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          );
        })}
      </ZoneTag>
    );
  };

  // Helper: Unified card content renderer (replaces renderSectionContent)
  // Now handles both block cards (formerly "sections") and regular cards
  const renderElementContent = (element, record) => {
    // For block cards, use elementType as the recordType
    // For zone elements (header/footer), use type directly
    const elementDef = componentElements.find(e => e.id === element.elementType);
    const recordType = elementDef?.recordType || element.elementType || element.type;
    const layout = element.layout || 'custom';

    // Route to appropriate renderer based on recordType
    switch (recordType) {
      // ========================================================================
      // ZONE HEADER ELEMENTS
      // ========================================================================
      case 'breadcrumb':
        return (
          <div className="mb-8">
            <button
              onClick={() => { setView('list'); setSelectedRecord(null); }}
              className="flex items-center text-sm transition-colors group"
              style={{ color: themeSettings.colors.textSecondary }}
              onMouseEnter={(e) => e.currentTarget.style.color = themeSettings.colors.text}
              onMouseLeave={(e) => e.currentTarget.style.color = themeSettings.colors.textSecondary}
            >
              <svg className="w-4 h-4 mr-1 group-hover:-translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M15 19l-7-7 7-7" />
              </svg>
              All Records
              <kbd className="ml-2 px-2 py-0.5 rounded text-xs border" style={{
                backgroundColor: themeSettings.colors.surface,
                borderColor: themeSettings.mode === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
                color: themeSettings.colors.textSecondary
              }}>Esc</kbd>
            </button>
          </div>
        );

      case 'title-group':
        return (
          <div className="flex items-center justify-center">
            <h1 className="text-3xl font-semibold tracking-tight text-center" style={{ color: themeSettings.colors.text }}>
              {record?.title}
            </h1>
          </div>
        );

      // ========================================================================
      // FOOTER ZONE ELEMENTS
      // ========================================================================
      case 'metadata':
        return (
          <div className="mt-12 pt-8 border-t border-neutral-200">
            <h4 className="text-xs font-semibold text-neutral-500 uppercase tracking-wider mb-4">Record Information</h4>
            <div className="grid grid-cols-2 gap-4 text-xs">
              <div>
                <dt className="text-neutral-500 mb-1">Record ID</dt>
                <dd className="text-neutral-900 font-mono">{record?.id}</dd>
              </div>
              <div>
                <dt className="text-neutral-500 mb-1">Record Type</dt>
                <dd className="text-neutral-900">{record?.recordType}</dd>
              </div>
              <div>
                <dt className="text-neutral-500 mb-1">Created</dt>
                <dd className="text-neutral-900">{record?.submissionDate || record?.date}</dd>
              </div>
              <div>
                <dt className="text-neutral-500 mb-1">Status</dt>
                <dd className="text-neutral-900">{record?.status}</dd>
              </div>
            </div>
          </div>
        );

      case 'last-updated':
        return (
          <div className="mt-12 pt-8 border-t border-neutral-200">
            <h4 className="text-xs font-semibold text-neutral-500 uppercase tracking-wider mb-4">Last Updated</h4>
            <div className="text-xs text-neutral-600">
              <p className="mb-2">
                <span className="font-medium">Modified:</span> {new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
              </p>
              <p>
                <span className="font-medium">By:</span> System Administrator
              </p>
            </div>
          </div>
        );

      case 'stats-summary':
        return (
          <div className="mt-12 pt-8 border-t border-neutral-200">
            <h4 className="text-xs font-semibold text-neutral-500 uppercase tracking-wider mb-4">Activity Stats</h4>
            <div className="space-y-3 text-xs">
              <div className="flex justify-between items-center">
                <span className="text-neutral-600">Views</span>
                <span className="font-semibold text-neutral-900">247</span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-neutral-600">Edits</span>
                <span className="font-semibold text-neutral-900">12</span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-neutral-600">Comments</span>
                <span className="font-semibold text-neutral-900">5</span>
              </div>
            </div>
          </div>
        );

      case 'action-bar':
        return (
          <div className="mt-8 pt-6 border-t border-neutral-200">
            <div className="flex items-center justify-between gap-4">
              <div className="flex gap-2">
                <button className="px-4 py-2 text-sm font-medium text-neutral-700 bg-white border border-neutral-300 rounded-lg hover:bg-neutral-50 transition-colors">
                  <span className="flex items-center gap-2">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                    Edit
                  </span>
                </button>
                <button className="px-4 py-2 text-sm font-medium text-neutral-700 bg-white border border-neutral-300 rounded-lg hover:bg-neutral-50 transition-colors">
                  <span className="flex items-center gap-2">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                    </svg>
                    Share
                  </span>
                </button>
              </div>
              <button className="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">
                Save Changes
              </button>
            </div>
          </div>
        );

      // ========================================================================
      // HEADER ZONE ELEMENTS
      // ========================================================================
      case 'action-buttons':
        return (
          <div className="flex items-center justify-end gap-2">
            <button className="px-3 py-1.5 text-xs font-medium text-neutral-700 bg-white border border-neutral-300 rounded-md hover:bg-neutral-50 transition-colors">
              Export
            </button>
            <button className="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors">
              Edit
            </button>
          </div>
        );

      // ========================================================================
      // BODY ZONE ELEMENTS (existing)
      // ========================================================================
      case 'header':
        return (
          <div className="border-b border-neutral-200 pb-6">
            <div className="flex items-start justify-between mb-4">
              <div>
                {record?.position && <p className="text-base text-neutral-600">{record?.position}</p>}
                {record?.company && <p className="text-sm text-neutral-500 mt-1">{record?.company}</p>}
              </div>
              <Button variant="ghost" size="sm" className="text-neutral-600">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                </svg>
              </Button>
            </div>
            <div className="flex items-center gap-4 text-sm">
              <div className="flex items-center">
                <span className="text-lg mr-2">{getStatusIndicator(record?.status)}</span>
                <span className="text-neutral-600">{record?.status}</span>
              </div>
              {record?.membershipType && record.membershipType !== 'N/A' && (
                <>
                  <div className="h-4 w-px bg-neutral-200"></div>
                  <div className="flex items-center">
                    <span className="text-neutral-600">{record?.membershipType}</span>
                  </div>
                </>
              )}
              {record?.duesStatus && record.duesStatus !== 'N/A' && (
                <>
                  <div className="h-4 w-px bg-neutral-200"></div>
                  <div className="flex items-center">
                    <span className="text-neutral-600">Dues: {record?.duesStatus}</span>
                  </div>
                </>
              )}
            </div>
          </div>
        );
      case 'bio':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-4">Bio</h3>
            <p className="text-neutral-700 leading-relaxed">{record?.bio}</p>
          </>
        );
      case 'contact':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-6">Contact Information</h3>
            <div className="grid grid-cols-2 gap-x-8 gap-y-6">
              <div>
                <dt className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2">Email</dt>
                <dd className="text-sm text-neutral-900">{record?.email}</dd>
              </div>
              <div>
                <dt className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2">Phone</dt>
                <dd className="text-sm text-neutral-900 font-mono">{record?.phone}</dd>
              </div>
            </div>
          </>
        );
      case 'committees':
        const data = record?.committees || [];

        switch (layout) {
          case 'link':
            return (
              <a href="#" className="text-blue-600 hover:text-blue-700 font-medium flex items-center gap-2">
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                Committee Participation
              </a>
            );

          case 'list':
            return (
              <>
                <h3 className="text-lg font-semibold text-neutral-900 mb-4 flex items-center gap-2">
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                  Committee Participation
                </h3>
                <div className="space-y-2">
                  {data.map((committee, idx) => (
                    <div key={idx} className="flex items-center justify-between py-2 border-b border-neutral-100 last:border-0">
                      <div className="flex-1">
                        <div className="text-sm font-medium text-neutral-900">{committee.name}</div>
                        <div className="text-xs text-neutral-500">{committee.position}</div>
                      </div>
                      <span className="text-xs text-neutral-500">{committee.startDate}</span>
                    </div>
                  ))}
                </div>
              </>
            );

          case 'card':
            return (
              <>
                <h3 className="text-lg font-semibold text-neutral-900 mb-4 flex items-center gap-2">
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                  Committee Participation
                </h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  {data.map((committee, idx) => (
                    <div key={idx} className="bg-neutral-50 border border-neutral-200 rounded-lg p-4">
                      <div className="text-sm font-semibold text-neutral-900 mb-1">{committee.name}</div>
                      <div className="text-xs text-neutral-600 mb-2">{committee.position}</div>
                      <div className="flex items-center gap-2 text-xs text-neutral-500">
                        <span>{committee.startDate}</span>
                        {committee.endDate && <span>â€” {committee.endDate}</span>}
                      </div>
                    </div>
                  ))}
                </div>
              </>
            );

          case 'grid':
            return (
              <>
                <div className="px-6 py-4 border-b border-neutral-200">
                  <h3 className="text-lg font-semibold text-neutral-900 flex items-center gap-2">
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    Committee Participation
                  </h3>
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-neutral-50 border-b border-neutral-200">
                      <tr>
                        <th className="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Committee</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Position</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Start Date</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">End Date</th>
                      </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-neutral-200">
                      {data.map((committee, idx) => (
                        <tr key={idx} className="hover:bg-neutral-50">
                          <td className="px-6 py-4 text-sm text-neutral-900">{committee.name}</td>
                          <td className="px-6 py-4 text-sm text-neutral-600">{committee.position}</td>
                          <td className="px-6 py-4 text-sm text-neutral-600 font-mono tabular-nums">{committee.startDate}</td>
                          <td className="px-6 py-4 text-sm text-neutral-600 font-mono tabular-nums">{committee.endDate || 'â€”'}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </>
            );

          case 'visualizations':
            return (
              <div className="text-center py-8">
                <div className="text-7xl font-bold text-neutral-900 mb-2">{data.length}</div>
                <div className="text-lg font-medium text-neutral-600">Committee Participation</div>
                <div className="text-sm text-neutral-500 mt-1">Committee Memberships</div>
              </div>
            );

          case 'custom':
          default:
            return (
              <>
                <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-6">Committee Participation</h3>
                <div className="space-y-6">
                  {data.map((committee, idx) => (
                    <div key={idx} className="bg-neutral-50 rounded-lg p-6">
                      <div className="grid grid-cols-2 gap-x-8 gap-y-4">
                        {/* Committee Name */}
                        <div className="col-span-2">
                          <dt className="text-xs font-medium text-neutral-400 uppercase tracking-wider mb-2">Committee</dt>
                          <dd
                            className={`text-base font-medium text-neutral-900 hover:bg-neutral-100 cursor-pointer px-2 py-1 -mx-2 rounded transition-colors ${
                              isEditPanelOpen && editingCommittee?.committeeIndex === idx && editingCommittee?.field === 'name'
                                ? 'ring-2 ring-neutral-900 bg-neutral-100'
                                : ''
                            }`}
                            onClick={() => {
                              setEditingCommittee({ committeeIndex: idx, field: 'name' });
                              setIsEditPanelOpen(true);
                              setRightPanelTab('elements');
                            }}
                          >
                            {committee.name}
                          </dd>
                        </div>

                        {/* Position */}
                        <div>
                          <dt className="text-xs font-medium text-neutral-400 uppercase tracking-wider mb-2">Position</dt>
                          <dd
                            className={`text-sm text-neutral-900 hover:bg-neutral-100 cursor-pointer px-2 py-1 -mx-2 rounded transition-colors ${
                              isEditPanelOpen && editingCommittee?.committeeIndex === idx && editingCommittee?.field === 'position'
                                ? 'ring-2 ring-neutral-900 bg-neutral-100'
                                : ''
                            }`}
                            onClick={() => {
                              setEditingCommittee({ committeeIndex: idx, field: 'position' });
                              setIsEditPanelOpen(true);
                              setRightPanelTab('elements');
                            }}
                          >
                            {committee.position}
                          </dd>
                        </div>

                        {/* Start Date */}
                        <div>
                          <dt className="text-xs font-medium text-neutral-400 uppercase tracking-wider mb-2">Start Date</dt>
                          <dd
                            className={`text-sm text-neutral-900 font-mono tabular-nums hover:bg-neutral-100 cursor-pointer px-2 py-1 -mx-2 rounded transition-colors ${
                              isEditPanelOpen && editingCommittee?.committeeIndex === idx && editingCommittee?.field === 'startDate'
                                ? 'ring-2 ring-neutral-900 bg-neutral-100'
                                : ''
                            }`}
                            onClick={() => {
                              setEditingCommittee({ committeeIndex: idx, field: 'startDate' });
                              setIsEditPanelOpen(true);
                              setRightPanelTab('elements');
                            }}
                          >
                            {committee.startDate}
                          </dd>
                        </div>

                        {/* End Date */}
                        <div>
                          <dt className="text-xs font-medium text-neutral-400 uppercase tracking-wider mb-2">End Date</dt>
                          <dd
                            className={`text-sm text-neutral-900 font-mono tabular-nums hover:bg-neutral-100 cursor-pointer px-2 py-1 -mx-2 rounded transition-colors ${
                              isEditPanelOpen && editingCommittee?.committeeIndex === idx && editingCommittee?.field === 'endDate'
                                ? 'ring-2 ring-neutral-900 bg-neutral-100'
                                : ''
                            }`}
                            onClick={() => {
                              setEditingCommittee({ committeeIndex: idx, field: 'endDate' });
                              setIsEditPanelOpen(true);
                              setRightPanelTab('elements');
                            }}
                          >
                            {committee.endDate || 'â€”'}
                          </dd>
                        </div>

                        {/* Memo */}
                        {committee.memo && (
                          <div className="col-span-2">
                            <dt className="text-xs font-medium text-neutral-400 uppercase tracking-wider mb-2">Memo</dt>
                            <dd
                              className={`text-sm text-neutral-700 leading-relaxed hover:bg-neutral-100 cursor-pointer px-2 py-1 -mx-2 rounded transition-colors ${
                                isEditPanelOpen && editingCommittee?.committeeIndex === idx && editingCommittee?.field === 'memo'
                                  ? 'ring-2 ring-neutral-900 bg-neutral-100'
                                  : ''
                              }`}
                              onClick={() => {
                                setEditingCommittee({ committeeIndex: idx, field: 'memo' });
                                setIsEditPanelOpen(true);
                                setRightPanelTab('elements');
                              }}
                            >
                              {committee.memo}
                            </dd>
                          </div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </>
            );
        }
      case 'interests':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-4">Interests & Expertise</h3>
            <div className="flex flex-wrap gap-2">
              {record?.interests?.map((interest, idx) => (
                <span key={idx} className="px-3 py-1 bg-neutral-100 text-neutral-700 rounded-full text-sm">
                  {interest}
                </span>
              ))}
            </div>
          </>
        );
      case 'membership':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-6">Membership</h3>
            <div className="grid grid-cols-2 gap-x-8 gap-y-6">
              <div>
                <dt className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2">Join Date</dt>
                <dd className="text-sm text-neutral-900">{record?.joinDate}</dd>
              </div>
              <div>
                <dt className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2">Member Type</dt>
                <dd className="text-sm text-neutral-900">{record?.membershipType}</dd>
              </div>
            </div>
          </>
        );

      // Application Block Types
      case 'applicant-profile':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-4">Applicant Profile</h3>
            <div className="flex items-center gap-4 mb-6 pb-6 border-b border-neutral-200">
              <div className="w-16 h-16 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-2xl font-semibold flex-shrink-0">
                {record?.title?.split(' ').map(n => n[0]).join('') || '?'}
              </div>
              <div className="flex-1">
                <h4 className="text-lg font-semibold text-neutral-900">{record?.title}</h4>
                <p className="text-sm text-neutral-600">{record?.position}</p>
                <p className="text-sm text-neutral-500">{record?.company}</p>
              </div>
            </div>
            <div className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${
              record?.status === 'Approved'
                ? 'bg-green-100 text-green-800'
                : record?.status === 'Under Discussion'
                ? 'bg-yellow-100 text-yellow-800'
                : 'bg-blue-100 text-blue-800'
            }`}>
              {record?.status}
            </div>
            {record?.bio && (
              <div className="mt-6">
                <h5 className="text-xs font-semibold text-neutral-500 uppercase tracking-wider mb-3">Bio</h5>
                <p className="text-sm text-neutral-700 leading-relaxed">{record.bio}</p>
              </div>
            )}
          </>
        );

      case 'applicant-contact':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-6">Contact Information</h3>
            <div className="space-y-4">
              <div className="flex items-center gap-3">
                <svg className="w-4 h-4 text-neutral-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                <div className="flex-1 text-sm text-neutral-900">{record?.email}</div>
              </div>
              <div className="flex items-center gap-3">
                <svg className="w-4 h-4 text-neutral-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                </svg>
                <div className="flex-1 text-sm text-neutral-900 font-mono">{record?.phone}</div>
              </div>
            </div>
          </>
        );

      case 'application-details':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-6">Application Details</h3>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <dt className="text-xs text-neutral-500 mb-1">Application ID</dt>
                <dd className="text-sm font-mono text-neutral-900">{record?.applicationId}</dd>
              </div>
              <div>
                <dt className="text-xs text-neutral-500 mb-1">Member ID</dt>
                <dd className="text-sm font-mono text-neutral-900">{record?.memberId}</dd>
              </div>
              <div>
                <dt className="text-xs text-neutral-500 mb-1">Member Type</dt>
                <dd className="text-sm text-neutral-900">{record?.membershipType}</dd>
              </div>
              <div>
                <dt className="text-xs text-neutral-500 mb-1">Year</dt>
                <dd className="text-sm text-neutral-900">{record?.year}</dd>
              </div>
              <div>
                <dt className="text-xs text-neutral-500 mb-1">Submission Date</dt>
                <dd className="text-sm text-neutral-900">{record?.submissionDate}</dd>
              </div>
              <div>
                <dt className="text-xs text-neutral-500 mb-1">Approval Date</dt>
                <dd className="text-sm text-neutral-900">{record?.approvalDate || 'â€”'}</dd>
              </div>
            </div>
          </>
        );

      case 'application-form':
        const formFieldsData = [
          // Section 1: Personal Information
          { id: 'fullName', label: 'Full Name', value: record?.title, section: 'Personal Information' },
          { id: 'preferredName', label: 'Preferred Name', value: record?.title?.split(' ')[0] || '', section: 'Personal Information' },
          { id: 'dateOfBirth', label: 'Date of Birth', value: '1985-06-15', section: 'Personal Information' },
          { id: 'nationality', label: 'Nationality', value: 'United States', section: 'Personal Information' },
          { id: 'email', label: 'Email Address', value: record?.email, section: 'Personal Information' },
          { id: 'phone', label: 'Phone Number', value: record?.phone, section: 'Personal Information' },
          { id: 'mailingAddress', label: 'Mailing Address', value: '123 Innovation Way, San Francisco, CA 94105', section: 'Personal Information' },
          { id: 'linkedinProfile', label: 'LinkedIn Profile', value: 'linkedin.com/in/' + record?.title?.toLowerCase().replace(' ', '-'), section: 'Personal Information' },
          { id: 'website', label: 'Personal Website', value: 'www.' + record?.title?.toLowerCase().replace(' ', '') + '.com', section: 'Personal Information' },

          // Section 2: Professional Background
          { id: 'currentPosition', label: 'Current Position', value: record?.position, section: 'Professional Background' },
          { id: 'organization', label: 'Organization', value: record?.company, section: 'Professional Background' },
          { id: 'yearsExperience', label: 'Years of Professional Experience', value: '15+ years', section: 'Professional Background' },
          { id: 'industry', label: 'Primary Industry', value: 'Technology / Design', section: 'Professional Background' },
          { id: 'specialization', label: 'Area of Specialization', value: 'Digital Product Design, UX Strategy, Design Systems', section: 'Professional Background' },
          { id: 'professionalBackground', label: 'Professional Summary', value: record?.bio, section: 'Professional Background' },
          { id: 'previousPositions', label: 'Previous Positions (last 5 years)', value: 'Senior Product Designer at TechCorp (2020-Present), Lead Designer at StartupX (2018-2020), UX Designer at AgencyY (2016-2018)', section: 'Professional Background' },

          // Section 3: Education & Certifications
          { id: 'highestDegree', label: 'Highest Degree Earned', value: 'Master of Fine Arts (MFA)', section: 'Education & Certifications' },
          { id: 'fieldOfStudy', label: 'Field of Study', value: 'Interaction Design', section: 'Education & Certifications' },
          { id: 'institution', label: 'Institution', value: 'Rhode Island School of Design', section: 'Education & Certifications' },
          { id: 'graduationYear', label: 'Graduation Year', value: '2010', section: 'Education & Certifications' },
          { id: 'certifications', label: 'Professional Certifications', value: 'Certified UX Professional (CUXP), Design Thinking Certification (IDEO), Accessibility Specialist (IAAP CPACC)', section: 'Education & Certifications' },

          // Section 4: Membership Application
          { id: 'membershipType', label: 'Membership Type Requested', value: record?.membershipType, section: 'Membership Application' },
          { id: 'reasonForJoining', label: 'Reason for Joining', value: 'Passionate about advancing the field through collaboration with other professionals and contributing to the community\'s knowledge base. I believe in the power of collective expertise to drive innovation and establish best practices in design.', section: 'Membership Application' },
          { id: 'contributionAreas', label: 'How can you contribute?', value: 'I would like to contribute through mentorship programs, speaking at events, participating in standards committees, and sharing case studies from my professional work. I have experience leading design teams and can offer insights on scaling design practices.', section: 'Membership Application' },
          { id: 'committeeInterest', label: 'Committee Interests', value: 'Design Excellence Committee, Mentorship Program, Education & Outreach', section: 'Membership Application' },
          { id: 'volunteerAvailability', label: 'Volunteer Time Availability', value: '4-6 hours per month', section: 'Membership Application' },

          // Section 5: Professional Accomplishments
          { id: 'publications', label: 'Publications & Speaking Engagements', value: 'Published 3 articles in UX Magazine, Keynote speaker at Design Summit 2023, Workshop facilitator at UX Conference 2024', section: 'Professional Accomplishments' },
          { id: 'awards', label: 'Awards & Recognition', value: 'Best UX Design Award 2023, Innovation in Design Award 2022, Featured in Design Leaders Spotlight', section: 'Professional Accomplishments' },
          { id: 'portfolioHighlights', label: 'Portfolio Highlights', value: 'Led redesign of enterprise SaaS platform serving 50k+ users, Developed design system adopted across 8 product teams, Mentored 15+ junior designers', section: 'Professional Accomplishments' },

          // Section 6: References
          { id: 'reference1Name', label: 'Reference 1: Name', value: 'Dr. Sarah Johnson', section: 'Professional References' },
          { id: 'reference1Title', label: 'Reference 1: Title', value: 'VP of Design, TechCorp Industries', section: 'Professional References' },
          { id: 'reference1Relationship', label: 'Reference 1: Relationship', value: 'Direct Manager', section: 'Professional References' },
          { id: 'reference1Email', label: 'Reference 1: Email', value: 'sarah.johnson@techcorp.com', section: 'Professional References' },
          { id: 'reference2Name', label: 'Reference 2: Name', value: 'Michael Chen', section: 'Professional References' },
          { id: 'reference2Title', label: 'Reference 2: Title', value: 'Director of Product, StartupX', section: 'Professional References' },
          { id: 'reference2Relationship', label: 'Reference 2: Relationship', value: 'Colleague / Collaborator', section: 'Professional References' },
          { id: 'reference2Email', label: 'Reference 2: Email', value: 'michael.chen@startupx.io', section: 'Professional References' },

          // Section 7: Additional Information
          { id: 'diversityStatement', label: 'Diversity & Inclusion Statement (Optional)', value: 'I am committed to fostering inclusive design practices and have led initiatives to make design more accessible to underrepresented communities.', section: 'Additional Information' },
          { id: 'additionalComments', label: 'Additional Comments', value: 'I am excited about the opportunity to join this professional community and contribute to its mission of advancing design excellence.', section: 'Additional Information' },
          { id: 'agreeTerms', label: 'Agreement to Terms', value: 'Yes, I agree to the code of conduct and membership terms', section: 'Additional Information' },
          { id: 'signatureDate', label: 'Application Date', value: record?.submissionDate, section: 'Additional Information' }
        ];

        return (
          <div className="relative">
            {/* Header with Zoom Controls and Artifact Gallery Button */}
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider">Application Form</h3>
              <div className="flex items-center gap-2">
                {/* Zoom Controls */}
                <div className="flex items-center gap-1 bg-neutral-100 rounded-lg px-2 py-1">
                  <button
                    onClick={() => setCanvasZoom(Math.max(50, canvasZoom - 10))}
                    className="p-1 text-neutral-600 hover:text-neutral-900 transition-colors"
                    title="Zoom Out"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7" />
                    </svg>
                  </button>
                  <span className="text-xs font-medium text-neutral-600 min-w-[3rem] text-center">{canvasZoom}%</span>
                  <button
                    onClick={() => setCanvasZoom(Math.min(200, canvasZoom + 10))}
                    className="p-1 text-neutral-600 hover:text-neutral-900 transition-colors"
                    title="Zoom In"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" />
                    </svg>
                  </button>
                  <button
                    onClick={() => setCanvasZoom(100)}
                    className="ml-1 px-2 py-0.5 text-xs text-neutral-600 hover:text-neutral-900 transition-colors"
                    title="Reset Zoom"
                  >
                    Reset
                  </button>
                </div>
                {/* Artifact Gallery Button */}
                {record?.artifacts && record.artifacts.length > 0 && (
                  <button
                    onClick={() => setIsArtifactGalleryOpen(true)}
                    className="flex items-center gap-1.5 px-3 py-1.5 bg-blue-50 text-blue-700 rounded-lg text-xs font-medium hover:bg-blue-100 transition-colors"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                    </svg>
                    {record.artifacts.length} Artifact{record.artifacts.length > 1 ? 's' : ''}
                  </button>
                )}
              </div>
            </div>

            {/* Canvas Container with Zoom and Pan */}
            <div
              className="bg-neutral-50 rounded-lg border border-neutral-200 overflow-hidden"
              style={{
                cursor: isPanning ? 'grabbing' : isSpacebarPressed ? 'grab' : 'default',
                position: 'relative',
                height: '600px'
              }}
              onMouseDown={(e) => {
                if (e.button === 0 && isSpacebarPressed) { // Spacebar + Left Click to pan
                  setIsPanning(true);
                  const startX = e.clientX;
                  const startY = e.clientY;
                  const startPanX = canvasPan.x;
                  const startPanY = canvasPan.y;

                  const handleMouseMove = (moveEvent) => {
                    const deltaX = (moveEvent.clientX - startX) / (canvasZoom / 100);
                    const deltaY = (moveEvent.clientY - startY) / (canvasZoom / 100);
                    setCanvasPan({ x: startPanX + deltaX, y: startPanY + deltaY });
                  };

                  const handleMouseUp = () => {
                    setIsPanning(false);
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                  };

                  document.addEventListener('mousemove', handleMouseMove);
                  document.addEventListener('mouseup', handleMouseUp);
                  e.preventDefault();
                }
              }}
            >
              <div
                style={{
                  transform: `scale(${canvasZoom / 100}) translate(${canvasPan.x}px, ${canvasPan.y}px)`,
                  transformOrigin: 'top left',
                  transition: isPanning ? 'none' : 'transform 0.2s ease',
                  padding: '24px',
                  minHeight: '100%'
                }}
              >
                <div className="bg-white rounded-lg p-8 shadow-sm max-w-4xl mx-auto">
                  {/* Group fields by section */}
                  {(() => {
                    const sections = [...new Set(formFieldsData.map(f => f.section))];
                    return sections.map((sectionName, sectionIndex) => {
                      const sectionFields = formFieldsData.filter(f => f.section === sectionName);
                      const sectionDiscussionCount = sectionFields.reduce((sum, field) =>
                        sum + (discussionMarkers[field.id]?.length || 0), 0
                      );

                      return (
                        <div key={sectionName} className={sectionIndex > 0 ? 'mt-10' : ''}>
                          {/* Section Header */}
                          <div className="flex items-center justify-between mb-6 pb-3 border-b-2 border-neutral-200">
                            <h4 className="text-base font-semibold text-neutral-900">{sectionName}</h4>
                            {sectionDiscussionCount > 0 && (
                              <span className="inline-flex items-center gap-1.5 px-2.5 py-1 bg-amber-50 text-amber-700 text-xs font-medium rounded-full">
                                <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                </svg>
                                {sectionDiscussionCount} discussion{sectionDiscussionCount !== 1 ? 's' : ''}
                              </span>
                            )}
                          </div>

                          {/* Section Fields */}
                          <div className="space-y-5">
                            {sectionFields.map((field, index) => {
                              const fieldDiscussionCount = discussionMarkers[field.id]?.length || 0;

                              return (
                                <div key={field.id} className="relative group">
                                  <div className="flex items-start gap-2">
                                    <div className="flex-1">
                                      <label className="block text-xs font-semibold text-neutral-500 uppercase tracking-wider mb-2">
                                        {field.label}
                                      </label>
                                      <div className="text-sm text-neutral-900 leading-relaxed whitespace-pre-wrap">
                                        {field.value}
                                      </div>
                                    </div>

                                    {/* Discussion Indicator & Add Button */}
                                    <div className="flex-shrink-0 flex items-center gap-1 pt-0.5">
                                      {fieldDiscussionCount > 0 && (
                                        <button
                                          onClick={() => {
                                            const marker = discussionMarkers[field.id]?.[0];
                                            if (marker) {
                                              setActiveDiscussion({ fieldId: field.id, markerId: marker.id });
                                            }
                                          }}
                                          className="flex items-center gap-1 px-2 py-1 bg-amber-50 text-amber-700 rounded-md text-xs font-medium hover:bg-amber-100 transition-colors"
                                          title="View discussions"
                                        >
                                          <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                          </svg>
                                          {fieldDiscussionCount}
                                        </button>
                                      )}

                                      {/* Subtle Plus Icon - Always visible on hover */}
                                      <button
                                        onClick={() => {
                                          const newMarker = {
                                            id: `marker-${field.id}-${Date.now()}`,
                                            fieldId: field.id,
                                            priority: 'question',
                                            text: '',
                                            author: 'Current User',
                                            timestamp: new Date().toISOString()
                                          };
                                          setDiscussionMarkers(prev => ({
                                            ...prev,
                                            [field.id]: [...(prev[field.id] || []), newMarker]
                                          }));
                                          setActiveDiscussion({ fieldId: field.id, markerId: newMarker.id });
                                        }}
                                        className="w-6 h-6 flex items-center justify-center rounded-md text-neutral-400 hover:text-blue-600 hover:bg-blue-50 transition-all opacity-0 group-hover:opacity-100"
                                        title="Add discussion"
                                      >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={2}>
                                          <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
                                        </svg>
                                      </button>
                                    </div>
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      );
                    });
                  })()}
                </div>

                {/* Pan Instructions */}
                <div className="mt-4 text-center">
                  {isSpacebarPressed ? (
                    <div className="inline-flex items-center gap-2 px-4 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium animate-pulse">
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11m0-5.5a1.5 1.5 0 013 0v3m0 0V11" />
                      </svg>
                      Pan mode active - Click and drag to move around
                    </div>
                  ) : (
                    <div className="text-xs text-neutral-500">
                      <kbd className="px-2 py-1 bg-neutral-100 border border-neutral-300 rounded text-neutral-700 font-mono text-xs">Spacebar</kbd>
                      {' '}<span className="text-neutral-400">+</span>{' '}
                      <span className="text-neutral-600">Drag to pan</span>
                      {' '}<span className="text-neutral-400">â€¢</span>{' '}
                      <kbd className="px-1.5 py-0.5 bg-neutral-100 border border-neutral-300 rounded text-neutral-700 font-mono text-xs">+</kbd>
                      <kbd className="px-1.5 py-0.5 bg-neutral-100 border border-neutral-300 rounded text-neutral-700 font-mono text-xs">-</kbd>
                      {' '}<span className="text-neutral-600">to zoom</span>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        );

      case 'application-actions':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-4">Actions</h3>
            <div className="space-y-2">
              {record?.status !== 'Approved' && (
                <button
                  className="w-full px-4 py-2.5 text-sm font-medium transition-colors flex items-center justify-center gap-2"
                  style={{
                    backgroundColor: themeSettings.buttons.primary.background,
                    color: themeSettings.buttons.primary.text,
                    borderRadius: `${themeSettings.buttons.primary.borderRadius}px`,
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.opacity = '0.9';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.opacity = '1';
                  }}
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M5 13l4 4L19 7" />
                  </svg>
                  Approve Application
                </button>
              )}
              <button
                className="w-full px-4 py-2.5 text-sm font-medium transition-colors flex items-center justify-center gap-2"
                style={{
                  backgroundColor: themeSettings.colors.accent,
                  color: '#ffffff',
                  borderRadius: `${themeSettings.buttons.primary.borderRadius}px`,
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.opacity = '0.9';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.opacity = '1';
                }}
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
                Add Discussion
              </button>
              <button
                className="w-full px-4 py-2.5 text-sm font-medium transition-colors flex items-center justify-center gap-2 border"
                style={{
                  backgroundColor: themeSettings.buttons.secondary.background,
                  color: themeSettings.buttons.secondary.text,
                  borderRadius: `${themeSettings.buttons.secondary.borderRadius}px`,
                  borderColor: themeSettings.mode === 'dark' ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.1)',
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.backgroundColor = themeSettings.mode === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.02)';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.backgroundColor = themeSettings.buttons.secondary.background;
                }}
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                Send Email
              </button>
              {record?.status !== 'Approved' && (
                <button
                  className="w-full px-4 py-2.5 text-sm font-medium transition-colors flex items-center justify-center gap-2 border border-red-300"
                  style={{
                    backgroundColor: 'transparent',
                    color: '#dc2626',
                    borderRadius: `${themeSettings.buttons.secondary.borderRadius}px`,
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.backgroundColor = 'rgba(220, 38, 38, 0.05)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.backgroundColor = 'transparent';
                  }}
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                  Reject Application
                </button>
              )}
            </div>
          </>
        );

      case 'application-activity':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-4">Latest Activity</h3>
            <div className="space-y-4">
              {record?.approvalDate && (
                <div className="flex gap-3">
                  <div className="w-2 h-2 mt-1.5 rounded-full bg-green-500 flex-shrink-0"></div>
                  <div className="flex-1">
                    <div className="text-sm text-neutral-900 font-medium">Application Approved</div>
                    <div className="text-xs text-neutral-500 mt-0.5">{record.approvalDate}</div>
                  </div>
                </div>
              )}
              {record?.discussionsCount > 0 && (
                <div className="flex gap-3">
                  <div className="w-2 h-2 mt-1.5 rounded-full bg-blue-500 flex-shrink-0"></div>
                  <div className="flex-1">
                    <div className="text-sm text-neutral-900 font-medium">{record.discussionsCount} Discussion{record.discussionsCount > 1 ? 's' : ''} Added</div>
                    <div className="text-xs text-neutral-500 mt-0.5">Review team has questions</div>
                  </div>
                </div>
              )}
              <div className="flex gap-3">
                <div className="w-2 h-2 mt-1.5 rounded-full bg-neutral-400 flex-shrink-0"></div>
                <div className="flex-1">
                  <div className="text-sm text-neutral-900 font-medium">Application Submitted</div>
                  <div className="text-xs text-neutral-500 mt-0.5">{record?.submissionDate}</div>
                </div>
              </div>
              <div className="flex gap-3">
                <div className="w-2 h-2 mt-1.5 rounded-full bg-neutral-300 flex-shrink-0"></div>
                <div className="flex-1">
                  <div className="text-sm text-neutral-900 font-medium">Application Started</div>
                  <div className="text-xs text-neutral-500 mt-0.5">Initial form access</div>
                </div>
              </div>
            </div>
          </>
        );

      case 'order-header':
        return (
          <div className="flex items-start justify-between">
            <div>
              <div className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2">Order Number</div>
              <div className="text-2xl font-semibold text-neutral-900">{record?.orderNumber}</div>
            </div>
            <div className="text-right">
              <div className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2">Status</div>
              <div className="inline-flex items-center gap-2 px-3 py-1.5 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                <div className="w-2 h-2 bg-green-600 rounded-full"></div>
                {record?.paymentStatus}
              </div>
            </div>
            <div className="grid grid-cols-3 gap-6 mt-6 w-full">
              <div>
                <div className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2">Order Date</div>
                <div className="text-sm text-neutral-900">{new Date(record?.orderDate).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</div>
              </div>
              <div>
                <div className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2">Payment Method</div>
                <div className="text-sm text-neutral-900">{record?.paymentMethod}</div>
              </div>
              <div>
                <div className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2">Transaction ID</div>
                <div className="text-sm text-neutral-600 font-mono">{record?.transactionId}</div>
              </div>
            </div>
          </div>
        );
      case 'order-customer':
        return (
          <>
            <h3 className="text-sm font-semibold text-neutral-900 mb-4">Customer Information</h3>
            <div className="grid grid-cols-2 gap-6">
              <div>
                <div className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2">Customer</div>
                <div className="text-sm font-medium text-neutral-900">{record?.customerName}</div>
                <div className="text-sm text-neutral-600 mt-1">{record?.customerEmail}</div>
                <div className="text-sm text-neutral-600">{record?.customerPhone}</div>
              </div>
              <div>
                <div className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2">Billing Address</div>
                <div className="text-sm text-neutral-900">
                  {record?.billingAddress?.street}<br />
                  {record?.billingAddress?.city}, {record?.billingAddress?.state} {record?.billingAddress?.zip}<br />
                  {record?.billingAddress?.country}
                </div>
              </div>
            </div>
          </>
        );
      case 'order-items':
        return (
          <>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-sm font-semibold text-neutral-900">Order Items</h3>
              <button className="text-xs text-neutral-600 hover:text-neutral-900 transition-colors">
                + Add Item
              </button>
            </div>
            <div className="space-y-6">
              {record?.lineItems?.map((item, idx) => {
                const isEditingThis = editingLineItem?.recordId === record?.id && editingLineItem?.itemIndex === idx;

                return (
                  <div key={item.id} className="pb-6 border-b border-neutral-100 last:border-0">
                    {/* Item Name & Description */}
                    <div className="mb-4">
                      <div className="text-sm font-medium text-neutral-900 mb-1">{item.name}</div>
                      <div className="text-xs text-neutral-600 leading-relaxed">{item.description}</div>
                    </div>

                    {/* Editable Fields Grid */}
                    <div className="grid grid-cols-4 gap-4">
                      {/* Quantity */}
                      <div>
                        <dt className="text-xs font-medium text-neutral-400 uppercase tracking-wider mb-2">Quantity</dt>
                        <dd
                          className={`text-sm text-neutral-900 font-medium hover:bg-neutral-100 cursor-pointer px-2 py-1 -mx-2 rounded transition-colors ${
                            isEditingThis && editingLineItem?.field === 'quantity'
                              ? 'ring-2 ring-neutral-900 bg-neutral-100'
                              : ''
                          }`}
                          onClick={() => {
                            setEditingLineItem({ recordId: record.id, itemIndex: idx, field: 'quantity' });
                            setIsEditPanelOpen(true);
                            setRightPanelTab('elements');
                          }}
                        >
                          {item.quantity}
                        </dd>
                      </div>

                      {/* Unit Price */}
                      <div>
                        <dt className="text-xs font-medium text-neutral-400 uppercase tracking-wider mb-2">Unit Price</dt>
                        <dd
                          className={`text-sm text-neutral-900 font-mono tabular-nums hover:bg-neutral-100 cursor-pointer px-2 py-1 -mx-2 rounded transition-colors ${
                            isEditingThis && editingLineItem?.field === 'unitPrice'
                              ? 'ring-2 ring-neutral-900 bg-neutral-100'
                              : ''
                          }`}
                          onClick={() => {
                            setEditingLineItem({ recordId: record.id, itemIndex: idx, field: 'unitPrice' });
                            setIsEditPanelOpen(true);
                            setRightPanelTab('elements');
                          }}
                        >
                          ${item.unitPrice.toFixed(2)}
                        </dd>
                      </div>

                      {/* Discount */}
                      <div>
                        <dt className="text-xs font-medium text-neutral-400 uppercase tracking-wider mb-2">Discount</dt>
                        <dd
                          className={`text-sm ${item.discount > 0 ? 'text-red-600' : 'text-neutral-900'} font-mono tabular-nums hover:bg-neutral-100 cursor-pointer px-2 py-1 -mx-2 rounded transition-colors ${
                            isEditingThis && editingLineItem?.field === 'discount'
                              ? 'ring-2 ring-neutral-900 bg-neutral-100'
                              : ''
                          }`}
                          onClick={() => {
                            setEditingLineItem({ recordId: record.id, itemIndex: idx, field: 'discount' });
                            setIsEditPanelOpen(true);
                            setRightPanelTab('elements');
                          }}
                        >
                          {item.discount > 0 ? `-$${item.discount.toFixed(2)}` : '$0.00'}
                        </dd>
                      </div>

                      {/* Line Total */}
                      <div>
                        <dt className="text-xs font-medium text-neutral-400 uppercase tracking-wider mb-2">Line Total</dt>
                        <dd className="text-sm text-neutral-900 font-semibold font-mono tabular-nums px-2 py-1 -mx-2">
                          ${item.total.toFixed(2)}
                        </dd>
                      </div>
                    </div>

                    {/* Actions Row */}
                    <div className="mt-4 flex items-center gap-2">
                      <button
                        onClick={() => {
                          setReturningLineItem({ recordId: record.id, itemIndex: idx });
                        }}
                        className="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs text-orange-700 hover:text-orange-900 hover:bg-orange-50 border border-orange-200 rounded-lg transition-colors"
                      >
                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                        </svg>
                        Process Return
                      </button>
                    </div>

                    {/* Return/Refund Modal/Panel */}
                    {returningLineItem?.recordId === record?.id && returningLineItem?.itemIndex === idx && (
                      <div className="mt-4 p-4 bg-orange-50 border border-orange-200 rounded-lg animate-fadeInScale">
                        <div className="flex items-center justify-between mb-3">
                          <div className="text-xs font-medium text-orange-900 uppercase tracking-wider">Process Return</div>
                          <button
                            onClick={() => setReturningLineItem(null)}
                            className="text-orange-600 hover:text-orange-900"
                          >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M6 18L18 6M6 6l12 12" />
                            </svg>
                          </button>
                        </div>
                        <div className="space-y-3">
                          <div>
                            <label className="block text-xs text-orange-900 mb-1">Return Quantity</label>
                            <input
                              type="number"
                              max={item.quantity}
                              defaultValue={item.quantity}
                              className="w-full px-3 py-2 text-sm border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                            />
                          </div>
                          <div>
                            <label className="block text-xs text-orange-900 mb-1">Reason for Return</label>
                            <select className="w-full px-3 py-2 text-sm border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                              <option>Customer changed mind</option>
                              <option>Item defective</option>
                              <option>Wrong item shipped</option>
                              <option>Other</option>
                            </select>
                          </div>
                          <div>
                            <label className="block text-xs text-orange-900 mb-1">Notes (optional)</label>
                            <textarea
                              rows="2"
                              className="w-full px-3 py-2 text-sm border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                              placeholder="Add any additional details..."
                            />
                          </div>
                          <div className="flex items-center gap-2 p-3 bg-orange-100 rounded-lg">
                            <svg className="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div className="text-xs text-orange-900">
                              Refund amount: <span className="font-semibold">${item.total.toFixed(2)}</span>
                            </div>
                          </div>
                        </div>
                        <div className="flex justify-end gap-2 mt-3">
                          <button
                            onClick={() => setReturningLineItem(null)}
                            className="px-3 py-1.5 text-xs text-neutral-700 hover:bg-white rounded-lg transition-colors"
                          >
                            Cancel
                          </button>
                          <button
                            onClick={() => {
                              // Handle return logic here
                              setReturningLineItem(null);
                            }}
                            className="px-3 py-1.5 text-xs bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-colors"
                          >
                            Process Return
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </>
        );
      case 'order-totals':
        return (
          <div className="space-y-3">
            <div className="flex items-center justify-between text-sm">
              <span className="text-neutral-600">Subtotal</span>
              <span className="text-neutral-900 font-medium">${record?.subtotal?.toFixed(2)}</span>
            </div>
            {record?.discountTotal > 0 && (
              <div className="flex items-center justify-between text-sm">
                <span className="text-neutral-600">Discount</span>
                <span className="text-red-600 font-medium">-${record?.discountTotal?.toFixed(2)}</span>
              </div>
            )}
            {record?.taxTotal > 0 && (
              <div className="flex items-center justify-between text-sm">
                <span className="text-neutral-600">Tax</span>
                <span className="text-neutral-900 font-medium">${record?.taxTotal?.toFixed(2)}</span>
              </div>
            )}
            {record?.shippingTotal > 0 && (
              <div className="flex items-center justify-between text-sm">
                <span className="text-neutral-600">Shipping</span>
                <span className="text-neutral-900 font-medium">${record?.shippingTotal?.toFixed(2)}</span>
              </div>
            )}
            <div className="pt-3 border-t-2 border-neutral-300 flex items-center justify-between">
              <span className="text-base font-semibold text-neutral-900">Total</span>
              <span className="text-2xl font-bold text-neutral-900">${record?.total?.toFixed(2)}</span>
            </div>
          </div>
        );
      case 'order-notes':
        if (!record?.notes) return null;
        return (
          <div className="flex items-start gap-3">
            <svg className="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <div>
              <div className="text-xs font-medium text-amber-900 uppercase tracking-wider mb-1">Order Notes</div>
              <div className="text-sm text-amber-900 leading-relaxed">{record?.notes}</div>
            </div>
          </div>
        );
      case 'order-actions':
        return (
          <div className="flex items-center gap-3">
            <button className="flex-1 px-4 py-3 bg-neutral-900 hover:bg-neutral-800 text-white text-sm font-medium rounded-lg transition-colors flex items-center justify-center gap-2">
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
              </svg>
              Download Invoice
            </button>
            <button className="flex-1 px-4 py-3 bg-white hover:bg-neutral-50 border border-neutral-300 text-neutral-900 text-sm font-medium rounded-lg transition-colors flex items-center justify-center gap-2">
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
              Email Receipt
            </button>
            <button className="px-4 py-3 bg-white hover:bg-neutral-50 border border-neutral-300 text-neutral-900 text-sm font-medium rounded-lg transition-colors flex items-center justify-center gap-2">
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
              </svg>
              Print
            </button>
          </div>
        );
      case 'activity':
        return null; // Activity shown in sidebar
      case 'actions':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-4">Actions</h3>
            <div className="space-y-2">
              <button className="w-full text-left px-4 py-2.5 text-sm font-medium text-neutral-900 bg-neutral-50 hover:bg-neutral-100 rounded-lg transition-colors">
                Edit Profile
              </button>
              <button className="w-full text-left px-4 py-2.5 text-sm text-neutral-700 hover:bg-neutral-50 rounded-lg transition-colors">
                Send Message
              </button>
              <button className="w-full text-left px-4 py-2.5 text-sm text-neutral-700 hover:bg-neutral-50 rounded-lg transition-colors">
                Manage Committees
              </button>
              <button className="w-full text-left px-4 py-2.5 text-sm text-neutral-700 hover:bg-neutral-50 rounded-lg transition-colors">
                View Invoices
              </button>
              <button className="w-full text-left px-4 py-2.5 text-sm text-neutral-700 hover:bg-neutral-50 rounded-lg transition-colors">
                Export Profile
              </button>
              <div className="pt-2 mt-2 border-t border-neutral-200">
                <button className="w-full text-left px-4 py-2.5 text-sm text-neutral-700 hover:bg-neutral-50 rounded-lg transition-colors">
                  Suspend Membership
                </button>
                <button className="w-full text-left px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                  Remove Member
                </button>
              </div>
            </div>
          </>
        );
      case 'recent-activity':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-4">Recent Activity</h3>
            <div className="space-y-4">
              {[
                { action: 'Attended Annual Conference 2024', time: '2 weeks ago' },
                { action: 'Volunteered at Committee Meeting', time: '3 weeks ago' },
                { action: 'Renewed membership', time: '1 month ago' },
                { action: 'Joined Technology Advisory Board', time: '2 months ago' },
                { action: 'Updated profile information', time: '3 months ago' },
              ].map((item, idx) => (
                <div key={idx} className="relative pl-6">
                  <div className="absolute left-0 top-1.5 w-2 h-2 rounded-full bg-neutral-300"></div>
                  {idx !== 4 && <div className="absolute left-[3px] top-4 w-px h-full bg-neutral-200"></div>}
                  <div className="text-sm text-neutral-900">{item.action}</div>
                  <div className="text-xs text-neutral-500 mt-0.5">{item.time}</div>
                </div>
              ))}
            </div>
          </>
        );
      case 'events':
      case 'event-attendance':
        // Get events data based on context
        const eventsData = element.context === 'list' ? allEvents : memberEvents;
        const eventsTitle = recordType === 'event-attendance' ? 'Event Attendance' : 'Events';

        switch (layout) {
          case 'link':
            return (
              <a href="#" className="text-blue-600 hover:text-blue-700 font-medium flex items-center gap-2">
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                {eventsTitle}
              </a>
            );

          case 'list':
            return (
              <>
                <h3 className="text-lg font-semibold text-neutral-900 mb-4 flex items-center gap-2">
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  {eventsTitle}
                </h3>
                <div className="space-y-2">
                  {eventsData.map(event => (
                    <div key={event.id} className="flex items-center justify-between py-2 border-b border-neutral-100 last:border-0">
                      <div className="flex-1">
                        <div className="text-sm font-medium text-neutral-900">{event.name}</div>
                        <div className="text-xs text-neutral-500">{event.date} â€¢ {event.type}</div>
                      </div>
                      <span className={`text-xs px-2 py-1 rounded ${
                        event.status === 'Upcoming' || event.status === 'Registered' ? 'bg-blue-100 text-blue-700' :
                        event.status === 'Open' ? 'bg-green-100 text-green-700' :
                        event.status === 'Past' || event.status === 'Attended' ? 'bg-neutral-100 text-neutral-700' :
                        'bg-neutral-100 text-neutral-700'
                      }`}>
                        {event.status}
                      </span>
                    </div>
                  ))}
                </div>
              </>
            );

          case 'card':
            return (
              <>
                <h3 className="text-lg font-semibold text-neutral-900 mb-4 flex items-center gap-2">
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  {eventsTitle}
                </h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  {eventsData.map(event => (
                    <div key={event.id} className="bg-neutral-50 border border-neutral-200 rounded-lg p-4">
                      <div className="text-sm font-semibold text-neutral-900 mb-1">{event.name}</div>
                      <div className="text-xs text-neutral-600 mb-2">{event.date}</div>
                      <div className="flex items-center gap-2">
                        <span className="text-xs text-neutral-500">{event.type}</span>
                        <span className={`text-xs px-2 py-0.5 rounded ${
                          event.status === 'Upcoming' || event.status === 'Registered' ? 'bg-blue-100 text-blue-700' :
                          event.status === 'Open' ? 'bg-green-100 text-green-700' :
                          event.status === 'Past' || event.status === 'Attended' ? 'bg-neutral-100 text-neutral-700' :
                          'bg-neutral-100 text-neutral-700'
                        }`}>
                          {event.status}
                        </span>
                      </div>
                    </div>
                  ))}
                </div>
              </>
            );

          case 'grid':
            return (
              <>
                <div className="px-6 py-4 border-b border-neutral-200">
                  <h3 className="text-lg font-semibold text-neutral-900 flex items-center gap-2">
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    {eventsTitle}
                  </h3>
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-neutral-50 border-b border-neutral-200">
                      <tr>
                        <th className="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Event</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Date</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Type</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Status</th>
                      </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-neutral-200">
                      {eventsData.map(event => (
                        <tr key={event.id} className="hover:bg-neutral-50">
                          <td className="px-6 py-4 text-sm text-neutral-900">{event.name}</td>
                          <td className="px-6 py-4 text-sm text-neutral-600 font-mono tabular-nums">{event.date}</td>
                          <td className="px-6 py-4 text-sm text-neutral-600">{event.type}</td>
                          <td className="px-6 py-4">
                            <span className={`text-xs px-2 py-1 rounded ${
                              event.status === 'Upcoming' || event.status === 'Registered' ? 'bg-blue-100 text-blue-700' :
                              event.status === 'Open' ? 'bg-green-100 text-green-700' :
                              event.status === 'Past' || event.status === 'Attended' ? 'bg-neutral-100 text-neutral-700' :
                              'bg-neutral-100 text-neutral-700'
                            }`}>
                              {event.status}
                            </span>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </>
            );

          case 'visualizations':
            return (
              <div className="text-center py-8">
                <div className="text-7xl font-bold text-neutral-900 mb-2">{eventsData.length}</div>
                <div className="text-lg font-medium text-neutral-600">{eventsTitle}</div>
                <div className="text-sm text-neutral-500 mt-1">Total Events</div>
              </div>
            );

          case 'custom':
          default:
            return (
              <>
                <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-4">{eventsTitle}</h3>
                <div className="space-y-3">
                  {eventsData.map(event => (
                    <div key={event.id} className="flex items-center justify-between py-2 border-b border-neutral-100 last:border-0">
                      <div className="flex-1">
                        <div className="text-sm font-medium text-neutral-900">{event.name}</div>
                        <div className="text-xs text-neutral-500">{event.date} â€¢ {event.type}</div>
                      </div>
                      <span className={`text-xs px-2 py-1 rounded ${
                        event.status === 'Upcoming' || event.status === 'Registered' ? 'bg-blue-100 text-blue-700' :
                        event.status === 'Open' ? 'bg-green-100 text-green-700' :
                        event.status === 'Past' || event.status === 'Attended' ? 'bg-neutral-100 text-neutral-700' :
                        'bg-neutral-100 text-neutral-700'
                      }`}>
                        {event.status}
                      </span>
                    </div>
                  ))}
                </div>
              </>
            );
        }

      // ========================================================================
      // CONTACT CRM RECORD TYPE ELEMENTS
      // ========================================================================
      case 'contact-profile':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-6">Profile</h3>
            <div className="space-y-4">
              <div className="flex items-center gap-4 pb-4 border-b border-neutral-100">
                <div className="w-16 h-16 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-2xl font-semibold flex-shrink-0">
                  {record?.title?.split(' ').map(n => n[0]).join('') || '?'}
                </div>
                <div className="flex-1">
                  <div className="text-sm font-medium text-neutral-500 mb-1">Lifecycle Stage</div>
                  <div className="text-base font-semibold text-neutral-900">{record?.contactLifecycleStage || 'N/A'}</div>
                </div>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <dt className="text-xs text-neutral-500 mb-1">Lead Status</dt>
                  <dd className="text-sm text-neutral-900">{record?.contactLeadStatus || 'N/A'}</dd>
                </div>
                <div>
                  <dt className="text-xs text-neutral-500 mb-1">Source</dt>
                  <dd className="text-sm text-neutral-900">{record?.contactSource || 'N/A'}</dd>
                </div>
                <div>
                  <dt className="text-xs text-neutral-500 mb-1">Engagement Score</dt>
                  <dd className="text-sm font-semibold text-neutral-900">{record?.contactEngagementScore || 0}/100</dd>
                </div>
                <div>
                  <dt className="text-xs text-neutral-500 mb-1">Last Contacted</dt>
                  <dd className="text-sm text-neutral-900">{record?.contactLastContactedDate || 'N/A'}</dd>
                </div>
              </div>
              {record?.contactSocialProfiles && (
                <div className="pt-4 border-t border-neutral-100">
                  <dt className="text-xs text-neutral-500 mb-3">Social Profiles</dt>
                  <div className="space-y-2">
                    {record.contactSocialProfiles.linkedin && (
                      <div className="flex items-center gap-2 text-sm">
                        <span className="text-neutral-500 w-20">LinkedIn:</span>
                        <a href={`https://${record.contactSocialProfiles.linkedin}`} className="text-blue-600 hover:underline" target="_blank" rel="noopener noreferrer">
                          {record.contactSocialProfiles.linkedin}
                        </a>
                      </div>
                    )}
                    {record.contactSocialProfiles.twitter && (
                      <div className="flex items-center gap-2 text-sm">
                        <span className="text-neutral-500 w-20">Twitter:</span>
                        <span className="text-neutral-900">{record.contactSocialProfiles.twitter}</span>
                      </div>
                    )}
                    {record.contactSocialProfiles.github && (
                      <div className="flex items-center gap-2 text-sm">
                        <span className="text-neutral-500 w-20">GitHub:</span>
                        <a href={`https://${record.contactSocialProfiles.github}`} className="text-blue-600 hover:underline" target="_blank" rel="noopener noreferrer">
                          {record.contactSocialProfiles.github}
                        </a>
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>
          </>
        );

      case 'contact-company':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-6">Company Information</h3>
            {record?.contactCompanyInfo ? (
              <div className="space-y-4">
                <div>
                  <dt className="text-xs text-neutral-500 mb-1">Company Name</dt>
                  <dd className="text-base font-semibold text-neutral-900">{record.contactCompanyInfo.name}</dd>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <dt className="text-xs text-neutral-500 mb-1">Industry</dt>
                    <dd className="text-sm text-neutral-900">{record.contactCompanyInfo.industry}</dd>
                  </div>
                  <div>
                    <dt className="text-xs text-neutral-500 mb-1">Company Size</dt>
                    <dd className="text-sm text-neutral-900">{record.contactCompanyInfo.size}</dd>
                  </div>
                  {record.contactCompanyInfo.revenue && (
                    <div>
                      <dt className="text-xs text-neutral-500 mb-1">Revenue</dt>
                      <dd className="text-sm text-neutral-900">{record.contactCompanyInfo.revenue}</dd>
                    </div>
                  )}
                  {record.contactCompanyInfo.website && (
                    <div>
                      <dt className="text-xs text-neutral-500 mb-1">Website</dt>
                      <dd className="text-sm">
                        <a href={`https://${record.contactCompanyInfo.website}`} className="text-blue-600 hover:underline" target="_blank" rel="noopener noreferrer">
                          {record.contactCompanyInfo.website}
                        </a>
                      </dd>
                    </div>
                  )}
                </div>
              </div>
            ) : (
              <div className="text-sm text-neutral-500 italic">No company information available</div>
            )}
          </>
        );

      case 'contact-timeline':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-6">Activity Timeline</h3>
            {record?.contactTimeline && record.contactTimeline.length > 0 ? (
              <div className="space-y-4">
                {record.contactTimeline.map((item, idx) => (
                  <div key={idx} className="flex gap-3">
                    <div className="flex-shrink-0 w-8 h-8 rounded-full bg-neutral-100 flex items-center justify-center">
                      {item.icon === 'email' && (
                        <svg className="w-4 h-4 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                      )}
                      {item.icon === 'calendar' && (
                        <svg className="w-4 h-4 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                      )}
                      {item.icon === 'document' && (
                        <svg className="w-4 h-4 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                      )}
                      {item.icon === 'star' && (
                        <svg className="w-4 h-4 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                        </svg>
                      )}
                      {item.icon === 'users' && (
                        <svg className="w-4 h-4 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                      )}
                    </div>
                    <div className="flex-1">
                      <div className="text-xs text-neutral-500 mb-1">{item.date}</div>
                      <div className="text-sm font-medium text-neutral-900">{item.title}</div>
                      {item.description && (
                        <div className="text-sm text-neutral-600 mt-1">{item.description}</div>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-sm text-neutral-500 italic">No activity recorded</div>
            )}
          </>
        );

      case 'contact-notes':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-6">Notes</h3>
            {record?.contactNotes && record.contactNotes.length > 0 ? (
              <div className="space-y-4">
                {record.contactNotes.map((note, idx) => (
                  <div key={note.id || idx} className="bg-neutral-50 rounded-lg p-4">
                    <div className="flex items-start justify-between mb-2">
                      <div className="text-xs font-medium text-neutral-900">{note.author}</div>
                      <div className="text-xs text-neutral-500">{note.date}</div>
                    </div>
                    <p className="text-sm text-neutral-700 leading-relaxed">{note.note}</p>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-sm text-neutral-500 italic">No notes available</div>
            )}
          </>
        );

      case 'contact-deals':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-6">Deals</h3>
            {record?.contactDeals && record.contactDeals.length > 0 ? (
              <div className="space-y-3">
                {record.contactDeals.map((deal, idx) => (
                  <div key={deal.id || idx} className="bg-neutral-50 rounded-lg p-4">
                    <div className="flex items-start justify-between mb-3">
                      <div>
                        <div className="text-sm font-semibold text-neutral-900 mb-1">{deal.name}</div>
                        <div className="text-xs text-neutral-500">{deal.id}</div>
                      </div>
                      <div className="text-right">
                        <div className="text-sm font-bold text-neutral-900">${deal.amount.toLocaleString()}</div>
                        <div className="text-xs text-neutral-500">{deal.probability}% probability</div>
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-3 text-xs">
                      <div>
                        <span className="text-neutral-500">Stage:</span>
                        <span className="ml-2 text-neutral-900">{deal.stage}</span>
                      </div>
                      <div>
                        <span className="text-neutral-500">Close Date:</span>
                        <span className="ml-2 text-neutral-900">{deal.closeDate}</span>
                      </div>
                      <div className="col-span-2">
                        <span className="text-neutral-500">Owner:</span>
                        <span className="ml-2 text-neutral-900">{deal.owner}</span>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-sm text-neutral-500 italic">No deals available</div>
            )}
          </>
        );

      case 'contact-tasks':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-6">Tasks</h3>
            {record?.contactTasks && record.contactTasks.length > 0 ? (
              <div className="space-y-2">
                {record.contactTasks.map((task, idx) => (
                  <div key={task.id || idx} className="flex items-start gap-3 p-3 bg-neutral-50 rounded-lg hover:bg-neutral-100 transition-colors">
                    <input type="checkbox" className="mt-1 rounded border-neutral-300" />
                    <div className="flex-1 min-w-0">
                      <div className="text-sm font-medium text-neutral-900 mb-1">{task.title}</div>
                      <div className="flex items-center gap-3 text-xs text-neutral-500">
                        <span className="flex items-center gap-1">
                          <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                          </svg>
                          {task.dueDate}
                        </span>
                        <span className={`px-2 py-0.5 rounded ${
                          task.priority === 'High' ? 'bg-red-100 text-red-700' :
                          task.priority === 'Medium' ? 'bg-yellow-100 text-yellow-700' :
                          'bg-neutral-200 text-neutral-700'
                        }`}>
                          {task.priority}
                        </span>
                        <span>{task.assignedTo}</span>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-sm text-neutral-500 italic">No tasks available</div>
            )}
          </>
        );

      // ========================================================================
      // EVENT RECORD TYPE ELEMENTS
      // ========================================================================
      case 'event-hero':
        return (
          <div className="p-8 bg-gradient-to-br from-blue-50 to-purple-50 rounded-lg">
            <div className="text-xs font-medium text-purple-600 uppercase tracking-wider mb-2">{record?.eventType}</div>
            <h2 className="text-3xl font-bold text-neutral-900 mb-4">{record?.title}</h2>
            <div className="flex flex-wrap gap-6 text-sm text-neutral-700 mb-4">
              <div className="flex items-center gap-2">
                <svg className="w-5 h-5 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                {record?.eventDate}
              </div>
              <div className="flex items-center gap-2">
                <svg className="w-5 h-5 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                {record?.eventLocation}
              </div>
              <div className="flex items-center gap-2">
                <svg className="w-5 h-5 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                {record?.eventRegistered} / {record?.eventCapacity} registered
              </div>
            </div>
            <p className="text-neutral-700 leading-relaxed">{record?.summary}</p>
          </div>
        );

      case 'event-speakers':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-6">Featured Speakers</h3>
            {record?.eventSpeakers && record.eventSpeakers.length > 0 ? (
              <div className="space-y-4">
                {record.eventSpeakers.map((speaker, idx) => (
                  <div key={idx} className="flex gap-4 pb-4 border-b border-neutral-100 last:border-0">
                    <div className="w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white text-lg font-semibold flex-shrink-0">
                      {speaker.name.split(' ').map(n => n[0]).join('')}
                    </div>
                    <div className="flex-1">
                      <div className="text-sm font-semibold text-neutral-900">{speaker.name}</div>
                      <div className="text-xs text-neutral-600">{speaker.title}</div>
                      <div className="text-xs text-neutral-500">{speaker.company}</div>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-sm text-neutral-500 italic">Speaker lineup coming soon</div>
            )}
          </>
        );

      case 'event-schedule':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-6">Schedule</h3>
            {record?.eventSchedule && record.eventSchedule.length > 0 ? (
              <div className="space-y-3">
                {record.eventSchedule.slice(0, 6).map((item, idx) => (
                  <div key={idx} className="flex gap-3">
                    <div className="text-xs text-neutral-500 font-mono w-16 flex-shrink-0">{item.time}</div>
                    <div className="flex-1">
                      <div className="text-sm font-medium text-neutral-900">{item.session}</div>
                      {item.speaker && <div className="text-xs text-neutral-500">{item.speaker}</div>}
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-sm text-neutral-500 italic">Schedule to be announced</div>
            )}
          </>
        );

      case 'event-registration':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-6">Registration</h3>
            <div className="space-y-4">
              <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                <div className="text-xs text-green-600 font-medium mb-1">Early Bird Pricing</div>
                <div className="text-2xl font-bold text-green-700 mb-1">{record?.eventEarlyBirdPrice}</div>
                <div className="text-xs text-green-600">Until {record?.eventEarlyBirdDeadline}</div>
              </div>
              <div>
                <div className="text-xs text-neutral-500 mb-1">Regular Price</div>
                <div className="text-lg font-semibold text-neutral-900">{record?.eventTicketPrice}</div>
              </div>
              <button className="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                Register Now
              </button>
              <div className="text-xs text-neutral-500 text-center">
                {record?.eventRegistered} / {record?.eventCapacity} spots filled
              </div>
            </div>
          </>
        );

      case 'event-testimonials':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-6">What Attendees Say</h3>
            {record?.eventTestimonials && record.eventTestimonials.length > 0 ? (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {record.eventTestimonials.map((testimonial, idx) => (
                  <div key={idx} className="bg-neutral-50 rounded-lg p-6">
                    <p className="text-sm text-neutral-700 italic mb-4">"{testimonial.quote}"</p>
                    <div className="text-xs font-medium text-neutral-900">{testimonial.name}</div>
                    <div className="text-xs text-neutral-500">{testimonial.title}, {testimonial.company}</div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-sm text-neutral-500 italic">Testimonials coming soon</div>
            )}
          </>
        );

      case 'event-speakers':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-6">Featured Speakers</h3>
            {record?.eventSpeakers && record.eventSpeakers.length > 0 ? (
              <div className="space-y-4">
                {record.eventSpeakers.map((speaker, idx) => (
                  <div key={idx} className="flex gap-4 pb-4 border-b border-neutral-100 last:border-0">
                    <div className="w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white text-lg font-semibold flex-shrink-0">
                      {speaker.name.split(' ').map(n => n[0]).join('')}
                    </div>
                    <div className="flex-1">
                      <div className="text-sm font-semibold text-neutral-900">{speaker.name}</div>
                      <div className="text-xs text-neutral-600">{speaker.title}</div>
                      <div className="text-xs text-neutral-500">{speaker.company}</div>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-sm text-neutral-500 italic">Speaker lineup coming soon</div>
            )}
          </>
        );

      case 'event-schedule':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-6">Schedule</h3>
            {record?.eventSchedule && record.eventSchedule.length > 0 ? (
              <div className="space-y-3">
                {record.eventSchedule.slice(0, 6).map((item, idx) => (
                  <div key={idx} className="flex gap-3">
                    <div className="text-xs text-neutral-500 font-mono w-16 flex-shrink-0">{item.time}</div>
                    <div className="flex-1">
                      <div className="text-sm font-medium text-neutral-900">{item.session}</div>
                      {item.speaker && <div className="text-xs text-neutral-500">{item.speaker}</div>}
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-sm text-neutral-500 italic">Schedule to be announced</div>
            )}
          </>
        );

      case 'event-registration':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-6">Registration</h3>
            <div className="space-y-4">
              <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                <div className="text-xs text-green-600 font-medium mb-1">Early Bird Pricing</div>
                <div className="text-2xl font-bold text-green-700 mb-1">{record?.eventEarlyBirdPrice}</div>
                <div className="text-xs text-green-600">Until {record?.eventEarlyBirdDeadline}</div>
              </div>
              <div>
                <div className="text-xs text-neutral-500 mb-1">Regular Price</div>
                <div className="text-lg font-semibold text-neutral-900">{record?.eventTicketPrice}</div>
              </div>
              <button className="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                Register Now
              </button>
              <div className="text-xs text-neutral-500 text-center">
                {record?.eventRegistered} / {record?.eventCapacity} spots filled
              </div>
            </div>
          </>
        );

      // ========================================================================
      // ARTICLE RECORD TYPE ELEMENTS
      // ========================================================================
      case 'article-header':
        return (
          <div className="mb-8">
            <div className="text-xs font-medium text-blue-600 uppercase tracking-wider mb-2">{record?.articleCategory}</div>
            <h2 className="text-3xl font-bold text-neutral-900 mb-4">{record?.title}</h2>
            <div className="flex items-center gap-4 text-sm text-neutral-500">
              <span>{record?.articlePublishDate}</span>
              <span>â€¢</span>
              <span>{record?.articleReadTime}</span>
            </div>
            {record?.articleExcerpt && (
              <p className="mt-4 text-lg text-neutral-600 leading-relaxed">{record.articleExcerpt}</p>
            )}
          </div>
        );

      case 'article-content':
        return (
          <div className="prose prose-neutral max-w-none">
            <div className="text-neutral-700 leading-relaxed whitespace-pre-wrap">
              {record?.articleContent?.substring(0, 2000)}
              {record?.articleContent && record.articleContent.length > 2000 && '...'}
            </div>
          </div>
        );

      case 'article-author':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-6">About the Author</h3>
            <div className="flex gap-4">
              <div className="w-16 h-16 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white text-2xl font-semibold flex-shrink-0">
                {record?.articleAuthor?.split(' ').map(n => n[0]).join('') || '?'}
              </div>
              <div>
                <div className="text-sm font-semibold text-neutral-900">{record?.articleAuthor}</div>
                <div className="text-xs text-neutral-600 mb-2">{record?.articleAuthorTitle}</div>
                <p className="text-sm text-neutral-700 leading-relaxed">{record?.articleAuthorBio}</p>
              </div>
            </div>
          </>
        );

      case 'article-related':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-6">Related Articles</h3>
            <div className="text-sm text-neutral-500 italic">More articles coming soon</div>
          </>
        );

      // ========================================================================
      // GENERIC ELEMENT RENDERERS FOR OTHER RECORD TYPES
      // ========================================================================
      case 'landing-hero':
        console.log('ðŸŽ¨âœ… RENDERING LANDING HERO - NEW BEAUTIFUL DESIGN!!!', {
          recordType,
          recordTitle: record?.title,
          recordSummary: record?.summary
        });
        return (
          <div className="border border-neutral-200 rounded-lg overflow-hidden bg-white shadow-sm">
            {/* Browser Chrome */}
            <div className="bg-neutral-100 border-b border-neutral-200 px-4 py-2 flex items-center gap-2">
              <div className="flex gap-1.5">
                <div className="w-2.5 h-2.5 rounded-full bg-red-400"></div>
                <div className="w-2.5 h-2.5 rounded-full bg-yellow-400"></div>
                <div className="w-2.5 h-2.5 rounded-full bg-green-400"></div>
              </div>
              <div className="flex-1 bg-white rounded px-3 py-0.5 text-xs text-neutral-500">
                ðŸ”’ www.example.com/{record?.title?.toLowerCase().replace(/\s+/g, '-') || 'landing'}
              </div>
            </div>

            {/* Landing Page Hero */}
            <div className="bg-gradient-to-br from-blue-600 via-purple-600 to-pink-600 text-white px-12 py-16 text-center relative overflow-hidden">
              {/* Decorative circles */}
              <div className="absolute top-0 right-0 w-64 h-64 bg-white opacity-10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
              <div className="absolute bottom-0 left-0 w-48 h-48 bg-white opacity-10 rounded-full translate-y-1/2 -translate-x-1/2"></div>

              <div className="relative z-10">
                <div className="inline-block px-4 py-1 bg-white/20 backdrop-blur-sm rounded-full text-sm font-medium mb-4">
                  âœ¨ New Feature Available
                </div>
                <h1 className="text-4xl font-bold mb-4">{record?.title}</h1>
                <p className="text-xl text-white/90 max-w-2xl mx-auto mb-8">{record?.summary}</p>
                <div className="flex items-center justify-center gap-4">
                  <button className="bg-white text-purple-600 font-semibold px-8 py-3 rounded-lg shadow-xl hover:shadow-2xl transition-all transform hover:scale-105">
                    Get Started Free
                  </button>
                  <button className="bg-transparent border-2 border-white text-white font-semibold px-8 py-3 rounded-lg hover:bg-white/10 transition-all">
                    Watch Demo
                  </button>
                </div>
                <div className="mt-6 text-sm text-white/80">
                  No credit card required â€¢ 14-day free trial â€¢ Cancel anytime
                </div>
              </div>
            </div>

            {/* Trust Bar */}
            <div className="bg-neutral-50 border-b border-neutral-200 px-8 py-4">
              <div className="text-xs text-neutral-500 text-center mb-2">Trusted by leading companies</div>
              <div className="flex items-center justify-center gap-8 text-neutral-400">
                <div className="font-bold">ACME</div>
                <div className="font-bold">TechCo</div>
                <div className="font-bold">StartupXYZ</div>
                <div className="font-bold">Enterprise</div>
              </div>
            </div>
          </div>
        );

      case 'course-hero':
      case 'product-gallery':
      case 'dashboard-header':
      case 'portfolio-hero':
      case 'invoice-header':
      case 'job-header':
        return (
          <div className="p-8 bg-gradient-to-br from-neutral-50 to-neutral-100 rounded-lg">
            <h2 className="text-2xl font-bold text-neutral-900 mb-3">{record?.title}</h2>
            <p className="text-neutral-700">{record?.summary || record?.bio}</p>
          </div>
        );

      case 'invoice-details':
        return (
          <div className="grid grid-cols-2 gap-6">
            <div>
              <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-4">Bill To</h3>
              <div className="text-sm">
                <div className="font-semibold text-neutral-900">{record?.invoiceBillTo?.name}</div>
                <div className="text-neutral-700 mt-1">{record?.invoiceBillTo?.contact}</div>
                <div className="text-neutral-700">{record?.invoiceBillTo?.address}</div>
                <div className="text-neutral-700">{record?.invoiceBillTo?.city}, {record?.invoiceBillTo?.state} {record?.invoiceBillTo?.zip}</div>
                <div className="text-neutral-700 mt-2">{record?.invoiceBillTo?.email}</div>
                <div className="text-neutral-700">{record?.invoiceBillTo?.phone}</div>
              </div>
            </div>
            <div>
              <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-4">Invoice Details</h3>
              <div className="text-sm space-y-2">
                <div className="flex justify-between">
                  <span className="text-neutral-500">Invoice #:</span>
                  <span className="font-medium text-neutral-900">{record?.invoiceNumber}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-neutral-500">Date:</span>
                  <span className="text-neutral-700">{record?.invoiceDate}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-neutral-500">Due Date:</span>
                  <span className="text-neutral-700">{record?.invoiceDueDate}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-neutral-500">Payment Terms:</span>
                  <span className="text-neutral-700">{record?.invoicePaymentTerms}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-neutral-500">Status:</span>
                  <span className={`font-medium ${record?.invoiceStatus === 'Paid' ? 'text-green-600' : 'text-orange-600'}`}>
                    {record?.invoiceStatus}
                  </span>
                </div>
              </div>
            </div>
          </div>
        );

      case 'invoice-items':
        return (
          <div>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-4">Line Items</h3>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className="border-b border-neutral-200">
                    <th className="text-left text-xs font-medium text-neutral-500 uppercase tracking-wider pb-3">Description</th>
                    <th className="text-right text-xs font-medium text-neutral-500 uppercase tracking-wider pb-3">Qty</th>
                    <th className="text-right text-xs font-medium text-neutral-500 uppercase tracking-wider pb-3">Rate</th>
                    <th className="text-right text-xs font-medium text-neutral-500 uppercase tracking-wider pb-3">Amount</th>
                  </tr>
                </thead>
                <tbody>
                  {record?.invoiceLineItems?.map((item, index) => (
                    <tr key={item.id} className={index !== record.invoiceLineItems.length - 1 ? 'border-b border-neutral-100' : ''}>
                      <td className="py-4">
                        <div className="font-medium text-neutral-900 text-sm">{item.description}</div>
                        {item.details && <div className="text-xs text-neutral-500 mt-1">{item.details}</div>}
                      </td>
                      <td className="py-4 text-right text-sm text-neutral-700">
                        {item.quantity} {item.unit}
                      </td>
                      <td className="py-4 text-right text-sm text-neutral-700">
                        ${item.rate.toFixed(2)}
                      </td>
                      <td className="py-4 text-right text-sm font-medium text-neutral-900">
                        ${item.amount.toFixed(2)}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        );

      case 'invoice-totals':
        return (
          <div className="max-w-sm ml-auto">
            <div className="space-y-3">
              <div className="flex justify-between text-sm">
                <span className="text-neutral-500">Subtotal:</span>
                <span className="font-medium text-neutral-900">${record?.invoiceSubtotal?.toFixed(2)}</span>
              </div>
              {record?.invoiceDiscount > 0 && (
                <div className="flex justify-between text-sm">
                  <span className="text-neutral-500">Discount:</span>
                  <span className="text-green-600">-${record?.invoiceDiscount?.toFixed(2)}</span>
                </div>
              )}
              <div className="flex justify-between text-sm">
                <span className="text-neutral-500">Tax:</span>
                <span className="text-neutral-700">${record?.invoiceTax?.toFixed(2)}</span>
              </div>
              {record?.invoiceTaxNote && (
                <div className="text-xs text-neutral-500 italic">{record.invoiceTaxNote}</div>
              )}
              <div className="border-t border-neutral-200 pt-3 flex justify-between">
                <span className="font-semibold text-neutral-900">Total:</span>
                <span className="text-lg font-bold text-neutral-900">${record?.invoiceTotal?.toFixed(2)}</span>
              </div>
              {record?.invoiceAmountPaid > 0 && (
                <>
                  <div className="flex justify-between text-sm">
                    <span className="text-neutral-500">Amount Paid:</span>
                    <span className="text-green-600">-${record?.invoiceAmountPaid?.toFixed(2)}</span>
                  </div>
                  <div className="flex justify-between text-sm font-semibold">
                    <span className="text-neutral-700">Balance Due:</span>
                    <span className={record?.invoiceBalance === 0 ? 'text-green-600' : 'text-orange-600'}>
                      ${record?.invoiceBalance?.toFixed(2)}
                    </span>
                  </div>
                </>
              )}
            </div>
          </div>
        );

      case 'invoice-notes':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">Notes</h3>
            <p className="text-sm text-neutral-700 whitespace-pre-line">{record?.invoiceNotes}</p>
          </>
        );

      case 'invoice-actions':
        return (
          <div className="flex gap-3 justify-end">
            <button className="px-4 py-2 text-sm font-medium text-neutral-700 bg-white border border-neutral-300 rounded-lg hover:bg-neutral-50 transition-colors">
              Download PDF
            </button>
            <button className="px-4 py-2 text-sm font-medium text-neutral-700 bg-white border border-neutral-300 rounded-lg hover:bg-neutral-50 transition-colors">
              Print
            </button>
            {record?.invoiceStatus !== 'Paid' && (
              <button className="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">
                Record Payment
              </button>
            )}
          </div>
        );

      case 'course-enrollment':
        return (
          <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-6">
            <div className="text-2xl font-bold text-neutral-900 mb-2">${record?.price || '99'}</div>
            <p className="text-sm text-neutral-600 mb-4">Full course access</p>
            <button className="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors mb-3">
              Enroll Now
            </button>
            <p className="text-xs text-neutral-500 text-center">30-day money-back guarantee</p>
          </div>
        );

      case 'course-curriculum':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-4">Curriculum</h3>
            <div className="space-y-3">
              <div className="flex items-center gap-3 p-3 bg-neutral-50 rounded-lg">
                <div className="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-bold">1</div>
                <div className="flex-1">
                  <div className="font-medium text-neutral-900 text-sm">Introduction & Fundamentals</div>
                  <div className="text-xs text-neutral-500">5 lessons â€¢ 2 hours</div>
                </div>
              </div>
              <div className="flex items-center gap-3 p-3 bg-neutral-50 rounded-lg">
                <div className="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-bold">2</div>
                <div className="flex-1">
                  <div className="font-medium text-neutral-900 text-sm">Advanced Concepts</div>
                  <div className="text-xs text-neutral-500">8 lessons â€¢ 4 hours</div>
                </div>
              </div>
              <div className="flex items-center gap-3 p-3 bg-neutral-50 rounded-lg">
                <div className="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-bold">3</div>
                <div className="flex-1">
                  <div className="font-medium text-neutral-900 text-sm">Practical Projects</div>
                  <div className="text-xs text-neutral-500">6 lessons â€¢ 3 hours</div>
                </div>
              </div>
            </div>
          </>
        );

      case 'course-instructor':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-4">Instructor</h3>
            <div className="flex items-start gap-4">
              <div className="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-500 rounded-full flex items-center justify-center text-white font-bold text-xl flex-shrink-0">
                {record?.title?.substring(0, 2).toUpperCase() || 'IN'}
              </div>
              <div>
                <div className="font-semibold text-neutral-900 mb-1">Expert Instructor</div>
                <div className="text-sm text-neutral-600">{record?.bio || 'Professional educator with years of experience in the field.'}</div>
              </div>
            </div>
          </>
        );

      case 'course-testimonials':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-4">Student Reviews</h3>
            <div className="space-y-4">
              <div className="bg-neutral-50 rounded-lg p-4">
                <div className="flex gap-1 mb-2">
                  {[1, 2, 3, 4, 5].map(i => <span key={i} className="text-yellow-400">â­</span>)}
                </div>
                <p className="text-sm text-neutral-700 mb-2">"Excellent course! Very comprehensive and well-structured."</p>
                <p className="text-xs text-neutral-500">- Student Name</p>
              </div>
            </div>
          </>
        );

      case 'product-purchase':
        return (
          <div className="bg-white border border-neutral-200 rounded-lg p-6">
            <div className="text-3xl font-bold text-neutral-900 mb-2">${record?.price || '299'}</div>
            <p className="text-sm text-neutral-600 mb-6">In stock, ready to ship</p>
            <button className="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors mb-3">
              Add to Cart
            </button>
            <button className="w-full bg-neutral-100 hover:bg-neutral-200 text-neutral-900 font-medium py-3 px-4 rounded-lg transition-colors">
              Buy Now
            </button>
          </div>
        );

      case 'product-reviews':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-4">Customer Reviews</h3>
            <div className="space-y-4">
              <div className="border-b border-neutral-200 pb-4">
                <div className="flex items-center gap-2 mb-2">
                  <div className="flex gap-1">
                    {[1, 2, 3, 4, 5].map(i => <span key={i} className="text-yellow-400">â­</span>)}
                  </div>
                  <span className="text-sm font-medium text-neutral-900">5.0</span>
                </div>
                <p className="text-sm text-neutral-700 mb-2">"Amazing product! Exceeded all my expectations. Highly recommended."</p>
                <p className="text-xs text-neutral-500">By John D. on Nov 15, 2024</p>
              </div>
            </div>
          </>
        );

      case 'job-requirements':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-4">Requirements</h3>
            <ul className="space-y-2">
              <li className="flex items-start gap-2 text-sm text-neutral-700">
                <span className="text-blue-600 mt-1">â€¢</span>
                <span>5+ years of experience in related field</span>
              </li>
              <li className="flex items-start gap-2 text-sm text-neutral-700">
                <span className="text-blue-600 mt-1">â€¢</span>
                <span>Bachelor's degree or equivalent experience</span>
              </li>
              <li className="flex items-start gap-2 text-sm text-neutral-700">
                <span className="text-blue-600 mt-1">â€¢</span>
                <span>Strong communication and leadership skills</span>
              </li>
              <li className="flex items-start gap-2 text-sm text-neutral-700">
                <span className="text-blue-600 mt-1">â€¢</span>
                <span>Ability to work in a fast-paced environment</span>
              </li>
            </ul>
          </>
        );

      case 'job-benefits':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-4">Benefits</h3>
            <ul className="space-y-2">
              <li className="flex items-start gap-2 text-sm text-neutral-700">
                <span className="text-green-600">âœ“</span>
                <span>Competitive salary and equity package</span>
              </li>
              <li className="flex items-start gap-2 text-sm text-neutral-700">
                <span className="text-green-600">âœ“</span>
                <span>Health, dental, and vision insurance</span>
              </li>
              <li className="flex items-start gap-2 text-sm text-neutral-700">
                <span className="text-green-600">âœ“</span>
                <span>Flexible work arrangements and remote options</span>
              </li>
              <li className="flex items-start gap-2 text-sm text-neutral-700">
                <span className="text-green-600">âœ“</span>
                <span>Professional development opportunities</span>
              </li>
            </ul>
          </>
        );

      case 'job-apply':
        return (
          <div className="bg-blue-50 border border-blue-200 rounded-lg p-6">
            <h3 className="text-sm font-semibold text-neutral-900 mb-4">Apply for this position</h3>
            <button className="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors mb-3">
              Submit Application
            </button>
            <p className="text-xs text-neutral-500 text-center">We'll review your application within 5 business days</p>
          </div>
        );

      case 'job-details':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-4">Job Details</h3>
            <div className="space-y-3 text-sm">
              <div>
                <div className="text-neutral-500 text-xs">Location</div>
                <div className="text-neutral-900 font-medium">{record?.location || 'Remote'}</div>
              </div>
              <div>
                <div className="text-neutral-500 text-xs">Job Type</div>
                <div className="text-neutral-900 font-medium">{record?.jobType || 'Full-time'}</div>
              </div>
              <div>
                <div className="text-neutral-500 text-xs">Salary Range</div>
                <div className="text-neutral-900 font-medium">{record?.salary || '$100k - $150k'}</div>
              </div>
            </div>
          </>
        );

      case 'job-team':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-4">Meet the Team</h3>
            <div className="space-y-3">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white font-bold text-sm">
                  SC
                </div>
                <div>
                  <div className="text-sm font-medium text-neutral-900">Sarah Chen</div>
                  <div className="text-xs text-neutral-500">Engineering Manager</div>
                </div>
              </div>
            </div>
          </>
        );

      case 'portfolio-challenge':
      case 'portfolio-solution':
      case 'portfolio-results':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-4">
              {recordType === 'portfolio-challenge' ? 'Challenge' : recordType === 'portfolio-solution' ? 'Solution' : 'Results'}
            </h3>
            <p className="text-sm text-neutral-700 leading-relaxed">{record?.bio || record?.summary || 'Project information will be displayed here.'}</p>
          </>
        );

      case 'portfolio-gallery':
        return (
          <div className="grid grid-cols-2 gap-4">
            <div className="aspect-video bg-gradient-to-br from-blue-100 to-purple-100 rounded-lg"></div>
            <div className="aspect-video bg-gradient-to-br from-green-100 to-teal-100 rounded-lg"></div>
            <div className="aspect-video bg-gradient-to-br from-orange-100 to-red-100 rounded-lg"></div>
            <div className="aspect-video bg-gradient-to-br from-pink-100 to-purple-100 rounded-lg"></div>
          </div>
        );

      case 'dashboard-chart':
        return (
          <div className="p-6 bg-white">
            <h3 className="text-sm font-semibold text-neutral-900 mb-4">Performance Chart</h3>
            <div className="h-48 bg-gradient-to-t from-blue-50 to-transparent rounded-lg flex items-end justify-around p-4">
              <div className="w-12 bg-blue-500 rounded-t" style={{ height: '60%' }}></div>
              <div className="w-12 bg-blue-500 rounded-t" style={{ height: '80%' }}></div>
              <div className="w-12 bg-blue-500 rounded-t" style={{ height: '45%' }}></div>
              <div className="w-12 bg-blue-500 rounded-t" style={{ height: '90%' }}></div>
              <div className="w-12 bg-blue-500 rounded-t" style={{ height: '70%' }}></div>
            </div>
          </div>
        );

      case 'dashboard-insights':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-4">Insights</h3>
            <div className="space-y-3">
              <div className="p-3 bg-green-50 border border-green-200 rounded-lg">
                <div className="text-xs font-medium text-green-900 mb-1">â†‘ 23% Increase</div>
                <div className="text-xs text-green-700">Performance is trending upward</div>
              </div>
              <div className="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <div className="text-xs font-medium text-blue-900 mb-1">New Record</div>
                <div className="text-xs text-blue-700">Best month this quarter</div>
              </div>
            </div>
          </>
        );

      case 'landing-sections':
        console.log('ðŸŒŸâœ… RENDERING LANDING SECTIONS - NEW BEAUTIFUL DESIGN!!!', {
          recordType,
          recordTitle: record?.title
        });
        return (
          <div className="bg-white border border-neutral-200 rounded-lg p-8">
            <div className="text-center mb-12">
              <h2 className="text-3xl font-bold text-neutral-900 mb-3">Why Choose Us?</h2>
              <p className="text-neutral-600 max-w-2xl mx-auto">Everything you need to succeed, all in one powerful platform</p>
            </div>

            {/* Features Grid */}
            <div className="grid grid-cols-3 gap-6 mb-12">
              <div className="text-center">
                <div className="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-500 rounded-xl mx-auto mb-4 flex items-center justify-center text-3xl">
                  ðŸš€
                </div>
                <h3 className="font-semibold text-neutral-900 mb-2">Lightning Fast</h3>
                <p className="text-sm text-neutral-600">Deploy in seconds, not hours. Our platform is optimized for speed.</p>
              </div>
              <div className="text-center">
                <div className="w-16 h-16 bg-gradient-to-br from-green-500 to-teal-500 rounded-xl mx-auto mb-4 flex items-center justify-center text-3xl">
                  ðŸ”’
                </div>
                <h3 className="font-semibold text-neutral-900 mb-2">Enterprise Security</h3>
                <p className="text-sm text-neutral-600">Bank-level encryption and compliance with industry standards.</p>
              </div>
              <div className="text-center">
                <div className="w-16 h-16 bg-gradient-to-br from-orange-500 to-red-500 rounded-xl mx-auto mb-4 flex items-center justify-center text-3xl">
                  ðŸ“Š
                </div>
                <h3 className="font-semibold text-neutral-900 mb-2">Deep Analytics</h3>
                <p className="text-sm text-neutral-600">Understand your data with powerful insights and visualizations.</p>
              </div>
            </div>

            {/* Stats Bar */}
            <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-6 grid grid-cols-3 gap-4 text-center">
              <div>
                <div className="text-3xl font-bold text-blue-600">{record?.peopleCount || '10,000'}+</div>
                <div className="text-sm text-neutral-600">Active Users</div>
              </div>
              <div>
                <div className="text-3xl font-bold text-purple-600">99.9%</div>
                <div className="text-sm text-neutral-600">Uptime SLA</div>
              </div>
              <div>
                <div className="text-3xl font-bold text-pink-600">{record?.activityCount || '50'}+</div>
                <div className="text-sm text-neutral-600">Integrations</div>
              </div>
            </div>
          </div>
        );

      case 'course-description':
      case 'product-info':
      case 'product-description':
      case 'job-description':
      case 'portfolio-overview':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-6">Description</h3>
            <p className="text-sm text-neutral-700 leading-relaxed">{record?.bio || record?.summary || 'Content will be displayed here.'}</p>
          </>
        );

      case 'landing-stats':
        return (
          <div className="bg-white border border-neutral-200 rounded-lg p-8">
            <div className="text-center mb-8">
              <h2 className="text-2xl font-bold text-neutral-900 mb-2">What Our Customers Say</h2>
              <p className="text-neutral-600">Don't just take our word for it</p>
            </div>

            {/* Testimonials */}
            <div className="space-y-6">
              <div className="bg-gradient-to-br from-blue-50 to-purple-50 rounded-lg p-6">
                <div className="flex items-start gap-4">
                  <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">
                    JD
                  </div>
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-2">
                      <div className="font-semibold text-neutral-900">Jane Doe</div>
                      <div className="text-xs text-neutral-500">â€¢ CEO, TechCorp</div>
                    </div>
                    <div className="flex gap-1 mb-2">
                      {[1,2,3,4,5].map(i => <span key={i} className="text-yellow-400">â­</span>)}
                    </div>
                    <p className="text-sm text-neutral-700 italic">"Absolutely game-changing! {record?.summary?.substring(0, 80) || 'This platform has transformed how we work.'}"</p>
                  </div>
                </div>
              </div>

              <div className="bg-gradient-to-br from-green-50 to-teal-50 rounded-lg p-6">
                <div className="flex items-start gap-4">
                  <div className="w-12 h-12 bg-gradient-to-br from-green-500 to-teal-500 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">
                    MS
                  </div>
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-2">
                      <div className="font-semibold text-neutral-900">Michael Smith</div>
                      <div className="text-xs text-neutral-500">â€¢ CTO, StartupXYZ</div>
                    </div>
                    <div className="flex gap-1 mb-2">
                      {[1,2,3,4,5].map(i => <span key={i} className="text-yellow-400">â­</span>)}
                    </div>
                    <p className="text-sm text-neutral-700 italic">"The ROI was immediate. We saw results within the first week of implementation!"</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );

      case 'course-stats':
      case 'email-stats':
      case 'dashboard-kpis':
        return (
          <>
            <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-6">Statistics</h3>
            <div className="grid grid-cols-2 gap-4">
              <div className="text-center">
                <div className="text-2xl font-bold text-neutral-900">{record?.peopleCount || 0}</div>
                <div className="text-xs text-neutral-500">Participants</div>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-neutral-900">{record?.activityCount || 0}</div>
                <div className="text-xs text-neutral-500">Activities</div>
              </div>
            </div>
          </>
        );

      case 'landing-performance':
        return (
          <div className="bg-white border border-neutral-200 rounded-lg p-8">
            <div className="text-center mb-8">
              <h2 className="text-2xl font-bold text-neutral-900 mb-2">Simple, Transparent Pricing</h2>
              <p className="text-neutral-600">Choose the plan that's right for you</p>
            </div>

            {/* Pricing Cards */}
            <div className="grid grid-cols-3 gap-6">
              <div className="border border-neutral-200 rounded-lg p-6 hover:shadow-lg transition-shadow">
                <div className="text-sm font-medium text-neutral-600 mb-2">Starter</div>
                <div className="text-3xl font-bold text-neutral-900 mb-4">
                  $29<span className="text-lg font-normal text-neutral-500">/mo</span>
                </div>
                <ul className="space-y-2 mb-6 text-sm text-neutral-700">
                  <li className="flex items-center gap-2">
                    <span className="text-green-500">âœ“</span> Up to 10 users
                  </li>
                  <li className="flex items-center gap-2">
                    <span className="text-green-500">âœ“</span> Basic features
                  </li>
                  <li className="flex items-center gap-2">
                    <span className="text-green-500">âœ“</span> Email support
                  </li>
                </ul>
                <button className="w-full bg-neutral-100 hover:bg-neutral-200 text-neutral-900 font-medium py-2 px-4 rounded-lg transition-colors">
                  Start Free Trial
                </button>
              </div>

              <div className="border-2 border-purple-500 rounded-lg p-6 relative shadow-lg">
                <div className="absolute -top-3 left-1/2 -translate-x-1/2 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-xs font-bold px-3 py-1 rounded-full">
                  POPULAR
                </div>
                <div className="text-sm font-medium text-purple-600 mb-2">Pro</div>
                <div className="text-3xl font-bold text-neutral-900 mb-4">
                  $99<span className="text-lg font-normal text-neutral-500">/mo</span>
                </div>
                <ul className="space-y-2 mb-6 text-sm text-neutral-700">
                  <li className="flex items-center gap-2">
                    <span className="text-green-500">âœ“</span> Up to 50 users
                  </li>
                  <li className="flex items-center gap-2">
                    <span className="text-green-500">âœ“</span> Advanced features
                  </li>
                  <li className="flex items-center gap-2">
                    <span className="text-green-500">âœ“</span> Priority support
                  </li>
                  <li className="flex items-center gap-2">
                    <span className="text-green-500">âœ“</span> Custom integrations
                  </li>
                </ul>
                <button className="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-medium py-2 px-4 rounded-lg transition-all">
                  Start Free Trial
                </button>
              </div>

              <div className="border border-neutral-200 rounded-lg p-6 hover:shadow-lg transition-shadow">
                <div className="text-sm font-medium text-neutral-600 mb-2">Enterprise</div>
                <div className="text-3xl font-bold text-neutral-900 mb-4">Custom</div>
                <ul className="space-y-2 mb-6 text-sm text-neutral-700">
                  <li className="flex items-center gap-2">
                    <span className="text-green-500">âœ“</span> Unlimited users
                  </li>
                  <li className="flex items-center gap-2">
                    <span className="text-green-500">âœ“</span> All features
                  </li>
                  <li className="flex items-center gap-2">
                    <span className="text-green-500">âœ“</span> Dedicated support
                  </li>
                  <li className="flex items-center gap-2">
                    <span className="text-green-500">âœ“</span> SLA guarantee
                  </li>
                </ul>
                <button className="w-full bg-neutral-100 hover:bg-neutral-200 text-neutral-900 font-medium py-2 px-4 rounded-lg transition-colors">
                  Contact Sales
                </button>
              </div>
            </div>
          </div>
        );

      case 'landing-tests':
        return (
          <div className="bg-gradient-to-br from-blue-600 via-purple-600 to-pink-600 text-white rounded-lg p-12 text-center">
            <h2 className="text-3xl font-bold mb-4">Ready to Get Started?</h2>
            <p className="text-xl text-white/90 mb-8 max-w-2xl mx-auto">
              Join thousands of teams already using {record?.title || 'our platform'} to achieve their goals
            </p>
            <div className="flex items-center justify-center gap-4">
              <button className="bg-white text-purple-600 font-semibold px-8 py-4 rounded-lg shadow-xl hover:shadow-2xl transition-all transform hover:scale-105">
                Start Free Trial â†’
              </button>
              <button className="bg-transparent border-2 border-white text-white font-semibold px-8 py-4 rounded-lg hover:bg-white/10 transition-all">
                Schedule Demo
              </button>
            </div>
            <div className="mt-6 text-sm text-white/80">
              âœ“ No credit card required  âœ“ 14-day free trial  âœ“ Cancel anytime
            </div>
          </div>
        );

      // ========================================================================
      // EMAIL CAMPAIGN ELEMENTS
      // ========================================================================
      case 'email-header':
        return (
          <div className="bg-neutral-50 border border-neutral-200 rounded-lg p-4 mb-4">
            <div className="space-y-2 text-xs">
              <div className="flex items-start">
                <span className="font-semibold text-neutral-500 w-16">From:</span>
                <span className="text-neutral-900">{record?.company || 'Marketing Team'} &lt;hello@example.com&gt;</span>
              </div>
              <div className="flex items-start">
                <span className="font-semibold text-neutral-500 w-16">To:</span>
                <span className="text-neutral-700">subscribers@list.com</span>
              </div>
              <div className="flex items-start">
                <span className="font-semibold text-neutral-500 w-16">Subject:</span>
                <span className="text-neutral-900 font-medium">{record?.title}</span>
              </div>
              {record?.summary && (
                <div className="flex items-start pt-2 border-t border-neutral-200">
                  <span className="font-semibold text-neutral-500 w-16">Preview:</span>
                  <span className="text-neutral-600 italic">{record.summary.substring(0, 80)}...</span>
                </div>
              )}
            </div>
          </div>
        );

      case 'email-preview':
        console.log('ðŸ“§âœ… RENDERING EMAIL PREVIEW - NEW BEAUTIFUL DESIGN!!!', {
          recordType,
          recordTitle: record?.title,
          recordCompany: record?.company
        });
        return (
          <div className="border border-neutral-200 rounded-lg overflow-hidden bg-white shadow-sm">
            {/* Email Browser Bar */}
            <div className="bg-neutral-100 border-b border-neutral-200 px-4 py-2 flex items-center gap-2">
              <div className="flex gap-1.5">
                <div className="w-2.5 h-2.5 rounded-full bg-red-400"></div>
                <div className="w-2.5 h-2.5 rounded-full bg-yellow-400"></div>
                <div className="w-2.5 h-2.5 rounded-full bg-green-400"></div>
              </div>
              <div className="flex-1 text-center text-xs text-neutral-500">Email Preview</div>
            </div>

            {/* Email Content */}
            <div className="bg-white">
              {/* Email Header with Logo */}
              <div className="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-8 py-6 text-center">
                <div className="w-12 h-12 bg-white rounded-lg mx-auto mb-3 flex items-center justify-center text-2xl font-bold text-blue-600">
                  {record?.company?.charAt(0) || 'ðŸ“§'}
                </div>
                <div className="text-sm font-medium opacity-90">{record?.company || 'Our Company'}</div>
              </div>

              {/* Email Body */}
              <div className="px-8 py-8">
                {/* Hero Section */}
                <div className="mb-6">
                  <h1 className="text-2xl font-bold text-neutral-900 mb-3">{record?.title}</h1>
                  <p className="text-base text-neutral-700 leading-relaxed">{record?.summary}</p>
                </div>

                {/* Feature Boxes */}
                <div className="grid grid-cols-2 gap-4 mb-6">
                  <div className="bg-blue-50 rounded-lg p-4 text-center">
                    <div className="text-3xl mb-2">ðŸŽ¯</div>
                    <div className="text-sm font-medium text-neutral-900">Targeted</div>
                    <div className="text-xs text-neutral-600">Reach your audience</div>
                  </div>
                  <div className="bg-purple-50 rounded-lg p-4 text-center">
                    <div className="text-3xl mb-2">âš¡</div>
                    <div className="text-sm font-medium text-neutral-900">Fast</div>
                    <div className="text-xs text-neutral-600">Instant delivery</div>
                  </div>
                </div>

                {/* CTA Button */}
                <div className="text-center mb-6">
                  <button className="bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold px-8 py-3 rounded-lg shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                    Take Action Now â†’
                  </button>
                  <p className="text-xs text-neutral-500 mt-2">Limited time offer â€¢ No credit card required</p>
                </div>

                {/* Social Proof */}
                <div className="bg-neutral-50 rounded-lg p-4 border-l-4 border-green-500">
                  <div className="flex items-start gap-3">
                    <div className="text-2xl">âœ¨</div>
                    <div>
                      <div className="text-sm font-medium text-neutral-900 mb-1">"This changed everything!"</div>
                      <div className="text-xs text-neutral-600">Join {record?.peopleCount || '10,000'}+ satisfied customers</div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Email Footer */}
              <div className="bg-neutral-50 border-t border-neutral-200 px-8 py-6 text-center">
                <div className="flex items-center justify-center gap-4 mb-4">
                  <a href="#" className="w-8 h-8 bg-neutral-200 rounded-full flex items-center justify-center text-neutral-600 hover:bg-blue-500 hover:text-white transition-colors">
                    <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                  </a>
                  <a href="#" className="w-8 h-8 bg-neutral-200 rounded-full flex items-center justify-center text-neutral-600 hover:bg-blue-400 hover:text-white transition-colors">
                    <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>
                  </a>
                  <a href="#" className="w-8 h-8 bg-neutral-200 rounded-full flex items-center justify-center text-neutral-600 hover:bg-pink-500 hover:text-white transition-colors">
                    <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0C8.74 0 8.333.015 7.053.072 5.775.132 4.905.333 4.14.63c-.789.306-1.459.717-2.126 1.384S.935 3.35.63 4.14C.333 4.905.131 5.775.072 7.053.012 8.333 0 8.74 0 12s.015 3.667.072 4.947c.06 1.277.261 2.148.558 2.913.306.788.717 1.459 1.384 2.126.667.666 1.336 1.079 2.126 1.384.766.296 1.636.499 2.913.558C8.333 23.988 8.74 24 12 24s3.667-.015 4.947-.072c1.277-.06 2.148-.262 2.913-.558.788-.306 1.459-.718 2.126-1.384.666-.667 1.079-1.335 1.384-2.126.296-.765.499-1.636.558-2.913.06-1.28.072-1.687.072-4.947s-.015-3.667-.072-4.947c-.06-1.277-.262-2.149-.558-2.913-.306-.789-.718-1.459-1.384-2.126C21.319 1.347 20.651.935 19.86.63c-.765-.297-1.636-.499-2.913-.558C15.667.012 15.26 0 12 0zm0 2.16c3.203 0 3.585.016 4.85.071 1.17.055 1.805.249 2.227.415.562.217.96.477 1.382.896.419.42.679.819.896 1.381.164.422.36 1.057.413 2.227.057 1.266.07 1.646.07 4.85s-.015 3.585-.074 4.85c-.061 1.17-.256 1.805-.421 2.227-.224.562-.479.96-.899 1.382-.419.419-.824.679-1.38.896-.42.164-1.065.36-2.235.413-1.274.057-1.649.07-4.859.07-3.211 0-3.586-.015-4.859-.074-1.171-.061-1.816-.256-2.236-.421-.569-.224-.96-.479-1.379-.899-.421-.419-.69-.824-.9-1.38-.165-.42-.359-1.065-.42-2.235-.045-1.26-.061-1.649-.061-4.844 0-3.196.016-3.586.061-4.861.061-1.17.255-1.814.42-2.234.21-.57.479-.96.9-1.381.419-.419.81-.689 1.379-.898.42-.166 1.051-.361 2.221-.421 1.275-.045 1.65-.06 4.859-.06l.045.03zm0 3.678c-3.405 0-6.162 2.76-6.162 6.162 0 3.405 2.76 6.162 6.162 6.162 3.405 0 6.162-2.76 6.162-6.162 0-3.405-2.76-6.162-6.162-6.162zM12 16c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zm7.846-10.405c0 .795-.646 1.44-1.44 1.44-.795 0-1.44-.646-1.44-1.44 0-.794.646-1.439 1.44-1.439.793-.001 1.44.645 1.44 1.439z"/></svg>
                  </a>
                </div>
                <div className="text-xs text-neutral-500 space-y-1">
                  <p className="font-medium">{record?.company || 'Company Name'}</p>
                  <p>123 Business St, Suite 100, City, State 12345</p>
                  <p className="pt-2">
                    <a href="#" className="text-neutral-400 hover:text-neutral-600 underline">Unsubscribe</a>
                    {' â€¢ '}
                    <a href="#" className="text-neutral-400 hover:text-neutral-600 underline">Update Preferences</a>
                  </p>
                </div>
              </div>
            </div>
          </div>
        );

      case 'email-actions':
        return (
          <div className="flex gap-3">
            <button className="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
              Send Test
            </button>
            <button className="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
              Schedule
            </button>
          </div>
        );

      default:
        console.log('âš ï¸ renderElementContent: NO CASE MATCH for recordType:', recordType, 'elementType:', element.elementType);
        return null;
    }
  };

  // Visualization panel state
  const [visualizationPanelOpen, setVisualizationPanelOpen] = useState(false);
  const [visualizationPanelData, setVisualizationPanelData] = useState(null);

  // Animation state for cards
  const [animatingCards, setAnimatingCards] = useState(new Set());

  const [formFields, setFormFields] = useState([
    { id: 'committee', label: 'Committee', type: 'select-single', required: true, options: ['Technology Advisory Board', 'Standards Committee', 'Education & Outreach', 'Design Excellence Committee', 'Conference Planning', 'Student Outreach', 'Board of Directors', 'Finance Committee', 'Strategic Planning', 'Product Management Forum', 'Certification Committee', 'Cybersecurity Working Group', 'Ethics & Compliance', 'Entrepreneurship Committee', 'Emeritus Advisory Council', 'Mentorship Program'] },
    { id: 'position', label: 'Position', type: 'select-single', required: true, options: ['Chair', 'Co-Chair', 'Vice Chair', 'Board Member', 'Treasurer', 'Secretary', 'Program Chair', 'Lead', 'Member', 'Ambassador', 'Advisor', 'Senior Mentor'] },
    { id: 'startDate', label: 'Start Date', type: 'date', required: true },
    { id: 'endDate', label: 'End Date', type: 'date', required: false },
    { id: 'memo', label: 'Memo', type: 'multiline', required: false, placeholder: 'Add notes about this committee role...' },
  ]);

  const mockRecords = [
    {
      id: 1,
      title: 'Sarah Chen',
      recordType: 'Contact',
      status: 'Active',
      date: '2022-03-15',
      lastUpdated: '2025-11-15T14:30:00',
      priority: 'High',
      owner: 'Member Services',
      type: 'member',
      summary: 'Senior technology leader and board member with expertise in AI/ML and cloud infrastructure. High-value member with strong engagement across events, committees, and mentorship programs.',
      tags: ['Leadership', 'Technology', 'Board Member', 'Mentor', 'VIP'],
      peopleCount: 8,
      activityCount: 124,
      messageCount: 47,
      email: 'sarah.chen@techcorp.com',
      phone: '(555) 123-4567',
      membershipType: 'Professional',
      company: 'TechCorp Industries',
      position: 'Senior Director, Engineering',
      committees: [
        { name: 'Technology Advisory Board', position: 'Chair', startDate: '2022-03-15', endDate: null, memo: 'Leading strategic technology initiatives and setting technical direction for the association.' },
        { name: 'Standards Committee', position: 'Member', startDate: '2022-06-01', endDate: null, memo: '' },
        { name: 'Education & Outreach', position: 'Co-Chair', startDate: '2023-01-10', endDate: null, memo: 'Developing educational programs for professional development and community engagement.' }
      ],
      duesStatus: 'Paid',
      renewalDate: '2025-03-15',
      address: '123 Innovation Way, San Francisco, CA 94105',
      interests: ['AI/ML', 'Cloud Infrastructure', 'Developer Tools', 'Engineering Leadership'],
      volunteerHours: 42,
      eventsAttended: 18,
      bio: 'Technology leader with 15+ years of experience in enterprise software development. Passionate about advancing industry standards and mentoring the next generation of engineers.',
      // CRM-specific Contact fields (HubSpot-inspired)
      contactLifecycleStage: 'Customer',
      contactLeadStatus: 'Qualified',
      contactSource: 'Conference 2022',
      contactCreateDate: '2022-03-15',
      contactLastContactedDate: '2025-11-10',
      contactLastActivityDate: '2025-11-15',
      contactEngagementScore: 87,
      contactSocialProfiles: {
        linkedin: 'linkedin.com/in/sarahchen',
        twitter: '@sarahchen_tech',
        github: 'github.com/sarahchen'
      },
      contactDeals: [
        {
          id: 'DEAL-001',
          name: 'Conference Sponsorship 2025',
          amount: 25000,
          stage: 'Negotiation',
          probability: 75,
          closeDate: '2025-01-15',
          owner: 'Events Team'
        },
        {
          id: 'DEAL-002',
          name: 'Corporate Partnership',
          amount: 50000,
          stage: 'Proposal Sent',
          probability: 50,
          closeDate: '2025-02-28',
          owner: 'Partnerships Team'
        }
      ],
      contactTasks: [
        {
          id: 'TASK-001',
          title: 'Follow up on conference sponsorship',
          dueDate: '2025-11-25',
          priority: 'High',
          status: 'Open',
          assignedTo: 'Jennifer Martinez'
        },
        {
          id: 'TASK-002',
          title: 'Schedule Q1 advisory board meeting',
          dueDate: '2025-12-15',
          priority: 'Medium',
          status: 'Open',
          assignedTo: 'Member Services'
        },
        {
          id: 'TASK-003',
          title: 'Send mentorship program update',
          dueDate: '2025-11-30',
          priority: 'Low',
          status: 'Open',
          assignedTo: 'Education Team'
        }
      ],
      contactNotes: [
        {
          id: 'NOTE-001',
          date: '2025-11-10',
          author: 'Jennifer Martinez',
          note: 'Sarah expressed interest in expanding TechCorp\'s sponsorship to include the certification program. Follow up with detailed proposal by end of month.'
        },
        {
          id: 'NOTE-002',
          date: '2025-10-28',
          author: 'Michael Torres',
          note: 'Excellent feedback on the new mentorship matching platform. Suggested adding skill-based matching criteria. Will incorporate into v2 roadmap.'
        },
        {
          id: 'NOTE-003',
          date: '2025-10-15',
          author: 'David Kim',
          note: 'Spoke at ELEVATE conference. Received outstanding speaker ratings (4.9/5). Potential keynote for 2026.'
        }
      ],
      contactEmails: [
        {
          id: 'EMAIL-001',
          date: '2025-11-15',
          subject: 'Re: Conference Sponsorship Opportunity',
          direction: 'outbound',
          status: 'Sent',
          openedAt: '2025-11-15 14:23:00'
        },
        {
          id: 'EMAIL-002',
          date: '2025-11-10',
          subject: 'Advisory Board: Q4 Meeting Notes',
          direction: 'outbound',
          status: 'Sent',
          openedAt: '2025-11-10 09:15:00'
        },
        {
          id: 'EMAIL-003',
          date: '2025-11-01',
          subject: 'Membership Renewal Reminder',
          direction: 'outbound',
          status: 'Sent',
          openedAt: '2025-11-01 16:42:00'
        }
      ],
      contactMeetings: [
        {
          id: 'MEET-001',
          title: 'Sponsorship Discussion',
          date: '2025-11-10',
          duration: '45 min',
          attendees: ['Sarah Chen', 'Jennifer Martinez', 'Events Team'],
          outcome: 'Positive - moving to proposal stage'
        },
        {
          id: 'MEET-002',
          title: 'Technology Advisory Board Meeting',
          date: '2025-10-15',
          duration: '90 min',
          attendees: ['Board Members', 'Executive Team'],
          outcome: 'Approved Q1 2025 technology roadmap'
        }
      ],
      contactTimeline: [
        {
          date: '2025-11-15',
          type: 'activity',
          icon: 'email',
          title: 'Sent email about conference sponsorship',
          description: 'Opened 2 hours ago'
        },
        {
          date: '2025-11-10',
          type: 'meeting',
          icon: 'calendar',
          title: 'Met with Events Team',
          description: 'Discussed 2025 conference sponsorship opportunities'
        },
        {
          date: '2025-10-28',
          type: 'note',
          icon: 'document',
          title: 'Note added by Michael Torres',
          description: 'Feedback on mentorship platform'
        },
        {
          date: '2025-10-15',
          type: 'event',
          icon: 'star',
          title: 'Spoke at ELEVATE Conference',
          description: 'Keynote: "The Future of AI in Engineering"'
        },
        {
          date: '2025-09-20',
          type: 'activity',
          icon: 'users',
          title: 'Mentored 3 new members',
          description: '1-on-1 sessions on career growth'
        }
      ],
      contactCompanyInfo: {
        name: 'TechCorp Industries',
        industry: 'Technology',
        size: '1,000-5,000 employees',
        revenue: '$500M - $1B',
        website: 'techcorp.com',
        linkedinUrl: 'linkedin.com/company/techcorp'
      },
      contactCustomFields: {
        'Preferred Communication': 'Email',
        'Meeting Preference': 'Virtual',
        'Event Interests': 'AI/ML, Leadership, Design Systems',
        'Mentorship Status': 'Active Mentor',
        'Speaking Opportunities': 'Yes',
        'Media Contact': 'Yes'
      }
    },
    {
      id: 2,
      title: 'ELEVATE 2025: The Future of Innovation',
      recordType: 'Event',
      status: 'Active',
      date: '2025-06-15',
      lastUpdated: '2025-11-16T09:45:00',
      priority: 'High',
      owner: 'Events Team',
      type: 'event',
      summary: 'Three-day immersive conference bringing together 1,200+ innovators, thought leaders, and change-makers to explore the intersection of technology, design, and human experience',
      tags: ['Conference', 'Innovation', 'Technology', 'Design', 'Networking'],
      peopleCount: 1247,
      activityCount: 356,
      messageCount: 128,
      email: 'elevate@association.org',
      phone: '(555) 234-5678',
      membershipType: 'N/A',
      company: 'Professional Association',
      position: 'Event',
      committees: [],
      duesStatus: 'N/A',
      renewalDate: 'N/A',
      address: 'Moscone Center, San Francisco, CA 94103',
      interests: ['AI/ML', 'Design Systems', 'Product Strategy', 'Leadership'],
      volunteerHours: 0,
      eventsAttended: 0,
      bio: 'Join us for three transformative days featuring 50+ keynote speakers, 120 breakout sessions, hands-on workshops, and unparalleled networking opportunities. Experience the future of innovation.',
      // Event-specific fields
      eventType: 'Conference',
      eventDate: 'June 15-17, 2025',
      eventTime: '9:00 AM - 6:00 PM PDT',
      eventLocation: 'Moscone Center, San Francisco, CA',
      eventVenue: 'Moscone Center',
      eventCapacity: 1500,
      eventRegistered: 1247,
      eventTicketPrice: '$599 - $1,299',
      eventEarlyBirdPrice: '$449',
      eventEarlyBirdDeadline: '2025-04-15',
      eventWebsite: 'https://elevate2025.association.org',
      eventHashtag: '#ELEVATE2025',
      eventDescription: 'ELEVATE 2025 is the premier gathering for professionals at the forefront of innovation. This year\'s theme, "The Future of Innovation," explores how emerging technologies, human-centered design, and strategic thinking converge to create meaningful impact.\n\nWhat to Expect:\n\nðŸŽ¤ Keynote Speakers\nHear from industry titans including Dr. Maya Chen (Chief AI Officer, TechCorp), James Morrison (VP of Design, GlobalTech), and Sarah Williams (Innovation Director, FutureLab).\n\nðŸ’¡ Breakout Sessions\n120+ sessions across 8 tracks: AI & Machine Learning, Design Systems, Product Strategy, Leadership, Sustainability, Ethics in Tech, User Research, and Future of Work.\n\nðŸ› ï¸ Hands-On Workshops\nInteractive workshops led by practitioners. Build real projects, learn new tools, and collaborate with peers.\n\nðŸ¤ Networking\nConnect with 1,200+ professionals through structured networking sessions, evening receptions, and our exclusive mobile app.\n\nðŸŽŸï¸ Ticket Options:\nâ€¢ Early Bird (Until April 15): $449\nâ€¢ General Admission: $599  \nâ€¢ VIP Pass: $1,299 (includes workshops, exclusive events, 1-on-1 mentoring)\nâ€¢ Student: $199 (limited availability)',
      eventSpeakers: [
        { name: 'Dr. Maya Chen', title: 'Chief AI Officer', company: 'TechCorp', photo: null, bio: 'Leading AI researcher and practitioner' },
        { name: 'James Morrison', title: 'VP of Design', company: 'GlobalTech', photo: null, bio: 'Design systems expert and author' },
        { name: 'Sarah Williams', title: 'Innovation Director', company: 'FutureLab', photo: null, bio: 'Product strategy thought leader' }
      ],
      eventSchedule: [
        { day: 'Day 1 - June 15', time: '9:00 AM', session: 'Opening Keynote: The Future is Now', speaker: 'Dr. Maya Chen', track: 'Main Stage' },
        { day: 'Day 1 - June 15', time: '11:00 AM', session: 'Breakout Sessions (Track 1-8)', speaker: 'Various', track: 'All Tracks' },
        { day: 'Day 1 - June 15', time: '2:00 PM', session: 'Hands-On Workshops', speaker: 'Workshop Leaders', track: 'Workshop Hall' },
        { day: 'Day 1 - June 15', time: '6:00 PM', session: 'Welcome Reception', speaker: null, track: 'Networking' },
        { day: 'Day 2 - June 16', time: '9:00 AM', session: 'Keynote: Design at Scale', speaker: 'James Morrison', track: 'Main Stage' },
        { day: 'Day 2 - June 16', time: '11:00 AM', session: 'Breakout Sessions (Track 1-8)', speaker: 'Various', track: 'All Tracks' },
        { day: 'Day 2 - June 16', time: '6:00 PM', session: 'Networking Dinner', speaker: null, track: 'Networking' },
        { day: 'Day 3 - June 17', time: '9:00 AM', session: 'Keynote: Leading Innovation', speaker: 'Sarah Williams', track: 'Main Stage' },
        { day: 'Day 3 - June 17', time: '11:00 AM', session: 'Final Breakout Sessions', speaker: 'Various', track: 'All Tracks' },
        { day: 'Day 3 - June 17', time: '4:00 PM', session: 'Closing Ceremony & Awards', speaker: 'All', track: 'Main Stage' }
      ],
      eventTracks: ['AI & Machine Learning', 'Design Systems', 'Product Strategy', 'Leadership', 'Sustainability', 'Ethics in Tech', 'User Research', 'Future of Work'],
      eventTestimonials: [
        { name: 'Jennifer Lee', title: 'Senior Product Manager', company: 'InnovateCo', quote: 'ELEVATE changed how I think about product strategy. The connections I made were invaluable.' },
        { name: 'Michael Torres', title: 'Design Director', company: 'CreativeStudio', quote: 'Best conference I\'ve attended in 10 years. The workshops were incredibly practical and immediately applicable.' }
      ],
      eventSponsors: ['TechCorp', 'GlobalTech', 'FutureLab', 'DesignTools Inc', 'InnovateNow'],
      eventRegistrationUrl: 'https://elevate2025.association.org/register',
      eventCancellationPolicy: 'Full refund until May 15, 2025. 50% refund until June 1, 2025.'
    },
    {
      id: 15,
      title: 'Adobe Summit 2025: The Digital Experience Conference',
      recordType: 'Event',
      status: 'Active',
      date: '2025-03-25',
      lastUpdated: '2025-11-21T10:30:00',
      priority: 'High',
      owner: 'Events Team',
      type: 'event',
      summary: 'The world\'s largest digital experience conference. Join 10,000+ marketers, advertisers, and experience makers for innovation, inspiration, and insights that will shape the future of customer experience.',
      tags: ['Conference', 'Digital Marketing', 'Adobe', 'Enterprise', 'CX', 'Innovation'],
      peopleCount: 10247,
      activityCount: 892,
      messageCount: 423,
      email: 'summit@adobe.com',
      phone: '(800) 833-6687',
      membershipType: 'N/A',
      company: 'Adobe Inc.',
      position: 'Event',
      committees: [],
      duesStatus: 'N/A',
      renewalDate: 'N/A',
      address: 'The Venetian Resort, Las Vegas, NV 89109',
      interests: ['Digital Marketing', 'Analytics', 'Commerce', 'AI', 'Personalization', 'Content'],
      volunteerHours: 0,
      eventsAttended: 0,
      bio: 'Adobe Summit brings together the brightest minds in digital experience to share insights, best practices, and the latest innovations. Discover how leading brands are using AI, data, and creativity to deliver exceptional customer experiences at scale.',
      // Event-specific fields
      eventType: 'Enterprise Conference',
      eventDate: 'March 25-27, 2025',
      eventTime: '8:00 AM - 7:00 PM PST',
      eventLocation: 'The Venetian Resort, Las Vegas, NV',
      eventVenue: 'The Venetian Resort & Convention Center',
      eventCapacity: 12000,
      eventRegistered: 10247,
      eventTicketPrice: '$1,695 - $2,495',
      eventEarlyBirdPrice: '$1,495',
      eventEarlyBirdDeadline: '2025-01-31',
      eventWebsite: 'https://summit.adobe.com',
      eventHashtag: '#AdobeSummit',
      eventDescription: 'Adobe Summit 2025 is where the future of digital experience comes to life. This year\'s theme focuses on AI-powered personalization, real-time customer intelligence, and seamless omnichannel experiences.\n\nðŸŽ¯ What Makes Summit Unmissable:\n\nðŸš€ AI & Innovation\nExperience the latest Adobe innovations including AI-powered analytics, generative content creation, and predictive customer insights. Get hands-on with Adobe Firefly, Sensei GenAI, and Real-Time CDP.\n\nðŸŽ¤ World-Class Speakers\nHear from CMOs, digital leaders, and celebrity speakers who are transforming customer experience. Past speakers include Satya Nadella, Serena Williams, and top marketing executives from Fortune 500 companies.\n\nðŸ“Š 200+ Sessions Across 12 Tracks\nâ€¢ Marketing Analytics & Insights\nâ€¢ Commerce & B2B\nâ€¢ Content & Assets\nâ€¢ Customer Journey Management\nâ€¢ Data Management & Privacy\nâ€¢ Personalization at Scale\nâ€¢ Creative & Design\nâ€¢ Emerging Technologies\nâ€¢ Leadership & Strategy\nâ€¢ Developer & Technical\nâ€¢ Industry Solutions\nâ€¢ Partner Ecosystem\n\nðŸ› ï¸ Immersive Labs & Certification\n40+ hands-on labs led by Adobe experts. Earn certifications in Adobe Experience Cloud, Analytics, Target, and Campaign.\n\nðŸ¤ Networking & Community\nConnect with 10,000+ peers through:\nâ€¢ Industry-specific networking sessions\nâ€¢ Partner pavilion with 100+ solution providers\nâ€¢ Exclusive customer appreciation events\nâ€¢ Community meetups and user groups\n\nðŸŽ‰ Sneaks & Innovation Showcase\nWitness the famous Adobe Sneaks - experimental projects that could become tomorrow\'s features. Vote for your favorite innovations.\n\nðŸŽŸï¸ Pass Types:\nâ€¢ Summit Pass: $1,695 (Full access to sessions, expo, and networking)\nâ€¢ Summit Plus Pass: $2,495 (Includes labs, certification, VIP events, and exclusive workshops)\nâ€¢ Team Discount: 20% off for groups of 5+\nâ€¢ Virtual Pass: $395 (Live-streamed keynotes and select sessions)\n\nðŸ’Ž VIP Experience Includes:\nâ€¢ Priority seating at keynotes\nâ€¢ Exclusive networking reception with speakers\nâ€¢ 1-on-1 strategy sessions with Adobe consultants\nâ€¢ Premium swag and gifts\nâ€¢ Access to executive lounges',
      eventSpeakers: [
        {
          name: 'Shantanu Narayen',
          title: 'Chairman & CEO',
          company: 'Adobe',
          photo: null,
          bio: 'Leading Adobe\'s transformation into the world\'s leading digital experience company'
        },
        {
          name: 'Anil Chakravarthy',
          title: 'President, Digital Experience Business',
          company: 'Adobe',
          photo: null,
          bio: 'Driving innovation in customer experience management and marketing technology'
        },
        {
          name: 'Dr. Genevieve Bell',
          title: 'Distinguished Professor & Director',
          company: 'Australian National University',
          photo: null,
          bio: 'Renowned anthropologist and AI ethics expert'
        },
        {
          name: 'Marc Benioff',
          title: 'Chair & CEO',
          company: 'Salesforce',
          photo: null,
          bio: 'Visionary leader in cloud computing and customer success'
        },
        {
          name: 'Tiffany Haddish',
          title: 'Comedian & Actress',
          company: 'Entertainment',
          photo: null,
          bio: 'Emmy and Grammy award-winning performer and entrepreneur'
        }
      ],
      eventSchedule: [
        {
          day: 'Day 1 - March 25',
          time: '8:30 AM',
          session: 'Opening Keynote: The Future of Experience',
          speaker: 'Shantanu Narayen',
          track: 'Main Stage'
        },
        {
          day: 'Day 1 - March 25',
          time: '11:00 AM',
          session: 'Innovation Showcase & Adobe Sneaks Preview',
          speaker: 'Adobe Innovation Team',
          track: 'Main Stage'
        },
        {
          day: 'Day 1 - March 25',
          time: '1:00 PM',
          session: 'Breakout Sessions (12 Tracks)',
          speaker: 'Various Industry Experts',
          track: 'All Tracks'
        },
        {
          day: 'Day 1 - March 25',
          time: '3:00 PM',
          session: 'Hands-On Labs & Certifications',
          speaker: 'Adobe Solution Consultants',
          track: 'Lab Hall'
        },
        {
          day: 'Day 1 - March 25',
          time: '6:00 PM',
          session: 'Welcome Reception & Expo Opening',
          speaker: null,
          track: 'Expo Hall'
        },
        {
          day: 'Day 2 - March 26',
          time: '8:30 AM',
          session: 'Keynote: AI-Powered Personalization at Scale',
          speaker: 'Anil Chakravarthy',
          track: 'Main Stage'
        },
        {
          day: 'Day 2 - March 26',
          time: '10:30 AM',
          session: 'Customer Success Stories',
          speaker: 'Fortune 500 CMOs',
          track: 'Main Stage'
        },
        {
          day: 'Day 2 - March 26',
          time: '1:00 PM',
          session: 'Advanced Breakout Sessions',
          speaker: 'Product Experts',
          track: 'All Tracks'
        },
        {
          day: 'Day 2 - March 26',
          time: '3:30 PM',
          session: 'Industry Roundtables (Retail, Finance, Healthcare, Tech)',
          speaker: 'Industry Leaders',
          track: 'Networking Lounges'
        },
        {
          day: 'Day 2 - March 26',
          time: '7:00 PM',
          session: 'Customer Appreciation Concert',
          speaker: 'Special Musical Guest',
          track: 'Entertainment'
        },
        {
          day: 'Day 3 - March 27',
          time: '9:00 AM',
          session: 'Fireside Chat: The Ethics of AI',
          speaker: 'Dr. Genevieve Bell & Marc Benioff',
          track: 'Main Stage'
        },
        {
          day: 'Day 3 - March 27',
          time: '11:00 AM',
          session: 'Partner Showcase & Solution Demos',
          speaker: 'Adobe Partners',
          track: 'Expo Hall'
        },
        {
          day: 'Day 3 - March 27',
          time: '2:00 PM',
          session: 'Final Breakout Sessions & Office Hours',
          speaker: 'Adobe Experts',
          track: 'All Tracks'
        },
        {
          day: 'Day 3 - March 27',
          time: '4:00 PM',
          session: 'Adobe Sneaks Finals & Closing Keynote',
          speaker: 'Tiffany Haddish',
          track: 'Main Stage'
        },
        {
          day: 'Day 3 - March 27',
          time: '5:30 PM',
          session: 'Closing Party & Awards Ceremony',
          speaker: null,
          track: 'Main Stage'
        }
      ],
      eventTracks: [
        'Marketing Analytics & Insights',
        'Commerce & B2B',
        'Content & Assets',
        'Customer Journey Management',
        'Data Management & Privacy',
        'Personalization at Scale',
        'Creative & Design',
        'Emerging Technologies',
        'Leadership & Strategy',
        'Developer & Technical',
        'Industry Solutions',
        'Partner Ecosystem'
      ],
      eventTestimonials: [
        {
          name: 'Sarah Martinez',
          title: 'VP of Marketing',
          company: 'RetailCorp',
          quote: 'Adobe Summit completely transformed our approach to customer experience. We implemented learnings immediately and saw 40% improvement in engagement within 3 months.'
        },
        {
          name: 'David Kim',
          title: 'Chief Digital Officer',
          company: 'FinanceNow',
          quote: 'The depth of technical content combined with strategic insights is unmatched. Summit is the one conference our entire digital team attends every year.'
        },
        {
          name: 'Emily Rodriguez',
          title: 'Director of Analytics',
          company: 'HealthTech Solutions',
          quote: 'The hands-on labs provided practical skills I use daily. Getting certified at Summit elevated my career and our organization\'s capabilities.'
        }
      ],
      eventSponsors: [
        'Adobe',
        'Accenture',
        'Deloitte Digital',
        'Publicis Sapient',
        'Cognizant',
        'HCL Technologies',
        'Merkle',
        'WPP',
        'Salesforce',
        'Microsoft',
        'Google Cloud',
        'AWS'
      ],
      eventRegistrationUrl: 'https://summit.adobe.com/na/register',
      eventCancellationPolicy: 'Full refund available until February 25, 2025. 50% refund until March 10, 2025. No refunds after March 10, 2025. All registrations are transferable.',
      eventFormat: 'Hybrid (In-person + Virtual)',
      eventCECredits: '18 Continuing Education Credits available',
      eventMobileApp: 'Adobe Summit App (iOS & Android) - Personalized agenda, networking, live Q&A',
      eventDressCode: 'Business Casual',
      eventHotelBlock: 'Discounted rooms at The Venetian, Palazzo, and nearby hotels. Book by February 15 for best rates.',
      eventTransportation: 'Complimentary shuttle service between partner hotels and venue. McCarran Airport is 10 minutes away.',
      eventAccessibility: 'Full ADA compliance. Sign language interpreters, closed captioning, and accessibility services available upon request.',
      eventSustainability: 'Carbon-neutral event. Digital-first materials, zero-waste catering, and sustainability initiatives throughout.',
      eventNetworking: 'AI-powered matchmaking app, industry-specific lounges, 1-on-1 meeting scheduler, community hub',
      eventExpo: '100+ solution partners, interactive demos, innovation showcase, partner theater sessions',
      eventCertifications: [
        'Adobe Certified Expert - Analytics',
        'Adobe Certified Expert - Target',
        'Adobe Certified Expert - Campaign',
        'Adobe Certified Professional - Experience Platform'
      ],
      eventLabs: [
        'Real-Time Customer Data Platform Deep Dive',
        'Journey Orchestration Masterclass',
        'Analytics Workspace Advanced Techniques',
        'Adobe Target Personalization Workshop',
        'Content Velocity with Adobe Firefly',
        'Commerce Cloud Implementation',
        'Customer Journey Analytics',
        'Adobe Experience Manager Sites'
      ],
      price: 1695,
      location: 'Las Vegas, NV',
      jobType: null,
      salary: null
    },
    {
      id: 3,
      title: 'The Ethical Imperative: Navigating AI in Professional Practice',
      recordType: 'Article',
      status: 'Active',
      date: '2024-11-01',
      lastUpdated: '2025-11-14T16:20:00',
      priority: 'High',
      owner: 'Content Team',
      type: 'content',
      summary: 'A comprehensive exploration of ethical frameworks, practical guidelines, and real-world case studies for professionals integrating AI into their practice',
      tags: ['AI', 'Ethics', 'Best Practices', 'Guidelines', 'Featured'],
      peopleCount: 3,
      activityCount: 2847,
      messageCount: 156,
      email: 'content@association.org',
      phone: 'N/A',
      membershipType: 'N/A',
      company: 'Professional Association',
      position: 'Content',
      committees: [],
      duesStatus: 'N/A',
      renewalDate: 'N/A',
      address: 'N/A',
      interests: ['AI/ML', 'Ethics', 'Standards', 'Professional Practice'],
      volunteerHours: 0,
      eventsAttended: 0,
      bio: 'This in-depth article examines the critical ethical considerations professionals must address when implementing AI systems, featuring insights from leading ethicists, practitioners, and policymakers.',
      // Article-specific fields
      articleAuthor: 'Dr. Rebecca Martinez',
      articleAuthorTitle: 'Chair, Ethics Committee',
      articleAuthorBio: 'Dr. Rebecca Martinez is an ethics researcher, policy advisor, and practicing technologist with over 20 years of experience at the intersection of technology and society. She chairs the association\'s Ethics Committee and has advised governments and Fortune 500 companies on responsible AI implementation.',
      articleAuthorPhoto: null,
      articlePublishDate: 'November 1, 2024',
      articleReadTime: '18 min read',
      articleCategory: 'Ethics & Policy',
      articleFeaturedImage: null,
      articleExcerpt: 'As artificial intelligence becomes increasingly embedded in professional practice, the ethical implications of our choices have never been more consequential. This article provides a comprehensive framework for navigating the complex ethical landscape of AI implementation.',
      articleContent: `As artificial intelligence becomes increasingly embedded in professional practice, the ethical implications of our choices have never been more consequential. From algorithmic bias to privacy concerns, from transparency challenges to questions of accountability, professionals face a maze of ethical decisions that will shape not just their careers, but the future of our society.

## The Stakes Have Never Been Higher

In 2023 alone, we witnessed AI systems denying healthcare coverage, perpetuating hiring discrimination, and making life-altering decisions about creditworthiness and criminal justice. Each of these failures traces back to human choicesâ€”choices made by professionals like us. The question is no longer whether we should be concerned about AI ethics, but how we can build ethical considerations into every stage of our work.

"We are the generation that will either build the guardrails for responsible AI, or we will be remembered for our failure to do so," says Dr. James Chen, a leading AI ethicist and former tech executive. "The decisions we make today will echo for decades."

## A Framework for Ethical AI Implementation

### 1. Bias and Fairness

The first and perhaps most critical consideration is bias. AI systems learn from data, and if that data reflects historical biasesâ€”whether in hiring, lending, healthcare, or criminal justiceâ€”the AI will perpetuate and potentially amplify those biases.

**Key Questions to Ask:**
- What data are we using to train this system?
- Whose perspectives are represented? Whose are missing?
- How might this system perform differently across demographic groups?
- What mechanisms do we have to detect and correct bias?

Consider the case of a major tech company whose hiring AI, trained on historical data, systematically downgraded resumes from women. The system had learned to replicate past biases, not predict future performance. The company ultimately scrapped the system, but not before it had influenced thousands of hiring decisions.

### 2. Transparency and Explainability

Black box AI systemsâ€”those whose decision-making processes are opaque even to their creatorsâ€”pose fundamental challenges to accountability and trust. In high-stakes domains like healthcare, finance, and criminal justice, the ability to explain and justify decisions is not just ethically important; it's often legally required.

"If you can't explain why the AI made a particular decision, you can't defend it, improve it, or even know if it's working correctly," notes Sarah Williams, Chief AI Officer at a leading healthcare system. "Explainability isn't a nice-to-have. It's essential."

**Best Practices:**
- Document model architecture, training data, and decision criteria
- Implement interpretability tools that can explain individual predictions
- Create clear channels for challenging AI decisions
- Maintain human oversight for consequential decisions

### 3. Privacy and Data Protection

AI systems are voracious consumers of data. The more data they have, the better they can perform. But this creates inherent tension with privacy rights and data protection obligations. Professionals must navigate complex regulatory frameworks like GDPR, CCPA, and HIPAA while still delivering value through AI.

The principle of data minimizationâ€”collecting only what you need, keeping it only as long as necessaryâ€”is particularly important. So is informed consent. Users should understand what data is being collected, how it will be used, and what decisions might be influenced by it.

### 4. Accountability and Oversight

When an AI system makes a mistake, who is responsible? The developer? The company? The professional who deployed it? The data scientist who trained it? Clear lines of accountability are essential for ethical AI implementation.

This means establishing robust governance frameworks, including:
- Regular audits of AI system performance and impact
- Clear escalation paths for concerns or errors
- Diverse oversight committees with technical and non-technical members
- Mechanisms for affected parties to seek redress

## Real-World Applications

### Healthcare: The Double-Edged Sword

AI has tremendous potential to improve healthcare outcomes, from early disease detection to personalized treatment plans. But it also raises profound ethical questions.

A recent study found that an algorithm widely used in healthcare to identify patients needing extra care systematically underestimated the needs of Black patients. The algorithm used healthcare spending as a proxy for health needs, but Black patients historically receive less careâ€”not because they need less, but because of systemic barriers to access.

This case illustrates how seemingly neutral technical choices can embed and perpetuate injustice. The solution required not just technical fixes, but a fundamental rethinking of what the algorithm was optimizing for.

### Financial Services: Balancing Innovation and Protection

In financial services, AI promises more accurate risk assessment and fraud detection. But it also risks creating new forms of discrimination and excluding vulnerable populations from financial services.

One bank found that its AI-powered loan approval system was more likely to approve loans for applicants from certain zip codesâ€”a modern form of redlining. The system had learned to use geography as a proxy for risk, but in doing so, it perpetuated historical patterns of discrimination.

### Criminal Justice: High Stakes, Higher Risks

Perhaps nowhere are the stakes higher than in criminal justice, where AI systems increasingly influence decisions about bail, sentencing, and parole. These systems promise to reduce human bias and inconsistency, but research shows they often amplify existing disparities.

A ProPublica investigation found that a widely used risk assessment tool was significantly more likely to incorrectly flag Black defendants as high-risk compared to white defendants. The human cost of these errors is immeasurable.

## Moving Forward: A Call to Action

Ethical AI implementation is not a one-time checklist. It's an ongoing commitment that requires vigilance, humility, and a willingness to prioritize ethics over convenience or profit.

**Five Commitments for Ethical AI Practice:**

1. **Educate Continuously**: The field of AI ethics is evolving rapidly. Commit to ongoing education.

2. **Diversify Teams**: Diverse perspectives aren't just nice to haveâ€”they're essential for identifying ethical risks.

3. **Build in Accountability**: Establish clear governance structures and accountability mechanisms from the start.

4. **Prioritize Transparency**: Document decisions, maintain model cards, and be honest about limitations.

5. **Center Affected Communities**: The people most affected by AI systems should have a voice in their design and deployment.

## Conclusion

The integration of AI into professional practice is inevitable. How we do itâ€”whether we prioritize ethics alongside innovation, whether we center the needs of vulnerable populations, whether we build systems that promote justice or perpetuate biasâ€”is up to us.

The ethical imperative is clear: We must build AI systems that reflect our highest values, not our historical biases. We must be transparent about how these systems work and accountable when they fail. And we must ensure that the benefits of AI are broadly shared, not concentrated among the already privileged.

The future of AI in professional practice depends on the choices we make today. Let's make them count.`,
      articleReferences: [
        'Chen, J. (2024). "Algorithmic Justice in the Age of AI." Journal of Ethics & Technology, 45(2), 112-145.',
        'Williams, S. & Martinez, R. (2023). "Transparency and Explainability in Healthcare AI." New England Journal of Medical AI, 15(4), 234-256.',
        'ProPublica Investigative Report (2023). "Machine Bias in Criminal Risk Assessment Tools."',
        'Stanford AI Ethics Institute (2024). "Best Practices for Responsible AI Development."'
      ],
      articleRelatedArticles: [
        { id: 301, title: 'Building Diverse AI Teams', category: 'Leadership' },
        { id: 302, title: 'GDPR Compliance for AI Systems', category: 'Compliance' },
        { id: 303, title: 'Case Studies in AI Ethics', category: 'Ethics' }
      ],
      articleShareCount: 1247,
      articleViewCount: 8934,
      articleCommentsCount: 156
    },
    {
      id: 4,
      title: 'Design Systems Certification: From Foundations to Enterprise Scale',
      recordType: 'Course',
      status: 'Active',
      date: '2023-03-10',
      lastUpdated: '2025-11-10T11:30:00',
      priority: 'High',
      owner: 'Education Team',
      type: 'course',
      summary: 'Master the art and science of design systems in this comprehensive 12-week certification program. Learn from industry experts, build real-world projects, and join a global community of design systems practitioners.',
      tags: ['Certification', 'Design Systems', 'Online Learning', 'Career Development'],
      peopleCount: 847,
      activityCount: 1245,
      messageCount: 423,
      email: 'education@association.org',
      phone: '(555) 456-7890',
      membershipType: 'N/A',
      company: 'Professional Association',
      position: 'Education',
      committees: [],
      duesStatus: 'N/A',
      renewalDate: 'N/A',
      address: 'Online',
      interests: ['Design Systems', 'Component Libraries', 'Scalable Design', 'Design Tokens'],
      volunteerHours: 0,
      eventsAttended: 0,
      bio: 'Transform your design and development workflow with a comprehensive understanding of design systems. This industry-recognized certification program combines theory, practice, and real-world case studies to prepare you for the evolving demands of modern product design.',
      // Course-specific fields
      courseInstructor: 'Nathan Chen',
      courseInstructorTitle: 'Design Systems Lead, TechCorp',
      courseInstructorBio: 'Nathan Chen is a design systems architect with 12 years of experience building and scaling design systems at companies like Airbnb, Dropbox, and TechCorp. He\'s the author of "Design Systems at Scale" and a frequent speaker at design conferences worldwide.',
      courseInstructorPhoto: null,
      courseLevel: 'Intermediate to Advanced',
      courseDuration: '12 weeks',
      courseEffort: '6-8 hours per week',
      courseFormat: 'Online, Self-paced with Live Sessions',
      coursePrice: '$1,299',
      courseMemberPrice: '$999',
      courseStartDate: 'January 13, 2025',
      courseEndDate: 'April 7, 2025',
      courseEnrollmentDeadline: 'January 10, 2025',
      courseEnrolled: 847,
      courseCapacity: 1000,
      courseRating: 4.8,
      courseReviews: 342,
      courseCertificate: 'Certified Design Systems Professional (CDSP)',
      coursePrerequisites: 'Familiarity with design tools (Figma, Sketch, or Adobe XD) and basic understanding of HTML/CSS. Experience with component-based frameworks (React, Vue) is helpful but not required.',
      courseDescription: `## What You'll Learn

This comprehensive certification program takes you from design systems fundamentals to enterprise-scale implementation. You'll learn the frameworks, tools, and methodologies used by leading design teams worldwide.

### Module 1: Foundations (Weeks 1-2)
- Design systems principles and philosophy
- Atomic design methodology
- Design tokens and theming
- Documentation strategies

### Module 2: Component Architecture (Weeks 3-5)
- Building scalable component libraries
- Component API design
- Accessibility best practices (WCAG 2.1)
- Cross-platform considerations

### Module 3: Implementation & Integration (Weeks 6-8)
- Design-to-code workflows
- Version control for design systems
- Figma, Storybook, and modern tooling
- Design token pipelines

### Module 4: Governance & Scale (Weeks 9-10)
- Team structures and contribution models
- Adoption strategies and evangelism
- Measuring design system success
- Enterprise case studies

### Module 5: Capstone Project (Weeks 11-12)
- Build a complete design system for a real-world scenario
- Peer review and feedback
- Present to industry experts
- Portfolio-ready deliverable

## What's Included

âœ… **60+ video lessons** (12-20 minutes each)
âœ… **12 live Q&A sessions** with Nathan Chen
âœ… **Hands-on projects** with expert feedback
âœ… **Design system starter kit** (Figma & React)
âœ… **Private Slack community** for networking
âœ… **Guest speakers** from Airbnb, Shopify, GitHub
âœ… **Certificate of completion** (CDSP credential)
âœ… **Lifetime access** to course materials

## Learning Outcomes

By the end of this course, you'll be able to:

â€¢ Design and document scalable component systems
â€¢ Implement design token architectures
â€¢ Build accessible, inclusive components
â€¢ Establish governance and contribution workflows
â€¢ Measure and communicate design system impact
â€¢ Lead design system initiatives at your organization

## Who Should Enroll

This course is perfect for:
- Product Designers wanting to specialize in systems
- Frontend Developers building component libraries
- Design Managers leading design system initiatives
- UX Engineers bridging design and code

## Student Success Stories

"This course transformed my career. Within 3 months of graduating, I became our team's design systems lead and got a 20% raise."
â€” Jennifer Park, Product Designer at InnovateCo

"Nathan's teaching style is incredibly clear. The capstone project is now the centerpiece of my portfolio."
â€” Marcus Williams, UX Engineer at DesignTech`,
      courseCurriculum: [
        { module: 1, title: 'Foundations', lessons: 8, duration: '2 weeks', topics: ['Design Tokens', 'Atomic Design', 'Documentation'] },
        { module: 2, title: 'Component Architecture', lessons: 12, duration: '3 weeks', topics: ['Component API', 'Accessibility', 'Cross-platform'] },
        { module: 3, title: 'Implementation & Integration', lessons: 12, duration: '3 weeks', topics: ['Figma', 'Storybook', 'Token Pipelines'] },
        { module: 4, title: 'Governance & Scale', lessons: 8, duration: '2 weeks', topics: ['Team Models', 'Adoption', 'Metrics'] },
        { module: 5, title: 'Capstone Project', lessons: 4, duration: '2 weeks', topics: ['Real-world Project', 'Peer Review', 'Presentation'] }
      ],
      courseInstructorTeam: [
        { name: 'Nathan Chen', role: 'Lead Instructor', company: 'TechCorp' },
        { name: 'Sarah Martinez', role: 'Guest Instructor', company: 'Airbnb' },
        { name: 'David Kim', role: 'Guest Instructor', company: 'Shopify' }
      ],
      courseTestimonials: [
        { name: 'Jennifer Park', title: 'Product Designer', company: 'InnovateCo', quote: 'This course transformed my career. Within 3 months of graduating, I became our team\'s design systems lead.', rating: 5 },
        { name: 'Marcus Williams', title: 'UX Engineer', company: 'DesignTech', quote: 'Nathan\'s teaching style is incredibly clear. The capstone project is now the centerpiece of my portfolio.', rating: 5 },
        { name: 'Lisa Chen', title: 'Design Manager', company: 'StartupCo', quote: 'Best investment in my professional development. I use what I learned every single day.', rating: 5 }
      ],
      courseFAQ: [
        { q: 'Do I need coding experience?', a: 'Basic HTML/CSS knowledge is helpful but not required. We provide resources for designers new to code.' },
        { q: 'How much time should I dedicate?', a: 'Plan for 6-8 hours per week: 3-4 hours for lessons, 3-4 hours for projects and practice.' },
        { q: 'Is the certificate recognized by employers?', a: 'Yes, the CDSP credential is recognized across the industry and valued by companies like Google, Meta, and Amazon.' },
        { q: 'What if I fall behind?', a: 'You have lifetime access to all materials and can progress at your own pace. Live sessions are recorded.' }
      ],
      courseRefundPolicy: 'Full refund within 14 days of enrollment, no questions asked.'
    },
    {
      id: 5,
      title: 'Professional Toolkit: Premium Resource Library',
      recordType: 'Product',
      status: 'Active',
      date: '2025-01-08',
      lastUpdated: '2025-11-12T14:15:00',
      priority: 'Medium',
      owner: 'Product Team',
      type: 'catalog',
      summary: 'The complete digital toolkit for modern professionals. 200+ templates, frameworks, and resources curated by industry experts. Lifetime access with quarterly updates.',
      tags: ['Templates', 'Resources', 'Frameworks', 'Digital Product', 'Bestseller'],
      peopleCount: 2847,
      activityCount: 456,
      messageCount: 234,
      email: 'products@association.org',
      phone: '(555) 567-8901',
      membershipType: 'N/A',
      company: 'Professional Association',
      position: 'Product',
      committees: [],
      duesStatus: 'N/A',
      renewalDate: 'N/A',
      address: 'Digital Download',
      interests: ['Templates', 'Frameworks', 'Professional Tools'],
      volunteerHours: 0,
      eventsAttended: 0,
      bio: 'Everything you need to accelerate your professional practice. From strategy frameworks to presentation templates, research methodologies to project plansâ€”all the tools used by leading practitioners.',
      // Product-specific fields
      productSKU: 'PROF-TOOLKIT-2025',
      productPrice: 299.00,
      productSalePrice: null,
      productMemberPrice: 199.00,
      productCategory: 'Digital Resources',
      productType: 'Digital Download',
      productRating: 4.9,
      productReviews: 847,
      productPurchases: 2847,
      productInventory: 'Unlimited (Digital)',
      productTags: ['Templates', 'Frameworks', 'Bestseller', 'New'],
      productImages: [
        { id: 1, url: null, alt: 'Professional Toolkit Cover', primary: true },
        { id: 2, url: null, alt: 'Template Preview 1' },
        { id: 3, url: null, alt: 'Template Preview 2' },
        { id: 4, url: null, alt: 'Framework Preview' }
      ],
      productDescription: `## Transform Your Professional Practice

The Professional Toolkit is the comprehensive resource library trusted by over 2,800 practitioners worldwide. Whether you're launching a new initiative, pitching stakeholders, or conducting research, you'll have expert-curated templates and frameworks at your fingertips.

### What's Included

**ðŸ“Š Strategy & Planning (45 templates)**
- Business model canvas
- Strategy workshop templates
- Roadmap frameworks
- OKR templates
- Stakeholder mapping tools

**ðŸ“ˆ Presentations & Pitch Decks (60 templates)**
- Investor pitch decks
- Executive presentations
- Workshop slide decks
- All templates available in Keynote, PowerPoint, and Google Slides

**ðŸ” Research & Discovery (35 frameworks)**
- User research plans
- Interview guides
- Survey templates
- Synthesis frameworks
- Research report templates

**ðŸ“‹ Project Management (40 templates)**
- Project briefs
- Sprint planning docs
- Retrospective frameworks
- Status report templates
- Team charters

**ðŸ’¼ Professional Documents (20 templates)**
- Proposal templates
- Statement of work (SOW)
- Contract templates
- Budget trackers
- Invoice templates

### Why Practitioners Love It

â­ï¸ **4.9/5 rating** from 847 reviews

"This toolkit has saved me countless hours. The strategy templates alone are worth 10x the price."
â€” Jennifer Martinez, Strategy Consultant

"Finally, professional-grade templates that don't look like they're from 2010. The presentation decks are stunning."
â€” Michael Chen, Product Leader

"I use something from this toolkit literally every single week. Best professional investment I've made."
â€” Sarah Williams, Design Director

### Features

âœ… **200+ premium templates** across all major categories
âœ… **Multiple file formats** (Sketch, Figma, Adobe, Office, Google)
âœ… **Lifetime access** to all current and future resources
âœ… **Quarterly updates** with new templates added regularly
âœ… **Commercial license** included for client work
âœ… **Private community** for template requests and support
âœ… **Video tutorials** showing how to use each framework

### Perfect For

- Consultants and freelancers
- Product managers and designers
- Strategy and innovation teams
- Entrepreneurs and founders
- Anyone who wants to work smarter

### What You Get

**Instant download** includes:
- Complete template library (2.4 GB)
- Video tutorial library (12 hours)
- Private community access
- Commercial use license
- Lifetime updates

### Lifetime Updates Guarantee

Buy once, benefit forever. We add 10-15 new templates every quarter based on community requests. All updates included free.

### Money-Back Guarantee

Not satisfied? Get a full refund within 30 days, no questions asked.`,
      productFeatures: [
        '200+ premium templates and frameworks',
        'Multiple file formats (Figma, Sketch, Adobe, Office)',
        'Lifetime access with quarterly updates',
        'Commercial license for client work',
        'Private community access',
        '12 hours of video tutorials',
        '30-day money-back guarantee'
      ],
      productSpecifications: {
        'File Size': '2.4 GB',
        'File Formats': 'Figma, Sketch, Adobe XD, PowerPoint, Keynote, Google Slides, PDF',
        'License': 'Commercial use allowed',
        'Updates': 'Lifetime (quarterly)',
        'Support': 'Email + Private Community',
        'Requirements': 'Modern design or office software'
      },
      productReviewsData: [
        { name: 'Jennifer Martinez', title: 'Strategy Consultant', rating: 5, date: '2024-11-05', review: 'This toolkit has saved me countless hours. The strategy templates alone are worth 10x the price. Highly recommend!' },
        { name: 'Michael Chen', title: 'Product Leader', rating: 5, date: '2024-10-28', review: 'Finally, professional-grade templates that don\'t look like they\'re from 2010. The presentation decks are stunning.' },
        { name: 'Sarah Williams', title: 'Design Director', rating: 5, date: '2024-10-15', review: 'I use something from this toolkit literally every single week. Best professional investment I\'ve made.' },
        { name: 'David Kim', title: 'Freelance Designer', rating: 5, date: '2024-09-20', review: 'The Figma templates are exceptional. Clear, well-organized, and easy to customize.' }
      ],
      productFAQ: [
        { q: 'What file formats are included?', a: 'Templates are provided in Figma, Sketch, Adobe XD, PowerPoint, Keynote, Google Slides, and PDF formats where applicable.' },
        { q: 'Can I use these for client work?', a: 'Yes! The commercial license allows you to use all templates for client projects.' },
        { q: 'Do I get updates?', a: 'Yes, lifetime access includes all future updates and new templates added quarterly.' },
        { q: 'Is there a refund policy?', a: 'Absolutely. 30-day money-back guarantee, no questions asked.' }
      ],
      productRelated: [
        { id: 501, title: 'Advanced Strategy Framework Pack', price: 149 },
        { id: 502, title: 'Executive Presentation Bundle', price: 99 },
        { id: 503, title: 'Research Toolkit Pro', price: 129 }
      ],
      productStock: 'In Stock',
      productShipping: 'Digital Download - Instant Access',
      productReturnPolicy: '30-day money-back guarantee'
    },
    {
      id: 6,
      title: 'Order #2024-11-15-3247',
      recordType: 'Order',
      status: 'Completed',
      date: '2024-11-15',
      lastUpdated: '2024-11-22T10:00:00',
      priority: 'Medium',
      owner: 'Commerce Team',
      type: 'commerce',
      summary: 'Conference registration and workshop bundle for Sarah Chen',
      tags: ['Conference', 'Registration', 'Payment Received', 'Fulfilled'],
      peopleCount: 1,
      activityCount: 8,
      messageCount: 4,
      email: 'orders@association.org',
      phone: '(555) 678-9012',
      membershipType: 'N/A',
      company: 'Professional Association',
      position: 'Order',
      committees: [],
      duesStatus: 'Paid',
      renewalDate: 'N/A',
      address: '123 Innovation Way, San Francisco, CA 94105',
      interests: [],
      volunteerHours: 0,
      eventsAttended: 0,
      bio: 'Conference registration including early-bird pricing, two workshop sessions, and networking reception access. Total: $599.00',
      // Order-specific fields
      orderNumber: '2024-11-15-3247',
      orderDate: '2024-11-15',
      orderPlacedTime: '2024-11-15 10:23:00 AM EST',
      orderStatus: 'Delivered',
      orderTracking: {
        carrier: 'FedEx',
        trackingNumber: 'FDX-789456123',
        estimatedDelivery: '2024-11-22',
        actualDelivery: '2024-11-22',
        trackingUrl: 'https://fedex.com/track/FDX-789456123'
      },
      orderTimeline: [
        { date: '2024-11-15', time: '10:23 AM', status: 'Order Placed', description: 'Your order has been confirmed', complete: true },
        { date: '2024-11-15', time: '11:45 AM', status: 'Payment Confirmed', description: 'Payment processed successfully', complete: true },
        { date: '2024-11-15', time: '02:30 PM', status: 'Order Confirmed', description: 'Registration and materials confirmed', complete: true },
        { date: '2024-11-15', time: '03:15 PM', status: 'Confirmation Sent', description: 'Confirmation email sent to sarah.chen@techcorp.com', complete: true },
        { date: '2024-11-22', time: '09:00 AM', status: 'Fulfilled', description: 'Registration complete, materials sent', complete: true }
      ],
      customerName: 'Sarah Chen',
      customerEmail: 'sarah.chen@techcorp.com',
      customerPhone: '(555) 123-4567',
      billingAddress: {
        street: '123 Innovation Way',
        city: 'San Francisco',
        state: 'CA',
        zip: '94105',
        country: 'United States'
      },
      lineItems: [
        {
          id: 1,
          name: '2025 Annual Conference - Early Bird Registration',
          description: 'Full access to 3-day conference including keynotes, breakout sessions, and exhibition hall',
          quantity: 1,
          unitPrice: 399.00,
          discount: 0,
          tax: 0,
          total: 399.00
        },
        {
          id: 2,
          name: 'Workshop: Advanced AI Implementation',
          description: 'Half-day workshop on practical AI implementation strategies',
          quantity: 1,
          unitPrice: 150.00,
          discount: 0,
          tax: 0,
          total: 150.00
        },
        {
          id: 3,
          name: 'Workshop: Leadership in Tech',
          description: 'Interactive workshop on effective technical leadership',
          quantity: 1,
          unitPrice: 150.00,
          discount: 0,
          tax: 0,
          total: 150.00
        },
        {
          id: 4,
          name: 'Networking Reception Ticket',
          description: 'Access to exclusive evening networking reception',
          quantity: 1,
          unitPrice: 50.00,
          discount: 50.00,
          tax: 0,
          total: 0.00
        }
      ],
      subtotal: 699.00,
      discountTotal: 50.00,
      taxTotal: 0.00,
      shippingTotal: 0.00,
      total: 649.00,
      paymentMethod: 'Credit Card',
      paymentStatus: 'Paid',
      paymentDate: '2024-11-15',
      transactionId: 'ch_3Q8KLM2eZvKYlo2C0abc1234',
      notes: 'Early bird discount applied. Complimentary networking reception included with workshop bundle.',
      fulfillmentStatus: 'Fulfilled',
      fulfillmentDate: '2024-11-15'
    },
    {
      id: 7,
      title: 'Membership Renewal: Your Impact Continues',
      recordType: 'Email Campaign',
      status: 'Active',
      date: '2025-11-05',
      lastUpdated: '2025-11-17T08:30:00',
      priority: 'High',
      owner: 'Communications Team',
      type: 'communication',
      summary: 'Strategic renewal campaign highlighting member value, community impact, and seamless renewal process with personalized benefits summary',
      tags: ['Renewal', 'Email', 'Membership', 'Conversion', 'Transactional'],
      peopleCount: 4523,
      activityCount: 892,
      messageCount: 145,
      email: 'communications@association.org',
      phone: 'N/A',
      membershipType: 'N/A',
      company: 'Professional Association',
      position: 'Communication',
      committees: [],
      duesStatus: 'N/A',
      renewalDate: 'N/A',
      address: 'N/A',
      interests: ['Communications', 'Member Engagement', 'Retention'],
      volunteerHours: 0,
      eventsAttended: 0,
      bio: 'Conversion-optimized renewal email combining emotional storytelling, data-driven value proposition, and frictionless CTA to drive membership renewals.',
      // Email Campaign-specific fields
      emailCampaignType: 'Transactional',
      emailSubject: 'Sarah, renew your membership and continue making an impact',
      emailPreheader: 'Your membership expires in 30 days. Renew now to keep your benefits active.',
      emailFrom: 'Professional Association <membership@association.org>',
      emailReplyTo: 'membership@association.org',
      emailSendDate: '2025-12-01 09:00 AM EST',
      emailRecipients: 4523,
      emailSegment: 'Members expiring in 30 days',
      emailOpenRate: 42.3,
      emailClickRate: 18.7,
      emailConversionRate: 12.4,
      emailStatus: 'Scheduled',
      emailTemplate: 'renewal-2025',
      emailPersonalization: ['First Name', 'Membership Level', 'Join Date', 'Benefits Used', 'Renewal Price'],
      emailContent: `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Renew Your Membership</title>
</head>
<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f5f5f7;">

  <!-- Container -->
  <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f5f5f7; padding: 40px 20px;">
    <tr>
      <td align="center">

        <!-- Email Content (600px width) -->
        <table width="600" cellpadding="0" cellspacing="0" style="background-color: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">

          <!-- Header -->
          <tr>
            <td style="padding: 40px 40px 20px; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
              <h1 style="margin: 0; color: #ffffff; font-size: 28px; font-weight: 600; letter-spacing: -0.5px;">Professional Association</h1>
            </td>
          </tr>

          <!-- Hero Image Placeholder -->
          <tr>
            <td style="padding: 0;">
              <div style="width: 100%; height: 240px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center;">
                <div style="color: #ffffff; text-align: center; padding: 40px;">
                  <div style="font-size: 48px; margin-bottom: 12px;">ðŸŒŸ</div>
                  <div style="font-size: 24px; font-weight: 600;">Your Impact Continues</div>
                </div>
              </div>
            </td>
          </tr>

          <!-- Main Content -->
          <tr>
            <td style="padding: 40px;">

              <!-- Greeting -->
              <p style="margin: 0 0 24px; font-size: 18px; color: #1d1d1f; font-weight: 600;">Hi Sarah,</p>

              <!-- Body Text -->
              <p style="margin: 0 0 20px; font-size: 16px; line-height: 1.6; color: #424245;">
                Your membership has been at the heart of everything we've accomplished together this year. From the knowledge you've gained to the connections you've made, your participation makes our community stronger.
              </p>

              <p style="margin: 0 0 20px; font-size: 16px; line-height: 1.6; color: #424245;">
                <strong style="color: #1d1d1f;">Your membership expires in 30 days.</strong> Renew today to continue enjoying all the benefits you love.
              </p>

              <!-- Stats Box -->
              <table width="100%" cellpadding="0" cellspacing="0" style="margin: 32px 0; background-color: #f5f5f7; border-radius: 12px; padding: 24px;">
                <tr>
                  <td>
                    <p style="margin: 0 0 16px; font-size: 14px; font-weight: 600; color: #86868b; text-transform: uppercase; letter-spacing: 0.5px;">Your 2024 Impact</p>

                    <table width="100%" cellpadding="0" cellspacing="0">
                      <tr>
                        <td width="33%" style="padding-right: 16px;">
                          <div style="font-size: 32px; font-weight: 700; color: #1d1d1f; margin-bottom: 4px;">18</div>
                          <div style="font-size: 13px; color: #86868b;">Events Attended</div>
                        </td>
                        <td width="33%" style="padding: 0 16px;">
                          <div style="font-size: 32px; font-weight: 700; color: #1d1d1f; margin-bottom: 4px;">42</div>
                          <div style="font-size: 13px; color: #86868b;">Volunteer Hours</div>
                        </td>
                        <td width="33%" style="padding-left: 16px;">
                          <div style="font-size: 32px; font-weight: 700; color: #1d1d1f; margin-bottom: 4px;">3</div>
                          <div style="font-size: 13px; color: #86868b;">Committees</div>
                        </td>
                      </tr>
                    </table>
                  </td>
                </tr>
              </table>

              <!-- Benefits List -->
              <p style="margin: 32px 0 16px; font-size: 16px; font-weight: 600; color: #1d1d1f;">Continue Your Benefits:</p>

              <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom: 32px;">
                <tr>
                  <td style="padding: 12px 0;">
                    <span style="color: #34c759; font-size: 18px; margin-right: 12px;">âœ“</span>
                    <span style="font-size: 15px; color: #424245;">Access to exclusive events and workshops</span>
                  </td>
                </tr>
                <tr>
                  <td style="padding: 12px 0;">
                    <span style="color: #34c759; font-size: 18px; margin-right: 12px;">âœ“</span>
                    <span style="font-size: 15px; color: #424245;">Premium resource library and templates</span>
                  </td>
                </tr>
                <tr>
                  <td style="padding: 12px 0;">
                    <span style="color: #34c759; font-size: 18px; margin-right: 12px;">âœ“</span>
                    <span style="font-size: 15px; color: #424245;">Networking with 5,000+ professionals</span>
                  </td>
                </tr>
                <tr>
                  <td style="padding: 12px 0;">
                    <span style="color: #34c759; font-size: 18px; margin-right: 12px;">âœ“</span>
                    <span style="font-size: 15px; color: #424245;">Professional certification programs</span>
                  </td>
                </tr>
              </table>

              <!-- CTA Button -->
              <table width="100%" cellpadding="0" cellspacing="0" style="margin: 32px 0;">
                <tr>
                  <td align="center">
                    <a href="#" style="display: inline-block; padding: 16px 48px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #ffffff; text-decoration: none; border-radius: 8px; font-size: 17px; font-weight: 600; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);">
                      Renew Now for $299
                    </a>
                  </td>
                </tr>
              </table>

              <!-- Pricing Details -->
              <p style="margin: 24px 0 32px; font-size: 14px; line-height: 1.6; color: #86868b; text-align: center;">
                Professional Membership: $299/year<br>
                <strong style="color: #34c759;">Save $100 with early renewal</strong>
              </p>

              <!-- Divider -->
              <div style="height: 1px; background-color: #e5e5e7; margin: 32px 0;"></div>

              <!-- Footer Message -->
              <p style="margin: 0 0 16px; font-size: 14px; line-height: 1.6; color: #424245;">
                Questions about your membership? We're here to help.
              </p>

              <p style="margin: 0; font-size: 14px; line-height: 1.6; color: #86868b;">
                Email us at <a href="mailto:membership@association.org" style="color: #667eea; text-decoration: none;">membership@association.org</a> or call (555) 123-4567
              </p>

            </td>
          </tr>

          <!-- Footer -->
          <tr>
            <td style="padding: 32px 40px; background-color: #f5f5f7; border-top: 1px solid #e5e5e7;">
              <p style="margin: 0 0 12px; font-size: 12px; color: #86868b; text-align: center;">
                Professional Association<br>
                123 Main Street, Suite 100, San Francisco, CA 94105
              </p>
              <p style="margin: 0; font-size: 12px; color: #86868b; text-align: center;">
                <a href="#" style="color: #86868b; text-decoration: none; margin: 0 8px;">Unsubscribe</a> â€¢
                <a href="#" style="color: #86868b; text-decoration: none; margin: 0 8px;">Preferences</a> â€¢
                <a href="#" style="color: #86868b; text-decoration: none; margin: 0 8px;">Privacy Policy</a>
              </p>
            </td>
          </tr>

        </table>

      </td>
    </tr>
  </table>

</body>
</html>`,
      emailPlainText: `Hi Sarah,

Your membership has been at the heart of everything we've accomplished together this year. From the knowledge you've gained to the connections you've made, your participation makes our community stronger.

Your membership expires in 30 days. Renew today to continue enjoying all the benefits you love.

YOUR 2024 IMPACT
- 18 Events Attended
- 42 Volunteer Hours
- 3 Committees

CONTINUE YOUR BENEFITS:
âœ“ Access to exclusive events and workshops
âœ“ Premium resource library and templates
âœ“ Networking with 5,000+ professionals
âœ“ Professional certification programs

RENEW NOW FOR $299
https://association.org/renew

Professional Membership: $299/year
Save $100 with early renewal

Questions? Email us at membership@association.org or call (555) 123-4567

---
Professional Association
123 Main Street, Suite 100, San Francisco, CA 94105

Unsubscribe: https://association.org/unsubscribe
`,
      emailTestimonial: null,
      emailABTest: false,
      emailVariantA: null,
      emailVariantB: null
    },
    {
      id: 8,
      title: 'Q4 2024 Member Engagement Analytics',
      recordType: 'Dashboard',
      status: 'Active',
      date: '2025-02-20',
      lastUpdated: '2025-11-20T07:15:00',
      priority: 'High',
      owner: 'Analytics Team',
      type: 'dashboard',
      summary: 'Executive dashboard providing real-time insights into member engagement, retention, revenue, and program performance with interactive data visualizations and trend analysis',
      tags: ['Analytics', 'KPIs', 'Executive', 'Real-time', 'Member Insights'],
      peopleCount: 24,
      activityCount: 1247,
      messageCount: 89,
      email: 'analytics@association.org',
      phone: 'N/A',
      membershipType: 'N/A',
      company: 'Professional Association',
      position: 'Dashboard',
      committees: [],
      duesStatus: 'N/A',
      renewalDate: 'N/A',
      address: 'N/A',
      interests: ['Analytics', 'Metrics', 'Engagement', 'Revenue', 'Trends'],
      volunteerHours: 0,
      eventsAttended: 0,
      bio: 'Comprehensive analytics dashboard tracking key organizational metrics across membership, events, revenue, and engagement. Data updates in real-time to provide leadership with actionable insights.',
      // Dashboard-specific fields
      dashboardType: 'Executive Analytics',
      dashboardPeriod: 'Q4 2024 (Oct 1 - Dec 31)',
      dashboardLastUpdated: '2025-11-20 07:15:00 AM EST',
      dashboardRefreshRate: 'Real-time (every 5 minutes)',
      dashboardOwner: 'Analytics Team',
      dashboardAccess: 'Executive Team, Board Members',
      dashboardMetrics: [
        {
          category: 'Membership',
          kpis: [
            { name: 'Total Members', value: 5247, change: 8.4, trend: 'up', target: 5000 },
            { name: 'New Members (Q4)', value: 423, change: 12.3, trend: 'up', target: 400 },
            { name: 'Retention Rate', value: 91.2, change: 2.1, trend: 'up', target: 90, unit: '%' },
            { name: 'Churn Rate', value: 8.8, change: -1.8, trend: 'down', target: 10, unit: '%' },
            { name: 'Member LTV', value: 3420, change: 5.2, trend: 'up', target: 3200, unit: '$' }
          ]
        },
        {
          category: 'Engagement',
          kpis: [
            { name: 'Event Attendance', value: 2847, change: 15.6, trend: 'up', target: 2500 },
            { name: 'Avg Events/Member', value: 4.2, change: 8.1, trend: 'up', target: 4.0 },
            { name: 'Email Open Rate', value: 38.4, change: 3.2, trend: 'up', target: 35, unit: '%' },
            { name: 'Community Activity', value: 1523, change: 22.4, trend: 'up', target: 1200 },
            { name: 'Resource Downloads', value: 8942, change: 18.7, trend: 'up', target: 8000 }
          ]
        },
        {
          category: 'Revenue',
          kpis: [
            { name: 'Total Revenue (Q4)', value: 1847000, change: 14.2, trend: 'up', target: 1650000, unit: '$' },
            { name: 'Membership Dues', value: 1247000, change: 9.4, trend: 'up', target: 1200000, unit: '$' },
            { name: 'Event Revenue', value: 423000, change: 28.6, trend: 'up', target: 350000, unit: '$' },
            { name: 'Product Sales', value: 177000, change: 15.3, trend: 'up', target: 150000, unit: '$' },
            { name: 'ARPU', value: 352, change: 5.8, trend: 'up', target: 340, unit: '$' }
          ]
        },
        {
          category: 'Programs',
          kpis: [
            { name: 'Events Hosted', value: 47, change: 17.5, trend: 'up', target: 40 },
            { name: 'Courses Completed', value: 234, change: 12.0, trend: 'up', target: 220 },
            { name: 'Certifications Issued', value: 156, change: 8.3, trend: 'up', target: 150 },
            { name: 'Volunteer Hours', value: 2847, change: 10.2, trend: 'up', target: 2500 },
            { name: 'Committee Members', value: 342, change: 6.5, trend: 'up', target: 325 }
          ]
        }
      ],
      dashboardCharts: [
        {
          type: 'line',
          title: 'Membership Growth Trend',
          description: '12-month member count with projection',
          dataPoints: [
            { month: 'Dec 2023', value: 4523 },
            { month: 'Jan 2024', value: 4612 },
            { month: 'Feb 2024', value: 4689 },
            { month: 'Mar 2024', value: 4756 },
            { month: 'Apr 2024', value: 4834 },
            { month: 'May 2024', value: 4901 },
            { month: 'Jun 2024', value: 4978 },
            { month: 'Jul 2024', value: 5045 },
            { month: 'Aug 2024', value: 5089 },
            { month: 'Sep 2024', value: 5134 },
            { month: 'Oct 2024', value: 5178 },
            { month: 'Nov 2024', value: 5247 }
          ]
        },
        {
          type: 'bar',
          title: 'Revenue by Source (Q4)',
          description: 'Quarterly revenue breakdown',
          dataPoints: [
            { category: 'Membership Dues', value: 1247000 },
            { category: 'Events', value: 423000 },
            { category: 'Products', value: 177000 },
            { category: 'Sponsorships', value: 89000 },
            { category: 'Other', value: 11000 }
          ]
        },
        {
          type: 'pie',
          title: 'Member Engagement Distribution',
          description: 'Members by engagement level',
          dataPoints: [
            { category: 'Highly Engaged (5+ activities)', value: 1247, percentage: 23.8 },
            { category: 'Engaged (2-4 activities)', value: 2356, percentage: 44.9 },
            { category: 'Moderately Engaged (1 activity)', value: 1123, percentage: 21.4 },
            { category: 'Low Engagement', value: 521, percentage: 9.9 }
          ]
        },
        {
          type: 'heatmap',
          title: 'Event Attendance by Month',
          description: 'Monthly event participation trends',
          data: 'Interactive heatmap showing attendance patterns'
        }
      ],
      dashboardInsights: [
        {
          type: 'success',
          title: 'Strong Q4 Performance',
          description: 'Revenue exceeded target by 12%, driven by record event attendance and product sales.',
          priority: 'high'
        },
        {
          type: 'info',
          title: 'Engagement Trend',
          description: 'Member engagement up 18% YoY. Community activity and resource downloads showing strong growth.',
          priority: 'medium'
        },
        {
          type: 'warning',
          title: 'Renewal Focus Needed',
          description: '847 members up for renewal in next 30 days. Launch renewal campaign to maintain retention rate.',
          priority: 'high'
        },
        {
          type: 'info',
          title: 'Program Success',
          description: 'Certification program exceeded enrollment targets by 24%. Consider expanding capacity for 2025.',
          priority: 'medium'
        }
      ],
      dashboardFilters: [
        { name: 'Date Range', options: ['Last 7 Days', 'Last 30 Days', 'Q4 2024', 'YTD', 'Custom'] },
        { name: 'Member Type', options: ['All', 'Professional', 'Student', 'Academic', 'Corporate'] },
        { name: 'Region', options: ['All', 'North America', 'Europe', 'Asia Pacific', 'Other'] },
        { name: 'Engagement Level', options: ['All', 'High', 'Medium', 'Low'] }
      ],
      dashboardExports: ['PDF Report', 'Excel', 'CSV', 'PowerPoint'],
      dashboardSubscribers: [
        { name: 'Executive Team', frequency: 'Daily' },
        { name: 'Board Members', frequency: 'Weekly' },
        { name: 'Department Heads', frequency: 'Monthly' }
      ]
    },
    // Portfolio/Project Record
    {
      id: 9,
      title: 'Meridian Health App: Redesign Case Study',
      recordType: 'Portfolio',
      status: 'Published',
      date: '2024-09-15',
      lastUpdated: '2025-11-18T10:30:00',
      priority: 'High',
      owner: 'Design Team',
      type: 'portfolio',
      summary: 'Comprehensive redesign of a health tracking mobile app, increasing user engagement by 240% and achieving 4.8 App Store rating',
      tags: ['Mobile App', 'Healthcare', 'Case Study', 'Featured', 'Award Winner'],
      peopleCount: 8,
      activityCount: 2456,
      messageCount: 145,
      email: 'design@association.org',
      phone: 'N/A',
      membershipType: 'N/A',
      company: 'Design Studio',
      position: 'Portfolio',
      committees: [],
      duesStatus: 'N/A',
      renewalDate: 'N/A',
      address: 'N/A',
      interests: ['Mobile Design', 'Healthcare', 'UX Research'],
      volunteerHours: 0,
      eventsAttended: 0,
      bio: 'A transformative redesign project that modernized a legacy health tracking app, focusing on accessibility, personalization, and delightful user experience.',
      // Portfolio-specific fields
      portfolioClient: 'Meridian Health',
      portfolioRole: 'Lead Product Designer',
      portfolioTeam: ['Sarah Martinez (Lead Designer)', 'David Chen (UX Researcher)', 'Lisa Park (UI Designer)', 'Michael Torres (iOS Developer)', 'Jennifer Kim (Android Developer)'],
      portfolioTimeline: 'September 2023 - March 2024 (6 months)',
      portfolioCategory: 'Mobile App Design',
      portfolioServices: ['UX Research', 'UI Design', 'Prototyping', 'Usability Testing', 'Design System'],
      portfolioTools: ['Figma', 'Maze', 'UserTesting', 'Dovetail', 'Principle'],
      portfolioAwards: ['2024 Design Excellence Award', 'Best Healthcare App - UX Awards 2024'],
      portfolioFeaturedImage: null,
      portfolioImages: [
        { id: 1, caption: 'App screens showing before/after comparison', type: 'hero' },
        { id: 2, caption: 'User journey map and research synthesis', type: 'process' },
        { id: 3, caption: 'Design system components', type: 'detail' },
        { id: 4, caption: 'Usability testing sessions', type: 'process' },
        { id: 5, caption: 'Final app in context on devices', type: 'hero' }
      ],
      portfolioChallenge: `Meridian Health's mobile app, launched in 2018, was struggling with low user engagement and poor ratings (2.3 stars). Despite having a loyal user base, retention was declining rapidly. The app felt dated, difficult to navigate, and failed to compete with newer health tracking apps.

**Key Problems Identified:**
â€¢ Confusing navigation with features buried 4-5 levels deep
â€¢ Overwhelming data displays with poor visual hierarchy
â€¢ No personalization or onboarding experience
â€¢ Accessibility issues (WCAG 2.1 AA failures)
â€¢ Inconsistent design patterns creating cognitive load`,
      portfolioSolution: `We took a comprehensive, user-centered approach to reimagine the app from the ground up while respecting the existing user base.

**Research & Discovery (6 weeks)**
- Interviewed 45 current users to understand pain points
- Analyzed 2,000+ App Store reviews and support tickets
- Conducted competitive analysis of 12 health tracking apps
- Created detailed user personas and journey maps
- Performed accessibility audit

**Design Strategy (4 weeks)**
- Simplified information architecture from 5 levels to 2-3 max
- Designed personalized onboarding flow based on health goals
- Created modular design system for consistency
- Prioritized data visualization and insight generation
- Ensured WCAG 2.1 AAA compliance

**Execution (12 weeks)**
- Iterative prototyping with weekly user testing
- Built comprehensive design system in Figma
- Close collaboration with development team
- Continuous usability testing with 60+ users
- Beta testing program with 1,000 users`,
      portfolioResults: [
        { metric: 'User Engagement', before: '12%', after: '41%', change: '+240%', description: 'Daily active users increased dramatically' },
        { metric: 'App Store Rating', before: '2.3 â­', after: '4.8 â­', change: '+109%', description: 'From poor to excellent ratings' },
        { metric: 'Retention (30-day)', before: '18%', after: '68%', change: '+278%', description: 'Users sticking with the app' },
        { metric: 'Task Completion', before: '42%', after: '89%', change: '+112%', description: 'Users successfully completing goals' },
        { metric: 'Accessibility Score', before: '48/100', after: '98/100', change: '+104%', description: 'WCAG 2.1 AAA compliant' }
      ],
      portfolioTestimonial: {
        quote: 'This redesign didn\'t just improve our appâ€”it transformed our entire business. User engagement and retention numbers we never thought possible. The design team\'s research-driven approach gave us confidence at every decision point.',
        author: 'Rachel Morrison',
        title: 'VP of Product, Meridian Health',
        photo: null
      },
      portfolioLessonsLearned: [
        'Deep user research is non-negotiable. We almost pursued the wrong direction based on stakeholder assumptions before research corrected course.',
        'Accessibility isn\'t a constraintâ€”it\'s a design catalyst. Making the app work for everyone made it better for all users.',
        'Incremental user testing prevented expensive mistakes. Weekly testing sessions caught issues that would have been costly post-launch.',
        'Design systems pay dividends. The 2 weeks invested in building our system saved 6+ weeks in execution and handoff.'
      ],
      portfolioLinks: {
        liveApp: 'https://apps.apple.com/us/app/meridian-health',
        caseStudy: 'https://designstudio.com/work/meridian-health',
        prototype: null
      },
      portfolioViewCount: 8934,
      portfolioLikeCount: 847,
      portfolioShareCount: 234
    },
    // Invoice Record
    {
      id: 10,
      title: 'Invoice #INV-2024-11247',
      recordType: 'Invoice',
      status: 'Paid',
      date: '2024-11-01',
      lastUpdated: '2024-11-15T14:30:00',
      priority: 'Medium',
      owner: 'Finance Team',
      type: 'invoice',
      summary: 'Professional services invoice for Q4 2024 strategic consulting engagement',
      tags: ['Paid', 'Consulting', 'Q4 2024', 'Strategic Services'],
      peopleCount: 2,
      activityCount: 8,
      messageCount: 4,
      email: 'finance@association.org',
      phone: '(555) 234-5678',
      membershipType: 'N/A',
      company: 'Professional Association',
      position: 'Invoice',
      committees: [],
      duesStatus: 'N/A',
      renewalDate: 'N/A',
      address: 'N/A',
      interests: [],
      volunteerHours: 0,
      eventsAttended: 0,
      bio: 'Professional services invoice for strategic consulting, market research, and advisory services delivered in Q4 2024.',
      // Invoice-specific fields
      invoiceNumber: 'INV-2024-11247',
      invoiceDate: '2024-11-01',
      invoiceDueDate: '2024-12-01',
      invoicePaidDate: '2024-11-15',
      invoiceStatus: 'Paid',
      invoiceType: 'Professional Services',
      invoicePaymentTerms: 'Net 30',
      invoicePaymentMethod: 'ACH Transfer',
      invoiceReference: 'PO #24-CS-4521',
      invoiceBillTo: {
        name: 'TechCorp Industries',
        contact: 'Sarah Chen, Senior Director',
        address: '123 Innovation Way',
        city: 'San Francisco',
        state: 'CA',
        zip: '94105',
        country: 'United States',
        email: 'ap@techcorp.com',
        phone: '(555) 123-4567'
      },
      invoiceBillFrom: {
        name: 'Professional Association',
        address: '456 Main Street, Suite 200',
        city: 'Chicago',
        state: 'IL',
        zip: '60601',
        country: 'United States',
        email: 'billing@association.org',
        phone: '(555) 987-6543',
        taxId: '12-3456789'
      },
      invoiceLineItems: [
        {
          id: 1,
          description: 'Strategic Consulting Services',
          details: '40 hours @ $250/hour - Q4 strategic planning, market analysis, and executive advisory',
          quantity: 40,
          unit: 'hours',
          rate: 250.00,
          amount: 10000.00
        },
        {
          id: 2,
          description: 'Market Research & Analysis',
          details: 'Comprehensive competitive analysis and member survey project',
          quantity: 1,
          unit: 'project',
          rate: 8500.00,
          amount: 8500.00
        },
        {
          id: 3,
          description: 'Workshop Facilitation',
          details: '2-day executive strategy workshop (Oct 15-16, 2024)',
          quantity: 2,
          unit: 'days',
          rate: 3500.00,
          amount: 7000.00
        },
        {
          id: 4,
          description: 'Advisory Board Services',
          details: 'Monthly advisory board participation and strategic guidance (Oct-Nov)',
          quantity: 2,
          unit: 'months',
          rate: 2500.00,
          amount: 5000.00
        }
      ],
      invoiceSubtotal: 30500.00,
      invoiceDiscount: 0.00,
      invoiceDiscountNote: null,
      invoiceTax: 0.00,
      invoiceTaxNote: 'Tax-exempt organization',
      invoiceTotal: 30500.00,
      invoiceAmountPaid: 30500.00,
      invoiceBalance: 0.00,
      invoiceNotes: 'Thank you for your business. Payment received via ACH transfer on November 15, 2024.\n\nProject deliverables:\nâ€¢ Q4 Strategic Plan (delivered Oct 30)\nâ€¢ Market Research Report (delivered Nov 15)\nâ€¢ Workshop materials and recordings\nâ€¢ Monthly advisory session notes',
      invoicePaymentInstructions: 'ACH Transfer:\nBank: First National Bank\nAccount: 123456789\nRouting: 987654321\n\nCheck Payment:\nProfessional Association\n456 Main Street, Suite 200\nChicago, IL 60601',
      invoiceTransactions: [
        {
          id: 'TXN-001',
          date: '2024-11-15',
          type: 'Payment',
          method: 'ACH Transfer',
          amount: 30500.00,
          reference: 'ACH-20241115-4521',
          status: 'Cleared'
        }
      ],
      invoiceAttachments: [
        { name: 'Strategic_Plan_Q4_2024.pdf', size: '2.4 MB', type: 'PDF' },
        { name: 'Market_Research_Report.pdf', size: '5.1 MB', type: 'PDF' },
        { name: 'Workshop_Materials.zip', size: '12.3 MB', type: 'ZIP' }
      ]
    },
    // Job Posting Record
    {
      id: 11,
      title: 'Senior Product Designer - Design Systems',
      recordType: 'Job',
      status: 'Active',
      date: '2024-10-15',
      lastUpdated: '2025-11-18T09:00:00',
      priority: 'High',
      owner: 'Talent Team',
      type: 'job',
      summary: 'Lead our design systems initiative, creating scalable, accessible component libraries used by 50+ product teams across the organization',
      tags: ['Design', 'Full-time', 'Remote', 'Senior Level', 'Hot Job'],
      peopleCount: 147,
      activityCount: 423,
      messageCount: 89,
      email: 'jobs@association.org',
      phone: '(555) 345-6789',
      membershipType: 'N/A',
      company: 'Professional Association',
      position: 'Job Posting',
      committees: [],
      duesStatus: 'N/A',
      renewalDate: 'N/A',
      address: 'Remote (US)',
      interests: ['Design Systems', 'Product Design', 'Component Libraries'],
      volunteerHours: 0,
      eventsAttended: 0,
      bio: 'Join our design team and help build the design system that powers experiences for millions of users. This is a high-impact role working at the intersection of design and engineering.',
      // Job-specific fields
      jobTitle: 'Senior Product Designer - Design Systems',
      jobDepartment: 'Product Design',
      jobLocation: 'Remote (United States)',
      jobType: 'Full-time',
      jobLevel: 'Senior',
      jobSalaryRange: '$140,000 - $180,000',
      jobEquity: 'Yes, competitive equity package',
      jobRemote: 'Fully Remote',
      jobPostedDate: '2024-10-15',
      jobApplicationDeadline: '2025-01-15',
      jobApplications: 147,
      jobViews: 2847,
      jobDescription: `## About the Role

We're looking for a Senior Product Designer to lead our design systems initiativeâ€”one of the most strategic projects in our organization. You'll create the component libraries, patterns, and guidelines that empower 50+ product teams to build consistent, accessible experiences for millions of users.

This isn't just about making pretty components. You'll be solving complex systems-level challenges, establishing design standards, and building the infrastructure that accelerates our entire product org.

## What You'll Do

**Design Systems Leadership**
â€¢ Own the end-to-end design systems roadmap and strategy
â€¢ Design and document component libraries in Figma
â€¢ Create comprehensive usage guidelines and best practices
â€¢ Partner with engineering to build production-ready components
â€¢ Establish governance and contribution models

**Cross-functional Collaboration**
â€¢ Work closely with 10+ product designers and 20+ engineers
â€¢ Conduct workshops and training sessions on system adoption
â€¢ Gather feedback and iterate based on team needs
â€¢ Partner with accessibility team to ensure WCAG 2.1 AAA compliance

**Strategic Impact**
â€¢ Define component API standards and patterns
â€¢ Create design tokens and theming architecture
â€¢ Build tools and processes that scale across teams
â€¢ Measure and communicate design system impact

## What We're Looking For

**Must-Haves**
â€¢ 6+ years of product design experience
â€¢ 2+ years building or maintaining design systems
â€¢ Expert-level Figma skills (variables, components, libraries)
â€¢ Strong understanding of HTML/CSS and component frameworks
â€¢ Portfolio demonstrating systems thinking and scalable solutions
â€¢ Excellent communication and documentation skills

**Nice-to-Haves**
â€¢ Experience with React, Vue, or similar frameworks
â€¢ Accessibility expertise and WCAG compliance
â€¢ Experience with design tokens and Style Dictionary
â€¢ Background in frontend development
â€¢ Open source design systems contributions

**Soft Skills**
â€¢ Systems thinker who sees the big picture
â€¢ Collaborative team player who loves pairing
â€¢ Patient educator who can teach and inspire
â€¢ Detail-oriented with high quality standards
â€¢ Comfortable with ambiguity and rapid iteration

## Why Join Us

**Impact**
â€¢ Your work will touch millions of users
â€¢ High-visibility role with executive exposure
â€¢ Shape the future of design at our company

**Growth**
â€¢ Learn from world-class designers and engineers
â€¢ Conference budget and learning stipend
â€¢ Career path to Principal/Staff Designer

**Culture**
â€¢ Fully remote with team offsites 2x/year
â€¢ Flexible hours and unlimited PTO
â€¢ Strong emphasis on work-life balance
â€¢ Inclusive, diverse, mission-driven team

**Compensation & Benefits**
â€¢ $140,000 - $180,000 base salary
â€¢ Competitive equity package
â€¢ Full health/dental/vision insurance
â€¢ 401(k) matching (4%)
â€¢ $2,000/year learning budget
â€¢ $1,000 home office setup
â€¢ 16 weeks parental leave

## Our Process

We believe in a fair, transparent hiring process:

1. **Application Review** (1 week) - We review all applications
2. **Phone Screen** (30 min) - Chat with recruiter about the role
3. **Portfolio Review** (60 min) - Deep dive into your work with hiring manager
4. **Design Challenge** (take-home, 3-4 hours) - Real-world systems problem
5. **Team Interviews** (3 hours) - Meet designers, engineers, and leadership
6. **Offer** ðŸŽ‰

Timeline: 3-4 weeks from application to offer

## How to Apply

Send us:
â€¢ Your resume
â€¢ Portfolio (Figma, website, or PDF)
â€¢ Brief cover letter (why this role excites you)

We're especially interested in seeing:
â€¢ Design systems work (component libraries, documentation)
â€¢ Examples of systems thinking and scalable solutions
â€¢ Cross-functional collaboration
â€¢ Before/after impact stories`,
      jobRequirements: [
        '6+ years of product design experience',
        '2+ years building or maintaining design systems',
        'Expert-level Figma skills',
        'Strong understanding of HTML/CSS',
        'Portfolio demonstrating systems thinking',
        'Excellent communication skills'
      ],
      jobResponsibilities: [
        'Own the design systems roadmap and strategy',
        'Design component libraries in Figma',
        'Partner with engineering on implementation',
        'Establish governance and contribution models',
        'Conduct training and workshops',
        'Ensure WCAG 2.1 AAA compliance'
      ],
      jobBenefits: [
        '$140,000 - $180,000 base salary',
        'Competitive equity package',
        'Full health/dental/vision insurance',
        '401(k) matching (4%)',
        '$2,000/year learning budget',
        '$1,000 home office setup',
        '16 weeks parental leave',
        'Unlimited PTO',
        'Fully remote'
      ],
      jobHiringManager: {
        name: 'Michael Torres',
        title: 'Director of Product Design',
        photo: null,
        linkedin: 'linkedin.com/in/michaeltorres'
      },
      jobTeamSize: 12,
      jobReportsTo: 'Director of Product Design',
      jobApplicationUrl: 'https://careers.association.org/apply/senior-product-designer-design-systems'
    },
    // Landing Page Record
    {
      id: 12,
      title: '2025 Conference Early Bird Landing Page',
      recordType: 'Landing Page',
      status: 'Active',
      date: '2024-10-01',
      lastUpdated: '2025-11-19T11:30:00',
      priority: 'High',
      owner: 'Marketing Team',
      type: 'landing-page',
      summary: 'High-converting landing page for ELEVATE 2025 conference early bird registration, featuring social proof, speaker lineup, and urgency-driven CTA',
      tags: ['Marketing', 'Conference', 'Conversion', 'Early Bird', 'Active Campaign'],
      peopleCount: 12,
      activityCount: 8934,
      messageCount: 234,
      email: 'marketing@association.org',
      phone: 'N/A',
      membershipType: 'N/A',
      company: 'Professional Association',
      position: 'Landing Page',
      committees: [],
      duesStatus: 'N/A',
      renewalDate: 'N/A',
      address: 'N/A',
      interests: ['Marketing', 'Conversion Optimization', 'Event Promotion'],
      volunteerHours: 0,
      eventsAttended: 0,
      bio: 'Conversion-optimized landing page designed to drive early bird conference registrations through compelling value proposition, social proof, and scarcity tactics.',
      // Landing Page-specific fields
      landingPageUrl: 'https://elevate2025.association.org/early-bird',
      landingPageType: 'Event Registration',
      landingPageStatus: 'Live',
      landingPageLaunchDate: '2024-10-01',
      landingPageGoal: 'Drive 500 early bird registrations by December 31, 2024',
      landingPageTarget: 500,
      landingPageConversions: 847,
      landingPageConversionRate: 23.4,
      landingPageVisitors: 3621,
      landingPageBounceRate: 31.2,
      landingPageAvgTimeOnPage: '4:32',
      landingPageTrafficSources: [
        { source: 'Email Campaign', visitors: 1842, conversions: 512, cvr: 27.8 },
        { source: 'Social Media', visitors: 892, conversions: 189, cvr: 21.2 },
        { source: 'Google Ads', visitors: 534, conversions: 98, cvr: 18.4 },
        { source: 'Organic Search', visitors: 245, conversions: 35, cvr: 14.3 },
        { source: 'Direct', visitors: 108, conversions: 13, cvr: 12.0 }
      ],
      landingPageSections: [
        {
          name: 'Hero',
          type: 'Full-width hero with video background',
          content: 'ELEVATE 2025 headline, date/location, primary CTA button',
          cta: 'Register Now - Save $150',
          ctaClicks: 1247
        },
        {
          name: 'Value Proposition',
          type: 'Three-column benefits',
          content: '50+ speakers, 120 sessions, Networking opportunities',
          cta: null,
          ctaClicks: 0
        },
        {
          name: 'Social Proof',
          type: 'Testimonials carousel',
          content: 'Video testimonials from past attendees',
          cta: null,
          ctaClicks: 0
        },
        {
          name: 'Speaker Lineup',
          type: 'Grid with photos',
          content: 'Featured speakers with headshots and credentials',
          cta: 'See Full Lineup',
          ctaClicks: 423
        },
        {
          name: 'Pricing',
          type: 'Comparison table',
          content: 'Early Bird vs Regular pricing with savings highlighted',
          cta: 'Claim Early Bird Price',
          ctaClicks: 892
        },
        {
          name: 'Countdown Timer',
          type: 'Urgency element',
          content: 'Live countdown to early bird deadline',
          cta: null,
          ctaClicks: 0
        },
        {
          name: 'FAQ',
          type: 'Accordion',
          content: '15 frequently asked questions',
          cta: null,
          ctaClicks: 0
        },
        {
          name: 'Final CTA',
          type: 'Full-width',
          content: 'Last chance messaging with registration form',
          cta: 'Secure My Spot',
          ctaClicks: 534
        }
      ],
      landingPageABTests: [
        {
          element: 'Hero CTA',
          variantA: 'Register Now - Save $150',
          variantB: 'Claim Your Early Bird Ticket',
          winner: 'Variant A',
          lift: '+18.4%',
          status: 'Completed'
        },
        {
          element: 'Social Proof',
          variantA: 'Written testimonials',
          variantB: 'Video testimonials',
          winner: 'Variant B',
          lift: '+34.2%',
          status: 'Completed'
        },
        {
          element: 'Pricing Display',
          variantA: 'Show savings ($150 off)',
          variantB: 'Show percentage (25% off)',
          winner: 'Variant A',
          lift: '+12.7%',
          status: 'Completed'
        }
      ],
      landingPageDesignElements: {
        colorScheme: 'Purple gradient (brand colors)',
        typography: 'Inter (headings), System fonts (body)',
        imagery: 'Conference photos, speaker headshots, venue',
        layout: 'Single-column, F-pattern optimized',
        mobileOptimized: true,
        loadTime: '1.8s',
        accessibilityScore: 98
      },
      landingPageIntegrations: [
        'Google Analytics 4',
        'Facebook Pixel',
        'LinkedIn Insight Tag',
        'Hotjar (heatmaps & recordings)',
        'Mailchimp (email integration)',
        'Stripe (payment processing)'
      ],
      landingPagePerformanceMetrics: {
        visitors: 3621,
        conversions: 847,
        conversionRate: 23.4,
        bounceRate: 31.2,
        avgTimeOnPage: '4:32',
        revenue: '$424,350',
        costPerAcquisition: '$42',
        returnOnAdSpend: 8.2
      },
      landingPageNextSteps: [
        'Launch retargeting campaign for visitors who didn\'t convert',
        'A/B test countdown timer placement',
        'Add live chat widget for questions',
        'Create Spanish language variant'
      ]
    },
    // Application Records
    {
      id: 101,
      title: 'Alexandra Rodriguez',
      recordType: 'Application',
      status: 'Pending Review',
      date: '2024-11-01',
      lastUpdated: '2024-11-01T10:30:00',
      priority: 'Medium',
      owner: 'Membership Committee',
      type: 'application',
      summary: 'Professional membership application from creative director with 15+ years experience',
      tags: ['Design', 'Leadership', 'Professional'],
      peopleCount: 0,
      activityCount: 3,
      messageCount: 3,
      email: 'alexandra.rodriguez@designco.com',
      phone: '(555) 234-5678',
      membershipType: 'Professional',
      company: 'DesignCo Studios',
      position: 'Creative Director',
      applicationId: 'APP-001',
      memberId: 'MEM-2024-001',
      year: 2024,
      submissionDate: '2024-11-01',
      approvalDate: null,
      discussionsCount: 3,
      bio: 'Experienced design leader with over 15 years in digital product design and team leadership. Passionate about mentoring emerging designers and fostering inclusive design practices.',
      artifacts: [
        { id: 'artifact-101-1', name: 'Resume_Rodriguez_2024.pdf', type: 'pdf', category: 'Resume/CV', url: '/artifacts/resume-101.pdf', size: '245 KB', uploadedDate: '2024-11-01' },
        { id: 'artifact-101-2', name: 'Portfolio_Samples.pdf', type: 'pdf', category: 'Portfolio', url: '/artifacts/portfolio-101.pdf', size: '3.2 MB', uploadedDate: '2024-11-01' },
        { id: 'artifact-101-3', name: 'Recommendation_Letter_Johnson.pdf', type: 'pdf', category: 'Reference Letter', url: '/artifacts/rec1-101.pdf', size: '128 KB', uploadedDate: '2024-11-01' },
        { id: 'artifact-101-4', name: 'Drivers_License.pdf', type: 'pdf', category: 'ID Document', url: '/artifacts/id-101.pdf', size: '892 KB', uploadedDate: '2024-11-01' },
        { id: 'artifact-101-5', name: 'Design_Certification_CUXP.pdf', type: 'pdf', category: 'Certificate', url: '/artifacts/cert1-101.pdf', size: '456 KB', uploadedDate: '2024-11-01' },
        { id: 'artifact-101-6', name: 'IDEO_Design_Thinking_Certificate.pdf', type: 'pdf', category: 'Certificate', url: '/artifacts/cert2-101.pdf', size: '523 KB', uploadedDate: '2024-11-01' },
        { id: 'artifact-101-7', name: 'Transcript_RISD.pdf', type: 'pdf', category: 'Transcript', url: '/artifacts/transcript-101.pdf', size: '1.1 MB', uploadedDate: '2024-11-01' },
        { id: 'artifact-101-8', name: 'Published_Article_UXMag_2023.pdf', type: 'pdf', category: 'Publication', url: '/artifacts/pub1-101.pdf', size: '678 KB', uploadedDate: '2024-11-01' }
      ]
    },
    {
      id: 102,
      title: 'Marcus Thompson',
      recordType: 'Application',
      status: 'Under Discussion',
      date: '2024-10-28',
      lastUpdated: '2024-11-05T14:20:00',
      priority: 'High',
      owner: 'Membership Committee',
      type: 'application',
      summary: 'Academic membership application from associate professor in HCI',
      tags: ['Academic', 'Research', 'Accessibility'],
      peopleCount: 0,
      activityCount: 5,
      messageCount: 5,
      email: 'marcus.thompson@university.edu',
      phone: '(555) 345-6789',
      membershipType: 'Academic',
      company: 'State University',
      position: 'Associate Professor',
      applicationId: 'APP-002',
      memberId: 'MEM-2024-002',
      year: 2024,
      submissionDate: '2024-10-28',
      approvalDate: null,
      discussionsCount: 5,
      bio: 'Academic researcher focused on human-computer interaction and accessibility. Published author with extensive teaching experience in UX design methodologies.',
      artifacts: [
        { id: 'artifact-102-1', name: 'CV_Thompson_Academic_2024.pdf', type: 'pdf', category: 'Resume/CV', url: '/artifacts/cv-102.pdf', size: '312 KB', uploadedDate: '2024-10-28' },
        { id: 'artifact-102-2', name: 'Publication_List_Complete.pdf', type: 'pdf', category: 'Publication', url: '/artifacts/pubs-102.pdf', size: '156 KB', uploadedDate: '2024-10-28' },
        { id: 'artifact-102-3', name: 'Research_Statement.pdf', type: 'pdf', category: 'Research', url: '/artifacts/research-102.pdf', size: '445 KB', uploadedDate: '2024-10-28' },
        { id: 'artifact-102-4', name: 'Teaching_Philosophy.pdf', type: 'pdf', category: 'Research', url: '/artifacts/teaching-102.pdf', size: '198 KB', uploadedDate: '2024-10-28' },
        { id: 'artifact-102-5', name: 'Passport_Scan.pdf', type: 'pdf', category: 'ID Document', url: '/artifacts/passport-102.pdf', size: '1.8 MB', uploadedDate: '2024-10-28' },
        { id: 'artifact-102-6', name: 'PhD_Diploma.pdf', type: 'pdf', category: 'Certificate', url: '/artifacts/diploma-102.pdf', size: '734 KB', uploadedDate: '2024-10-28' },
        { id: 'artifact-102-7', name: 'Recommendation_Letter_Dean.pdf', type: 'pdf', category: 'Reference Letter', url: '/artifacts/rec1-102.pdf', size: '215 KB', uploadedDate: '2024-10-28' },
        { id: 'artifact-102-8', name: 'Recommendation_Letter_Colleague.pdf', type: 'pdf', category: 'Reference Letter', url: '/artifacts/rec2-102.pdf', size: '198 KB', uploadedDate: '2024-10-28' },
        { id: 'artifact-102-9', name: 'Sample_Research_Paper_HCI.pdf', type: 'pdf', category: 'Publication', url: '/artifacts/paper-102.pdf', size: '2.4 MB', uploadedDate: '2024-10-28' },
        { id: 'artifact-102-10', name: 'University_Employment_Verification.pdf', type: 'pdf', category: 'Verification', url: '/artifacts/employment-102.pdf', size: '124 KB', uploadedDate: '2024-10-28' }
      ]
    },
    {
      id: 103,
      title: 'Priya Patel',
      recordType: 'Application',
      status: 'Approved',
      date: '2024-10-15',
      lastUpdated: '2024-11-10T16:45:00',
      priority: 'Low',
      owner: 'Membership Committee',
      type: 'application',
      summary: 'Professional membership application - APPROVED',
      tags: ['Design Systems', 'Professional', 'Enterprise'],
      peopleCount: 0,
      activityCount: 2,
      messageCount: 2,
      email: 'priya.patel@innovatetech.com',
      phone: '(555) 456-7890',
      membershipType: 'Professional',
      company: 'InnovateTech Solutions',
      position: 'Senior Product Designer',
      applicationId: 'APP-003',
      memberId: 'MEM-2024-003',
      year: 2024,
      submissionDate: '2024-10-15',
      approvalDate: '2024-11-10',
      discussionsCount: 2,
      bio: 'Product designer specializing in enterprise SaaS applications. Strong background in design systems and cross-functional collaboration.'
    },
    {
      id: 104,
      title: 'James Wilson',
      recordType: 'Application',
      status: 'Pending Review',
      date: '2024-11-12',
      lastUpdated: '2024-11-12T09:15:00',
      priority: 'Low',
      owner: 'Membership Committee',
      type: 'application',
      summary: 'Student membership application from graduate student',
      tags: ['Student', 'Emerging Tech', 'Education'],
      peopleCount: 0,
      activityCount: 1,
      messageCount: 1,
      email: 'james.wilson@student.edu',
      phone: '(555) 567-8901',
      membershipType: 'Student',
      company: 'Design Institute',
      position: 'Graduate Student',
      applicationId: 'APP-004',
      memberId: 'MEM-2024-004',
      year: 2024,
      submissionDate: '2024-11-12',
      approvalDate: null,
      discussionsCount: 1,
      bio: 'Graduate student pursuing a Master\'s in Interaction Design. Interested in emerging technologies and their impact on user experience.'
    },
    {
      id: 105,
      title: 'Yuki Tanaka',
      recordType: 'Application',
      status: 'Approved',
      date: '2024-10-20',
      lastUpdated: '2024-11-15T11:30:00',
      priority: 'Medium',
      owner: 'Membership Committee',
      type: 'application',
      summary: 'Professional membership application - APPROVED',
      tags: ['International', 'UX', 'Professional'],
      peopleCount: 0,
      activityCount: 4,
      messageCount: 4,
      email: 'yuki.tanaka@globalux.jp',
      phone: '+81-3-1234-5678',
      membershipType: 'Professional',
      company: 'Global UX Agency',
      position: 'UX Director',
      applicationId: 'APP-005',
      memberId: 'MEM-2024-005',
      year: 2024,
      submissionDate: '2024-10-20',
      approvalDate: '2024-11-15',
      discussionsCount: 4,
      bio: 'International UX leader with experience across Asian and North American markets. Expertise in cross-cultural design and localization.'
    },
    {
      id: 106,
      title: 'Emily Foster',
      recordType: 'Application',
      status: 'Under Discussion',
      date: '2024-11-05',
      lastUpdated: '2024-11-18T15:00:00',
      priority: 'High',
      owner: 'Membership Committee',
      type: 'application',
      summary: 'Professional membership application under active review',
      tags: ['Startup', 'Design', 'Professional'],
      peopleCount: 0,
      activityCount: 7,
      messageCount: 7,
      email: 'emily.foster@startupventures.com',
      phone: '(555) 678-9012',
      membershipType: 'Professional',
      company: 'StartupVentures Inc',
      position: 'Head of Design',
      applicationId: 'APP-006',
      memberId: 'MEM-2024-006',
      year: 2024,
      submissionDate: '2024-11-05',
      approvalDate: null,
      discussionsCount: 7,
      bio: 'Design leader focused on early-stage startups and rapid prototyping. Strong advocate for user research and data-driven design decisions.'
    },
  ];

  // Enhanced filtering with multi-field search, status/type filters, and sorting
  const filteredRecords = mockRecords
    .filter(record => {
      // Multi-field search
      const searchLower = searchTerm.toLowerCase();
      const matchesSearch = !searchTerm ||
        record.title.toLowerCase().includes(searchLower) ||
        record.email.toLowerCase().includes(searchLower) ||
        record.company.toLowerCase().includes(searchLower) ||
        record.position.toLowerCase().includes(searchLower) ||
        record.committees.some(e => e.name.toLowerCase().includes(searchLower));

      // Status filter
      const matchesStatus = statusFilter.length === 0 || statusFilter.includes(record.status);

      // Type filter
      const matchesType = typeFilter.length === 0 || typeFilter.includes(record.membershipType);

      return matchesSearch && matchesStatus && matchesType;
    })
    .sort((a, b) => {
      let aVal, bVal;

      switch(sortField) {
        case 'title':
          aVal = a.title.toLowerCase();
          bVal = b.title.toLowerCase();
          break;
        case 'recordType':
          aVal = a.recordType?.toLowerCase() || '';
          bVal = b.recordType?.toLowerCase() || '';
          break;
        case 'company':
          aVal = a.company.toLowerCase();
          bVal = b.company.toLowerCase();
          break;
        case 'membershipType':
          aVal = a.membershipType.toLowerCase();
          bVal = b.membershipType.toLowerCase();
          break;
        case 'date':
          aVal = new Date(a.date);
          bVal = new Date(b.date);
          break;
        case 'lastUpdated':
          aVal = new Date(a.lastUpdated || a.date);
          bVal = new Date(b.lastUpdated || b.date);
          break;
        case 'status':
          aVal = a.status.toLowerCase();
          bVal = b.status.toLowerCase();
          break;
        default:
          return 0;
      }

      if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
      if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
      return 0;
    });

  // Calculate member statistics
  const memberStats = {
    total: mockRecords.length,
    active: mockRecords.filter(r => r.status === 'Active').length,
    pending: mockRecords.filter(r => r.status === 'Pending').length,
    completed: mockRecords.filter(r => r.status === 'Completed').length,
    professional: mockRecords.filter(r => r.membershipType === 'Professional').length,
    individual: mockRecords.filter(r => r.membershipType === 'Individual').length,
    student: mockRecords.filter(r => r.membershipType === 'Student').length,
    totalVolunteerHours: mockRecords.reduce((sum, r) => sum + (r.volunteerHours || 0), 0),
  };

  // Bulk operation handlers
  const handleBulkExport = () => {
    const selectedData = mockRecords.filter(r => selectedRecords.includes(r.id));
    const csvContent = "data:text/csv;charset=utf-8," +
      "Name,Email,Company,Type,Status,Join Date\n" +
      selectedData.map(r =>
        `"${r.title}","${r.email}","${r.company}","${r.membershipType}","${r.status}","${r.date}"`
      ).join("\n");

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `members_export_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const handleBulkDelete = () => {
    if (confirm(`Are you sure you want to delete ${selectedRecords.length} member(s)? This action cannot be undone.`)) {
      // In a real app, this would make an API call
      console.log('Deleting members:', selectedRecords);
      setSelectedRecords([]);
    }
  };

  const handleBulkEmail = () => {
    const selectedEmails = mockRecords
      .filter(r => selectedRecords.includes(r.id))
      .map(r => r.email);
    const mailto = `mailto:${selectedEmails.join(',')}`;
    window.location.href = mailto;
  };

  // Quick page creation handler - instant blank page
  const handleQuickCreatePage = () => {
    const pageNumber = customPages.filter(p => p.type === 'database').length + 1;
    const blankPageRecord = createBlankPage({
      id: `page-${Date.now()}`,
      title: `Untitled ${pageNumber}`,
      createdBy: 'current-user'
    });

    // Convert to page format expected by App
    const newPage = {
      id: blankPageRecord.id,
      name: blankPageRecord.title,
      type: 'database',
      icon: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z',
      isCustom: true,
      settings: {
        universalConfig: blankPageRecord.pageConfig
      },
      metadata: blankPageRecord.metadata
    };

    setCustomPages([...customPages, newPage]);
    setActiveCustomPageId(newPage.id);
    setView('custom-page');
  };

  // Template-based page creation handler
  const handlePageTemplateSelect = (template) => {
    if (!template) {
      // Blank template - create complete database page (same as quick create)
      const pageNumber = customPages.filter(p => p.type === 'database').length + 1;
      const blankPageRecord = createBlankPage({
        id: `page-${Date.now()}`,
        title: `Untitled ${pageNumber}`,
        createdBy: 'current-user'
      });

      const blankPage = {
        id: blankPageRecord.id,
        name: blankPageRecord.title,
        type: 'database',
        icon: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z',
        isCustom: true,
        settings: {
          universalConfig: blankPageRecord.pageConfig
        },
        metadata: blankPageRecord.metadata
      };
      setCustomPages([...customPages, blankPage]);
      setActiveCustomPageId(blankPage.id);
      setView('custom-page');
      setShowPageTemplateGallery(false);
    } else {
      // Create page from template with sample data
      const pageNumber = customPages.filter(p => p.type === 'database').length + 1;
      const templateRecord = createSampleRecord(template.templateId, `${template.name} ${pageNumber}`);

      // Helper function to interpolate template strings with data
      const interpolateData = (template, data) => {
        if (typeof template !== 'string') {
          return template;
        }
        return template.replace(/\{\{([^}]+)\}\}/g, (match, path) => {
          const [fieldPath, filter] = path.split('|').map(s => s.trim());
          const value = fieldPath.split('.').reduce((obj, key) => {
            const arrayMatch = key.match(/([^\[]+)\[(\d+)\]/);
            if (arrayMatch) {
              const [, arrayKey, index] = arrayMatch;
              return obj?.[arrayKey]?.[parseInt(index)];
            }
            return obj?.[key];
          }, data);

          if (filter && value !== undefined && value !== null) {
            switch (filter) {
              case 'number':
                return typeof value === 'number' ? value.toLocaleString() : value;
              case 'currency':
                return typeof value === 'number' ? `$${value.toLocaleString()}` : value;
              default:
                return value;
            }
          }

          return value !== undefined && value !== null ? value : match;
        });
      };

      // Recursively process config to replace template placeholders
      const processConfig = (obj, data) => {
        if (!obj || typeof obj !== 'object') {
          return obj;
        }
        if (Array.isArray(obj)) {
          return obj.map(item => processConfig(item, data));
        }
        const processed = {};
        for (const [key, value] of Object.entries(obj)) {
          if (typeof value === 'string') {
            processed[key] = interpolateData(value, data);
          } else if (typeof value === 'object') {
            processed[key] = processConfig(value, data);
          } else {
            processed[key] = value;
          }
        }
        return processed;
      };

      // Combine record data for interpolation
      const recordData = {
        ...templateRecord,
        ...templateRecord.customData
      };

      // Process the config to replace all template variables
      const processedConfig = processConfig(templateRecord.pageConfig, recordData);

      // Convert template record to page format
      const newPage = {
        id: templateRecord.id,
        name: templateRecord.title,
        type: 'database',
        icon: template.icon || 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z',
        isCustom: true,
        templateId: template.templateId,
        customData: templateRecord.customData,
        settings: {
          universalConfig: processedConfig  // Use processed config with interpolated data
        },
        metadata: templateRecord.metadata
      };

      setCustomPages([...customPages, newPage]);
      setActiveCustomPageId(newPage.id);
      setView('custom-page');
      setShowPageTemplateGallery(false);
    }
  };

  const handleSort = (field) => {
    if (sortField === field) {
      setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
    } else {
      setSortField(field);
      setSortDirection('asc');
    }
  };

  // Sample events data
  const allEvents = [
    { id: 'evt-1', name: 'Annual Technology Conference 2024', date: '2024-06-15', type: 'Conference', status: 'Upcoming', registrations: 450 },
    { id: 'evt-2', name: 'Leadership Workshop Series', date: '2024-05-20', type: 'Workshop', status: 'Open', registrations: 85 },
    { id: 'evt-3', name: 'Networking Mixer - Spring Edition', date: '2024-04-10', type: 'Networking', status: 'Past', registrations: 120 },
    { id: 'evt-4', name: 'Professional Development Webinar', date: '2024-07-01', type: 'Webinar', status: 'Upcoming', registrations: 210 },
    { id: 'evt-5', name: 'Industry Standards Summit', date: '2024-08-15', type: 'Summit', status: 'Open', registrations: 310 },
  ];

  const memberEvents = [
    { id: 'evt-1', name: 'Annual Technology Conference 2024', date: '2024-06-15', type: 'Conference', status: 'Registered', role: 'Attendee' },
    { id: 'evt-3', name: 'Networking Mixer - Spring Edition', date: '2024-04-10', type: 'Networking', status: 'Attended', role: 'Attendee' },
    { id: 'evt-5', name: 'Industry Standards Summit', date: '2024-08-15', type: 'Summit', status: 'Registered', role: 'Speaker' },
  ];

  const componentElements = [
    // Containers - Advanced layout containers
    { id: 'kanban-layout', type: 'container', name: 'Kanban Board', description: 'Column-based card organization', icon: 'view-columns', isContainer: true },
    { id: 'grid-layout', type: 'container', name: 'Grid Layout', description: 'Grid container with draggable elements', icon: 'grid', isContainer: true },
    { id: 'canvas-layout', type: 'container', name: 'Canvas Layout', description: 'Freeform container with absolute positioning', icon: 'canvas', isContainer: true },

    // Containers - Basic structural containers with presets
    { id: 'section', type: 'container', name: 'Section', description: 'Full-width page section', icon: 'rectangle', isContainer: true, containerPreset: 'section' },
    { id: 'container', type: 'container', name: 'Container', description: 'Versatile content wrapper', icon: 'box', isContainer: true, containerPreset: 'centered' },
    { id: 'card', type: 'container', name: 'Card', description: 'Bordered container with shadow', icon: 'card', isContainer: true, containerPreset: 'card' },
    { id: 'div-block', type: 'container', name: 'Div Block', description: 'Blank div for custom layouts', icon: 'square', isContainer: true, containerPreset: 'custom' },

    // Utility Components
    { id: 'spacer', type: 'utility', name: 'Spacer', description: 'Add vertical spacing between elements', icon: 'arrows-expand' },

    // Zone Elements - Elements typically used in header/footer zones
    { id: 'breadcrumb', type: 'zone', name: 'Breadcrumb', description: 'Navigation breadcrumb', icon: 'chevron-left' },
    { id: 'title-group', type: 'zone', name: 'Title Group', description: 'Page title and record type', icon: 'document' },
    { id: 'action-buttons', type: 'zone', name: 'Action Buttons', description: 'Primary action buttons', icon: 'lightning' },
    { id: 'metadata', type: 'zone', name: 'Record Metadata', description: 'Record information details', icon: 'information-circle' },
    { id: 'last-updated', type: 'zone', name: 'Last Updated', description: 'Modification timestamp', icon: 'clock' },
    { id: 'stats-summary', type: 'zone', name: 'Stats Summary', description: 'Key statistics summary', icon: 'chart' },
    { id: 'action-bar', type: 'zone', name: 'Action Bar', description: 'Footer action bar', icon: 'menu' },

    // Combos - Pre-configured combinations of blocks
    {
      id: 'profile-essentials',
      type: 'combo',
      name: 'Profile Essentials',
      description: 'Header + Bio + Contact combo',
      icon: 'user',
      elements: ['header', 'bio', 'contact']
    },
    {
      id: 'member-overview',
      type: 'combo',
      name: 'Member Overview',
      description: 'Header + Membership + Recent Activity',
      icon: 'badge',
      elements: ['header', 'membership', 'recent-activity']
    },
    {
      id: 'professional-profile',
      type: 'combo',
      name: 'Professional Profile',
      description: 'Header + Bio + Work Experience + Skills',
      icon: 'briefcase',
      elements: ['header', 'bio', 'work-experience', 'skills']
    },

    // Blocks - Core content blocks for record data
    { id: 'header', type: 'block', recordType: 'header', name: 'Header', description: 'Name, title, and status', icon: 'user', supportsLayouts: false },
    { id: 'bio', type: 'block', recordType: 'bio', name: 'Biography', description: 'Personal biography text', icon: 'document-text', supportsLayouts: true },
    { id: 'contact', type: 'block', recordType: 'contact', name: 'Contact Information', description: 'Email, phone, and address', icon: 'mail', supportsLayouts: true },
    { id: 'interests', type: 'block', recordType: 'interests', name: 'Interests & Expertise', description: 'Topics and expertise areas', icon: 'light-bulb', supportsLayouts: true },
    { id: 'membership', type: 'block', recordType: 'membership', name: 'Membership Details', description: 'Join date and member type', icon: 'badge', supportsLayouts: true },
    { id: 'actions', type: 'block', recordType: 'actions', name: 'Quick Actions', description: 'Common member actions', icon: 'lightning', supportsLayouts: false },
    { id: 'recent-activity', type: 'block', recordType: 'recent-activity', name: 'Recent Activity', description: 'Recent member activity timeline', icon: 'clock', supportsLayouts: true },

    // Blocks - Extended content blocks
    { id: 'abstracts', type: 'block', recordType: 'abstracts', name: 'Abstracts', description: 'Research paper summaries', icon: 'document', supportsLayouts: true },
    { id: 'accreditations', type: 'block', recordType: 'accreditations', name: 'Accreditations', description: 'Professional certifications earned', icon: 'badge', supportsLayouts: true },
    { id: 'advocacy', type: 'block', recordType: 'advocacy', name: 'Advocacy', description: 'Causes and initiatives supported', icon: 'megaphone', supportsLayouts: true },
    { id: 'ce-credits', type: 'block', recordType: 'ce-credits', name: 'CE Credits', description: 'Continuing education hours', icon: 'academic', supportsLayouts: true },
    { id: 'committees', type: 'block', recordType: 'committees', name: 'Committee Participation', description: 'Committee memberships and roles', icon: 'users-group', supportsLayouts: true },
    { id: 'cv', type: 'block', recordType: 'cv', name: 'CV', description: 'Curriculum vitae document', icon: 'document-text', supportsLayouts: true },
    { id: 'engagement-badges', type: 'block', recordType: 'engagement-badges', name: 'Engagement Badges', description: 'Achievement and participation awards', icon: 'star', supportsLayouts: true },
    { id: 'events', type: 'block', recordType: 'events', name: 'Events', description: 'Events and registrations', icon: 'calendar', supportsLayouts: true },
    { id: 'event-attendance', type: 'block', recordType: 'event-attendance', name: 'Event Attendance', description: 'Conferences and events attended', icon: 'calendar', supportsLayouts: true },
    { id: 'grants', type: 'block', recordType: 'grants', name: 'Grants', description: 'Research funding received', icon: 'currency', supportsLayouts: true },
    { id: 'languages', type: 'block', recordType: 'languages', name: 'Languages', description: 'Languages spoken fluently', icon: 'globe', supportsLayouts: true },
    { id: 'liaison', type: 'block', recordType: 'liaison', name: 'Liaison', description: 'External organization connections', icon: 'link', supportsLayouts: true },
    { id: 'media-inquiries', type: 'block', recordType: 'media-inquiries', name: 'Media Inquiries', description: 'Press and media contacts', icon: 'newspaper', supportsLayouts: true },
    { id: 'mentorships', type: 'block', recordType: 'mentorships', name: 'Mentorships', description: 'Mentor and mentee relationships', icon: 'users', supportsLayouts: true },
    { id: 'orders', type: 'block', recordType: 'orders', name: 'Orders', description: 'Purchase history and orders', icon: 'shopping', supportsLayouts: true },
    { id: 'order-header', type: 'block', recordType: 'order-header', name: 'Order Header', description: 'Order number, status, and key details', icon: 'document', supportsLayouts: false },
    { id: 'order-customer', type: 'block', recordType: 'order-customer', name: 'Customer Information', description: 'Customer contact and billing details', icon: 'user', supportsLayouts: false },
    { id: 'order-items', type: 'block', recordType: 'order-items', name: 'Order Items', description: 'Editable line items with return support', icon: 'list', supportsLayouts: false },
    { id: 'order-totals', type: 'block', recordType: 'order-totals', name: 'Order Totals', description: 'Subtotal, discounts, tax, and total', icon: 'calculator', supportsLayouts: false },
    { id: 'order-notes', type: 'block', recordType: 'order-notes', name: 'Order Notes', description: 'Special instructions and notes', icon: 'document-text', supportsLayouts: false },
    { id: 'order-actions', type: 'block', recordType: 'order-actions', name: 'Order Actions', description: 'Download, email, and print options', icon: 'lightning', supportsLayouts: false },
    { id: 'applicant-profile', type: 'block', recordType: 'applicant-profile', name: 'Applicant Profile', description: 'Applicant name, position, company, and status', icon: 'user', supportsLayouts: false },
    { id: 'applicant-contact', type: 'block', recordType: 'applicant-contact', name: 'Applicant Contact', description: 'Email and phone contact information', icon: 'mail', supportsLayouts: false },
    { id: 'application-details', type: 'block', recordType: 'application-details', name: 'Application Details', description: 'Application ID, member ID, and dates', icon: 'document', supportsLayouts: false },
    { id: 'application-form', type: 'block', recordType: 'application-form', name: 'Application Form', description: 'Full application form with all fields', icon: 'document-text', supportsLayouts: false },
    { id: 'application-actions', type: 'block', recordType: 'application-actions', name: 'Application Actions', description: 'Approve, reject, and discussion buttons', icon: 'lightning', supportsLayouts: false },
    { id: 'application-activity', type: 'block', recordType: 'application-activity', name: 'Latest Activity', description: 'Recent activity timeline for application', icon: 'clock', supportsLayouts: false },
    { id: 'payment-methods', type: 'block', recordType: 'payment-methods', name: 'Payment Methods', description: 'Billing and payment options', icon: 'credit-card', supportsLayouts: true },
    { id: 'professional-development', type: 'block', recordType: 'professional-development', name: 'Professional Development', description: 'Career growth activities', icon: 'trending-up', supportsLayouts: true },
    { id: 'publications', type: 'block', recordType: 'publications', name: 'Publications', description: 'Published works and articles', icon: 'book', supportsLayouts: true },
    { id: 'refunds', type: 'block', recordType: 'refunds', name: 'Refunds', description: 'Refund requests and history', icon: 'refresh', supportsLayouts: true },
    { id: 'relationships', type: 'block', recordType: 'relationships', name: 'Relationships', description: 'Professional network connections', icon: 'users-group', supportsLayouts: true },
    { id: 'services-benefits', type: 'block', recordType: 'services-benefits', name: 'Member Services & Benefits', description: 'Available member perks', icon: 'gift', supportsLayouts: true },
    { id: 'skills', type: 'block', recordType: 'skills', name: 'Skills', description: 'Technical and professional skills', icon: 'lightning', supportsLayouts: true },
    { id: 'social-links', type: 'block', recordType: 'social-links', name: 'Social Links', description: 'Social media profiles', icon: 'share', supportsLayouts: true },
    { id: 'sponsorships', type: 'block', recordType: 'sponsorships', name: 'Sponsorships', description: 'Event and initiative sponsorships', icon: 'flag', supportsLayouts: true },
    { id: 'task-forces', type: 'block', recordType: 'task-forces', name: 'Task Forces', description: 'Special project groups', icon: 'briefcase', supportsLayouts: true },
    { id: 'topics-interest', type: 'block', recordType: 'topics-interest', name: 'Topics of Interest', description: 'Subject matter expertise', icon: 'light-bulb', supportsLayouts: true },
    { id: 'work-experience', type: 'block', recordType: 'work-experience', name: 'Work Experience', description: 'Employment history details', icon: 'office', supportsLayouts: true },
    { id: 'volunteer-experience', type: 'block', recordType: 'volunteer-experience', name: 'Volunteer Experience', description: 'Community service activities', icon: 'heart', supportsLayouts: true },

    // Contact CRM Record Type Elements
    { id: 'contact-profile', type: 'block', recordType: 'contact-profile', name: 'Contact Profile', description: 'CRM profile with lifecycle stage and engagement', icon: 'user', supportsLayouts: false },
    { id: 'contact-company', type: 'block', recordType: 'contact-company', name: 'Company Information', description: 'Company details for contact', icon: 'office', supportsLayouts: false },
    { id: 'contact-timeline', type: 'block', recordType: 'contact-timeline', name: 'Activity Timeline', description: 'Contact activity history', icon: 'clock', supportsLayouts: false },
    { id: 'contact-notes', type: 'block', recordType: 'contact-notes', name: 'Notes', description: 'Contact notes and communications', icon: 'document-text', supportsLayouts: false },
    { id: 'contact-deals', type: 'block', recordType: 'contact-deals', name: 'Deals', description: 'Sales pipeline and opportunities', icon: 'currency', supportsLayouts: false },
    { id: 'contact-tasks', type: 'block', recordType: 'contact-tasks', name: 'Tasks', description: 'Contact-related tasks', icon: 'check', supportsLayouts: false },

    // Event Record Type Elements
    { id: 'event-hero', type: 'block', recordType: 'event-hero', name: 'Event Hero', description: 'Event header with key details', icon: 'calendar', supportsLayouts: false },
    { id: 'event-speakers', type: 'block', recordType: 'event-speakers', name: 'Speakers', description: 'Featured event speakers', icon: 'users', supportsLayouts: false },
    { id: 'event-schedule', type: 'block', recordType: 'event-schedule', name: 'Schedule', description: 'Event agenda and sessions', icon: 'clock', supportsLayouts: false },
    { id: 'event-registration', type: 'block', recordType: 'event-registration', name: 'Registration', description: 'Event registration and pricing', icon: 'ticket', supportsLayouts: false },
    { id: 'event-testimonials', type: 'block', recordType: 'event-testimonials', name: 'Testimonials', description: 'Attendee testimonials', icon: 'star', supportsLayouts: false },
    { id: 'event-3-column-section', type: 'container', recordType: 'event-3-column-section', name: '3-Column Section', description: 'Speakers, schedule, and registration in 3 columns', icon: 'view-grid', supportsLayouts: false, isContainer: true, containerPreset: '3-column' },

    // Article Record Type Elements
    { id: 'article-header', type: 'block', recordType: 'article-header', name: 'Article Header', description: 'Article title and metadata', icon: 'document', supportsLayouts: false },
    { id: 'article-content', type: 'block', recordType: 'article-content', name: 'Article Content', description: 'Main article body', icon: 'document-text', supportsLayouts: false },
    { id: 'article-author', type: 'block', recordType: 'article-author', name: 'Author Bio', description: 'Author information', icon: 'user', supportsLayouts: false },
    { id: 'article-related', type: 'block', recordType: 'article-related', name: 'Related Articles', description: 'Related content links', icon: 'link', supportsLayouts: false },

    // Course Record Type Elements
    { id: 'course-hero', type: 'block', recordType: 'course-hero', name: 'Course Hero', description: 'Course header section', icon: 'academic', supportsLayouts: false },
    { id: 'course-description', type: 'block', recordType: 'course-description', name: 'Description', description: 'Course overview', icon: 'document-text', supportsLayouts: false },
    { id: 'course-curriculum', type: 'block', recordType: 'course-curriculum', name: 'Curriculum', description: 'Course syllabus', icon: 'list', supportsLayouts: false },
    { id: 'course-instructor', type: 'block', recordType: 'course-instructor', name: 'Instructor', description: 'Instructor information', icon: 'user', supportsLayouts: false },
    { id: 'course-enrollment', type: 'block', recordType: 'course-enrollment', name: 'Enrollment', description: 'Enrollment details', icon: 'ticket', supportsLayouts: false },
    { id: 'course-stats', type: 'block', recordType: 'course-stats', name: 'Course Stats', description: 'Course statistics', icon: 'chart', supportsLayouts: false },
    { id: 'course-testimonials', type: 'block', recordType: 'course-testimonials', name: 'Testimonials', description: 'Student reviews', icon: 'star', supportsLayouts: false },

    // Product Record Type Elements
    { id: 'product-gallery', type: 'block', recordType: 'product-gallery', name: 'Product Gallery', description: 'Product images', icon: 'photograph', supportsLayouts: false },
    { id: 'product-info', type: 'block', recordType: 'product-info', name: 'Product Info', description: 'Product details', icon: 'information', supportsLayouts: false },
    { id: 'product-purchase', type: 'block', recordType: 'product-purchase', name: 'Purchase', description: 'Buy now section', icon: 'shopping', supportsLayouts: false },
    { id: 'product-description', type: 'block', recordType: 'product-description', name: 'Description', description: 'Full product description', icon: 'document-text', supportsLayouts: false },
    { id: 'product-reviews', type: 'block', recordType: 'product-reviews', name: 'Reviews', description: 'Customer reviews', icon: 'star', supportsLayouts: false },

    // Order Record Type Elements (timeline added, others existed)
    { id: 'order-timeline', type: 'block', recordType: 'order-timeline', name: 'Order Timeline', description: 'Order status tracking', icon: 'clock', supportsLayouts: false },

    // Dashboard Record Type Elements
    { id: 'dashboard-header', type: 'block', recordType: 'dashboard-header', name: 'Dashboard Header', description: 'Dashboard title', icon: 'chart', supportsLayouts: false },
    { id: 'dashboard-kpis', type: 'block', recordType: 'dashboard-kpis', name: 'Key Metrics', description: 'KPI cards', icon: 'trending-up', supportsLayouts: false },
    { id: 'dashboard-chart', type: 'block', recordType: 'dashboard-chart', name: 'Chart', description: 'Data visualization', icon: 'chart', supportsLayouts: false },
    { id: 'dashboard-insights', type: 'block', recordType: 'dashboard-insights', name: 'Insights', description: 'Key insights', icon: 'light-bulb', supportsLayouts: false },

    // Portfolio Record Type Elements
    { id: 'portfolio-hero', type: 'block', recordType: 'portfolio-hero', name: 'Portfolio Hero', description: 'Project hero image', icon: 'photograph', supportsLayouts: false },
    { id: 'portfolio-overview', type: 'block', recordType: 'portfolio-overview', name: 'Overview', description: 'Project overview', icon: 'document-text', supportsLayouts: false },
    { id: 'portfolio-challenge', type: 'block', recordType: 'portfolio-challenge', name: 'Challenge', description: 'Project challenge', icon: 'exclamation', supportsLayouts: false },
    { id: 'portfolio-solution', type: 'block', recordType: 'portfolio-solution', name: 'Solution', description: 'Project solution', icon: 'light-bulb', supportsLayouts: false },
    { id: 'portfolio-results', type: 'block', recordType: 'portfolio-results', name: 'Results', description: 'Project results', icon: 'chart', supportsLayouts: false },
    { id: 'portfolio-gallery', type: 'block', recordType: 'portfolio-gallery', name: 'Gallery', description: 'Project images', icon: 'photograph', supportsLayouts: false },

    // Invoice Record Type Elements
    { id: 'invoice-header', type: 'block', recordType: 'invoice-header', name: 'Invoice Header', description: 'Invoice title and number', icon: 'document', supportsLayouts: false },
    { id: 'invoice-details', type: 'block', recordType: 'invoice-details', name: 'Invoice Details', description: 'Invoice metadata', icon: 'information', supportsLayouts: false },
    { id: 'invoice-items', type: 'block', recordType: 'invoice-items', name: 'Line Items', description: 'Invoice line items', icon: 'list', supportsLayouts: false },
    { id: 'invoice-totals', type: 'block', recordType: 'invoice-totals', name: 'Totals', description: 'Invoice totals', icon: 'calculator', supportsLayouts: false },
    { id: 'invoice-notes', type: 'block', recordType: 'invoice-notes', name: 'Notes', description: 'Payment terms', icon: 'document-text', supportsLayouts: false },
    { id: 'invoice-actions', type: 'block', recordType: 'invoice-actions', name: 'Actions', description: 'Print and download', icon: 'lightning', supportsLayouts: false },

    // Job Record Type Elements
    { id: 'job-header', type: 'block', recordType: 'job-header', name: 'Job Header', description: 'Job title and company', icon: 'briefcase', supportsLayouts: false },
    { id: 'job-description', type: 'block', recordType: 'job-description', name: 'Description', description: 'Job description', icon: 'document-text', supportsLayouts: false },
    { id: 'job-requirements', type: 'block', recordType: 'job-requirements', name: 'Requirements', description: 'Job requirements', icon: 'list', supportsLayouts: false },
    { id: 'job-benefits', type: 'block', recordType: 'job-benefits', name: 'Benefits', description: 'Job benefits', icon: 'gift', supportsLayouts: false },
    { id: 'job-apply', type: 'block', recordType: 'job-apply', name: 'Apply', description: 'Application form', icon: 'paper-airplane', supportsLayouts: false },
    { id: 'job-details', type: 'block', recordType: 'job-details', name: 'Details', description: 'Job details', icon: 'information', supportsLayouts: false },
    { id: 'job-team', type: 'block', recordType: 'job-team', name: 'Team', description: 'Team information', icon: 'users', supportsLayouts: false },

    // Landing Page Record Type Elements
    { id: 'landing-hero', type: 'block', recordType: 'landing-hero', name: 'Hero Section', description: 'Landing page hero', icon: 'photograph', supportsLayouts: false },
    { id: 'landing-stats', type: 'block', recordType: 'landing-stats', name: 'Stats', description: 'Key statistics', icon: 'chart', supportsLayouts: false },
    { id: 'landing-sections', type: 'block', recordType: 'landing-sections', name: 'Content Sections', description: 'Main content', icon: 'document-text', supportsLayouts: false },
    { id: 'landing-performance', type: 'block', recordType: 'landing-performance', name: 'Performance', description: 'Performance metrics', icon: 'trending-up', supportsLayouts: false },
    { id: 'landing-tests', type: 'block', recordType: 'landing-tests', name: 'A/B Tests', description: 'Test variations', icon: 'beaker', supportsLayouts: false },

    // Email Campaign Record Type Elements
    { id: 'email-header', type: 'block', recordType: 'email-header', name: 'Email Header', description: 'Email campaign header', icon: 'mail', supportsLayouts: false },
    { id: 'email-preview', type: 'block', recordType: 'email-preview', name: 'Email Preview', description: 'Email content preview', icon: 'eye', supportsLayouts: false },
    { id: 'email-stats', type: 'block', recordType: 'email-stats', name: 'Email Stats', description: 'Campaign statistics', icon: 'chart', supportsLayouts: false },
    { id: 'email-actions', type: 'block', recordType: 'email-actions', name: 'Actions', description: 'Send and schedule', icon: 'paper-airplane', supportsLayouts: false },
  ];

  // Container preset configurations
  const containerPresets = {
    section: {
      label: 'Full-width (Section)',
      description: 'Full viewport width, ideal for page sections',
      defaultStyles: {
        width: '100%',
        padding: '60px 24px',
        backgroundColor: '#f9fafb'
      }
    },
    centered: {
      label: 'Max-width Centered',
      description: 'Centered content with maximum width',
      defaultStyles: {
        maxWidth: '1200px',
        margin: '0 auto',
        padding: '0 24px'
      }
    },
    card: {
      label: 'Border + Shadow (Card)',
      description: 'Card-style with border and shadow',
      defaultStyles: {
        border: '1px solid #e5e7eb',
        borderRadius: '8px',
        padding: '24px',
        backgroundColor: '#ffffff',
        boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)'
      }
    },
    custom: {
      label: 'Custom',
      description: 'No default styles, fully customizable',
      defaultStyles: {}
    },
    '3-column': {
      label: '3-Column Layout',
      description: '3-column grid layout for child elements',
      defaultStyles: {
        display: 'grid',
        gridTemplateColumns: 'repeat(3, 1fr)',
        gap: '24px',
        padding: '0'
      }
    }
  };

  // Predefined options for name prefixes and suffixes
  const namePrefixOptions = ['Mr.', 'Mrs.', 'Ms.', 'Miss', 'Dr.', 'Prof.', 'Rev.', 'Hon.', 'Mx.'];
  const nameSuffixOptions = ['Jr.', 'Sr.', 'II', 'III', 'IV', 'V', 'PhD', 'MD', 'Esq.', 'DDS'];

  const fieldTypes = [
    { id: 'single-line', name: 'Single Line', description: 'Short text input', icon: 'text' },
    { id: 'multiline', name: 'Multi-line', description: 'Long text input', icon: 'document-text' },
    { id: 'name', name: 'Name', description: 'Full name field', icon: 'user' },
    { id: 'phone', name: 'Phone', description: 'Phone number input', icon: 'phone' },
    { id: 'email', name: 'Email', description: 'Email address input', icon: 'mail' },
    { id: 'address', name: 'Address', description: 'Street address input', icon: 'location' },
    { id: 'website', name: 'Website', description: 'URL input', icon: 'globe' },
    { id: 'select-single', name: 'Select Single', description: 'Dropdown with one choice', icon: 'list' },
    { id: 'select-multi', name: 'Select Multi', description: 'Select multiple options', icon: 'check-list' },
    { id: 'date', name: 'Date Picker', description: 'Select a date', icon: 'calendar' },
    { id: 'date-range', name: 'Date Range', description: 'Select start and end dates', icon: 'calendar' },
    { id: 'time', name: 'Time', description: 'Time input', icon: 'clock' },
    { id: 'select-record', name: 'Select Record', description: 'Link to another record', icon: 'link' },
    { id: 'section-header', name: 'Section Header', description: 'Heading to organize fields', icon: 'heading' },
    { id: 'html', name: 'HTML', description: 'Custom HTML content', icon: 'code' },
    { id: 'divider', name: 'Divider Line', description: 'Visual separator line', icon: 'minus' },
    { id: 'section-break', name: 'Section Break', description: 'Space between sections', icon: 'dots' },
  ];

  // Combine elements and fields into a single list for unified filtering
  const allElements = [
    ...componentElements,
    ...fieldTypes.map(field => ({ ...field, type: 'field', isField: true }))
  ];

  // Filter elements based on search and category
  const filteredElements = allElements.filter(element => {
    // Apply category filter
    const matchesCategory =
      elementCategoryFilter === 'all' ||
      (elementCategoryFilter === 'blocks' && element.type === 'block') ||
      (elementCategoryFilter === 'containers' && element.type === 'container') ||
      (elementCategoryFilter === 'combos' && element.type === 'combo') ||
      (elementCategoryFilter === 'fields' && element.type === 'field');

    // Apply search filter
    const matchesSearch =
      elementSearchFilter === '' ||
      element.name.toLowerCase().includes(elementSearchFilter.toLowerCase()) ||
      element.description.toLowerCase().includes(elementSearchFilter.toLowerCase());

    return matchesCategory && matchesSearch;
  });

  // Helper functions for form builder
  const addFormField = (fieldType) => {
    const newField = {
      id: `field-${Date.now()}`,
      label: `New ${fieldType.name}`,
      type: fieldType.id,
      required: false,
      placeholder: '',
      options: fieldType.id.includes('select') ? [] : undefined,
    };

    // Add sub-fields for name type
    if (fieldType.id === 'name') {
      newField.subFields = [
        { id: 'prefix', label: 'Prefix', visible: true, placeholder: 'Mr., Ms., Dr., etc.' },
        { id: 'firstName', label: 'First Name', visible: true, placeholder: 'First name' },
        { id: 'middleName', label: 'Middle Name', visible: true, placeholder: 'Middle name' },
        { id: 'lastName', label: 'Last Name', visible: true, placeholder: 'Last name' },
        { id: 'suffix', label: 'Suffix', visible: true, placeholder: 'Jr., Sr., III, etc.' },
      ];
      newField.layout = 'vertical'; // 'vertical' or 'horizontal'
      newField.usePredefinedPrefix = false;
      newField.usePredefinedSuffix = false;
    }

    setFormFields([...formFields, newField]);
  };

  const moveFieldUp = (index) => {
    if (index === 0) return;
    const newFields = [...formFields];
    [newFields[index - 1], newFields[index]] = [newFields[index], newFields[index - 1]];
    setFormFields(newFields);
  };

  const moveFieldDown = (index) => {
    if (index === formFields.length - 1) return;
    const newFields = [...formFields];
    [newFields[index], newFields[index + 1]] = [newFields[index + 1], newFields[index]];
    setFormFields(newFields);
  };

  const updateField = (fieldId, updates) => {
    setFormFields(formFields.map(f => f.id === fieldId ? { ...f, ...updates } : f));
  };

  const deleteField = (fieldId) => {
    setFormFields(formFields.filter(f => f.id !== fieldId));
    if (selectedFieldId === fieldId) {
      setSelectedFieldId(null);
    }
  };

  // Drag and drop handlers
  const handleDragStart = (e, index) => {
    setDraggedFieldIndex(index);
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', e.target);
  };

  const handleDragOver = (e, index) => {
    e.preventDefault();

    // Get cursor position relative to the element
    const rect = e.currentTarget.getBoundingClientRect();
    const cursorY = e.clientY - rect.top;
    const elementHeight = rect.height;

    // Determine if cursor is in upper or lower half
    const isUpperHalf = cursorY < elementHeight / 2;

    // Calculate target index based on cursor position
    let targetIndex = isUpperHalf ? index : index + 1;

    // Check if we're dragging a field type from elements panel
    if (draggedFieldType) {
      e.dataTransfer.dropEffect = 'copy';
      setDropTargetIndex(targetIndex);
      return;
    }

    // Handle reordering existing fields - just show drop indicator
    e.dataTransfer.dropEffect = 'move';

    if (draggedFieldIndex === null || draggedFieldIndex === index) {
      setDropTargetIndex(null);
      return;
    }

    // Set drop target for visual indicator only
    setDropTargetIndex(targetIndex);
  };

  const handleDrop = (e, index) => {
    e.preventDefault();

    // Use the dropTargetIndex that was set by handleDragOver
    const targetIndex = dropTargetIndex !== null ? dropTargetIndex : index;
    let droppedFieldId = null;

    // Check if we're dropping a field type from elements panel
    if (draggedFieldType) {
      const fieldType = fieldTypes.find(ft => ft.id === draggedFieldType);
      if (fieldType) {
        const newField = {
          id: `field-${Date.now()}`,
          label: `New ${fieldType.name}`,
          type: fieldType.id,
          required: false,
          placeholder: '',
          options: fieldType.id.includes('select') ? [] : undefined,
        };

        // Add sub-fields for name type
        if (fieldType.id === 'name') {
          newField.subFields = [
            { id: 'prefix', label: 'Prefix', visible: true, placeholder: 'Mr., Ms., Dr., etc.' },
            { id: 'firstName', label: 'First Name', visible: true, placeholder: 'First name' },
            { id: 'middleName', label: 'Middle Name', visible: true, placeholder: 'Middle name' },
            { id: 'lastName', label: 'Last Name', visible: true, placeholder: 'Last name' },
            { id: 'suffix', label: 'Suffix', visible: true, placeholder: 'Jr., Sr., III, etc.' },
          ];
          newField.layout = 'vertical'; // 'vertical' or 'horizontal'
          newField.usePredefinedPrefix = false;
          newField.usePredefinedSuffix = false;
        }

        droppedFieldId = newField.id;

        const newFields = [...formFields];
        // If dropping at the end, just push; otherwise splice at index
        if (targetIndex >= newFields.length) {
          newFields.push(newField);
        } else {
          newFields.splice(targetIndex, 0, newField);
        }
        setFormFields(newFields);
      }
    } else if (draggedFieldIndex !== null) {
      // Handle reordering existing fields
      const newFields = [...formFields];
      const draggedField = newFields[draggedFieldIndex];
      droppedFieldId = draggedField.id;
      newFields.splice(draggedFieldIndex, 1);

      // Adjust target index if needed after removal
      let adjustedIndex = targetIndex;
      if (targetIndex > draggedFieldIndex) {
        adjustedIndex = targetIndex - 1;
      }

      if (adjustedIndex >= newFields.length) {
        newFields.push(draggedField);
      } else {
        newFields.splice(adjustedIndex, 0, draggedField);
      }
      setFormFields(newFields);
    }

    // Trigger drop animation
    if (droppedFieldId) {
      setJustDroppedId(droppedFieldId);
      setTimeout(() => setJustDroppedId(null), 300);
    }

    // Clean up
    setDropTargetIndex(null);
  };

  const handleDragEnd = () => {
    setDraggedFieldIndex(null);
    setDraggedFieldType(null);
    setDropTargetIndex(null);
  };

  // Section drag handlers (for detail page sections)
  const handleSectionDragStart = (e, sectionId, index) => {
    e.stopPropagation();
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('sectionId', sectionId);
    setDraggedSection(sectionId);
  };

  const handleSectionDragOver = (e, index) => {
    e.preventDefault();
    e.stopPropagation();
    e.dataTransfer.dropEffect = 'move';
    setSectionDropTargetIndex(index);
  };

  const handleSectionDrop = (e, targetIndex) => {
    e.preventDefault();
    e.stopPropagation();

    const sectionId = e.dataTransfer.getData('sectionId');
    if (!sectionId) return;

    const currentIndex = detailSections.indexOf(sectionId);
    if (currentIndex === -1) return;

    const newSections = [...detailSections];
    newSections.splice(currentIndex, 1);
    newSections.splice(targetIndex, 0, sectionId);

    setDetailSections(newSections);
    setDraggedSection(null);
    setSectionDropTargetIndex(null);
  };

  const handleSectionDragEnd = () => {
    setDraggedSection(null);
    setSectionDropTargetIndex(null);
  };

  // Custom collision detection that prioritizes containers
  // IMPROVED: Uses pointerWithin for all collision detection
  // This allows dropping as soon as the mouse cursor enters a zone, rather than requiring
  // the element's center to be dragged into the zone. This is especially important for
  // large elements being dragged to narrow zones (e.g., body to header).
  const customCollisionDetection = (args) => {
    // Use pointer position for all collision detection
    // This provides intuitive, industry-standard drag behavior where drops
    // occur based on mouse position rather than element center
    return pointerWithin(args);
  };

  // DND-KIT: Unified drag handler - handles both new cards and reordering
  const handleCardDragStart = (event) => {
    setActiveElementId(event.active.id);
    if (event.active.data.current?.type === 'outline-item') {
      setActiveOutlineItemId(event.active.id);
    }
  };

  const handleCardDragEnd = (event) => {
    try {
      const { active, over } = event;
      setActiveElementId(null);
      setActiveOutlineItemId(null);
      setOverOutlineItemId(null);
      setDragPreviewPosition(null); // Clear preview

      if (!over) {
        return;
      }

    // Prevent duplicate execution - dnd-kit sometimes fires drop events twice
    const dropId = `${active.id}-${over.id}`;
    const now = Date.now();

    if (window._lastDropId === dropId && now - window._lastDropTime < 100) {
      return;
    }
    window._lastDropId = dropId;
    window._lastDropTime = now;
    setTimeout(() => {
      delete window._lastDropId;
      delete window._lastDropTime;
    }, 200);

    // Handle rearranging Quick Access icons
    if (active.data.current?.type === 'quick-access-icon' && over.data.current?.type === 'quick-access-icon') {
      const activeIndex = active.data.current.index;
      const overIndex = over.data.current.index;

      if (activeIndex !== overIndex) {
        setQuickAccessIcons((icons) => {
          const newIcons = [...icons];
          const [movedIcon] = newIcons.splice(activeIndex, 1);
          newIcons.splice(overIndex, 0, movedIcon);
          return newIcons;
        });
      }
      return;
    }

    // Handle drop on Quick Access
    if (over.id === 'quick-access-drop-zone' || over.data.current?.type === 'quick-access-icon') {
      const element = componentElements.find(e => e.id === active.data.current?.elementType);
      if (element) {
        console.log('Adding to Quick Access from @dnd-kit:', element);
        const newIcon = {
          id: element.id || `custom-${Date.now()}`,
          category: 'custom',
          icon: element.icon,
          label: element.name
        };
        // Check if icon already exists to avoid duplicates
        const iconExists = quickAccessIcons.some(icon => icon.id === newIcon.id);
        if (!iconExists) {
          setQuickAccessIcons([...quickAccessIcons, newIcon]);
        }
      }
      return;
    }

    // Handle Custom Page zone/row/column drops and reordering
    if (over.data.current?.context === 'custom-page') {
      const pageId = over.data.current.pageId;
      const isGap = over.data.current.type === 'gap';
      const isNewElement = active.data.current?.type === 'new-element';
      const isExistingElement = active.data.current?.type === 'existing-element';

      if (isGap && (isNewElement || isExistingElement)) {
        const zoneName = over.data.current.zoneName;
        const rowId = over.data.current.rowId;
        const columnIndex = over.data.current.columnIndex ?? 0;
        const insertIndex = over.data.current.insertIndex;

        if (isNewElement) {
          // Adding new element from panel
          const elementType = active.data.current.elementType;
          const elementDef = getElementDefinition(elementType);

          const newElement = {
            id: `elem-${Date.now()}`,
            type: elementType,
            elementType: elementType,
            content: elementDef?.defaultSettings?.placeholder || `New ${elementType.replace(/-/g, ' ')}`,
            settings: elementDef?.defaultSettings || {},
            data: elementDef?.defaultSettings?.data || {}
          };

          // Insert into custom page zone
          updateCustomPageZone(pageId, zoneName, (zone) => {
            const rows = [...(zone.rows || [])];
            const rowIndex = rows.findIndex(r => r.id === rowId);
            if (rowIndex === -1) return zone;

            const row = { ...rows[rowIndex] };
            const columns = [...(row.columns || [])];
            const column = { ...(columns[columnIndex] || {}) };
            const elements = [...(column.elements || [])];

            elements.splice(insertIndex, 0, newElement);

            column.elements = elements;
            columns[columnIndex] = column;
            row.columns = columns;
            rows[rowIndex] = row;

            return { ...zone, rows };
          });
        } else if (isExistingElement) {
          // Reordering existing element
          const fromZone = active.data.current.zoneName;
          const fromRow = active.data.current.rowId;
          const fromColumn = active.data.current.columnIndex ?? 0;

          // Remove from old position and insert at new position
          updateCustomPageZone(pageId, fromZone, (zone) => {
            const rows = [...(zone.rows || [])];

            // Remove from old position
            const fromRowIndex = rows.findIndex(r => r.id === fromRow);
            if (fromRowIndex === -1) return zone;

            const fromRowObj = { ...rows[fromRowIndex] };
            const fromColumns = [...(fromRowObj.columns || [])];
            const fromColumnObj = { ...(fromColumns[fromColumn] || {}) };
            const fromElements = [...(fromColumnObj.elements || [])];

            const movedElementIndex = fromElements.findIndex(el => el.id === active.id);
            if (movedElementIndex === -1) return zone;

            const [movedElement] = fromElements.splice(movedElementIndex, 1);

            // If same zone, update and insert at new position
            if (fromZone === zoneName && fromRow === rowId && fromColumn === columnIndex) {
              const adjustedInsertIndex = insertIndex > movedElementIndex ? insertIndex - 1 : insertIndex;
              fromElements.splice(adjustedInsertIndex, 0, movedElement);
              fromColumnObj.elements = fromElements;
              fromColumns[fromColumn] = fromColumnObj;
              fromRowObj.columns = fromColumns;
              rows[fromRowIndex] = fromRowObj;
            } else {
              // Different location, remove from old
              fromColumnObj.elements = fromElements;
              fromColumns[fromColumn] = fromColumnObj;
              fromRowObj.columns = fromColumns;
              rows[fromRowIndex] = fromRowObj;

              // Insert at new location
              const toRowIndex = rows.findIndex(r => r.id === rowId);
              if (toRowIndex !== -1) {
                const toRowObj = { ...rows[toRowIndex] };
                const toColumns = [...(toRowObj.columns || [])];
                const toColumnObj = { ...(toColumns[columnIndex] || {}) };
                const toElements = [...(toColumnObj.elements || [])];

                toElements.splice(insertIndex, 0, movedElement);
                toColumnObj.elements = toElements;
                toColumns[columnIndex] = toColumnObj;
                toRowObj.columns = toColumns;
                rows[toRowIndex] = toRowObj;
              }
            }

            return { ...zone, rows };
          });
        }
      }
      return;
    }

    // Legacy: Handle Custom Page Body Element reordering (for old structure)
    if (active.id && over.id && String(active.id).startsWith('elem-') && String(over.id).startsWith('elem-')) {
      const activePage = customPages.find(p => p.id === activeCustomPageId);
      if (activePage && activePage.settings?.body?.elements) {
        const elements = activePage.settings.body.elements;
        const oldIndex = elements.findIndex(el => el.id === active.id);
        const newIndex = elements.findIndex(el => el.id === over.id);

        if (oldIndex !== -1 && newIndex !== -1 && oldIndex !== newIndex) {
          const reorderedElements = arrayMove(elements, oldIndex, newIndex);

          setCustomPages(customPages.map(p =>
            p.id === activeCustomPageId
              ? {
                  ...p,
                  settings: {
                    ...p.settings,
                    body: {
                      ...p.settings.body,
                      elements: reorderedElements
                    }
                  }
                }
              : p
          ));
        }
      }
      return;
    }

    // Handle Explorer Outline reordering
    if (active.data.current?.type === 'outline-item' && over.data.current?.type === 'outline-item') {
      if (active.id !== over.id) {
        // Check if we're in detail view with a selected record
        if (view === 'detail' && selectedRecord) {
          // Update detailPageLayouts for the selected record
          setDetailPageLayouts((prev) => {
            const currentLayout = prev[selectedRecord.id] || getDefaultDetailLayout(selectedRecord.id);
            const oldIndex = currentLayout.findIndex(item => item.id === active.id);
            const newIndex = currentLayout.findIndex(item => item.id === over.id);

            if (oldIndex === -1 || newIndex === -1) {
              console.warn('Could not find items in detail layout', { activeId: active.id, overId: over.id });
              return prev;
            }

            // Get the column index of the item being dropped onto
            const targetColumnIndex = currentLayout[newIndex].columnIndex ?? 0;
            const movedItem = currentLayout[oldIndex];

            // Update the moved item's column index if it changed
            const updatedItem = {
              ...movedItem,
              columnIndex: targetColumnIndex
            };

            // Remove from old position and insert at new position
            const layoutWithoutItem = currentLayout.filter((_, idx) => idx !== oldIndex);
            const adjustedNewIndex = newIndex > oldIndex ? newIndex - 1 : newIndex;
            const newLayout = [
              ...layoutWithoutItem.slice(0, adjustedNewIndex),
              updatedItem,
              ...layoutWithoutItem.slice(adjustedNewIndex)
            ];

            return {
              ...prev,
              [selectedRecord.id]: newLayout
            };
          });
          // Priority 1: Success Feedback - Show elegant confirmation
          setSuccessFeedback({ elementId: active.id, timestamp: Date.now() });
          setTimeout(() => setSuccessFeedback(null), 2000);
        } else {
          // Update droppedElements for list view
          setDroppedElements((items) => {
            const oldIndex = items.findIndex(item => item.id === active.id);
            const newIndex = items.findIndex(item => item.id === over.id);

            if (oldIndex === -1 || newIndex === -1) {
              console.warn('Could not find items in dropped elements', { activeId: active.id, overId: over.id });
              return items;
            }

            return arrayMove(items, oldIndex, newIndex);
          });
          // Priority 1: Success Feedback - Show elegant confirmation
          setSuccessFeedback({ elementId: active.id, timestamp: Date.now() });
          setTimeout(() => setSuccessFeedback(null), 2000);
        }
      }
      return;
    }

    // Extract common drop zone data
    const isGap = over.data.current?.type === 'gap';
    const isGridContainer = over.data.current?.type === 'grid-container';
    const isCanvasContainer = over.data.current?.type === 'canvas-container';
    const containerId = over.data.current?.containerId;
    const insertIndex = over.data.current?.insertIndex;
    const context = over.data.current?.context || 'list';
    const recordId = over.data.current?.recordId || null;

    if ((isGridContainer || isCanvasContainer) && containerId) {
      // Handle drop into container
      const isNewCard = active.data.current?.type === 'new-element';

      if (isNewCard) {
        const elementType = active.data.current.elementType;

        // Check if this is a combo
        const comboElement = componentElements.find(el => el.id === elementType && el.type === 'combo');
        const isCombo = !!comboElement;

        // Prepare children to add (single element or multiple for combos)
        const childrenToAdd = [];

        if (isCombo) {
          // Create a child for each element in the combo
          comboElement.elements.forEach((elementId, index) => {
            childrenToAdd.push({
              id: `${elementId}-${Date.now()}-${index}`,
              elementType: elementId,
            });
          });
        } else {
          // Single element
          childrenToAdd.push({
            id: `${elementType}-${Date.now()}`,
            elementType,
          });
        }

        // Add children to container
        setContainerChildren(prev => ({
          ...prev,
          [containerId]: [...(prev[containerId] || []), ...childrenToAdd]
        }));

        // Set initial positions for Grid
        if (isGridContainer) {
          setGridLayouts(prev => {
            const currentLayout = prev[containerId] || { children: [], positions: {} };
            const existingCount = (prev[containerId]?.children || []).length;
            const newPositions = {};
            const newChildren = [];

            childrenToAdd.forEach((child, index) => {
              newChildren.push(child.id);
              newPositions[child.id] = {
                x: 0,
                y: (existingCount + index) * 2,
                w: 4,
                h: 2
              };
            });

            return {
              ...prev,
              [containerId]: {
                ...currentLayout,
                children: [...currentLayout.children, ...newChildren],
                positions: {
                  ...currentLayout.positions,
                  ...newPositions
                }
              }
            };
          });
        }

        // Set initial positions for Canvas
        if (isCanvasContainer) {
          // Determine mode and breakpoint for this container
          const mode = canvasMode[containerId] || 'grid';
          const breakpoint = canvasBreakpoint[containerId] || 'desktop';

          setCanvasLayouts(prev => {
            const currentLayout = prev[containerId] || {
              gridPositions: { desktop: {}, tablet: {}, mobile: {} },
              freeformPositions: { desktop: {}, tablet: {}, mobile: {} }
            };

            if (mode === 'grid') {
              const newGridPositions = {};
              childrenToAdd.forEach((child, index) => {
                newGridPositions[child.id] = {
                  gridColumn: `${1 + (index % 4) * 6} / ${7 + (index % 4) * 6}`,
                  gridRow: `${Math.floor(index / 4) + 1} / ${Math.floor(index / 4) + 2}`,
                  zIndex: 1
                };
              });

              return {
                ...prev,
                [containerId]: {
                  ...currentLayout,
                  gridPositions: {
                    ...currentLayout.gridPositions,
                    [breakpoint]: {
                      ...currentLayout.gridPositions?.[breakpoint],
                      ...newGridPositions
                    }
                  }
                }
              };
            } else {
              const newFreeformPositions = {};
              childrenToAdd.forEach((child, index) => {
                newFreeformPositions[child.id] = {
                  x: 50 + (index * 30),
                  y: 50 + (index * 30),
                  width: 250,
                  height: 150,
                  rotate: 0,
                  zIndex: 1
                };
              });

              return {
                ...prev,
                [containerId]: {
                  ...currentLayout,
                  freeformPositions: {
                    ...currentLayout.freeformPositions,
                    [breakpoint]: {
                      ...currentLayout.freeformPositions?.[breakpoint],
                      ...newFreeformPositions
                    }
                  }
                }
              };
            }
          });
        }
      } else if (!isNewCard) {
        // Handle existing page card being dropped into Canvas container
        const cardId = active.id;

        // Find the card in droppedElements
        const existingCard = droppedElements.find(el => el.id === cardId);
        if (!existingCard) return;

        // Create child element for container
        const childElement = {
          id: `${existingCard.elementType}-${Date.now()}`,
          elementType: existingCard.elementType,
        };

        // Remove from droppedElements
        setDroppedElements(prev => prev.filter(el => el.id !== cardId));

        // Remove from detail page layout if applicable
        if (existingCard.context === 'detail' && existingCard.recordId) {
          setDetailPageLayouts(prev => {
            const currentLayout = prev[existingCard.recordId] || [];
            return {
              ...prev,
              [existingCard.recordId]: currentLayout.filter(item => item.id !== cardId)
            };
          });
        }

        // Add to container children
        setContainerChildren(prev => ({
          ...prev,
          [containerId]: [...(prev[containerId] || []), childElement]
        }));

        // Set initial positions for Canvas
        if (isCanvasContainer) {
          const mode = canvasMode[containerId] || 'grid';
          const breakpoint = canvasBreakpoint[containerId] || 'desktop';

          setCanvasLayouts(prev => {
            const currentLayout = prev[containerId] || {
              gridPositions: { desktop: {}, tablet: {}, mobile: {} },
              freeformPositions: { desktop: {}, tablet: {}, mobile: {} }
            };

            const existingChildren = containerChildren[containerId] || [];
            const index = existingChildren.length;

            if (mode === 'grid') {
              const newPosition = {
                gridColumn: `${1 + (index % 4) * 6} / ${7 + (index % 4) * 6}`,
                gridRow: `${Math.floor(index / 4) + 1} / ${Math.floor(index / 4) + 2}`,
                zIndex: 1
              };

              return {
                ...prev,
                [containerId]: {
                  ...currentLayout,
                  gridPositions: {
                    ...currentLayout.gridPositions,
                    [breakpoint]: {
                      ...currentLayout.gridPositions?.[breakpoint],
                      [childElement.id]: newPosition
                    }
                  }
                }
              };
            } else {
              const newPosition = {
                x: 50 + (index * 30),
                y: 50 + (index * 30),
                width: 250,
                height: 150,
                rotate: 0,
                zIndex: 1
              };

              return {
                ...prev,
                [containerId]: {
                  ...currentLayout,
                  freeformPositions: {
                    ...currentLayout.freeformPositions,
                    [breakpoint]: {
                      ...currentLayout.freeformPositions?.[breakpoint],
                      [childElement.id]: newPosition
                    }
                  }
                }
              };
            }
          });
        }

        // Set initial positions for Grid Layout
        if (isGridContainer) {
          setGridLayouts(prev => {
            const currentLayout = prev[containerId] || { children: [], positions: {} };
            const existingCount = (prev[containerId]?.children || []).length;

            return {
              ...prev,
              [containerId]: {
                ...currentLayout,
                children: [...currentLayout.children, childElement.id],
                positions: {
                  ...currentLayout.positions,
                  [childElement.id]: {
                    x: 0,
                    y: existingCount * 2,
                    w: 4,
                    h: 2
                  }
                }
              }
            };
          });
        }
      }
      return;
    }

    // Handle dragging canvas children OUT of container to page columns
    const isCanvasGridChild = active.data.current?.type === 'canvas-grid-child';
    const isCanvasFreeformChild = active.data.current?.type === 'canvas-freeform-child';

    if ((isCanvasGridChild || isCanvasFreeformChild) && isGap) {
      // Canvas child is being dropped on a gap (page column drop zone)
      const childId = active.data.current?.childId;
      const sourceContainerId = active.data.current?.containerId;
      const breakpoint = active.data.current?.breakpoint;
      const targetColumnIndex = over.data.current?.columnIndex ?? 0;

      if (!childId || !sourceContainerId || insertIndex === undefined) return;

      // Find the child element data
      const childData = containerChildren[sourceContainerId]?.find(c => c.id === childId);
      if (!childData) return;

      // Create a new card for the page
      const newCard = {
        type: 'card',
        id: `${childData.elementType}-${Date.now()}`,
        elementType: childData.elementType,
        context,
        recordId,
        layout: cardSettings[childData.elementType]?.layout || 'list',
        borderWidth: 1,
        columnSpan: 1,
        columnIndex: targetColumnIndex,
        zIndex: childData.elementType === 'spacer' ? 0 : 1,
        ...(childData.elementType === 'spacer' ? { height: 48 } : {})
      };

      // Remove from canvas container children
      setContainerChildren(prev => ({
        ...prev,
        [sourceContainerId]: (prev[sourceContainerId] || []).filter(c => c.id !== childId)
      }));

      // Clean up canvas layout positions
      setCanvasLayouts(prev => {
        const currentLayout = prev[sourceContainerId] || {
          gridPositions: { desktop: {}, tablet: {}, mobile: {} },
          freeformPositions: { desktop: {}, tablet: {}, mobile: {} }
        };

        const newGridPositions = { ...currentLayout.gridPositions };
        const newFreeformPositions = { ...currentLayout.freeformPositions };

        // Remove from all breakpoints
        ['desktop', 'tablet', 'mobile'].forEach(bp => {
          if (newGridPositions[bp]) {
            const { [childId]: removed, ...rest } = newGridPositions[bp];
            newGridPositions[bp] = rest;
          }
          if (newFreeformPositions[bp]) {
            const { [childId]: removed, ...rest } = newFreeformPositions[bp];
            newFreeformPositions[bp] = rest;
          }
        });

        return {
          ...prev,
          [sourceContainerId]: {
            gridPositions: newGridPositions,
            freeformPositions: newFreeformPositions
          }
        };
      });

      // Add to page layout
      if (context === 'detail' && recordId) {
        // Add to detail page layout
        setDroppedElements(prev => [...prev, newCard]);

        setDetailPageLayouts(prev => {
          const currentLayout = prev[recordId] || getDefaultDetailLayout(recordId);
          const columnItems = currentLayout.filter(item => (item.columnIndex ?? 0) === targetColumnIndex);
          const otherItems = currentLayout.filter(item => (item.columnIndex ?? 0) !== targetColumnIndex);

          columnItems.splice(insertIndex, 0, newCard);

          return { ...prev, [recordId]: [...otherItems, ...columnItems] };
        });
      } else {
        // Add to list view
        setDroppedElements(prev => {
          const otherCards = prev.filter(e =>
            !(e.context === context && (context === 'list' || e.recordId === recordId))
          );
          const contextCards = prev.filter(e =>
            e.context === context && (context === 'list' || e.recordId === recordId)
          );

          contextCards.splice(insertIndex, 0, newCard);

          return [...otherCards, ...contextCards];
        });
      }

      return;
    }

    // Handle dragging existing canvas grid children (within same container)
    if (isCanvasGridChild && !isGap) {
      const childId = active.data.current?.childId;
      const containerId = active.data.current?.containerId;
      const breakpoint = active.data.current?.breakpoint;
      const getPosition = active.data.current?.getPosition;
      const gridConfig = active.data.current?.gridConfig;

      if (!childId || !containerId || !getPosition || !gridConfig) return;

      // Find container element by data attribute (more reliable than over.data)
      const containerElement = document.querySelector(`[data-container-id="${containerId}"]`);
      if (!containerElement) {
        console.warn(`Canvas grid container not found: ${containerId}`);
        return;
      }

      const { delta, activatorEvent } = event;
      const currentPosition = getPosition();

      // Grid mode: calculate new grid position with snapping using container-relative coordinates
      if (delta && currentPosition && activatorEvent) {
        const containerRect = containerElement.getBoundingClientRect();

        // Get the dragged element to calculate grab offset
        const draggedElement = active.node?.element;

        // Calculate initial grab offset (where on the element was clicked)
        let grabOffsetX = 0;
        let grabOffsetY = 0;

        if (draggedElement) {
          const elementRect = draggedElement.getBoundingClientRect();
          const initialMouseX = activatorEvent instanceof MouseEvent
            ? activatorEvent.clientX
            : activatorEvent.touches?.[0]?.clientX;
          const initialMouseY = activatorEvent instanceof MouseEvent
            ? activatorEvent.clientY
            : activatorEvent.touches?.[0]?.clientY;

          if (initialMouseX !== undefined && initialMouseY !== undefined) {
            grabOffsetX = initialMouseX - elementRect.left;
            grabOffsetY = initialMouseY - elementRect.top;
          }
        }

        // Calculate final mouse position (viewport coordinates)
        const finalMouseX = (activatorEvent instanceof MouseEvent
          ? activatorEvent.clientX
          : activatorEvent.touches?.[0]?.clientX || 0) + delta.x;
        const finalMouseY = (activatorEvent instanceof MouseEvent
          ? activatorEvent.clientY
          : activatorEvent.touches?.[0]?.clientY || 0) + delta.y;

        // Calculate where the element's top-left should be (accounting for grab offset)
        // Note: Both finalMouse and containerRect are in viewport coordinates, so no scroll adjustment needed
        let elementTopLeftX = finalMouseX - grabOffsetX - containerRect.left;
        let elementTopLeftY = finalMouseY - grabOffsetY - containerRect.top;

        // Calculate actual column width from container
        const contentWidth = containerRect.width - (gridConfig.gap * 2);
        const columnWidth = (contentWidth - (gridConfig.gap * (gridConfig.columns - 1))) / gridConfig.columns;

        // Calculate which column/row the element's top-left corresponds to
        // Account for the initial gap (container padding) in the calculation
        const colIndex = Math.max(0, Math.round((elementTopLeftX - gridConfig.gap) / (columnWidth + gridConfig.gap)));
        const rowIndex = Math.max(0, Math.round((elementTopLeftY - gridConfig.gap) / (gridConfig.rowHeight + gridConfig.gap)));

        // Parse current grid position to maintain span
        const [colStart, colEnd] = currentPosition.gridColumn.split(' / ').map(v => parseInt(v) || 1);
        const colSpan = colEnd - colStart;

        const currentRow = currentPosition.gridRow.split(' / ');
        let rowStart = currentRow[0] === 'auto' ? 1 : parseInt(currentRow[0]) || 1;
        let rowEnd = currentRow[1] === 'auto' ? rowStart + 1 : parseInt(currentRow[1]) || rowStart + 1;
        const rowSpan = rowEnd - rowStart;

        // Calculate new position (1-indexed for CSS Grid)
        let newColStart = Math.max(1, colIndex + 1);
        let newColEnd = newColStart + colSpan;

        // Clamp to grid bounds
        if (newColEnd > gridConfig.columns + 1) {
          newColEnd = gridConfig.columns + 1;
          newColStart = newColEnd - colSpan;
        }

        let newRowStart = Math.max(1, rowIndex + 1);
        let newRowEnd = newRowStart + rowSpan;

        // Update position
        setCanvasLayouts(prev => {
          const currentLayout = prev[containerId] || {
            gridPositions: { desktop: {}, tablet: {}, mobile: {} },
            freeformPositions: { desktop: {}, tablet: {}, mobile: {} }
          };

          return {
            ...prev,
            [containerId]: {
              ...currentLayout,
              gridPositions: {
                ...currentLayout.gridPositions,
                [breakpoint]: {
                  ...currentLayout.gridPositions?.[breakpoint],
                  [childId]: {
                    gridColumn: `${newColStart} / ${newColEnd}`,
                    gridRow: `${newRowStart} / ${newRowEnd}`,
                    zIndex: currentPosition.zIndex || 1
                  }
                }
              }
            }
          };
        });
      }
      return;
    }

    // Handle dragging existing canvas freeform children (within same container)
    if (isCanvasFreeformChild && !isGap) {
      const childId = active.data.current?.childId;
      const containerId = active.data.current?.containerId;
      const breakpoint = active.data.current?.breakpoint;
      const getPosition = active.data.current?.getPosition;

      if (!childId || !containerId || !getPosition) return;

      // Get container element to calculate accurate positioning
      // For freeform, we might drop outside the container, so we use the containerId to look it up
      let containerElement = over?.data.current?.getContainerElement?.();

      // If we didn't drop over the container, try to find it by containerId
      if (!containerElement) {
        // Look for the container in the DOM
        const containerNode = document.querySelector(`[data-container-id="${containerId}"]`);
        if (containerNode) {
          containerElement = containerNode;
        } else {
          // Fallback to delta-based positioning if container not found
          const { delta } = event;
          const currentPosition = getPosition();

          if (delta && currentPosition) {
            setCanvasLayouts(prev => {
              const currentLayout = prev[containerId] || {
                gridPositions: { desktop: {}, tablet: {}, mobile: {} },
                freeformPositions: { desktop: {}, tablet: {}, mobile: {} }
              };

              return {
                ...prev,
                [containerId]: {
                  ...currentLayout,
                  freeformPositions: {
                    ...currentLayout.freeformPositions,
                    [breakpoint]: {
                      ...currentLayout.freeformPositions?.[breakpoint],
                      [childId]: {
                        ...currentPosition,
                        x: currentPosition.x + delta.x,
                        y: currentPosition.y + delta.y
                      }
                    }
                  }
                }
              };
            });
          }
          return;
        }
      }

      const { delta, activatorEvent } = event;
      const currentPosition = getPosition();

      // Freeform mode: calculate new position using container-relative coordinates
      if (delta && currentPosition && activatorEvent && containerElement) {
        const containerRect = containerElement.getBoundingClientRect();

        // For freeform mode, use a consistent center-based offset for predictable UX
        // This ensures the element always follows the mouse at the same relative position
        const grabOffsetX = currentPosition.width / 2;
        const grabOffsetY = currentPosition.height / 2;

        // Calculate final mouse position (viewport coordinates)
        const finalMouseX = (activatorEvent instanceof MouseEvent
          ? activatorEvent.clientX
          : activatorEvent.touches?.[0]?.clientX || 0) + delta.x;
        const finalMouseY = (activatorEvent instanceof MouseEvent
          ? activatorEvent.clientY
          : activatorEvent.touches?.[0]?.clientY || 0) + delta.y;

        // Calculate where the element's top-left should be (with center-based offset)
        // Note: Both finalMouse and containerRect are in viewport coordinates, so no scroll adjustment needed
        let newX = finalMouseX - grabOffsetX - containerRect.left;
        let newY = finalMouseY - grabOffsetY - containerRect.top;

        // Clamp to container bounds to prevent dragging outside the canvas
        newX = Math.max(0, Math.min(newX, containerRect.width - currentPosition.width));
        newY = Math.max(0, Math.min(newY, containerRect.height - currentPosition.height));

        setCanvasLayouts(prev => {
          const currentLayout = prev[containerId] || {
            gridPositions: { desktop: {}, tablet: {}, mobile: {} },
            freeformPositions: { desktop: {}, tablet: {}, mobile: {} }
          };

          return {
            ...prev,
            [containerId]: {
              ...currentLayout,
              freeformPositions: {
                ...currentLayout.freeformPositions,
                [breakpoint]: {
                  ...currentLayout.freeformPositions?.[breakpoint],
                  [childId]: {
                    ...currentPosition,
                    x: newX,
                    y: newY
                  }
                }
              }
            }
          };
        });
      }
      return;
    }

    // Check if this is a new card from the panel or existing card/section
    const isNewCard = active.data.current?.type === 'new-element';
    const isSection = active.data.current?.type === 'section';

    // Extract zone information for zone-aware operations
    const targetZoneName = over.data.current?.zoneName;
    const sourceZoneName = active.data.current?.zoneName;
    const targetColumnIndex = over.data.current?.columnIndex ?? 0;

    // Handle zone-aware operations (header/footer zones)
    if (context === 'detail' && recordId && targetZoneName && (targetZoneName === 'header' || targetZoneName === 'footer')) {
      // Determine insertion index - if dropping on element (not gap), place after it
      let finalInsertIndex = insertIndex;
      if (!isGap && over.data.current?.type === 'existing-element') {
        // Find the element's position in its column and insert after it
        const targetRowId = over.data.current?.rowId;
        const overColumnIndex = over.data.current?.columnIndex ?? 0;

        setPageSettings(prev => {
          const zone = prev.detail.zones[targetZoneName];
          const row = zone.rows.find(r => r.id === targetRowId) || zone.rows[0];
          const elements = row.elements || [];
          const columnElements = elements.filter(e => (e.columnIndex ?? 0) === overColumnIndex);
          const overElementIndex = columnElements.findIndex(e => e.id === over.id);

          if (overElementIndex >= 0) {
            finalInsertIndex = overElementIndex + 1;
          }
          return prev;
        });
      }

      if (isNewCard) {
        // Adding new element from panel to header/footer zone
        const elementType = active.data.current.elementType;
        const newElement = {
          id: `${elementType}-${Date.now()}`,
          type: elementType,
          visible: true,
          columnIndex: targetColumnIndex,
        };

        // Update pageSettings to add element to zone
        setPageSettings(prev => {
          const zone = prev.detail.zones[targetZoneName];
          // Find the target row - use the row that contains the drop target
          const targetRowId = over.data.current?.rowId;
          const targetRow = zone.rows.find(r => r.id === targetRowId) || zone.rows[0];
          const elements = targetRow.elements || [];

          // Calculate proper insertion position
          const newElements = [...elements];
          if (isGap && insertIndex !== undefined) {
            // Inserting at gap - find the correct position in the full array
            const columnElements = elements.filter(e => (e.columnIndex ?? 0) === targetColumnIndex);
            const beforeElements = elements.filter(e => (e.columnIndex ?? 0) < targetColumnIndex);
            const actualIndex = beforeElements.length + Math.min(insertIndex, columnElements.length);
            newElements.splice(actualIndex, 0, newElement);
          } else {
            // Just add to the end
            newElements.push(newElement);
          }

          return {
            ...prev,
            detail: {
              ...prev.detail,
              zones: {
                ...prev.detail.zones,
                [targetZoneName]: {
                  ...zone,
                  rows: zone.rows.map(r =>
                    r.id === targetRow.id
                      ? { ...r, elements: newElements }
                      : r
                  )
                }
              }
            }
          };
        });
      } else if (!isSection) {
        // Reordering existing element within or between zones
        if (active.id === over.id) return;

        // First, handle removing from body zone if needed (before other state updates)
        if (sourceZoneName === 'body' || !sourceZoneName) {
          setDetailPageLayouts(prevLayouts => {
            const currentLayout = prevLayouts[recordId] || [];
            return {
              ...prevLayouts,
              [recordId]: currentLayout.filter(item => item.id !== active.id)
            };
          });
        }

        // Handle moving between zones or within same zone
        setPageSettings(prev => {
          // Find the source zone, row, and element
          let sourceZone = null;
          let sourceRow = null;
          let movedElement = null;
          let sourceRowId = null;

          if (sourceZoneName && (sourceZoneName === 'header' || sourceZoneName === 'footer')) {
            // Moving from header/footer zone
            sourceZone = prev.detail.zones[sourceZoneName];
            sourceRowId = active.data.current?.rowId;
            sourceRow = sourceZone.rows.find(r => r.id === sourceRowId) || sourceZone.rows[0];
            const elements = sourceRow.elements || [];
            movedElement = elements.find(e => e.id === active.id);
          } else if (sourceZoneName === 'body' || !sourceZoneName) {
            // Moving from body zone to header/footer - convert to zone element
            const elementType = active.data.current?.elementType || active.id.split('-')[0];
            movedElement = {
              id: active.id, // Keep the same ID
              type: elementType,
              visible: true,
              columnIndex: targetColumnIndex,
            };
            // Body removal already handled above
          }

          if (!movedElement) return prev;

          // Get target zone and row
          const targetZone = prev.detail.zones[targetZoneName];
          const targetRowId = over.data.current?.rowId;
          const targetRow = targetZone.rows.find(r => r.id === targetRowId) || targetZone.rows[0];

          // Update moved element with new column index
          const updatedElement = { ...movedElement, columnIndex: targetColumnIndex };

          // Build updated zones
          const updatedZones = { ...prev.detail.zones };

          // Update target zone
          updatedZones[targetZoneName] = {
            ...targetZone,
            rows: targetZone.rows.map(row => {
              if (row.id !== targetRow.id) {
                // Not the target row
                if (sourceZoneName === targetZoneName && sourceRow && row.id === sourceRow.id) {
                  // This is the source row in the same zone - remove the element
                  return {
                    ...row,
                    elements: (row.elements || []).filter(e => e.id !== active.id)
                  };
                }
                return row;
              }

              // This is the target row - insert the element
              let elements = row.elements || [];

              // If moving within same row, remove first
              if (sourceZoneName === targetZoneName && sourceRow && row.id === sourceRow.id) {
                elements = elements.filter(e => e.id !== active.id);
              }

              // Calculate insertion position
              const newElements = [...elements];
              if (isGap && insertIndex !== undefined) {
                // Find the correct position in the full array
                const columnElements = elements.filter(e => (e.columnIndex ?? 0) === targetColumnIndex);
                const beforeElements = elements.filter(e => (e.columnIndex ?? 0) < targetColumnIndex);
                const actualIndex = beforeElements.length + Math.min(insertIndex, columnElements.length);
                newElements.splice(actualIndex, 0, updatedElement);
              } else {
                // Add to end
                newElements.push(updatedElement);
              }

              return {
                ...row,
                elements: newElements
              };
            })
          };

          // Update source zone if different from target
          if (sourceZoneName !== targetZoneName && sourceZoneName && (sourceZoneName === 'header' || sourceZoneName === 'footer')) {
            updatedZones[sourceZoneName] = {
              ...sourceZone,
              rows: sourceZone.rows.map(row =>
                row.id === sourceRow.id
                  ? { ...row, elements: (row.elements || []).filter(e => e.id !== active.id) }
                  : row
              )
            };
          }

          return {
            ...prev,
            detail: {
              ...prev.detail,
              zones: updatedZones
            }
          };
        });
      }
      return;
    }

    // Handle detail page layout (unified sections + cards) with column support
    if (context === 'detail' && recordId) {
      // Special handling: Moving FROM header/footer zones TO body zone
      if (!isNewCard && !isSection && sourceZoneName && (sourceZoneName === 'header' || sourceZoneName === 'footer') && targetZoneName === 'body') {
        // Moving from header/footer to body
        const elementType = active.data.current?.elementType || active.id.split('-')[0];
        const newBodyElement = {
          type: 'card',
          id: active.id, // Keep same ID
          elementType,
          context,
          recordId,
          layout: cardSettings[elementType]?.layout || 'list',
          borderWidth: 1,
          columnSpan: 1,
          columnIndex: targetColumnIndex,
          zIndex: elementType === 'spacer' ? 0 : 1,
          ...(elementType === 'spacer' ? { height: 48 } : {})
        };

        // Create unique drop ID for React StrictMode deduplication (no timestamp - must be stable)
        const dropOperationId = `header-footer-to-body-${active.id}-${recordId}-${targetColumnIndex}-${insertIndex}`;

        // Add to body zone (detailPageLayouts)
        setDetailPageLayouts(prev => {
          // Get the layout we'll be working with (includes default if needed)
          const layoutForInsertion = prev[recordId] || getDefaultDetailLayout(recordId);

          // Check if element already exists - make operation idempotent for StrictMode
          const alreadyExists = layoutForInsertion.some(item => item.id === active.id);

          if (alreadyExists) {
            // Return updated state if it exists, otherwise prev
            return prev[recordId] ? prev : { ...prev, [recordId]: layoutForInsertion };
          }

          if (isGap && insertIndex !== undefined) {
            // Calculate actual insertion position in the full layout array
            const itemsBeforeColumn = layoutForInsertion.filter(item => (item.columnIndex ?? 0) < targetColumnIndex).length;
            const itemsInColumn = layoutForInsertion.filter(item => (item.columnIndex ?? 0) === targetColumnIndex).length;
            const actualIndex = itemsBeforeColumn + Math.min(insertIndex, itemsInColumn);

            const newLayout = [...layoutForInsertion];
            // Final idempotency check before splicing
            if (!newLayout.some(item => item.id === newBodyElement.id)) {
              newLayout.splice(actualIndex, 0, newBodyElement);
            }

            return { ...prev, [recordId]: newLayout };
          } else {
            // Add to end
            const newLayout = [...layoutForInsertion];
            // Final idempotency check before adding
            if (!newLayout.some(item => item.id === newBodyElement.id)) {
              newLayout.push(newBodyElement);
            }

            return { ...prev, [recordId]: newLayout };
          }
        });

        // Remove from source zone (header/footer)
        setPageSettings(prev => {
          const sourceZone = prev.detail.zones[sourceZoneName];
          const sourceRowId = active.data.current?.rowId;
          const sourceRow = sourceZone.rows.find(r => r.id === sourceRowId) || sourceZone.rows[0];

          return {
            ...prev,
            detail: {
              ...prev.detail,
              zones: {
                ...prev.detail.zones,
                [sourceZoneName]: {
                  ...sourceZone,
                  rows: sourceZone.rows.map(row =>
                    row.id === sourceRow.id
                      ? { ...row, elements: (row.elements || []).filter(e => e.id !== active.id) }
                      : row
                  )
                }
              }
            }
          };
        });

        // Add to droppedElements for reference
        setDroppedElements(prev => {
          const exists = prev.find(e => e.id === active.id);
          return exists ? prev : [...prev, newBodyElement];
        });

        return;
      }

      if (isNewCard && isGap && insertIndex !== undefined) {
        // Adding new card from panel to detail page
        const elementType = active.data.current.elementType;

        // Check if this is a combo - if so, expand it to multiple cards
        const comboElement = componentElements.find(el => el.id === elementType && el.type === 'combo');
        const isCombo = !!comboElement;

        // Prepare cards to add (single element or multiple for combos)
        const cardsToAdd = [];

        if (isCombo) {
          // Create a card for each element in the combo
          comboElement.elements.forEach((elementId, index) => {
            const cardId = `${elementId}-${Date.now()}-${index}`;
            cardsToAdd.push({
              type: 'card',
              id: cardId,
              elementType: elementId,
              context,
              recordId,
              layout: cardSettings[elementId]?.layout || 'list',
              borderWidth: 1,
              columnSpan: 1,
              columnIndex: targetColumnIndex,
              zIndex: elementId === 'spacer' ? 0 : 1, // Spacers behind, others in front
              ...(elementId === 'spacer' ? { height: 48 } : {})
            });
          });
        } else {
          // Single element
          const cardId = `${elementType}-${Date.now()}`;
          cardsToAdd.push({
            type: 'card',
            id: cardId,
            elementType,
            context,
            recordId,
            layout: cardSettings[elementType]?.layout || 'list',
            borderWidth: 1,
            columnSpan: 1,
            columnIndex: targetColumnIndex,
            zIndex: elementType === 'spacer' ? 0 : 1, // Spacers behind, others in front
            ...(elementType === 'spacer' ? { height: 48 } : {})
          });
        }

        // Add to droppedElements (for reference)
        setDroppedElements(prev => [...prev, ...cardsToAdd]);

        // Add to unified layout at specified position
        setDetailPageLayouts(prev => {
          // Use helper function instead of inline array (avoids stale closure)
          const currentLayout = prev[recordId] || getDefaultDetailLayout(recordId);

          // Filter items in target column to calculate correct insert position
          const columnItems = currentLayout.filter(item => (item.columnIndex ?? 0) === targetColumnIndex);
          const otherItems = currentLayout.filter(item => (item.columnIndex ?? 0) !== targetColumnIndex);

          // Insert all cards at the specified index
          columnItems.splice(insertIndex, 0, ...cardsToAdd);

          const newLayout = [...otherItems, ...columnItems];
          console.log('LAYOUT AFTER ADD:', {
            totalItems: newLayout.length,
            addedCards: cardsToAdd.map(c => c.id),
            isCombo,
            columnItems: newLayout.filter(i => (i.columnIndex ?? 0) === targetColumnIndex).map(i => i.id)
          });

          // Merge back together
          return { ...prev, [recordId]: newLayout };
        });
      } else if (!isNewCard && !isSection) {
        // Reordering existing card within or between columns in body zone
        if (active.id === over.id) return;

        const sourceColumnIndex = active.data.current?.columnIndex ?? 0;

        setDetailPageLayouts(prev => {
          const currentLayout = prev[recordId] || getDefaultDetailLayout(recordId);
          const oldIndex = currentLayout.findIndex(item => item.id === active.id);
          if (oldIndex === -1) return prev;

          const movedItem = currentLayout[oldIndex];

          // Remove from old position
          const layoutWithoutItem = currentLayout.filter((_, idx) => idx !== oldIndex);

          // Update column assignment
          const updatedItem = { ...movedItem, columnIndex: targetColumnIndex };

          // Calculate actual insertion position in full array
          const itemsBeforeColumn = layoutWithoutItem.filter(item => (item.columnIndex ?? 0) < targetColumnIndex).length;
          const itemsInColumn = layoutWithoutItem.filter(item => (item.columnIndex ?? 0) === targetColumnIndex).length;

          // Adjust index if moving within same column
          const adjustedIndex = (sourceColumnIndex === targetColumnIndex && oldIndex < insertIndex) ? insertIndex - 1 : insertIndex;
          const actualIndex = itemsBeforeColumn + Math.min(adjustedIndex, itemsInColumn);

          // Insert at calculated position
          const newLayout = [...layoutWithoutItem];
          newLayout.splice(actualIndex, 0, updatedItem);

          return { ...prev, [recordId]: newLayout };
        });
      } else if (isSection) {
        // Reordering section within or between columns
        if (active.id === over.id) return;

        const sourceColumnIndex = active.data.current?.columnIndex ?? 0;

        setDetailPageLayouts(prev => {
          const currentLayout = prev[recordId] || getDefaultDetailLayout(recordId);
          const oldIndex = currentLayout.findIndex(item => item.id === active.id);
          if (oldIndex === -1) return prev;

          const movedItem = currentLayout[oldIndex];

          // Remove from old position
          const layoutWithoutItem = currentLayout.filter((_, idx) => idx !== oldIndex);

          // Update column assignment
          const updatedItem = { ...movedItem, columnIndex: targetColumnIndex };

          // Calculate actual insertion position in full array
          const itemsBeforeColumn = layoutWithoutItem.filter(item => (item.columnIndex ?? 0) < targetColumnIndex).length;
          const itemsInColumn = layoutWithoutItem.filter(item => (item.columnIndex ?? 0) === targetColumnIndex).length;

          // Adjust index if moving within same column
          const adjustedIndex = (sourceColumnIndex === targetColumnIndex && oldIndex < insertIndex) ? insertIndex - 1 : insertIndex;
          const actualIndex = itemsBeforeColumn + Math.min(adjustedIndex, itemsInColumn);

          // Insert at calculated position
          const newLayout = [...layoutWithoutItem];
          newLayout.splice(actualIndex, 0, updatedItem);

          return { ...prev, [recordId]: newLayout };
        });
      }
      return;
    }

    // Handle list view (old logic for backwards compatibility)
    if (isNewCard) {
      // Adding new card from panel
      const elementType = active.data.current.elementType;
      const cardId = `${elementType}-${Date.now()}`;
      const newCard = {
        id: cardId,
        elementType,
        context,
        recordId,
        layout: cardSettings[elementType]?.layout || 'list',
        borderWidth: 1,
        columnSpan: 1,
        ...(elementType === 'spacer' ? { height: 48 } : {})
      };

      if (isGap && insertIndex !== undefined) {
        // Insert at specific position
        setDroppedElements(prev => {
          const otherCards = prev.filter(e =>
            !(e.context === context && (context === 'list' || e.recordId === recordId))
          );
          const contextCards = prev.filter(e =>
            e.context === context && (context === 'list' || e.recordId === recordId)
          );

          // Insert at the specified index
          contextCards.splice(insertIndex, 0, newCard);

          return [...otherCards, ...contextCards];
        });
      } else {
        // Append to end if no specific position
        setDroppedElements(prev => [...prev, newCard]);
      }
    } else {
      // Reordering existing card
      if (active.id === over.id) {
        return;
      }

      setDroppedElements((cards) => {
        // Filter cards for current context
        const contextCards = cards.filter(e =>
          e.context === context && (context === 'list' || e.recordId === recordId)
        );

        const oldIndex = contextCards.findIndex(e => e.id === active.id);

        if (oldIndex === -1) return cards;

        let newIndex;
        if (isGap && insertIndex !== undefined) {
          // Use the insert index from gap
          newIndex = insertIndex;
          // Adjust if dragging downward (removed item shifts indices)
          if (oldIndex < insertIndex) {
            newIndex = insertIndex - 1;
          }
        } else {
          // Dropped on another card
          newIndex = contextCards.findIndex(e => e.id === over.id);
          if (newIndex === -1) return cards;
        }

        // Reorder within context
        const reorderedContextCards = arrayMove(contextCards, oldIndex, newIndex);

        // Merge back with other contexts
        const otherCards = cards.filter(e =>
          !(e.context === context && (context === 'list' || e.recordId === recordId))
        );

        return [...otherCards, ...reorderedContextCards];
      });
    }
    } catch (error) {
      console.error('Drag operation failed:', error);

      // Reset to safe state
      setActiveElementId(null);
      setActiveOutlineItemId(null);
      setOverOutlineItemId(null);
      setDragPreviewPosition(null);

      // Show user-friendly error
      showToast('Oops! Something went wrong with the drag operation. Please try again.', 'error');

      // Log error details for debugging
      if (event?.active?.id && event?.over?.id) {
        console.error('Drag error details:', {
          activeId: event.active.id,
          overId: event.over.id,
          activeData: event.active.data.current,
          overData: event.over.data.current
        });
      }
    }
  };

  // Initialize container layouts on first render
  useEffect(() => {
    // Find all dropped container cards and initialize them if needed
    droppedElements.forEach(element => {
      const elementDef = componentElements.find(e => e.id === element.elementType);
      if (elementDef?.isContainer) {
        if (element.elementType === 'kanban-layout' && !kanbanLayouts[element.id]) {
          setKanbanLayouts(prev => ({
            ...prev,
            [element.id]: {
              columns: [
                { id: 'col-1', title: 'To Do', cardIds: [] },
                { id: 'col-2', title: 'In Progress', cardIds: [] },
                { id: 'col-3', title: 'Done', cardIds: [] },
              ]
            }
          }));
        } else if (element.elementType === 'grid-layout' && !gridLayouts[element.id]) {
          setGridLayouts(prev => ({
            ...prev,
            [element.id]: { children: [], positions: {} }
          }));
        } else if (element.elementType === 'canvas-layout' && !canvasLayouts[element.id]) {
          setCanvasLayouts(prev => ({
            ...prev,
            [element.id]: { children: [], positions: {} }
          }));
        }

        // Initialize container children tracking
        if (!containerChildren[element.id]) {
          setContainerChildren(prev => ({
            ...prev,
            [element.id]: []
          }));
        }
      }
    });
  }, [droppedElements, kanbanLayouts, gridLayouts, canvasLayouts]);

  // Render Container Card (Kanban, Grid, Canvas)
  const renderContainerElement = (element, elementDef, context, recordId = null) => {
    // Get record data if recordId is provided
    const record = recordId ? mockRecords.find(r => r.id === recordId) : null;

    const containerContent = (() => {
      switch (element.elementType) {
        case 'kanban-layout':
          const kanbanData = kanbanLayouts[element.id] || { columns: [] };
          const kanbanColumns = kanbanData?.columns || [];
          return (
            <div className="bg-white rounded-lg border-2 border-neutral-200 p-6">
              <div className="flex items-center justify-between mb-6">
                <h3 className="text-lg font-semibold text-neutral-900 flex items-center gap-2">
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    {getIconSvg(elementDef.icon)}
                  </svg>
                  {elementDef.name}
                </h3>
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    // Add new column
                    const newColumn = {
                      id: `col-${Date.now()}`,
                      title: 'New Column',
                      cardIds: []
                    };
                    setKanbanLayouts(prev => ({
                      ...prev,
                      [element.id]: {
                        ...prev[element.id],
                        columns: [...(prev[element.id]?.columns || []), newColumn]
                      }
                    }));
                  }}
                  className="text-sm text-neutral-600 hover:text-neutral-900 flex items-center gap-1"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 4v16m8-8H4" />
                  </svg>
                  Add Column
                </button>
              </div>
              <div className="flex gap-4 overflow-x-auto pb-4">
                {kanbanColumns.map((column, colIdx) => (
                  <div key={column.id} className="flex-shrink-0 w-80">
                    <div className="bg-neutral-50 rounded-lg p-4">
                      <div className="flex items-center justify-between mb-4">
                        <input
                          type="text"
                          value={column.title}
                          onChange={(e) => {
                            setKanbanLayouts(prev => ({
                              ...prev,
                              [element.id]: {
                                ...prev[element.id],
                                columns: prev[element.id].columns.map((col, idx) =>
                                  idx === colIdx ? { ...col, title: e.target.value } : col
                                )
                              }
                            }));
                          }}
                          className="font-semibold text-neutral-900 bg-transparent border-none focus:outline-none focus:ring-2 focus:ring-neutral-900 rounded px-2 py-1"
                        />
                        <span className="text-xs text-neutral-500">
                          {(column.cardIds || []).length}
                        </span>
                      </div>
                      <div className="space-y-2 min-h-[200px]">
                        {(column.cardIds || []).map((cardId) => (
                          <div key={cardId} className="bg-white rounded-lg p-3 shadow-sm border border-neutral-200">
                            <p className="text-sm text-neutral-900">Card {cardId}</p>
                          </div>
                        ))}
                        <button
                          onClick={() => {
                            const newCardId = `card-${Date.now()}`;
                            setKanbanLayouts(prev => ({
                              ...prev,
                              [element.id]: {
                                ...prev[element.id],
                                columns: prev[element.id].columns.map((col, idx) =>
                                  idx === colIdx
                                    ? { ...col, cardIds: [...col.cardIds, newCardId] }
                                    : col
                                )
                              }
                            }));
                          }}
                          className="w-full py-2 text-sm text-neutral-600 hover:text-neutral-900 hover:bg-white rounded-lg border-2 border-dashed border-neutral-300 hover:border-neutral-400 transition-colors"
                        >
                          + Add Card
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          );

        case 'grid-layout':
          const gridChildren = containerChildren[element.id] || [];
          const currentGridSettings = gridSettings[element.id];

          return (
            <div
              className="bg-white rounded-lg border-neutral-200 p-6"
              style={{
                borderWidth: `${element.borderWidth ?? 2}px`,
                borderStyle: 'solid',
              }}
            >
              <div className="flex items-center justify-between mb-6">
                <h3 className="text-lg font-semibold text-neutral-900 flex items-center gap-2">
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    {getIconSvg(elementDef.icon)}
                  </svg>
                  {elementDef.name}
                </h3>
                <div className="flex items-center gap-4">
                  <div className="text-xs text-neutral-500">
                    {gridChildren.length} element{gridChildren.length !== 1 ? 's' : ''}
                  </div>
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      setSelectedElementForSettings(element.id);
                      setRightPanelTab('settings');
                    }}
                    className="text-xs text-neutral-600 hover:text-neutral-900 flex items-center gap-1 px-2 py-1 rounded hover:bg-neutral-100 transition-colors"
                    title="Grid Settings"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065zM15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Settings
                  </button>
                </div>
              </div>
              <GridLayoutDropZone
                elementId={element.id}
                gridChildren={gridChildren}
                gridLayouts={gridLayouts}
                pageSettings={pageSettings}
                context={context}
                componentElements={componentElements}
                setGridLayouts={setGridLayouts}
                record={record}
                renderElementContent={renderElementContent}
                gridSettings={currentGridSettings}
              />
            </div>
          );

        case 'canvas-layout':
          /**
           * CANVAS LAYOUT - DUAL MODE SYSTEM
           *
           * This implementation provides a competitive advantage over Squarespace Fluid Engine
           * by offering BOTH grid-based and freeform positioning modes.
           *
           * MODES:
           * 1. Grid Mode - Squarespace Fluid Engine parity
           *    - Uses CSS Grid with 24 columns (desktop), 12 (tablet), 8 (mobile)
           *    - Content flow logic with grid-based positioning
           *    - Automatic alignment and responsive behavior
           *    - Best for: Novice users, content-heavy layouts, responsive designs
           *
           * 2. Freeform Mode - Competitive advantage
           *    - Pixel-perfect absolute positioning
           *    - React Moveable for drag, resize, rotate controls
           *    - Grid snapping for precision
           *    - Best for: Expert users, graphic design, custom layouts
           *
           * FEATURES:
           * - Per-container mode selection (grid OR freeform)
           * - Per-breakpoint layouts (desktop/tablet/mobile)
           * - Visual grid overlay for guidance
           * - Position conversion helpers (grid â†” freeform)
           * - Selection state management
           * - Real-time position updates
           *
           * STATE STRUCTURE:
           * canvasLayouts[containerId] = {
           *   gridPositions: {
           *     desktop: { childId: { gridColumn, gridRow, zIndex } },
           *     tablet: { ... },
           *     mobile: { ... }
           *   },
           *   freeformPositions: {
           *     desktop: { childId: { x, y, width, height, rotate, zIndex } },
           *     tablet: { ... },
           *     mobile: { ... }
           *   }
           * }
           */
          const currentMode = canvasMode[element.id] || 'grid';
          const currentBreakpoint = canvasBreakpoint[element.id] || 'desktop';
          const canvasData = canvasLayouts[element.id] || {
            gridPositions: { desktop: {}, tablet: {}, mobile: {} },
            freeformPositions: { desktop: {}, tablet: {}, mobile: {} }
          };
          const canvasChildren = containerChildren[element.id] || [];

          // Grid configuration based on breakpoint
          const gridConfig = {
            desktop: { columns: 24, rowHeight: 40, gap: 16 },
            tablet: { columns: 12, rowHeight: 40, gap: 12 },
            mobile: { columns: 8, rowHeight: 40, gap: 8 }
          };
          const currentGridConfig = gridConfig[currentBreakpoint];

          // Position conversion helpers
          const convertGridToFreeform = (gridPosition, containerWidth = 1200) => {
            // Parse grid column/row values (e.g., "1 / 7" means columns 1-6)
            const [colStart, colEnd] = gridPosition.gridColumn.split(' / ').map(v => parseInt(v) || 1);
            const columnWidth = (containerWidth - (currentGridConfig.gap * (currentGridConfig.columns + 1))) / currentGridConfig.columns;

            return {
              x: (colStart - 1) * (columnWidth + currentGridConfig.gap) + currentGridConfig.gap,
              y: 0, // Grid row positioning would need additional calculation
              width: (colEnd - colStart) * columnWidth + (colEnd - colStart - 1) * currentGridConfig.gap,
              height: 150, // Default height
              rotate: 0,
              zIndex: gridPosition.zIndex || 1
            };
          };

          const convertFreeformToGrid = (freeformPosition, containerWidth = 1200) => {
            const columnWidth = (containerWidth - (currentGridConfig.gap * (currentGridConfig.columns + 1))) / currentGridConfig.columns;
            const colStart = Math.round(freeformPosition.x / (columnWidth + currentGridConfig.gap)) + 1;
            const colSpan = Math.max(1, Math.round(freeformPosition.width / (columnWidth + currentGridConfig.gap)));

            return {
              gridColumn: `${colStart} / ${colStart + colSpan}`,
              gridRow: 'auto',
              zIndex: freeformPosition.zIndex || 1
            };
          };

          // Callback for updating grid positions (resize) - memoized to prevent unnecessary re-renders
          const handleUpdateGridPosition = React.useCallback((containerId, breakpoint, childId, updates) => {
            setCanvasLayouts(prev => ({
              ...prev,
              [containerId]: {
                ...prev[containerId],
                gridPositions: {
                  ...prev[containerId]?.gridPositions,
                  [breakpoint]: {
                    ...prev[containerId]?.gridPositions?.[breakpoint],
                    [childId]: {
                      ...(prev[containerId]?.gridPositions?.[breakpoint]?.[childId] || {}),
                      ...updates
                    }
                  }
                }
              }
            }));
          }, []);

          // Callback for updating freeform positions - memoized to prevent unnecessary re-renders
          const handleUpdatePosition = React.useCallback((containerId, breakpoint, childId, updates) => {
            setCanvasLayouts(prev => ({
              ...prev,
              [containerId]: {
                ...prev[containerId],
                freeformPositions: {
                  ...prev[containerId]?.freeformPositions,
                  [breakpoint]: {
                    ...prev[containerId]?.freeformPositions?.[breakpoint],
                    [childId]: {
                      ...(prev[containerId]?.freeformPositions?.[breakpoint]?.[childId] || {}),
                      ...updates
                    }
                  }
                }
              }
            }));
          }, []);

          return (
            <div className="bg-white rounded-lg border-2 border-neutral-200 p-6">
              {/* Header with mode and breakpoint controls */}
              <div className="flex items-start justify-between mb-6 gap-6">
                <div className="flex-1">
                  <h3 className="text-lg font-semibold text-neutral-900 flex items-center gap-2 mb-2">
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      {getIconSvg(elementDef.icon)}
                    </svg>
                    {elementDef.name}
                  </h3>
                  <div className="text-xs text-neutral-500">
                    {canvasChildren.length} element{canvasChildren.length !== 1 ? 's' : ''} â€¢ {currentMode} mode â€¢ {currentBreakpoint}
                  </div>
                </div>

                <div className="flex gap-3">
                  {/* Breakpoint selector */}
                  <div className="flex gap-1 bg-neutral-100 rounded-lg p-1">
                    {['desktop', 'tablet', 'mobile'].map((bp) => (
                      <button
                        key={bp}
                        onClick={() => {
                          setCanvasBreakpoint(prev => ({
                            ...prev,
                            [element.id]: bp
                          }));
                        }}
                        className={`px-3 py-1.5 rounded text-xs font-medium transition-colors ${
                          currentBreakpoint === bp
                            ? 'bg-white text-neutral-900 shadow-sm'
                            : 'text-neutral-600 hover:text-neutral-900'
                        }`}
                        title={bp.charAt(0).toUpperCase() + bp.slice(1)}
                      >
                        {bp === 'desktop' && 'ðŸ–¥ï¸'}
                        {bp === 'tablet' && 'ðŸ“±'}
                        {bp === 'mobile' && 'ðŸ“±'}
                      </button>
                    ))}
                  </div>

                  {/* Mode toggle */}
                  <div className="flex gap-1 bg-neutral-100 rounded-lg p-1">
                    <button
                      onClick={() => {
                        setCanvasMode(prev => ({
                          ...prev,
                          [element.id]: 'grid'
                        }));
                      }}
                      className={`px-3 py-1.5 rounded text-xs font-medium transition-colors ${
                        currentMode === 'grid'
                          ? 'bg-white text-neutral-900 shadow-sm'
                          : 'text-neutral-600 hover:text-neutral-900'
                      }`}
                    >
                      Grid
                    </button>
                    <button
                      onClick={() => {
                        setCanvasMode(prev => ({
                          ...prev,
                          [element.id]: 'freeform'
                        }));
                      }}
                      className={`px-3 py-1.5 rounded text-xs font-medium transition-colors ${
                        currentMode === 'freeform'
                          ? 'bg-white text-neutral-900 shadow-sm'
                          : 'text-neutral-600 hover:text-neutral-900'
                      }`}
                    >
                      Freeform
                    </button>
                  </div>
                </div>
              </div>

              {/* Render appropriate container based on mode */}
              {currentMode === 'grid' ? (
                <CanvasGridModeContainer
                  elementId={element.id}
                  canvasData={canvasData}
                  currentBreakpoint={currentBreakpoint}
                  canvasChildren={canvasChildren}
                  currentGridConfig={currentGridConfig}
                  componentElements={componentElements}
                  onUpdateGridPosition={handleUpdateGridPosition}
                  activeElementId={activeElementId}
                  dragPreviewPosition={dragPreviewPosition}
                />
              ) : (
                <CanvasFreeformModeContainer
                  elementId={element.id}
                  canvasData={canvasData}
                  currentBreakpoint={currentBreakpoint}
                  canvasChildren={canvasChildren}
                  currentGridConfig={currentGridConfig}
                  componentElements={componentElements}
                  onUpdatePosition={handleUpdatePosition}
                  activeElementId={activeElementId}
                  dragPreviewPosition={dragPreviewPosition}
                />
              )}
            </div>
          );

        default:
          // Handle preset-based containers (section, container, card, div-block, 3-column)
          if (elementDef.containerPreset) {
            const presetKey = element.containerPreset || elementDef.containerPreset;
            const preset = containerPresets[presetKey];
            const presetStyles = preset?.defaultStyles || {};
            const children = containerChildren[element.id] || [];

            // Special handling for 3-column layout - render actual children
            if (presetKey === '3-column' && children.length > 0) {
              return (
                <div style={presetStyles} className="w-full">
                  {children.map((child, idx) => {
                    const childElementDef = componentElements.find(e => e.id === child.elementType);
                    if (!childElementDef) return null;

                    const content = renderElementContent(child, record);
                    if (!content) return null;

                    return (
                      <div key={child.id} className="bg-white rounded-lg border border-neutral-200 p-6">
                        {content}
                      </div>
                    );
                  })}
                </div>
              );
            }

            // Default placeholder for other container presets
            return (
              <div
                className="bg-white rounded-lg border-2 border-neutral-200 overflow-hidden"
                style={presetStyles}
              >
                <div className="p-6">
                  <h3 className="text-lg font-semibold text-neutral-900 flex items-center gap-2 mb-4">
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      {getIconSvg(elementDef.icon)}
                    </svg>
                    {elementDef.name}
                  </h3>
                  <div className="text-sm text-neutral-500">
                    <p className="mb-2">
                      <strong>Preset:</strong> {preset?.label || 'Custom'}
                    </p>
                    <p className="text-xs text-neutral-400">
                      {preset?.description || 'Configure in settings'}
                    </p>
                  </div>
                  <div className="mt-4 p-4 bg-neutral-50 rounded border-2 border-dashed border-neutral-300 text-center text-neutral-400 text-sm">
                    Container content area ({children.length} children)
                    <br />
                    <span className="text-xs">(Nested elements will appear here)</span>
                  </div>
                </div>
              </div>
            );
          }
          return null;
      }
    })();

    return (
      <div className="relative group">
        {/* Drag handle on hover - top left of card (only in design mode) */}
        {isDesignMode() && (
          <div className="absolute -left-3 top-2 opacity-0 group-hover:opacity-100 transition-opacity cursor-grab active:cursor-grabbing z-10">
            <svg className="w-5 h-5 text-neutral-400" fill="currentColor" viewBox="0 0 20 20">
              <circle cx="7" cy="4" r="1.5" />
              <circle cx="13" cy="4" r="1.5" />
              <circle cx="7" cy="10" r="1.5" />
              <circle cx="13" cy="10" r="1.5" />
              <circle cx="7" cy="16" r="1.5" />
              <circle cx="13" cy="16" r="1.5" />
            </svg>
          </div>
        )}

        {/* Container content */}
        <div onClick={() => {
          // Only handle container clicks in design mode
          if (isDesignMode() && isComponentPanelOpen) {
            setSelectedElementForSettings(element.id);
            setRightPanelTab('settings');
          }
        }}>
          {containerContent}
        </div>
      </div>
    );
  };

  // Auto-spacer helper: Get affected columns by a spanning element
  const getAffectedColumns = (columnIndex, columnSpan) => {
    const affected = [];
    for (let i = 1; i < columnSpan; i++) {
      affected.push(columnIndex + i);
    }
    return affected;
  };

  // Auto-spacer helper: Check if spacers already exist at position
  const checkExistingSpacers = (layout, affectedColumns, elementIndex) => {
    const existing = [];
    affectedColumns.forEach((colIndex) => {
      const columnItems = layout.filter(item => (item.columnIndex ?? 0) === colIndex);
      if (columnItems[elementIndex]) {
        const item = columnItems[elementIndex];
        if (item.type === 'card') {
          const element =droppedElements.find(e => e.id === item.id);
          if (element?.elementType === 'spacer') {
            existing.push(colIndex);
          }
        }
      }
    });
    return existing;
  };

  // Auto-spacer helper: Detect actual collisions with content
  const detectCollisions = (cardId) => {
    if (!selectedRecord?.id || !cardId) {
      return { hasCollision: false, collisions: [] };
    }

    const spanningElement = droppedElements.find(e => e.id === cardId);
    if (!spanningElement || (spanningElement.columnSpan ?? 1) <= 1) {
      return { hasCollision: false, collisions: [] };
    }

    const layout = getAllDetailElements(selectedRecord.id);
    const spanningItem = layout.find(item => item.id === cardId);
    if (!spanningItem) {
      return { hasCollision: false, collisions: [] };
    }

    const sourceColumnIndex = spanningItem.columnIndex ?? 0;
    const affectedColumns = getAffectedColumns(sourceColumnIndex, spanningElement.columnSpan);

    if (affectedColumns.length === 0) {
      return { hasCollision: false, collisions: [] };
    }

    // Check each affected column for ANY non-spacer content
    // When a card spans multiple columns, it visually overlaps ALL content in those columns
    const collisions = [];
    affectedColumns.forEach((colIndex) => {
      const columnItems = layout.filter(item => (item.columnIndex ?? 0) === colIndex);

      columnItems.forEach((item, idx) => {
        if (item.type === 'card') {
          const element =droppedElements.find(e => e.id === item.id);
          // Count as collision if it's a real card (not a spacer)
          if (element && element.elementType !== 'spacer') {
            collisions.push({
              columnIndex: colIndex,
              cardId: item.id,
              elementType: element.elementType,
              position: idx
            });
          }
        } else if (item.type === 'section' || item.type === 'divider') {
          // Sections and dividers also count as collisions
          collisions.push({
            columnIndex: colIndex,
            itemType: item.type,
            position: idx
          });
        }
      });
    });

    return {
      hasCollision: collisions.length > 0,
      collisions,
      affectedColumns
    };
  };

  // Auto-spacer: Show toast notification
  const showToast = (message) => {
    setToastMessage(message);
    if (toastTimeoutRef.current) {
      clearTimeout(toastTimeoutRef.current);
    }
    toastTimeoutRef.current = setTimeout(() => {
      setToastMessage(null);
    }, 3000);
  };

  // Auto-spacer: Automatically insert spacers in affected columns
  const autoInsertSpacers = () => {
    if (!selectedElementForSettings || !selectedRecord?.id) return;

    // 1. Get the spanning element's details
    const spanningElement = droppedElements.find(e => e.id === selectedElementForSettings);
    if (!spanningElement || (spanningElement.columnSpan ?? 1) <= 1) return;

    const layout = getAllDetailElements(selectedRecord.id);
    const spanningItem = layout.find(item => item.id === spanningElement.id);
    if (!spanningItem) return;

    const sourceColumnIndex = spanningItem.columnIndex ?? 0;

    // 2. Calculate affected columns
    const affectedColumns = getAffectedColumns(sourceColumnIndex, spanningElement.columnSpan);
    if (affectedColumns.length === 0) return;

    // 3. Find the index position in source column
    const sourceColumnItems = layout.filter(
      item => (item.columnIndex ?? 0) === sourceColumnIndex
    );
    const elementIndex = sourceColumnItems.findIndex(
      item => item.id === spanningElement.id
    );

    // 4. Check for existing spacers
    const existingSpacers = checkExistingSpacers(layout, affectedColumns, elementIndex);

    // 5. Calculate spacer height (same as Smart Layout logic)
    const spanningElementDom = document.getElementById(spanningElement.id);
    const elementHeight = spanningElementDom?.offsetHeight;
    const spacerHeight = elementHeight
      ? elementHeight + (pageSettings.detail.sectionSpacing || 8)
      : (pageSettings.detail.smartLayoutOffset || 200);

    // 6. Create spacers for each affected column (skip if already exists)
    const newSpacers = [];
    const newLayoutItems = [];
    let insertedCount = 0;
    const insertedIds = [];

    affectedColumns.forEach((colIndex) => {
      if (existingSpacers.includes(colIndex)) return; // Skip if spacer already exists

      const spacerId = `spacer-auto-${Date.now()}-${colIndex}-${Math.random().toString(36).substr(2, 9)}`;

      // Create spacer card
      newSpacers.push({
        id: spacerId,
        elementType: 'spacer',
        height: spacerHeight,
        context: 'detail',
        layout: 'list',
        borderWidth: 0,
        columnSpan: 1,
        zIndex: 0 // Spacers always behind other elements
      });

      // Create layout entry
      newLayoutItems.push({
        type: 'card',
        id: spacerId,
        columnIndex: colIndex
      });

      insertedIds.push(spacerId);
      insertedCount++;
    });

    if (insertedCount === 0) {
      showToast('Spacers already exist in affected columns');
      return;
    }

    // 7. Update state
    setDroppedElements(prev => [...prev, ...newSpacers]);

    setDetailPageLayouts(prev => {
      const currentLayout = prev[selectedRecord.id] || [];
      const updatedLayout = [...currentLayout];

      newLayoutItems.forEach((item) => {
        // Find insertion point: same position as spanning element in its column
        const itemsBeforeInColumn = updatedLayout.filter(
          layoutItem =>
            (layoutItem.columnIndex ?? 0) === item.columnIndex &&
            updatedLayout.indexOf(layoutItem) < updatedLayout.findIndex(l => l.id === spanningElement.id)
        ).length;

        // Insert at the calculated position
        const insertPosition = updatedLayout.filter(
          layoutItem => (layoutItem.columnIndex ?? 0) < item.columnIndex
        ).length + itemsBeforeInColumn;

        updatedLayout.splice(insertPosition, 0, item);
      });

      return {
        ...prev,
        [selectedRecord.id]: updatedLayout
      };
    });

    // 8. Show success feedback
    setRecentlyInsertedSpacers(insertedIds);
    showToast(`âœ¨ Added ${insertedCount} spacer${insertedCount > 1 ? 's' : ''} (${spacerHeight}px each)`);

    // Clear highlight after animation
    if (spacerAnimationTimeoutRef.current) {
      clearTimeout(spacerAnimationTimeoutRef.current);
    }
    spacerAnimationTimeoutRef.current = setTimeout(() => {
      setRecentlyInsertedSpacers([]);
    }, 2000);
  };

  // Render card based on layout
  const renderElement = (element, index, context, recordId = null) => {
    const elementDef = componentElements.find(e => e.id === element.elementType);

    console.log('ðŸŽ¨ renderElement called:', {
      elementType: element.elementType,
      elementDef: elementDef ? `Found: ${elementDef.name}` : 'NOT FOUND',
      type: elementDef?.type,
      recordId,
      element
    });

    if (!elementDef) {
      console.log('âŒ renderElement: elementDef NOT FOUND, returning null');
      return null;
    }

    // Get record data if recordId is provided
    const record = recordId ? mockRecords.find(r => r.id === recordId) : null;

    // Get data based on card type
    let data = [];
    if (element.elementType === 'committees') {
      data = record?.committees || [];
    } else if (element.elementType === 'events' || element.elementType === 'event-attendance') {
      data = element.context === 'list' ? allEvents : memberEvents;
    } else {
      // For other card types, default to events for now
      data = element.context === 'list' ? allEvents : memberEvents;
    }

    // Keep events variable for backward compatibility
    const events = element.elementType === 'committees' ? data : (element.context === 'list' ? allEvents : memberEvents);

    const handleCardClick = () => {
      // Only handle card clicks in design mode
      if (!isDesignMode()) {
        return;
      }

      const now = Date.now();
      const timeSinceLastClick = now - lastClickTime;

      // Selection Cycling: If clicking on already-selected element within 1.5 seconds, cycle to next element
      if (selectedElementForSettings === element.id && timeSinceLastClick < 1500) {
        // Get all elements in the current layout
        const layout = context === 'detail' && recordId
          ? getAllDetailElements(recordId)
          : droppedElements.filter(e => e.context === context);

        // Find elements in the same column as current element
        const currentColumnIndex = element.columnIndex ?? 0;
        const elementsInColumn = layout.filter(e => (e.columnIndex ?? 0) === currentColumnIndex);

        if (elementsInColumn.length > 1) {
          // Find current element's index in the column
          const currentIndex = elementsInColumn.findIndex(e => e.id === element.id);

          // Cycle to next element (wrap around to 0 if at end)
          const nextIndex = (currentIndex + 1) % elementsInColumn.length;
          const nextElement = elementsInColumn[nextIndex];

          // Select the next element in the cycle
          setSelectedElementForSettings(nextElement.id);
          setClickCycleIndex(nextIndex);
          setLastClickTime(now);

          // Show toast to indicate cycling
          const elementDef = componentElements.find(e => e.id === nextElement.elementType);
          showToast(`â†» Cycled to ${elementDef?.name || 'element'} (${nextIndex + 1}/${elementsInColumn.length})`);

          // Reset cycle after 2 seconds of no clicking
          if (clickCycleTimeoutRef.current) {
            clearTimeout(clickCycleTimeoutRef.current);
          }
          clickCycleTimeoutRef.current = setTimeout(() => {
            setClickCycleIndex(0);
          }, 2000);

          return; // Exit early, don't do normal click handling
        }
      }

      // Normal click handling (not cycling)
      setLastClickTime(now);
      setClickCycleIndex(0);

      // Open component panel if not already open
      if (!isComponentPanelOpen) {
        setIsComponentPanelOpen(true);
      }
      // Clear any section selection and set this card for settings
      setSelectedSectionForSettings(null);
      setSelectedElementForSettings(element.id); // Use card instance ID instead of card type
      setRightPanelTab('settings');
    };

    // Handle Container Card Types (Kanban, Grid, Canvas)
    if (elementDef.isContainer) {
      return renderContainerElement(element, elementDef, context, recordId);
    }

    // Handle Spacer - just vertical space with minimal visual indicator
    if (element.elementType === 'spacer') {
      const spacerHeight = element.height ?? 48;
      const isRecentlyInserted = recentlyInsertedSpacers.includes(element.id);
      const isSelected = selectedElementForSettings === element.id;

      return (
        <div
          id={element.id}
          onClick={handleCardClick}
          className={`relative group transition-all duration-500 ${
            isDesignMode() ? 'cursor-pointer' : ''
          } ${
            isRecentlyInserted ? 'animate-pulse' : ''
          }`}
          style={{
            height: `${spacerHeight}px`,
            minHeight: '24px',
            // Click-through: Allow clicks to pass through to elements behind
            // unless the spacer is being hovered or selected (only in design mode)
            pointerEvents: (isDesignMode() && isSelected) ? 'auto' : 'none',
          }}
        >
          {/* Subtle dashed outline on hover to show it's clickable */}
          <div
            className={`absolute inset-0 border-2 border-dashed rounded transition-all flex items-center justify-center ${
              isRecentlyInserted
                ? 'border-green-400 bg-green-50'
                : isSelected
                ? 'border-neutral-900 bg-neutral-50'
                : 'border-transparent group-hover:border-blue-400 group-hover:bg-blue-50'
            }`}
            style={{
              // Enable pointer events on the inner div for hover detection
              pointerEvents: 'auto',
            }}
          >
            <span className={`text-xs font-medium transition-opacity ${
              isRecentlyInserted
                ? 'text-green-600 opacity-100'
                : isSelected
                ? 'text-neutral-900 opacity-100'
                : 'text-blue-600 opacity-0 group-hover:opacity-100'
            }`}>
              {isSelected ? 'âœ“ ' : ''}Spacer ({spacerHeight}px) {isRecentlyInserted && 'âœ¨'}
            </span>
          </div>
        </div>
      );
    }

    // Handle zone elements (breadcrumb, title-group, metadata, last-updated)
    // These render differently when moved to body zone
    if (elementDef.type === 'zone') {
      const elementContent = renderElementContent(element, record);
      if (!elementContent) return null;

      const isHovered = hoveredElementId === element.id;

      return (
        <div
          id={element.id}
          onClick={handleCardClick}
          onMouseEnter={() => setHoveredElementId(element.id)}
          onMouseLeave={() => setHoveredElementId(null)}
          className={`rounded-lg overflow-hidden group ${isDesignMode() ? 'cursor-pointer' : ''} relative`}
          style={{
            backgroundColor: themeSettings.colors.background,
            borderWidth: `${element.borderWidth ?? 1}px`,
            borderColor: selectedElementForSettings === element.id
              ? themeSettings.colors.text
              : (themeSettings.mode === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'),
            borderStyle: 'solid',
            transition: 'box-shadow 0.2s ease, transform 0.2s ease, background-color 0.3s ease, border-color 0.3s ease',
            transform: isHovered ? 'translateY(-1px)' : 'none',
            boxShadow: isHovered ? (themeSettings.mode === 'dark' ? '0 4px 12px rgba(0, 0, 0, 0.3)' : '0 4px 12px rgba(0, 0, 0, 0.08)') : 'none',
          }}
        >
          <div
            className="transition-all overflow-x-auto"
            style={{
              padding: `${pageSettings.detail.contentPadding ?? 24}px`,
            }}
          >
            {elementContent}
          </div>
        </div>
      );
    }

    // Handle block cards using unified rendering function
    if (elementDef.type === 'block') {
      const elementContent = renderElementContent(element, record);
      console.log('ðŸ“¦ Block element content:', {
        elementType: element.elementType,
        hasContent: !!elementContent,
        contentType: typeof elementContent,
        content: elementContent
      });
      if (!elementContent) {
        console.log('âŒ renderElement: elementContent is null/undefined, returning null');
        return null;
      }

      const isHovered = hoveredElementId === element.id;
      const showFlexPanelIcon = isHovered && !isFlexPanelEnabled(element.id);

      return (
        <div
          id={element.id}
          onClick={handleCardClick}
          onMouseEnter={() => setHoveredElementId(element.id)}
          onMouseLeave={() => setHoveredElementId(null)}
          className={`rounded-lg overflow-hidden group ${isDesignMode() ? 'cursor-pointer' : ''} relative`}
          style={{
            backgroundColor: themeSettings.colors.background,
            borderWidth: `${element.borderWidth ?? 1}px`,
            borderColor: selectedElementForSettings === element.id
              ? themeSettings.colors.text
              : (themeSettings.mode === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'),
            borderStyle: 'solid',
            transition: 'box-shadow 0.2s ease, transform 0.2s ease, background-color 0.3s ease, border-color 0.3s ease',
            transform: isHovered ? 'translateY(-1px)' : 'none',
            boxShadow: isHovered ? (themeSettings.mode === 'dark' ? '0 4px 12px rgba(0, 0, 0, 0.3)' : '0 4px 12px rgba(0, 0, 0, 0.08)') : 'none',
          }}
        >
          {/* Flex Panel Pop-out Icon */}
          {showFlexPanelIcon && (
            <button
              onClick={(e) => {
                e.stopPropagation();
                toggleFlexPanel(element.id);
              }}
              className="absolute top-2 right-2 z-10 p-1.5 bg-white/95 backdrop-blur-sm rounded-lg border border-neutral-200 shadow-lg hover:bg-blue-50 hover:border-blue-300 transition-all duration-150 group/icon"
              style={{
                animation: 'fadeInScale 150ms ease-out',
              }}
              title="Convert to Flex Panel (âŒ˜â‡§P)"
            >
              <svg
                className="w-4 h-4 text-neutral-600 group-hover/icon:text-blue-600 transition-colors"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={1}
                  d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                />
              </svg>
            </button>
          )}

          <div
            className="transition-all overflow-x-auto"
            style={{
              padding: `${pageSettings.detail.contentPadding ?? 24}px`,
            }}
          >
            {elementContent}
          </div>
        </div>
      );
    }

    const elementContent = (() => {
      // Render based on layout
      switch (element.layout) {
        case 'link':
          return (
            <div className="bg-white rounded-lg p-4">
            <a href="#" className="text-blue-600 hover:text-blue-700 font-medium flex items-center gap-2">
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                {getIconSvg(elementDef.icon)}
              </svg>
              {elementDef.name}
            </a>
          </div>
        );
      }
    })();

  // Wrap card content with drag handle and click handler
  return (
    <div className="relative group">
      {/* Drag handle on hover - top left of card (only in design mode) */}
      {isDesignMode() && (
        <div
          className="absolute -left-3 top-2 opacity-0 group-hover:opacity-100 transition-opacity cursor-grab active:cursor-grabbing z-10"
          onMouseDown={(e) => {
            // Start dragging when handle is clicked
            e.currentTarget.parentElement.querySelector('[data-card-content]').setAttribute('draggable', 'true');
          }}
        >
          <svg className="w-5 h-5 text-neutral-400" fill="currentColor" viewBox="0 0 20 20">
            <circle cx="7" cy="4" r="1.5" />
            <circle cx="13" cy="4" r="1.5" />
            <circle cx="7" cy="10" r="1.5" />
            <circle cx="13" cy="10" r="1.5" />
            <circle cx="7" cy="16" r="1.5" />
            <circle cx="13" cy="16" r="1.5" />
          </svg>
        </div>
      )}

      {/* Element content with click and drag handlers */}
      <div
        data-card-content
        draggable
        onDragStart={(e) => {
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('cardId', element.id);
          setDraggedCardIndex(index);
        }}
        onDragEnd={() => {
          setDraggedCardIndex(null);
        }}
        onClick={handleCardClick}
        className={`rounded-lg transition-all ${isDesignMode() ? 'cursor-pointer hover:ring-2 hover:ring-neutral-300' : ''}`}
        style={{
          borderWidth: `${element.borderWidth ?? 1}px`,
          borderStyle: 'solid',
          borderColor: '#e5e5e5'
        }}
      >
        {elementContent}
      </div>
    </div>
  );
};

  // DND-KIT: Sortable Outline Item Component
  const SortableOutlineItem = ({ element, containerChildren, isOver, isDragging: isDraggingProp }) => {
    const {
      attributes,
      listeners,
      setNodeRef,
      transform,
      transition,
      isDragging: isDraggingInternal,
    } = useSortable({
      id: element.id,
      data: {
        type: 'outline-item',
      },
    });

    const isDragging = isDraggingProp !== undefined ? isDraggingProp : isDraggingInternal;

    const style = {
      transform: CSS.Transform.toString(transform),
      transition,
      opacity: isDragging ? 0.5 : 1,
    };

    // Check if element is a container by type or by elementType definition
    const elementDef = componentElements.find(e => e.id === element.elementType);
    const isContainer = ['container', 'kanban', 'grid', 'canvas'].includes(element.type) || elementDef?.isContainer;
    const children = isContainer ? (containerChildren[element.id] || []) : [];

    return (
      <div ref={setNodeRef} style={style} className="group relative">
        {/* Drop indicator - horizontal line shown when dragging over */}
        {isOver && activeOutlineItemId && activeOutlineItemId !== element.id && (
          <div className="absolute -top-0.5 left-0 right-0 h-0.5 bg-blue-500 z-10 rounded-full" />
        )}
        <div
          className={`flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-white/60 cursor-pointer transition-all ${
            element.visible === false ? 'opacity-50' : ''
          }`}
          onClick={() => {
            setSelectedElementForSettings(element.id);
            // Scroll to element on both list and detail pages
            document.getElementById(element.id)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }}
        >
          {/* Drag Handle */}
          <div
            {...attributes}
            {...listeners}
            className="cursor-grab active:cursor-grabbing flex-shrink-0"
          >
            <svg className="w-3.5 h-3.5 text-neutral-400 hover:text-neutral-600" fill="currentColor" viewBox="0 0 20 20">
              <circle cx="7" cy="4" r="1.5" />
              <circle cx="13" cy="4" r="1.5" />
              <circle cx="7" cy="10" r="1.5" />
              <circle cx="13" cy="10" r="1.5" />
              <circle cx="7" cy="16" r="1.5" />
              <circle cx="13" cy="16" r="1.5" />
            </svg>
          </div>

          {/* Icon based on element type */}
          <svg className="w-4 h-4 text-neutral-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            {element.type === 'text' && (
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 6h16M4 12h16M4 18h7" />
            )}
            {element.type === 'input' && (
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            )}
            {isContainer && (
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
            )}
            {!['text', 'input'].includes(element.type) && !isContainer && (
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343" />
            )}
          </svg>

          {/* Element Label */}
          <span className="text-sm text-neutral-700 flex-1 truncate">
            {element.label || element.type || 'Element'}
          </span>

          {/* Visibility Toggle */}
          <button
            onClick={(e) => {
              e.stopPropagation();
              const toggleVisibility = (el) =>
                el.id === element.id
                  ? { ...el, visible: el.visible === false ? true : false }
                  : el;

              // Update droppedElements (always needed for visibility data)
              setDroppedElements(prev => prev.map(toggleVisibility));

              // Also update detailPageLayouts if we're in detail view
              if (view === 'detail' && selectedRecord) {
                setDetailPageLayouts(prev => ({
                  ...prev,
                  [selectedRecord.id]: (prev[selectedRecord.id] || getDefaultDetailLayout(selectedRecord.id)).map(toggleVisibility)
                }));
              }
            }}
            className={`p-1 hover:bg-neutral-100 rounded transition-all ${
              element.visible === false ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'
            }`}
            title={element.visible === false ? "Show element" : "Hide element"}
          >
            <svg className="w-4 h-4 text-neutral-500 hover:text-neutral-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              {element.visible === false ? (
                // Eye off icon
                <>
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                </>
              ) : (
                // Eye on icon
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              )}
            </svg>
          </button>

          {/* Element Type Badge */}
          <span className="text-xs text-neutral-400 opacity-0 group-hover:opacity-100 transition-opacity">
            {element.type}
          </span>
        </div>

        {/* Nested Children */}
        {children.length > 0 && (
          <div className="ml-6 mt-1 space-y-1 border-l-2 border-neutral-200/50 pl-2">
            {children.map((child) => {
              // Look up element definition to get proper name and type
              const childElementDef = componentElements.find(e => e.id === child.elementType);
              const childLabel = child.label || childElementDef?.name || child.elementType || 'Child Element';
              const childType = child.type || childElementDef?.type || 'element';

              return (
                <div
                  key={child.id}
                  className="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-white/60 cursor-pointer transition-all text-sm"
                  onClick={() => {
                    setSelectedElementForSettings(child.id);
                  }}
                >
                  <svg className="w-3.5 h-3.5 text-neutral-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  <span className="text-neutral-600 flex-1 truncate">
                    {childLabel}
                  </span>
                  <span className="text-xs text-neutral-400">
                    {childType}
                  </span>
                </div>
              );
            })}
          </div>
        )}
      </div>
    );
  };

  // DND-KIT: Sortable Card Component
  const SortableElement = ({ element, index, context, recordId, pageId, columnIndex, zoneName, rowId }) => {
    const {
      attributes,
      listeners,
      setNodeRef,
      transform,
      transition,
      isDragging,
    } = useSortable({
      id: element.id,
      data: {
        type: 'existing-element',
        context,
        recordId,
        pageId,
        columnIndex,
        zoneName,
        rowId,
        elementType: element.elementType || element.type, // Pass element type for cross-zone transfers
      },
    });

    // Prevent ALL items from moving during ANY drag operation
    // When activeElementId exists, a drag is happening - freeze all items
    // Only DragOverlay moves, and blue drop indicator shows position
    const isAnyDragActive = activeElementId !== null;
    const columnSpan = element.columnSpan ?? 1;

    // Check if this is a zone element (header/footer) vs body card element
    const isZoneElement = element.type && !element.elementType;

    // Check if this is a container element
    const elementDef = componentElements.find(e => e.id === element.elementType);
    const isContainer = elementDef?.isContainer;

    const style = {
      transform: isAnyDragActive ? 'none' : CSS.Transform.toString(transform),
      transition: isAnyDragActive ? 'none' : transition,
      opacity: isDragging ? 0.4 : 1,
      gridColumnStart: (columnIndex ?? 0) + 1, // CSS grid is 1-indexed
      gridColumn: columnSpan > 1 ? `span ${columnSpan}` : undefined,
      position: 'relative', // Required for z-index to work in CSS grid
      zIndex: element.zIndex ?? 1, // Apply z-index for layering (spacers=0, others=1+)
    };

    // Get the record for zone elements
    const record = recordId ? mockRecords.find(r => r.id === recordId) : selectedRecord;

    // Use minimal spacing for header/footer zones, normal spacing for body
    const isHeaderOrFooter = zoneName === 'header' || zoneName === 'footer';
    const spacingClass = isHeaderOrFooter ? '' : 'mb-8';

    return (
      <div ref={setNodeRef} style={style} className={spacingClass}>
        <div className="relative group transition-all duration-200 hover:scale-[1.01]">
          {/* Drag handle on hover - top left of card (only in design mode) */}
          {/* Priority 4: Improved Hover States - Always subtly visible for discoverability */}
          {/* For containers, make it more prominent and prevent pointer-events from blocking */}
          {isDesignMode() && (
            <div
              {...attributes}
              {...listeners}
              role="button"
              aria-label={`Drag ${elementDef?.name || element.elementType || 'element'} to reorder`}
              aria-describedby={`${element.id}-drag-instructions`}
              tabIndex={0}
              onKeyDown={(e) => {
                // Allow Enter/Space to activate drag for keyboard users
                if (e.key === 'Enter' || e.key === ' ') {
                  e.preventDefault();
                  // Keyboard drag is handled by KeyboardSensor in sensors
                }
              }}
              className={`absolute -left-3 top-2 opacity-20 group-hover:opacity-100 transition-all duration-200 cursor-grab active:cursor-grabbing ${
                isContainer ? 'z-50' : 'z-10'
              }`}
              style={{ pointerEvents: 'auto' }}
            >
              <div className="bg-white rounded-lg shadow-sm border border-neutral-200 p-1 hover:shadow-md transition-shadow">
                <svg
                  className="w-4 h-4 text-neutral-400 hover:text-neutral-600"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                  aria-hidden="true"
                >
                  <circle cx="7" cy="4" r="1.5" />
                  <circle cx="13" cy="4" r="1.5" />
                  <circle cx="7" cy="10" r="1.5" />
                  <circle cx="13" cy="10" r="1.5" />
                  <circle cx="7" cy="16" r="1.5" />
                  <circle cx="13" cy="16" r="1.5" />
                </svg>
              </div>
              {/* Hidden instructions for screen readers */}
              <span id={`${element.id}-drag-instructions`} className="sr-only">
                Press Space or Enter to pick up this element, then use arrow keys to move it, and Space or Enter again to drop it.
              </span>
            </div>
          )}

          {/* Render content: Use renderElementContent for zone elements, renderElement for cards */}
          <div id={element.id}>
            {isZoneElement
              ? renderElementContent(element, record)
              : renderElement(element, index, context, recordId)
            }
          </div>
        </div>
      </div>
    );
  };

  // DND-KIT: Sortable Section Component - makes sections draggable
  const SortableSection = ({ sectionId, children, context, recordId, columnIndex }) => {
    const {
      attributes,
      listeners,
      setNodeRef,
      transform,
      transition,
      isDragging,
    } = useSortable({
      id: `section-${sectionId}`,
      data: {
        type: 'section',
        sectionId,
        context,
        recordId,
        columnIndex,
      },
    });

    // Prevent ALL items from moving during ANY drag operation
    // When activeElementId exists, a drag is happening - freeze all items
    // Only DragOverlay moves, and blue drop indicator shows position
    const isAnyDragActive = activeElementId !== null;

    // Get section settings
    const columnSpan = sectionSettings[sectionId]?.columnSpan ?? 1;
    const borderWidth = sectionSettings[sectionId]?.borderWidth ?? 1;

    const style = {
      transform: isAnyDragActive ? 'none' : CSS.Transform.toString(transform),
      transition: isAnyDragActive ? 'none' : transition,
      opacity: isDragging ? 0.4 : 1,
      gridColumnStart: (columnIndex ?? 0) + 1, // CSS grid is 1-indexed
      gridColumn: columnSpan > 1 ? `span ${columnSpan}` : undefined,
    };

    const handleSectionClick = () => {
      // Only handle section clicks in design mode
      if (!isDesignMode()) {
        return;
      }

      if (sectionId === 'committees') {
        // Open component panel if not already open
        if (!isComponentPanelOpen) {
          setIsComponentPanelOpen(true);
        }
        // Clear any card selection and set this section for settings
        setSelectedElementForSettings(null);
        setSelectedSectionForSettings(sectionId);
        setRightPanelTab('settings');
      }
    };

    return (
      <div ref={setNodeRef} style={style}>
        <div className="relative group transition-all duration-200 hover:scale-[1.005]">
          {/* Drag handle for section - appears on hover */}
          <div
            {...attributes}
            {...listeners}
            className="absolute -left-3 top-2 opacity-0 group-hover:opacity-100 transition-all duration-200 cursor-grab active:cursor-grabbing z-10"
          >
            <div className="bg-white rounded-lg shadow-sm border border-neutral-200 p-1 hover:shadow-md transition-shadow">
              <svg className="w-4 h-4 text-neutral-400 hover:text-neutral-600" fill="currentColor" viewBox="0 0 20 20">
                <circle cx="7" cy="4" r="1.5" />
                <circle cx="13" cy="4" r="1.5" />
                <circle cx="7" cy="10" r="1.5" />
                <circle cx="13" cy="10" r="1.5" />
                <circle cx="7" cy="16" r="1.5" />
                <circle cx="13" cy="16" r="1.5" />
              </svg>
            </div>
          </div>

          {/* Settings button for committee section */}
          {sectionId === 'committees' && (
            <button
              onClick={(e) => {
                e.stopPropagation();
                setSelectedSectionForSettings(sectionId);
                setSelectedElementForSettings(null);
                setRightPanelTab('settings');
              }}
              className="absolute -right-3 top-6 opacity-0 group-hover:opacity-100 transition-all duration-200 z-10 bg-white rounded-lg shadow-sm border border-neutral-200 p-1 hover:shadow-md"
              title="Section settings"
            >
              <svg className="w-4 h-4 text-neutral-400 hover:text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065zM15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
            </button>
          )}

          <div
            onClick={handleSectionClick}
            className={sectionId === 'committees' ? 'cursor-pointer hover:ring-2 hover:ring-neutral-300 rounded-lg transition-all' : ''}
            style={sectionId === 'committees' ? {
              borderWidth: `${borderWidth}px`,
              borderStyle: 'solid',
              borderColor: '#e5e5e5',
              padding: '1.5rem',
              borderRadius: '0.5rem',
              backgroundColor: 'white'
            } : {}}
          >
            {children}
          </div>
        </div>
      </div>
    );
  };

  // DND-KIT: Droppable Gap - shows drop line between cards
  // Optimized for minimal layout impact following CMS best practices
  const DroppableGap = ({ context, recordId, pageId, insertIndex, columnIndex, zoneName, rowId, columnItems }) => {
    // Support both recordId (detail view) and pageId (custom pages)
    const contextId = pageId || recordId || 'list';

    const { setNodeRef, isOver } = useDroppable({
      id: `gap-${context}-${contextId}-${columnIndex ?? 'none'}-${zoneName || 'body'}-${rowId || 'none'}-${insertIndex}`,
      data: {
        context,
        recordId,
        pageId,
        insertIndex,
        columnIndex,
        zoneName: zoneName || 'body',
        rowId,
        type: 'gap',
      },
    });

    const isDragging = activeElementId !== null;

    // Hide gaps immediately before and after the dragged element
    const shouldHide = React.useMemo(() => {
      if (!isDragging || !columnItems || !activeElementId) return false;

      const draggedIndex = columnItems.findIndex(item => item.id === activeElementId);
      if (draggedIndex === -1) return false;

      // Hide gap before dragged element (insertIndex === draggedIndex)
      // Hide gap after dragged element (insertIndex === draggedIndex + 1)
      return insertIndex === draggedIndex || insertIndex === draggedIndex + 1;
    }, [isDragging, columnItems, activeElementId, insertIndex]);

    // Don't render if should be hidden
    if (shouldHide) {
      return null;
    }

    return (
      <div
        ref={setNodeRef}
        className={`relative transition-all duration-200 ease-out ${
          isOver
            ? 'h-6 -my-2'  // Large drop target when hovering (24px - 16px = 8px net, no shift!)
            : isDragging
              ? 'h-6 -my-2'  // Large invisible hit area (24px - 16px = 8px net, matches reduced gap)
              : 'h-0'        // Invisible when not dragging
        }`}
        style={{
          pointerEvents: 'auto',
          zIndex: 40,
        }}
        title={`Drop zone ${insertIndex}`}
      >
        {/* Active drop target - prominent blue line with pulse */}
        {isOver && (
          <div className="absolute inset-x-0 top-1/2 -translate-y-1/2 z-10 animate-in fade-in duration-200">
            <div className="h-1.5 bg-gradient-to-r from-blue-400 via-blue-500 to-blue-400 rounded-full shadow-lg mx-4 animate-pulse">
              <div className="absolute left-1/2 -translate-x-1/2 -translate-y-1/2 w-4 h-4 bg-blue-500 rounded-full border-2 border-white shadow-lg"></div>
            </div>
            <div className="text-center mt-1">
              <span className="text-xs font-medium text-blue-600 bg-blue-50 px-2 py-0.5 rounded">Drop here</span>
            </div>
          </div>
        )}
        {/* Priority 5: Drop Zone Animation - Available drop zones with fade-in animation */}
        {isDragging && !isOver && (
          <div className="absolute inset-x-0 top-1/2 -translate-y-1/2 -my-2 px-4 animate-in fade-in duration-300">
            <div className="w-full border-t-[3px] border-blue-400 border-dashed opacity-60"></div>
          </div>
        )}
      </div>
    );
  };

  // Draggable Quick Access Icon component
  const DraggableQuickAccessIcon = ({ item, index }) => {
    const [isHovered, setIsHovered] = useState(false);

    const { attributes, listeners, setNodeRef: setDraggableRef, transform, transition, isDragging } = useDraggable({
      id: `quick-access-icon-${item.id}`,
      data: {
        type: 'quick-access-icon',
        iconId: item.id,
        index: index
      },
    });

    const { setNodeRef: setDroppableRef, isOver } = useDroppable({
      id: `quick-access-drop-${item.id}`,
      data: {
        type: 'quick-access-icon',
        iconId: item.id,
        index: index
      }
    });

    // Combine refs
    const setNodeRef = (node) => {
      setDraggableRef(node);
      setDroppableRef(node);
    };

    const style = {
      transform: transform ? `translate3d(${transform.x}px, ${transform.y}px, 0)` : undefined,
      transition,
      opacity: isDragging ? 0.5 : 1,
    };

    return (
      <div
        ref={setNodeRef}
        style={style}
        onMouseEnter={() => setIsHovered(true)}
        onMouseLeave={() => setIsHovered(false)}
        className="relative"
      >
        {/* Drop indicator - vertical line on left edge when dragging over */}
        {isOver && (
          <div className="absolute -left-1 top-0 bottom-0 w-1 bg-blue-500 rounded-full pointer-events-none z-20" />
        )}

        {/* Drag handle - visible on hover, positioned on LEFT */}
        <div
          {...attributes}
          {...listeners}
          className={`absolute -top-1 -left-1 z-10 p-1 bg-white rounded-full shadow-md cursor-grab active:cursor-grabbing transition-opacity ${
            isHovered ? 'opacity-100' : 'opacity-0'
          }`}
        >
          <svg className="w-3 h-3 text-neutral-500" fill="currentColor" viewBox="0 0 20 20">
            <circle cx="7" cy="4" r="1.5" />
            <circle cx="13" cy="4" r="1.5" />
            <circle cx="7" cy="10" r="1.5" />
            <circle cx="13" cy="10" r="1.5" />
            <circle cx="7" cy="16" r="1.5" />
            <circle cx="13" cy="16" r="1.5" />
          </svg>
        </div>

        <button
          className="w-full flex flex-col items-center justify-center gap-1.5 p-3 rounded-lg hover:bg-white/80 transition-all group"
          title={item.label}
          onClick={() => {
            // Handle icon click - would add element to canvas
            console.log(`Quick Access: ${item.label}`);
          }}
        >
          <svg className="w-6 h-6 text-neutral-600 group-hover:text-neutral-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            {/* Support both SVG path strings (for default icons) and icon names (from componentElements) */}
            {item.icon && (item.icon.includes('M') || item.icon.includes('L')) ? (
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d={item.icon} />
            ) : (
              getIconSvg(item.icon)
            )}
          </svg>
          <span className="text-xs text-neutral-500 group-hover:text-neutral-700 text-center leading-tight">{item.label}</span>
        </button>
      </div>
    );
  };

  // Quick Access Drop Zone component
  const QuickAccessDropZone = ({ icons, isDragTarget }) => {
    const { setNodeRef, isOver } = useDroppable({
      id: 'quick-access-drop-zone',
      data: {
        type: 'quick-access'
      }
    });

    return (
      <div
        ref={setNodeRef}
        className={`px-4 pb-4 overflow-y-auto transition-all relative ${
          isOver ? 'bg-blue-100/50' : ''
        }`}
        style={{ height: `calc(100% - 40px)` }}
      >
        {/* Drop indicator for entire zone */}
        {isOver && (
          <div className="absolute inset-2 rounded-lg border-2 border-dashed border-blue-400 bg-blue-50/30 pointer-events-none z-10 flex items-center justify-center">
            <div className="text-sm font-medium text-blue-600">Drop to add to Quick Access</div>
          </div>
        )}

        <div className="grid grid-cols-4 gap-2">
          {icons.map((item, index) => (
            <DraggableQuickAccessIcon key={item.id} item={item} index={index} />
          ))}
        </div>
      </div>
    );
  };

  // DND-KIT: Draggable Card Panel Item (for dragging new cards from panel)
  const DraggableCardPanelItem = ({ element }) => {
    const { attributes, listeners, setNodeRef, transform, isDragging } = useDraggable({
      id: `panel-${element.id}`,
      data: {
        type: 'new-element',
        elementType: element.id,
      },
    });

    const style = transform ? {
      transform: `translate3d(${transform.x}px, ${transform.y}px, 0)`,
      opacity: isDragging ? 0.5 : 1,
    } : undefined;

    // Track when @dnd-kit dragging starts/ends for Quick Access
    React.useEffect(() => {
      if (isDragging) {
        setDraggedElement({
          id: element.id,
          name: element.name,
          icon: element.icon,
          type: 'element'
        });
      } else if (draggedElement?.id === element.id) {
        setTimeout(() => {
          setDraggedElement(null);
          setIsQuickAccessDropTarget(false);
        }, 100);
      }
    }, [isDragging]);

    return (
      <div
        ref={setNodeRef}
        style={style}
        {...attributes}
        {...listeners}
        className="relative group cursor-grab active:cursor-grabbing pl-3"
      >
        {/* Drag Handle */}
        <div className="absolute left-0 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity z-10 pointer-events-none">
          <svg className="w-4 h-4 text-neutral-400" fill="currentColor" viewBox="0 0 20 20">
            <circle cx="7" cy="4" r="1.5" />
            <circle cx="13" cy="4" r="1.5" />
            <circle cx="7" cy="10" r="1.5" />
            <circle cx="13" cy="10" r="1.5" />
            <circle cx="7" cy="16" r="1.5" />
            <circle cx="13" cy="16" r="1.5" />
          </svg>
        </div>

        <div className="w-full flex items-start gap-4 pr-4 py-3 rounded-lg hover:bg-neutral-50 transition-colors">
          <div className="flex-shrink-0 w-10 h-10 rounded-lg bg-neutral-100 group-hover:bg-neutral-200 transition-colors flex items-center justify-center">
            <svg className="w-5 h-5 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              {getIconSvg(element.icon)}
            </svg>
          </div>
          <div className="flex-1 min-w-0">
            <div className="text-sm font-medium text-neutral-900">{element.name}</div>
            <div className="text-xs text-neutral-500 mt-0.5">{element.description}</div>
          </div>

          {/* Chevron Icon for Settings */}
          <button
            onClick={(e) => {
              e.stopPropagation();
              setSelectedElementForSettings(element.id);
              setRightPanelTab('settings');
            }}
            className="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity p-1 hover:bg-neutral-200 rounded"
            title="Card settings"
          >
            <svg className="w-4 h-4 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 5l7 7-7 7" />
            </svg>
          </button>
        </div>
      </div>
    );
  };

  // Keyboard shortcuts for floating panels and canvas
  useEffect(() => {
    const handleKeyDown = (e) => {
      // Spacebar - Enable pan mode (like Figma)
      if (e.code === 'Space' && !['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
        if (!isSpacebarPressed) {
          setIsSpacebarPressed(true);
          e.preventDefault();
        }
      }

      // ESC - Close artifact gallery or active discussion
      if (e.key === 'Escape') {
        if (isArtifactGalleryOpen) {
          setIsArtifactGalleryOpen(false);
          e.preventDefault();
        } else if (activeDiscussion) {
          setActiveDiscussion(null);
          e.preventDefault();
        }
      }

      // Cmd/Ctrl + K - Toggle artifact gallery (if on application record)
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        if (selectedRecord?.artifacts && selectedRecord.artifacts.length > 0) {
          setIsArtifactGalleryOpen(prev => !prev);
          e.preventDefault();
        }
      }

      // Cmd/Ctrl + 1-9 - Open specific artifact in floating panel
      if ((e.metaKey || e.ctrlKey) && e.key >= '1' && e.key <= '9') {
        const artifactIndex = parseInt(e.key) - 1;
        if (selectedRecord?.artifacts && selectedRecord.artifacts[artifactIndex]) {
          const artifact = selectedRecord.artifacts[artifactIndex];
          const newPanel = {
            id: `panel-${artifact.id}-${Date.now()}`,
            artifactId: artifact.id,
            position: {
              x: 100 + (floatingPanels.length * 30),
              y: 100 + (floatingPanels.length * 30),
              width: 500,
              height: 600
            },
            zIndex: panelZIndexCounter + 1,
            minimized: false
          };
          setFloatingPanels(panels => [...panels, newPanel]);
          setPanelZIndexCounter(panelZIndexCounter + 1);
          e.preventDefault();
        }
      }

      // Cmd/Ctrl + W - Close active artifact panel
      if ((e.metaKey || e.ctrlKey) && e.key === 'w') {
        if (activeArtifactPanel) {
          setFloatingPanels(panels => panels.filter(p => p.id !== activeArtifactPanel));
          setActiveArtifactPanel(null);
          e.preventDefault();
        }
      }

      // Cmd/Ctrl + M - Minimize/restore active artifact panel
      if ((e.metaKey || e.ctrlKey) && e.key === 'm') {
        if (activeArtifactPanel) {
          setFloatingPanels(panels => panels.map(p =>
            p.id === activeArtifactPanel ? { ...p, minimized: !p.minimized } : p
          ));
          e.preventDefault();
        }
      }

      // + / - for zoom control (when not in input)
      if (view === 'detail' && selectedRecord?.recordType === 'Application' && !['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
        if (e.key === '+' || e.key === '=') {
          setCanvasZoom(prev => Math.min(200, prev + 10));
          e.preventDefault();
        } else if (e.key === '-' || e.key === '_') {
          setCanvasZoom(prev => Math.max(50, prev - 10));
          e.preventDefault();
        } else if (e.key === '0') {
          setCanvasZoom(100);
          e.preventDefault();
        }
      }
    };

    const handleKeyUp = (e) => {
      // Spacebar release - Disable pan mode
      if (e.code === 'Space') {
        setIsSpacebarPressed(false);
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    window.addEventListener('keyup', handleKeyUp);
    return () => {
      window.removeEventListener('keydown', handleKeyDown);
      window.removeEventListener('keyup', handleKeyUp);
    };
  }, [isArtifactGalleryOpen, activeDiscussion, selectedRecord, floatingPanels, panelZIndexCounter, activeArtifactPanel, view, canvasZoom, isSpacebarPressed]);

  // Auto-open dropdown/calendar for fields when edit panel opens
  useEffect(() => {
    if (editingCommittee && isEditPanelOpen) {
      const fieldId = editingCommittee.field === 'name' ? 'committee' : editingCommittee.field;
      const field = formFields.find(f => f.id === fieldId);

      if (field) {
        // Small delay to ensure DOM is ready
        setTimeout(() => {
          if (field.type === 'select-single') {
            setOpenDropdownId(field.id);
          } else if (field.type === 'date') {
            // Trigger click on date input to open calendar
            const dateInput = document.querySelector(`input[type="date"][data-field-id="${field.id}"]`);
            if (dateInput) {
              dateInput.focus();
              // Attempt to open the calendar by simulating click
              dateInput.showPicker?.();
            }
          } else if (field.type === 'multiline') {
            // Focus on textarea for memo fields
            const textarea = document.querySelector(`textarea[data-field-id="${field.id}"]`);
            if (textarea) {
              textarea.focus();
            }
          }
        }, 150);
      }
    } else {
      // Close dropdown when edit panel closes
      setOpenDropdownId(null);
    }
  }, [editingCommittee, isEditPanelOpen]);

  // Keyboard shortcuts
  useEffect(() => {
    const handleKeyDown = (e) => {
      // Cmd/Ctrl + K for search
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        document.querySelector('input[type="text"]')?.focus();
      }
      // Escape to close menus and panels
      if (e.key === 'Escape') {
        if (isSidebarOpen) {
          setIsSidebarOpen(false);
        } else if (isWorkspaceSelectorOpen) {
          setIsWorkspaceSelectorOpen(false);
        } else if (isNewRecordMenuOpen) {
          setIsNewRecordMenuOpen(false);
        } else if (isUserMenuOpen) {
          setIsUserMenuOpen(false);
        } else if (openActionMenu) {
          setOpenActionMenu(null);
        } else if (isFilterPanelOpen) {
          setIsFilterPanelOpen(false);
        } else if (openDropdownId) {
          setOpenDropdownId(null);
        } else if (view === 'detail') {
          setView('list');
          setSelectedRecord(null);
        }
      }
      // Cmd/Ctrl + N for new
      if ((e.metaKey || e.ctrlKey) && e.key === 'n' && view === 'list') {
        e.preventDefault();
        // New record action would go here
      }
      // Cmd/Ctrl + Z for undo
      if ((e.metaKey || e.ctrlKey) && e.key === 'z' && !e.shiftKey && view === 'detail') {
        e.preventDefault();
        handleUndo();
      }
      // Cmd/Ctrl + Shift + Z or Cmd/Ctrl + Y for redo
      if ((e.metaKey || e.ctrlKey) && ((e.key === 'z' && e.shiftKey) || e.key === 'y') && view === 'detail') {
        e.preventDefault();
        handleRedo();
      }
    };

    const handleClickOutside = (e) => {
      // Close global header dropdowns when clicking outside
      if (isWorkspaceSelectorOpen && !e.target.closest('[data-workspace-selector]')) {
        setIsWorkspaceSelectorOpen(false);
      }
      if (isNewRecordMenuOpen && !e.target.closest('[data-new-record-menu]')) {
        setIsNewRecordMenuOpen(false);
      }
      if (isUserMenuOpen && !e.target.closest('[data-user-menu]')) {
        setIsUserMenuOpen(false);
      }
      // Close action menu when clicking outside
      if (openActionMenu && !e.target.closest('td')) {
        setOpenActionMenu(null);
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    window.addEventListener('click', handleClickOutside);
    return () => {
      window.removeEventListener('keydown', handleKeyDown);
      window.removeEventListener('click', handleClickOutside);
    };
  }, [view, openDropdownId, openActionMenu, isFilterPanelOpen, isWorkspaceSelectorOpen, isNewRecordMenuOpen, isUserMenuOpen, isSidebarOpen, handleUndo, handleRedo]);

  // Auto-close sidebar when Explorer is docked and shown to prevent visual overlap (unless pinned)
  // Only triggers when Explorer state changes, not when sidebar is manually opened
  useEffect(() => {
    if (activeLayers.has('explorer') && explorerIsDocked && isSidebarOpen && !isSidebarPinned) {
      setIsSidebarOpen(false);
    }
  }, [activeLayers, explorerIsDocked]);

  // FLIP animation for reordering fields
  useEffect(() => {
    // Skip animation on initial mount
    if (Object.keys(fieldPositions.current).length === 0) {
      // Just record positions
      formFields.forEach(field => {
        const el = fieldRefs.current[field.id];
        if (el) {
          const rect = el.getBoundingClientRect();
          fieldPositions.current[field.id] = { top: rect.top, left: rect.left };
        }
      });
      return;
    }

    // Animate fields that moved
    formFields.forEach(field => {
      const el = fieldRefs.current[field.id];
      if (el && fieldPositions.current[field.id]) {
        const oldPos = fieldPositions.current[field.id];
        const newPos = el.getBoundingClientRect();

        const deltaY = oldPos.top - newPos.top;

        // Only animate if position actually changed
        if (Math.abs(deltaY) > 1 && field.id !== justDroppedId) {
          // Apply initial transform
          el.style.transform = `translateY(${deltaY}px)`;
          el.style.transition = 'none';

          // Force reflow
          el.offsetHeight;

          // Animate to final position
          el.style.transform = 'translateY(0)';
          el.style.transition = 'transform 350ms cubic-bezier(0.32, 0.72, 0, 1)';
        }
      }
    });

    // Update positions for next time
    formFields.forEach(field => {
      const el = fieldRefs.current[field.id];
      if (el) {
        const rect = el.getBoundingClientRect();
        fieldPositions.current[field.id] = { top: rect.top, left: rect.left };
      }
    });
  }, [formFields]);

  const handleViewRecord = (record) => {
    setSelectedRecord(record);
    setView('detail');
  };

  const toggleRecordSelection = (recordId) => {
    setSelectedRecords(prev =>
      prev.includes(recordId)
        ? prev.filter(id => id !== recordId)
        : [...prev, recordId]
    );
  };

  const getStatusIndicator = (status) => {
    const indicators = {
      'Active': 'â—',
      'Pending': 'â—‹',
      'Completed': 'âœ“',
      'In Progress': 'â—',
    };
    return indicators[status] || 'â—‹';
  };

  const getPrioritySymbol = (priority) => {
    const symbols = {
      'High': 'â†‘â†‘',
      'Medium': 'â†’',
      'Low': 'â†“',
    };
    return symbols[priority] || 'â†’';
  };

  const getIconSvg = (iconName) => {
    const icons = {
      // Layout Container Icons
      'view-columns': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 4H5a2 2 0 00-2 2v12a2 2 0 002 2h4m0-16h4m-4 0v16m4-16h4a2 2 0 012 2v12a2 2 0 01-2 2h-4m0-16v16" />,
      'grid': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zM14 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />,
      'canvas': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />,

      // Regular Icons
      'text': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 6h16M4 12h16M4 18h7" />,
      'list': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 6h16M4 12h16M4 18h16" />,
      'check-list': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />,
      'document': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />,
      'badge': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />,
      'megaphone': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" />,
      'academic': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 14l9-5-9-5-9 5 9 5z M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z M12 14l-9-5v7a2 2 0 002 2h14a2 2 0 002-2v-7l-9 5z" />,
      'document-text': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />,
      'star': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />,
      'calendar': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />,
      'currency': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />,
      'globe': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />,
      'link': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />,
      'newspaper': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />,
      'users': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />,
      'shopping': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />,
      'credit-card': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />,
      'trending-up': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />,
      'book': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />,
      'refresh': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />,
      'users-group': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />,
      'gift': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />,
      'lightning': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M13 10V3L4 14h7v7l9-11h-7z" />,
      'share': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />,
      'flag': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9" />,
      'briefcase': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />,
      'light-bulb': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />,
      'office': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />,
      'heart': <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />,
    };
    return icons[iconName] || icons['document'];
  };

  // Handle drag move to show drop preview
  const handleDragMove = (event) => {
    const { active, over, delta, activatorEvent } = event;

    // Track over state for outline items
    if (active?.data?.current?.type === 'outline-item') {
      setOverOutlineItemId(over?.id || null);
    }

    // Only show preview for canvas children
    const isCanvasChild =
      active?.data?.current?.type === 'canvas-grid-child' ||
      active?.data?.current?.type === 'canvas-freeform-child';

    if (!isCanvasChild || !delta || !activatorEvent) {
      setDragPreviewPosition(null);
      return;
    }

    const containerId = active.data.current?.containerId;
    const childId = active.data.current?.childId;
    const getPosition = active.data.current?.getPosition;

    if (!containerId || !getPosition) return;

    const containerElement = document.querySelector(`[data-container-id="${containerId}"]`);
    if (!containerElement) return;

    const containerRect = containerElement.getBoundingClientRect();
    const currentPosition = getPosition();

    // Determine if grid or freeform mode
    const isGridMode = active.data.current?.type === 'canvas-grid-child';

    // Calculate grab offset based on mode
    let grabOffsetX = 0;
    let grabOffsetY = 0;

    if (isGridMode) {
      // Grid mode: Use actual click position for natural grab feel
      const draggedElement = active.node?.element;
      if (draggedElement) {
        const elementRect = draggedElement.getBoundingClientRect();
        const initialMouseX = activatorEvent instanceof MouseEvent
          ? activatorEvent.clientX
          : activatorEvent.touches?.[0]?.clientX;
        const initialMouseY = activatorEvent instanceof MouseEvent
          ? activatorEvent.clientY
          : activatorEvent.touches?.[0]?.clientY;

        if (initialMouseX !== undefined && initialMouseY !== undefined) {
          grabOffsetX = initialMouseX - elementRect.left;
          grabOffsetY = initialMouseY - elementRect.top;
        }
      }
    } else {
      // Freeform mode: Use consistent center-based offset for predictable UX
      grabOffsetX = currentPosition.width / 2;
      grabOffsetY = currentPosition.height / 2;
    }

    const finalMouseX = (activatorEvent instanceof MouseEvent
      ? activatorEvent.clientX
      : activatorEvent.touches?.[0]?.clientX || 0) + delta.x;
    const finalMouseY = (activatorEvent instanceof MouseEvent
      ? activatorEvent.clientY
      : activatorEvent.touches?.[0]?.clientY || 0) + delta.y;

    let elementTopLeftX = finalMouseX - grabOffsetX - containerRect.left;
    let elementTopLeftY = finalMouseY - grabOffsetY - containerRect.top;

    if (isGridMode) {
      const gridConfig = active.data.current?.gridConfig;
      if (!gridConfig) return;

      const contentWidth = containerRect.width - (gridConfig.gap * 2);
      const columnWidth = (contentWidth - (gridConfig.gap * (gridConfig.columns - 1))) / gridConfig.columns;

      // Account for the initial gap (container padding) in the calculation
      const colIndex = Math.max(0, Math.round((elementTopLeftX - gridConfig.gap) / (columnWidth + gridConfig.gap)));
      const rowIndex = Math.max(0, Math.round((elementTopLeftY - gridConfig.gap) / (gridConfig.rowHeight + gridConfig.gap)));

      const [colStart, colEnd] = currentPosition.gridColumn.split(' / ').map(v => parseInt(v) || 1);
      const colSpan = colEnd - colStart;
      const currentRow = currentPosition.gridRow.split(' / ');
      let rowStart = currentRow[0] === 'auto' ? 1 : parseInt(currentRow[0]) || 1;
      let rowEnd = currentRow[1] === 'auto' ? rowStart + 1 : parseInt(currentRow[1]) || rowStart + 1;
      const rowSpan = rowEnd - rowStart;

      let newColStart = Math.max(1, colIndex + 1);
      let newColEnd = newColStart + colSpan;
      if (newColEnd > gridConfig.columns + 1) {
        newColEnd = gridConfig.columns + 1;
        newColStart = newColEnd - colSpan;
      }

      let newRowStart = Math.max(1, rowIndex + 1);
      let newRowEnd = newRowStart + rowSpan;

      setDragPreviewPosition({
        type: 'grid',
        containerId,
        childId,
        gridColumn: `${newColStart} / ${newColEnd}`,
        gridRow: `${newRowStart} / ${newRowEnd}`,
      });
    } else {
      // Freeform mode
      let newX = Math.max(0, Math.min(elementTopLeftX, containerRect.width - currentPosition.width));
      let newY = Math.max(0, Math.min(elementTopLeftY, containerRect.height - currentPosition.height));

      setDragPreviewPosition({
        type: 'freeform',
        containerId,
        childId,
        x: newX,
        y: newY,
        width: currentPosition.width,
        height: currentPosition.height,
        rotate: currentPosition.rotate || 0,
      });
    }
  };

  return (
    <DndContext
      sensors={sensors}
      collisionDetection={customCollisionDetection}
      onDragStart={handleCardDragStart}
      onDragMove={handleDragMove}
      onDragEnd={handleCardDragEnd}
    >
      <div
        className="min-h-screen flex flex-col"
        style={{
          backgroundColor: themeSettings.pageBackground,
          color: themeSettings.colors.text,
        }}
      >
        {/* Theme CSS Variables and Styles */}
        <style dangerouslySetInnerHTML={{ __html: `
          :root {
            --theme-primary: ${themeSettings.colors.primary};
            --theme-secondary: ${themeSettings.colors.secondary};
            --theme-accent: ${themeSettings.colors.accent};
            --theme-background: ${themeSettings.colors.background};
            --theme-surface: ${themeSettings.colors.surface};
            --theme-text: ${themeSettings.colors.text};
            --theme-text-secondary: ${themeSettings.colors.textSecondary};
            --theme-page-bg: ${themeSettings.pageBackground};
          }

          /* Smooth Theme Transitions - Targeted approach to avoid conflicts */
          /* Only apply to elements that don't have specific animations */
          body,
          .bg-white,
          .bg-neutral-50,
          .bg-neutral-100,
          .text-neutral-900,
          .text-neutral-800,
          .text-neutral-700,
          .text-neutral-600,
          .text-neutral-500,
          .text-neutral-400,
          .border-neutral-200,
          .border-neutral-100,
          button:not([class*="animate"]):not([class*="panel-transition"]),
          div:not([class*="animate"]):not([class*="panel-transition"]):not(.react-grid-item) {
            transition: background-color var(--duration-normal, 0.3s) var(--ease-in-out, cubic-bezier(0.4, 0, 0.2, 1)),
                        color var(--duration-normal, 0.3s) var(--ease-in-out, cubic-bezier(0.4, 0, 0.2, 1)),
                        border-color var(--duration-normal, 0.3s) var(--ease-in-out, cubic-bezier(0.4, 0, 0.2, 1)),
                        box-shadow var(--duration-normal, 0.3s) var(--ease-in-out, cubic-bezier(0.4, 0, 0.2, 1));
          }

          /* Typography - Headers (h1, h2, h3) */
          h1, h2, h3, .text-lg, .text-xl {
            font-size: ${themeSettings.typography.header.fontSize}px !important;
            line-height: ${themeSettings.typography.header.lineHeight} !important;
            font-weight: ${themeSettings.typography.header.fontWeight} !important;
          }

          /* Typography - Paragraphs */
          p, .leading-relaxed {
            font-size: ${themeSettings.typography.paragraph.fontSize}px !important;
            line-height: ${themeSettings.typography.paragraph.lineHeight} !important;
            font-weight: ${themeSettings.typography.paragraph.fontWeight} !important;
          }

          /* Typography - Default/Body text */
          body, .text-sm, .text-base, dd, dt, td {
            font-size: ${themeSettings.typography.default.fontSize}px !important;
            line-height: ${themeSettings.typography.default.lineHeight} !important;
            font-weight: ${themeSettings.typography.default.fontWeight} !important;
          }

          /* Main content cards - Bio, Contact, Committee blocks */
          .bg-white.rounded-lg {
            background-color: ${themeSettings.colors.background} !important;
            border-color: ${themeSettings.mode === 'dark' ? '#555' : '#e5e5e5'} !important;
          }

          /* Inner content backgrounds */
          .bg-neutral-50 {
            background-color: ${themeSettings.colors.surface} !important;
          }

          .bg-neutral-100 {
            background-color: ${themeSettings.mode === 'dark' ?
              (themeSettings.theme === 'clarity' ? '#1e3a5f' :
               themeSettings.theme === 'joyful' ? '#3d2845' : '#333')
              : themeSettings.colors.surface} !important;
          }

          /* Text colors - Primary */
          .text-neutral-900, .text-neutral-800, .text-neutral-700 {
            color: ${themeSettings.colors.text} !important;
          }

          /* Text colors - Secondary */
          .text-neutral-600, .text-neutral-500, .text-neutral-400 {
            color: ${themeSettings.colors.textSecondary} !important;
          }

          /* Border colors */
          .border-neutral-200, .border-neutral-100,
          .divide-neutral-200, .divide-neutral-100,
          .border-b {
            border-color: ${themeSettings.mode === 'dark' ? '#555' : '#e5e5e5'} !important;
          }

          /* Hover states */
          .hover\\:bg-neutral-50:hover, .hover\\:bg-neutral-100:hover {
            background-color: ${themeSettings.mode === 'dark' ? '#444' :
              (themeSettings.theme === 'clarity' ? '#eff6ff' :
               themeSettings.theme === 'joyful' ? '#fdf4ff' : themeSettings.colors.surface)} !important;
          }

          /* Links and accents */
          .text-blue-600, .text-blue-700, a {
            color: ${themeSettings.colors.accent} !important;
          }

          .hover\\:text-blue-700:hover {
            color: ${themeSettings.colors.accent} !important;
            opacity: 0.8;
          }

          /* Buttons - Primary */
          button.bg-neutral-900, .bg-neutral-900 {
            background-color: ${themeSettings.buttons.primary.background} !important;
            color: ${themeSettings.buttons.primary.text} !important;
            border-radius: ${themeSettings.buttons.primary.borderRadius}px !important;
          }

          /* Buttons - Secondary */
          button.bg-neutral-100, button.text-neutral-700 {
            background-color: ${themeSettings.buttons.secondary.background} !important;
            color: ${themeSettings.buttons.secondary.text} !important;
            border-radius: ${themeSettings.buttons.secondary.borderRadius}px !important;
          }

          /* Images */
          img {
            border-width: ${themeSettings.images.borderWidth}px !important;
            border-radius: ${themeSettings.images.borderRadius}px !important;
            box-shadow: ${
              themeSettings.images.shadow === 'sm' ? '0 1px 2px 0 rgb(0 0 0 / 0.05)' :
              themeSettings.images.shadow === 'md' ? '0 4px 6px -1px rgb(0 0 0 / 0.1)' :
              themeSettings.images.shadow === 'lg' ? '0 10px 15px -3px rgb(0 0 0 / 0.1)' : 'none'
            } !important;
          }

          /* Table styles */
          thead.bg-neutral-50, thead {
            background-color: ${themeSettings.colors.surface} !important;
          }

          tbody.bg-white, tbody {
            background-color: ${themeSettings.colors.background} !important;
          }

          tr.hover\\:bg-neutral-50:hover {
            background-color: ${themeSettings.mode === 'dark' ? '#333' : themeSettings.colors.surface} !important;
          }

          /* Committee cards and similar nested cards */
          .space-y-6 > div.bg-neutral-50,
          .grid > div.bg-neutral-50,
          .space-y-2 > div.bg-neutral-50 {
            background-color: ${themeSettings.colors.surface} !important;
            border-color: ${themeSettings.mode === 'dark' ? '#555' : '#e5e5e5'} !important;
          }

          /* ========== UI CHROME THEMING ========== */

          /* Top Navigation Bar */
          header.bg-white {
            background-color: ${themeSettings.colors.background} !important;
            border-color: ${themeSettings.mode === 'dark' ? '#444' : '#e5e5e5'} !important;
          }

          /* Sidebar Navigation */
          aside.bg-white {
            background-color: ${themeSettings.colors.background} !important;
            border-color: ${themeSettings.mode === 'dark' ? '#444' : '#e5e5e5'} !important;
          }

          /* Settings Panel (Right Panel) */
          .fixed.right-0.top-0.h-full {
            background-color: ${themeSettings.colors.background} !important;
            border-color: ${themeSettings.mode === 'dark' ? '#444' : '#e5e5e5'} !important;
          }

          /* Explorer Panel */
          [style*="rgba(255, 255, 255"] {
            background-color: ${themeSettings.mode === 'dark'
              ? `${themeSettings.colors.background}ee`
              : `${themeSettings.colors.background}f5`} !important;
          }

          /* All Dropdowns and Menus */
          .absolute.bg-white.border.shadow-lg,
          .absolute.bg-white.border.rounded-lg {
            background-color: ${themeSettings.colors.background} !important;
            border-color: ${themeSettings.mode === 'dark' ? '#555' : '#e5e5e5'} !important;
            box-shadow: ${themeSettings.mode === 'dark'
              ? '0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3)'
              : '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)'} !important;
          }

          /* Form Inputs */
          input[type="text"],
          input[type="email"],
          input[type="number"],
          input[type="color"],
          textarea,
          select {
            background-color: ${themeSettings.colors.surface} !important;
            border-color: ${themeSettings.mode === 'dark' ? '#555' : '#d4d4d4'} !important;
            color: ${themeSettings.colors.text} !important;
          }

          input[type="text"]:focus,
          input[type="email"]:focus,
          input[type="number"]:focus,
          textarea:focus,
          select:focus {
            border-color: ${themeSettings.colors.primary} !important;
            outline: none !important;
            box-shadow: 0 0 0 3px ${themeSettings.colors.primary}33 !important;
          }

          input::placeholder,
          textarea::placeholder {
            color: ${themeSettings.colors.textSecondary} !important;
            opacity: 0.6;
          }

          /* Range Inputs */
          input[type="range"] {
            background-color: ${themeSettings.colors.surface} !important;
          }

          input[type="range"]::-webkit-slider-thumb {
            background-color: ${themeSettings.colors.primary} !important;
          }

          input[type="range"]::-moz-range-thumb {
            background-color: ${themeSettings.colors.primary} !important;
          }

          /* Studio Panel */
          .bg-neutral-50.border-b {
            background-color: ${themeSettings.colors.surface} !important;
            border-color: ${themeSettings.mode === 'dark' ? '#444' : '#e5e5e5'} !important;
          }

          /* User Avatar */
          .bg-neutral-900.text-white:not(button) {
            background-color: ${themeSettings.colors.primary} !important;
            color: ${themeSettings.colors.background} !important;
          }

          /* Tooltips */
          .bg-neutral-900.text-white.shadow-xl {
            background-color: ${themeSettings.colors.primary} !important;
            color: ${themeSettings.colors.background} !important;
          }

          /* Modal Backdrops */
          .bg-black.bg-opacity-20,
          .bg-black.bg-opacity-50 {
            background-color: ${themeSettings.mode === 'dark' ? 'rgba(0,0,0,0.7)' : 'rgba(0,0,0,0.3)'} !important;
          }

          /* Scrollbars (Webkit) */
          ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
          }

          ::-webkit-scrollbar-track {
            background: ${themeSettings.colors.surface};
          }

          ::-webkit-scrollbar-thumb {
            background: ${themeSettings.colors.textSecondary};
            border-radius: 5px;
          }

          ::-webkit-scrollbar-thumb:hover {
            background: ${themeSettings.colors.primary};
          }

          /* Focus Ring Colors */
          .focus\\:ring-neutral-900:focus {
            --tw-ring-color: ${themeSettings.colors.primary} !important;
          }

          .focus\\:ring-blue-500:focus {
            --tw-ring-color: ${themeSettings.colors.accent} !important;
          }
        ` }} />
        <style dangerouslySetInnerHTML={{ __html: cardAnimationStyles }} />
        <style dangerouslySetInnerHTML={{ __html: `
          @keyframes fadeInScale {
            from {
              opacity: 0;
              transform: scale(0.8);
            }
            to {
              opacity: 1;
              transform: scale(1);
            }
          }
        ` }} />
      {/* Global Header Bar */}
      <header className={`h-14 bg-white border-b border-neutral-200 flex items-center px-4 sticky z-50 transition-all duration-300 ease-in-out ${
        isComponentPanelOpen ? 'mr-80' : 'mr-0'
      } ${
        isLayerActive('explorer') && explorerIsDocked ? `ml-[${explorerPanelSize.width}px]` : 'ml-0'
      } ${
        isLayerActive('studio') ? 'top-12 shadow-[0_2px_8px_rgba(0,0,0,0.08)]' : 'top-0'
      }`} style={{
        marginLeft: isLayerActive('explorer') && explorerIsDocked ? `${explorerPanelSize.width}px` : '0'
      }}>
        {/* Left Section */}
        <div className="flex items-center gap-3">
          {/* Hamburger Menu */}
          <button
            onClick={() => setIsSidebarOpen(!isSidebarOpen)}
            className="w-8 h-8 flex items-center justify-center text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-colors relative z-[60]"
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>

          {/* Workspace Selector */}
          <div className="relative" data-workspace-selector>
            <button
              onClick={() => setIsWorkspaceSelectorOpen(!isWorkspaceSelectorOpen)}
              className="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-neutral-900 hover:bg-neutral-100 rounded-lg transition-colors"
            >
              <span>Central</span>
              <svg className="w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 9l-7 7-7-7" />
              </svg>
            </button>

            {/* Workspace Dropdown */}
            {isWorkspaceSelectorOpen && (
              <div className="absolute top-full left-0 mt-1 w-56 bg-white border border-neutral-200 rounded-lg shadow-lg py-1 z-50">
                <div className="px-3 py-2 text-xs font-medium text-neutral-500 uppercase tracking-wider">
                  Workspaces
                </div>
                <button className="w-full text-left px-4 py-2 text-sm text-neutral-700 bg-neutral-50 font-medium">
                  Central
                </button>
                <button className="w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 transition-colors">
                  Events
                </button>
                <button className="w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 transition-colors">
                  Publications
                </button>
                <button className="w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 transition-colors">
                  Certifications
                </button>
              </div>
            )}
          </div>

          {/* New Record Button */}
          <div className="relative" data-new-record-menu>
            <button
              onClick={() => setIsNewRecordMenuOpen(!isNewRecordMenuOpen)}
              className="w-8 h-8 flex items-center justify-center text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-colors"
              title="New Record"
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 4v16m8-8H4" />
              </svg>
            </button>

            {/* New Record Dropdown */}
            {isNewRecordMenuOpen && (
              <div className="absolute top-full left-0 mt-1 w-56 bg-white border border-neutral-200 rounded-lg shadow-lg py-1 z-50">
                <div className="px-3 py-2 text-xs font-medium text-neutral-500 uppercase tracking-wider">
                  Create New
                </div>
                <button className="w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 transition-colors flex items-center gap-3">
                  <svg className="w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                  </svg>
                  Member
                </button>
                <button className="w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 transition-colors flex items-center gap-3">
                  <svg className="w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                  Organization
                </button>
                <button className="w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 transition-colors flex items-center gap-3">
                  <svg className="w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  Event
                </button>
                <button className="w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 transition-colors flex items-center gap-3">
                  <svg className="w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  Document
                </button>
                <button
                  onClick={() => {
                    setCanvasType('empty');
                    setView('canvas');
                    setIsNewRecordMenuOpen(false);
                  }}
                  className="w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 transition-colors flex items-center gap-3"
                >
                  <svg className="w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
                  </svg>
                  Page
                </button>
                <button
                  onClick={() => {
                    setView('slide-deck');
                    setDeckView('list');
                    setCurrentDeckId(null);
                    setIsNewRecordMenuOpen(false);
                  }}
                  className="w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 transition-colors flex items-center gap-3"
                >
                  <svg className="w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                  </svg>
                  Slide Deck
                </button>
                <div className="border-t border-neutral-200 my-1"></div>
                <button
                  onClick={() => {
                    setCanvasType('blueprint');
                    setView('canvas');
                    setIsNewRecordMenuOpen(false);
                  }}
                  className="w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 transition-colors flex items-center gap-3"
                >
                  <svg className="w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                  </svg>
                  Blueprint
                </button>
              </div>
            )}
          </div>
        </div>

        {/* Center Section - Global Search */}
        <div className="flex-1 flex justify-center px-4">
          <div className="relative w-full max-w-[420px]">
            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg className="h-4 w-4 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>
            <input
              type="text"
              placeholder="Search across all workspaces..."
              value={globalSearchTerm}
              onChange={(e) => setGlobalSearchTerm(e.target.value)}
              className="w-full pl-10 pr-4 py-2 bg-neutral-50 border border-neutral-200 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-neutral-900 focus:bg-white transition-colors"
            />
          </div>
        </div>

        {/* Right Section */}
        <div className="flex items-center gap-3 pr-14">
          {/* Flex Panel Auto-Arrange - Only show when there are active flex panels */}
          {Object.keys(flexPanelSettings).filter(id => flexPanelSettings[id]?.enabled).length > 0 && (
            <div className="relative" data-flex-panel-arrange>
              <button
                onClick={() => setIsFlexPanelArrangeMenuOpen(!isFlexPanelArrangeMenuOpen)}
                className="w-8 h-8 flex items-center justify-center text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-colors"
                title="Auto-Arrange Flex Panels"
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zM14 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                </svg>
              </button>

              {/* Auto-Arrange Dropdown */}
              {isFlexPanelArrangeMenuOpen && (
                <div className="absolute top-full right-0 mt-1 w-56 bg-white border border-neutral-200 rounded-lg shadow-lg py-1 z-[9999]">
                  <div className="px-3 py-2 text-xs font-medium text-neutral-500 uppercase tracking-wider">
                    Auto-Arrange Flex Panels
                  </div>
                  <button
                    onClick={() => autoArrangeFlexPanels('grid')}
                    className="w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 transition-colors flex items-center gap-3"
                  >
                    <svg className="w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zM14 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                    </svg>
                    Grid Layout
                  </button>
                  <button
                    onClick={() => autoArrangeFlexPanels('side-by-side')}
                    className="w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 transition-colors flex items-center gap-3"
                  >
                    <svg className="w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 4H5a2 2 0 00-2 2v12a2 2 0 002 2h4m0-16v16m0-16h10a2 2 0 012 2v12a2 2 0 01-2 2H9" />
                    </svg>
                    Side by Side
                  </button>
                  <button
                    onClick={() => autoArrangeFlexPanels('stacked')}
                    className="w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 transition-colors flex items-center gap-3"
                  >
                    <svg className="w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                    Vertically Stacked
                  </button>
                  <button
                    onClick={() => autoArrangeFlexPanels('cascade')}
                    className="w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 transition-colors flex items-center gap-3"
                  >
                    <svg className="w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                    </svg>
                    Cascade
                  </button>
                  <button
                    onClick={() => autoArrangeFlexPanels('coverflow')}
                    className="w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 transition-colors flex items-center gap-3"
                  >
                    <svg className="w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                    Cover Flow
                  </button>
                </div>
              )}
            </div>
          )}

          {/* User Menu */}
          <div className="relative" data-user-menu>
            <button
              onClick={() => setIsUserMenuOpen(!isUserMenuOpen)}
              className="w-8 h-8 flex items-center justify-center bg-neutral-900 text-white text-xs font-semibold rounded-full hover:bg-neutral-800 transition-colors"
              title="User Menu"
            >
              JD
            </button>

            {/* User Dropdown */}
            {isUserMenuOpen && (
              <div className="absolute top-full right-0 mt-1 w-56 bg-white border border-neutral-200 rounded-lg shadow-lg py-1 z-50">
                <div className="px-4 py-3 border-b border-neutral-200">
                  <div className="text-sm font-medium text-neutral-900">John Doe</div>
                  <div className="text-xs text-neutral-500 mt-0.5">john.doe@example.com</div>
                </div>
                <button className="w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 transition-colors flex items-center gap-3">
                  <svg className="w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                  </svg>
                  User Settings
                </button>
                <button className="w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 transition-colors flex items-center gap-3">
                  <svg className="w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  Preferences
                </button>
                <div className="border-t border-neutral-200 my-1"></div>
                <button className="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors flex items-center gap-3">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                  </svg>
                  Sign Out
                </button>
              </div>
            )}
          </div>
        </div>
      </header>

      {/* Fixed Component Panel Toggle - stays in position when header moves */}
      <button
        onClick={() => {
          if (isComponentPanelOpen) {
            setIsComponentPanelOpen(false);
            setSelectedFieldId(null);
            setRightPanelTab('elements');
          } else {
            setIsComponentPanelOpen(true);
          }
        }}
        className={`fixed right-4 p-2 text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-all ${
          isLayerActive('studio') ? 'top-[4.75rem]' : 'top-3'
        }`}
        style={{ zIndex: 60 }}
        title={isComponentPanelOpen ? "Close sidebar" : "Open sidebar"}
      >
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          {isComponentPanelOpen ? (
            // Sidebar open icon - lines with gap on right
            <>
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 6h10M4 12h10M4 18h10" />
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M20 6v12" />
            </>
          ) : (
            // Sidebar closed icon - simple sidebar icon
            <>
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 6h16M4 12h16M4 18h16" />
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M20 6v12" />
            </>
          )}
        </svg>
      </button>

      {/* Left Sidebar Navigation Panel */}
      <div
        className={`fixed bottom-0 bg-white border-r border-neutral-200 transform ${
          isSidebarOpen ? 'translate-x-0' : '-translate-x-full'
        } ${
          isLayerActive('studio') ? 'top-30' : 'top-14'
        }`}
        style={{
          width: isSidebarCollapsed ? '64px' : '256px',
          left: explorerIsDocked && isLayerActive('explorer') ? `${explorerPanelSize.width}px` : '0',
          zIndex: (isSidebarOpen && !isSidebarPinned) ? 115 : 110, // Higher z-index when unpinned to overlay FAB icons
          opacity: (explorerIsDocked && isLayerActive('explorer') && !isSidebarOpen && !isSidebarPinned) ? 0 : 1,
          transition: 'transform 300ms cubic-bezier(0.4, 0, 0.2, 1), width 300ms cubic-bezier(0.4, 0, 0.2, 1), left 300ms cubic-bezier(0.4, 0, 0.2, 1), opacity 200ms cubic-bezier(0.4, 0, 0.2, 1)',
        }}
      >
        <div className="h-full flex flex-col overflow-y-auto">
          {/* Main Navigation */}
          <div className="flex-1 py-4">
            <nav className="space-y-1 px-3">
              {/* Home */}
              <button
                className={`w-full flex items-center gap-3 px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors ${
                  isSidebarCollapsed ? 'justify-center' : ''
                }`}
                title={isSidebarCollapsed ? 'Home' : ''}
              >
                <svg className="w-4 h-4 text-neutral-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                {!isSidebarCollapsed && <span>Home</span>}
              </button>

              {/* Contacts */}
              <button
                className={`w-full flex items-center gap-3 px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors ${
                  isSidebarCollapsed ? 'justify-center' : ''
                }`}
                title={isSidebarCollapsed ? 'Contacts' : ''}
              >
                <svg className="w-4 h-4 text-neutral-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                {!isSidebarCollapsed && <span>Contacts</span>}
              </button>

              {/* Tasks */}
              <button
                className={`w-full flex items-center gap-3 px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors ${
                  isSidebarCollapsed ? 'justify-center' : ''
                }`}
                title={isSidebarCollapsed ? 'Tasks' : ''}
              >
                <svg className="w-4 h-4 text-neutral-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                </svg>
                {!isSidebarCollapsed && <span>Tasks</span>}
              </button>

              {/* APPS Section */}
              <div className="pt-4">
                {!isSidebarCollapsed && (
                  <div className="px-3 py-2 text-xs font-semibold text-neutral-500 uppercase tracking-wider">
                    Apps
                  </div>
                )}
                <div className="space-y-1">
                  <button
                    className={`w-full flex items-center gap-3 px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors ${
                      isSidebarCollapsed ? 'justify-center' : ''
                    }`}
                    title={isSidebarCollapsed ? 'Messages' : ''}
                  >
                    <svg className="w-4 h-4 text-neutral-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    {!isSidebarCollapsed && <span>Messages</span>}
                  </button>
                  <button
                    className={`w-full flex items-center gap-3 px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors ${
                      isSidebarCollapsed ? 'justify-center' : ''
                    }`}
                    title={isSidebarCollapsed ? 'Files' : ''}
                  >
                    <svg className="w-4 h-4 text-neutral-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                    </svg>
                    {!isSidebarCollapsed && <span>Files</span>}
                  </button>
                  <button
                    className={`w-full flex items-center gap-3 px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors ${
                      isSidebarCollapsed ? 'justify-center' : ''
                    }`}
                    title={isSidebarCollapsed ? 'Calendar' : ''}
                  >
                    <svg className="w-4 h-4 text-neutral-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    {!isSidebarCollapsed && <span>Calendar</span>}
                  </button>
                  <button
                    className={`w-full flex items-center gap-3 px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors ${
                      isSidebarCollapsed ? 'justify-center' : ''
                    }`}
                    title={isSidebarCollapsed ? 'Reports' : ''}
                  >
                    <svg className="w-4 h-4 text-neutral-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    {!isSidebarCollapsed && <span>Reports</span>}
                  </button>
                  <button
                    className={`w-full flex items-center gap-3 px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors ${
                      isSidebarCollapsed ? 'justify-center' : ''
                    }`}
                    title={isSidebarCollapsed ? 'Add App' : ''}
                  >
                    <svg className="w-4 h-4 text-neutral-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 4v16m8-8H4" />
                    </svg>
                    {!isSidebarCollapsed && <span>Add App</span>}
                  </button>
                </div>
              </div>

              {/* Recently Viewed Section */}
              {!isSidebarCollapsed && (
              <div className="pt-4">
                <div className="px-3 py-2 text-xs font-semibold text-neutral-500 uppercase tracking-wider">
                  Recently Viewed
                </div>
                <div className="space-y-1">
                  <button className="w-full flex items-center gap-3 px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors">
                    <svg className="w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    Jane Doe
                  </button>
                  <button className="w-full flex items-center gap-3 px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors">
                    <svg className="w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    Michael Smith
                  </button>
                  <button className="w-full flex items-center gap-3 px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors">
                    <svg className="w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />
                    </svg>
                    Awards Banquet
                  </button>
                </div>
              </div>
              )}

              {/* Lists Section */}
              {!isSidebarCollapsed && (
              <div className="pt-4">
                <div className="px-3 py-2 text-xs font-semibold text-neutral-500 uppercase tracking-wider">
                  Lists
                </div>
                <div className="space-y-1">
                  {/* Current Members - Expandable */}
                  <div>
                    <button
                      onClick={() => {
                        if (expandedFolders.includes('current-members')) {
                          setExpandedFolders(expandedFolders.filter(f => f !== 'current-members'));
                        } else {
                          setExpandedFolders([...expandedFolders, 'current-members']);
                        }
                      }}
                      className="w-full flex items-center gap-2 px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors"
                    >
                      <svg
                        className={`w-3 h-3 text-neutral-500 transition-transform ${
                          expandedFolders.includes('current-members') ? 'rotate-90' : ''
                        }`}
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 5l7 7-7 7" />
                      </svg>
                      <svg className="w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                      </svg>
                      Current Members
                    </button>

                    {/* Nested items */}
                    {expandedFolders.includes('current-members') && (
                      <div className="ml-6 mt-1 space-y-1">
                        <button className="w-full flex items-center gap-3 px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors">
                          <svg className="w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                          </svg>
                          New members
                        </button>

                        {/* By Type - Nested folder */}
                        <div>
                          <button
                            onClick={() => {
                              if (expandedFolders.includes('by-type')) {
                                setExpandedFolders(expandedFolders.filter(f => f !== 'by-type'));
                              } else {
                                setExpandedFolders([...expandedFolders, 'by-type']);
                              }
                            }}
                            className="w-full flex items-center gap-2 px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors"
                          >
                            <svg
                              className={`w-3 h-3 text-neutral-500 transition-transform ${
                                expandedFolders.includes('by-type') ? 'rotate-90' : ''
                              }`}
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 5l7 7-7 7" />
                            </svg>
                            <svg className="w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                            </svg>
                            By Type
                          </button>

                          {/* Nested items under By Type */}
                          {expandedFolders.includes('by-type') && (
                            <div className="ml-6 mt-1 space-y-1">
                              <button className="w-full flex items-center gap-3 px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors">
                                <svg className="w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Student
                              </button>
                              <button className="w-full flex items-center gap-3 px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors">
                                <svg className="w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Full-Time
                              </button>
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>
              )}

              {/* Channels Section */}
              <div className="pt-4">
                {!isSidebarCollapsed && (
                  <div className="px-3 py-2 text-xs font-semibold text-neutral-500 uppercase tracking-wider">
                    Channels
                  </div>
                )}
                <div className="space-y-1">
                  <button
                    className={`w-full flex items-center gap-3 px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors ${
                      isSidebarCollapsed ? 'justify-center' : ''
                    }`}
                    title={isSidebarCollapsed ? '# Staff' : ''}
                  >
                    <svg className="w-4 h-4 text-neutral-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                    </svg>
                    {!isSidebarCollapsed && <span># Staff</span>}
                  </button>
                  <button
                    className={`w-full flex items-center gap-3 px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors ${
                      isSidebarCollapsed ? 'justify-center' : ''
                    }`}
                    title={isSidebarCollapsed ? '# Events' : ''}
                  >
                    <svg className="w-4 h-4 text-neutral-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                    </svg>
                    {!isSidebarCollapsed && <span># Events</span>}
                  </button>
                  <button
                    className={`w-full flex items-center gap-3 px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors ${
                      isSidebarCollapsed ? 'justify-center' : ''
                    }`}
                    title={isSidebarCollapsed ? '# Finance' : ''}
                  >
                    <svg className="w-4 h-4 text-neutral-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                    </svg>
                    {!isSidebarCollapsed && <span># Finance</span>}
                  </button>
                </div>
              </div>
            </nav>
          </div>

          {/* Settings Footer */}
          <div className="border-t border-neutral-200 p-3">
            <div className="flex items-center gap-2">
              {/* Width Toggle Button */}
              <button
                onClick={() => setIsSidebarCollapsed(!isSidebarCollapsed)}
                className="p-2 text-neutral-500 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-colors"
                title={isSidebarCollapsed ? 'Expand sidebar' : 'Collapse sidebar'}
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  {isSidebarCollapsed ? (
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                  ) : (
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
                  )}
                </svg>
              </button>

              {/* Settings Button */}
              <button className={`flex items-center gap-3 px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors ${
                isSidebarCollapsed ? 'flex-shrink-0' : 'flex-1'
              }`}>
                <svg className="w-4 h-4 text-neutral-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                {!isSidebarCollapsed && <span>Settings</span>}
              </button>

              {/* Pin Button */}
              <button
                onClick={() => setIsSidebarPinned(!isSidebarPinned)}
                className={`p-2 rounded-lg transition-colors ${
                  isSidebarPinned
                    ? 'text-blue-600 bg-blue-50 hover:bg-blue-100'
                    : 'text-neutral-500 hover:text-neutral-900 hover:bg-neutral-100'
                }`}
                title={isSidebarPinned ? 'Unpin sidebar (will auto-close when Explorer opens)' : 'Pin sidebar (stays open with Explorer)'}
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  {isSidebarPinned ? (
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                  ) : (
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                  )}
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      {/* Backdrop for sidebar - only show when NOT pinned (overlay mode) */}
      {isSidebarOpen && !isSidebarPinned && (
        <div
          className="fixed inset-0 bg-black bg-opacity-20 z-[105] transition-opacity"
          onClick={() => setIsSidebarOpen(false)}
        />
      )}

      {/* Main Content Area */}
      <div className="flex-1 flex transition-all duration-300 ease-in-out" style={{
        marginLeft: (() => {
          let leftMargin = 0;
          // Add Explorer width if docked
          if (isLayerActive('explorer') && explorerIsDocked) {
            leftMargin += explorerPanelSize.width;
            // Also add sidebar width if it's pinned and open (sidebar stacks next to Explorer)
            if (isSidebarPinned && isSidebarOpen) {
              leftMargin += isSidebarCollapsed ? 64 : 256;
            }
          } else {
            // Add sidebar width ONLY if pinned AND open AND Explorer is NOT docked
            if (isSidebarPinned && isSidebarOpen) {
              leftMargin += isSidebarCollapsed ? 64 : 256;
            }
          }
          return `${leftMargin}px`;
        })()
      }}>
      {/* Component Library / Form Builder Panel - Slides from Right */}
      <div
        className={`fixed right-0 bottom-0 w-80 bg-white border-l border-neutral-200 transform z-50 ${
          isComponentPanelOpen ? 'translate-x-0' : 'translate-x-full'
        } ${
          isLayerActive('studio') ? 'top-16' : 'top-0'
        }`}
        style={{
          transition: 'transform 300ms cubic-bezier(0.4, 0, 0.2, 1)',
        }}
      >
        <div className="h-full flex flex-col">
          {/* Panel Header with Tabs - aligned with global bar height */}
          <div className="h-14 border-b border-neutral-200 flex items-center">
            {/* Tabs */}
            <div className="flex w-full">
              <button
                onClick={() => setRightPanelTab('elements')}
                className={`flex-1 px-6 py-3 text-sm font-medium transition-colors ${
                  rightPanelTab === 'elements'
                    ? 'text-neutral-900 border-b-2 border-neutral-900'
                    : 'text-neutral-500 hover:text-neutral-700'
                }`}
              >
                Elements
              </button>
              <button
                onClick={() => setRightPanelTab('settings')}
                className={`flex-1 px-6 py-3 text-sm font-medium transition-colors ${
                  rightPanelTab === 'settings'
                    ? 'text-neutral-900 border-b-2 border-neutral-900'
                    : 'text-neutral-500 hover:text-neutral-700'
                }`}
              >
                Settings
              </button>
            </div>
          </div>

          {/* Dynamic Content */}
          <div className="flex-1 overflow-y-auto px-4 py-4">
            {rightPanelTab === 'elements' ? (
              <div className="space-y-6">
                {/* Elements Section (Blocks, Containers, Combos) */}
                <div>
                  <h3 className="text-xs font-semibold text-neutral-500 uppercase tracking-wider mb-3 px-1">Elements</h3>

                  {/* Search Filter */}
                  <div className="relative mb-3">
                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                      <svg className="h-4 w-4 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                      </svg>
                    </div>
                    <input
                      type="text"
                      placeholder="Search elements..."
                      value={elementSearchFilter}
                      onChange={(e) => setElementSearchFilter(e.target.value)}
                      className="w-full pl-10 pr-3 py-2 text-sm border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-neutral-900 focus:border-transparent"
                    />
                    {elementSearchFilter && (
                      <button
                        onClick={() => setElementSearchFilter('')}
                        className="absolute inset-y-0 right-0 pr-3 flex items-center text-neutral-400 hover:text-neutral-600"
                      >
                        <svg className="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    )}
                  </div>

                  {/* Category Filter Dropdown */}
                  <div className="mb-3">
                    <select
                      value={elementCategoryFilter}
                      onChange={(e) => setElementCategoryFilter(e.target.value)}
                      className="w-full px-3 py-2 text-sm border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-neutral-900 focus:border-transparent bg-white"
                    >
                      <option value="all">All Elements</option>
                      <option value="blocks">Blocks</option>
                      <option value="containers">Containers</option>
                      <option value="combos">Combos</option>
                      <option value="fields">Fields</option>
                    </select>
                  </div>

                  {/* Elements List */}
                  <div className="space-y-2">
                    {filteredElements.length > 0 ? (
                      filteredElements.map((element) => (
                        element.isField ? (
                          // Render field items with drag + click functionality
                          <div
                            key={element.id}
                            draggable
                            onDragStart={(e) => {
                              e.dataTransfer.effectAllowed = 'copy';
                              e.dataTransfer.setData('fieldType', element.id);
                              setDraggedFieldType(element.id);
                              // Also track for Quick Access drop
                              setDraggedElement({
                                id: element.id,
                                name: element.name,
                                icon: element.icon,
                                type: 'field'
                              });
                            }}
                            onDragEnd={(e) => {
                              handleDragEnd(e);
                              setDraggedElement(null);
                              setIsQuickAccessDropTarget(false);
                            }}
                            className="relative group cursor-grab active:cursor-grabbing pl-3"
                          >
                            {/* Drag Handle */}
                            <div className="absolute left-0 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity z-10 pointer-events-none">
                              <svg className="w-4 h-4 text-neutral-400" fill="currentColor" viewBox="0 0 20 20">
                                <circle cx="7" cy="4" r="1.5" />
                                <circle cx="13" cy="4" r="1.5" />
                                <circle cx="7" cy="10" r="1.5" />
                                <circle cx="13" cy="10" r="1.5" />
                                <circle cx="7" cy="16" r="1.5" />
                                <circle cx="13" cy="16" r="1.5" />
                              </svg>
                            </div>

                            <div
                              onClick={() => addFormField(element)}
                              className="w-full flex items-start gap-4 pr-4 py-3 rounded-lg hover:bg-neutral-50 transition-colors"
                            >
                              <div className="flex-shrink-0 w-10 h-10 rounded-lg bg-neutral-100 group-hover:bg-neutral-200 transition-colors flex items-center justify-center">
                                <svg className="w-5 h-5 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  {getIconSvg(element.icon)}
                                </svg>
                              </div>
                              <div className="flex-1 min-w-0">
                                <div className="text-sm font-medium text-neutral-900">{element.name}</div>
                                <div className="text-xs text-neutral-500 mt-0.5">{element.description}</div>
                              </div>
                            </div>
                          </div>
                        ) : (
                          // Render element items using DraggableCardPanelItem
                          <DraggableCardPanelItem key={element.id} element={element} />
                        )
                      ))
                    ) : (
                      <div className="text-center py-8 text-neutral-500">
                        <svg className="mx-auto h-12 w-12 text-neutral-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p className="text-sm">No elements found</p>
                        <p className="text-xs mt-1">Try a different search or filter</p>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            ) : rightPanelTab === 'settings' ? (
              /* Unified Element Settings View (handles all cards including former sections) */
              selectedElementForSettings ? (
                /* Element Layout Settings - Using Shared Components */
                (() => {
                  // Find the selected card instance - check both droppedElements and detailPageLayouts
                  let selectedElement = droppedElements.find(e => e.id === selectedElementForSettings);

                  // For block cards (former sections), check detailPageLayouts
                  if (!selectedElement && selectedRecord) {
                    const layout = getAllDetailElements(selectedRecord.id);
                    selectedElement = layout.find(item => item.id === selectedElementForSettings);
                  }

                  if (!selectedElement) return null;

                  const elementDef = componentElements.find(e => e.id === selectedElement.elementType);
                  if (!elementDef) return null;

                  // Determine if this is a block card (stored in layout) or user-dragged card (stored in droppedElements)
                  const isRecordDataCard = elementDef?.type === 'block';
                  const isInDroppedCards = droppedElements.some(e => e.id === selectedElementForSettings);

                  // Calculate collision data for collision detection
                  const shouldShowCollisionWarning =
                    !pageSettings.detail.smartLayout &&
                    view === 'detail' &&
                    pageSettings.detail.columns > 1 &&
                    selectedRecord?.id;

                  const collisionData = shouldShowCollisionWarning ? detectCollisions(selectedElement.id) : null;

                  return (
                    <div className="space-y-6">
                      <SettingsHeader
                        title={`${elementDef.name} ${elementDef.isContainer ? 'Container' : 'Card'}`}
                        subtitle={elementDef.isContainer ? 'Configure container preset and layout' : 'Choose a layout for this card'}
                        onBack={() => setSelectedElementForSettings(null)}
                      />

                      {/* Flex Panel Toggle - Available for all elements except spacers */}
                      {selectedElement.elementType !== 'spacer' && (
                        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-100">
                          <div className="flex items-start justify-between">
                            <div className="flex-1">
                              <div className="flex items-center gap-2 mb-1">
                                <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                                </svg>
                                <h3 className="text-sm font-semibold text-neutral-900">Flex Panel Mode</h3>
                              </div>
                              <p className="text-xs text-neutral-600 leading-relaxed">
                                Transform this {elementDef.isContainer ? 'container' : 'block'} into a floating, resizable panel that can be positioned anywhere on the page
                              </p>
                            </div>
                            <button
                              onClick={() => toggleFlexPanel(selectedElementForSettings)}
                              className={`ml-3 relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2 ${
                                isFlexPanelEnabled(selectedElementForSettings) ? 'bg-blue-600' : 'bg-neutral-200'
                              }`}
                            >
                              <span
                                className={`pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out ${
                                  isFlexPanelEnabled(selectedElementForSettings) ? 'translate-x-5' : 'translate-x-0'
                                }`}
                              />
                            </button>
                          </div>

                          {/* Additional info when enabled */}
                          {isFlexPanelEnabled(selectedElementForSettings) && (
                            <div className="mt-3 pt-3 border-t border-blue-200">
                              <p className="text-xs text-blue-700 flex items-center gap-1.5">
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Drag the header to reposition, use handles to resize, and controls to minimize/maximize
                              </p>
                            </div>
                          )}
                        </div>
                      )}

                      {/* Spacer-specific settings */}
                      {selectedElement.elementType === 'spacer' ? (
                        <div>
                          <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">
                            Height: {selectedElement.height ?? 48}px
                          </label>
                          <input
                            type="range"
                            min="0"
                            max="1440"
                            step="8"
                            value={selectedElement.height ?? 48}
                            onChange={(e) => {
                              const newHeight = parseInt(e.target.value);
                              // Update droppedElements
                              setDroppedElements(prev => prev.map(e =>
                                e.id === selectedElementForSettings
                                  ? { ...e, height: newHeight }
                                  : e
                              ));
                              // Also update detailPageLayouts if element is in detail view
                              if (view === 'detail' && selectedRecord) {
                                setDetailPageLayouts(prev => ({
                                  ...prev,
                                  [selectedRecord.id]: (prev[selectedRecord.id] || getDefaultDetailLayout(selectedRecord.id)).map(item =>
                                    item.id === selectedElementForSettings
                                      ? { ...item, height: newHeight }
                                      : item
                                  )
                                }));
                              }
                            }}
                            className="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer accent-neutral-900"
                          />
                          <div className="flex justify-between text-xs text-neutral-400 mt-1">
                            <span>0px</span>
                            <span>1440px</span>
                          </div>
                        </div>
                      ) : (
                        <>
                          {/* Grid Layout Settings - for grid-layout containers */}
                          {elementDef.id === 'grid-layout' ? (
                            <>
                              <div>
                                <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">
                                  Grid Columns: {gridSettings[selectedElementForSettings]?.cols || 12}
                                </label>
                                <input
                                  type="range"
                                  min="1"
                                  max="24"
                                  step="1"
                                  value={gridSettings[selectedElementForSettings]?.cols || 12}
                                  onChange={(e) => {
                                    const newCols = parseInt(e.target.value);
                                    setGridSettings(prev => ({
                                      ...prev,
                                      [selectedElementForSettings]: {
                                        ...prev[selectedElementForSettings],
                                        cols: newCols
                                      }
                                    }));
                                  }}
                                  className="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer accent-neutral-900"
                                />
                                <div className="flex justify-between text-xs text-neutral-400 mt-1">
                                  <span>1</span>
                                  <span>24</span>
                                </div>
                              </div>

                              <div>
                                <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">
                                  Row Height: {gridSettings[selectedElementForSettings]?.rowHeight || 60}px
                                </label>
                                <input
                                  type="range"
                                  min="20"
                                  max="200"
                                  step="10"
                                  value={gridSettings[selectedElementForSettings]?.rowHeight || 60}
                                  onChange={(e) => {
                                    const newRowHeight = parseInt(e.target.value);
                                    setGridSettings(prev => ({
                                      ...prev,
                                      [selectedElementForSettings]: {
                                        ...prev[selectedElementForSettings],
                                        rowHeight: newRowHeight
                                      }
                                    }));
                                  }}
                                  className="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer accent-neutral-900"
                                />
                                <div className="flex justify-between text-xs text-neutral-400 mt-1">
                                  <span>20px</span>
                                  <span>200px</span>
                                </div>
                              </div>

                              <div>
                                <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">
                                  Grid Spacing: {gridSettings[selectedElementForSettings]?.margin || 8}px
                                </label>
                                <input
                                  type="range"
                                  min="0"
                                  max="32"
                                  step="4"
                                  value={gridSettings[selectedElementForSettings]?.margin || 8}
                                  onChange={(e) => {
                                    const newMargin = parseInt(e.target.value);
                                    setGridSettings(prev => ({
                                      ...prev,
                                      [selectedElementForSettings]: {
                                        ...prev[selectedElementForSettings],
                                        margin: newMargin
                                      }
                                    }));
                                  }}
                                  className="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer accent-neutral-900"
                                />
                                <div className="flex justify-between text-xs text-neutral-400 mt-1">
                                  <span>0px</span>
                                  <span>32px</span>
                                </div>
                              </div>

                              <div>
                                <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">
                                  Layout Mode
                                </label>
                                <div className="space-y-2">
                                  <label className="flex items-center gap-2 cursor-pointer p-3 border border-neutral-200 rounded-lg hover:border-neutral-300 hover:bg-neutral-50 transition-colors">
                                    <input
                                      type="radio"
                                      name="compactType"
                                      value="vertical"
                                      checked={(gridSettings[selectedElementForSettings]?.compactType || 'vertical') === 'vertical'}
                                      onChange={(e) => {
                                        setGridSettings(prev => ({
                                          ...prev,
                                          [selectedElementForSettings]: {
                                            ...prev[selectedElementForSettings],
                                            compactType: 'vertical'
                                          }
                                        }));
                                      }}
                                      className="w-4 h-4 text-neutral-900 border-neutral-300 focus:ring-neutral-900"
                                    />
                                    <div className="flex-1">
                                      <div className="text-sm font-medium text-neutral-900">Vertical Compact</div>
                                      <div className="text-xs text-neutral-500">Items stack vertically with minimal gaps</div>
                                    </div>
                                  </label>
                                  <label className="flex items-center gap-2 cursor-pointer p-3 border border-neutral-200 rounded-lg hover:border-neutral-300 hover:bg-neutral-50 transition-colors">
                                    <input
                                      type="radio"
                                      name="compactType"
                                      value="horizontal"
                                      checked={(gridSettings[selectedElementForSettings]?.compactType || 'vertical') === 'horizontal'}
                                      onChange={(e) => {
                                        setGridSettings(prev => ({
                                          ...prev,
                                          [selectedElementForSettings]: {
                                            ...prev[selectedElementForSettings],
                                            compactType: 'horizontal'
                                          }
                                        }));
                                      }}
                                      className="w-4 h-4 text-neutral-900 border-neutral-300 focus:ring-neutral-900"
                                    />
                                    <div className="flex-1">
                                      <div className="text-sm font-medium text-neutral-900">Horizontal Compact</div>
                                      <div className="text-xs text-neutral-500">Items fill horizontally first</div>
                                    </div>
                                  </label>
                                  <label className="flex items-center gap-2 cursor-pointer p-3 border border-neutral-200 rounded-lg hover:border-neutral-300 hover:bg-neutral-50 transition-colors">
                                    <input
                                      type="radio"
                                      name="compactType"
                                      value="none"
                                      checked={(gridSettings[selectedElementForSettings]?.compactType ?? 'vertical') === null || gridSettings[selectedElementForSettings]?.compactType === 'none'}
                                      onChange={(e) => {
                                        setGridSettings(prev => ({
                                          ...prev,
                                          [selectedElementForSettings]: {
                                            ...prev[selectedElementForSettings],
                                            compactType: null
                                          }
                                        }));
                                      }}
                                      className="w-4 h-4 text-neutral-900 border-neutral-300 focus:ring-neutral-900"
                                    />
                                    <div className="flex-1">
                                      <div className="text-sm font-medium text-neutral-900">Free Form</div>
                                      <div className="text-xs text-neutral-500">Items stay where you place them</div>
                                    </div>
                                  </label>
                                </div>
                              </div>
                            </>
                          ) : elementDef.isContainer && elementDef.containerPreset ? (
                            <div>
                              <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">
                                Preset
                              </label>
                              <div className="space-y-2">
                                {Object.entries(containerPresets).map(([presetKey, preset]) => (
                                  <label
                                    key={presetKey}
                                    className="flex items-start gap-3 p-3 border border-neutral-200 rounded-lg hover:border-neutral-300 hover:bg-neutral-50 cursor-pointer transition-colors"
                                  >
                                    <input
                                      type="radio"
                                      name="containerPreset"
                                      value={presetKey}
                                      checked={(selectedElement.containerPreset || elementDef.containerPreset) === presetKey}
                                      onChange={(e) => {
                                        const newPreset = e.target.value;
                                        const maxColumns = selectedElement.context === 'detail' ? pageSettings.detail.columns : 1;
                                        const autoColumnSpan = newPreset === 'section' ? maxColumns : 1;

                                        // Update droppedElements
                                        setDroppedElements(prev => prev.map(el =>
                                          el.id === selectedElementForSettings
                                            ? { ...el, containerPreset: newPreset, columnSpan: autoColumnSpan }
                                            : el
                                        ));
                                        // Also update detailPageLayouts if element is in detail view
                                        if (view === 'detail' && selectedRecord) {
                                          setDetailPageLayouts(prev => ({
                                            ...prev,
                                            [selectedRecord.id]: (prev[selectedRecord.id] || getDefaultDetailLayout(selectedRecord.id)).map(item =>
                                              item.id === selectedElementForSettings
                                                ? { ...item, containerPreset: newPreset, columnSpan: autoColumnSpan }
                                                : item
                                            )
                                          }));
                                        }
                                      }}
                                      className="mt-1 w-4 h-4 text-neutral-900 border-neutral-300 focus:ring-neutral-900"
                                    />
                                    <div className="flex-1">
                                      <div className="text-sm font-medium text-neutral-900">{preset.label}</div>
                                      <div className="text-xs text-neutral-500 mt-0.5">{preset.description}</div>
                                    </div>
                                  </label>
                                ))}
                              </div>
                            </div>
                          ) : (
                            /* Layout Selector - for blocks (non-containers) */
                            <LayoutSelector
                              currentLayout={selectedElement.layout}
                              onLayoutChange={(layoutId) => {
                                // Update either droppedElements or detailPageLayouts depending on card type
                                if (isInDroppedCards) {
                                  setDroppedElements(prev => prev.map(e =>
                                    e.id === selectedElementForSettings
                                      ? { ...e, layout: layoutId }
                                      : e
                                  ));
                                } else {
                                  setDetailPageLayouts(prev => ({
                                    ...prev,
                                    [selectedRecord.id]: (prev[selectedRecord.id] || getDefaultDetailLayout(selectedRecord.id)).map(item =>
                                      item.id === selectedElementForSettings
                                        ? { ...item, layout: layoutId }
                                        : item
                                    )
                                  }));
                                }
                              }}
                            />
                          )}

                          <BorderWidthControl
                                value={selectedElement.borderWidth}
                                onChange={(newWidth) => {
                                  // Update either droppedElements or detailPageLayouts depending on card type
                                  if (isInDroppedCards) {
                                    setDroppedElements(prev => prev.map(e =>
                                      e.id === selectedElementForSettings
                                        ? { ...e, borderWidth: newWidth }
                                        : e
                                    ));
                                  } else {
                                    setDetailPageLayouts(prev => ({
                                      ...prev,
                                      [selectedRecord.id]: (prev[selectedRecord.id] || getDefaultDetailLayout(selectedRecord.id)).map(item =>
                                        item.id === selectedElementForSettings
                                          ? { ...item, borderWidth: newWidth }
                                          : item
                                      )
                                    }));
                                  }
                                }}
                              />

                              <ColumnSpanControl
                            value={selectedElement.columnSpan}
                            maxColumns={selectedElement.context === 'detail' ? pageSettings.detail.columns : 1}
                            onChange={(newSpan) => {
                              // Update either droppedElements or detailPageLayouts depending on card type
                              if (isInDroppedCards) {
                                setDroppedElements(prev => prev.map(e =>
                                  e.id === selectedElementForSettings
                                    ? { ...e, columnSpan: newSpan }
                                    : e
                                ));
                              } else {
                                setDetailPageLayouts(prev => ({
                                  ...prev,
                                  [selectedRecord.id]: (prev[selectedRecord.id] || getDefaultDetailLayout(selectedRecord.id)).map(item =>
                                    item.id === selectedElementForSettings
                                      ? { ...item, columnSpan: newSpan }
                                      : item
                                  )
                                }));
                              }
                            }}
                            showCollisionWarning={shouldShowCollisionWarning}
                            collisionData={collisionData}
                            elementType={isRecordDataCard ? elementDef.recordType : 'card'}
                            onFixCollision={collisionData?.hasCollision ? autoInsertSpacers : null}
                            onFixCollisionMouseEnter={collisionData?.hasCollision ? () => {
                              const colsWithCollisions = [...new Set(collisionData.collisions.map(e => e.columnIndex))];
                              setHighlightedColumns(colsWithCollisions);
                            } : null}
                            onFixCollisionMouseLeave={collisionData?.hasCollision ? () => {
                              setHighlightedColumns([]);
                            } : null}
                            fixCollisionButtonLabel="Add Spacers to Fix Collision"
                          />
                        </>
                      )}

                      {/* Layer Controls (z-index) - Available for ALL elements including spacers */}
                      <div>
                        <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">
                          Layer Order: z-index {selectedElement.zIndex ?? 1}
                        </label>
                        <div className="grid grid-cols-2 gap-2">
                          <button
                            onClick={() => {
                              // Send to Back (z-index = 0)
                              const updateFn = (e) => e.id === selectedElementForSettings ? { ...e, zIndex: 0 } : e;
                              if (isInDroppedCards) {
                                setDroppedElements(prev => prev.map(updateFn));
                              } else {
                                setDetailPageLayouts(prev => ({
                                  ...prev,
                                  [selectedRecord.id]: (prev[selectedRecord.id] || getDefaultDetailLayout(selectedRecord.id)).map(updateFn)
                                }));
                              }
                            }}
                            className="flex items-center justify-center gap-1 px-3 py-2 text-xs font-medium text-neutral-700 bg-white border border-neutral-300 rounded-lg hover:bg-neutral-50 hover:border-neutral-400 transition-colors"
                          >
                            <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 9l-7 7-7-7" />
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 14l-7 7-7-7" />
                            </svg>
                            Send to Back
                          </button>
                          <button
                            onClick={() => {
                              // Move Backward (z-index - 1, min 0)
                              const newZIndex = Math.max(0, (selectedElement.zIndex ?? 1) - 1);
                              const updateFn = (e) => e.id === selectedElementForSettings ? { ...e, zIndex: newZIndex } : e;
                              if (isInDroppedCards) {
                                setDroppedElements(prev => prev.map(updateFn));
                              } else {
                                setDetailPageLayouts(prev => ({
                                  ...prev,
                                  [selectedRecord.id]: (prev[selectedRecord.id] || getDefaultDetailLayout(selectedRecord.id)).map(updateFn)
                                }));
                              }
                            }}
                            className="flex items-center justify-center gap-1 px-3 py-2 text-xs font-medium text-neutral-700 bg-white border border-neutral-300 rounded-lg hover:bg-neutral-50 hover:border-neutral-400 transition-colors"
                          >
                            <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 9l-7 7-7-7" />
                            </svg>
                            Move Back
                          </button>
                          <button
                            onClick={() => {
                              // Move Forward (z-index + 1, max 999)
                              const newZIndex = Math.min(999, (selectedElement.zIndex ?? 1) + 1);
                              const updateFn = (e) => e.id === selectedElementForSettings ? { ...e, zIndex: newZIndex } : e;
                              if (isInDroppedCards) {
                                setDroppedElements(prev => prev.map(updateFn));
                              } else {
                                setDetailPageLayouts(prev => ({
                                  ...prev,
                                  [selectedRecord.id]: (prev[selectedRecord.id] || getDefaultDetailLayout(selectedRecord.id)).map(updateFn)
                                }));
                              }
                            }}
                            className="flex items-center justify-center gap-1 px-3 py-2 text-xs font-medium text-neutral-700 bg-white border border-neutral-300 rounded-lg hover:bg-neutral-50 hover:border-neutral-400 transition-colors"
                          >
                            <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M5 15l7-7 7 7" />
                            </svg>
                            Move Forward
                          </button>
                          <button
                            onClick={() => {
                              // Bring to Front (z-index = 999)
                              const updateFn = (e) => e.id === selectedElementForSettings ? { ...e, zIndex: 999 } : e;
                              if (isInDroppedCards) {
                                setDroppedElements(prev => prev.map(updateFn));
                              } else {
                                setDetailPageLayouts(prev => ({
                                  ...prev,
                                  [selectedRecord.id]: (prev[selectedRecord.id] || getDefaultDetailLayout(selectedRecord.id)).map(updateFn)
                                }));
                              }
                            }}
                            className="flex items-center justify-center gap-1 px-3 py-2 text-xs font-medium text-neutral-700 bg-white border border-neutral-300 rounded-lg hover:bg-neutral-50 hover:border-neutral-400 transition-colors"
                          >
                            <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M5 10l7-7 7 7" />
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M5 15l7-7 7 7" />
                            </svg>
                            Bring to Front
                          </button>
                        </div>
                        <p className="text-xs text-neutral-500 mt-2">
                          Control which elements appear in front or behind others
                        </p>
                      </div>

                      <SettingsFooter onDone={() => setSelectedElementForSettings(null)} />
                    </div>
                  );
                })()
              ) : selectedFieldId ? (
                <div className="space-y-6">
                  {(() => {
                    const field = formFields.find(f => f.id === selectedFieldId);
                    if (!field) return null;

                    return (
                      <>
                        {/* Back Button and Field Label */}
                        <div>
                          <div className="flex items-center gap-2 mb-2">
                            <button
                              onClick={() => setSelectedFieldId(null)}
                              className="flex-shrink-0 p-1 text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100 rounded transition-colors"
                              title="Back to settings"
                            >
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M15 19l-7-7 7-7" />
                              </svg>
                            </button>
                            <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider">
                              Field Label
                            </label>
                          </div>
                          <input
                            type="text"
                            value={field.label}
                            onChange={(e) => updateField(field.id, { label: e.target.value })}
                            className="w-full px-3 py-2 border border-neutral-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-neutral-900"
                          />
                        </div>

                        {/* Field Type */}
                        <div>
                          <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2">
                            Field Type
                          </label>
                          <div className="text-sm text-neutral-900 px-3 py-2 bg-neutral-50 rounded-lg">
                            {fieldTypes.find(ft => ft.id === field.type)?.name || field.type}
                          </div>
                        </div>

                        {/* Required */}
                        <div>
                          <label className="flex items-center gap-2 cursor-pointer">
                            <input
                              type="checkbox"
                              checked={field.required}
                              onChange={(e) => updateField(field.id, { required: e.target.checked })}
                              className="rounded border-neutral-300 text-neutral-900 focus:ring-neutral-500"
                            />
                            <span className="text-sm text-neutral-700">Required field</span>
                          </label>
                        </div>

                        {/* Name Sub-fields (for name type) */}
                        {field.type === 'name' && field.subFields && (
                          <>
                            {/* Layout Option */}
                            <div>
                              <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2">
                                Layout
                              </label>
                              <div className="flex gap-2">
                                <button
                                  onClick={() => updateField(field.id, { layout: 'vertical' })}
                                  className={`flex-1 px-4 py-2 text-sm rounded-lg transition-colors ${
                                    field.layout === 'vertical'
                                      ? 'bg-neutral-900 text-white'
                                      : 'bg-neutral-100 text-neutral-700 hover:bg-neutral-200'
                                  }`}
                                >
                                  Vertical
                                </button>
                                <button
                                  onClick={() => updateField(field.id, { layout: 'horizontal' })}
                                  className={`flex-1 px-4 py-2 text-sm rounded-lg transition-colors ${
                                    field.layout === 'horizontal'
                                      ? 'bg-neutral-900 text-white'
                                      : 'bg-neutral-100 text-neutral-700 hover:bg-neutral-200'
                                  }`}
                                >
                                  Horizontal
                                </button>
                              </div>
                            </div>

                            {/* Predefined Prefix/Suffix Options */}
                            <div className="space-y-3">
                              <label className="flex items-center gap-2 cursor-pointer">
                                <input
                                  type="checkbox"
                                  checked={field.usePredefinedPrefix || false}
                                  onChange={(e) => updateField(field.id, { usePredefinedPrefix: e.target.checked })}
                                  className="rounded border-neutral-300 text-neutral-900 focus:ring-neutral-500"
                                />
                                <span className="text-sm text-neutral-700">Use predefined prefix options</span>
                              </label>

                              <label className="flex items-center gap-2 cursor-pointer">
                                <input
                                  type="checkbox"
                                  checked={field.usePredefinedSuffix || false}
                                  onChange={(e) => updateField(field.id, { usePredefinedSuffix: e.target.checked })}
                                  className="rounded border-neutral-300 text-neutral-900 focus:ring-neutral-500"
                                />
                                <span className="text-sm text-neutral-700">Use predefined suffix options</span>
                              </label>
                            </div>

                            <div>
                              <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">
                                Name Fields
                              </label>
                            <div className="space-y-2">
                              {field.subFields.map((subField, idx) => (
                                <div
                                  key={subField.id}
                                  className="flex items-center gap-3 p-3 bg-neutral-50 rounded-lg hover:bg-neutral-100 transition-colors"
                                >
                                  {/* Drag Handle */}
                                  <button
                                    onMouseDown={(e) => {
                                      // Prevent selection
                                      e.preventDefault();
                                    }}
                                    onClick={() => {
                                      if (idx === 0) return;
                                      const newSubFields = [...field.subFields];
                                      [newSubFields[idx - 1], newSubFields[idx]] = [newSubFields[idx], newSubFields[idx - 1]];
                                      updateField(field.id, { subFields: newSubFields });
                                    }}
                                    disabled={idx === 0}
                                    className={`flex-shrink-0 p-1 ${idx === 0 ? 'opacity-30 cursor-not-allowed' : 'hover:bg-neutral-200 cursor-pointer'} rounded transition-colors`}
                                    title="Move up"
                                  >
                                    <svg className="w-4 h-4 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M5 15l7-7 7 7" />
                                    </svg>
                                  </button>

                                  <button
                                    onMouseDown={(e) => {
                                      e.preventDefault();
                                    }}
                                    onClick={() => {
                                      if (idx === field.subFields.length - 1) return;
                                      const newSubFields = [...field.subFields];
                                      [newSubFields[idx], newSubFields[idx + 1]] = [newSubFields[idx + 1], newSubFields[idx]];
                                      updateField(field.id, { subFields: newSubFields });
                                    }}
                                    disabled={idx === field.subFields.length - 1}
                                    className={`flex-shrink-0 p-1 ${idx === field.subFields.length - 1 ? 'opacity-30 cursor-not-allowed' : 'hover:bg-neutral-200 cursor-pointer'} rounded transition-colors`}
                                    title="Move down"
                                  >
                                    <svg className="w-4 h-4 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 9l-7 7-7-7" />
                                    </svg>
                                  </button>

                                  {/* Label */}
                                  <span className="flex-1 text-sm text-neutral-900 font-medium">
                                    {subField.label}
                                  </span>

                                  {/* Show/Hide Toggle */}
                                  <button
                                    onClick={() => {
                                      const newSubFields = field.subFields.map(sf =>
                                        sf.id === subField.id ? { ...sf, visible: !sf.visible } : sf
                                      );
                                      updateField(field.id, { subFields: newSubFields });
                                    }}
                                    className="flex-shrink-0 p-1.5 hover:bg-neutral-200 rounded transition-colors"
                                    title={subField.visible ? 'Hide field' : 'Show field'}
                                  >
                                    {subField.visible ? (
                                      <svg className="w-4 h-4 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                      </svg>
                                    ) : (
                                      <svg className="w-4 h-4 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                                      </svg>
                                    )}
                                  </button>
                                </div>
                              ))}
                            </div>
                            <p className="mt-2 text-xs text-neutral-500">
                              Use the arrows to reorder and the eye icon to show/hide fields
                            </p>
                          </div>
                          </>
                        )}

                        {/* Placeholder (for text fields) */}
                        {(field.type === 'single-line' || field.type === 'multiline') && (
                          <div>
                            <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2">
                              Placeholder
                            </label>
                            <input
                              type="text"
                              value={field.placeholder || ''}
                              onChange={(e) => updateField(field.id, { placeholder: e.target.value })}
                              className="w-full px-3 py-2 border border-neutral-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-neutral-900"
                              placeholder="Enter placeholder text..."
                            />
                          </div>
                        )}

                        {/* Options (for select fields) */}
                        {field.type.includes('select') && (
                          <div>
                            <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2">
                              Options
                            </label>
                            <textarea
                              value={field.options?.join('\n') || ''}
                              onChange={(e) => updateField(field.id, { options: e.target.value.split('\n') })}
                              rows={6}
                              className="w-full px-3 py-2 border border-neutral-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-neutral-900 font-mono"
                              placeholder="Enter one option per line..."
                            />
                            <p className="mt-2 text-xs text-neutral-500">One option per line</p>
                          </div>
                        )}

                        {/* Delete Field Button */}
                        <div className="pt-4 border-t border-neutral-200">
                          <button
                            onClick={() => deleteField(field.id)}
                            className="w-full px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                          >
                            Delete Field
                          </button>
                        </div>
                      </>
                    );
                  })()}
                </div>
              ) : (
                /* Settings Navigation - Hierarchical Menu */
                !settingsCategory ? (
                  /* Main Settings Menu */
                  <div className="space-y-3">
                    <div className="mb-6">
                      <h3 className="text-sm font-semibold text-neutral-900 mb-1">Settings</h3>
                      <p className="text-xs text-neutral-500">Configure your workspace and theme</p>
                    </div>

                    {/* Settings Options */}
                    <button
                      onClick={() => {
                        setSelectedElementForSettings(null);
                        setSettingsCategory('element');
                      }}
                      className="w-full flex items-center justify-between p-4 bg-white border border-neutral-200 rounded-lg hover:border-neutral-300 hover:shadow-sm transition-all group"
                    >
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center group-hover:bg-blue-100 transition-colors">
                          <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-3zM14 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1h-4a1 1 0 01-1-1v-3z" />
                          </svg>
                        </div>
                        <div className="text-left">
                          <div className="text-sm font-medium text-neutral-900">Element Settings</div>
                          <div className="text-xs text-neutral-500">Configure individual elements</div>
                        </div>
                      </div>
                      <svg className="w-5 h-5 text-neutral-400 group-hover:text-neutral-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 5l7 7-7 7" />
                      </svg>
                    </button>

                    <button
                      onClick={() => setSettingsCategory('page')}
                      className="w-full flex items-center justify-between p-4 bg-white border border-neutral-200 rounded-lg hover:border-neutral-300 hover:shadow-sm transition-all group"
                    >
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-lg bg-purple-50 flex items-center justify-center group-hover:bg-purple-100 transition-colors">
                          <svg className="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                          </svg>
                        </div>
                        <div className="text-left">
                          <div className="text-sm font-medium text-neutral-900">Page Settings</div>
                          <div className="text-xs text-neutral-500">Layout and container options</div>
                        </div>
                      </div>
                      <svg className="w-5 h-5 text-neutral-400 group-hover:text-neutral-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 5l7 7-7 7" />
                      </svg>
                    </button>

                    <button
                      onClick={() => setSettingsCategory('workspace')}
                      className="w-full flex items-center justify-between p-4 bg-white border border-neutral-200 rounded-lg hover:border-neutral-300 hover:shadow-sm transition-all group"
                    >
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-lg bg-green-50 flex items-center justify-center group-hover:bg-green-100 transition-colors">
                          <svg className="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                          </svg>
                        </div>
                        <div className="text-left">
                          <div className="text-sm font-medium text-neutral-900">Workspace Settings</div>
                          <div className="text-xs text-neutral-500">General workspace preferences</div>
                        </div>
                      </div>
                      <svg className="w-5 h-5 text-neutral-400 group-hover:text-neutral-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 5l7 7-7 7" />
                      </svg>
                    </button>

                    <button
                      onClick={() => setSettingsCategory('themes')}
                      className="w-full flex items-center justify-between p-4 bg-white border border-neutral-200 rounded-lg hover:border-neutral-300 hover:shadow-sm transition-all group"
                    >
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-lg bg-amber-50 flex items-center justify-center group-hover:bg-amber-100 transition-colors">
                          <svg className="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                          </svg>
                        </div>
                        <div className="text-left">
                          <div className="text-sm font-medium text-neutral-900">Themes</div>
                          <div className="text-xs text-neutral-500">Colors, buttons, and typography</div>
                        </div>
                      </div>
                      <svg className="w-5 h-5 text-neutral-400 group-hover:text-neutral-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 5l7 7-7 7" />
                      </svg>
                    </button>
                  </div>
                ) : settingsCategory === 'page' ? (
                  /* Page Settings */
                  <div className="space-y-6">
                    <SettingsHeader
                      title="Page Settings"
                      subtitle="Configure layout settings for this page"
                      onBack={() => setSettingsCategory(null)}
                    />

                    {/* Current View Indicator */}
                    <div className="bg-neutral-50 rounded-lg p-4">
                      <div className="text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2">Current View</div>
                      <div className="text-sm font-semibold text-neutral-900">
                        {view === 'list' ? 'Record Listing' : 'Record Details'}
                      </div>
                    </div>

                  {/* Section Divider */}
                  <div className="border-t border-neutral-200 pt-6">
                    <h4 className="text-xs font-semibold text-neutral-900 uppercase tracking-wider mb-4">Container</h4>

                    {/* Container Width */}
                    <div className="space-y-3">
                      <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider">
                        Width
                      </label>
                      <div className="grid grid-cols-2 gap-2">
                        {['standard', 'wide', 'narrow', 'full', 'custom'].map((width) => (
                          <button
                            key={width}
                            onClick={() => {
                              setPageSettings(prev => ({
                                ...prev,
                                [view]: {
                                  ...prev[view],
                                  containerWidth: width
                                }
                              }));
                            }}
                            className={`px-3 py-2 text-xs font-medium rounded-lg transition-all ${
                              pageSettings[view]?.containerWidth === width
                                ? 'bg-neutral-900 text-white'
                                : 'bg-neutral-100 text-neutral-700 hover:bg-neutral-200'
                            }`}
                          >
                            {width.charAt(0).toUpperCase() + width.slice(1)}
                            {width === 'standard' && ' (1200px)'}
                            {width === 'wide' && ' (1400px)'}
                            {width === 'narrow' && ' (900px)'}
                          </button>
                        ))}
                      </div>

                      {/* Custom Width Input */}
                      {pageSettings[view]?.containerWidth === 'custom' && (
                        <div className="mt-3 bg-neutral-50 rounded-lg p-3">
                          <label className="block text-xs font-medium text-neutral-600 mb-2">
                            Custom Width (px)
                          </label>
                          <input
                            type="number"
                            min="600"
                            max="2000"
                            step="50"
                            value={pageSettings[view]?.customWidth || 1200}
                            onChange={(e) => {
                              const newWidth = parseInt(e.target.value) || 1200;
                              setPageSettings(prev => ({
                                ...prev,
                                [view]: {
                                  ...prev[view],
                                  customWidth: Math.min(Math.max(newWidth, 600), 2000)
                                }
                              }));
                            }}
                            className="w-full px-3 py-2 border border-neutral-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-neutral-900"
                          />
                          <p className="text-xs text-neutral-500 mt-1">
                            Range: 600-2000px
                          </p>
                        </div>
                      )}

                      <p className="text-xs text-neutral-500 mt-2">
                        Controls the maximum width of the page container
                      </p>
                    </div>
                  </div>

                  {/* 3-Zone Layout Management */}
                  {view === 'detail' && (
                    <div className="border-t border-neutral-200 pt-6">
                      <h4 className="text-xs font-semibold text-neutral-900 uppercase tracking-wider mb-4">Page Zones</h4>
                      <p className="text-xs text-neutral-500 mb-4">
                        Manage header, body, and footer zones with unlimited rows
                      </p>

                      <div className="space-y-3">
                        {/* Header Zone */}
                        <div className="bg-neutral-50 rounded-lg p-3">
                          <div className="flex items-center justify-between mb-2">
                            <div className="flex items-center gap-2">
                              <span className="text-sm font-medium text-neutral-900">Header</span>
                              <span className="text-xs text-neutral-500">
                                ({pageSettings.detail.zones.header?.rows?.length || 0} rows)
                              </span>
                            </div>
                            <button
                              onClick={() => {
                                setPageSettings(prev => ({
                                  ...prev,
                                  detail: {
                                    ...prev.detail,
                                    zones: {
                                      ...prev.detail.zones,
                                      header: {
                                        ...prev.detail.zones.header,
                                        visible: !prev.detail.zones.header?.visible
                                      }
                                    }
                                  }
                                }));
                              }}
                              className={`px-2 py-1 text-xs font-medium rounded transition-all ${
                                pageSettings.detail.zones.header?.visible
                                  ? 'bg-neutral-900 text-white'
                                  : 'bg-neutral-200 text-neutral-600'
                              }`}
                            >
                              {pageSettings.detail.zones.header?.visible ? 'Visible' : 'Hidden'}
                            </button>
                          </div>
                        </div>

                        {/* Body Zone */}
                        <div className="bg-neutral-50 rounded-lg p-3">
                          <div className="flex items-center justify-between mb-2">
                            <div className="flex items-center gap-2">
                              <span className="text-sm font-medium text-neutral-900">Body</span>
                              <span className="text-xs text-neutral-500">
                                ({pageSettings.detail.zones.body?.rows?.length || 0} rows)
                              </span>
                            </div>
                            <button
                              onClick={() => {
                                setPageSettings(prev => ({
                                  ...prev,
                                  detail: {
                                    ...prev.detail,
                                    zones: {
                                      ...prev.detail.zones,
                                      body: {
                                        ...prev.detail.zones.body,
                                        visible: !prev.detail.zones.body?.visible
                                      }
                                    }
                                  }
                                }));
                              }}
                              className={`px-2 py-1 text-xs font-medium rounded transition-all ${
                                pageSettings.detail.zones.body?.visible
                                  ? 'bg-neutral-900 text-white'
                                  : 'bg-neutral-200 text-neutral-600'
                              }`}
                            >
                              {pageSettings.detail.zones.body?.visible ? 'Visible' : 'Hidden'}
                            </button>
                          </div>
                        </div>

                        {/* Footer Zone */}
                        <div className="bg-neutral-50 rounded-lg p-3">
                          <div className="flex items-center justify-between mb-2">
                            <div className="flex items-center gap-2">
                              <span className="text-sm font-medium text-neutral-900">Footer</span>
                              <span className="text-xs text-neutral-500">
                                ({pageSettings.detail.zones.footer?.rows?.length || 0} rows)
                              </span>
                            </div>
                            <button
                              onClick={() => {
                                setPageSettings(prev => ({
                                  ...prev,
                                  detail: {
                                    ...prev.detail,
                                    zones: {
                                      ...prev.detail.zones,
                                      footer: {
                                        ...prev.detail.zones.footer,
                                        visible: !prev.detail.zones.footer?.visible
                                      }
                                    }
                                  }
                                }));
                              }}
                              className={`px-2 py-1 text-xs font-medium rounded transition-all ${
                                pageSettings.detail.zones.footer?.visible
                                  ? 'bg-neutral-900 text-white'
                                  : 'bg-neutral-200 text-neutral-600'
                              }`}
                            >
                              {pageSettings.detail.zones.footer?.visible ? 'Visible' : 'Hidden'}
                            </button>
                          </div>
                        </div>
                      </div>

                      <div className="mt-4 text-xs text-neutral-500 bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <div className="flex items-start gap-2">
                          <svg className="w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                          <div>
                            <p className="font-medium text-blue-900 mb-1">3-Zone Layout Active</p>
                            <p className="text-blue-700">
                              Each zone can have multiple rows with independent column configurations.
                              Full row management UI coming soon.
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Section Divider */}
                  <div className="border-t border-neutral-200 pt-6">
                    <h4 className="text-xs font-semibold text-neutral-900 uppercase tracking-wider mb-4">Layout</h4>

                    {/* Column Layout Mode (Tier 1, 2, 3 System) */}
                    {view === 'detail' && (
                      <div className="mb-6">
                        <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">
                          Column Layout Mode
                        </label>
                        <div className="space-y-2">
                          {[
                            {
                              value: 'auto',
                              label: 'Auto',
                              description: 'Smart defaults (Applications use hybrid)',
                              icon: 'âœ¨'
                            },
                            {
                              value: 'proportional',
                              label: 'Proportional',
                              description: 'All columns scale together',
                              icon: 'â–®â–®â–®â–® â–®â–®â–®â–® â–®â–®â–®â–®'
                            },
                            {
                              value: 'hybrid',
                              label: 'Hybrid',
                              description: 'Fixed sidebars + flexible center',
                              icon: 'â–®â–® â–®â–®â–®â–®â–®â–®â–®â–® â–®â–®'
                            },
                            {
                              value: 'custom',
                              label: 'Custom',
                              description: 'Configure each column individually',
                              icon: 'âš™ï¸'
                            }
                          ].map((mode) => (
                            <button
                              key={mode.value}
                              onClick={() => {
                                setPageSettings(prev => {
                                  const newSettings = {
                                    ...prev,
                                    detail: {
                                      ...prev.detail,
                                      columnLayoutMode: mode.value,
                                      zones: {
                                        ...prev.detail.zones,
                                        body: {
                                          ...prev.detail.zones.body,
                                          rows: prev.detail.zones.body.rows.map(row =>
                                            row.id === 'main-content-row'
                                              ? { ...row, columnLayoutMode: mode.value }
                                              : row
                                          )
                                        }
                                      }
                                    }
                                  };
                                  return newSettings;
                                });
                              }}
                              className={`w-full text-left px-3 py-2.5 rounded-lg transition-all border ${
                                pageSettings.detail?.columnLayoutMode === mode.value
                                  ? 'bg-neutral-900 text-white border-neutral-900'
                                  : 'bg-white text-neutral-700 border-neutral-200 hover:border-neutral-300 hover:bg-neutral-50'
                              }`}
                            >
                              <div className="flex items-start gap-2">
                                <span className="text-sm mt-0.5">{mode.icon}</span>
                                <div className="flex-1">
                                  <div className="text-xs font-semibold">{mode.label}</div>
                                  <div className={`text-xs mt-0.5 ${
                                    pageSettings.detail?.columnLayoutMode === mode.value
                                      ? 'text-neutral-300'
                                      : 'text-neutral-500'
                                  }`}>
                                    {mode.description}
                                  </div>
                                </div>
                              </div>
                            </button>
                          ))}
                        </div>

                        {/* Hybrid Mode Settings */}
                        {pageSettings.detail?.columnLayoutMode === 'hybrid' && (
                          <div className="mt-4 bg-neutral-50 rounded-lg p-4 space-y-4">
                            <div>
                              <label className="block text-xs font-medium text-neutral-600 mb-2">
                                Left Sidebar Width: {pageSettings.detail?.hybridSidebarWidth || 320}px
                              </label>
                              <input
                                type="range"
                                min="240"
                                max="480"
                                step="10"
                                value={pageSettings.detail?.hybridSidebarWidth || 320}
                                onChange={(e) => {
                                  const newWidth = parseInt(e.target.value);
                                  setPageSettings(prev => ({
                                    ...prev,
                                    detail: {
                                      ...prev.detail,
                                      hybridSidebarWidth: newWidth,
                                      zones: {
                                        ...prev.detail.zones,
                                        body: {
                                          ...prev.detail.zones.body,
                                          rows: prev.detail.zones.body.rows.map(row =>
                                            row.id === 'main-content-row'
                                              ? { ...row, hybridSidebarWidth: newWidth }
                                              : row
                                          )
                                        }
                                      }
                                    }
                                  }));
                                }}
                                className="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer accent-neutral-900"
                              />
                              <div className="flex justify-between text-xs text-neutral-400 mt-1">
                                <span>240px</span>
                                <span>480px</span>
                              </div>
                            </div>
                            <div>
                              <label className="block text-xs font-medium text-neutral-600 mb-2">
                                Right Sidebar Width: {pageSettings.detail?.hybridRightSidebarWidth || 280}px
                              </label>
                              <input
                                type="range"
                                min="240"
                                max="480"
                                step="10"
                                value={pageSettings.detail?.hybridRightSidebarWidth || 280}
                                onChange={(e) => {
                                  const newWidth = parseInt(e.target.value);
                                  setPageSettings(prev => ({
                                    ...prev,
                                    detail: {
                                      ...prev.detail,
                                      hybridRightSidebarWidth: newWidth,
                                      zones: {
                                        ...prev.detail.zones,
                                        body: {
                                          ...prev.detail.zones.body,
                                          rows: prev.detail.zones.body.rows.map(row =>
                                            row.id === 'main-content-row'
                                              ? { ...row, hybridRightSidebarWidth: newWidth }
                                              : row
                                          )
                                        }
                                      }
                                    }
                                  }));
                                }}
                                className="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer accent-neutral-900"
                              />
                              <div className="flex justify-between text-xs text-neutral-400 mt-1">
                                <span>240px</span>
                                <span>480px</span>
                              </div>
                            </div>
                            <p className="text-xs text-neutral-500">
                              Center column will flex to fill available space
                            </p>
                          </div>
                        )}

                        <p className="text-xs text-neutral-500 mt-3">
                          {pageSettings.detail?.columnLayoutMode === 'auto' &&
                            'Application records automatically use hybrid layout for optimal viewing'}
                          {pageSettings.detail?.columnLayoutMode === 'proportional' &&
                            'All columns resize proportionally as viewport changes'}
                          {pageSettings.detail?.columnLayoutMode === 'hybrid' &&
                            'Fixed sidebars with expanding center - ideal for forms'}
                          {pageSettings.detail?.columnLayoutMode === 'custom' &&
                            'Advanced per-column control (configure below)'}
                        </p>
                      </div>
                    )}

                    {/* Content Columns */}
                    <div className="mb-6">
                      <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">
                        Content Columns: {pageSettings[view]?.columns || 2}
                      </label>
                      <input
                        type="range"
                        min="1"
                        max="6"
                        step="1"
                        value={pageSettings[view]?.columns || 2}
                        onChange={(e) => {
                          const newColumns = parseInt(e.target.value);
                          // Initialize columnWidths array with equal distribution
                          const equalWidth = Math.floor(100 / newColumns);
                          const remainder = 100 - (equalWidth * newColumns);
                          const columnWidths = Array(newColumns).fill(equalWidth);
                          if (remainder > 0) columnWidths[0] += remainder;

                          setPageSettings(prev => ({
                            ...prev,
                            [view]: {
                              ...prev[view],
                              columns: newColumns,
                              columnWidths: columnWidths,
                              zones: {
                                ...prev[view].zones,
                                body: {
                                  ...prev[view].zones.body,
                                  rows: prev[view].zones.body.rows.map(row =>
                                    row.id === 'main-content-row'
                                      ? { ...row, columns: newColumns, columnWidths: columnWidths }
                                      : row
                                  )
                                }
                              }
                            }
                          }));
                        }}
                        className="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer accent-neutral-900"
                      />
                      <div className="flex justify-between text-xs text-neutral-400 mt-1">
                        <span>1</span>
                        <span>6</span>
                      </div>
                      <p className="text-xs text-neutral-500 mt-2">
                        Number of columns for the page layout
                      </p>
                    </div>

                    {/* Column Widths - Preset Ratios */}
                    {pageSettings[view]?.columns === 2 && (
                      <div onMouseEnter={activateColumnOverlays}>
                        <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">
                          Column Ratio
                        </label>
                        <div className="grid grid-cols-3 gap-2 mb-3">
                          {[
                            { label: '50/50', widths: [50, 50] },
                            { label: '60/40', widths: [60, 40] },
                            { label: '70/30', widths: [70, 30] },
                            { label: '40/60', widths: [40, 60] },
                            { label: '30/70', widths: [30, 70] },
                            { label: '66/34', widths: [66, 34] },
                          ].map((preset) => {
                            const isActive = JSON.stringify(pageSettings[view]?.columnWidths) === JSON.stringify(preset.widths);
                            return (
                              <button
                                key={preset.label}
                                onClick={() => {
                                  setPageSettings(prev => {
                                    const newSettings = {
                                      ...prev,
                                      [view]: {
                                        ...prev[view],
                                        columnWidths: preset.widths,
                                        zones: {
                                          ...prev[view].zones,
                                          body: {
                                            ...prev[view].zones.body,
                                            rows: prev[view].zones.body.rows.map(row =>
                                              row.id === 'main-content-row'
                                                ? { ...row, columnWidths: preset.widths }
                                                : row
                                            )
                                          }
                                        }
                                      }
                                    };
                                    // Also update columnConfig if in custom mode
                                    if (prev[view]?.columnLayoutMode === 'custom') {
                                      newSettings[view].columnConfig = preset.widths.map(w => ({
                                        type: 'flexible',
                                        value: w
                                      }));
                                      newSettings[view].zones.body.rows = newSettings[view].zones.body.rows.map(row =>
                                        row.id === 'main-content-row'
                                          ? { ...row, columnConfig: newSettings[view].columnConfig }
                                          : row
                                      );
                                    }
                                    return newSettings;
                                  });
                                }}
                                className={`px-2 py-1.5 text-xs font-medium rounded transition-all ${
                                  isActive
                                    ? 'bg-neutral-900 text-white'
                                    : 'bg-neutral-100 text-neutral-700 hover:bg-neutral-200'
                                }`}
                              >
                                {preset.label}
                              </button>
                            );
                          })}
                        </div>

                        {/* Interactive Visual Bar with Draggable Dividers */}
                        <div className="mb-3">
                          <label className="block text-xs font-medium text-neutral-600 mb-2">
                            Adjust Ratio
                          </label>
                          <div
                            className="relative h-12 bg-neutral-50 rounded-lg border border-neutral-200 overflow-hidden"
                            onMouseDown={(e) => {
                              // Check if clicking on divider area
                              const rect = e.currentTarget.getBoundingClientRect();
                              const clickX = e.clientX - rect.left;
                              const totalWidth = rect.width;
                              const col1Width = (pageSettings[view]?.columnWidths[0] || 60) / 100 * totalWidth;

                              // If clicking within 12px of divider, start dragging
                              if (Math.abs(clickX - col1Width) < 12) {
                                const handleMouseMove = (moveEvent) => {
                                  const newClickX = moveEvent.clientX - rect.left;
                                  const newCol1Percent = Math.max(15, Math.min(85, (newClickX / totalWidth) * 100));
                                  const newCol2Percent = 100 - newCol1Percent;
                                  const newWidths = [Math.round(newCol1Percent), Math.round(newCol2Percent)];

                                  setPageSettings(prev => ({
                                    ...prev,
                                    [view]: {
                                      ...prev[view],
                                      columnWidths: newWidths,
                                      zones: {
                                        ...prev[view].zones,
                                        body: {
                                          ...prev[view].zones.body,
                                          rows: prev[view].zones.body.rows.map(row =>
                                            row.id === 'main-content-row'
                                              ? { ...row, columnWidths: newWidths }
                                              : row
                                          )
                                        }
                                      }
                                    }
                                  }));

                                  activateColumnOverlays();
                                };

                                const handleMouseUp = () => {
                                  document.removeEventListener('mousemove', handleMouseMove);
                                  document.removeEventListener('mouseup', handleMouseUp);
                                  document.body.style.cursor = '';
                                  document.body.style.userSelect = '';
                                };

                                document.addEventListener('mousemove', handleMouseMove);
                                document.addEventListener('mouseup', handleMouseUp);
                                document.body.style.cursor = 'col-resize';
                                document.body.style.userSelect = 'none';
                              }
                            }}
                          >
                            {/* Column visualization */}
                            <div className="absolute inset-0 flex">
                              <div
                                className="bg-blue-100 flex items-center justify-center text-xs font-medium text-blue-900 transition-all duration-150"
                                style={{ width: `${pageSettings[view]?.columnWidths[0] || 60}%` }}
                              >
                                {pageSettings[view]?.columnWidths[0] || 60}%
                              </div>
                              <div
                                className="bg-neutral-100 flex items-center justify-center text-xs font-medium text-neutral-700 transition-all duration-150"
                                style={{ width: `${pageSettings[view]?.columnWidths[1] || 40}%` }}
                              >
                                {pageSettings[view]?.columnWidths[1] || 40}%
                              </div>
                            </div>

                            {/* Draggable divider */}
                            <div
                              className="absolute top-0 bottom-0 w-1 bg-neutral-400 hover:bg-blue-500 hover:w-1.5 transition-all cursor-col-resize z-10"
                              style={{
                                left: `${pageSettings[view]?.columnWidths[0] || 60}%`,
                                transform: 'translateX(-50%)'
                              }}
                              onMouseEnter={(e) => {
                                e.currentTarget.style.width = '6px';
                              }}
                              onMouseLeave={(e) => {
                                e.currentTarget.style.width = '4px';
                              }}
                            />
                          </div>
                          <p className="text-xs text-neutral-500 mt-1">
                            Drag the divider to adjust column split
                          </p>
                        </div>

                        {/* Numeric Inputs for Precise Control */}
                        <div className="space-y-2">
                          <label className="block text-xs font-medium text-neutral-600">
                            Precise Width Control
                          </label>
                          {(pageSettings[view]?.columnWidths || []).map((width, idx) => (
                            <div key={idx} className="flex items-center gap-2">
                              <span className="text-xs text-neutral-600 w-20">Column {idx + 1}</span>
                              <div className="flex-1 flex items-center gap-1">
                                <input
                                  type="number"
                                  min="15"
                                  max="85"
                                  value={width}
                                  onFocus={activateColumnOverlays}
                                  onChange={(e) => {
                                    const newWidth = Math.max(15, Math.min(85, parseInt(e.target.value) || 15));
                                    const otherIdx = idx === 0 ? 1 : 0;
                                    const otherWidth = 100 - newWidth;

                                    const newWidths = [...(pageSettings[view]?.columnWidths || [])];
                                    newWidths[idx] = newWidth;
                                    newWidths[otherIdx] = otherWidth;

                                    setPageSettings(prev => {
                                      const newSettings = {
                                        ...prev,
                                        [view]: {
                                          ...prev[view],
                                          columnWidths: newWidths
                                        }
                                      };
                                      // Also update columnConfig if in custom mode
                                      if (prev[view]?.columnLayoutMode === 'custom') {
                                        newSettings[view].columnConfig = newWidths.map(w => ({
                                          type: 'flexible',
                                          value: w
                                        }));
                                      }
                                      return newSettings;
                                    });

                                    activateColumnOverlays();
                                  }}
                                  className="w-16 px-2 py-1 text-xs border border-neutral-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                />
                                <span className="text-xs text-neutral-500">%</span>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Column Widths - 3 Columns Presets */}
                    {pageSettings[view]?.columns === 3 && (
                      <div onMouseEnter={activateColumnOverlays}>
                        <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">
                          Column Ratio
                        </label>
                        <div className="grid grid-cols-2 gap-2 mb-3">
                          {[
                            { label: '33/33/33', widths: [33, 33, 34] },
                            { label: '50/25/25', widths: [50, 25, 25] },
                            { label: '25/50/25', widths: [25, 50, 25] },
                            { label: '25/25/50', widths: [25, 25, 50] },
                          ].map((preset) => {
                            const isActive = JSON.stringify(pageSettings[view]?.columnWidths) === JSON.stringify(preset.widths);
                            return (
                              <button
                                key={preset.label}
                                onClick={() => {
                                  setPageSettings(prev => {
                                    const newSettings = {
                                      ...prev,
                                      [view]: {
                                        ...prev[view],
                                        columnWidths: preset.widths,
                                        zones: {
                                          ...prev[view].zones,
                                          body: {
                                            ...prev[view].zones.body,
                                            rows: prev[view].zones.body.rows.map(row =>
                                              row.id === 'main-content-row'
                                                ? { ...row, columnWidths: preset.widths }
                                                : row
                                            )
                                          }
                                        }
                                      }
                                    };
                                    // Also update columnConfig if in custom mode
                                    if (prev[view]?.columnLayoutMode === 'custom') {
                                      newSettings[view].columnConfig = preset.widths.map(w => ({
                                        type: 'flexible',
                                        value: w
                                      }));
                                      newSettings[view].zones.body.rows = newSettings[view].zones.body.rows.map(row =>
                                        row.id === 'main-content-row'
                                          ? { ...row, columnConfig: newSettings[view].columnConfig }
                                          : row
                                      );
                                    }
                                    return newSettings;
                                  });
                                }}
                                className={`px-2 py-1.5 text-xs font-medium rounded transition-all ${
                                  isActive
                                    ? 'bg-neutral-900 text-white'
                                    : 'bg-neutral-100 text-neutral-700 hover:bg-neutral-200'
                                }`}
                              >
                                {preset.label}
                              </button>
                            );
                          })}
                        </div>

                        {/* Interactive Visual Bar with Draggable Dividers for 3 Columns */}
                        <div className="mb-3">
                          <label className="block text-xs font-medium text-neutral-600 mb-2">
                            Adjust Ratio
                          </label>
                          <div
                            className="relative h-12 bg-neutral-50 rounded-lg border border-neutral-200 overflow-hidden"
                            onMouseDown={(e) => {
                              const rect = e.currentTarget.getBoundingClientRect();
                              const clickX = e.clientX - rect.left;
                              const totalWidth = rect.width;
                              const widths = pageSettings[view]?.columnWidths || [33, 33, 34];

                              // Calculate divider positions
                              const divider1X = (widths[0] / 100) * totalWidth;
                              const divider2X = ((widths[0] + widths[1]) / 100) * totalWidth;

                              let activeDivider = null;
                              if (Math.abs(clickX - divider1X) < 12) activeDivider = 0;
                              else if (Math.abs(clickX - divider2X) < 12) activeDivider = 1;

                              if (activeDivider !== null) {
                                const handleMouseMove = (moveEvent) => {
                                  const newClickX = moveEvent.clientX - rect.left;
                                  const newWidths = [...widths];

                                  if (activeDivider === 0) {
                                    // Dragging divider between col1 and col2
                                    const newCol1Percent = Math.max(15, Math.min(100 - widths[2] - 15, (newClickX / totalWidth) * 100));
                                    const newCol2Percent = widths[0] + widths[1] - newCol1Percent;

                                    if (newCol2Percent >= 15) {
                                      newWidths[0] = Math.round(newCol1Percent);
                                      newWidths[1] = Math.round(newCol2Percent);
                                    }
                                  } else {
                                    // Dragging divider between col2 and col3
                                    const combinedPercent = (newClickX / totalWidth) * 100;
                                    const newCol2Percent = Math.max(15, Math.min(100 - widths[0] - 15, combinedPercent - widths[0]));
                                    const newCol3Percent = 100 - widths[0] - newCol2Percent;

                                    if (newCol3Percent >= 15) {
                                      newWidths[1] = Math.round(newCol2Percent);
                                      newWidths[2] = Math.round(newCol3Percent);
                                    }
                                  }

                                  setPageSettings(prev => {
                                    const newSettings = {
                                      ...prev,
                                      [view]: {
                                        ...prev[view],
                                        columnWidths: newWidths
                                      }
                                    };
                                    // Also update columnConfig if in custom mode
                                    if (prev[view]?.columnLayoutMode === 'custom') {
                                      newSettings[view].columnConfig = newWidths.map(w => ({
                                        type: 'flexible',
                                        value: w
                                      }));
                                    }
                                    return newSettings;
                                  });

                                  activateColumnOverlays();
                                };

                                const handleMouseUp = () => {
                                  document.removeEventListener('mousemove', handleMouseMove);
                                  document.removeEventListener('mouseup', handleMouseUp);
                                  document.body.style.cursor = '';
                                  document.body.style.userSelect = '';
                                };

                                document.addEventListener('mousemove', handleMouseMove);
                                document.addEventListener('mouseup', handleMouseUp);
                                document.body.style.cursor = 'col-resize';
                                document.body.style.userSelect = 'none';
                              }
                            }}
                          >
                            {/* Column visualization */}
                            <div className="absolute inset-0 flex">
                              <div
                                className="bg-blue-100 flex items-center justify-center text-xs font-medium text-blue-900 transition-all duration-150"
                                style={{ width: `${pageSettings[view]?.columnWidths[0] || 33}%` }}
                              >
                                {pageSettings[view]?.columnWidths[0] || 33}%
                              </div>
                              <div
                                className="bg-neutral-100 flex items-center justify-center text-xs font-medium text-neutral-700 transition-all duration-150"
                                style={{ width: `${pageSettings[view]?.columnWidths[1] || 33}%` }}
                              >
                                {pageSettings[view]?.columnWidths[1] || 33}%
                              </div>
                              <div
                                className="bg-blue-50 flex items-center justify-center text-xs font-medium text-blue-800 transition-all duration-150"
                                style={{ width: `${pageSettings[view]?.columnWidths[2] || 34}%` }}
                              >
                                {pageSettings[view]?.columnWidths[2] || 34}%
                              </div>
                            </div>

                            {/* Draggable divider 1 (between col1 and col2) */}
                            <div
                              className="absolute top-0 bottom-0 w-1 bg-neutral-400 hover:bg-blue-500 hover:w-1.5 transition-all cursor-col-resize z-10"
                              style={{
                                left: `${pageSettings[view]?.columnWidths[0] || 33}%`,
                                transform: 'translateX(-50%)'
                              }}
                              onMouseEnter={(e) => {
                                e.currentTarget.style.width = '6px';
                              }}
                              onMouseLeave={(e) => {
                                e.currentTarget.style.width = '4px';
                              }}
                            />

                            {/* Draggable divider 2 (between col2 and col3) */}
                            <div
                              className="absolute top-0 bottom-0 w-1 bg-neutral-400 hover:bg-blue-500 hover:w-1.5 transition-all cursor-col-resize z-10"
                              style={{
                                left: `${(pageSettings[view]?.columnWidths[0] || 33) + (pageSettings[view]?.columnWidths[1] || 33)}%`,
                                transform: 'translateX(-50%)'
                              }}
                              onMouseEnter={(e) => {
                                e.currentTarget.style.width = '6px';
                              }}
                              onMouseLeave={(e) => {
                                e.currentTarget.style.width = '4px';
                              }}
                            />
                          </div>
                          <p className="text-xs text-neutral-500 mt-1">
                            Drag the dividers to adjust column splits
                          </p>
                        </div>

                        {/* Numeric Inputs for Precise Control */}
                        <div className="space-y-2">
                          <label className="block text-xs font-medium text-neutral-600">
                            Precise Width Control
                          </label>
                          {(pageSettings[view]?.columnWidths || []).map((width, idx) => (
                            <div key={idx} className="flex items-center gap-2">
                              <span className="text-xs text-neutral-600 w-20">Column {idx + 1}</span>
                              <div className="flex-1 flex items-center gap-1">
                                <input
                                  type="number"
                                  min="15"
                                  max="70"
                                  value={width}
                                  onFocus={activateColumnOverlays}
                                  onChange={(e) => {
                                    const newWidth = Math.max(15, Math.min(70, parseInt(e.target.value) || 15));
                                    const currentWidths = [...(pageSettings[view]?.columnWidths || [])];
                                    const oldWidth = currentWidths[idx];
                                    const diff = newWidth - oldWidth;

                                    // Distribute the difference proportionally to other columns
                                    const otherIndices = currentWidths.map((_, i) => i).filter(i => i !== idx);
                                    const totalOtherWidth = otherIndices.reduce((sum, i) => sum + currentWidths[i], 0);

                                    const newWidths = [...currentWidths];
                                    newWidths[idx] = newWidth;

                                    let remaining = 100 - newWidth;
                                    otherIndices.forEach((i, arrayIdx) => {
                                      if (arrayIdx === otherIndices.length - 1) {
                                        // Last one gets the remainder to ensure sum = 100
                                        newWidths[i] = remaining;
                                      } else {
                                        const proportion = currentWidths[i] / totalOtherWidth;
                                        const adjusted = Math.max(15, Math.round(remaining * proportion));
                                        newWidths[i] = adjusted;
                                        remaining -= adjusted;
                                      }
                                    });

                                    setPageSettings(prev => {
                                      const newSettings = {
                                        ...prev,
                                        [view]: {
                                          ...prev[view],
                                          columnWidths: newWidths
                                        }
                                      };
                                      // Also update columnConfig if in custom mode
                                      if (prev[view]?.columnLayoutMode === 'custom') {
                                        newSettings[view].columnConfig = newWidths.map(w => ({
                                          type: 'flexible',
                                          value: w
                                        }));
                                      }
                                      return newSettings;
                                    });

                                    activateColumnOverlays();
                                  }}
                                  className="w-16 px-2 py-1 text-xs border border-neutral-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                />
                                <span className="text-xs text-neutral-500">%</span>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Column Widths - Equal Distribution Display for 4+ columns */}
                    {pageSettings[view]?.columns > 3 && (
                      <div>
                        <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2">
                          Column Widths
                        </label>
                        <div className="bg-neutral-50 rounded-lg p-3 space-y-1">
                          {(pageSettings[view]?.columnWidths || []).map((width, idx) => (
                            <div key={idx} className="flex items-center justify-between text-xs">
                              <span className="text-neutral-600">Column {idx + 1}</span>
                              <span className="font-medium text-neutral-900">{width}%</span>
                            </div>
                          ))}
                        </div>
                        <p className="text-xs text-neutral-500 mt-2">
                          Equal distribution
                        </p>
                      </div>
                    )}
                  </div>

                  {/* Section Divider */}
                  <div className="border-t border-neutral-200 pt-6">
                    <h4 className="text-xs font-semibold text-neutral-900 uppercase tracking-wider mb-4">Spacing</h4>

                    {/* Column Gap */}
                    <div className="mb-6">
                      <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">
                        Column Gap: {pageSettings[view]?.columnGap ?? 48}px
                      </label>
                      <input
                        type="range"
                        min="0"
                        max="96"
                        step="8"
                        value={pageSettings[view]?.columnGap ?? 48}
                        onChange={(e) => {
                          const newGap = parseInt(e.target.value);
                          setPageSettings(prev => ({
                            ...prev,
                            [view]: {
                              ...prev[view],
                              columnGap: newGap,
                              zones: {
                                ...prev[view].zones,
                                body: {
                                  ...prev[view].zones.body,
                                  rows: prev[view].zones.body.rows.map(row =>
                                    row.id === 'main-content-row'
                                      ? { ...row, columnGap: newGap }
                                      : row
                                  )
                                }
                              }
                            }
                          }));
                        }}
                        className="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer accent-neutral-900"
                      />
                      <div className="flex justify-between text-xs text-neutral-400 mt-1">
                        <span>0px</span>
                        <span>96px</span>
                      </div>
                      <p className="text-xs text-neutral-500 mt-2">
                        Space between columns
                      </p>
                    </div>

                    {/* Section Spacing */}
                    <div className="mb-6">
                      <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">
                        Section Spacing: {pageSettings[view]?.sectionSpacing ?? 64}px
                      </label>
                      <input
                        type="range"
                        min="0"
                        max="128"
                        step="8"
                        value={pageSettings[view]?.sectionSpacing ?? 64}
                        onChange={(e) => {
                          const newSpacing = parseInt(e.target.value);
                          setPageSettings(prev => ({
                            ...prev,
                            [view]: {
                              ...prev[view],
                              sectionSpacing: newSpacing,
                              zones: {
                                ...prev[view].zones,
                                body: {
                                  ...prev[view].zones.body,
                                  rows: prev[view].zones.body.rows.map(row =>
                                    row.id === 'main-content-row'
                                      ? { ...row, sectionSpacing: newSpacing }
                                      : row
                                  )
                                }
                              }
                            }
                          }));
                        }}
                        className="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer accent-neutral-900"
                      />
                      <div className="flex justify-between text-xs text-neutral-400 mt-1">
                        <span>0px</span>
                        <span>128px</span>
                      </div>
                      <p className="text-xs text-neutral-500 mt-2">
                        Vertical space between sections and cards
                      </p>
                    </div>

                    {/* Content Padding */}
                    <div>
                      <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">
                        Content Padding: {pageSettings[view]?.contentPadding ?? 24}px
                      </label>
                      <input
                        type="range"
                        min="0"
                        max="48"
                        step="4"
                        value={pageSettings[view]?.contentPadding ?? 24}
                        onChange={(e) => {
                          const newPadding = parseInt(e.target.value);
                          setPageSettings(prev => ({
                            ...prev,
                            [view]: {
                              ...prev[view],
                              contentPadding: newPadding,
                              zones: {
                                ...prev[view].zones,
                                body: {
                                  ...prev[view].zones.body,
                                  rows: prev[view].zones.body.rows.map(row =>
                                    row.id === 'main-content-row'
                                      ? { ...row, contentPadding: newPadding }
                                      : row
                                  )
                                }
                              }
                            }
                          }));
                        }}
                        className="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer accent-neutral-900"
                      />
                      <div className="flex justify-between text-xs text-neutral-400 mt-1">
                        <span>0px</span>
                        <span>48px</span>
                      </div>
                      <p className="text-xs text-neutral-500 mt-2">
                        Internal padding within sections
                      </p>
                    </div>
                  </div>

                  {/* Section Divider */}
                  <div className="border-t border-neutral-200 pt-6">
                    <h4 className="text-xs font-semibold text-neutral-900 uppercase tracking-wider mb-4">Responsive</h4>

                    {/* Mobile Breakpoint */}
                    <div className="mb-6">
                      <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">
                        Mobile Breakpoint
                      </label>
                      <div className="grid grid-cols-2 gap-2">
                        {[
                          { label: 'Tablet (768px)', value: 768 },
                          { label: 'Phone (640px)', value: 640 },
                        ].map((breakpoint) => {
                          const isActive = (pageSettings[view]?.mobileBreakpoint || 768) === breakpoint.value;
                          return (
                            <button
                              key={breakpoint.value}
                              onClick={() => {
                                setPageSettings(prev => ({
                                  ...prev,
                                  [view]: {
                                    ...prev[view],
                                    mobileBreakpoint: breakpoint.value
                                  }
                                }));
                              }}
                              className={`px-3 py-2 text-xs font-medium rounded-lg transition-all ${
                                isActive
                                  ? 'bg-neutral-900 text-white'
                                  : 'bg-neutral-100 text-neutral-700 hover:bg-neutral-200'
                              }`}
                            >
                              {breakpoint.label}
                            </button>
                          );
                        })}
                      </div>
                      <p className="text-xs text-neutral-500 mt-2">
                        Columns stack vertically below this width
                      </p>
                    </div>

                    {/* Column Stacking Order */}
                    {pageSettings[view]?.columns > 1 && (
                      <div>
                        <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">
                          Mobile Stack Order
                        </label>
                        <div className="grid grid-cols-2 gap-2">
                          <button
                            onClick={() => {
                              setPageSettings(prev => ({
                                ...prev,
                                [view]: {
                                  ...prev[view],
                                  mobileStackReverse: false
                                }
                              }));
                            }}
                            className={`px-3 py-2 text-xs font-medium rounded-lg transition-all ${
                              !pageSettings[view]?.mobileStackReverse
                                ? 'bg-neutral-900 text-white'
                                : 'bg-neutral-100 text-neutral-700 hover:bg-neutral-200'
                            }`}
                          >
                            Normal (1,2,3...)
                          </button>
                          <button
                            onClick={() => {
                              setPageSettings(prev => ({
                                ...prev,
                                [view]: {
                                  ...prev[view],
                                  mobileStackReverse: true
                                }
                              }));
                            }}
                            className={`px-3 py-2 text-xs font-medium rounded-lg transition-all ${
                              pageSettings[view]?.mobileStackReverse
                                ? 'bg-neutral-900 text-white'
                                : 'bg-neutral-100 text-neutral-700 hover:bg-neutral-200'
                            }`}
                          >
                            Reverse (...3,2,1)
                          </button>
                        </div>
                        <p className="text-xs text-neutral-500 mt-2">
                          Order columns appear when stacked
                        </p>
                      </div>
                    )}

                    {/* Smart Layout - Only for detail view with multiple columns */}
                    {view === 'detail' && pageSettings[view]?.columns > 1 && (
                      <div className="mt-6 pt-6 border-t border-neutral-200">
                        <div className="mb-4">
                          <label className="flex items-center justify-between cursor-pointer">
                            <div className="flex-1">
                              <span className="block text-xs font-medium text-neutral-500 uppercase tracking-wider">
                                Smart Layout
                              </span>
                              <p className="text-xs text-neutral-400 mt-1">
                                Automatically adjust spacing when elements span multiple columns
                              </p>
                            </div>
                            <div className="relative inline-block w-10 ml-4 align-middle select-none">
                              <input
                                type="checkbox"
                                checked={pageSettings[view]?.smartLayout || false}
                                onChange={(e) => {
                                  setPageSettings(prev => ({
                                    ...prev,
                                    [view]: {
                                      ...prev[view],
                                      smartLayout: e.target.checked
                                    }
                                  }));
                                }}
                                className="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-2 appearance-none cursor-pointer transition-transform duration-200 ease-in-out checked:translate-x-5"
                                style={{
                                  top: '0',
                                  left: '0',
                                }}
                              />
                              <label
                                className="toggle-label block overflow-hidden h-5 rounded-full bg-neutral-300 cursor-pointer"
                                style={{
                                  backgroundColor: pageSettings[view]?.smartLayout ? '#171717' : '#d4d4d4'
                                }}
                              />
                            </div>
                          </label>
                        </div>

                        {/* Smart Layout Offset Slider - Only shown when enabled */}
                        {pageSettings[view]?.smartLayout && (
                          <div className="ml-0 mt-4">
                            <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">
                              Auto-Spacing Amount
                            </label>
                            <div className="flex items-center gap-3">
                              <input
                                type="range"
                                min="0"
                                max="400"
                                step="8"
                                value={pageSettings[view]?.smartLayoutOffset || 200}
                                onChange={(e) => {
                                  setPageSettings(prev => ({
                                    ...prev,
                                    [view]: {
                                      ...prev[view],
                                      smartLayoutOffset: parseInt(e.target.value)
                                    }
                                  }));
                                }}
                                className="flex-1 h-1 bg-neutral-200 rounded-lg appearance-none cursor-pointer slider"
                                style={{
                                  background: `linear-gradient(to right, #171717 0%, #171717 ${((pageSettings[view]?.smartLayoutOffset || 200) / 400) * 100}%, #e5e5e5 ${((pageSettings[view]?.smartLayoutOffset || 200) / 400) * 100}%, #e5e5e5 100%)`
                                }}
                              />
                              <div className="text-xs font-medium text-neutral-700 min-w-[48px] text-right">
                                {pageSettings[view]?.smartLayoutOffset || 200}px
                              </div>
                            </div>
                            <p className="text-xs text-neutral-400 mt-2">
                              Vertical spacing applied to elements below spanning items
                            </p>
                          </div>
                        )}
                      </div>
                    )}
                  </div>

                  {/* Info Box */}
                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div className="flex items-start gap-3">
                      <svg className="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                      </svg>
                      <div className="text-xs text-blue-900">
                        <p className="font-medium mb-1">Page Settings</p>
                        <p className="text-blue-800">
                          These settings apply to the current view ({view === 'list' ? 'Record Listing' : 'Record Details'}).
                          Different settings can be configured for each view.
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
                ) : settingsCategory === 'workspace' ? (
                  /* Workspace Settings */
                  <div className="space-y-6">
                    <SettingsHeader
                      title="Workspace Settings"
                      subtitle="General workspace preferences"
                      onBack={() => setSettingsCategory(null)}
                    />

                    {/* Placeholder for future workspace settings */}
                    <div className="bg-neutral-50 border border-neutral-200 rounded-lg p-6 text-center">
                      <svg className="w-12 h-12 text-neutral-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      </svg>
                      <p className="text-sm font-medium text-neutral-700">Workspace settings coming soon</p>
                      <p className="text-xs text-neutral-500 mt-1">Configure general workspace preferences</p>
                    </div>
                  </div>
                ) : settingsCategory === 'themes' ? (
                  /* Themes */
                  <div className="space-y-6">
                    <SettingsHeader
                      title="Themes"
                      subtitle="Customize colors, buttons, and typography"
                      onBack={() => setSettingsCategory(null)}
                    />

                    {/* 1. Theme Selector */}
                    <div className="border-t border-neutral-200 pt-6">
                      <h4 className="text-xs font-semibold text-neutral-900 uppercase tracking-wider mb-4">Theme</h4>

                      {/* Current Theme Display */}
                      <div className="bg-neutral-50 rounded-lg p-4 mb-3">
                        <div className="flex items-center justify-between mb-2">
                          <div className="text-xs font-medium text-neutral-500 uppercase tracking-wider">Current Theme</div>
                          <div className="text-sm font-semibold text-neutral-900 capitalize">{themeSettings.theme}</div>
                        </div>

                        {/* Dark/Light Mode Toggle */}
                        <div className="flex items-center justify-between pt-3 border-t border-neutral-200">
                          <span className="text-xs font-medium text-neutral-700">Mode</span>
                          <div className="flex items-center gap-2">
                            <button
                              onClick={() => applyThemePreset(themeSettings.theme, 'light')}
                              className={`px-3 py-1.5 text-xs font-medium rounded-md transition-all ${
                                themeSettings.mode === 'light'
                                  ? 'bg-neutral-900 text-white'
                                  : 'bg-white text-neutral-600 hover:bg-neutral-100 border border-neutral-200'
                              }`}
                            >
                              <svg className="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                              </svg>
                              Light
                            </button>
                            <button
                              onClick={() => applyThemePreset(themeSettings.theme, 'dark')}
                              className={`px-3 py-1.5 text-xs font-medium rounded-md transition-all ${
                                themeSettings.mode === 'dark'
                                  ? 'bg-neutral-900 text-white'
                                  : 'bg-white text-neutral-600 hover:bg-neutral-100 border border-neutral-200'
                              }`}
                            >
                              <svg className="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                              </svg>
                              Dark
                            </button>
                          </div>
                        </div>
                      </div>

                      {/* Theme Options */}
                      <div className="space-y-2">
                        {/* Minimalist */}
                        <button
                          onClick={() => applyThemePreset('minimalist', themeSettings.mode)}
                          className={`w-full p-4 rounded-lg border-2 transition-all ${
                            themeSettings.theme === 'minimalist'
                              ? 'border-neutral-900 bg-neutral-50'
                              : 'border-neutral-200 hover:border-neutral-300 bg-white'
                          }`}
                        >
                          <div className="flex items-center justify-between mb-3">
                            <div className="text-left">
                              <div className="text-sm font-semibold text-neutral-900">Minimalist</div>
                              <div className="text-xs text-neutral-500 mt-0.5">Clean neutral palette</div>
                            </div>
                            {themeSettings.theme === 'minimalist' && (
                              <svg className="w-5 h-5 text-neutral-900" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                              </svg>
                            )}
                          </div>
                          <div className="flex gap-1.5">
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.minimalist[themeSettings.mode].colors.primary}}></div>
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.minimalist[themeSettings.mode].colors.secondary}}></div>
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.minimalist[themeSettings.mode].colors.accent}}></div>
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.minimalist[themeSettings.mode].colors.surface}}></div>
                          </div>
                        </button>

                        {/* Clarity */}
                        <button
                          onClick={() => applyThemePreset('clarity', themeSettings.mode)}
                          className={`w-full p-4 rounded-lg border-2 transition-all ${
                            themeSettings.theme === 'clarity'
                              ? 'border-blue-600 bg-blue-50'
                              : 'border-neutral-200 hover:border-neutral-300 bg-white'
                          }`}
                        >
                          <div className="flex items-center justify-between mb-3">
                            <div className="text-left">
                              <div className="text-sm font-semibold text-neutral-900">Clarity</div>
                              <div className="text-xs text-neutral-500 mt-0.5">Professional blues</div>
                            </div>
                            {themeSettings.theme === 'clarity' && (
                              <svg className="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                              </svg>
                            )}
                          </div>
                          <div className="flex gap-1.5">
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.clarity[themeSettings.mode].colors.primary}}></div>
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.clarity[themeSettings.mode].colors.secondary}}></div>
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.clarity[themeSettings.mode].colors.accent}}></div>
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.clarity[themeSettings.mode].colors.surface}}></div>
                          </div>
                        </button>

                        {/* Joyful */}
                        <button
                          onClick={() => applyThemePreset('joyful', themeSettings.mode)}
                          className={`w-full p-4 rounded-lg border-2 transition-all ${
                            themeSettings.theme === 'joyful'
                              ? 'border-pink-500 bg-pink-50'
                              : 'border-neutral-200 hover:border-neutral-300 bg-white'
                          }`}
                        >
                          <div className="flex items-center justify-between mb-3">
                            <div className="text-left">
                              <div className="text-sm font-semibold text-neutral-900">Joyful</div>
                              <div className="text-xs text-neutral-500 mt-0.5">Vibrant and playful</div>
                            </div>
                            {themeSettings.theme === 'joyful' && (
                              <svg className="w-5 h-5 text-pink-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                              </svg>
                            )}
                          </div>
                          <div className="flex gap-1.5">
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.joyful[themeSettings.mode].colors.primary}}></div>
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.joyful[themeSettings.mode].colors.secondary}}></div>
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.joyful[themeSettings.mode].colors.accent}}></div>
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.joyful[themeSettings.mode].colors.surface}}></div>
                          </div>
                        </button>

                        {/* Corporate */}
                        <button
                          onClick={() => applyThemePreset('corporate', themeSettings.mode)}
                          className={`w-full p-4 rounded-lg border-2 transition-all ${
                            themeSettings.theme === 'corporate'
                              ? 'border-blue-800 bg-blue-50'
                              : 'border-neutral-200 hover:border-neutral-300 bg-white'
                          }`}
                        >
                          <div className="flex items-center justify-between mb-3">
                            <div className="text-left">
                              <div className="text-sm font-semibold text-neutral-900">Corporate</div>
                              <div className="text-xs text-neutral-500 mt-0.5">Business professional</div>
                            </div>
                            {themeSettings.theme === 'corporate' && (
                              <svg className="w-5 h-5 text-blue-800" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                              </svg>
                            )}
                          </div>
                          <div className="flex gap-1.5">
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.corporate[themeSettings.mode].colors.primary}}></div>
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.corporate[themeSettings.mode].colors.secondary}}></div>
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.corporate[themeSettings.mode].colors.accent}}></div>
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.corporate[themeSettings.mode].colors.surface}}></div>
                          </div>
                        </button>

                        {/* Ocean */}
                        <button
                          onClick={() => applyThemePreset('ocean', themeSettings.mode)}
                          className={`w-full p-4 rounded-lg border-2 transition-all ${
                            themeSettings.theme === 'ocean'
                              ? 'border-cyan-600 bg-cyan-50'
                              : 'border-neutral-200 hover:border-neutral-300 bg-white'
                          }`}
                        >
                          <div className="flex items-center justify-between mb-3">
                            <div className="text-left">
                              <div className="text-sm font-semibold text-neutral-900">Ocean</div>
                              <div className="text-xs text-neutral-500 mt-0.5">Calming aqua tones</div>
                            </div>
                            {themeSettings.theme === 'ocean' && (
                              <svg className="w-5 h-5 text-cyan-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                              </svg>
                            )}
                          </div>
                          <div className="flex gap-1.5">
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.ocean[themeSettings.mode].colors.primary}}></div>
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.ocean[themeSettings.mode].colors.secondary}}></div>
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.ocean[themeSettings.mode].colors.accent}}></div>
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.ocean[themeSettings.mode].colors.surface}}></div>
                          </div>
                        </button>

                        {/* Forest */}
                        <button
                          onClick={() => applyThemePreset('forest', themeSettings.mode)}
                          className={`w-full p-4 rounded-lg border-2 transition-all ${
                            themeSettings.theme === 'forest'
                              ? 'border-emerald-600 bg-emerald-50'
                              : 'border-neutral-200 hover:border-neutral-300 bg-white'
                          }`}
                        >
                          <div className="flex items-center justify-between mb-3">
                            <div className="text-left">
                              <div className="text-sm font-semibold text-neutral-900">Forest</div>
                              <div className="text-xs text-neutral-500 mt-0.5">Natural greens</div>
                            </div>
                            {themeSettings.theme === 'forest' && (
                              <svg className="w-5 h-5 text-emerald-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                              </svg>
                            )}
                          </div>
                          <div className="flex gap-1.5">
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.forest[themeSettings.mode].colors.primary}}></div>
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.forest[themeSettings.mode].colors.secondary}}></div>
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.forest[themeSettings.mode].colors.accent}}></div>
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.forest[themeSettings.mode].colors.surface}}></div>
                          </div>
                        </button>

                        {/* Sunset */}
                        <button
                          onClick={() => applyThemePreset('sunset', themeSettings.mode)}
                          className={`w-full p-4 rounded-lg border-2 transition-all ${
                            themeSettings.theme === 'sunset'
                              ? 'border-orange-600 bg-orange-50'
                              : 'border-neutral-200 hover:border-neutral-300 bg-white'
                          }`}
                        >
                          <div className="flex items-center justify-between mb-3">
                            <div className="text-left">
                              <div className="text-sm font-semibold text-neutral-900">Sunset</div>
                              <div className="text-xs text-neutral-500 mt-0.5">Warm oranges</div>
                            </div>
                            {themeSettings.theme === 'sunset' && (
                              <svg className="w-5 h-5 text-orange-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                              </svg>
                            )}
                          </div>
                          <div className="flex gap-1.5">
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.sunset[themeSettings.mode].colors.primary}}></div>
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.sunset[themeSettings.mode].colors.secondary}}></div>
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.sunset[themeSettings.mode].colors.accent}}></div>
                            <div className="flex-1 h-6 rounded" style={{backgroundColor: themePresets.sunset[themeSettings.mode].colors.surface}}></div>
                          </div>
                        </button>

                        {/* Custom */}
                        <button
                          onClick={() => setThemeSettings(prev => ({ ...prev, theme: 'custom' }))}
                          className={`w-full p-4 rounded-lg border-2 transition-all ${
                            themeSettings.theme === 'custom'
                              ? 'border-neutral-900 bg-neutral-50'
                              : 'border-neutral-200 hover:border-neutral-300 bg-white'
                          }`}
                        >
                          <div className="flex items-center justify-between">
                            <div className="text-left">
                              <div className="text-sm font-semibold text-neutral-900">Custom</div>
                              <div className="text-xs text-neutral-500 mt-0.5">Create your own theme</div>
                            </div>
                            {themeSettings.theme === 'custom' && (
                              <svg className="w-5 h-5 text-neutral-900" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                              </svg>
                            )}
                          </div>
                        </button>
                      </div>

                      {/* Export/Import Buttons */}
                      <div className="mt-4 pt-4 border-t border-neutral-200">
                        <div className="grid grid-cols-2 gap-2">
                          <button
                            onClick={exportTheme}
                            className="flex items-center justify-center gap-2 px-3 py-2 text-xs font-medium text-neutral-700 bg-white border border-neutral-300 rounded-lg hover:bg-neutral-50 transition-colors"
                          >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Export
                          </button>
                          <label className="flex items-center justify-center gap-2 px-3 py-2 text-xs font-medium text-neutral-700 bg-white border border-neutral-300 rounded-lg hover:bg-neutral-50 transition-colors cursor-pointer">
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                            Import
                            <input type="file" accept=".json" onChange={importTheme} className="hidden" />
                          </label>
                        </div>
                      </div>
                    </div>

                    {/* 2. Colors */}
                    <div className="border-t border-neutral-200 pt-6">
                      <h4 className="text-xs font-semibold text-neutral-900 uppercase tracking-wider mb-4">Colors</h4>
                      <div className="space-y-3">
                        {/* Primary Color */}
                        <div className="bg-neutral-50 rounded-lg p-3">
                          <label className="block text-xs font-medium text-neutral-700 mb-2">Primary</label>
                          <div className="flex items-center gap-2">
                            <input
                              type="color"
                              value={themeSettings.colors.primary}
                              onChange={(e) => setThemeSettings(prev => ({
                                ...prev,
                                theme: 'custom',
                                colors: { ...prev.colors, primary: e.target.value }
                              }))}
                              className="w-12 h-8 rounded border border-neutral-300 cursor-pointer"
                            />
                            <input
                              type="text"
                              value={themeSettings.colors.primary}
                              onChange={(e) => setThemeSettings(prev => ({
                                ...prev,
                                theme: 'custom',
                                colors: { ...prev.colors, primary: e.target.value }
                              }))}
                              className="flex-1 px-2 py-1 text-xs font-mono border border-neutral-300 rounded focus:outline-none focus:ring-1 focus:ring-neutral-400"
                            />
                          </div>
                        </div>

                        {/* Secondary Color */}
                        <div className="bg-neutral-50 rounded-lg p-3">
                          <label className="block text-xs font-medium text-neutral-700 mb-2">Secondary</label>
                          <div className="flex items-center gap-2">
                            <input
                              type="color"
                              value={themeSettings.colors.secondary}
                              onChange={(e) => setThemeSettings(prev => ({
                                ...prev,
                                theme: 'custom',
                                colors: { ...prev.colors, secondary: e.target.value }
                              }))}
                              className="w-12 h-8 rounded border border-neutral-300 cursor-pointer"
                            />
                            <input
                              type="text"
                              value={themeSettings.colors.secondary}
                              onChange={(e) => setThemeSettings(prev => ({
                                ...prev,
                                theme: 'custom',
                                colors: { ...prev.colors, secondary: e.target.value }
                              }))}
                              className="flex-1 px-2 py-1 text-xs font-mono border border-neutral-300 rounded focus:outline-none focus:ring-1 focus:ring-neutral-400"
                            />
                          </div>
                        </div>

                        {/* Accent Color */}
                        <div className="bg-neutral-50 rounded-lg p-3">
                          <label className="block text-xs font-medium text-neutral-700 mb-2">Accent</label>
                          <div className="flex items-center gap-2">
                            <input
                              type="color"
                              value={themeSettings.colors.accent}
                              onChange={(e) => setThemeSettings(prev => ({
                                ...prev,
                                theme: 'custom',
                                colors: { ...prev.colors, accent: e.target.value }
                              }))}
                              className="w-12 h-8 rounded border border-neutral-300 cursor-pointer"
                            />
                            <input
                              type="text"
                              value={themeSettings.colors.accent}
                              onChange={(e) => setThemeSettings(prev => ({
                                ...prev,
                                theme: 'custom',
                                colors: { ...prev.colors, accent: e.target.value }
                              }))}
                              className="flex-1 px-2 py-1 text-xs font-mono border border-neutral-300 rounded focus:outline-none focus:ring-1 focus:ring-neutral-400"
                            />
                          </div>
                        </div>

                        {/* Background Color */}
                        <div className="bg-neutral-50 rounded-lg p-3">
                          <label className="block text-xs font-medium text-neutral-700 mb-2">Background</label>
                          <div className="flex items-center gap-2">
                            <input
                              type="color"
                              value={themeSettings.colors.background}
                              onChange={(e) => setThemeSettings(prev => ({
                                ...prev,
                                theme: 'custom',
                                colors: { ...prev.colors, background: e.target.value }
                              }))}
                              className="w-12 h-8 rounded border border-neutral-300 cursor-pointer"
                            />
                            <input
                              type="text"
                              value={themeSettings.colors.background}
                              onChange={(e) => setThemeSettings(prev => ({
                                ...prev,
                                theme: 'custom',
                                colors: { ...prev.colors, background: e.target.value }
                              }))}
                              className="flex-1 px-2 py-1 text-xs font-mono border border-neutral-300 rounded focus:outline-none focus:ring-1 focus:ring-neutral-400"
                            />
                          </div>
                        </div>

                        {/* Surface Color */}
                        <div className="bg-neutral-50 rounded-lg p-3">
                          <label className="block text-xs font-medium text-neutral-700 mb-2">Surface</label>
                          <div className="flex items-center gap-2">
                            <input
                              type="color"
                              value={themeSettings.colors.surface}
                              onChange={(e) => setThemeSettings(prev => ({
                                ...prev,
                                theme: 'custom',
                                colors: { ...prev.colors, surface: e.target.value }
                              }))}
                              className="w-12 h-8 rounded border border-neutral-300 cursor-pointer"
                            />
                            <input
                              type="text"
                              value={themeSettings.colors.surface}
                              onChange={(e) => setThemeSettings(prev => ({
                                ...prev,
                                theme: 'custom',
                                colors: { ...prev.colors, surface: e.target.value }
                              }))}
                              className="flex-1 px-2 py-1 text-xs font-mono border border-neutral-300 rounded focus:outline-none focus:ring-1 focus:ring-neutral-400"
                            />
                          </div>
                        </div>

                        {/* Text Color */}
                        <div className="bg-neutral-50 rounded-lg p-3">
                          <label className="block text-xs font-medium text-neutral-700 mb-2">Text</label>
                          <div className="flex items-center gap-2">
                            <input
                              type="color"
                              value={themeSettings.colors.text}
                              onChange={(e) => setThemeSettings(prev => ({
                                ...prev,
                                theme: 'custom',
                                colors: { ...prev.colors, text: e.target.value }
                              }))}
                              className="w-12 h-8 rounded border border-neutral-300 cursor-pointer"
                            />
                            <input
                              type="text"
                              value={themeSettings.colors.text}
                              onChange={(e) => setThemeSettings(prev => ({
                                ...prev,
                                theme: 'custom',
                                colors: { ...prev.colors, text: e.target.value }
                              }))}
                              className="flex-1 px-2 py-1 text-xs font-mono border border-neutral-300 rounded focus:outline-none focus:ring-1 focus:ring-neutral-400"
                            />
                          </div>
                        </div>

                        {/* Text Secondary Color */}
                        <div className="bg-neutral-50 rounded-lg p-3">
                          <label className="block text-xs font-medium text-neutral-700 mb-2">Text Secondary</label>
                          <div className="flex items-center gap-2">
                            <input
                              type="color"
                              value={themeSettings.colors.textSecondary}
                              onChange={(e) => setThemeSettings(prev => ({
                                ...prev,
                                theme: 'custom',
                                colors: { ...prev.colors, textSecondary: e.target.value }
                              }))}
                              className="w-12 h-8 rounded border border-neutral-300 cursor-pointer"
                            />
                            <input
                              type="text"
                              value={themeSettings.colors.textSecondary}
                              onChange={(e) => setThemeSettings(prev => ({
                                ...prev,
                                theme: 'custom',
                                colors: { ...prev.colors, textSecondary: e.target.value }
                              }))}
                              className="flex-1 px-2 py-1 text-xs font-mono border border-neutral-300 rounded focus:outline-none focus:ring-1 focus:ring-neutral-400"
                            />
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* 3. Buttons */}
                    <div className="border-t border-neutral-200 pt-6">
                      <h4 className="text-xs font-semibold text-neutral-900 uppercase tracking-wider mb-4">Buttons</h4>
                      <div className="space-y-4">
                        {/* Primary Button */}
                        <div className="bg-neutral-50 rounded-lg p-4">
                          <div className="text-xs font-medium text-neutral-700 mb-3">Primary Button</div>

                          {/* Preview */}
                          <div className="mb-4">
                            <button
                              className="px-4 py-2 text-sm font-medium transition-all"
                              style={{
                                backgroundColor: themeSettings.buttons.primary.background,
                                color: themeSettings.buttons.primary.text,
                                borderRadius: `${themeSettings.buttons.primary.borderRadius}px`
                              }}
                            >
                              Primary Action
                            </button>
                          </div>

                          {/* Controls */}
                          <div className="space-y-3">
                            <div>
                              <label className="block text-xs font-medium text-neutral-600 mb-2">Background</label>
                              <div className="flex items-center gap-2">
                                <input
                                  type="color"
                                  value={themeSettings.buttons.primary.background}
                                  onChange={(e) => setThemeSettings(prev => ({
                                    ...prev,
                                    theme: 'custom',
                                    buttons: {
                                      ...prev.buttons,
                                      primary: { ...prev.buttons.primary, background: e.target.value }
                                    }
                                  }))}
                                  className="w-10 h-7 rounded border border-neutral-300 cursor-pointer"
                                />
                                <input
                                  type="text"
                                  value={themeSettings.buttons.primary.background}
                                  onChange={(e) => setThemeSettings(prev => ({
                                    ...prev,
                                    theme: 'custom',
                                    buttons: {
                                      ...prev.buttons,
                                      primary: { ...prev.buttons.primary, background: e.target.value }
                                    }
                                  }))}
                                  className="flex-1 px-2 py-1 text-xs font-mono border border-neutral-300 rounded focus:outline-none focus:ring-1 focus:ring-neutral-400"
                                />
                              </div>
                            </div>

                            <div>
                              <label className="block text-xs font-medium text-neutral-600 mb-2">Text Color</label>
                              <div className="flex items-center gap-2">
                                <input
                                  type="color"
                                  value={themeSettings.buttons.primary.text}
                                  onChange={(e) => setThemeSettings(prev => ({
                                    ...prev,
                                    theme: 'custom',
                                    buttons: {
                                      ...prev.buttons,
                                      primary: { ...prev.buttons.primary, text: e.target.value }
                                    }
                                  }))}
                                  className="w-10 h-7 rounded border border-neutral-300 cursor-pointer"
                                />
                                <input
                                  type="text"
                                  value={themeSettings.buttons.primary.text}
                                  onChange={(e) => setThemeSettings(prev => ({
                                    ...prev,
                                    theme: 'custom',
                                    buttons: {
                                      ...prev.buttons,
                                      primary: { ...prev.buttons.primary, text: e.target.value }
                                    }
                                  }))}
                                  className="flex-1 px-2 py-1 text-xs font-mono border border-neutral-300 rounded focus:outline-none focus:ring-1 focus:ring-neutral-400"
                                />
                              </div>
                            </div>

                            <div>
                              <label className="block text-xs font-medium text-neutral-600 mb-2">Border Radius: {themeSettings.buttons.primary.borderRadius}px</label>
                              <input
                                type="range"
                                min="0"
                                max="24"
                                value={themeSettings.buttons.primary.borderRadius}
                                onChange={(e) => setThemeSettings(prev => ({
                                  ...prev,
                                  theme: 'custom',
                                  buttons: {
                                    ...prev.buttons,
                                    primary: { ...prev.buttons.primary, borderRadius: parseInt(e.target.value) }
                                  }
                                }))}
                                className="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer"
                              />
                            </div>
                          </div>
                        </div>

                        {/* Secondary Button */}
                        <div className="bg-neutral-50 rounded-lg p-4">
                          <div className="text-xs font-medium text-neutral-700 mb-3">Secondary Button</div>

                          {/* Preview */}
                          <div className="mb-4">
                            <button
                              className="px-4 py-2 text-sm font-medium border transition-all"
                              style={{
                                backgroundColor: themeSettings.buttons.secondary.background,
                                color: themeSettings.buttons.secondary.text,
                                borderRadius: `${themeSettings.buttons.secondary.borderRadius}px`,
                                borderColor: '#e5e5e5'
                              }}
                            >
                              Secondary Action
                            </button>
                          </div>

                          {/* Controls */}
                          <div className="space-y-3">
                            <div>
                              <label className="block text-xs font-medium text-neutral-600 mb-2">Background</label>
                              <div className="flex items-center gap-2">
                                <input
                                  type="color"
                                  value={themeSettings.buttons.secondary.background}
                                  onChange={(e) => setThemeSettings(prev => ({
                                    ...prev,
                                    theme: 'custom',
                                    buttons: {
                                      ...prev.buttons,
                                      secondary: { ...prev.buttons.secondary, background: e.target.value }
                                    }
                                  }))}
                                  className="w-10 h-7 rounded border border-neutral-300 cursor-pointer"
                                />
                                <input
                                  type="text"
                                  value={themeSettings.buttons.secondary.background}
                                  onChange={(e) => setThemeSettings(prev => ({
                                    ...prev,
                                    theme: 'custom',
                                    buttons: {
                                      ...prev.buttons,
                                      secondary: { ...prev.buttons.secondary, background: e.target.value }
                                    }
                                  }))}
                                  className="flex-1 px-2 py-1 text-xs font-mono border border-neutral-300 rounded focus:outline-none focus:ring-1 focus:ring-neutral-400"
                                />
                              </div>
                            </div>

                            <div>
                              <label className="block text-xs font-medium text-neutral-600 mb-2">Text Color</label>
                              <div className="flex items-center gap-2">
                                <input
                                  type="color"
                                  value={themeSettings.buttons.secondary.text}
                                  onChange={(e) => setThemeSettings(prev => ({
                                    ...prev,
                                    theme: 'custom',
                                    buttons: {
                                      ...prev.buttons,
                                      secondary: { ...prev.buttons.secondary, text: e.target.value }
                                    }
                                  }))}
                                  className="w-10 h-7 rounded border border-neutral-300 cursor-pointer"
                                />
                                <input
                                  type="text"
                                  value={themeSettings.buttons.secondary.text}
                                  onChange={(e) => setThemeSettings(prev => ({
                                    ...prev,
                                    theme: 'custom',
                                    buttons: {
                                      ...prev.buttons,
                                      secondary: { ...prev.buttons.secondary, text: e.target.value }
                                    }
                                  }))}
                                  className="flex-1 px-2 py-1 text-xs font-mono border border-neutral-300 rounded focus:outline-none focus:ring-1 focus:ring-neutral-400"
                                />
                              </div>
                            </div>

                            <div>
                              <label className="block text-xs font-medium text-neutral-600 mb-2">Border Radius: {themeSettings.buttons.secondary.borderRadius}px</label>
                              <input
                                type="range"
                                min="0"
                                max="24"
                                value={themeSettings.buttons.secondary.borderRadius}
                                onChange={(e) => setThemeSettings(prev => ({
                                  ...prev,
                                  theme: 'custom',
                                  buttons: {
                                    ...prev.buttons,
                                    secondary: { ...prev.buttons.secondary, borderRadius: parseInt(e.target.value) }
                                  }
                                }))}
                                className="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer"
                              />
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* 4. Text */}
                    <div className="border-t border-neutral-200 pt-6">
                      <h4 className="text-xs font-semibold text-neutral-900 uppercase tracking-wider mb-4">Typography</h4>
                      <div className="space-y-4">
                        {/* Header Typography */}
                        <div className="bg-neutral-50 rounded-lg p-4">
                          <div className="text-xs font-medium text-neutral-700 mb-3">Header</div>

                          {/* Preview */}
                          <div
                            className="mb-4 pb-3 border-b border-neutral-200"
                            style={{
                              fontSize: `${themeSettings.typography.header.fontSize}px`,
                              lineHeight: themeSettings.typography.header.lineHeight,
                              fontWeight: themeSettings.typography.header.fontWeight
                            }}
                          >
                            The quick brown fox
                          </div>

                          {/* Controls */}
                          <div className="space-y-3">
                            <div>
                              <label className="block text-xs font-medium text-neutral-600 mb-2">Font Size: {themeSettings.typography.header.fontSize}px</label>
                              <input
                                type="range"
                                min="16"
                                max="48"
                                value={themeSettings.typography.header.fontSize}
                                onChange={(e) => setThemeSettings(prev => ({
                                  ...prev,
                                  theme: 'custom',
                                  typography: {
                                    ...prev.typography,
                                    header: { ...prev.typography.header, fontSize: parseInt(e.target.value) }
                                  }
                                }))}
                                className="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer"
                              />
                            </div>
                            <div>
                              <label className="block text-xs font-medium text-neutral-600 mb-2">Line Height: {themeSettings.typography.header.lineHeight}</label>
                              <input
                                type="range"
                                min="1"
                                max="2"
                                step="0.1"
                                value={themeSettings.typography.header.lineHeight}
                                onChange={(e) => setThemeSettings(prev => ({
                                  ...prev,
                                  theme: 'custom',
                                  typography: {
                                    ...prev.typography,
                                    header: { ...prev.typography.header, lineHeight: parseFloat(e.target.value) }
                                  }
                                }))}
                                className="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer"
                              />
                            </div>
                            <div>
                              <label className="block text-xs font-medium text-neutral-600 mb-2">Font Weight</label>
                              <select
                                value={themeSettings.typography.header.fontWeight}
                                onChange={(e) => setThemeSettings(prev => ({
                                  ...prev,
                                  theme: 'custom',
                                  typography: {
                                    ...prev.typography,
                                    header: { ...prev.typography.header, fontWeight: parseInt(e.target.value) }
                                  }
                                }))}
                                className="w-full px-2 py-1.5 text-xs border border-neutral-300 rounded focus:outline-none focus:ring-1 focus:ring-neutral-400"
                              >
                                <option value="300">Light (300)</option>
                                <option value="400">Regular (400)</option>
                                <option value="500">Medium (500)</option>
                                <option value="600">Semibold (600)</option>
                                <option value="700">Bold (700)</option>
                              </select>
                            </div>
                          </div>
                        </div>

                        {/* Paragraph Typography */}
                        <div className="bg-neutral-50 rounded-lg p-4">
                          <div className="text-xs font-medium text-neutral-700 mb-3">Paragraph</div>

                          {/* Preview */}
                          <div
                            className="mb-4 pb-3 border-b border-neutral-200"
                            style={{
                              fontSize: `${themeSettings.typography.paragraph.fontSize}px`,
                              lineHeight: themeSettings.typography.paragraph.lineHeight,
                              fontWeight: themeSettings.typography.paragraph.fontWeight
                            }}
                          >
                            The quick brown fox jumps over the lazy dog
                          </div>

                          {/* Controls */}
                          <div className="space-y-3">
                            <div>
                              <label className="block text-xs font-medium text-neutral-600 mb-2">Font Size: {themeSettings.typography.paragraph.fontSize}px</label>
                              <input
                                type="range"
                                min="12"
                                max="24"
                                value={themeSettings.typography.paragraph.fontSize}
                                onChange={(e) => setThemeSettings(prev => ({
                                  ...prev,
                                  theme: 'custom',
                                  typography: {
                                    ...prev.typography,
                                    paragraph: { ...prev.typography.paragraph, fontSize: parseInt(e.target.value) }
                                  }
                                }))}
                                className="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer"
                              />
                            </div>
                            <div>
                              <label className="block text-xs font-medium text-neutral-600 mb-2">Line Height: {themeSettings.typography.paragraph.lineHeight}</label>
                              <input
                                type="range"
                                min="1.2"
                                max="2"
                                step="0.1"
                                value={themeSettings.typography.paragraph.lineHeight}
                                onChange={(e) => setThemeSettings(prev => ({
                                  ...prev,
                                  theme: 'custom',
                                  typography: {
                                    ...prev.typography,
                                    paragraph: { ...prev.typography.paragraph, lineHeight: parseFloat(e.target.value) }
                                  }
                                }))}
                                className="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer"
                              />
                            </div>
                            <div>
                              <label className="block text-xs font-medium text-neutral-600 mb-2">Font Weight</label>
                              <select
                                value={themeSettings.typography.paragraph.fontWeight}
                                onChange={(e) => setThemeSettings(prev => ({
                                  ...prev,
                                  theme: 'custom',
                                  typography: {
                                    ...prev.typography,
                                    paragraph: { ...prev.typography.paragraph, fontWeight: parseInt(e.target.value) }
                                  }
                                }))}
                                className="w-full px-2 py-1.5 text-xs border border-neutral-300 rounded focus:outline-none focus:ring-1 focus:ring-neutral-400"
                              >
                                <option value="300">Light (300)</option>
                                <option value="400">Regular (400)</option>
                                <option value="500">Medium (500)</option>
                                <option value="600">Semibold (600)</option>
                                <option value="700">Bold (700)</option>
                              </select>
                            </div>
                          </div>
                        </div>

                        {/* Default Typography */}
                        <div className="bg-neutral-50 rounded-lg p-4">
                          <div className="text-xs font-medium text-neutral-700 mb-3">Default</div>

                          {/* Preview */}
                          <div
                            className="mb-4 pb-3 border-b border-neutral-200"
                            style={{
                              fontSize: `${themeSettings.typography.default.fontSize}px`,
                              lineHeight: themeSettings.typography.default.lineHeight,
                              fontWeight: themeSettings.typography.default.fontWeight
                            }}
                          >
                            The quick brown fox jumps over the lazy dog
                          </div>

                          {/* Controls */}
                          <div className="space-y-3">
                            <div>
                              <label className="block text-xs font-medium text-neutral-600 mb-2">Font Size: {themeSettings.typography.default.fontSize}px</label>
                              <input
                                type="range"
                                min="12"
                                max="20"
                                value={themeSettings.typography.default.fontSize}
                                onChange={(e) => setThemeSettings(prev => ({
                                  ...prev,
                                  theme: 'custom',
                                  typography: {
                                    ...prev.typography,
                                    default: { ...prev.typography.default, fontSize: parseInt(e.target.value) }
                                  }
                                }))}
                                className="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer"
                              />
                            </div>
                            <div>
                              <label className="block text-xs font-medium text-neutral-600 mb-2">Line Height: {themeSettings.typography.default.lineHeight}</label>
                              <input
                                type="range"
                                min="1.2"
                                max="2"
                                step="0.1"
                                value={themeSettings.typography.default.lineHeight}
                                onChange={(e) => setThemeSettings(prev => ({
                                  ...prev,
                                  theme: 'custom',
                                  typography: {
                                    ...prev.typography,
                                    default: { ...prev.typography.default, lineHeight: parseFloat(e.target.value) }
                                  }
                                }))}
                                className="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer"
                              />
                            </div>
                            <div>
                              <label className="block text-xs font-medium text-neutral-600 mb-2">Font Weight</label>
                              <select
                                value={themeSettings.typography.default.fontWeight}
                                onChange={(e) => setThemeSettings(prev => ({
                                  ...prev,
                                  theme: 'custom',
                                  typography: {
                                    ...prev.typography,
                                    default: { ...prev.typography.default, fontWeight: parseInt(e.target.value) }
                                  }
                                }))}
                                className="w-full px-2 py-1.5 text-xs border border-neutral-300 rounded focus:outline-none focus:ring-1 focus:ring-neutral-400"
                              >
                                <option value="300">Light (300)</option>
                                <option value="400">Regular (400)</option>
                                <option value="500">Medium (500)</option>
                                <option value="600">Semibold (600)</option>
                                <option value="700">Bold (700)</option>
                              </select>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* 5. Images */}
                    <div className="border-t border-neutral-200 pt-6">
                      <h4 className="text-xs font-semibold text-neutral-900 uppercase tracking-wider mb-4">Images</h4>
                      <div className="bg-neutral-50 rounded-lg p-4">
                        <div className="text-xs font-medium text-neutral-700 mb-3">Image Frame Style</div>

                        {/* Preview */}
                        <div
                          className="w-full h-32 bg-neutral-200 flex items-center justify-center mb-4"
                          style={{
                            borderWidth: `${themeSettings.images.borderWidth}px`,
                            borderColor: '#d4d4d4',
                            borderRadius: `${themeSettings.images.borderRadius}px`,
                            boxShadow: themeSettings.images.shadow === 'sm' ? '0 1px 2px 0 rgb(0 0 0 / 0.05)' :
                                       themeSettings.images.shadow === 'md' ? '0 4px 6px -1px rgb(0 0 0 / 0.1)' :
                                       themeSettings.images.shadow === 'lg' ? '0 10px 15px -3px rgb(0 0 0 / 0.1)' : 'none'
                          }}
                        >
                          <div className="text-center text-neutral-400">
                            <svg className="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <div className="text-xs">Image Placeholder</div>
                          </div>
                        </div>

                        {/* Controls */}
                        <div className="space-y-3">
                          <div>
                            <label className="block text-xs font-medium text-neutral-600 mb-2">Border Width: {themeSettings.images.borderWidth}px</label>
                            <input
                              type="range"
                              min="0"
                              max="8"
                              value={themeSettings.images.borderWidth}
                              onChange={(e) => setThemeSettings(prev => ({
                                ...prev,
                                theme: 'custom',
                                images: { ...prev.images, borderWidth: parseInt(e.target.value) }
                              }))}
                              className="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer"
                            />
                          </div>

                          <div>
                            <label className="block text-xs font-medium text-neutral-600 mb-2">Border Radius: {themeSettings.images.borderRadius}px</label>
                            <input
                              type="range"
                              min="0"
                              max="24"
                              value={themeSettings.images.borderRadius}
                              onChange={(e) => setThemeSettings(prev => ({
                                ...prev,
                                theme: 'custom',
                                images: { ...prev.images, borderRadius: parseInt(e.target.value) }
                              }))}
                              className="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer"
                            />
                          </div>

                          <div>
                            <label className="block text-xs font-medium text-neutral-600 mb-2">Shadow</label>
                            <select
                              value={themeSettings.images.shadow}
                              onChange={(e) => setThemeSettings(prev => ({
                                ...prev,
                                theme: 'custom',
                                images: { ...prev.images, shadow: e.target.value }
                              }))}
                              className="w-full px-2 py-1.5 text-xs border border-neutral-300 rounded focus:outline-none focus:ring-1 focus:ring-neutral-400"
                            >
                              <option value="none">None</option>
                              <option value="sm">Small</option>
                              <option value="md">Medium</option>
                              <option value="lg">Large</option>
                            </select>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* 6. Page Background */}
                    <div className="border-t border-neutral-200 pt-6">
                      <h4 className="text-xs font-semibold text-neutral-900 uppercase tracking-wider mb-4">Page Background</h4>
                      <div className="bg-neutral-50 rounded-lg p-4">
                        <label className="block text-xs font-medium text-neutral-700 mb-3">Background Color</label>

                        {/* Preview */}
                        <div
                          className="w-full h-16 rounded-lg border-2 border-white shadow-sm mb-3"
                          style={{ backgroundColor: themeSettings.pageBackground }}
                        ></div>

                        {/* Controls */}
                        <div className="flex items-center gap-2">
                          <input
                            type="color"
                            value={themeSettings.pageBackground}
                            onChange={(e) => setThemeSettings(prev => ({
                              ...prev,
                              theme: 'custom',
                              pageBackground: e.target.value
                            }))}
                            className="w-12 h-8 rounded border border-neutral-300 cursor-pointer"
                          />
                          <input
                            type="text"
                            value={themeSettings.pageBackground}
                            onChange={(e) => setThemeSettings(prev => ({
                              ...prev,
                              theme: 'custom',
                              pageBackground: e.target.value
                            }))}
                            className="flex-1 px-2 py-1 text-xs font-mono border border-neutral-300 rounded focus:outline-none focus:ring-1 focus:ring-neutral-400"
                          />
                        </div>
                      </div>
                    </div>

                    {/* 7. Layout */}
                    <div className="border-t border-neutral-200 pt-6">
                      <h4 className="text-xs font-semibold text-neutral-900 uppercase tracking-wider mb-4">Layout</h4>
                      <div className="space-y-2">
                        <button
                          onClick={() => setThemeSettings(prev => ({ ...prev, layout: { ...prev.layout, spacing: 'compact' } }))}
                          className={`w-full px-4 py-3 text-sm font-medium rounded-lg transition-all ${
                            themeSettings.layout.spacing === 'compact'
                              ? 'bg-neutral-900 text-white'
                              : 'bg-neutral-100 text-neutral-700 hover:bg-neutral-200'
                          }`}
                        >
                          Compact
                        </button>
                        <button
                          onClick={() => setThemeSettings(prev => ({ ...prev, layout: { ...prev.layout, spacing: 'comfortable' } }))}
                          className={`w-full px-4 py-3 text-sm font-medium rounded-lg transition-all ${
                            themeSettings.layout.spacing === 'comfortable'
                              ? 'bg-neutral-900 text-white'
                              : 'bg-neutral-100 text-neutral-700 hover:bg-neutral-200'
                          }`}
                        >
                          Comfortable
                        </button>
                        <button
                          onClick={() => setThemeSettings(prev => ({ ...prev, layout: { ...prev.layout, spacing: 'spacious' } }))}
                          className={`w-full px-4 py-3 text-sm font-medium rounded-lg transition-all ${
                            themeSettings.layout.spacing === 'spacious'
                              ? 'bg-neutral-900 text-white'
                              : 'bg-neutral-100 text-neutral-700 hover:bg-neutral-200'
                          }`}
                        >
                          Spacious
                        </button>
                      </div>
                    </div>
                  </div>
                ) : settingsCategory === 'element' ? (
                  /* Element Settings Placeholder */
                  <div className="space-y-6">
                    <SettingsHeader
                      title="Element Settings"
                      subtitle="Configure individual elements"
                      onBack={() => setSettingsCategory(null)}
                    />

                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-6 text-center">
                      <svg className="w-12 h-12 text-blue-600 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                      <p className="text-sm font-medium text-blue-900">No Element Selected</p>
                      <p className="text-xs text-blue-700 mt-1">Select an element on the canvas to configure its settings</p>
                    </div>
                  </div>
                ) : null
              )
            ) : null}
          </div>
        </div>
      </div>

      {/* Main Content Area - Shifts when panel opens */}
      <div
        className={`flex-1 panel-transition ${
          isComponentPanelOpen ? 'mr-80' : 'mr-0'
        } ${
          isLayerActive('studio') ? 'mt-12' : 'mt-0'
        }`}
        style={{
          transitionTimingFunction: 'var(--ease-spring)',
          transitionDuration: 'var(--duration-slower)',
        }}
      >
        <main
          ref={mainContentRef}
          className={
            view === 'canvas'
              ? 'w-full h-full'
              : view === 'slide-deck'
                ? 'w-full h-full' // No padding for slide deck view (needs full height)
                : view === 'detail'
                  ? 'mx-auto px-8 pb-12 panel-transition' // No top padding for detail view (header zone handles its own padding)
                  : 'mx-auto px-8 py-12 panel-transition'
          }
          style={(view === 'canvas' || view === 'slide-deck') ? {} : {
            maxWidth: (() => {
              // Detail view: Respect container width setting
              if (view === 'detail' && pageSettings.detail.containerWidth === 'full') {
                return 'none';
              }
              // List view: Respect container width setting
              if (view === 'list' && pageSettings.list.containerWidth === 'full') {
                return 'none';
              }
              // Default: 1400px max (old behavior)
              return '1400px';
            })(),
            transitionTimingFunction: 'var(--ease-spring)',
            transitionDuration: 'var(--duration-slower)',
            marginLeft: (() => {
              // Only add margin when Explorer is floating/snapped (not docked)
              // When docked, the outer wrapper already handles the margin
              if (isLayerActive('explorer') && !explorerPanelMinimized && !explorerIsDocked) {
                if (explorerPanelSnapped === 'left') {
                  // When snapped left (floating), use spacing with padding
                  return `${explorerPanelSize.width + 40}px`;
                }
              }
              return '';
            })(),
            marginRight: isLayerActive('explorer') && explorerPanelSnapped === 'right' && !explorerPanelMinimized
              ? `${explorerPanelSize.width + 40}px`
              : ''
          }}
        >
        {view === 'template-demo' ? (
          <TemplateDemo />
        ) : view === 'slide-deck' ? (
          <div className="h-full bg-white animate-view-fade-in">
            {deckView === 'list' ? (
              <DeckList
                onCreateDeck={async () => {
                  try {
                    const newDeck = await deckService.createDeck({
                      name: 'New Presentation',
                      description: 'Created from records app',
                      tags: []
                    });
                    setCurrentDeckId(newDeck.id);
                    setDeckView('editor');
                  } catch (err) {
                    console.error('Failed to create deck:', err);
                  }
                }}
                onOpenDeck={(deckId) => {
                  setCurrentDeckId(deckId);
                  setDeckView('editor');
                }}
              />
            ) : (
              <div className="h-full flex flex-col">
                {/* Back to List Button */}
                <div className="bg-gray-50 border-b border-gray-200 px-6 py-3">
                  <button
                    onClick={() => {
                      setDeckView('list');
                      setCurrentDeckId(null);
                    }}
                    className="flex items-center space-x-2 text-blue-600 hover:text-blue-700"
                  >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    <span>Back to Deck List</span>
                  </button>
                </div>
                {/* Editor */}
                <div className="flex-1 overflow-hidden">
                  <SimpleDeckEditorDemo deckId={currentDeckId} />
                </div>
              </div>
            )}
          </div>
        ) : view === 'canvas' ? (
          <InfiniteCanvas
            onClose={() => setView('list')}
            onShapesChange={setCanvasShapes}
            mode={canvasType}
          />
        ) : view === 'custom-page' ? (
          (() => {
            // Find the active custom page
            const activePage = customPages.find(p => p.id === activeCustomPageId);

            if (!activePage) {
              return (
                <div className="flex items-center justify-center h-screen">
                  <p className="text-neutral-500">Page not found</p>
                </div>
              );
            }

            // Render Database Page (Notion-style)
            if (activePage.type === 'database') {
              const settings = activePage.settings || {};
              const cover = settings.cover || {};
              const header = settings.header || {};
              const body = settings.body || {};

              // Check if using new universalConfig structure
              const universalConfig = settings.universalConfig;
              const useNewStructure = !!universalConfig;

              return (
                <div className="animate-view-fade-in">
                  {/* Cover Image Zone - Edge to Edge */}
                  {cover.enabled && cover.image && (
                    <div
                      className="relative w-screen bg-neutral-100 cursor-move"
                      style={{
                        height: '340px',
                        marginLeft: 'calc(-50vw + 50%)'
                      }}
                      onMouseDown={(e) => {
                        setIsDraggingCover(true);
                        setCoverDragStartY(e.clientY);
                        setCoverDragStartPosition(cover.verticalPosition || 50);
                        e.preventDefault();
                      }}
                      onMouseMove={(e) => {
                        if (isDraggingCover) {
                          const deltaY = e.clientY - coverDragStartY;
                          const deltaPercent = (deltaY / 340) * 100;
                          const newPosition = Math.max(0, Math.min(100, coverDragStartPosition + deltaPercent));

                          setCustomPages(customPages.map(p =>
                            p.id === activePage.id
                              ? {
                                  ...p,
                                  settings: {
                                    ...p.settings,
                                    cover: {
                                      ...cover,
                                      verticalPosition: newPosition
                                    }
                                  }
                                }
                              : p
                          ));
                        }
                      }}
                      onMouseUp={() => setIsDraggingCover(false)}
                      onMouseLeave={() => setIsDraggingCover(false)}
                    >
                      <img
                        src={cover.image}
                        alt="Cover"
                        className="w-full h-full object-cover pointer-events-none select-none"
                        style={{
                          objectPosition: `center ${cover.verticalPosition || 50}%`
                        }}
                        draggable={false}
                      />
                      {/* Cover controls - shown on hover */}
                      <div className={`absolute inset-0 ${isDraggingCover ? 'bg-black/20' : 'bg-black/0 hover:bg-black/10'} transition-colors group`}>
                        {isDraggingCover && (
                          <div className="absolute inset-0 flex items-center justify-center">
                            <div className="bg-white/90 px-4 py-2 rounded-lg shadow-lg">
                              <div className="text-sm font-medium text-neutral-900">
                                Position: {Math.round(cover.verticalPosition || 50)}%
                              </div>
                              <div className="text-xs text-neutral-500 mt-1">
                                Drag to reposition
                              </div>
                            </div>
                          </div>
                        )}
                        <div className={`absolute bottom-4 right-4 transition-opacity flex gap-2 ${isDraggingCover ? 'opacity-0 pointer-events-none' : 'opacity-0 group-hover:opacity-100'}`}>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              setShowUnsplashModal(true);
                            }}
                            className="px-3 py-1.5 bg-white/90 hover:bg-white text-sm text-neutral-700 rounded-lg transition-colors"
                          >
                            Change
                          </button>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              setCustomPages(customPages.map(p =>
                                p.id === activePage.id
                                  ? { ...p, settings: { ...p.settings, cover: { ...cover, enabled: false, image: null } } }
                                  : p
                              ));
                            }}
                            className="px-3 py-1.5 bg-white/90 hover:bg-white text-sm text-neutral-700 rounded-lg transition-colors"
                          >
                            Remove
                          </button>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Add Cover Button (when no cover) */}
                  {!cover.enabled && (
                    <div className="group relative h-12 hover:bg-neutral-50/50 transition-colors">
                      <button
                        className="absolute inset-0 w-full flex items-center justify-center
                                   opacity-0 group-hover:opacity-100 transition-opacity
                                   text-sm text-neutral-500 gap-2"
                        onClick={() => setShowUnsplashModal(true)}
                      >
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        Add cover
                      </button>
                    </div>
                  )}

                  {/* Page Icon (overlaps cover if present) */}
                  {(header.icon || showEmojiPicker) && (
                    <div
                      className="relative px-12"
                      style={{ marginTop: cover.enabled ? '-39px' : '40px' }}
                    >
                      <button
                        className="text-6xl bg-white rounded-lg p-2 border border-neutral-200
                                   hover:bg-neutral-50 transition-colors relative group"
                        onClick={() => setShowEmojiPicker(!showEmojiPicker)}
                      >
                        {header.icon || 'ðŸ˜Š'}
                        {!header.icon && (
                          <span className="absolute inset-0 flex items-center justify-center text-xs text-neutral-400 group-hover:text-neutral-600">
                            Click to add icon
                          </span>
                        )}
                      </button>
                    </div>
                  )}

                  {/* Header Zone - Title and Description */}
                  <div className="px-12" style={{ paddingTop: header.icon ? '16px' : (cover.enabled ? '60px' : '24px') }}>
                    {/* Add icon button (when no icon) */}
                    {!header.icon && !showEmojiPicker && (
                      <button
                        onClick={() => setShowEmojiPicker(true)}
                        className="mb-4 text-sm text-neutral-500 hover:text-neutral-700 hover:bg-neutral-100 px-3 py-1.5 rounded-lg transition-colors flex items-center gap-2"
                      >
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Add icon
                      </button>
                    )}

                    <input
                      className="page-title-input w-full text-4xl font-bold
                                 border-0 outline-none placeholder-neutral-300
                                 focus:ring-0 bg-transparent"
                      value={header.title || 'Untitled'}
                      onChange={(e) => {
                        setCustomPages(customPages.map(p =>
                          p.id === activePage.id
                            ? { ...p, name: e.target.value, settings: { ...p.settings, header: { ...header, title: e.target.value } } }
                            : p
                        ));
                      }}
                      placeholder="Untitled"
                    />

                    <input
                      className="w-full mt-2 text-sm text-neutral-500
                                 border-0 outline-none placeholder-neutral-300
                                 focus:ring-0 bg-transparent"
                      value={header.description || ''}
                      onChange={(e) => {
                        setCustomPages(customPages.map(p =>
                          p.id === activePage.id
                            ? { ...p, settings: { ...p.settings, header: { ...header, description: e.target.value } } }
                            : p
                        ));
                      }}
                      placeholder="Add a description..."
                    />
                  </div>

                  {/* Body Zone - Content */}
                  <div className="px-12 mt-8 pb-24">
                    {/* Use new zone/row/column system if universalConfig exists */}
                    {useNewStructure ? (
                      <>
                        {renderCustomPageZone('body', getCustomPageZoneData(activePage.id, 'body'), activePage.id)}
                        {/* Add element prompt at bottom */}
                        {isDesignMode() && (
                          <div className="mt-8 flex items-center gap-3 text-neutral-400 py-2 opacity-50 hover:opacity-100 transition-opacity">
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 4v16m8-8H4" />
                            </svg>
                            <span className="text-sm">Drag elements from the sidebar to add content</span>
                          </div>
                        )}
                      </>
                    ) : (
                      /* Legacy rendering for pages without universalConfig */
                      (!body.elements || body.elements.length === 0) && body.showSlashInput ? (
                      <div className="py-4">
                        <div className="flex items-center gap-3 text-neutral-400 mb-4">
                          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 4v16m8-8H4" />
                          </svg>
                          <input
                            className="flex-1 text-base border-0 outline-none placeholder-neutral-400
                                       focus:ring-0 bg-transparent"
                            placeholder="Type '/' for blocks, or just start typing..."
                            onChange={(e) => {
                              if (e.target.value === '/') {
                                const rect = e.target.getBoundingClientRect();
                                setSlashPalettePosition({ x: rect.left, y: rect.bottom + 8 });
                                setSlashPaletteInput(e.target);
                                setShowSlashPalette(true);
                                e.target.value = '';
                              }
                            }}
                            onKeyDown={(e) => {
                              if (e.key === 'Enter' && e.target.value.trim() && !showSlashPalette) {
                                // Create a simple text element
                                const newElement = {
                                  id: `elem-${Date.now()}`,
                                  type: 'text',
                                  content: e.target.value
                                };
                                setCustomPages(customPages.map(p =>
                                  p.id === activePage.id
                                    ? {
                                        ...p,
                                        settings: {
                                          ...p.settings,
                                          body: {
                                            ...body,
                                            elements: [...(body.elements || []), newElement]
                                          }
                                        }
                                      }
                                    : p
                                ));
                                e.target.value = '';
                              } else if (e.key === 'Escape') {
                                setShowSlashPalette(false);
                              }
                            }}
                          />
                        </div>
                        <div className="flex gap-6 text-xs text-neutral-400">
                          <span>Press <kbd className="px-1.5 py-0.5 bg-neutral-100 rounded text-neutral-500">/</kbd> for quick insert</span>
                          <span>Drag from Elements panel â†’</span>
                          <span>Click <kbd className="px-1.5 py-0.5 bg-neutral-100 rounded text-neutral-500">+ Add cover</kbd> above</span>
                        </div>
                      </div>
                    ) : (
                      <SortableContext
                        items={(body.elements || []).map(el => el.id)}
                        strategy={verticalListSortingStrategy}
                      >
                        <div className="space-y-4">
                          {(body.elements || []).map((element) => (
                            <SortableBodyElement
                              key={element.id}
                              element={element}
                              activePage={activePage}
                              customPages={customPages}
                              setCustomPages={setCustomPages}
                            />
                          ))}
                        {/* Add new element input at bottom */}
                        <div className="flex items-center gap-3 text-neutral-400 py-2 opacity-50 hover:opacity-100 transition-opacity">
                          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 4v16m8-8H4" />
                          </svg>
                          <input
                            className="flex-1 text-base border-0 outline-none placeholder-neutral-400
                                       focus:ring-0 bg-transparent"
                            placeholder="Type '/' for blocks, or just start typing..."
                            onChange={(e) => {
                              if (e.target.value === '/') {
                                const rect = e.target.getBoundingClientRect();
                                setSlashPalettePosition({ x: rect.left, y: rect.bottom + 8 });
                                setSlashPaletteInput(e.target);
                                setShowSlashPalette(true);
                                e.target.value = '';
                              }
                            }}
                            onKeyDown={(e) => {
                              if (e.key === 'Enter' && e.target.value.trim() && !showSlashPalette) {
                                const newElement = {
                                  id: `elem-${Date.now()}`,
                                  type: 'text',
                                  content: e.target.value
                                };
                                setCustomPages(customPages.map(p =>
                                  p.id === activePage.id
                                    ? {
                                        ...p,
                                        settings: {
                                          ...p.settings,
                                          body: {
                                            ...body,
                                            elements: [...(body.elements || []), newElement]
                                          }
                                        }
                                      }
                                    : p
                                ));
                                e.target.value = '';
                              } else if (e.key === 'Escape') {
                                setShowSlashPalette(false);
                              }
                            }}
                          />
                        </div>
                        </div>
                      </SortableContext>
                    ))}
                  </div>
                </div>
              );
            }

            // Fallback for other custom page types
            return (
              <div className="flex items-center justify-center h-screen">
                <p className="text-neutral-500">Custom page type not yet implemented</p>
              </div>
            );
          })()
        ) : view === 'list' ? (
          <div className="animate-view-fade-in">
            {/* Command Bar - Premium minimalist toolbar */}
            <div className="mb-8">
              <div className="flex items-center justify-between mb-6">
                <div className="relative flex-1 max-w-md">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg className="h-4 w-4 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                  </div>
                  <Input
                    placeholder="Search records by name, type, tags..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="pl-10 bg-neutral-50 border-neutral-200 focus:bg-white transition-colors"
                  />
                  <div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                    <kbd className="hidden sm:inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-white border border-neutral-200 text-neutral-500">
                      âŒ˜K
                    </kbd>
                  </div>
                </div>
                <div className="flex items-center gap-3 ml-6">
                  {selectedRecords.length > 0 && (
                    <div className="flex items-center gap-2 mr-4">
                      <span className="text-sm text-neutral-600">{selectedRecords.length} selected</span>
                      <Button onClick={handleBulkExport} variant="ghost" size="sm" className="text-xs">
                        <svg className="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Export
                      </Button>
                      <Button onClick={handleBulkEmail} variant="ghost" size="sm" className="text-xs">
                        <svg className="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        Email
                      </Button>
                      <Button onClick={handleBulkDelete} variant="ghost" size="sm" className="text-xs text-red-600 hover:text-red-700">
                        <svg className="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        Delete
                      </Button>
                    </div>
                  )}
                  <Button
                    onClick={() => setIsFilterPanelOpen(!isFilterPanelOpen)}
                    variant="ghost"
                    size="sm"
                    className={`text-neutral-700 ${(statusFilter.length > 0 || typeFilter.length > 0) ? 'bg-neutral-100' : ''}`}
                  >
                    <svg className="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                    </svg>
                    Filter
                    {(statusFilter.length > 0 || typeFilter.length > 0) && (
                      <span className="ml-1.5 px-1.5 py-0.5 bg-neutral-900 text-white text-[10px] rounded-full">
                        {statusFilter.length + typeFilter.length}
                      </span>
                    )}
                  </Button>
                  <Button
                    onClick={() => setView('template-demo')}
                    variant="ghost"
                    size="sm"
                    className="text-blue-600 hover:text-blue-700 hover:bg-blue-50"
                  >
                    <svg className="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 16a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zM14 16a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                    </svg>
                    Template Demo
                  </Button>
                  <Button variant="primary" size="sm" className="bg-neutral-900 hover:bg-neutral-800">
                    New Record
                    <kbd className="ml-2 hidden sm:inline-flex items-center px-1.5 rounded text-[10px] font-medium bg-neutral-800 text-neutral-400">
                      âŒ˜N
                    </kbd>
                  </Button>
                </div>
              </div>
            </div>

            {/* Advanced Filter Panel */}
            {isFilterPanelOpen && (
              <div className="mb-6 bg-white border border-neutral-200 rounded-lg p-6">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-sm font-semibold text-neutral-900">Filters</h3>
                  <button
                    onClick={() => {
                      setStatusFilter([]);
                      setTypeFilter([]);
                    }}
                    className="text-xs text-neutral-600 hover:text-neutral-900 transition-colors"
                  >
                    Clear all
                  </button>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  {/* Status Filter */}
                  <div>
                    <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">
                      Status
                    </label>
                    <div className="space-y-2">
                      {['Active', 'Pending', 'Completed', 'In Progress'].map(status => (
                        <label key={status} className="flex items-center cursor-pointer group">
                          <input
                            type="checkbox"
                            checked={statusFilter.includes(status)}
                            onChange={(e) => {
                              if (e.target.checked) {
                                setStatusFilter([...statusFilter, status]);
                              } else {
                                setStatusFilter(statusFilter.filter(s => s !== status));
                              }
                            }}
                            className="rounded border-neutral-300 text-neutral-900 focus:ring-neutral-500"
                          />
                          <span className="ml-2 text-sm text-neutral-700 group-hover:text-neutral-900">
                            {status}
                          </span>
                          <span className="ml-auto text-xs text-neutral-400">
                            ({mockRecords.filter(r => r.status === status).length})
                          </span>
                        </label>
                      ))}
                    </div>
                  </div>

                  {/* Membership Type Filter */}
                  <div>
                    <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">
                      Membership Type
                    </label>
                    <div className="space-y-2">
                      {['Professional', 'Individual', 'Student', 'Emeritus'].map(type => (
                        <label key={type} className="flex items-center cursor-pointer group">
                          <input
                            type="checkbox"
                            checked={typeFilter.includes(type)}
                            onChange={(e) => {
                              if (e.target.checked) {
                                setTypeFilter([...typeFilter, type]);
                              } else {
                                setTypeFilter(typeFilter.filter(t => t !== type));
                              }
                            }}
                            className="rounded border-neutral-300 text-neutral-900 focus:ring-neutral-500"
                          />
                          <span className="ml-2 text-sm text-neutral-700 group-hover:text-neutral-900">
                            {type}
                          </span>
                          <span className="ml-auto text-xs text-neutral-400">
                            ({mockRecords.filter(r => r.membershipType === type).length})
                          </span>
                        </label>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Dropped Cards with dnd-kit */}
            <SortableContext
              items={droppedElements.filter(element => element.context === 'list' && element.visible !== false).map(e => e.id)}
              strategy={verticalListSortingStrategy}
            >
              {(() => {
                const listElements = droppedElements.filter(element => element.context === 'list' && element.visible !== false);
                return (
                  <>
                    {/* Drop zone before first card */}
                    <DroppableGap context="list" recordId={null} insertIndex={0} columnItems={listElements} />

                    {listElements.map((element, idx) => {
                      const isOutlineHover = overOutlineItemId === element.id && activeOutlineItemId;
                      const isContainer = ['container', 'kanban', 'grid', 'canvas'].includes(element.type);

                      return (
                        <React.Fragment key={element.id}>
                          {/* Drop indicator before this item when hovering in Outline - Enhanced for zoom view */}
                          {isOutlineHover && (
                            <div className="relative h-2 -my-2 z-50">
                              <div className="absolute inset-x-0 h-2 bg-gradient-to-r from-blue-400 via-blue-500 to-blue-400 rounded-full shadow-2xl shadow-blue-500/60 animate-pulse"
                                   style={{
                                     boxShadow: '0 0 20px 4px rgba(59, 130, 246, 0.5), 0 0 40px 8px rgba(59, 130, 246, 0.3)'
                                   }}
                              />
                              <div className="absolute inset-x-0 top-1/2 -translate-y-1/2 h-0.5 bg-white/80 rounded-full" />
                            </div>
                          )}
                          {/* Only highlight containers, not regular elements */}
                          <div className={`transition-all duration-200 ${isOutlineHover && isContainer ? 'ring-4 ring-blue-500 ring-offset-4 rounded-lg shadow-2xl shadow-blue-500/30 scale-[1.01]' : ''}`}>
                            <SortableElement
                              element={element}
                              index={idx}
                              context="list"
                              recordId={null}
                            />
                          </div>
                          {/* Drop zone after each card */}
                          <DroppableGap context="list" recordId={null} insertIndex={idx + 1} columnItems={listElements} />
                        </React.Fragment>
                      );
                    })}
                  </>
                );
              })()}
            </SortableContext>

            {/* Records Table - Minimalist Design */}
            <div className="bg-white border border-neutral-200 rounded-lg overflow-hidden">
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead>
                    <tr className="bg-neutral-50 border-b border-neutral-200">
                      <th className="w-12 px-6 py-3">
                        <input
                          type="checkbox"
                          className="rounded border-neutral-300 text-neutral-900 focus:ring-neutral-500"
                          onChange={(e) => {
                            if (e.target.checked) {
                              setSelectedRecords(filteredRecords.map(r => r.id));
                            } else {
                              setSelectedRecords([]);
                            }
                          }}
                        />
                      </th>
                      <th className="text-left py-3 px-4 text-xs font-medium text-neutral-500 uppercase tracking-wider">
                        <button
                          onClick={() => handleSort('status')}
                          className="flex items-center gap-1 hover:text-neutral-900 transition-colors"
                        >
                          Status
                          {sortField === 'status' && (
                            <svg className={`w-3 h-3 ${sortDirection === 'desc' ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M5 15l7-7 7 7" />
                            </svg>
                          )}
                        </button>
                      </th>
                      <th className="text-left py-3 px-4 text-xs font-medium text-neutral-500 uppercase tracking-wider">
                        <button
                          onClick={() => handleSort('recordType')}
                          className="flex items-center gap-1 hover:text-neutral-900 transition-colors"
                        >
                          Record Type
                          {sortField === 'recordType' && (
                            <svg className={`w-3 h-3 ${sortDirection === 'desc' ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M5 15l7-7 7 7" />
                            </svg>
                          )}
                        </button>
                      </th>
                      <th className="text-left py-3 px-4 text-xs font-medium text-neutral-500 uppercase tracking-wider">
                        <button
                          onClick={() => handleSort('title')}
                          className="flex items-center gap-1 hover:text-neutral-900 transition-colors"
                        >
                          Name
                          {sortField === 'title' && (
                            <svg className={`w-3 h-3 ${sortDirection === 'desc' ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M5 15l7-7 7 7" />
                            </svg>
                          )}
                        </button>
                      </th>
                      <th className="text-left py-3 px-4 text-xs font-medium text-neutral-500 uppercase tracking-wider">
                        Summary
                      </th>
                      <th className="text-left py-3 px-4 text-xs font-medium text-neutral-500 uppercase tracking-wider">
                        Tags
                      </th>
                      <th className="text-left py-3 px-4 text-xs font-medium text-neutral-500 uppercase tracking-wider">
                        Activity
                      </th>
                      <th className="text-left py-3 px-4 text-xs font-medium text-neutral-500 uppercase tracking-wider">
                        <button
                          onClick={() => handleSort('lastUpdated')}
                          className="flex items-center gap-1 hover:text-neutral-900 transition-colors"
                        >
                          Last Updated
                          {sortField === 'lastUpdated' && (
                            <svg className={`w-3 h-3 ${sortDirection === 'desc' ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M5 15l7-7 7 7" />
                            </svg>
                          )}
                        </button>
                      </th>
                      <th className="w-20 py-3 px-4"></th>
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-neutral-100">
                    {filteredRecords.map((record) => (
                      <tr
                        key={record.id}
                        className="hover:bg-neutral-50 transition-colors cursor-pointer group"
                        onClick={() => handleViewRecord(record)}
                      >
                        <td className="px-6 py-4" onClick={(e) => e.stopPropagation()}>
                          <input
                            type="checkbox"
                            className="rounded border-neutral-300 text-neutral-900 focus:ring-neutral-500"
                            checked={selectedRecords.includes(record.id)}
                            onChange={() => toggleRecordSelection(record.id)}
                          />
                        </td>
                        <td className="py-4 px-4">
                          <div className="flex items-center">
                            <span className="text-sm text-neutral-900 mr-2">{getStatusIndicator(record.status)}</span>
                            <span className="text-sm text-neutral-600">{record.status}</span>
                          </div>
                        </td>
                        <td className="py-4 px-4">
                          <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-neutral-100 text-neutral-800">
                            {record.recordType}
                          </span>
                        </td>
                        <td className="py-4 px-4">
                          <div className="text-sm font-medium text-neutral-900">{record.title}</div>
                        </td>
                        <td className="py-4 px-4">
                          <div className="text-sm text-neutral-600 max-w-xs truncate">{record.summary}</div>
                        </td>
                        <td className="py-4 px-4">
                          <div className="flex flex-wrap gap-1">
                            {record.tags?.slice(0, 2).map((tag, idx) => (
                              <span key={idx} className="inline-flex items-center px-2 py-0.5 rounded text-xs bg-neutral-50 text-neutral-600 border border-neutral-200">
                                {tag}
                              </span>
                            ))}
                            {record.tags?.length > 2 && (
                              <span className="inline-flex items-center px-2 py-0.5 rounded text-xs text-neutral-500">
                                +{record.tags.length - 2}
                              </span>
                            )}
                          </div>
                        </td>
                        <td className="py-4 px-4">
                          <div className="flex items-center gap-3">
                            {record.peopleCount > 0 && (
                              <div className="flex items-center gap-1 text-neutral-600">
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                                </svg>
                                <span className="text-xs">{record.peopleCount}</span>
                              </div>
                            )}
                            {record.activityCount > 0 && (
                              <div className="flex items-center gap-1 text-neutral-600">
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                                <span className="text-xs">{record.activityCount}</span>
                              </div>
                            )}
                            {record.messageCount > 0 && (
                              <div className="flex items-center gap-1 text-neutral-600">
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                                </svg>
                                <span className="text-xs">{record.messageCount}</span>
                              </div>
                            )}
                          </div>
                        </td>
                        <td className="py-4 px-4">
                          <div className="text-sm text-neutral-500 font-mono tabular-nums">
                            {new Date(record.lastUpdated).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                          </div>
                          <div className="text-xs text-neutral-400 mt-0.5">
                            {new Date(record.lastUpdated).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
                          </div>
                        </td>
                        <td className="py-4 px-4 text-right relative" onClick={(e) => e.stopPropagation()}>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              setOpenActionMenu(openActionMenu === record.id ? null : record.id);
                            }}
                            className="opacity-0 group-hover:opacity-100 transition-opacity text-neutral-400 hover:text-neutral-900 p-1"
                          >
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                            </svg>
                          </button>
                          {openActionMenu === record.id && (
                            <div className="absolute right-0 top-full mt-1 w-48 bg-white border border-neutral-200 rounded-lg shadow-lg z-10 py-1">
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  handleViewRecord(record);
                                  setOpenActionMenu(null);
                                }}
                                className="w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 transition-colors"
                              >
                                View Details
                              </button>
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  window.location.href = `mailto:${record.email}`;
                                  setOpenActionMenu(null);
                                }}
                                className="w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 transition-colors"
                              >
                                Send Email
                              </button>
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  const csvContent = "data:text/csv;charset=utf-8," +
                                    "Name,Email,Company,Type,Status,Join Date\n" +
                                    `"${record.title}","${record.email}","${record.company}","${record.membershipType}","${record.status}","${record.date}"`;
                                  const encodedUri = encodeURI(csvContent);
                                  const link = document.createElement("a");
                                  link.setAttribute("href", encodedUri);
                                  link.setAttribute("download", `${record.title.replace(/\s+/g, '_')}_profile.csv`);
                                  document.body.appendChild(link);
                                  link.click();
                                  document.body.removeChild(link);
                                  setOpenActionMenu(null);
                                }}
                                className="w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 transition-colors"
                              >
                                Export Profile
                              </button>
                              <div className="border-t border-neutral-200 my-1"></div>
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  if (confirm(`Archive ${record.title}?`)) {
                                    console.log('Archiving:', record.id);
                                  }
                                  setOpenActionMenu(null);
                                }}
                                className="w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 transition-colors"
                              >
                                Archive Member
                              </button>
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  if (confirm(`Delete ${record.title}? This cannot be undone.`)) {
                                    console.log('Deleting:', record.id);
                                  }
                                  setOpenActionMenu(null);
                                }}
                                className="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors"
                              >
                                Delete Member
                              </button>
                            </div>
                          )}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              {/* Footer with count */}
              <div className="bg-neutral-50 px-6 py-3 border-t border-neutral-200">
                <div className="flex items-center justify-between">
                  <p className="text-xs text-neutral-500">
                    Showing <span className="font-medium text-neutral-900">{filteredRecords.length}</span> of <span className="font-medium text-neutral-900">{mockRecords.length}</span> members
                  </p>
                  <div className="flex items-center gap-2 text-xs text-neutral-500">
                    <kbd className="px-2 py-0.5 rounded bg-white border border-neutral-200">â†‘</kbd>
                    <kbd className="px-2 py-0.5 rounded bg-white border border-neutral-200">â†“</kbd>
                    <span>to navigate</span>
                    <kbd className="px-2 py-0.5 rounded bg-white border border-neutral-200 ml-2">Enter</kbd>
                    <span>to open</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        ) : (
          <div className="animate-view-fade-in">
            {/* Detail View - 3-Zone Layout System (Simplified 2-Layer Architecture) */}
            {(() => {
              // Layer 1: Get all page elements
              const pageElements = getPageElements(selectedRecord?.id);

              // Layer 2: Render zones directly
              return (
                <>
                  {/* HEADER ZONE */}
                  {renderZone('header', pageElements.header, selectedRecord?.id)}

                  {/* BODY ZONE */}
                  {renderZone('body', pageElements.body, selectedRecord?.id)}

                  {/* FOOTER ZONE */}
                  {renderZone('footer', pageElements.footer, selectedRecord?.id)}
                </>
              );
            })()}

            </div>
        )}

        {/* Edit Panel Slide-out */}
        {isEditPanelOpen && editingCommittee && (
            <div className={`fixed top-0 bottom-0 w-[500px] bg-white shadow-2xl border-l border-neutral-200 z-50 transform transition-all duration-300 ${
              isComponentPanelOpen ? 'right-80' : 'right-0'
            }`}>
              <div className="h-full flex flex-col">
                {/* Header */}
                <div className="border-b border-neutral-200 px-8 py-6">
                  <div className="flex items-center justify-between">
                    <h2 className="text-xl font-semibold text-neutral-900">Edit Committee</h2>
                    <button
                      onClick={() => {
                        setIsEditPanelOpen(false);
                        setEditingCommittee(null);
                      }}
                      className="text-neutral-400 hover:text-neutral-900 transition-colors"
                    >
                      <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                </div>

                {/* Dynamic Form Content */}
                <div
                  className="flex-1 overflow-y-auto px-8 py-6"
                  onDragOver={(e) => {
                    // Fallback dragOver handler for any gaps
                    e.preventDefault();
                    if (draggedFieldType) {
                      e.dataTransfer.dropEffect = 'copy';
                    } else {
                      e.dataTransfer.dropEffect = 'move';
                    }
                  }}
                  onDrop={(e) => {
                    // Fallback drop handler - use the current dropTargetIndex
                    if (dropTargetIndex !== null) {
                      handleDrop(e, dropTargetIndex);
                    }
                  }}
                >
                  <style>{`
                    @keyframes fieldDrop {
                      0% { opacity: 0; transform: scale(0.95) translateY(-8px); }
                      100% { opacity: 1; transform: scale(1) translateY(0); }
                    }
                    .field-drop-animation {
                      animation: fieldDrop 350ms cubic-bezier(0.34, 1.56, 0.64, 1);
                    }
                    .field-shift-animation {
                      transition: all 350ms cubic-bezier(0.32, 0.72, 0, 1);
                    }
                  `}</style>
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                    {formFields.map((field, index) => (
                      <div
                        key={field.id}
                        ref={el => fieldRefs.current[field.id] = el}
                        className={`${
                          justDroppedId === field.id ? 'field-drop-animation' : ''
                        }`}
                      >
                        {/* Invisible drop zone above field - covers the gap */}
                        <div
                          onDragOver={(e) => handleDragOver(e, index)}
                          onDrop={(e) => handleDrop(e, index)}
                          className="h-8 -mb-8"
                        />

                        <div
                          draggable
                          onDragStart={(e) => handleDragStart(e, index)}
                          onDragOver={(e) => handleDragOver(e, index)}
                          onDrop={(e) => handleDrop(e, index)}
                          onDragEnd={handleDragEnd}
                          className={`group relative ${
                            selectedFieldId === field.id ? 'rounded-lg p-4 -mx-4' : ''
                          } ${draggedFieldIndex === index ? 'opacity-50' : ''}`}
                          style={selectedFieldId === field.id ? { boxShadow: 'inset 0 0 0 2px rgb(59 130 246)' } : {}}
                          onClick={() => {
                            if (isComponentPanelOpen) {
                              setSelectedFieldId(field.id);
                              setRightPanelTab('settings');
                            }
                          }}
                        >
                        {/* Drop Indicator Line - Above field */}
                        {dropTargetIndex === index && (draggedFieldIndex !== null || draggedFieldType !== null) && draggedFieldIndex !== index && (
                          <div
                            className="absolute left-0 right-0 pointer-events-none z-50"
                            style={{ top: '-12px', left: '-32px', right: '-32px', width: 'calc(100% + 64px)' }}
                          >
                            <div className="bg-blue-500 rounded-full" style={{ height: '2px', boxShadow: '0 0 8px rgba(59, 130, 246, 0.6)' }} />
                          </div>
                        )}

                        {/* Drag Handle - Visible on hover */}
                        <div className={`absolute top-0 opacity-0 group-hover:opacity-100 transition-opacity cursor-grab active:cursor-grabbing ${
                          selectedFieldId === field.id ? '-left-2 bg-white rounded px-1 py-0.5' : '-left-6'
                        }`}>
                          <svg className="w-4 h-4 text-neutral-400" fill="currentColor" viewBox="0 0 20 20">
                            <circle cx="7" cy="4" r="1.5" />
                            <circle cx="13" cy="4" r="1.5" />
                            <circle cx="7" cy="10" r="1.5" />
                            <circle cx="13" cy="10" r="1.5" />
                            <circle cx="7" cy="16" r="1.5" />
                            <circle cx="13" cy="16" r="1.5" />
                          </svg>
                        </div>

                        <label className="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2">
                          {field.label}
                          {field.required && <span className="text-red-500 ml-1">*</span>}
                        </label>

                        {/* Render field based on type */}
                        {field.type === 'single-line' && (
                          <input
                            type="text"
                            placeholder={field.placeholder}
                            autoFocus={
                              editingCommittee &&
                              ((field.id === 'committee' && editingCommittee.field === 'name') ||
                               (field.id === editingCommittee.field))
                            }
                            className="w-full px-4 py-2.5 border border-neutral-300 rounded-lg text-sm text-neutral-900 focus:outline-none focus:ring-2 focus:ring-neutral-900 focus:border-transparent"
                          />
                        )}

                        {field.type === 'name' && field.subFields && (
                          <div className={field.layout === 'horizontal' ? 'grid grid-cols-2 gap-3' : 'space-y-3'}>
                            {field.subFields.filter(sf => sf.visible).map((subField) => (
                              <div key={subField.id} className={field.layout === 'horizontal' && (subField.id === 'firstName' || subField.id === 'lastName') ? '' : field.layout === 'horizontal' ? 'col-span-2' : ''}>
                                <label className="block text-xs font-medium text-neutral-500 mb-1.5">
                                  {subField.label}
                                </label>
                                {/* Render select for prefix/suffix if predefined is enabled */}
                                {subField.id === 'prefix' && field.usePredefinedPrefix ? (
                                  <select className="w-full px-4 py-2.5 border border-neutral-300 rounded-lg text-sm text-neutral-900 focus:outline-none focus:ring-2 focus:ring-neutral-900 focus:border-transparent bg-white">
                                    <option value="">Select...</option>
                                    {namePrefixOptions.map(opt => (
                                      <option key={opt} value={opt}>{opt}</option>
                                    ))}
                                  </select>
                                ) : subField.id === 'suffix' && field.usePredefinedSuffix ? (
                                  <select className="w-full px-4 py-2.5 border border-neutral-300 rounded-lg text-sm text-neutral-900 focus:outline-none focus:ring-2 focus:ring-neutral-900 focus:border-transparent bg-white">
                                    <option value="">Select...</option>
                                    {nameSuffixOptions.map(opt => (
                                      <option key={opt} value={opt}>{opt}</option>
                                    ))}
                                  </select>
                                ) : (
                                  <input
                                    type="text"
                                    placeholder={subField.placeholder}
                                    className="w-full px-4 py-2.5 border border-neutral-300 rounded-lg text-sm text-neutral-900 focus:outline-none focus:ring-2 focus:ring-neutral-900 focus:border-transparent"
                                  />
                                )}
                              </div>
                            ))}
                          </div>
                        )}

                        {field.type === 'multiline' && (
                          <textarea
                            rows={6}
                            data-field-id={field.id}
                            placeholder={field.placeholder}
                            autoFocus={editingCommittee && field.id === editingCommittee.field}
                            className="w-full px-4 py-2.5 border border-neutral-300 rounded-lg text-sm text-neutral-900 focus:outline-none focus:ring-2 focus:ring-neutral-900 focus:border-transparent resize-none"
                            defaultValue={field.id === 'memo' ? selectedRecord?.committees?.[editingCommittee.committeeIndex]?.memo : ''}
                          />
                        )}

                        {field.type === 'select-single' && (
                          <div className="relative">
                            <button
                              type="button"
                              onClick={() => setOpenDropdownId(openDropdownId === field.id ? null : field.id)}
                              className="w-full px-4 py-2.5 border border-neutral-300 rounded-lg text-sm text-neutral-900 focus:outline-none focus:ring-2 focus:ring-neutral-900 focus:border-transparent bg-white text-left flex items-center justify-between"
                            >
                              <span>
                                {field.id === 'committee'
                                  ? selectedRecord?.committees?.[editingCommittee.committeeIndex]?.name
                                  : field.id === 'position'
                                  ? selectedRecord?.committees?.[editingCommittee.committeeIndex]?.position
                                  : 'Select...'}
                              </span>
                              <svg
                                className={`w-4 h-4 text-neutral-400 transition-transform ${
                                  openDropdownId === field.id ? 'rotate-180' : ''
                                }`}
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                              >
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 9l-7 7-7-7" />
                              </svg>
                            </button>

                            {/* Custom Dropdown Menu */}
                            {openDropdownId === field.id && (
                              <>
                                {/* Backdrop to close dropdown */}
                                <div
                                  className="fixed inset-0 z-10"
                                  onClick={() => setOpenDropdownId(null)}
                                />

                                {/* Dropdown Options */}
                                <div className="absolute z-20 w-full mt-2 bg-white border border-neutral-200 rounded-lg shadow-xl max-h-80 overflow-y-auto">
                                  {field.options?.filter(o => o.trim()).map((option, idx) => {
                                    const currentValue = field.id === 'committee'
                                      ? selectedRecord?.committees?.[editingCommittee.committeeIndex]?.name
                                      : field.id === 'position'
                                      ? selectedRecord?.committees?.[editingCommittee.committeeIndex]?.position
                                      : '';
                                    const isSelected = option === currentValue;

                                    return (
                                      <button
                                        key={idx}
                                        type="button"
                                        onClick={() => {
                                          // Handle selection logic here
                                          setOpenDropdownId(null);
                                        }}
                                        className={`w-full px-4 py-2.5 text-left text-sm transition-colors hover:bg-neutral-50 ${
                                          isSelected ? 'bg-neutral-50 font-medium text-neutral-900' : 'text-neutral-700'
                                        }`}
                                      >
                                        <div className="flex items-center justify-between">
                                          <span>{option}</span>
                                          {isSelected && (
                                            <svg className="w-4 h-4 text-neutral-900" fill="currentColor" viewBox="0 0 20 20">
                                              <path
                                                fillRule="evenodd"
                                                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                                clipRule="evenodd"
                                              />
                                            </svg>
                                          )}
                                        </div>
                                      </button>
                                    );
                                  })}
                                </div>
                              </>
                            )}
                          </div>
                        )}

                        {field.type === 'select-multi' && (
                          <select
                            multiple
                            size={Math.min(field.options?.filter(o => o.trim()).length || 3, 6)}
                            autoFocus={editingCommittee && field.id === editingCommittee.field}
                            className="w-full px-4 py-2.5 border border-neutral-300 rounded-lg text-sm text-neutral-900 focus:outline-none focus:ring-2 focus:ring-neutral-900 focus:border-transparent"
                          >
                            {field.options?.filter(o => o.trim()).map((option, idx) => (
                              <option key={idx} value={option}>{option}</option>
                            ))}
                          </select>
                        )}

                        {field.type === 'date' && (
                          <input
                            type="date"
                            data-field-id={field.id}
                            autoFocus={editingCommittee && field.id === editingCommittee.field}
                            className="w-full px-4 py-2.5 border border-neutral-300 rounded-lg text-sm text-neutral-900 font-mono focus:outline-none focus:ring-2 focus:ring-neutral-900 focus:border-transparent"
                            defaultValue={
                              field.id === 'startDate'
                                ? selectedRecord?.committees?.[editingCommittee.committeeIndex]?.startDate
                                : field.id === 'endDate'
                                ? selectedRecord?.committees?.[editingCommittee.committeeIndex]?.endDate || ''
                                : ''
                            }
                          />
                        )}

                        {field.type === 'date-range' && (
                          <DateRangeField
                            placeholder="Select date range"
                            onChange={(range) => console.log('Date range selected:', range)}
                          />
                        )}

                        {field.type === 'select-record' && (
                          <div className="w-full px-4 py-2.5 border border-neutral-300 rounded-lg text-sm text-neutral-500 bg-neutral-50">
                            Select a record...
                          </div>
                        )}
                        </div>
                      </div>
                    ))}

                    {/* Drop Zone - After last field */}
                    <div
                      onDragOver={(e) => handleDragOver(e, formFields.length)}
                      onDrop={(e) => handleDrop(e, formFields.length)}
                      className="relative min-h-12"
                    >
                      {dropTargetIndex === formFields.length && (draggedFieldIndex !== null || draggedFieldType !== null) && (
                        <div
                          className="absolute left-0 right-0 pointer-events-none z-50"
                          style={{ top: '-12px', left: '-32px', right: '-32px', width: 'calc(100% + 64px)' }}
                        >
                          <div className="bg-blue-500 rounded-full" style={{ height: '2px', boxShadow: '0 0 8px rgba(59, 130, 246, 0.6)' }} />
                        </div>
                      )}
                    </div>
                  </div>
                </div>

                {/* Footer Actions */}
                <div className="border-t border-neutral-200 px-8 py-6">
                  <div className="flex gap-3 justify-end">
                    <button
                      onClick={() => {
                        setIsEditPanelOpen(false);
                        setEditingCommittee(null);
                      }}
                      className="px-4 py-2.5 text-sm text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={() => {
                        // Save logic would go here
                        setIsEditPanelOpen(false);
                        setEditingCommittee(null);
                      }}
                      className="px-4 py-2.5 text-sm font-medium text-white bg-neutral-900 hover:bg-neutral-800 rounded-lg transition-colors"
                    >
                      Save Changes
                    </button>
                  </div>
                </div>
              </div>
            </div>
        )}
        </main>
      </div>
      </div>

      {/* Visualization Detail Panel - Slide out from right */}
      {visualizationPanelOpen && visualizationPanelData && (
        <>
          {/* Backdrop */}
          <div
            className="fixed inset-0 bg-black bg-opacity-30 z-40 transition-opacity"
            onClick={() => setVisualizationPanelOpen(false)}
          />

          {/* Slide-out Panel */}
          <div className="fixed top-0 right-0 bottom-0 w-[600px] bg-white shadow-2xl z-50 overflow-y-auto transform transition-transform duration-300 ease-out">
            {/* Panel Header */}
            <div className="sticky top-0 bg-white border-b border-neutral-200 px-8 py-6 flex items-center justify-between z-10">
              <div>
                <h2 className="text-2xl font-semibold text-neutral-900">{visualizationPanelData.elementDef.name}</h2>
                <p className="text-sm text-neutral-500 mt-1">
                  {visualizationPanelData.element.context === 'list' ? 'Total Events' : 'Your Events'}
                </p>
              </div>
              <button
                onClick={() => setVisualizationPanelOpen(false)}
                className="p-2 hover:bg-neutral-100 rounded-lg transition-colors"
              >
                <svg className="w-6 h-6 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>

            {/* Panel Content - Event List */}
            <div className="px-8 py-6">
              <div className="space-y-4">
                {(visualizationPanelData?.events || []).map((event, idx) => (
                  <div
                    key={idx}
                    className="bg-neutral-50 rounded-lg p-4 hover:bg-neutral-100 transition-colors cursor-pointer border border-neutral-200"
                  >
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <h3 className="font-medium text-neutral-900">{event.title}</h3>
                        <div className="mt-2 space-y-1">
                          <div className="flex items-center gap-2 text-sm text-neutral-600">
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <span>{event.date}</span>
                          </div>
                          {event.location && (
                            <div className="flex items-center gap-2 text-sm text-neutral-600">
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                              </svg>
                              <span>{event.location}</span>
                            </div>
                          )}
                          {visualizationPanelData.element.context === 'list' && event.registrations !== undefined && (
                            <div className="flex items-center gap-2 text-sm text-neutral-600">
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                              </svg>
                              <span>{event.registrations} registered</span>
                            </div>
                          )}
                          {visualizationPanelData.element.context === 'detail' && event.role && (
                            <div className="flex items-center gap-2 text-sm text-neutral-600">
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                              </svg>
                              <span>{event.role}</span>
                            </div>
                          )}
                        </div>
                      </div>
                      <svg className="w-5 h-5 text-neutral-400 flex-shrink-0 ml-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 5l7 7-7 7" />
                      </svg>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </>
      )}
      </div>

      {/* DragOverlay - shows preview of dragged item */}
      <DragOverlay>
        {activeElementId ? (
          (() => {
            // Check if dragging a section
            const isSection = activeElementId.toString().startsWith('section-');
            if (isSection) {
              const sectionId = activeElementId.toString().replace('section-', '');
              const sectionNames = {
                'header': 'Header',
                'bio': 'Biography',
                'contact': 'Contact Information',
                'committees': 'Committee Participation',
                'interests': 'Interests & Expertise',
                'membership': 'Membership',
                'activity': 'Activity Timeline'
              };
              return (
                <div className="bg-white rounded-lg shadow-xl border border-neutral-200 p-4 cursor-grabbing opacity-90">
                  <div className="flex items-center gap-2">
                    <svg className="w-5 h-5 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                    <span className="font-medium text-neutral-900">{sectionNames[sectionId] || sectionId}</span>
                  </div>
                </div>
              );
            }

            // Check if dragging a new card from panel
            const isPanelCard = activeElementId.toString().startsWith('panel-');
            if (isPanelCard) {
              const elementType = activeElementId.toString().replace('panel-', '');
              const elementDef = componentElements.find(e => e.id === elementType);
              return elementDef ? (
                <div className="bg-white rounded-lg shadow-xl border border-neutral-200 p-4 cursor-grabbing opacity-90">
                  <div className="flex items-center gap-2">
                    <svg className="w-5 h-5 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      {getIconSvg(elementDef.icon)}
                    </svg>
                    <span className="font-medium text-neutral-900">{elementDef.name}</span>
                  </div>
                </div>
              ) : null;
            }

            // Dragging existing element - show full element content
            // Search in all zones to find the element
            let record = selectedRecord;

            // Get element from all page elements
            const allElements = getAllPageElements(selectedRecord?.id);
            let element = allElements.find(el => el.id === activeElementId);

            // If not found in zones, check droppedElements
            if (!element) {
              element = droppedElements.find(e => e.id === activeElementId);
            }

            if (!element) return null;

            // Render the full element with appropriate styling
            return (
              <div className="cursor-grabbing opacity-90 pointer-events-none" style={{ maxWidth: '600px' }}>
                {element.type && !element.elementType
                  ? renderElementContent(element, record)
                  : renderElement(element, 0, element.context || 'detail', element.recordId)
                }
              </div>
            );
          })()
        ) : null}
      </DragOverlay>

      {/* Priority 1: Success Feedback - Dynamic Island Style */}
      {successFeedback && (
        <div className="fixed top-4 left-1/2 -translate-x-1/2 z-[200] animate-in slide-in-from-top-2 fade-in duration-300">
          <div className="bg-neutral-900 text-white px-4 py-2 rounded-full shadow-2xl flex items-center gap-2 animate-in zoom-in-95 duration-200">
            <div className="w-5 h-5 bg-green-500 rounded-full flex items-center justify-center animate-in zoom-in-50 duration-300">
              <svg className="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <span className="text-sm font-medium">Element moved</span>
          </div>
        </div>
      )}

      {/* FAB Layers System */}
      <div className="fixed bottom-6 z-[110] transition-all duration-300 ease-in-out" style={{
        left: (() => {
          let leftOffset = 24; // Base offset from edge
          // Add Explorer width if docked
          if (isLayerActive('explorer') && explorerIsDocked) {
            leftOffset += explorerPanelSize.width;
            // Also add sidebar width if it's pinned and open (sidebar stacks next to Explorer)
            if (isSidebarPinned && isSidebarOpen) {
              leftOffset += isSidebarCollapsed ? 64 : 256;
            }
          } else {
            // Add sidebar width ONLY if pinned AND open AND Explorer is NOT docked
            if (isSidebarPinned && isSidebarOpen) {
              leftOffset += isSidebarCollapsed ? 64 : 256;
            }
          }
          return `${leftOffset}px`;
        })()
      }}>
        {/* Main FAB Button (Layers Icon) */}
        <button
          onClick={() => {
            setIsFabExpanded(!isFabExpanded);
            if (!isFabExpanded) {
              setActiveLayers(new Set()); // Clear all layers when collapsing FAB
            }
          }}
          className="flex items-center justify-center"
          style={{
            width: '32px',
            height: '32px',
            minWidth: '32px',
            minHeight: '32px',
            borderRadius: '50%',
            backgroundColor: isFabExpanded ? '#171717' : '#ffffff',
            color: isFabExpanded ? '#ffffff' : '#171717',
            boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',
            overflow: 'hidden',
            flexShrink: 0,
            transition: 'background-color 0.15s ease-in-out, color 0.15s ease-in-out',
          }}
          title="Central Studio"
        >
          {isFabExpanded ? (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          ) : (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
            </svg>
          )}
        </button>

        {/* Vertical Layer Options (Dock, Explorer, Studio) */}
        {FAB_LAYER_OPTIONS.vertical.map((layer, index) => (
          <button
            key={layer.id}
            onClick={() => {
              toggleLayer(layer.id);
            }}
            className={`absolute w-8 h-8 rounded-full shadow-lg flex items-center justify-center group backdrop-blur-sm transition-[background-color,opacity,transform] ${
              isLayerActive(layer.id)
                ? 'bg-neutral-900 opacity-100'
                : 'bg-white/30 hover:bg-white/90 opacity-40 hover:opacity-100'
            }`}
            style={{
              bottom: isFabExpanded ? `${(index + 1) * 56}px` : '10px',
              left: '10px',
              transition: `all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) ${index * 50}ms`,
              opacity: isFabExpanded ? 1 : 0,
              transform: isFabExpanded ? 'scale(1)' : 'scale(0)',
              pointerEvents: isFabExpanded ? 'auto' : 'none',
              padding: '6px',
            }}
            title={layer.name}
          >
            <svg className={`w-4 h-4 ${
              isLayerActive(layer.id) ? 'text-white' : 'text-neutral-900/60'
            }`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d={layer.icon} />
            </svg>
            {/* Tooltip */}
            <div className="absolute left-16 whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none">
              <div className="bg-neutral-900 text-white px-3 py-2 rounded-lg shadow-xl">
                <div className="text-sm font-medium">{layer.name}</div>
                <div className="text-xs text-neutral-300 mt-0.5">{layer.description}</div>
              </div>
            </div>
          </button>
        ))}

        {/* Horizontal Layer Options (Insights, Reports, Timeline) */}
        {FAB_LAYER_OPTIONS.horizontal.map((layer, index) => (
          <button
            key={layer.id}
            onClick={() => {
              toggleLayer(layer.id);
            }}
            className={`absolute w-8 h-8 rounded-full shadow-lg flex items-center justify-center group backdrop-blur-sm transition-[background-color,opacity,transform] ${
              isLayerActive(layer.id)
                ? 'bg-neutral-900 opacity-100'
                : 'bg-white/30 hover:bg-white/90 opacity-40 hover:opacity-100'
            }`}
            style={{
              bottom: '10px',
              left: isFabExpanded ? `${(index + 1) * 56}px` : '10px',
              transition: `all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) ${(index + 3) * 50}ms`,
              opacity: isFabExpanded ? 1 : 0,
              transform: isFabExpanded ? 'scale(1)' : 'scale(0)',
              pointerEvents: isFabExpanded ? 'auto' : 'none',
              padding: '6px',
            }}
            title={layer.name}
          >
            <svg className={`w-4 h-4 ${
              isLayerActive(layer.id) ? 'text-white' : 'text-neutral-900/60'
            }`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d={layer.icon} />
            </svg>
            {/* Tooltip */}
            <div className="absolute bottom-16 left-1/2 -translate-x-1/2 whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none">
              <div className="bg-neutral-900 text-white px-3 py-2 rounded-lg shadow-xl">
                <div className="text-sm font-medium">{layer.name}</div>
                <div className="text-xs text-neutral-300 mt-0.5">{layer.description}</div>
              </div>
            </div>
          </button>
        ))}
      </div>

      {/* Central Studio Panel */}
      {isLayerActive('studio') && (
        <div className="fixed top-0 left-0 right-0 bg-neutral-50 border-b border-neutral-300 z-[100] animate-slide-down">
          <div className="h-12 px-6 flex items-center justify-between gap-4">
            {/* Left Section: Workspace Views & Interaction Modes */}
            <div className="flex items-center gap-4">
              {/* Workspace Views - Collapsed to single dropdown */}
              <div className="relative">
                <button
                  onClick={() => setIsWorkspaceViewDropdownOpen(!isWorkspaceViewDropdownOpen)}
                  className={`px-2.5 py-1.5 rounded-lg text-xs font-medium transition-all flex items-center gap-1.5 ${
                    isWorkspaceViewDropdownOpen
                      ? 'bg-neutral-900 text-white'
                      : 'text-neutral-700 hover:bg-white hover:shadow-sm'
                  }`}
                >
                  <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d={WORKSPACE_VIEWS.find(v => v.id === studioWorkspaceView)?.icon} />
                  </svg>
                  <span>{WORKSPACE_VIEWS.find(v => v.id === studioWorkspaceView)?.name || 'View'}</span>
                  <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 9l-7 7-7-7" />
                  </svg>
                </button>

                {isWorkspaceViewDropdownOpen && (
                  <div className="absolute top-full mt-2 left-0 bg-white rounded-lg shadow-2xl border border-neutral-200 p-2 min-w-[280px] z-[110]">
                    {WORKSPACE_VIEWS.map((view) => (
                      <button
                        key={view.id}
                        onClick={() => {
                          setStudioWorkspaceView(view.id);
                          setIsWorkspaceViewDropdownOpen(false);
                        }}
                        className={`w-full px-3 py-2 rounded-lg transition-all flex items-start gap-3 text-left ${
                          studioWorkspaceView === view.id
                            ? 'bg-neutral-100'
                            : 'hover:bg-neutral-50'
                        }`}
                      >
                        <svg className="w-5 h-5 text-neutral-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d={view.icon} />
                        </svg>
                        <div>
                          <div className="text-sm font-medium text-neutral-900">{view.name}</div>
                          <div className="text-xs text-neutral-500 mt-0.5">{view.description}</div>
                        </div>
                      </button>
                    ))}
                  </div>
                )}
              </div>

              {/* Divider */}
              <div className="h-6 w-px bg-neutral-300"></div>

              {/* Interaction Mode */}
              <div className="relative">
                <button
                  onClick={() => setIsInteractionModeDropdownOpen(!isInteractionModeDropdownOpen)}
                  className={`px-2.5 py-1.5 rounded-lg text-xs font-medium transition-all flex items-center gap-1.5 ${
                    isInteractionModeDropdownOpen
                      ? 'bg-neutral-900 text-white'
                      : 'text-neutral-700 hover:bg-white hover:shadow-sm'
                  }`}
                >
                  <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d={INTERACTION_MODES.find(m => m.id === studioInteractionMode)?.icon} />
                  </svg>
                  <span>{INTERACTION_MODES.find(m => m.id === studioInteractionMode)?.name}</span>
                  <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 9l-7 7-7-7" />
                  </svg>
                </button>

                {isInteractionModeDropdownOpen && (
                  <div className="absolute top-full mt-2 left-0 bg-white rounded-lg shadow-2xl border border-neutral-200 p-2 min-w-[280px] z-[110]">
                    {INTERACTION_MODES.map((mode) => (
                      <button
                        key={mode.id}
                        onClick={() => {
                          setStudioInteractionMode(mode.id);
                          setIsInteractionModeDropdownOpen(false);
                        }}
                        className={`w-full px-3 py-2 rounded-lg transition-all flex items-start gap-3 text-left ${
                          studioInteractionMode === mode.id
                            ? 'bg-neutral-100'
                            : 'hover:bg-neutral-50'
                        }`}
                      >
                        <svg className="w-5 h-5 text-neutral-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d={mode.icon} />
                        </svg>
                        <div>
                          <div className="text-sm font-medium text-neutral-900">{mode.name}</div>
                          <div className="text-xs text-neutral-500 mt-0.5">{mode.description}</div>
                        </div>
                      </button>
                    ))}
                  </div>
                )}
              </div>
            </div>

            {/* Middle Section: Context Bar */}
            <div className="flex-1 flex items-center justify-center overflow-hidden">
              {!isContextBarExpanded ? (
                <button
                  onClick={() => setIsContextBarExpanded(true)}
                  className="text-xs text-neutral-600 hover:text-neutral-900 transition-colors underline decoration-dotted underline-offset-4"
                >
                  View...
                </button>
              ) : (
                <div className="text-xs text-neutral-600 flex items-center gap-2 animate-fade-in">
                  <span>View</span>
                  <select className="px-2 py-0.5 border border-neutral-200 rounded text-neutral-900 bg-white text-xs">
                    <option>en-US</option>
                    <option>es-ES</option>
                    <option>fr-FR</option>
                  </select>
                  <span>as</span>
                  <div className="relative">
                    <button
                      onClick={() => setIsUserPersonaDropdownOpen(!isUserPersonaDropdownOpen)}
                      className="px-2 py-0.5 border border-neutral-200 rounded text-neutral-900 bg-white text-xs font-medium hover:bg-neutral-50 transition-colors flex items-center gap-1"
                    >
                      <span>{USER_PERSONAS.find(p => p.id === studioUserPersona)?.name || '@johndoe'}</span>
                      <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 9l-7 7-7-7" />
                      </svg>
                    </button>
                    {isUserPersonaDropdownOpen && (
                      <div className="absolute top-full mt-1 left-0 bg-white rounded-lg shadow-xl border border-neutral-200 p-1 min-w-[140px] z-[110]">
                        {USER_PERSONAS.map((persona) => (
                          <button
                            key={persona.id}
                            onClick={() => {
                              setStudioUserPersona(persona.id);
                              setIsUserPersonaDropdownOpen(false);
                            }}
                            className={`w-full px-2 py-1.5 rounded text-left transition-all ${
                              studioUserPersona === persona.id
                                ? 'bg-neutral-100'
                                : 'hover:bg-neutral-50'
                            }`}
                          >
                            <div className="text-xs font-medium text-neutral-900">{persona.name}</div>
                            <div className="text-xs text-neutral-500">{persona.role}</div>
                          </button>
                        ))}
                      </div>
                    )}
                  </div>
                  <span>on</span>
                  <input type="date" value={new Date().toISOString().split('T')[0]} className="px-2 py-0.5 border border-neutral-200 rounded text-neutral-900 bg-white text-xs" />
                  <span>with</span>
                  <div className="flex items-center gap-1 px-2 py-0.5 border border-neutral-200 rounded bg-white">
                    <button
                      onClick={() => setStudioDeviceView('desktop')}
                      className={`p-1 rounded transition-all ${
                        studioDeviceView === 'desktop'
                          ? 'bg-neutral-900 text-white'
                          : 'text-neutral-600 hover:bg-neutral-100'
                      }`}
                      title="Desktop"
                    >
                      <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                      </svg>
                    </button>
                    <button
                      onClick={() => setStudioDeviceView('tablet')}
                      className={`p-1 rounded transition-all ${
                        studioDeviceView === 'tablet'
                          ? 'bg-neutral-900 text-white'
                          : 'text-neutral-600 hover:bg-neutral-100'
                      }`}
                      title="Tablet"
                    >
                      <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 18h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                      </svg>
                    </button>
                    <button
                      onClick={() => setStudioDeviceView('mobile')}
                      className={`p-1 rounded transition-all ${
                        studioDeviceView === 'mobile'
                          ? 'bg-neutral-900 text-white'
                          : 'text-neutral-600 hover:bg-neutral-100'
                      }`}
                      title="Mobile"
                    >
                      <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
                      </svg>
                    </button>
                  </div>
                  <button
                    onClick={() => setIsContextBarExpanded(false)}
                    className="ml-1 text-neutral-400 hover:text-neutral-900 transition-colors"
                    title="Collapse"
                  >
                    <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
              )}
            </div>

            {/* Right Section: Controls */}
            <div className="flex items-center gap-2">
              {/* Undo */}
              <button
                className="p-1.5 rounded-lg text-neutral-700 hover:bg-neutral-100 transition-all"
                title="Undo"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                </svg>
              </button>

              {/* Redo */}
              <button
                className="p-1.5 rounded-lg text-neutral-700 hover:bg-neutral-100 transition-all"
                title="Redo"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M21 10h-10a8 8 0 00-8 8v2m18-10l-6 6m6-6l-6-6" />
                </svg>
              </button>

              {/* Divider */}
              <div className="h-6 w-px bg-neutral-200"></div>

              {/* Status Indicator */}
              <div className="flex items-center gap-1.5">
                <div className="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                <span className="text-xs text-neutral-600">Saved</span>
              </div>

              {/* Publish Button */}
              <button className="px-3 py-1.5 bg-neutral-900 text-white rounded-lg text-xs font-medium hover:bg-neutral-800 transition-all flex items-center gap-1.5">
                <span>Publish</span>
                <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 9l-7 7-7-7" />
                </svg>
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Explorer Panel - Docked on Left */}
      {isLayerActive('explorer') && (
        <div
          ref={explorerPanelRef}
          className={`fixed ${
            explorerIsDocked ? 'z-[120]' : 'z-[100]'
          } ${
            explorerIsDocked
              ? 'rounded-r-2xl border-r border-t border-b'
              : 'rounded-2xl shadow-lg'
          } ${explorerPanelMinimized ? 'h-14' : ''} animate-slide-in-left panel-transition panel-backdrop-transition`}
          style={{
            ...(explorerIsDocked
              ? {
                  left: '0',
                  top: '0', // Full height from top
                  bottom: '0',
                  width: `${explorerPanelSize.width}px`,
                  height: explorerPanelMinimized ? 'auto' : 'auto',
                }
              : explorerPanelSnapped === 'left'
              ? {
                  left: '20px',
                  top: '76px',
                  bottom: explorerPanelMinimized ? 'auto' : '20px',
                  width: `${explorerPanelSize.width}px`,
                  height: explorerPanelMinimized ? 'auto' : 'auto',
                }
              : explorerPanelSnapped === 'right'
              ? {
                  right: '20px',
                  top: '76px',
                  bottom: explorerPanelMinimized ? 'auto' : '20px',
                  width: `${explorerPanelSize.width}px`,
                  height: explorerPanelMinimized ? 'auto' : 'auto',
                }
              : explorerPanelSnapped === 'top'
              ? {
                  left: '20px',
                  right: '20px',
                  top: '76px',
                  width: 'auto',
                  height: explorerPanelMinimized ? 'auto' : `${explorerPanelSize.height}px`,
                }
              : explorerPanelSnapped === 'bottom'
              ? {
                  left: '20px',
                  right: '20px',
                  bottom: '20px',
                  width: 'auto',
                  height: explorerPanelMinimized ? 'auto' : `${explorerPanelSize.height}px`,
                }
              : {
                  left: `${explorerPanelPosition.x}px`,
                  top: `${explorerPanelPosition.y}px`,
                  width: `${explorerPanelSize.width}px`,
                  height: explorerPanelMinimized ? 'auto' : `${explorerPanelSize.height}px`,
                }),
            backgroundColor: isExplorerPanelFocused ? 'rgba(255, 255, 255, 0.95)' : 'rgba(255, 255, 255, 0.55)',
            backdropFilter: 'blur(20px)',
            WebkitBackdropFilter: 'blur(20px)',
            border: explorerIsDocked ? '1px solid rgba(0, 0, 0, 0.1)' : '1px solid rgba(0, 0, 0, 0.1)',
            borderLeft: explorerIsDocked ? 'none' : undefined,
            transition: 'background-color 0.2s ease',
          }}
          onMouseEnter={() => setIsExplorerPanelFocused(true)}
          onMouseLeave={() => setIsExplorerPanelFocused(false)}
        >
          {/* Header */}
          <div
            ref={explorerDragHandleRef}
            className={`h-14 px-4 flex items-center justify-between border-b border-neutral-200/50 ${
              !explorerIsDocked && !explorerPanelSnapped ? 'cursor-move' : ''
            }`}
            onMouseDown={(e) => {
              if (!explorerIsDocked && !explorerPanelSnapped) {
                const startX = e.clientX - explorerPanelPosition.x;
                const startY = e.clientY - explorerPanelPosition.y;

                const handleMouseMove = (moveEvent) => {
                  const newX = moveEvent.clientX - startX;
                  const newY = moveEvent.clientY - startY;
                  setExplorerPanelPosition({ x: newX, y: newY });
                };

                const handleMouseUp = () => {
                  document.removeEventListener('mousemove', handleMouseMove);
                  document.removeEventListener('mouseup', handleMouseUp);
                };

                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
              }
            }}
          >
            <div className="flex items-center gap-2">
              <h3 className="text-sm font-semibold text-neutral-900">Explorer</h3>
            </div>

            <div className="flex items-center gap-1">
              {/* Pop-out Icon */}
              <button
                onClick={() => {
                  setExplorerIsDocked(!explorerIsDocked);
                  if (explorerIsDocked) {
                    // When popping out, position near where it was
                    setExplorerPanelPosition({ x: 20, y: 76 });
                    setExplorerPanelSnapped(null);
                  }
                }}
                className="p-1.5 text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100/80 rounded transition-colors"
                title={explorerIsDocked ? 'Pop out' : 'Dock'}
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  {explorerIsDocked ? (
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                  ) : (
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                  )}
                </svg>
              </button>

              {/* Close */}
              <button
                onClick={() => toggleLayer('explorer')}
                className="p-1.5 text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100/80 rounded transition-colors"
                title="Close (âŒ˜+E / Ctrl+E)"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>

              {/* Settings (Vertical Ellipse) */}
              <div className="relative">
                <button
                  onClick={() => setIsExplorerSettingsMenuOpen(!isExplorerSettingsMenuOpen)}
                  className="p-1.5 text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100/80 rounded transition-colors"
                  title="Settings"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                  </svg>
                </button>

                {/* Settings Menu */}
                {isExplorerSettingsMenuOpen && (
                  <div className="absolute top-full right-0 mt-1 bg-white/95 backdrop-blur-lg rounded-lg shadow-xl border border-neutral-200/50 py-1 min-w-[150px] z-10">
                    <button
                      onClick={() => {
                        setExplorerPanelSnapped('left');
                        setExplorerIsDocked(false);
                        setIsExplorerSettingsMenuOpen(false);
                      }}
                      className={`w-full px-3 py-1.5 text-left text-xs transition-colors ${
                        !explorerIsDocked && explorerPanelSnapped === 'left' ? 'bg-neutral-100 font-medium' : 'hover:bg-neutral-50'
                      }`}
                    >
                      Snap Left
                    </button>
                    <button
                      onClick={() => {
                        setExplorerPanelSnapped('right');
                        setExplorerIsDocked(false);
                        setIsExplorerSettingsMenuOpen(false);
                      }}
                      className={`w-full px-3 py-1.5 text-left text-xs transition-colors ${
                        !explorerIsDocked && explorerPanelSnapped === 'right' ? 'bg-neutral-100 font-medium' : 'hover:bg-neutral-50'
                      }`}
                    >
                      Snap Right
                    </button>
                    <button
                      onClick={() => {
                        setExplorerPanelSnapped('top');
                        setExplorerIsDocked(false);
                        setIsExplorerSettingsMenuOpen(false);
                      }}
                      className={`w-full px-3 py-1.5 text-left text-xs transition-colors ${
                        !explorerIsDocked && explorerPanelSnapped === 'top' ? 'bg-neutral-100 font-medium' : 'hover:bg-neutral-50'
                      }`}
                    >
                      Snap Top
                    </button>
                    <button
                      onClick={() => {
                        setExplorerPanelSnapped('bottom');
                        setExplorerIsDocked(false);
                        setIsExplorerSettingsMenuOpen(false);
                      }}
                      className={`w-full px-3 py-1.5 text-left text-xs transition-colors ${
                        !explorerIsDocked && explorerPanelSnapped === 'bottom' ? 'bg-neutral-100 font-medium' : 'hover:bg-neutral-50'
                      }`}
                    >
                      Snap Bottom
                    </button>
                    <div className="h-px bg-neutral-200 my-1" />
                    <button
                      onClick={() => {
                        // Tile with Other Panels logic would go here
                        setIsExplorerSettingsMenuOpen(false);
                      }}
                      className="w-full px-3 py-1.5 text-left text-xs hover:bg-neutral-50"
                    >
                      Tile with Other Panels
                    </button>
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* Panel Content */}
          {!explorerPanelMinimized && (
            <div className="flex flex-col h-[calc(100%-3.5rem)]">
              {/* Tab Navigation with Drag Handles and Reordering */}
              <div className="flex justify-around border-b border-neutral-200/50 px-4 pt-3">
                {explorerTabOrder.map((tabId, index) => {
                  const tabConfig = {
                    pages: { label: 'Pages', badge: null },
                    outline: {
                      label: 'Outline',
                      badge: (() => {
                        const count = view === 'detail' && selectedRecord
                          ? getAllDetailElements(selectedRecord.id).length
                          : droppedElements.filter(el => el.context === view).length;
                        return count > 0 ? count : null;
                      })()
                    },
                    list: { label: 'List', badge: null }
                  };

                  const config = tabConfig[tabId];
                  if (!config) return null;

                  return (
                    <React.Fragment key={tabId}>
                      {/* Drop zone for reordering */}
                      {draggedTab && draggedTab !== tabId && (
                        <div
                          className={`w-2 transition-all ${
                            dragOverTab === `before-${tabId}` ? 'bg-blue-400 w-1' : ''
                          }`}
                          onDragOver={(e) => {
                            e.preventDefault();
                            setDragOverTab(`before-${tabId}`);
                          }}
                          onDragLeave={() => setDragOverTab(null)}
                          onDrop={(e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            const draggedTabId = e.dataTransfer.getData('text/plain');
                            if (draggedTabId && draggedTabId !== tabId) {
                              const newOrder = [...explorerTabOrder];
                              const draggedIndex = newOrder.indexOf(draggedTabId);
                              const targetIndex = newOrder.indexOf(tabId);
                              newOrder.splice(draggedIndex, 1);
                              newOrder.splice(targetIndex, 0, draggedTabId);
                              setExplorerTabOrder(newOrder);
                            }
                            setDraggedTab(null);
                            setDragOverTab(null);
                          }}
                        />
                      )}

                      {/* Tab */}
                      <div
                        className="relative group"
                        onMouseEnter={() => setHoveredTab(tabId)}
                        onMouseLeave={() => setHoveredTab(null)}
                      >
                        <button
                          onClick={() => setExplorerActiveTab(tabId)}
                          draggable={hoveredTab === tabId && (isLayerActive('studio') || isComponentPanelOpen)}
                          onDragStart={(e) => {
                            if (hoveredTab === tabId && (isLayerActive('studio') || isComponentPanelOpen)) {
                              setDraggedTab(tabId);
                              e.dataTransfer.effectAllowed = 'move';
                              e.dataTransfer.setData('text/plain', tabId);
                            }
                          }}
                          onDragEnd={() => {
                            setDraggedTab(null);
                            setDragOverTab(null);
                            setIsQuickAccessDropTarget(false);
                          }}
                          className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors flex items-center gap-1 ${
                            explorerActiveTab === tabId
                              ? 'border-neutral-900 text-neutral-900'
                              : 'border-transparent text-neutral-500 hover:text-neutral-700'
                          } ${draggedTab === tabId ? 'opacity-50' : ''}`}
                        >
                          {hoveredTab === tabId && (isLayerActive('studio') || isComponentPanelOpen) && (
                            <svg className="w-3.5 h-3.5 text-neutral-400 cursor-grab" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 8h16M4 16h16" />
                            </svg>
                          )}
                          {config.label}
                          {config.badge && (
                            <span className="ml-1.5 px-1.5 py-0.5 text-xs bg-neutral-100 text-neutral-600 rounded">
                              {config.badge}
                            </span>
                          )}
                        </button>
                      </div>
                    </React.Fragment>
                  );
                })}
              </div>

              {/* Search Filter */}
              {explorerActiveTab !== 'pages' && (
                <div className="px-4 pt-4 pb-3">
                  <div className="relative">
                    <svg
                      className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-400"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={1}
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                      />
                    </svg>
                    <input
                      type="text"
                      value={explorerSearchFilter}
                      onChange={(e) => setExplorerSearchFilter(e.target.value)}
                      placeholder={explorerActiveTab === 'outline' ? 'Search elements...' : 'Search list...'}
                      className="w-full pl-9 pr-3 py-2 text-sm bg-white/80 border border-neutral-200/50 rounded-lg focus:outline-none focus:ring-2 focus:ring-neutral-900/20 focus:border-neutral-900/20 transition-all"
                    />
                  </div>
                  {/* Hidden elements indicator */}
                  {explorerActiveTab === 'outline' && (() => {
                    const currentElements = view === 'detail' && selectedRecord
                      ? getAllDetailElements(selectedRecord.id)
                      : droppedElements.filter(el => el.context === view);

                    const hiddenCount = currentElements.filter(item => {
                      if (item.type === 'card') {
                        const elementData = droppedElements.find(e => e.id === item.id);
                        return elementData?.visible === false;
                      }
                      return item.visible === false;
                    }).length;

                    return hiddenCount > 0 ? (
                      <div className="mt-2 flex items-center gap-2 text-xs text-neutral-500">
                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                        </svg>
                        <span>
                          {hiddenCount} hidden element{hiddenCount === 1 ? '' : 's'}
                        </span>
                      </div>
                    ) : null;
                  })()}
                </div>
              )}

              {/* Main Content Area - Adjust for Quick Access */}
              <div className={`flex-1 overflow-y-auto px-4 ${explorerActiveTab === 'pages' ? 'pt-4' : ''} pb-4`} style={{
                height: `calc(100% - ${isQuickAccessCollapsed ? 40 : quickAccessHeight}px)`
              }}>
                {explorerActiveTab === 'pages' ? (
                  <div className="space-y-2">
                    {/* Pages Search & Add */}
                    <div className="mb-4">
                      <div className="relative flex items-center gap-2">
                        <div className="relative flex-1">
                          <svg
                            className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-400"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={1}
                              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                            />
                          </svg>
                          <input
                            type="text"
                            value={explorerPagesSearch}
                            onChange={(e) => setExplorerPagesSearch(e.target.value)}
                            placeholder="Search pages..."
                            className="w-full pl-9 pr-3 py-2 text-sm bg-white/80 border border-neutral-200/50 rounded-lg focus:outline-none focus:ring-2 focus:ring-neutral-900/20 focus:border-neutral-900/20 transition-all"
                          />
                        </div>
                        {/* Canvas menu dropdown button */}
                        <div className="relative">
                          <button
                            className="p-2 text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100/80 rounded-lg transition-colors"
                            title="New Design Canvas"
                            onClick={() => setCanvasMenuOpen(!canvasMenuOpen)}
                          >
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zM14 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                            </svg>
                          </button>

                          {/* Canvas submenu */}
                          {canvasMenuOpen && (
                            <>
                              {/* Backdrop to close menu when clicking outside */}
                              <div
                                className="fixed inset-0 z-40"
                                onClick={() => setCanvasMenuOpen(false)}
                              />

                              <div className="absolute right-0 top-full mt-2 w-56 bg-white rounded-lg shadow-lg border border-neutral-200 py-1 z-50">
                                <button
                                  onClick={() => {
                                    setView('canvas');
                                    setCanvasType('empty');
                                    setCanvasMenuOpen(false);
                                  }}
                                  className="w-full text-left px-4 py-2.5 hover:bg-neutral-50 transition-colors"
                                >
                                  <div className="flex items-center gap-3">
                                    <svg className="w-5 h-5 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                    <div>
                                      <div className="text-sm font-medium text-neutral-900">Empty Canvas</div>
                                      <div className="text-xs text-neutral-500">Start from scratch</div>
                                    </div>
                                  </div>
                                </button>
                                <button
                                  onClick={() => {
                                    setView('canvas');
                                    setCanvasType('blueprint');
                                    setCanvasMenuOpen(false);
                                  }}
                                  className="w-full text-left px-4 py-2.5 hover:bg-neutral-50 transition-colors"
                                >
                                  <div className="flex items-center gap-3">
                                    <svg className="w-5 h-5 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    <div>
                                      <div className="text-sm font-medium text-neutral-900">Blueprint Canvas</div>
                                      <div className="text-xs text-neutral-500">Auto-generate from CSV</div>
                                    </div>
                                  </div>
                                </button>
                              </div>
                            </>
                          )}
                        </div>

                        {/* Page Creation Buttons */}
                        <div className="flex items-center gap-2">
                          {/* Primary: Quick Create - Instant blank database page */}
                          <button
                            className="p-2 text-neutral-700 bg-white hover:bg-neutral-50 border border-neutral-300 rounded-lg transition-colors"
                            title="Create new database page"
                            onClick={handleQuickCreatePage}
                          >
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                            </svg>
                          </button>

                          {/* Secondary: Template Gallery */}
                          <button
                            className="p-2 text-neutral-700 bg-white hover:bg-neutral-50 border border-neutral-300 rounded-lg transition-colors"
                            title="Browse templates"
                            onClick={() => setShowPageTemplateGallery(true)}
                          >
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-3zM14 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1h-4a1 1 0 01-1-1v-3z" />
                            </svg>
                          </button>
                        </div>
                      </div>
                    </div>

                    {/* Pages List */}
                    <div className="text-xs font-semibold text-neutral-600 uppercase tracking-wider mb-2">All Pages</div>
                    {(() => {
                      const defaultPages = [
                        { id: 'list', name: 'List View', icon: 'M4 6h16M4 10h16M4 14h16M4 18h16', isDefault: true },
                        { id: 'detail', name: 'Detail View', icon: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z', isDefault: true },
                        { id: 'canvas', name: 'Canvas View', icon: 'M4 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zM14 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z', isDefault: true },
                        { id: 'kanban', name: 'Kanban View', icon: 'M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2', isDefault: true },
                        { id: 'calendar', name: 'Calendar View', icon: 'M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z', isDefault: true },
                        { id: 'gallery', name: 'Gallery View', icon: 'M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z', isDefault: true },
                      ];

                      const allPages = [...defaultPages, ...customPages];

                      return allPages.filter(page => {
                        if (!explorerPagesSearch) return true;
                        return page.name.toLowerCase().includes(explorerPagesSearch.toLowerCase());
                      }).map((page, index) => (
                        <React.Fragment key={page.id}>
                          {/* Drop indicator line */}
                          {dropTargetPageId === page.id && draggedPageId && (
                            <div className="h-0.5 bg-blue-500 mx-3 my-1 rounded-full" />
                          )}

                          <div
                            draggable={page.isCustom}
                            onDragStart={(e) => {
                              if (page.isCustom) {
                                setDraggedPageId(page.id);
                                e.dataTransfer.effectAllowed = 'move';
                              }
                            }}
                            onDragEnd={() => {
                              setDraggedPageId(null);
                              setDropTargetPageId(null);
                            }}
                            onDragOver={(e) => {
                              if (draggedPageId && draggedPageId !== page.id) {
                                e.preventDefault();
                                setDropTargetPageId(page.id);
                              }
                            }}
                            onDragLeave={() => {
                              setDropTargetPageId(null);
                            }}
                            onDrop={(e) => {
                              e.preventDefault();
                              if (draggedPageId && draggedPageId !== page.id) {
                                const draggedIndex = customPages.findIndex(p => p.id === draggedPageId);
                                const targetIndex = customPages.findIndex(p => p.id === page.id);

                                if (draggedIndex !== -1 && targetIndex !== -1) {
                                  const newPages = [...customPages];
                                  const [draggedPage] = newPages.splice(draggedIndex, 1);
                                  newPages.splice(targetIndex, 0, draggedPage);
                                  setCustomPages(newPages);
                                }
                              }
                              setDropTargetPageId(null);
                              setDraggedPageId(null);
                            }}
                            className={`flex items-center gap-2 py-2.5 rounded-lg cursor-pointer transition-all ${
                              view === page.id
                                ? 'bg-neutral-100 text-neutral-900'
                                : 'hover:bg-white/60 text-neutral-700'
                            } ${draggedPageId === page.id ? 'opacity-50' : ''} ${
                              page.isCustom ? 'pl-1 pr-3' : 'px-3'
                            }`}
                            onClick={() => {
                              if (!editingPageId) {
                                if (page.id === 'list' || page.id === 'detail' || page.id === 'canvas') {
                                  setView(page.id);
                                  setActiveCustomPageId(null);
                                } else if (page.isCustom) {
                                  // Custom database page
                                  setView('custom-page');
                                  setActiveCustomPageId(page.id);
                                }
                              }
                            }}
                          >
                            {/* Drag handle for custom pages */}
                            {page.isCustom && (
                              <svg className="w-4 h-4 text-neutral-400 cursor-grab active:cursor-grabbing flex-shrink-0 -ml-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 8h16M4 16h16" />
                              </svg>
                            )}

                            <svg className="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d={page.icon} />
                            </svg>

                            <div className="flex-1 min-w-0">
                              {editingPageId === page.id ? (
                                <input
                                  type="text"
                                  defaultValue={page.name}
                                  autoFocus
                                  onFocus={(e) => e.target.select()}
                                  onBlur={(e) => {
                                    const newName = e.target.value.trim() || page.name;
                                    setCustomPages(customPages.map(p =>
                                      p.id === page.id ? { ...p, name: newName } : p
                                    ));
                                    setEditingPageId(null);
                                  }}
                                  onKeyDown={(e) => {
                                    if (e.key === 'Enter') {
                                      e.target.blur();
                                    } else if (e.key === 'Escape') {
                                      setEditingPageId(null);
                                    }
                                  }}
                                  className="w-full text-sm font-medium bg-white border border-blue-500 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  onClick={(e) => e.stopPropagation()}
                                />
                              ) : (
                                <div className="text-sm font-medium truncate">{page.name}</div>
                              )}
                            </div>

                            {view === page.id && !editingPageId && (
                              <svg className="w-4 h-4 text-neutral-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                              </svg>
                            )}
                          </div>
                        </React.Fragment>
                      ));
                    })()}
                  </div>
                ) : explorerActiveTab === 'outline' ? (
                  <div className="space-y-1">
                    {/* Page Elements Outline */}
                    {(() => {
                      // Special handling for canvas view
                      if (view === 'canvas') {
                        // Helper function to get icon path for shape type
                        const getShapeIcon = (type) => {
                          const icons = {
                            'rectangle': 'M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z',
                            'circle': 'M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z',
                            'diamond': 'M12 2L2 12l10 10 10-10L12 2z',
                            'arrow': 'M13 7h8m0 0v8m0-8l-8 8-4-4-6 6',
                            'line': 'M5 12h14',
                            'section': 'M4 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1h-4a1 1 0 01-1-1V5z',
                            'text': 'M4 6h16M4 12h16M4 18h7',
                            'drawing': 'M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z',
                            'signature': 'M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z'
                          };
                          return icons[type] || icons['rectangle'];
                        };

                        if (canvasShapes.length === 0) {
                          return (
                            <div className="text-center py-12 px-4">
                              <svg className="w-12 h-12 mx-auto mb-3 text-neutral-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zM14 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                              </svg>
                              <p className="text-sm text-neutral-500 font-medium mb-1">No Canvas Elements</p>
                              <p className="text-xs text-neutral-400">Add shapes to the canvas to see them here</p>
                            </div>
                          );
                        }

                        // Filter shapes by search
                        const filteredShapes = canvasShapes.filter(shape => {
                          if (!explorerSearchFilter) return true;
                          const searchLower = explorerSearchFilter.toLowerCase();
                          return shape.type?.toLowerCase().includes(searchLower) ||
                                 shape.id?.toLowerCase().includes(searchLower);
                        });

                        return (
                          <div className="space-y-1 px-2 py-2">
                            {filteredShapes.map((shape, index) => (
                              <div
                                key={shape.id}
                                className="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-neutral-100 transition-colors cursor-pointer"
                              >
                                <svg className="w-4 h-4 text-neutral-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d={getShapeIcon(shape.type)} />
                                </svg>
                                <span className="text-xs text-neutral-700 flex-1 truncate">
                                  {shape.type.charAt(0).toUpperCase() + shape.type.slice(1)} {filteredShapes.filter(s => s.type === shape.type).indexOf(shape) + 1}
                                </span>
                                <span className="text-xs text-neutral-400">
                                  {Math.round(shape.width)}Ã—{Math.round(shape.height)}
                                </span>
                              </div>
                            ))}
                          </div>
                        );
                      }

                      // Get elements based on current view
                      let currentElements = [];

                      if (view === 'detail' && selectedRecord) {
                        // For detail view, gather elements from all zones (header, body, footer)
                        const allZoneElements = [];

                        // Add header zone elements
                        const headerZone = pageSettings.detail.zones.header;
                        if (headerZone && headerZone.visible) {
                          headerZone.rows.forEach(row => {
                            row.elements.forEach(el => {
                              allZoneElements.push({
                                ...el,
                                zone: 'header'
                              });
                            });
                          });
                        }

                        // Add body zone elements (from layout)
                        const bodyElements = getAllDetailElements(selectedRecord.id);
                        bodyElements.forEach(el => {
                          allZoneElements.push({
                            ...el,
                            zone: 'body'
                          });
                        });

                        // Add footer zone elements
                        const footerZone = pageSettings.detail.zones.footer;
                        if (footerZone && footerZone.visible) {
                          footerZone.rows.forEach(row => {
                            row.elements.forEach(el => {
                              allZoneElements.push({
                                ...el,
                                zone: 'footer'
                              });
                            });
                          });
                        }

                        currentElements = allZoneElements;
                      } else {
                        currentElements = droppedElements.filter(el => el.context === view);
                      }

                      const visibleElements = currentElements.filter(item => {
                        // For detail page layout items
                        if (item.type === 'card' || item.type === 'section' || item.type === 'container') {
                          const elementData = droppedElements.find(e => e.id === item.id);
                          return elementData?.visible !== false;
                        }
                        // For list elements
                        return item.visible !== false;
                      });

                      if (currentElements.length === 0) {
                        return (
                          <div className="text-center py-12 px-4">
                            <svg className="w-12 h-12 mx-auto mb-3 text-neutral-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                            <p className="text-sm text-neutral-500 font-medium mb-1">No page elements yet</p>
                            <p className="text-xs text-neutral-400 mb-4">Start building by dragging elements from the component panel</p>
                            <button
                              onClick={() => {
                                setIsComponentPanelOpen(true);
                                setRightPanelTab('elements');
                              }}
                              className="inline-flex items-center gap-2 px-4 py-2 bg-neutral-900 text-white text-xs rounded-lg hover:bg-neutral-800 transition-colors"
                            >
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 4v16m8-8H4" />
                              </svg>
                              Open Component Panel
                            </button>
                          </div>
                        );
                      }

                      // Filter by search (and ensure no null/undefined items)
                      const filteredElements = currentElements
                        .filter((item) => item != null && item.id != null)
                        .filter((item) => {
                          if (explorerSearchFilter === '') return true;
                          const searchLower = explorerSearchFilter.toLowerCase();
                          // For detail layout items, check elementType
                          if (item.elementType) {
                            return item.elementType.toLowerCase().includes(searchLower);
                          }
                          // For list elements
                          return (
                            item.label?.toLowerCase().includes(searchLower) ||
                            item.type?.toLowerCase().includes(searchLower)
                          );
                        });

                      // Group elements by zone for detail view
                      if (view === 'detail' && selectedRecord) {
                        // Group by zone
                        const zones = { header: [], body: [], footer: [] };
                        filteredElements.forEach(item => {
                          const zoneName = item.zone || 'body';
                          if (zones[zoneName]) {
                            zones[zoneName].push(item);
                          }
                        });

                        return (
                          <SortableContext
                            items={filteredElements.map(el => el.id)}
                            strategy={verticalListSortingStrategy}
                          >
                            <div className="space-y-4">
                              {/* Header Zone */}
                              {zones.header.length > 0 && (
                                <div className="space-y-1">
                                  <div className="flex items-center gap-2 px-3 py-1.5 text-xs font-medium text-blue-600 uppercase tracking-wider bg-blue-50 rounded">
                                    <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                    Header Zone
                                    <span className="text-blue-500 font-normal ml-auto">{zones.header.length}</span>
                                  </div>
                                  <div className="ml-2 border-l-2 border-blue-200/50 pl-2 space-y-1">
                                    {zones.header.map((item, idx) => (
                                      <React.Fragment key={item.id}>
                                        <SortableOutlineItem
                                          element={{ ...item, label: item.elementType, visible: true }}
                                          containerChildren={containerChildren}
                                          isOver={overOutlineItemId === item.id}
                                          isDragging={activeOutlineItemId === item.id}
                                        />
                                      </React.Fragment>
                                    ))}
                                  </div>
                                </div>
                              )}

                              {/* Body Zone */}
                              {zones.body.length > 0 && (
                                <div className="space-y-1">
                                  <div className="flex items-center gap-2 px-3 py-1.5 text-xs font-medium text-green-600 uppercase tracking-wider bg-green-50 rounded">
                                    <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 6h16M4 12h16M4 18h16" />
                                    </svg>
                                    Body Zone
                                    <span className="text-green-500 font-normal ml-auto">{zones.body.length}</span>
                                  </div>
                                  <div className="ml-2 border-l-2 border-green-200/50 pl-2 space-y-1">
                                    {zones.body.map((item, idx) => {
                                      const element = {
                                        ...item,
                                        label: item.elementType,
                                        type: item.type,
                                        visible: (item.type === 'card' || item.type === 'container')
                                          ? (droppedElements.find(e => e.id === item.id)?.visible !== false)
                                          : true
                                      };

                                      return (
                                        <React.Fragment key={item.id}>
                                          <SortableOutlineItem
                                            element={element}
                                            containerChildren={containerChildren}
                                            isOver={overOutlineItemId === item.id}
                                            isDragging={activeOutlineItemId === item.id}
                                          />
                                        </React.Fragment>
                                      );
                                    })}
                                  </div>
                                </div>
                              )}

                              {/* Footer Zone */}
                              {zones.footer.length > 0 && (
                                <div className="space-y-1">
                                  <div className="flex items-center gap-2 px-3 py-1.5 text-xs font-medium text-purple-600 uppercase tracking-wider bg-purple-50 rounded">
                                    <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                    Footer Zone
                                    <span className="text-purple-500 font-normal ml-auto">{zones.footer.length}</span>
                                  </div>
                                  <div className="ml-2 border-l-2 border-purple-200/50 pl-2 space-y-1">
                                    {zones.footer.map((item, idx) => (
                                      <React.Fragment key={item.id}>
                                        <SortableOutlineItem
                                          element={{ ...item, label: item.elementType, visible: true }}
                                          containerChildren={containerChildren}
                                          isOver={overOutlineItemId === item.id}
                                          isDragging={activeOutlineItemId === item.id}
                                        />
                                      </React.Fragment>
                                    ))}
                                  </div>
                                </div>
                              )}
                            </div>
                          </SortableContext>
                        );
                      }

                      // List view - no column grouping
                      return (
                        <SortableContext
                          items={filteredElements.map(el => el.id)}
                          strategy={verticalListSortingStrategy}
                        >
                          {filteredElements.map((item, idx) => {
                            const element = view === 'detail'
                              ? {
                                  ...item,
                                  label: item.elementType,
                                  type: item.type,
                                  visible: (item.type === 'card' || item.type === 'container')
                                    ? (droppedElements.find(e => e.id === item.id)?.visible !== false)
                                    : true
                                }
                              : item;

                            const isLast = idx === filteredElements.length - 1;

                            return (
                              <React.Fragment key={item.id}>
                                <SortableOutlineItem
                                  element={element}
                                  containerChildren={containerChildren}
                                  isOver={overOutlineItemId === item.id}
                                  isDragging={activeOutlineItemId === item.id}
                                />
                                {/* Drop zone after last item */}
                                {isLast && activeOutlineItemId && (
                                  <div className="relative h-8 -mb-1">
                                    <div className="absolute top-4 left-0 right-0 h-0.5 bg-blue-500/30 rounded-full" />
                                  </div>
                                )}
                              </React.Fragment>
                            );
                          })}
                        </SortableContext>
                      );
                    })()}
                  </div>
                ) : (
                  <div className="space-y-2">
                    {/* Sample List Items */}
                    <div className="text-sm text-neutral-500 mb-4">
                      {explorerRecordType.charAt(0).toUpperCase() + explorerRecordType.slice(1)} List
                    </div>
                    {[1, 2, 3, 4, 5].map((i) => (
                      <div
                        key={i}
                        className="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-white/60 cursor-pointer transition-all"
                        onClick={() => {
                          // Handle record selection
                          console.log(`Selected ${explorerRecordType} #${i}`);
                        }}
                      >
                        <div className="w-8 h-8 rounded-full bg-gradient-to-br from-neutral-200 to-neutral-300 flex-shrink-0" />
                        <div className="flex-1 min-w-0">
                          <div className="text-sm font-medium text-neutral-900 truncate">
                            {explorerRecordType.slice(0, -1)} {i}
                          </div>
                          <div className="text-xs text-neutral-500 truncate">
                            Sample description for {explorerRecordType.slice(0, -1)} #{i}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Drop Zone for Tabs (above Quick Access) */}
              {draggedTab && (
                <div
                  className={`px-4 py-2 border-t border-neutral-200/50 transition-all ${
                    isQuickAccessDropTarget
                      ? 'bg-blue-50 border-blue-300'
                      : 'bg-neutral-50/50'
                  }`}
                  onDragOver={(e) => {
                    e.preventDefault();
                    setIsQuickAccessDropTarget(true);
                  }}
                  onDragLeave={() => {
                    setIsQuickAccessDropTarget(false);
                  }}
                  onDrop={(e) => {
                    e.preventDefault();
                    setIsQuickAccessDropTarget(false);
                    const tabName = e.dataTransfer.getData('text/plain');
                    console.log(`Tab "${tabName}" dropped above Quick Access - creating embedded panel`);

                    // Create a new embedded panel within Explorer (above Quick Access)
                    const newPanel = {
                      id: `embedded-panel-${Date.now()}`,
                      tabId: tabName,
                      height: 200,
                      isMinimized: false
                    };
                    setEmbeddedPanels([...embeddedPanels, newPanel]);
                    setDraggedTab(null);
                  }}
                >
                  <div className="flex items-center justify-center gap-2 text-xs text-neutral-500">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 4v16m8-8H4" />
                    </svg>
                    Drop here to create embedded panel
                  </div>
                </div>
              )}

              {/* Embedded Panels - Rendered above Quick Access */}
              {embeddedPanels.map((panel) => {
                const tabConfig = {
                  pages: { label: 'Pages' },
                  outline: { label: 'Outline' },
                  list: { label: 'List' }
                };
                const config = tabConfig[panel.tabId];
                if (!config) return null;

                return (
                  <div
                    key={panel.id}
                    className="border-t border-neutral-200/50 bg-white/40 relative"
                    style={{ height: panel.isMinimized ? 'auto' : `${panel.height}px` }}
                  >
                    {/* Resize Handle - only show when not collapsed */}
                    {!panel.isMinimized && (
                      <div
                        className="absolute top-0 left-0 right-0 h-2 cursor-ns-resize hover:bg-blue-500/20 transition-colors group"
                        onMouseDown={(e) => {
                          e.stopPropagation();
                          const startY = e.clientY;
                          const startHeight = panel.height;

                          const handleMouseMove = (moveEvent) => {
                            const newHeight = Math.max(150, Math.min(500, startHeight - (moveEvent.clientY - startY)));
                            setEmbeddedPanels(embeddedPanels.map(p =>
                              p.id === panel.id ? { ...p, height: newHeight } : p
                            ));
                          };

                          const handleMouseUp = () => {
                            document.removeEventListener('mousemove', handleMouseMove);
                            document.removeEventListener('mouseup', handleMouseUp);
                          };

                          document.addEventListener('mousemove', handleMouseMove);
                          document.addEventListener('mouseup', handleMouseUp);
                        }}
                      >
                        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-8 h-1 bg-neutral-300 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" />
                      </div>
                    )}

                    {/* Panel Header - Matches Quick Access styling */}
                    <div className={`px-4 pt-3 pb-2 flex items-center justify-between transition-colors`}>
                      <div className="flex items-center gap-2">
                        <button
                          onClick={() => {
                            setEmbeddedPanels(embeddedPanels.map(p =>
                              p.id === panel.id ? { ...p, isMinimized: !p.isMinimized } : p
                            ));
                          }}
                          className="p-0.5 text-neutral-400 hover:text-neutral-900 transition-colors"
                          title={panel.isMinimized ? 'Expand' : 'Collapse'}
                        >
                          <svg className={`w-4 h-4 transition-transform ${panel.isMinimized ? '-rotate-90' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 9l-7 7-7-7" />
                          </svg>
                        </button>
                        <div className="text-xs font-semibold uppercase tracking-wider text-neutral-600">
                          {config.label}
                        </div>
                      </div>
                      <button
                        onClick={() => {
                          setEmbeddedPanels(embeddedPanels.filter(p => p.id !== panel.id));
                        }}
                        className="p-1 text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100/80 rounded transition-colors"
                        title="Close panel"
                      >
                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>

                    {/* Panel Content - Shows simplified view of tab content */}
                    {!panel.isMinimized && (
                      <div className="overflow-y-auto px-4 py-2" style={{ height: 'calc(100% - 40px)' }}>
                        {panel.tabId === 'outline' ? (
                          <div className="space-y-1 text-xs">
                            {(() => {
                              const currentElements = view === 'detail' && selectedRecord
                                ? getAllDetailElements(selectedRecord.id)
                                : droppedElements.filter(el => el.context === view);

                              if (currentElements.length === 0) {
                                return <div className="text-neutral-400 py-4 text-center">No elements</div>;
                              }

                              return currentElements.map((item, idx) => (
                                <div key={item.id || idx} className="flex items-center gap-2 px-2 py-1.5 hover:bg-neutral-100/80 rounded">
                                  <span className="text-neutral-600">{item.elementType || item.type}</span>
                                </div>
                              ));
                            })()}
                          </div>
                        ) : panel.tabId === 'pages' ? (
                          <div className="text-xs text-neutral-500 py-4 text-center">Pages view</div>
                        ) : (
                          <div className="text-xs text-neutral-500 py-4 text-center">List view</div>
                        )}
                      </div>
                    )}
                  </div>
                );
              })}

              {/* Quick Access Panel */}
              <div
                className="border-t border-neutral-200/50 bg-white/40 relative"
                style={{ height: isQuickAccessCollapsed ? '40px' : `${quickAccessHeight}px` }}
              >
                {/* Resize Handle - only show when not collapsed */}
                {!isQuickAccessCollapsed && (
                  <div
                    ref={quickAccessResizeHandleRef}
                    className="absolute top-0 left-0 right-0 h-2 cursor-ns-resize hover:bg-blue-500/20 transition-colors group"
                    onMouseDown={(e) => {
                      e.stopPropagation();
                      const startY = e.clientY;
                      const startHeight = quickAccessHeight;

                      const handleMouseMove = (moveEvent) => {
                        const newHeight = Math.max(180, Math.min(500, startHeight - (moveEvent.clientY - startY)));
                        setQuickAccessHeight(newHeight);
                      };

                      const handleMouseUp = () => {
                        document.removeEventListener('mousemove', handleMouseMove);
                        document.removeEventListener('mouseup', handleMouseUp);
                      };

                      document.addEventListener('mousemove', handleMouseMove);
                      document.addEventListener('mouseup', handleMouseUp);
                    }}
                  >
                    <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-8 h-1 bg-neutral-300 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" />
                  </div>
                )}

                {/* Quick Access Header */}
                <div className={`px-4 pt-3 pb-2 flex items-center justify-between transition-colors ${
                  draggedElement && isQuickAccessDropTarget ? 'bg-blue-50' : ''
                }`}>
                  <div className="flex items-center gap-2">
                    <button
                      onClick={() => setIsQuickAccessCollapsed(!isQuickAccessCollapsed)}
                      className="p-0.5 text-neutral-400 hover:text-neutral-900 transition-colors"
                      title={isQuickAccessCollapsed ? 'Expand' : 'Collapse'}
                    >
                      <svg className={`w-4 h-4 transition-transform ${isQuickAccessCollapsed ? '-rotate-90' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 9l-7 7-7-7" />
                      </svg>
                    </button>
                    <div className={`text-xs font-semibold uppercase tracking-wider ${
                      draggedElement && isQuickAccessDropTarget ? 'text-blue-600' : 'text-neutral-600'
                    }`}>
                      {draggedElement && isQuickAccessDropTarget ? 'Drop to add to Quick Access' : 'Quick Access'}
                    </div>
                  </div>
                  {draggedElement && isQuickAccessDropTarget && !isQuickAccessCollapsed && (
                    <svg className="w-4 h-4 text-blue-500 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                    </svg>
                  )}
                </div>

                {/* Quick Access Icons Grid - only show when not collapsed */}
                {!isQuickAccessCollapsed && (
                  <QuickAccessDropZone
                    icons={quickAccessIcons}
                    isDragTarget={draggedElement && isQuickAccessDropTarget}
                  />
                )}
              </div>
            </div>
          )}

          {/* Resize Handles */}
          {!explorerPanelMinimized && (
            <>
              {/* Right edge resize when docked */}
              {explorerIsDocked && (
                <div
                  className="absolute top-0 right-0 bottom-0 w-2 cursor-ew-resize hover:bg-blue-500/20 transition-colors"
                  onMouseDown={(e) => {
                    e.stopPropagation();
                    const startX = e.clientX;
                    const startWidth = explorerPanelSize.width;

                    const handleMouseMove = (moveEvent) => {
                      const newWidth = Math.max(280, Math.min(800, startWidth + (moveEvent.clientX - startX)));
                      setExplorerPanelSize({ ...explorerPanelSize, width: newWidth });
                    };

                    const handleMouseUp = () => {
                      document.removeEventListener('mousemove', handleMouseMove);
                      document.removeEventListener('mouseup', handleMouseUp);
                    };

                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                  }}
                />
              )}

              {/* Corner resize when not snapped and not docked */}
              {!explorerIsDocked && !explorerPanelSnapped && (
                <div
                  ref={explorerResizeHandleRef}
                  className="absolute bottom-0 right-0 w-4 h-4 cursor-nwse-resize"
                  onMouseDown={(e) => {
                    e.stopPropagation();
                    const startX = e.clientX;
                    const startY = e.clientY;
                    const startWidth = explorerPanelSize.width;
                    const startHeight = explorerPanelSize.height;

                    const handleMouseMove = (moveEvent) => {
                      const newWidth = Math.max(280, startWidth + (moveEvent.clientX - startX));
                      const newHeight = Math.max(400, startHeight + (moveEvent.clientY - startY));
                      setExplorerPanelSize({ width: newWidth, height: newHeight });
                    };

                    const handleMouseUp = () => {
                      document.removeEventListener('mousemove', handleMouseMove);
                      document.removeEventListener('mouseup', handleMouseUp);
                    };

                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                  }}
                >
                  <svg className="w-4 h-4 text-neutral-300" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M14 14V0h2v16H0v-2h14zM12 12V2h2v12H2v-2h10z" opacity="0.3" />
                  </svg>
                </div>
              )}

              {/* Right edge resize when snapped left (not docked) */}
              {!explorerIsDocked && explorerPanelSnapped === 'left' && (
                <div
                  className="absolute top-0 right-0 bottom-0 w-2 cursor-ew-resize hover:bg-blue-500/20 transition-colors"
                  onMouseDown={(e) => {
                    e.stopPropagation();
                    const startX = e.clientX;
                    const startWidth = explorerPanelSize.width;

                    const handleMouseMove = (moveEvent) => {
                      const newWidth = Math.max(280, Math.min(800, startWidth + (moveEvent.clientX - startX)));
                      setExplorerPanelSize({ ...explorerPanelSize, width: newWidth });
                    };

                    const handleMouseUp = () => {
                      document.removeEventListener('mousemove', handleMouseMove);
                      document.removeEventListener('mouseup', handleMouseUp);
                    };

                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                  }}
                />
              )}

              {/* Left edge resize when snapped right (not docked) */}
              {!explorerIsDocked && explorerPanelSnapped === 'right' && (
                <div
                  className="absolute top-0 left-0 bottom-0 w-2 cursor-ew-resize hover:bg-blue-500/20 transition-colors"
                  onMouseDown={(e) => {
                    e.stopPropagation();
                    const startX = e.clientX;
                    const startWidth = explorerPanelSize.width;

                    const handleMouseMove = (moveEvent) => {
                      const newWidth = Math.max(280, Math.min(800, startWidth - (moveEvent.clientX - startX)));
                      setExplorerPanelSize({ ...explorerPanelSize, width: newWidth });
                    };

                    const handleMouseUp = () => {
                      document.removeEventListener('mousemove', handleMouseMove);
                      document.removeEventListener('mouseup', handleMouseUp);
                    };

                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                  }}
                />
              )}

              {/* Bottom edge resize when snapped top (not docked) */}
              {!explorerIsDocked && explorerPanelSnapped === 'top' && (
                <div
                  className="absolute bottom-0 left-0 right-0 h-2 cursor-ns-resize hover:bg-blue-500/20 transition-colors"
                  onMouseDown={(e) => {
                    e.stopPropagation();
                    const startY = e.clientY;
                    const startHeight = explorerPanelSize.height;

                    const handleMouseMove = (moveEvent) => {
                      const newHeight = Math.max(400, Math.min(window.innerHeight - 96, startHeight + (moveEvent.clientY - startY)));
                      setExplorerPanelSize({ ...explorerPanelSize, height: newHeight });
                    };

                    const handleMouseUp = () => {
                      document.removeEventListener('mousemove', handleMouseMove);
                      document.removeEventListener('mouseup', handleMouseUp);
                    };

                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                  }}
                />
              )}

              {/* Top edge resize when snapped bottom (not docked) */}
              {!explorerIsDocked && explorerPanelSnapped === 'bottom' && (
                <div
                  className="absolute top-0 left-0 right-0 h-2 cursor-ns-resize hover:bg-blue-500/20 transition-colors"
                  onMouseDown={(e) => {
                    e.stopPropagation();
                    const startY = e.clientY;
                    const startHeight = explorerPanelSize.height;

                    const handleMouseMove = (moveEvent) => {
                      const newHeight = Math.max(400, Math.min(window.innerHeight - 96, startHeight - (moveEvent.clientY - startY)));
                      setExplorerPanelSize({ ...explorerPanelSize, height: newHeight });
                    };

                    const handleMouseUp = () => {
                      document.removeEventListener('mousemove', handleMouseMove);
                      document.removeEventListener('mouseup', handleMouseUp);
                    };

                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                  }}
                />
              )}
            </>
          )}
        </div>
      )}

      {/* Detached Panels */}
      {detachedPanels.map((panel) => (
        <div
          key={panel.id}
          className="fixed z-[100] rounded-2xl shadow-2xl bg-white/95 backdrop-blur-lg border border-neutral-200"
          style={{
            left: `${panel.position.x}px`,
            top: `${panel.position.y}px`,
            width: `${panel.size.width}px`,
            height: panel.isMinimized ? 'auto' : `${panel.size.height}px`,
          }}
        >
          {/* Panel Header */}
          <div
            className="h-14 px-4 flex items-center justify-between border-b border-neutral-200/50 cursor-move"
            onMouseDown={(e) => {
              const startX = e.clientX - panel.position.x;
              const startY = e.clientY - panel.position.y;

              const handleMouseMove = (moveEvent) => {
                const newX = moveEvent.clientX - startX;
                const newY = moveEvent.clientY - startY;
                setDetachedPanels(detachedPanels.map(p =>
                  p.id === panel.id ? { ...p, position: { x: newX, y: newY } } : p
                ));
              };

              const handleMouseUp = () => {
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
              };

              document.addEventListener('mousemove', handleMouseMove);
              document.addEventListener('mouseup', handleMouseUp);
            }}
          >
            <h3 className="text-sm font-semibold text-neutral-900 capitalize">{panel.tabId}</h3>
            <button
              onClick={() => setDetachedPanels(detachedPanels.filter(p => p.id !== panel.id))}
              className="p-1.5 text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100/80 rounded transition-colors"
              title="Close panel"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>

          {/* Panel Content */}
          {!panel.isMinimized && (
            <div className="p-4 overflow-y-auto" style={{ height: 'calc(100% - 3.5rem)' }}>
              <div className="text-sm text-neutral-600">
                This is the {panel.tabId} panel content.
              </div>
            </div>
          )}
        </div>
      ))}

      {/* Timeline Panel */}
      {isLayerActive('timeline') && (
        <div
          ref={timelinePanelRef}
          className={`fixed z-[100] rounded-t-2xl shadow-2xl animate-slide-up panel-transition panel-backdrop-transition ${
            timelinePanelMinimized ? 'h-14' : ''
          }`}
          style={{
            left: '20px',
            right: '20px',
            bottom: '20px',
            height: timelinePanelMinimized ? 'auto' : `${timelinePanelHeight}px`,
            backgroundColor: isTimelinePanelFocused ? 'rgba(255, 255, 255, 0.95)' : 'rgba(255, 255, 255, 0.55)',
            backdropFilter: 'blur(20px)',
            WebkitBackdropFilter: 'blur(20px)',
            border: '1px solid rgba(0, 0, 0, 0.1)',
            transition: 'background-color 0.2s ease',
          }}
          onMouseEnter={() => setIsTimelinePanelFocused(true)}
          onMouseLeave={() => setIsTimelinePanelFocused(false)}
        >
          {/* Header */}
          <div className="h-14 px-6 flex items-center justify-between border-b border-neutral-200/50">
            <div className="flex items-center gap-4">
              {/* Minimize/Restore - Far Left */}
              <button
                onClick={() => setTimelinePanelMinimized(!timelinePanelMinimized)}
                className="p-1.5 text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100/80 rounded transition-colors"
                title={timelinePanelMinimized ? 'Restore' : 'Minimize'}
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  {timelinePanelMinimized ? (
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M5 15l7-7 7 7" />
                  ) : (
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 9l-7 7-7-7" />
                  )}
                </svg>
              </button>

              <h3 className="text-sm font-semibold text-neutral-900">Timeline</h3>

              {/* Record Name Selector */}
              <div className="relative group">
                <button className="flex items-center gap-2 px-3 py-1.5 text-sm text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100/80 rounded-lg transition-colors">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  <span className="font-medium">{timelineRecordName}</span>
                  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 9l-7 7-7-7" />
                  </svg>
                </button>

                {/* Record Dropdown */}
                <div className="absolute top-full left-0 mt-1 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all bg-white/95 backdrop-blur-lg rounded-lg shadow-xl border border-neutral-200/50 py-2 min-w-[200px] z-10">
                  {['Current Record', 'Current Page', 'All Records'].map((record) => (
                    <button
                      key={record}
                      onClick={() => setTimelineRecordName(record)}
                      className={`w-full px-4 py-2 text-left text-sm transition-colors ${
                        timelineRecordName === record
                          ? 'bg-neutral-100 text-neutral-900 font-medium'
                          : 'text-neutral-600 hover:bg-neutral-50'
                      }`}
                    >
                      {record}
                    </button>
                  ))}
                </div>
              </div>

              {/* Date Range Filter */}
              <div className="relative group">
                <button className="flex items-center gap-2 px-3 py-1.5 text-sm text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100/80 rounded-lg transition-colors">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span>Last {timelineDateRange} days</span>
                  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 9l-7 7-7-7" />
                  </svg>
                </button>

                {/* Date Range Dropdown */}
                <div className="absolute top-full left-0 mt-1 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all bg-white/95 backdrop-blur-lg rounded-lg shadow-xl border border-neutral-200/50 py-2 min-w-[160px] z-10">
                  {[7, 14, 30, 60, 90].map((days) => (
                    <button
                      key={days}
                      onClick={() => setTimelineDateRange(days)}
                      className={`w-full px-4 py-2 text-left text-sm transition-colors ${
                        timelineDateRange === days
                          ? 'bg-neutral-100 text-neutral-900 font-medium'
                          : 'text-neutral-600 hover:bg-neutral-50'
                      }`}
                    >
                      Last {days} days
                    </button>
                  ))}
                </div>
              </div>

              {/* Field Selector */}
              <div className="flex items-center gap-2">
                {timelineSelectedField ? (
                  <div className="flex items-center gap-2 px-3 py-1.5 bg-blue-50 text-blue-700 rounded-lg text-sm">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                    </svg>
                    <span className="font-medium">{timelineSelectedField}</span>
                    <button
                      onClick={() => setTimelineSelectedField(null)}
                      className="ml-1 hover:bg-blue-100 rounded p-0.5"
                    >
                      <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                ) : (
                  <div className="relative group">
                    <button className="flex items-center gap-2 px-3 py-1.5 text-sm text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100/80 rounded-lg transition-colors border border-neutral-200/50 border-dashed">
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                      </svg>
                      <span>Filter by field</span>
                      <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 9l-7 7-7-7" />
                      </svg>
                    </button>

                    {/* Field Selection Dropdown */}
                    <div className="absolute top-full left-0 mt-1 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all bg-white/95 backdrop-blur-lg rounded-lg shadow-xl border border-neutral-200/50 py-2 min-w-[200px] z-10">
                      <div className="px-3 py-2 text-xs font-medium text-neutral-500 uppercase tracking-wider border-b border-neutral-100">
                        Select Field
                      </div>
                      {['Status', 'Priority', 'Assignee', 'Due Date', 'Category', 'Tags'].map((field) => (
                        <button
                          key={field}
                          onClick={() => setTimelineSelectedField(field)}
                          className="w-full px-4 py-2 text-left text-sm text-neutral-600 hover:bg-neutral-50 transition-colors"
                        >
                          {field}
                        </button>
                      ))}
                    </div>
                  </div>
                )}

                {/* Visual Field Selector Target Icon */}
                <button
                  onClick={() => {
                    setIsTimelineFieldSelectorActive(!isTimelineFieldSelectorActive);
                    if (isTimelineFieldSelectorActive) {
                      // Exiting field selection mode
                      setTimelineSelectedField(null);
                    }
                  }}
                  className={`p-2 rounded-lg transition-all ${
                    isTimelineFieldSelectorActive
                      ? 'bg-blue-600 text-white shadow-md'
                      : 'text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100/80 border border-neutral-200/50'
                  }`}
                  title={isTimelineFieldSelectorActive ? 'Exit field selection mode (ESC)' : 'Select field visually from page'}
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                  </svg>
                </button>
              </div>
            </div>

            <div className="flex items-center gap-1">
              {/* Visualization Toggle */}
              <div className="flex items-center gap-1 bg-neutral-100/80 rounded-lg p-1">
                <button
                  onClick={() => setTimelineVisualization('bar')}
                  className={`px-3 py-1.5 text-xs font-medium rounded transition-colors ${
                    timelineVisualization === 'bar'
                      ? 'bg-white text-neutral-900 shadow-sm'
                      : 'text-neutral-600 hover:text-neutral-900'
                  }`}
                  title="Bar Chart"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                  </svg>
                </button>
                <button
                  onClick={() => setTimelineVisualization('heatmap')}
                  className={`px-3 py-1.5 text-xs font-medium rounded transition-colors ${
                    timelineVisualization === 'heatmap'
                      ? 'bg-white text-neutral-900 shadow-sm'
                      : 'text-neutral-600 hover:text-neutral-900'
                  }`}
                  title="Calendar Heatmap"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zM14 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                  </svg>
                </button>
              </div>

              {/* Period Toggle (only for bar chart) */}
              {timelineVisualization === 'bar' && (
                <div className="flex items-center gap-1 bg-neutral-100/80 rounded-lg p-1 ml-2">
                  <button
                    onClick={() => setTimelinePeriod('day')}
                    className={`px-2 py-1.5 text-xs font-medium rounded transition-colors ${
                      timelinePeriod === 'day'
                        ? 'bg-white text-neutral-900 shadow-sm'
                        : 'text-neutral-600 hover:text-neutral-900'
                    }`}
                  >
                    Day
                  </button>
                  <button
                    onClick={() => setTimelinePeriod('week')}
                    className={`px-2 py-1.5 text-xs font-medium rounded transition-colors ${
                      timelinePeriod === 'week'
                        ? 'bg-white text-neutral-900 shadow-sm'
                        : 'text-neutral-600 hover:text-neutral-900'
                    }`}
                  >
                    Week
                  </button>
                  <button
                    onClick={() => setTimelinePeriod('month')}
                    className={`px-2 py-1.5 text-xs font-medium rounded transition-colors ${
                      timelinePeriod === 'month'
                        ? 'bg-white text-neutral-900 shadow-sm'
                        : 'text-neutral-600 hover:text-neutral-900'
                    }`}
                  >
                    Month
                  </button>
                </div>
              )}

              <div className="h-6 w-px bg-neutral-200 mx-2" />

              {/* Close */}
              <button
                onClick={() => toggleLayer('timeline')}
                className="p-1.5 text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100/80 rounded transition-colors"
                title="Close Timeline"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          </div>

          {/* Panel Content */}
          {!timelinePanelMinimized && (
            <div className="flex flex-col h-[calc(100%-3.5rem)]">
              {/* Visualization Area */}
              <div className="flex-1 overflow-y-auto px-6 py-6">
                {timelineVisualization === 'bar' ? (
                  <div className="h-full">
                    <ResponsiveContainer width="100%" height="100%">
                      <BarChart
                        data={generateTimelineData(timelineDateRange, timelinePeriod, timelineSelectedField)}
                        margin={{ top: 10, right: 30, left: 0, bottom: 20 }}
                      >
                        <CartesianGrid strokeDasharray="3 3" stroke="#e5e5e5" />
                        <XAxis
                          dataKey="date"
                          tick={{ fill: '#737373', fontSize: 12 }}
                          tickLine={{ stroke: '#e5e5e5' }}
                        />
                        <YAxis
                          tick={{ fill: '#737373', fontSize: 12 }}
                          tickLine={{ stroke: '#e5e5e5' }}
                          label={{ value: 'Activity Count', angle: -90, position: 'insideLeft', style: { fill: '#737373', fontSize: 12 } }}
                        />
                        <Tooltip
                          contentStyle={{
                            backgroundColor: 'rgba(255, 255, 255, 0.98)',
                            border: '1px solid #e5e5e5',
                            borderRadius: '8px',
                            padding: '12px',
                            boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                          }}
                          cursor={{ fill: 'rgba(59, 130, 246, 0.1)' }}
                        />
                        <Bar
                          dataKey="count"
                          fill="#3b82f6"
                          radius={[4, 4, 0, 0]}
                          onClick={(data) => {
                            setTimelineSelectedDataPoint(data);
                            setIsTimelineDetailsPanelOpen(true);
                          }}
                          cursor="pointer"
                        >
                          {generateTimelineData(timelineDateRange, timelinePeriod, timelineSelectedField).map((entry, index) => (
                            <Cell
                              key={`cell-${index}`}
                              fill={timelineSelectedDataPoint?.date === entry.date ? '#1d4ed8' : '#3b82f6'}
                            />
                          ))}
                        </Bar>
                      </BarChart>
                    </ResponsiveContainer>
                  </div>
                ) : (
                  <div className="h-full flex flex-col items-center justify-start p-8 overflow-auto">
                    <div className="w-full max-w-6xl">
                      {/* Info text */}
                      <div className="mb-4 text-center">
                        <p className="text-sm text-neutral-600">
                          Showing activity for the last {Math.min(timelineDateRange, 365)} days
                        </p>
                      </div>

                      {/* Heatmap container with fixed sizing */}
                      <div className="w-full overflow-x-auto pb-4">
                        <div style={{
                          minWidth: `${Math.max(800, Math.ceil(timelineDateRange / 7) * 15)}px`,
                          width: '100%'
                        }}>
                          <CalendarHeatmap
                            startDate={subDays(new Date(), Math.min(timelineDateRange, 365))}
                            endDate={new Date()}
                            values={generateHeatmapData(Math.min(timelineDateRange, 365))}
                            gutterSize={3}
                            horizontal={true}
                            showWeekdayLabels={true}
                            showMonthLabels={true}
                            classForValue={(value) => {
                              if (!value || value.count === 0) {
                                return 'color-empty';
                              }
                              if (value.count < 5) {
                                return 'color-scale-1';
                              }
                              if (value.count < 10) {
                                return 'color-scale-2';
                              }
                              if (value.count < 20) {
                                return 'color-scale-3';
                              }
                              return 'color-scale-4';
                            }}
                            tooltipDataAttrs={(value) => {
                              return {
                                'data-tip': value.date
                                  ? `${format(new Date(value.date), 'MMM dd, yyyy')}: ${value.count} activities`
                                  : 'No data',
                              };
                            }}
                            onClick={(value) => {
                              if (value && value.count > 0) {
                                const dateObj = new Date(value.date);
                                const mockDataPoint = {
                                  date: format(dateObj, 'MMM dd'),
                                  fullDate: value.date,
                                  count: value.count,
                                  activities: generateMockActivities(value.count, dateObj, timelineSelectedField)
                                };
                                setTimelineSelectedDataPoint(mockDataPoint);
                                setIsTimelineDetailsPanelOpen(true);
                              }
                            }}
                          />
                        </div>
                      </div>

                      {/* Heatmap Legend */}
                      <div className="flex items-center justify-center gap-4 mt-6">
                        <span className="text-xs text-neutral-500">Less</span>
                        <div className="flex gap-1">
                          <div className="w-4 h-4 rounded color-empty border border-neutral-200" />
                          <div className="w-4 h-4 rounded color-scale-1" />
                          <div className="w-4 h-4 rounded color-scale-2" />
                          <div className="w-4 h-4 rounded color-scale-3" />
                          <div className="w-4 h-4 rounded color-scale-4" />
                        </div>
                        <span className="text-xs text-neutral-500">More</span>
                      </div>
                    </div>
                  </div>
                )}
              </div>

              {/* Resize Handle */}
              <div
                className="absolute top-0 left-0 right-0 h-2 cursor-ns-resize hover:bg-blue-500/20 transition-colors"
                onMouseDown={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  const startY = e.clientY;
                  const startHeight = timelinePanelHeight;

                  // Prevent text selection during drag
                  document.body.style.userSelect = 'none';
                  document.body.style.cursor = 'ns-resize';

                  const handleMouseMove = (moveEvent) => {
                    moveEvent.preventDefault();
                    const newHeight = Math.max(300, Math.min(window.innerHeight - 96, startHeight - (moveEvent.clientY - startY)));
                    setTimelinePanelHeight(newHeight);
                  };

                  const handleMouseUp = () => {
                    // Restore default cursor and text selection
                    document.body.style.userSelect = '';
                    document.body.style.cursor = '';

                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                  };

                  document.addEventListener('mousemove', handleMouseMove);
                  document.addEventListener('mouseup', handleMouseUp);
                }}
              />
            </div>
          )}
        </div>
      )}

      {/* Timeline Details Slide-out Panel */}
      {isTimelineDetailsPanelOpen && timelineSelectedDataPoint && (
        <div
          className={`fixed right-0 top-0 bottom-0 w-96 bg-white border-l border-neutral-200 transform transition-transform duration-300 ease-in-out z-[110] ${
            isTimelineDetailsPanelOpen ? 'translate-x-0' : 'translate-x-full'
          }`}
        >
          {/* Details Panel Header */}
          <div className="h-14 border-b border-neutral-200 flex items-center justify-between px-6">
            <div>
              <h3 className="text-sm font-semibold text-neutral-900">Activity Details</h3>
              <p className="text-xs text-neutral-500 mt-0.5">
                {timelineSelectedDataPoint.date} - {timelineSelectedDataPoint.count} activities
              </p>
            </div>
            <button
              onClick={() => {
                setIsTimelineDetailsPanelOpen(false);
                setTimelineSelectedDataPoint(null);
              }}
              className="p-1.5 text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100/80 rounded transition-colors"
              title="Close"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>

          {/* Details Panel Content */}
          <div className="flex-1 overflow-y-auto p-6">
            <div className="space-y-4">
              {timelineSelectedDataPoint.activities && timelineSelectedDataPoint.activities.length > 0 ? (
                timelineSelectedDataPoint.activities.map((activity) => (
                  <div key={activity.id} className="pb-4 border-b border-neutral-100 last:border-0">
                    <div className="flex items-start gap-3">
                      <div className="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center">
                        <svg className="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2">
                          <p className="text-sm font-medium text-neutral-900">{activity.type}</p>
                        </div>
                        <p className="text-xs text-neutral-500 mt-1">by {activity.user}</p>
                        <p className="text-xs text-neutral-400 mt-0.5">{activity.timestamp}</p>
                        {activity.details && (
                          <p className="text-xs text-neutral-600 mt-2 bg-neutral-50 p-2 rounded">{activity.details}</p>
                        )}
                      </div>
                    </div>
                  </div>
                ))
              ) : (
                <div className="text-center py-12">
                  <svg className="w-12 h-12 mx-auto mb-3 text-neutral-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <p className="text-sm text-neutral-500">No activities found</p>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Visual Field Selection Overlay */}
      {isTimelineFieldSelectorActive && isLayerActive('timeline') && (
        <>
          {/* Overlay with instruction banner */}
          <div className="fixed inset-0 z-[105] pointer-events-none">
            {/* Top instruction banner */}
            <div className="fixed top-20 left-1/2 -translate-x-1/2 z-[106] pointer-events-auto">
              <div className="bg-blue-600 text-white px-6 py-3 rounded-lg shadow-2xl flex items-center gap-4 animate-fade-in">
                <div className="flex items-center gap-3">
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span className="text-sm font-medium">Click on any field on the page to track its activity timeline</span>
                </div>
                <button
                  onClick={() => setIsTimelineFieldSelectorActive(false)}
                  className="px-3 py-1 bg-white/20 hover:bg-white/30 rounded text-xs font-medium transition-colors"
                >
                  Cancel (ESC)
                </button>
              </div>
            </div>

            {/* Highlighting overlay for selectable fields */}
            <style>
              {`
                .timeline-field-selectable {
                  position: relative;
                  cursor: pointer !important;
                }
                .timeline-field-selectable::before {
                  content: '';
                  position: absolute;
                  top: -2px;
                  left: -2px;
                  right: -2px;
                  bottom: -2px;
                  border: 2px dashed #3b82f6;
                  border-radius: 6px;
                  background: rgba(59, 130, 246, 0.05);
                  pointer-events: none;
                  z-index: 1;
                  animation: pulse-border 2s ease-in-out infinite;
                }
                .timeline-field-selectable::after {
                  content: attr(data-field-name);
                  position: absolute;
                  top: -24px;
                  left: 0;
                  background: #3b82f6;
                  color: white;
                  padding: 2px 8px;
                  border-radius: 4px;
                  font-size: 11px;
                  font-weight: 600;
                  white-space: nowrap;
                  pointer-events: none;
                  z-index: 2;
                  opacity: 0;
                  transition: opacity 0.2s;
                }
                .timeline-field-selectable:hover::after {
                  opacity: 1;
                }
                @keyframes pulse-border {
                  0%, 100% {
                    border-color: #3b82f6;
                    background: rgba(59, 130, 246, 0.05);
                  }
                  50% {
                    border-color: #60a5fa;
                    background: rgba(59, 130, 246, 0.1);
                  }
                }
              `}
            </style>
          </div>

          {/* Background overlay with crosshair cursor */}
          <div
            className="fixed inset-0 z-[104] bg-black/5"
            style={{ cursor: 'crosshair' }}
            onClick={() => {
              // Clicked outside any field, exit selection mode
              setIsTimelineFieldSelectorActive(false);
            }}
          />

          {/* Simulated selectable fields overlay - for demonstration */}
          <div className="fixed inset-0 z-[105] pointer-events-none">
            {/* Simulate highlighting fields on the page */}
            {['Status', 'Priority', 'Assignee', 'Due Date', 'Category', 'Tags', 'Description', 'Notes'].map((fieldName, index) => {
              // Position fields in a 2-column grid pattern
              const column = index % 2;
              const row = Math.floor(index / 2);

              return (
                <div
                  key={fieldName}
                  className="timeline-field-selectable pointer-events-auto"
                  data-field-name={fieldName}
                  onClick={(e) => {
                    e.stopPropagation();
                    setTimelineSelectedField(fieldName);
                    setIsTimelineFieldSelectorActive(false);
                  }}
                  style={{
                    position: 'absolute',
                    left: `${15 + column * 45}%`,
                    top: `${180 + row * 90}px`,
                    width: '250px',
                    height: '48px',
                    zIndex: 105,
                  }}
                />
              );
            })}
          </div>
        </>
      )}

      {/* Insights Panel */}
      {isLayerActive('insights') && (
        <div
          ref={insightsPanelRef}
          className={`fixed z-[100] rounded-t-2xl shadow-2xl animate-slide-up panel-transition panel-backdrop-transition ${
            insightsPanelMinimized ? 'h-14' : ''
          }`}
          style={{
            left: '20px',
            right: '20px',
            // When Timeline is active, push Insights up above it
            bottom: isLayerActive('timeline')
              ? `${(timelinePanelMinimized ? 56 : timelinePanelHeight) + 40}px`
              : '20px',
            height: insightsPanelMinimized ? 'auto' : `${insightsPanelHeight}px`,
            backgroundColor: isInsightsPanelFocused ? 'rgba(255, 255, 255, 0.95)' : 'rgba(255, 255, 255, 0.55)',
            backdropFilter: 'blur(20px)',
            WebkitBackdropFilter: 'blur(20px)',
            border: '1px solid rgba(0, 0, 0, 0.1)',
            transition: 'background-color 0.2s ease, bottom 0.3s ease',
          }}
          onMouseEnter={() => setIsInsightsPanelFocused(true)}
          onMouseLeave={() => setIsInsightsPanelFocused(false)}
        >
          {/* Header */}
          <div className="h-14 px-6 flex items-center justify-between border-b border-neutral-200/50">
            <div className="flex items-center gap-4">
              {/* Minimize/Restore */}
              <button
                onClick={() => setInsightsPanelMinimized(!insightsPanelMinimized)}
                className="p-1.5 text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100/80 rounded transition-colors"
                title={insightsPanelMinimized ? 'Restore' : 'Minimize'}
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  {insightsPanelMinimized ? (
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M5 15l7-7 7 7" />
                  ) : (
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 9l-7 7-7-7" />
                  )}
                </svg>
              </button>

              <h3 className="text-sm font-semibold text-neutral-900">Insights</h3>

              {/* Timeline Filter Indicator */}
              {isLayerActive('timeline') && (
                <div className="flex items-center gap-1.5 px-2.5 py-1 bg-blue-50 text-blue-700 rounded-md text-xs font-medium">
                  <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span>Filtered by Timeline</span>
                </div>
              )}

              {/* Field Selector */}
              <div className="flex items-center gap-2">
                {insightsSelectedField ? (
                  <div className="flex items-center gap-2 px-3 py-1.5 bg-blue-50 text-blue-700 rounded-lg text-sm">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                    </svg>
                    <span className="font-medium">{insightsSelectedField}</span>
                    <button
                      onClick={() => setInsightsSelectedField(null)}
                      className="ml-1 hover:bg-blue-100 rounded p-0.5"
                    >
                      <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                ) : (
                  <div className="relative group">
                    <button className="flex items-center gap-2 px-3 py-1.5 text-sm text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100/80 rounded-lg transition-colors border border-neutral-200/50 border-dashed">
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                      </svg>
                      <span>All Fields</span>
                      <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 9l-7 7-7-7" />
                      </svg>
                    </button>

                    {/* Field Selection Dropdown */}
                    <div className="absolute top-full left-0 mt-1 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all bg-white/95 backdrop-blur-lg rounded-lg shadow-xl border border-neutral-200/50 py-2 min-w-[200px] z-10">
                      <div className="px-3 py-2 text-xs font-medium text-neutral-500 uppercase tracking-wider border-b border-neutral-100">
                        Select Field
                      </div>
                      {['Status', 'Priority', 'Assignee', 'Due Date', 'Category', 'Tags'].map((field) => (
                        <button
                          key={field}
                          onClick={() => setInsightsSelectedField(field)}
                          className="w-full px-4 py-2 text-left text-sm text-neutral-600 hover:bg-neutral-50 transition-colors"
                        >
                          {field}
                        </button>
                      ))}
                    </div>
                  </div>
                )}

                {/* Visual Field Selector Target Icon */}
                <button
                  onClick={() => {
                    setIsInsightsFieldSelectorActive(!isInsightsFieldSelectorActive);
                    if (isInsightsFieldSelectorActive) {
                      setInsightsSelectedField(null);
                    }
                  }}
                  className={`p-2 rounded-lg transition-all ${
                    isInsightsFieldSelectorActive
                      ? 'bg-blue-600 text-white shadow-md'
                      : 'text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100/80 border border-neutral-200/50'
                  }`}
                  title={isInsightsFieldSelectorActive ? 'Exit field selection mode (ESC)' : 'Select field visually from page'}
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                  </svg>
                </button>
              </div>
            </div>

            <div className="flex items-center gap-2">
              {/* Customize button */}
              <button
                className="px-3 py-1.5 text-xs font-medium text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100/80 rounded-lg transition-colors border border-neutral-200/50"
                title="Customize visualizations"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                </svg>
              </button>

              <div className="h-6 w-px bg-neutral-200 mx-1" />

              {/* Close */}
              <button
                onClick={() => toggleLayer('insights')}
                className="p-1.5 text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100/80 rounded transition-colors"
                title="Close Insights"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          </div>

          {/* Panel Content */}
          {!insightsPanelMinimized && (
            <div className="flex flex-col h-[calc(100%-3.5rem)]">
              {/* Visualizations Grid */}
              <div className="flex-1 overflow-y-auto px-6 py-6">
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  {(insightsVisualizations || []).filter(v => v.enabled).map((viz, index) => (
                    <div
                      key={viz.id}
                      className="bg-white border border-neutral-200/50 rounded-xl p-5 hover:shadow-lg transition-all cursor-pointer group"
                      onClick={() => setInsightsSelectedChart(viz)}
                    >
                      {/* Viz Header */}
                      <div className="flex items-center justify-between mb-4">
                        <h4 className="text-sm font-semibold text-neutral-900">{viz.title}</h4>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            // Handle drag/reorder
                          }}
                          className="opacity-0 group-hover:opacity-100 transition-opacity p-1 text-neutral-400 hover:text-neutral-900"
                          title="Drag to reorder"
                        >
                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 6h16M4 12h16M4 18h16" />
                          </svg>
                        </button>
                      </div>

                      {/* Viz Content */}
                      <div className="h-48">
                        {viz.type === 'pie' && (
                          <ResponsiveContainer width="100%" height="100%">
                            <PieChart>
                              <Pie
                                data={[
                                  { name: 'Active', value: 35, color: '#10b981' },
                                  { name: 'Pending', value: 25, color: '#f59e0b' },
                                  { name: 'Completed', value: 30, color: '#3b82f6' },
                                  { name: 'Cancelled', value: 10, color: '#ef4444' }
                                ]}
                                cx="50%"
                                cy="50%"
                                innerRadius={0}
                                outerRadius={65}
                                paddingAngle={2}
                                dataKey="value"
                                onClick={(data) => {
                                  // Open Explorer with filtered items
                                  setActiveLayer('explorer');
                                  setExplorerActiveTab('list');
                                }}
                                cursor="pointer"
                              >
                                {[
                                  { name: 'Active', value: 35, color: '#10b981' },
                                  { name: 'Pending', value: 25, color: '#f59e0b' },
                                  { name: 'Completed', value: 30, color: '#3b82f6' },
                                  { name: 'Cancelled', value: 10, color: '#ef4444' }
                                ].map((entry, i) => (
                                  <Cell key={`cell-${i}`} fill={entry.color} />
                                ))}
                              </Pie>
                              <Tooltip
                                contentStyle={{
                                  backgroundColor: 'rgba(255, 255, 255, 0.98)',
                                  border: '1px solid #e5e5e5',
                                  borderRadius: '8px',
                                  padding: '8px 12px',
                                  boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                                }}
                              />
                              <Legend
                                verticalAlign="bottom"
                                height={36}
                                iconSize={10}
                                wrapperStyle={{ fontSize: '11px' }}
                              />
                            </PieChart>
                          </ResponsiveContainer>
                        )}

                        {viz.type === 'donut' && (
                          <ResponsiveContainer width="100%" height="100%">
                            <PieChart>
                              <Pie
                                data={[
                                  { name: 'High', value: 20, color: '#ef4444' },
                                  { name: 'Medium', value: 45, color: '#f59e0b' },
                                  { name: 'Low', value: 35, color: '#10b981' }
                                ]}
                                cx="50%"
                                cy="50%"
                                innerRadius={45}
                                outerRadius={65}
                                paddingAngle={2}
                                dataKey="value"
                                onClick={(data) => {
                                  setActiveLayer('explorer');
                                  setExplorerActiveTab('list');
                                }}
                                cursor="pointer"
                              >
                                {[
                                  { name: 'High', value: 20, color: '#ef4444' },
                                  { name: 'Medium', value: 45, color: '#f59e0b' },
                                  { name: 'Low', value: 35, color: '#10b981' }
                                ].map((entry, i) => (
                                  <Cell key={`cell-${i}`} fill={entry.color} />
                                ))}
                              </Pie>
                              <Tooltip
                                contentStyle={{
                                  backgroundColor: 'rgba(255, 255, 255, 0.98)',
                                  border: '1px solid #e5e5e5',
                                  borderRadius: '8px',
                                  padding: '8px 12px',
                                  boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                                }}
                              />
                              <Legend
                                verticalAlign="bottom"
                                height={36}
                                iconSize={10}
                                wrapperStyle={{ fontSize: '11px' }}
                              />
                            </PieChart>
                          </ResponsiveContainer>
                        )}

                        {viz.type === 'line' && (
                          <ResponsiveContainer width="100%" height="100%">
                            <LineChart
                              data={[
                                { date: 'Mon', value: 12 },
                                { date: 'Tue', value: 19 },
                                { date: 'Wed', value: 15 },
                                { date: 'Thu', value: 25 },
                                { date: 'Fri', value: 22 },
                                { date: 'Sat', value: 18 },
                                { date: 'Sun', value: 14 }
                              ]}
                              margin={{ top: 5, right: 5, left: -20, bottom: 5 }}
                            >
                              <CartesianGrid strokeDasharray="3 3" stroke="#e5e5e5" />
                              <XAxis dataKey="date" tick={{ fill: '#737373', fontSize: 10 }} />
                              <YAxis tick={{ fill: '#737373', fontSize: 10 }} />
                              <Tooltip
                                contentStyle={{
                                  backgroundColor: 'rgba(255, 255, 255, 0.98)',
                                  border: '1px solid #e5e5e5',
                                  borderRadius: '8px',
                                  padding: '8px 12px',
                                  boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                                }}
                              />
                              <Line type="monotone" dataKey="value" stroke="#3b82f6" strokeWidth={1} dot={{ r: 3 }} />
                            </LineChart>
                          </ResponsiveContainer>
                        )}

                        {viz.type === 'bar' && (
                          <ResponsiveContainer width="100%" height="100%">
                            <BarChart
                              data={[
                                { name: 'John', value: 12 },
                                { name: 'Sarah', value: 19 },
                                { name: 'Mike', value: 8 },
                                { name: 'Emma', value: 15 },
                                { name: 'Alex', value: 10 }
                              ]}
                              margin={{ top: 5, right: 5, left: -20, bottom: 5 }}
                            >
                              <CartesianGrid strokeDasharray="3 3" stroke="#e5e5e5" />
                              <XAxis dataKey="name" tick={{ fill: '#737373', fontSize: 10 }} />
                              <YAxis tick={{ fill: '#737373', fontSize: 10 }} />
                              <Tooltip
                                contentStyle={{
                                  backgroundColor: 'rgba(255, 255, 255, 0.98)',
                                  border: '1px solid #e5e5e5',
                                  borderRadius: '8px',
                                  padding: '8px 12px',
                                  boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                                }}
                              />
                              <Bar
                                dataKey="value"
                                fill="#3b82f6"
                                radius={[4, 4, 0, 0]}
                                onClick={(data) => {
                                  setActiveLayer('explorer');
                                  setExplorerActiveTab('list');
                                }}
                                cursor="pointer"
                              />
                            </BarChart>
                          </ResponsiveContainer>
                        )}

                        {viz.type === 'progress' && (
                          <div className="h-full flex flex-col items-center justify-center">
                            <div className="relative w-40 h-40">
                              <svg className="transform -rotate-90 w-40 h-40">
                                <circle
                                  cx="80"
                                  cy="80"
                                  r="70"
                                  stroke="#e5e5e5"
                                  strokeWidth="12"
                                  fill="transparent"
                                />
                                <circle
                                  cx="80"
                                  cy="80"
                                  r="70"
                                  stroke="#10b981"
                                  strokeWidth="12"
                                  fill="transparent"
                                  strokeDasharray={`${70 * 2 * Math.PI}`}
                                  strokeDashoffset={`${70 * 2 * Math.PI * (1 - 0.73)}`}
                                  strokeLinecap="round"
                                />
                              </svg>
                              <div className="absolute inset-0 flex items-center justify-center">
                                <span className="text-3xl font-bold text-neutral-900">73%</span>
                              </div>
                            </div>
                            <p className="mt-2 text-xs text-neutral-500">128 of 175 completed</p>
                          </div>
                        )}

                        {viz.type === 'metric' && (
                          <div className="h-full flex flex-col items-center justify-center">
                            <div className="text-center">
                              <div className="text-5xl font-bold text-red-600 mb-2">12</div>
                              <p className="text-sm text-neutral-600 mb-4">Items overdue</p>
                              <div className="flex items-center justify-center gap-2 text-xs text-red-600">
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                                </svg>
                                <span>+3 from last week</span>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* Resize Handle */}
              <div
                className="absolute top-0 left-0 right-0 h-2 cursor-ns-resize hover:bg-blue-500/20 transition-colors"
                onMouseDown={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  const startY = e.clientY;
                  const startHeight = insightsPanelHeight;

                  // Prevent text selection during drag
                  document.body.style.userSelect = 'none';
                  document.body.style.cursor = 'ns-resize';

                  const handleMouseMove = (moveEvent) => {
                    moveEvent.preventDefault();
                    const newHeight = Math.max(350, Math.min(window.innerHeight - 96, startHeight - (moveEvent.clientY - startY)));
                    setInsightsPanelHeight(newHeight);
                  };

                  const handleMouseUp = () => {
                    // Restore default cursor and text selection
                    document.body.style.userSelect = '';
                    document.body.style.cursor = '';

                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                  };

                  document.addEventListener('mousemove', handleMouseMove);
                  document.addEventListener('mouseup', handleMouseUp);
                }}
              />
            </div>
          )}
        </div>
      )}

      {/* Finder Panel */}
      {isLayerActive('finder') && (
        <div
          ref={finderPanelRef}
          className={`fixed z-[100] rounded-t-2xl shadow-2xl animate-slide-up panel-transition panel-backdrop-transition ${
            finderPanelMinimized ? 'h-14' : ''
          }`}
          style={{
            left: '20px',
            right: '20px',
            bottom: '20px',
            height: finderPanelMinimized ? 'auto' : `${finderPanelSize.height}px`,
            backgroundColor: isFinderPanelFocused ? 'rgba(255, 255, 255, 0.95)' : 'rgba(255, 255, 255, 0.55)',
            backdropFilter: 'blur(20px)',
            WebkitBackdropFilter: 'blur(20px)',
            border: '1px solid rgba(0, 0, 0, 0.1)',
            transition: 'background-color 0.2s ease',
          }}
          onMouseEnter={() => setIsFinderPanelFocused(true)}
          onMouseLeave={() => setIsFinderPanelFocused(false)}
        >
          {/* Header */}
          <div className="h-14 px-6 flex items-center justify-between border-b border-neutral-200/50">
            <div className="flex items-center gap-4">
              {/* Minimize/Restore */}
              <button
                onClick={() => setFinderPanelMinimized(!finderPanelMinimized)}
                className="p-1.5 text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100/80 rounded transition-colors"
                title={finderPanelMinimized ? 'Restore' : 'Minimize'}
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  {finderPanelMinimized ? (
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M5 15l7-7 7 7" />
                  ) : (
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 9l-7 7-7-7" />
                  )}
                </svg>
              </button>

              <h3 className="text-sm font-semibold text-neutral-900">Enterprise Finder</h3>

              {/* Search Filter */}
              <div className="relative">
                <input
                  type="text"
                  placeholder="Search applications..."
                  value={finderSearchFilter}
                  onChange={(e) => setFinderSearchFilter(e.target.value)}
                  className="w-64 px-3 py-1.5 pl-9 text-sm border border-neutral-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
                <svg className="w-4 h-4 absolute left-3 top-2.5 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>

              {/* Selected Count */}
              {selectedRecord?.recordType === 'Application' && view === 'detail' && (
                <div className="flex items-center gap-1.5 px-2.5 py-1 bg-blue-50 text-blue-700 rounded-md text-xs font-medium">
                  <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span>1 Selected</span>
                </div>
              )}
            </div>

            {/* Close Button */}
            <button
              onClick={() => toggleLayer('finder')}
              className="p-1.5 text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100/80 rounded transition-colors"
              title="Close"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>

          {/* Content */}
          {!finderPanelMinimized && (
            <div className="h-[calc(100%-56px)] overflow-auto">
              {/* Applications Grid */}
              <div className="p-4">
                <div className="bg-white rounded-lg border border-neutral-200 overflow-hidden">
                  <table className="w-full text-sm">
                    <thead className="bg-neutral-50 border-b border-neutral-200">
                      <tr>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-neutral-600 uppercase tracking-wider">Status</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-neutral-600 uppercase tracking-wider">Application ID</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-neutral-600 uppercase tracking-wider">Member ID</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-neutral-600 uppercase tracking-wider">Name</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-neutral-600 uppercase tracking-wider">Year</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-neutral-600 uppercase tracking-wider">Submission Date</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-neutral-600 uppercase tracking-wider">Approval Date</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-neutral-600 uppercase tracking-wider">Member Type</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-neutral-600 uppercase tracking-wider">Discussions</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-neutral-200">
                      {mockRecords.filter(record => record.recordType === 'Application')
                        .filter(app =>
                          !finderSearchFilter ||
                          app.title.toLowerCase().includes(finderSearchFilter.toLowerCase()) ||
                          app.applicationId.toLowerCase().includes(finderSearchFilter.toLowerCase()) ||
                          app.status.toLowerCase().includes(finderSearchFilter.toLowerCase())
                        )
                        .map((app) => (
                        <tr
                          key={app.id}
                          onClick={() => { setSelectedRecord(app); setView('detail'); }}
                          className={`cursor-pointer transition-colors ${
                            selectedRecord?.id === app.id
                              ? 'bg-blue-50 hover:bg-blue-100'
                              : 'hover:bg-neutral-50'
                          }`}
                        >
                          <td className="px-4 py-3">
                            <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                              app.status === 'Approved'
                                ? 'bg-green-100 text-green-800'
                                : app.status === 'Under Discussion'
                                ? 'bg-yellow-100 text-yellow-800'
                                : 'bg-blue-100 text-blue-800'
                            }`}>
                              {app.status}
                            </span>
                          </td>
                          <td className="px-4 py-3 text-neutral-900 font-mono text-xs">{app.applicationId}</td>
                          <td className="px-4 py-3 text-neutral-900 font-mono text-xs">{app.memberId}</td>
                          <td className="px-4 py-3 text-neutral-900 font-medium">{app.title}</td>
                          <td className="px-4 py-3 text-neutral-600">{app.year}</td>
                          <td className="px-4 py-3 text-neutral-600">{app.submissionDate}</td>
                          <td className="px-4 py-3 text-neutral-600">{app.approvalDate || 'â€”'}</td>
                          <td className="px-4 py-3 text-neutral-600">{app.membershipType}</td>
                          <td className="px-4 py-3">
                            <div className="flex items-center gap-1.5">
                              <svg className="w-4 h-4 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                              </svg>
                              <span className="text-neutral-600">{app.discussionsCount}</span>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          )}

          {/* Resize Handle */}
          {!finderPanelMinimized && (
            <div
              className="absolute top-0 left-0 right-0 h-2 cursor-ns-resize hover:bg-blue-500/10 transition-colors group"
              onMouseDown={(e) => {
                e.preventDefault();
                const startY = e.clientY;
                const startHeight = finderPanelSize.height;

                const handleMouseMove = (moveEvent) => {
                  const deltaY = startY - moveEvent.clientY;
                  const newHeight = Math.max(200, Math.min(window.innerHeight - 100, startHeight + deltaY));
                  setFinderPanelSize(prev => ({ ...prev, height: newHeight }));
                };

                const handleMouseUp = () => {
                  document.removeEventListener('mousemove', handleMouseMove);
                  document.removeEventListener('mouseup', handleMouseUp);
                };

                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
              }}
            >
              <div className="absolute top-0.5 left-1/2 -translate-x-1/2 w-12 h-1 bg-neutral-300 rounded-full group-hover:bg-blue-500 transition-colors"></div>
            </div>
          )}
        </div>
      )}

      {/* Insights Visual Field Selection Overlay */}
      {isInsightsFieldSelectorActive && isLayerActive('insights') && (
        <>
          {/* Overlay with instruction banner */}
          <div className="fixed inset-0 z-[105] pointer-events-none">
            {/* Top instruction banner */}
            <div className="fixed top-20 left-1/2 -translate-x-1/2 z-[106] pointer-events-auto">
              <div className="bg-blue-600 text-white px-6 py-3 rounded-lg shadow-2xl flex items-center gap-4 animate-fade-in">
                <div className="flex items-center gap-3">
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span className="text-sm font-medium">Click on any field on the page to see insights for that field</span>
                </div>
                <button
                  onClick={() => setIsInsightsFieldSelectorActive(false)}
                  className="px-3 py-1 bg-white/20 hover:bg-white/30 rounded text-xs font-medium transition-colors"
                >
                  Cancel (ESC)
                </button>
              </div>
            </div>
          </div>

          {/* Background overlay with crosshair cursor */}
          <div
            className="fixed inset-0 z-[104] bg-black/5"
            style={{ cursor: 'crosshair' }}
            onClick={() => {
              setIsInsightsFieldSelectorActive(false);
            }}
          />

          {/* Simulated selectable fields overlay */}
          <div className="fixed inset-0 z-[105] pointer-events-none">
            {['Status', 'Priority', 'Assignee', 'Due Date', 'Category', 'Tags', 'Description', 'Notes'].map((fieldName, index) => {
              const column = index % 2;
              const row = Math.floor(index / 2);

              return (
                <div
                  key={fieldName}
                  className="timeline-field-selectable pointer-events-auto"
                  data-field-name={fieldName}
                  onClick={(e) => {
                    e.stopPropagation();
                    setInsightsSelectedField(fieldName);
                    setIsInsightsFieldSelectorActive(false);
                  }}
                  style={{
                    position: 'absolute',
                    left: `${15 + column * 45}%`,
                    top: `${180 + row * 90}px`,
                    width: '250px',
                    height: '48px',
                    zIndex: 105,
                  }}
                />
              );
            })}
          </div>
        </>
      )}

      {/* Flex Panel Blocks - Floating, Resizable Panels */}
      {Object.entries(flexPanelSettings || {}).filter(([_, settings]) => settings.enabled).map(([elementId, panelSettings]) => {
        // Find the element in droppedElements or detailPageLayouts
        let element = droppedElements.find(e => e.id === elementId);
        if (!element && selectedRecord) {
          const layout = getAllDetailElements(selectedRecord.id);
          element = layout.find(item => item.id === elementId);
        }

        if (!element) return null;

        const elementDef = componentElements.find(e => e.id === element.elementType);
        if (!elementDef) return null;

        const { position, size, minimized, maximized, zIndex } = panelSettings;
        const isFocused = flexPanelFocusStates[elementId] || false;
        const isTransitioning = flexPanelTransitioning === elementId;

        // FLIP animation: calculate initial transform if transitioning
        let initialTransform = {};
        if (isTransitioning && elementRectCache.current[elementId]) {
          const cached = elementRectCache.current[elementId];
          const deltaX = cached.x - position.x;
          const deltaY = cached.y - position.y;
          const scaleX = cached.width / size.width;
          const scaleY = cached.height / size.height;

          initialTransform = {
            transform: `translate(${deltaX}px, ${deltaY}px) scale(${scaleX}, ${scaleY})`,
            transition: 'none',
          };
        }

        return (
          <div
            key={elementId}
            ref={(el) => {
              flexPanelRefs.current[elementId] = el;
              // Trigger FLIP animation after mount
              if (el && isTransitioning && elementRectCache.current[elementId]) {
                requestAnimationFrame(() => {
                  requestAnimationFrame(() => {
                    if (el) {
                      el.style.transform = 'translate(0, 0) scale(1, 1)';
                      el.style.transition = 'transform 350ms cubic-bezier(0.4, 0, 0.2, 1), box-shadow 350ms ease, background-color 0.2s ease';
                    }
                  });
                });
              }
            }}
            className={`fixed rounded-2xl shadow-2xl ${minimized ? 'h-14' : ''}`}
            style={{
              left: maximized ? '20px' : `${position.x}px`,
              top: maximized ? '76px' : `${position.y}px`,
              width: maximized ? 'calc(100vw - 40px)' : `${size.width}px`,
              height: minimized ? 'auto' : (maximized ? 'calc(100vh - 96px)' : `${size.height}px`),
              zIndex: zIndex || 100,
              backgroundColor: isFocused ? 'rgba(255, 255, 255, 0.95)' : 'rgba(255, 255, 255, 0.75)',
              backdropFilter: 'blur(20px)',
              WebkitBackdropFilter: 'blur(20px)',
              border: '1px solid rgba(0, 0, 0, 0.1)',
              transition: 'background-color 0.2s ease',
              ...initialTransform,
            }}
            onMouseEnter={() => setFlexPanelFocusStates(prev => ({ ...prev, [elementId]: true }))}
            onMouseLeave={() => setFlexPanelFocusStates(prev => ({ ...prev, [elementId]: false }))}
          >
            {/* Header with drag handle */}
            <div
              className="h-14 px-4 flex items-center justify-between border-b border-neutral-200/50 cursor-move bg-gradient-to-r from-blue-50/50 to-indigo-50/50"
              onMouseDown={(e) => {
                if (!maximized) {
                  e.preventDefault();
                  const startX = e.clientX - position.x;
                  const startY = e.clientY - position.y;

                  const handleMouseMove = (moveEvent) => {
                    const newX = Math.max(0, Math.min(moveEvent.clientX - startX, window.innerWidth - size.width));
                    const newY = Math.max(56, Math.min(moveEvent.clientY - startY, window.innerHeight - 100));
                    updateFlexPanelSettings(elementId, { position: { x: newX, y: newY } });
                  };

                  const handleMouseUp = () => {
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                  };

                  document.addEventListener('mousemove', handleMouseMove);
                  document.addEventListener('mouseup', handleMouseUp);
                }
              }}
            >
              <div className="flex items-center gap-2">
                <svg className="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                </svg>
                <h3 className="text-sm font-semibold text-neutral-900">{elementDef.name}</h3>
                <span className="text-xs text-neutral-500">Flex Panel</span>
              </div>

              <div className="flex items-center gap-1">
                {/* Minimize/Restore */}
                <button
                  onClick={() => updateFlexPanelSettings(elementId, { minimized: !minimized })}
                  className="p-1.5 text-neutral-400 hover:text-neutral-900 hover:bg-white/80 rounded transition-colors"
                  title={minimized ? 'Restore' : 'Minimize'}
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M20 12H4" />
                  </svg>
                </button>

                {/* Maximize/Restore */}
                <button
                  onClick={() => updateFlexPanelSettings(elementId, { maximized: !maximized })}
                  className="p-1.5 text-neutral-400 hover:text-neutral-900 hover:bg-white/80 rounded transition-colors"
                  title={maximized ? 'Restore' : 'Maximize'}
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    {maximized ? (
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 9V6a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2h-3M9 9H6a2 2 0 00-2 2v6a2 2 0 002 2h6a2 2 0 002-2v-3M9 9h3v3" />
                    ) : (
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                    )}
                  </svg>
                </button>

                {/* Pin to Grid (disable flex panel) */}
                <button
                  onClick={() => toggleFlexPanel(elementId)}
                  className="p-1.5 text-neutral-400 hover:text-blue-600 hover:bg-blue-50/80 rounded transition-colors"
                  title="Pin to Grid (âŒ˜â‡§P)"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                  </svg>
                </button>
              </div>
            </div>

            {/* Panel Content */}
            {!minimized && (
              <div className="p-4 overflow-auto" style={{ height: 'calc(100% - 3.5rem)' }}>
                {/* Render the actual element content */}
                {renderElement(element, 0, view === 'detail' ? 'detail' : 'list', selectedRecord?.id)}
              </div>
            )}

            {/* Resize Handles - Full flexibility with corner, edge controls */}
            {!minimized && !maximized && (
              <>
                {/* Bottom-right corner resize - both width and height */}
                <div
                  className="absolute bottom-0 right-0 w-6 h-6 cursor-nwse-resize group/resize z-10"
                  onMouseDown={(e) => {
                    e.stopPropagation();
                    const startX = e.clientX;
                    const startY = e.clientY;
                    const startWidth = size.width;
                    const startHeight = size.height;

                    const handleMouseMove = (moveEvent) => {
                      const newWidth = Math.max(300, startWidth + (moveEvent.clientX - startX));
                      const newHeight = Math.max(200, startHeight + (moveEvent.clientY - startY));
                      updateFlexPanelSettings(elementId, { size: { width: newWidth, height: newHeight } });
                    };

                    const handleMouseUp = () => {
                      document.removeEventListener('mousemove', handleMouseMove);
                      document.removeEventListener('mouseup', handleMouseUp);
                    };

                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                  }}
                >
                  <svg className="w-4 h-4 text-neutral-400 group-hover/resize:text-blue-500 transition-colors absolute bottom-0.5 right-0.5" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M16 16V14H14V16H16ZM16 11V9H14V11H16ZM13 16V14H11V16H13ZM16 8V6H14V8H16ZM13 13V11H11V13H13ZM10 16V14H8V16H10ZM13 10V8H11V10H13ZM10 13V11H8V13H10ZM10 10V8H8V10H10Z" />
                  </svg>
                </div>

                {/* Right edge resize - width only */}
                <div
                  className="absolute top-0 right-0 bottom-0 w-2 cursor-ew-resize hover:bg-blue-500/20 transition-colors"
                  onMouseDown={(e) => {
                    e.stopPropagation();
                    const startX = e.clientX;
                    const startWidth = size.width;

                    const handleMouseMove = (moveEvent) => {
                      const newWidth = Math.max(300, startWidth + (moveEvent.clientX - startX));
                      updateFlexPanelSettings(elementId, { size: { width: newWidth, height: size.height } });
                    };

                    const handleMouseUp = () => {
                      document.removeEventListener('mousemove', handleMouseMove);
                      document.removeEventListener('mouseup', handleMouseUp);
                    };

                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                  }}
                />

                {/* Bottom edge resize - height only */}
                <div
                  className="absolute left-0 right-0 bottom-0 h-2 cursor-ns-resize hover:bg-blue-500/20 transition-colors"
                  onMouseDown={(e) => {
                    e.stopPropagation();
                    const startY = e.clientY;
                    const startHeight = size.height;

                    const handleMouseMove = (moveEvent) => {
                      const newHeight = Math.max(200, startHeight + (moveEvent.clientY - startY));
                      updateFlexPanelSettings(elementId, { size: { width: size.width, height: newHeight } });
                    };

                    const handleMouseUp = () => {
                      document.removeEventListener('mousemove', handleMouseMove);
                      document.removeEventListener('mouseup', handleMouseUp);
                    };

                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                  }}
                />
              </>
            )}
          </div>
        );
      })}

      {/* Toast Notification */}
      {toastMessage && (
        <div className="fixed bottom-8 left-1/2 transform -translate-x-1/2 z-50 animate-fade-in">
          <div className="bg-neutral-900 text-white px-6 py-3 rounded-lg shadow-2xl flex items-center gap-3 max-w-md">
            <svg className="w-5 h-5 text-green-400 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
            </svg>
            <span className="text-sm font-medium">{toastMessage}</span>
          </div>
        </div>
      )}

      {/* Drag Overlay - shows the element being dragged */}
      <DragOverlay dropAnimation={null}>
        {activeElementId ? (() => {
          // Find the active element - check zones first, then body layouts
          let activeElement = null;
          let activeRecord = null;

          // Check if it's a panel item (new element being dragged)
          if (activeElementId.startsWith('panel-')) {
            const elementType = activeElementId.replace('panel-', '');
            const elementDef = componentElements.find(e => e.id === elementType);
            if (elementDef) {
              return (
                <div className="w-80 bg-white rounded-lg shadow-2xl border border-neutral-200 p-4 opacity-90">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-lg bg-neutral-100 flex items-center justify-center">
                      <svg className="w-5 h-5 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        {getIconSvg(elementDef.icon)}
                      </svg>
                    </div>
                    <div>
                      <div className="text-sm font-medium text-neutral-900">{elementDef.name}</div>
                      <div className="text-xs text-neutral-500">{elementDef.description}</div>
                    </div>
                  </div>
                </div>
              );
            }
          }

          // Check zone elements (header/footer)
          if (selectedRecord) {
            ['header', 'footer', 'body'].forEach(zoneName => {
              const zone = pageSettings.detail.zones[zoneName];
              if (zone && zone.rows) {
                zone.rows.forEach(row => {
                  const elements = row.id === 'main-content-row' && zoneName === 'body'
                    ? getAllDetailElements(selectedRecord.id)
                    : (row.elements || []);
                  const found = elements.find(e => e.id === activeElementId);
                  if (found) {
                    activeElement = found;
                    activeRecord = selectedRecord;
                  }
                });
              }
            });
          }

          // Check droppedElements for user-added elements
          if (!activeElement) {
            activeElement = droppedElements.find(e => e.id === activeElementId);
            if (activeElement && view === 'detail') {
              activeRecord = selectedRecord;
            }
          }

          if (activeElement) {
            // IMPROVED: Show compact preview for better UX
            // Compact preview reduces visual clutter and makes it easier to see drop zones
            const isZoneElement = activeElement.type && !activeElement.elementType;
            const elementType = activeElement.elementType || activeElement.type;
            const elementDef = componentElements.find(e => e.id === elementType);

            if (elementDef) {
              return (
                <div className="w-80 bg-white rounded-lg shadow-2xl border-2 border-blue-500 p-4 opacity-90">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center">
                      <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        {getIconSvg(elementDef.icon)}
                      </svg>
                    </div>
                    <div className="flex-1">
                      <div className="text-sm font-medium text-neutral-900">{elementDef.name}</div>
                      <div className="text-xs text-neutral-500">
                        {isZoneElement ? 'Zone Element' : 'Content Block'}
                      </div>
                    </div>
                    <div className="text-xs text-blue-600 font-medium">Moving...</div>
                  </div>
                </div>
              );
            }

            // Fallback to full preview if element definition not found
            return (
              <div className="bg-white rounded-lg shadow-2xl border border-neutral-200 opacity-90 max-w-2xl">
                {isZoneElement
                  ? renderElementContent(activeElement, activeRecord)
                  : renderElement(activeElement, 0, 'detail', activeRecord?.id)
                }
              </div>
            );
          }

          return null;
        })() : null}
      </DragOverlay>

      {/* Zoom-Out Overlay for Outline Drag Operations */}
      <ZoomOutOverlay
        isActive={!!activeOutlineItemId}
        mainContentRef={mainContentRef}
        overOutlineItemId={overOutlineItemId}
        activeOutlineItemId={activeOutlineItemId}
        view={view}
        droppedElements={droppedElements}
        selectedRecord={selectedRecord}
        getAllDetailElements={getAllDetailElements}
      />

      {/* Floating Artifact Panels */}
      {floatingPanels.map((panel) => {
        const artifact = selectedRecord?.artifacts?.find(a => a.id === panel.artifactId);
        if (!artifact || panel.minimized) return null;

        return (
          <div
            key={panel.id}
            className="fixed bg-white rounded-lg shadow-2xl border border-neutral-300 flex flex-col"
            style={{
              left: panel.position.x,
              top: panel.position.y,
              width: panel.position.width,
              height: panel.position.height,
              zIndex: panel.zIndex,
              resize: 'both',
              overflow: 'hidden'
            }}
            onClick={() => {
              // Bring to front
              const maxZ = Math.max(...floatingPanels.map(p => p.zIndex), panelZIndexCounter);
              setFloatingPanels(panels => panels.map(p =>
                p.id === panel.id ? { ...p, zIndex: maxZ + 1 } : p
              ));
              setPanelZIndexCounter(maxZ + 1);
              setActiveArtifactPanel(panel.id);
            }}
          >
            {/* Panel Header - Draggable */}
            <div
              className={`flex items-center justify-between px-4 py-2 bg-neutral-100 border-b border-neutral-200 cursor-move ${
                activeArtifactPanel === panel.id ? 'bg-blue-100' : ''
              }`}
              onMouseDown={(e) => {
                if (e.button !== 0) return;
                const startX = e.clientX;
                const startY = e.clientY;
                const startPosX = panel.position.x;
                const startPosY = panel.position.y;

                const handleMouseMove = (moveEvent) => {
                  const deltaX = moveEvent.clientX - startX;
                  const deltaY = moveEvent.clientY - startY;
                  setFloatingPanels(panels => panels.map(p =>
                    p.id === panel.id
                      ? { ...p, position: { ...p.position, x: startPosX + deltaX, y: startPosY + deltaY } }
                      : p
                  ));
                };

                const handleMouseUp = () => {
                  document.removeEventListener('mousemove', handleMouseMove);
                  document.removeEventListener('mouseup', handleMouseUp);
                };

                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
              }}
            >
              <div className="flex items-center gap-2 flex-1 min-w-0">
                <svg className="w-4 h-4 text-neutral-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2">
                    <span className="text-sm font-medium text-neutral-900 truncate">{artifact.name}</span>
                    {artifact.category && (
                      <span className="px-2 py-0.5 bg-blue-100 text-blue-700 text-[10px] font-semibold rounded-full flex-shrink-0">
                        {artifact.category}
                      </span>
                    )}
                  </div>
                  <span className="text-xs text-neutral-500">({artifact.size})</span>
                </div>
              </div>
              <div className="flex items-center gap-1 ml-2">
                {/* Minimize Button */}
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    setFloatingPanels(panels => panels.map(p =>
                      p.id === panel.id ? { ...p, minimized: true } : p
                    ));
                  }}
                  className="p-1 text-neutral-500 hover:text-neutral-700 hover:bg-neutral-200 rounded"
                  title="Minimize"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 12H4" />
                  </svg>
                </button>
                {/* Close Button */}
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    setFloatingPanels(panels => panels.filter(p => p.id !== panel.id));
                  }}
                  className="p-1 text-neutral-500 hover:text-red-600 hover:bg-red-50 rounded"
                  title="Close"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>

            {/* Panel Content */}
            <div className="flex-1 overflow-auto p-4 bg-neutral-50">
              <div className="flex items-center justify-center h-full bg-white rounded border border-neutral-200">
                <div className="text-center">
                  <svg className="w-16 h-16 mx-auto mb-4 text-neutral-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                  </svg>
                  <p className="text-sm text-neutral-500">PDF Preview</p>
                  <p className="text-xs text-neutral-400 mt-1">{artifact.name}</p>
                  <button className="mt-4 px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors">
                    Download
                  </button>
                </div>
              </div>
            </div>

            {/* Resize Handle */}
            <div
              className="absolute bottom-0 right-0 w-4 h-4 cursor-se-resize"
              onMouseDown={(e) => {
                e.stopPropagation();
                const startX = e.clientX;
                const startY = e.clientY;
                const startWidth = panel.position.width;
                const startHeight = panel.position.height;

                const handleMouseMove = (moveEvent) => {
                  const deltaX = moveEvent.clientX - startX;
                  const deltaY = moveEvent.clientY - startY;
                  setFloatingPanels(panels => panels.map(p =>
                    p.id === panel.id
                      ? {
                          ...p,
                          position: {
                            ...p.position,
                            width: Math.max(300, startWidth + deltaX),
                            height: Math.max(200, startHeight + deltaY)
                          }
                        }
                      : p
                  ));
                };

                const handleMouseUp = () => {
                  document.removeEventListener('mousemove', handleMouseMove);
                  document.removeEventListener('mouseup', handleMouseUp);
                };

                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
              }}
            >
              <svg className="w-full h-full text-neutral-400" viewBox="0 0 16 16">
                <path fill="currentColor" d="M16 16H14V14H16V16ZM16 12H14V10H16V12ZM12 16H10V14H12V16Z" />
              </svg>
            </div>
          </div>
        );
      })}

      {/* Minimized Panels Dock */}
      {floatingPanels.filter(p => p.minimized).length > 0 && (
        <div className="fixed bottom-6 right-6 flex flex-col gap-2 z-[999]">
          {floatingPanels.filter(p => p.minimized).map((panel) => {
            const artifact = selectedRecord?.artifacts?.find(a => a.id === panel.artifactId);
            if (!artifact) return null;

            return (
              <button
                key={panel.id}
                onClick={() => {
                  setFloatingPanels(panels => panels.map(p =>
                    p.id === panel.id ? { ...p, minimized: false } : p
                  ));
                }}
                className="flex items-center gap-2 px-3 py-2 bg-white rounded-lg shadow-lg border border-neutral-200 hover:shadow-xl transition-shadow max-w-xs"
              >
                <svg className="w-4 h-4 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
                <span className="text-sm text-neutral-900 truncate">{artifact.name}</span>
              </button>
            );
          })}
        </div>
      )}

      {/* Discussion Floating Panel */}
      {activeDiscussion && (() => {
        const field = selectedRecord && (() => {
          // Find field data from application form
          const formData = [
            { id: 'fullName', label: 'Full Name', value: selectedRecord?.title },
            { id: 'preferredName', label: 'Preferred Name', value: selectedRecord?.title?.split(' ')[0] || '' },
            { id: 'email', label: 'Email Address', value: selectedRecord?.email },
            { id: 'professionalBackground', label: 'Professional Summary', value: selectedRecord?.bio },
            { id: 'currentPosition', label: 'Current Position', value: selectedRecord?.position },
            { id: 'organization', label: 'Organization', value: selectedRecord?.company },
            { id: 'membershipType', label: 'Membership Type Requested', value: selectedRecord?.membershipType }
          ];
          return formData.find(f => f.id === activeDiscussion.fieldId);
        })();

        const currentMarkers = discussionMarkers[activeDiscussion.fieldId] || [];
        const currentMarker = currentMarkers.find(m => m.id === activeDiscussion.markerId);

        return (
          <div
            className="fixed bg-white rounded-lg shadow-2xl border border-neutral-300 flex flex-col"
            style={{
              left: discussionPanelPosition.x,
              top: discussionPanelPosition.y,
              width: discussionPanelPosition.width,
              height: discussionPanelPosition.height,
              zIndex: 1001,
              resize: 'both',
              overflow: 'hidden'
            }}
          >
            {/* Discussion Panel Header - Draggable */}
            <div
              className="flex items-center justify-between px-4 py-3 border-b border-neutral-200 bg-gradient-to-r from-blue-50 to-white cursor-move"
              onMouseDown={(e) => {
                if (e.button !== 0) return;
                const startX = e.clientX;
                const startY = e.clientY;
                const startPosX = discussionPanelPosition.x;
                const startPosY = discussionPanelPosition.y;

                const handleMouseMove = (moveEvent) => {
                  const deltaX = moveEvent.clientX - startX;
                  const deltaY = moveEvent.clientY - startY;
                  setDiscussionPanelPosition(prev => ({
                    ...prev,
                    x: startPosX + deltaX,
                    y: startPosY + deltaY
                  }));
                };

                const handleMouseUp = () => {
                  document.removeEventListener('mousemove', handleMouseMove);
                  document.removeEventListener('mouseup', handleMouseUp);
                };

                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
              }}
            >
              <div className="flex-1">
                <div className="flex items-center gap-2">
                  <svg className="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                  </svg>
                  <div>
                    <h3 className="text-sm font-semibold text-neutral-900">Discussion</h3>
                    <p className="text-xs text-neutral-600">{field?.label || 'Field'}</p>
                  </div>
                </div>
              </div>
              <button
                onClick={() => setActiveDiscussion(null)}
                className="p-1 text-neutral-500 hover:text-neutral-700 hover:bg-neutral-200 rounded transition-colors"
                title="Close discussion"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>

              {/* Field Context */}
              <div className="px-6 py-4 bg-neutral-50 border-b border-neutral-200">
                <div className="text-xs font-semibold text-neutral-500 uppercase tracking-wider mb-2">Field Content</div>
                <div className="text-sm text-neutral-900 bg-white rounded-lg p-3 border border-neutral-200">
                  {field?.value || 'N/A'}
                </div>
              </div>

              {/* Discussion Thread */}
              <div className="flex-1 overflow-y-auto px-6 py-4">
                <div className="space-y-4">
                  {currentMarkers.map((marker, index) => (
                    <div key={marker.id} className="flex gap-3">
                      {/* Avatar */}
                      <div className="flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white text-sm font-semibold">
                        {marker.author.charAt(0)}
                      </div>
                      {/* Message */}
                      <div className="flex-1">
                        <div className="flex items-baseline gap-2 mb-1">
                          <span className="text-sm font-semibold text-neutral-900">{marker.author}</span>
                          <span className="text-xs text-neutral-500">
                            {new Date(marker.timestamp).toLocaleString('en-US', {
                              month: 'short',
                              day: 'numeric',
                              hour: 'numeric',
                              minute: '2-digit'
                            })}
                          </span>
                          <span className={`text-xs px-2 py-0.5 rounded-full ${
                            marker.priority === 'issue' ? 'bg-red-100 text-red-700' :
                            marker.priority === 'question' ? 'bg-amber-100 text-amber-700' :
                            'bg-green-100 text-green-700'
                          }`}>
                            {marker.priority}
                          </span>
                        </div>
                        <textarea
                          autoFocus
                          value={marker.text || ''}
                          placeholder="Type your comment or question here..."
                          className="w-full px-3 py-2 border border-neutral-300 rounded-lg text-sm text-neutral-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                          rows={3}
                          onChange={(e) => {
                            setDiscussionMarkers(prev => ({
                              ...prev,
                              [activeDiscussion.fieldId]: prev[activeDiscussion.fieldId].map(m =>
                                m.id === marker.id ? { ...m, text: e.target.value } : m
                              )
                            }));
                          }}
                        />
                      </div>
                    </div>
                  ))}
                </div>
              </div>

            {/* Discussion Actions */}
            <div className="px-6 py-4 border-t border-neutral-200 bg-neutral-50">
              <div className="flex items-center gap-3">
                {/* Priority Selector */}
                <select
                  value={currentMarker?.priority || 'question'}
                  onChange={(e) => {
                    setDiscussionMarkers(prev => ({
                      ...prev,
                      [activeDiscussion.fieldId]: prev[activeDiscussion.fieldId].map(m =>
                        m.id === currentMarker?.id ? { ...m, priority: e.target.value } : m
                      )
                    }));
                  }}
                  className="px-3 py-2 border border-neutral-300 rounded-lg text-sm text-neutral-900 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="info">Info</option>
                  <option value="question">Question</option>
                  <option value="issue">Issue</option>
                </select>

                <div className="flex-1"></div>

                {/* Action Buttons */}
                <button
                  onClick={() => {
                    // Delete this discussion
                    setDiscussionMarkers(prev => ({
                      ...prev,
                      [activeDiscussion.fieldId]: prev[activeDiscussion.fieldId].filter(m => m.id !== activeDiscussion.markerId)
                    }));
                    setActiveDiscussion(null);
                  }}
                  className="px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                >
                  Delete
                </button>
                <button
                  onClick={() => setActiveDiscussion(null)}
                  className="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors"
                >
                  Close
                </button>
              </div>
            </div>

            {/* Resize Handle */}
            <div
              className="absolute bottom-0 right-0 w-4 h-4 cursor-se-resize"
              onMouseDown={(e) => {
                e.stopPropagation();
                const startX = e.clientX;
                const startY = e.clientY;
                const startWidth = discussionPanelPosition.width;
                const startHeight = discussionPanelPosition.height;

                const handleMouseMove = (moveEvent) => {
                  const deltaX = moveEvent.clientX - startX;
                  const deltaY = moveEvent.clientY - startY;
                  setDiscussionPanelPosition(prev => ({
                    ...prev,
                    width: Math.max(400, startWidth + deltaX),
                    height: Math.max(300, startHeight + deltaY)
                  }));
                };

                const handleMouseUp = () => {
                  document.removeEventListener('mousemove', handleMouseMove);
                  document.removeEventListener('mouseup', handleMouseUp);
                };

                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
              }}
            >
              <svg className="w-full h-full text-neutral-400" viewBox="0 0 16 16">
                <path fill="currentColor" d="M16 16H14V14H16V16ZM16 12H14V10H16V12ZM12 16H10V14H12V16Z" />
              </svg>
            </div>
          </div>
        );
      })()}

      {/* Artifact Gallery Modal */}
      {isArtifactGalleryOpen && selectedRecord?.artifacts && (
        <div
          className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1000]"
          onClick={() => setIsArtifactGalleryOpen(false)}
        >
          <div
            className="bg-white rounded-xl shadow-2xl max-w-5xl w-full mx-4 max-h-[85vh] overflow-hidden"
            onClick={(e) => e.stopPropagation()}
          >
            {/* Modal Header */}
            <div className="flex items-center justify-between px-6 py-4 border-b border-neutral-200">
              <div>
                <h2 className="text-lg font-semibold text-neutral-900">Application Artifacts</h2>
                <p className="text-sm text-neutral-600 mt-0.5">{selectedRecord.artifacts.length} documents attached</p>
              </div>
              <button
                onClick={() => setIsArtifactGalleryOpen(false)}
                className="p-1 text-neutral-500 hover:text-neutral-700 hover:bg-neutral-100 rounded"
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>

            {/* Modal Content - Artifact Grid */}
            <div className="p-6 overflow-y-auto max-h-[calc(85vh-6rem)]">
              <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                {selectedRecord.artifacts.map((artifact) => (
                  <button
                    key={artifact.id}
                    onClick={() => {
                      // Open artifact in floating panel
                      const newPanel = {
                        id: `panel-${artifact.id}-${Date.now()}`,
                        artifactId: artifact.id,
                        position: {
                          x: 100 + (floatingPanels.length * 30),
                          y: 100 + (floatingPanels.length * 30),
                          width: 500,
                          height: 600
                        },
                        zIndex: panelZIndexCounter + 1,
                        minimized: false
                      };
                      setFloatingPanels(panels => [...panels, newPanel]);
                      setPanelZIndexCounter(panelZIndexCounter + 1);
                      setIsArtifactGalleryOpen(false);
                    }}
                    className="group flex flex-col items-center p-4 bg-neutral-50 rounded-lg border border-neutral-200 hover:border-blue-500 hover:bg-blue-50 transition-all"
                  >
                    {/* Document Icon */}
                    <div className="w-full aspect-[3/4] bg-white rounded border border-neutral-200 mb-3 flex flex-col items-center justify-center group-hover:border-blue-500 transition-colors relative">
                      <svg className="w-12 h-12 text-neutral-300 group-hover:text-blue-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                      </svg>
                      {/* Category Badge */}
                      {artifact.category && (
                        <div className="absolute top-2 left-2 right-2">
                          <span className="inline-block px-2 py-0.5 bg-blue-600 text-white text-[10px] font-semibold rounded-full truncate max-w-full">
                            {artifact.category}
                          </span>
                        </div>
                      )}
                    </div>
                    <p className="text-xs font-medium text-neutral-900 truncate w-full text-center px-1" title={artifact.name}>
                      {artifact.name}
                    </p>
                    <p className="text-xs text-neutral-500 mt-1">{artifact.size}</p>
                  </button>
                ))}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* ============================ */}
      {/* DATABASE PAGE MODALS & PANELS */}
      {/* ============================ */}

      {/* Template Gallery Modal */}
      {showPageTemplateGallery && (
        <TemplateGallery
          onSelectTemplate={handlePageTemplateSelect}
          onClose={() => setShowPageTemplateGallery(false)}
          showBlankOption={true}
        />
      )}

      {/* Emoji Picker Modal */}
      {showEmojiPicker && (
        <>
          <div
            className="fixed inset-0 z-[100]"
            onClick={() => setShowEmojiPicker(false)}
          />
          <div className="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[101]">
            <EmojiPicker
              onEmojiClick={(emojiData) => {
                const activePage = customPages.find(p => p.id === activeCustomPageId);
                if (activePage) {
                  setCustomPages(customPages.map(p =>
                    p.id === activeCustomPageId
                      ? {
                          ...p,
                          settings: {
                            ...p.settings,
                            header: {
                              ...p.settings.header,
                              icon: emojiData.emoji
                            }
                          }
                        }
                      : p
                  ));
                }
                setShowEmojiPicker(false);
              }}
              width={350}
              height={450}
            />
          </div>
        </>
      )}

      {/* Unsplash Slide-out Panel */}
      {showUnsplashModal && (
        <>
          {/* Backdrop */}
          <div
            className="fixed inset-0 z-[100] bg-black/30 transition-opacity"
            onClick={() => setShowUnsplashModal(false)}
          />

          {/* Slide-out Panel */}
          <div
            className="fixed top-0 right-0 bottom-0 z-[101] w-full max-w-2xl bg-white shadow-2xl transform transition-transform duration-300 ease-out flex flex-col"
            style={{
              animation: 'slideInRight 0.3s ease-out'
            }}
          >
            {/* Header */}
            <div className="border-b border-neutral-200 px-8 py-6 flex-shrink-0">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-2xl font-bold text-neutral-900">Choose Cover Image</h2>
                <button
                  onClick={() => setShowUnsplashModal(false)}
                  className="text-neutral-400 hover:text-neutral-900 transition-colors p-2 hover:bg-neutral-100 rounded-lg"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
              <div className="relative">
                <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input
                  type="text"
                  value={unsplashSearch}
                  onChange={(e) => setUnsplashSearch(e.target.value)}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter' && unsplashSearch.trim()) {
                      // Simulate search - in production, call Unsplash API
                      const mockImages = [
                        'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800',
                        'https://images.unsplash.com/photo-1501785888041-af3ef285b470?w=800',
                        'https://images.unsplash.com/photo-1469474968028-56623f02e42e?w=800',
                        'https://images.unsplash.com/photo-1426604966848-d7adac402bff?w=800',
                        'https://images.unsplash.com/photo-1472214103451-9374bd1c798e?w=800',
                        'https://images.unsplash.com/photo-1508193638397-1c4234db14d8?w=800',
                        'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=800',
                        'https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?w=800',
                        'https://images.unsplash.com/photo-1494500764479-0c8f2919a3d8?w=800'
                      ];
                      setUnsplashImages(mockImages);
                    }
                  }}
                  placeholder="Search for images (e.g., nature, abstract, workspace)..."
                  className="w-full pl-10 pr-4 py-3 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>
            </div>

            {/* Content Area */}
            <div className="flex-1 overflow-y-auto px-8 py-6">
              {unsplashImages.length === 0 ? (
                <div className="h-full flex flex-col items-center justify-center text-center">
                  <svg className="w-20 h-20 text-neutral-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <p className="text-base font-medium text-neutral-700 mb-2">Search for images</p>
                  <p className="text-sm text-neutral-500 mb-8">
                    Type a search term above and press Enter
                  </p>

                  <div className="w-full max-w-md">
                    <div className="relative mb-4">
                      <div className="absolute inset-0 flex items-center">
                        <div className="w-full border-t border-neutral-200" />
                      </div>
                      <div className="relative flex justify-center text-sm">
                        <span className="px-4 bg-white text-neutral-500">or</span>
                      </div>
                    </div>
                    <input
                      type="text"
                      placeholder="Paste an image URL..."
                      className="w-full px-4 py-3 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      onKeyDown={(e) => {
                        if (e.key === 'Enter' && e.target.value.trim()) {
                          const activePage = customPages.find(p => p.id === activeCustomPageId);
                          if (activePage) {
                            setCustomPages(customPages.map(p =>
                              p.id === activeCustomPageId
                                ? {
                                    ...p,
                                    settings: {
                                      ...p.settings,
                                      cover: {
                                        enabled: true,
                                        image: e.target.value,
                                        verticalPosition: 50
                                      }
                                    }
                                  }
                                : p
                            ));
                          }
                          setShowUnsplashModal(false);
                          setUnsplashImages([]);
                        }
                      }}
                    />
                  </div>
                </div>
              ) : (
                <div className="grid grid-cols-2 gap-4">
                  {unsplashImages.map((img, idx) => (
                    <button
                      key={idx}
                      onClick={() => {
                        const activePage = customPages.find(p => p.id === activeCustomPageId);
                        if (activePage) {
                          setCustomPages(customPages.map(p =>
                            p.id === activeCustomPageId
                              ? {
                                  ...p,
                                  settings: {
                                    ...p.settings,
                                    cover: {
                                      enabled: true,
                                      image: img,
                                      verticalPosition: 50
                                    }
                                  }
                                }
                              : p
                          ));
                        }
                        setShowUnsplashModal(false);
                        setUnsplashImages([]);
                      }}
                      className="aspect-video rounded-lg overflow-hidden hover:ring-4 hover:ring-blue-500 transition-all group relative"
                    >
                      <img src={img} alt="" className="w-full h-full object-cover" />
                      <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors" />
                    </button>
                  ))}
                </div>
              )}
            </div>
          </div>
        </>
      )}

      {/* Reposition Slider Modal */}
      {showRepositionModal && (
        <div className="fixed inset-0 z-[100] bg-black/50 flex items-center justify-center" onClick={() => setShowRepositionModal(false)}>
          <div className="bg-white rounded-lg shadow-2xl w-full max-w-md p-6" onClick={(e) => e.stopPropagation()}>
            <h3 className="text-lg font-semibold text-neutral-900 mb-4">Reposition Cover Image</h3>
            <div className="mb-6">
              <label className="block text-sm text-neutral-600 mb-2">
                Vertical Position: {repositionValue}%
              </label>
              <input
                type="range"
                min="0"
                max="100"
                value={repositionValue}
                onChange={(e) => setRepositionValue(parseInt(e.target.value))}
                className="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer slider"
                style={{
                  background: `linear-gradient(to right, #3b82f6 0%, #3b82f6 ${repositionValue}%, #e5e7eb ${repositionValue}%, #e5e7eb 100%)`
                }}
              />
              <div className="flex justify-between text-xs text-neutral-500 mt-1">
                <span>Top</span>
                <span>Center</span>
                <span>Bottom</span>
              </div>
            </div>
            <div className="flex gap-3">
              <button
                onClick={() => setShowRepositionModal(false)}
                className="flex-1 px-4 py-2 border border-neutral-300 rounded-lg hover:bg-neutral-50 transition-colors"
              >
                Cancel
              </button>
              <button
                onClick={() => {
                  const activePage = customPages.find(p => p.id === activeCustomPageId);
                  if (activePage) {
                    setCustomPages(customPages.map(p =>
                      p.id === activeCustomPageId
                        ? {
                            ...p,
                            settings: {
                              ...p.settings,
                              cover: {
                                ...p.settings.cover,
                                verticalPosition: repositionValue
                              }
                            }
                          }
                        : p
                    ));
                  }
                  setShowRepositionModal(false);
                }}
                className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
              >
                Apply
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Slash Command Palette */}
      <SlashPalette
        isOpen={showSlashPalette}
        position={slashPalettePosition}
        onClose={() => setShowSlashPalette(false)}
        onSelectElement={(elementType) => {
          const activePage = customPages.find(p => p.id === activeCustomPageId);
          if (activePage) {
            // Get element definition from registry to use default settings
            const elementDef = getElementDefinition(elementType);

            const newElement = {
              id: `elem-${Date.now()}`,
              type: elementType,
              content: elementDef?.defaultSettings?.placeholder || `New ${elementType.replace(/-/g, ' ')}`,
              settings: elementDef?.defaultSettings || {}
            };

            setCustomPages(customPages.map(p =>
              p.id === activeCustomPageId
                ? {
                    ...p,
                    settings: {
                      ...p.settings,
                      body: {
                        ...p.settings.body,
                        elements: [...(p.settings?.body?.elements || []), newElement]
                      }
                    }
                  }
                : p
            ));
          }
          setShowSlashPalette(false);
          if (slashPaletteInput) {
            slashPaletteInput.focus();
          }
        }}
      />

    </DndContext>
  );
}

export default App;
